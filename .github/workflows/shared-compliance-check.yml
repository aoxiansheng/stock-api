name: Common Module Compliance Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/src/**/*.ts'
      - 'backend/src/**/*.js'
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/src/**/*.ts'
      - 'backend/src/**/*.js'

jobs:
  compliance-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Install dependencies
      working-directory: backend
      run: npm ci
      
    - name: Run ESLint compliance check
      working-directory: backend
      run: npm run lint:common
      continue-on-error: true
      
    - name: Run common module compliance check
      working-directory: backend
      run: |
        chmod +x scripts/check-common-compliance.sh
        ./scripts/check-common-compliance.sh
      id: compliance-check
      continue-on-error: true
      
    - name: Generate compliance report
      if: always()
      working-directory: backend
      run: |
        echo "## ğŸ” Common æ¨¡å—å¤ç”¨åˆè§„æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # è¿è¡Œæ£€æŸ¥å¹¶æ•è·è¾“å‡º
        if ./scripts/check-common-compliance.sh > compliance_report.txt 2>&1; then
          echo "âœ… **æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **å‘ç°åˆè§„é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### è¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat compliance_report.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ä¿®å¤æŒ‡å—" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. æŸ¥çœ‹ [Common æ¨¡å—å¤ç”¨åˆè§„æ£€æŸ¥æ¸…å•](./docs/common-module-compliance-checklist.md)" >> $GITHUB_STEP_SUMMARY
        echo "2. å‚è€ƒ [å¼€å‘è§„èŒƒæŒ‡å—](./docs/å¼€å‘è§„èŒƒæŒ‡å—.md) ç¬¬10ç« " >> $GITHUB_STEP_SUMMARY
        echo "3. è¿è¡Œ \`npm run compliance:fix\` è‡ªåŠ¨ä¿®å¤éƒ¨åˆ†é—®é¢˜" >> $GITHUB_STEP_SUMMARY
        
    - name: Comment PR with compliance results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // è¯»å–åˆè§„æ£€æŸ¥ç»“æœ
          let complianceReport = '';
          try {
            complianceReport = fs.readFileSync('backend/compliance_report.txt', 'utf8');
          } catch (error) {
            complianceReport = 'æ— æ³•è¯»å–åˆè§„æ£€æŸ¥æŠ¥å‘Š';
          }
          
          // é¢„å¤„ç†ç»“æœçŠ¶æ€
          const resultStatus = complianceReport.includes('æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†') 
            ? 'âœ… **æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼**' 
            : 'âŒ **å‘ç°åˆè§„é—®é¢˜**';
          
          // æ„å»ºè¯„è®ºå†…å®¹
          const comment = [
            '## ğŸ” Common æ¨¡å—å¤ç”¨åˆè§„æ£€æŸ¥æŠ¥å‘Š',
            '',
            '### æ£€æŸ¥ç»“æœ',
            resultStatus,
            '',
            '### è¯¦ç»†æŠ¥å‘Š',
            '```',
            complianceReport,
            '```',
            '',
            '### ğŸ“‹ ä¿®å¤æŒ‡å—',
            '1. æŸ¥çœ‹ [Common æ¨¡å—å¤ç”¨åˆè§„æ£€æŸ¥æ¸…å•](./docs/common-module-compliance-checklist.md)',
            '2. å‚è€ƒ [å¼€å‘è§„èŒƒæŒ‡å—](./docs/å¼€å‘è§„èŒƒæŒ‡å—.md) ç¬¬10ç« ',  
            '3. è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤é—®é¢˜ï¼š',
            '   ```bash',
            '   npm run compliance:fix  # è‡ªåŠ¨ä¿®å¤éƒ¨åˆ†é—®é¢˜',
            '   npm run lint:fix        # ä¿®å¤ä»£ç æ ¼å¼é—®é¢˜',
            '   ```',
            '',
            '### ğŸ¯ é‡ç‚¹æ£€æŸ¥é¡¹',
            '- [ ] ä½¿ç”¨ `createLogger` è€Œä¸æ˜¯ `new Logger`',
            '- [ ] æ‰€æœ‰æ—¥å¿—è°ƒç”¨ä½¿ç”¨ `sanitizeLogData()` åŒ…è£…æ•æ„Ÿæ•°æ®',
            '- [ ] ä½¿ç”¨ `@common` è·¯å¾„åˆ«åå¯¼å…¥ common æ¨¡å—',
            '- [ ] å¤ç”¨ common æ¨¡å—çš„ç±»å‹å®šä¹‰å’Œå¸¸é‡',
            '- [ ] æ²¡æœ‰ä½¿ç”¨ `console.log/warn/error`',
            '',
            '---',
            '*æ­¤æŠ¥å‘Šç”± Common æ¨¡å—å¤ç”¨åˆè§„æ£€æŸ¥å·¥ä½œæµè‡ªåŠ¨ç”Ÿæˆ*'
          ].join('\n');

          // æŸ¥æ‰¾ç°æœ‰çš„åˆè§„æ£€æŸ¥è¯„è®º
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const existingComment = comments.find(comment => 
            comment.body.includes('Common æ¨¡å—å¤ç”¨åˆè§„æ£€æŸ¥æŠ¥å‘Š')
          );
          
          if (existingComment) {
            // æ›´æ–°ç°æœ‰è¯„è®º
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            // åˆ›å»ºæ–°è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }
          
    - name: Fail if compliance check failed
      if: steps.compliance-check.outcome == 'failure'
      run: |
        echo "âŒ Common æ¨¡å—å¤ç”¨åˆè§„æ£€æŸ¥å¤±è´¥"
        echo "è¯·ä¿®å¤è¿è§„é¡¹åé‡æ–°æäº¤"
        exit 1

  # å¯é€‰ï¼šè‡ªåŠ¨ä¿®å¤ä½œä¸š
  auto-fix:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'auto-fix-compliance')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Install dependencies
      working-directory: backend
      run: npm ci
      
    - name: Run auto-fix
      working-directory: backend
      run: |
        npm run compliance:fix
        npm run format
        
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ”§ è‡ªåŠ¨ä¿®å¤ Common æ¨¡å—å¤ç”¨åˆè§„é—®é¢˜"
          git push
        fi
