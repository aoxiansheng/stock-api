# 🎯 **旧系统清理 - 细化执行待办清单**

> 基于验证后的迁移计划v2.0，制定可直接执行的细分任务清单

---

## 📅 **P0 紧急任务 - Day 1（预计8-10小时）**

### ✅ **任务组1：StreamCacheService 遗留代码清理（4-6小时）**

#### 准备工作（30分钟）
- [ ] 创建今日工作分支：`git checkout -b cleanup/stream-cache-legacy`
- [ ] 创建备份目录：`mkdir -p backup/$(date +%Y%m%d)`
- [ ] 备份遗留文件：`cp src/core/05-caching/module/stream-cache/services/stream-cache.service.ts.legacy backup/$(date +%Y%m%d)/`

#### 执行清理（1小时）
- [ ] 删除遗留文件：`rm src/core/05-caching/module/stream-cache/services/stream-cache.service.ts.legacy`
- [ ] 打开 `src/core/05-caching/module/stream-cache/module/stream-cache.module.ts`
- [ ] 删除第133-134行的 Provider 配置：`provide: 'StreamCacheService'`
- [ ] 删除第142行的 Export 配置：`'StreamCacheService'`
- [ ] 保存文件

#### 验证测试（2-3小时）
- [ ] 运行标准化服务测试：`DISABLE_AUTO_INIT=true bun run test:unit:cache --testNamePattern="StreamCacheStandardized"`
- [ ] 运行完整缓存模块测试：`DISABLE_AUTO_INIT=true bun run test:unit:cache`
- [ ] 运行集成测试：`DISABLE_AUTO_INIT=true bun run test:integration:cache`
- [ ] 应用启动测试：`timeout 30s DISABLE_AUTO_INIT=false bun run start`
- [ ] 确认所有测试通过

#### 收尾工作（30分钟）
- [ ] 提交代码：`git add -A && git commit -m "chore: 移除StreamCacheService遗留代码"`
- [ ] 记录完成状态和测试结果

---

### ✅ **任务组2：ProcessingTime 字段迁移（6-8小时）**

#### 准备工作（30分钟）
- [ ] 创建分支：`git checkout -b cleanup/processing-time-field`
- [ ] 确认影响范围（5个文件）
- [ ] 备份相关文件

#### 字段重命名（2小时）
- [ ] 修改 `src/core/01-entry/stream-receiver/interfaces/data-processing.interface.ts`
  - [ ] 将第59行 `processingTime: number` 改为 `processingTimeMs: number`
- [ ] 修改 `src/core/01-entry/stream-receiver/services/stream-data-processor.service.ts`
  - [ ] 将第458行函数参数 `processingTime` 改为 `processingTimeMs`
  - [ ] 将第461行 `this.dataProcessingStats.totalProcessingTime` 改为 `totalProcessingTimeMs`
- [ ] 修改 `src/monitoring/config/unified/monitoring-events.config.ts`
  - [ ] 将第951行 `processingTimeoutMs` 保持不变（已经是正确命名）
- [ ] 修改 `src/monitoring/config/unified/monitoring-enhanced.config.ts`
  - [ ] 将第528行引用更新（如需要）
- [ ] 更新 `src/common/interfaces/time-fields.interface.ts` 中的注释说明

#### 自动化检查（1小时）
- [ ] 运行ESLint废弃字段检测：`bun run lint:deprecated-fields`
- [ ] 运行完整ESLint：`bun run lint`
- [ ] 修复所有ESLint报告的问题

#### 验证测试（2小时）
- [ ] TypeScript类型检查：`DISABLE_AUTO_INIT=true npm run typecheck`
- [ ] 监控模块测试：`DISABLE_AUTO_INIT=true bun run test:unit:monitoring`
- [ ] 核心模块测试：`DISABLE_AUTO_INIT=true bun run test:unit:core`
- [ ] 确认无编译错误和测试失败

#### 收尾工作（30分钟）
- [ ] 提交代码：`git add -A && git commit -m "refactor: 将processingTime迁移为processingTimeMs"`
- [ ] 合并到主分支（如适用）

---

## 📈 **P1 高优先级任务 - Day 2-4（预计4-6小时）**

### ✅ **任务组3：Feature Flags 清理（4-6小时）**

#### 调研分析（1小时）
- [ ] 检查 `metricsLegacyModeEnabled` 使用情况：`grep -r "metricsLegacyModeEnabled" src/`
- [ ] 检查环境变量配置：`grep -r "METRICS_LEGACY_MODE_ENABLED" .`
- [ ] 记录所有使用位置
- [ ] 确认是否有生产环境依赖

#### 渐进式清理（2小时）
- [ ] 第一步：添加使用监控日志
  - [ ] 在使用处添加警告日志：`logger.warn('METRICS_LEGACY_MODE is enabled - consider migration')`
  - [ ] 部署并观察1-2天（可选）
- [ ] 第二步：移除Feature Flag
  - [ ] 打开 `src/appcore/config/feature-flags.config.ts`
  - [ ] 删除第42-43行：`readonly metricsLegacyModeEnabled: boolean = ...`
  - [ ] 删除第12行环境变量注释
  - [ ] 更新 `getAllFlags()` 方法（删除相关返回值）

#### 验证测试（1.5小时）
- [ ] 配置文件类型检查：`DISABLE_AUTO_INIT=true npm run typecheck:file -- src/appcore/config/feature-flags.config.ts`
- [ ] 监控模块测试：`DISABLE_AUTO_INIT=true bun run test:unit:monitoring`
- [ ] 指标模块测试：`DISABLE_AUTO_INIT=true bun run test:unit:metrics`
- [ ] 应用启动测试：`timeout 30s DISABLE_AUTO_INIT=false bun run start`

#### 收尾工作（30分钟）
- [ ] 提交代码：`git add -A && git commit -m "chore: 移除metricsLegacyModeEnabled feature flag"`
- [ ] 更新环境变量文档

---

## ⚙️ **P2 中等优先级任务 - Day 5-7（预计8-10小时）**

### ✅ **任务组4：测试文件更新（6-8小时）**

#### 测试文件迁移（4小时）
- [ ] 更新 `test/jest/unit/stream-cache/stream-cache-migration-validation.spec.ts`
  - [ ] 将所有 `StreamCacheService` 引用改为 `StreamCacheStandardizedService`
- [ ] 更新 `test/jest/unit/core/05-caching/stream-cache/stream-cache-memory-leak.spec.ts`
  - [ ] 更新import语句和类名引用
- [ ] 更新 `test/jest/integration/monitoring/presenter.controller.integration.spec.ts`
  - [ ] 移除legacy端点相关测试（如存在）
- [ ] 更新 `test/manual/data-fetcher-compatibility.test.js`
  - [ ] 确认兼容性测试仍然有效

#### 运行所有测试（2小时）
- [ ] 单元测试：`DISABLE_AUTO_INIT=true bun run test:unit:cache`
- [ ] 集成测试：`DISABLE_AUTO_INIT=true bun run test:integration:cache`
- [ ] 监控测试：`DISABLE_AUTO_INIT=true bun run test:integration:monitoring`
- [ ] 修复所有失败的测试

### ✅ **任务组5：ESLint 配置优化（2-4小时）**

#### 配置检查（1小时）
- [ ] 手动检查 `eslint.config.mts` 完整文件
- [ ] 搜索 "legacy" 关键词：`grep -n "legacy" eslint.config.mts`
- [ ] 确认是否存在legacy目录忽略规则
- [ ] 如存在，记录具体行号

#### 清理配置（1小时）
- [ ] 移除legacy目录忽略规则（如存在）
- [ ] 保留processingTime废弃检测规则（暂时）
- [ ] 更新lint脚本配置

---

## 🧹 **P3 清理任务 - Week 2（预计3-4小时）**

### ✅ **任务组6：文档和注释更新（2-3小时）**

#### 代码注释更新（1小时）
- [ ] 更新 `src/core/01-entry/stream-receiver/services/stream-receiver.service.ts` 第67行注释
- [ ] 搜索所有提及 `StreamCacheService` 的注释：`grep -r "StreamCacheService" src/ --include="*.ts"`
- [ ] 批量更新为 `StreamCacheStandardizedService`

#### 项目文档更新（1小时）
- [ ] 更新 `CLAUDE.md` 中的相关描述
- [ ] 更新迁移文档状态
- [ ] 创建本次清理的总结文档

### ✅ **任务组7：验证脚本创建（1-2小时）**

#### 创建检查脚本（1小时）
- [ ] 创建 `scripts/check-legacy-cleanup.sh`
- [ ] 添加legacy文件检查逻辑
- [ ] 添加废弃字段检查逻辑
- [ ] 添加执行权限：`chmod +x scripts/check-legacy-cleanup.sh`

#### 更新package.json（30分钟）
- [ ] 添加脚本命令：`"check:legacy-cleanup": "scripts/check-legacy-cleanup.sh"`
- [ ] 运行验证：`npm run check:legacy-cleanup`

---

## 📊 **最终验收清单**

### ✅ **技术验证**
- [ ] 所有 `.legacy` 文件已删除
- [ ] StreamCacheService 别名已移除
- [ ] processingTime 字段已全部迁移
- [ ] metricsLegacyModeEnabled 已清理
- [ ] ESLint 检查无错误
- [ ] TypeScript 编译通过
- [ ] 所有测试通过

### ✅ **性能验证**
- [ ] 应用启动时间 < 5% 增加
- [ ] 内存使用 < 10% 增加
- [ ] API 响应时间稳定

### ✅ **文档完善**
- [ ] 代码注释已更新
- [ ] 项目文档已更新
- [ ] 迁移记录已归档

---

## 📝 **执行注意事项**

1. **每个任务组可独立执行**，建议按顺序但可并行
2. **每完成一个任务组即可提交**，不必等待全部完成
3. **遇到问题随时停止**，不要强行推进
4. **保持备份习惯**，关键操作前先备份
5. **测试充分**，宁可多测不可少测

---

*生成时间：2024年9月24日*
*版本：v1.0*
*预计总耗时：8-10个工作日 → 实际可压缩至5-7天*