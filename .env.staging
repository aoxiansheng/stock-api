# =============================================================================
# 预生产环境配置文件 - New Stock API
# Symbol Mapper 缓存重构预生产验证环境
# =============================================================================

NODE_ENV=staging

# =============================================================================
# 🗄️ 数据库配置
# =============================================================================

# MongoDB 配置 - 预生产环境使用独立数据库
MONGODB_URI=mongodb://mongo-staging:27017/smart-stock-data-staging
MONGODB_OPTIONS=retryWrites=true&w=majority&maxPoolSize=20&minPoolSize=2

# Redis 配置 - 预生产环境独立 Redis
REDIS_URL=redis://redis-staging:6379
REDIS_PASSWORD=staging_redis_password
REDIS_MAX_RETRIES=3
REDIS_RETRY_DELAY=1000

# =============================================================================
# 🚀 服务配置
# =============================================================================

PORT=3000
HOST=0.0.0.0

# CSRF 保护 - 预生产环境启用
DISABLE_CSRF=false
CORS_ORIGIN=https://staging.your-domain.com

# JWT 配置
JWT_SECRET=staging_secret_key_replace_in_production
JWT_EXPIRES_IN=24h

# =============================================================================
# 🔧 Symbol Mapper 缓存重构配置 (验证环境)
# =============================================================================

# 符号映射缓存开关 - 预生产环境全面启用验证
SYMBOL_MAPPING_CACHE_ENABLED=true

# L1 缓存配置 (规则缓存) - 较小配置便于测试
RULE_CACHE_MAX_SIZE=100
RULE_CACHE_TTL=300000  # 5分钟，便于观察缓存失效

# L2 缓存配置 (符号缓存)
SYMBOL_CACHE_MAX_SIZE=5000
SYMBOL_CACHE_TTL=180000  # 3分钟，便于测试

# L3 缓存配置 (批量结果缓存) - 预生产验证
BATCH_RESULT_CACHE_MAX_SIZE=2000
BATCH_RESULT_CACHE_TTL=3600000  # 1小时

# 性能优化开关 - 全部启用进行验证
DATA_TRANSFORM_CACHE_ENABLED=true
BATCH_PROCESSING_ENABLED=true
OBJECT_POOL_ENABLED=true
RULE_COMPILATION_ENABLED=true

# 动态日志级别 - 预生产环境启用
DYNAMIC_LOG_LEVEL_ENABLED=true

# 指标双写兼容模式 - 验证迁移兼容性
METRICS_LEGACY_MODE_ENABLED=true

# =============================================================================
# 📊 监控和指标配置 (增强监控)
# =============================================================================

# 日志级别 - 预生产详细日志
LOG_LEVEL=info
LOG_FORMAT=json

# Prometheus 指标
METRICS_ENABLED=true
METRICS_PATH=/metrics
METRICS_PORT=9090

# 性能监控
APM_ENABLED=true
APM_SERVICE_NAME=new-stock-api-staging
APM_SERVER_URL=https://staging-apm.your-domain.com

# 健康检查
HEALTH_CHECK_ENABLED=true
HEALTH_CHECK_TIMEOUT=3000

# =============================================================================
# 🔒 数据源配置 (测试环境凭据)
# =============================================================================

# LongPort 测试环境凭据
LONGPORT_APP_KEY=${LONGPORT_STAGING_APP_KEY}
LONGPORT_APP_SECRET=${LONGPORT_STAGING_APP_SECRET}
LONGPORT_ACCESS_TOKEN=${LONGPORT_STAGING_ACCESS_TOKEN}

# LongPort SG 测试环境
LONGPORT_SG_APP_KEY=${LONGPORT_SG_STAGING_APP_KEY}
LONGPORT_SG_APP_SECRET=${LONGPORT_SG_STAGING_APP_SECRET}
LONGPORT_SG_ACCESS_TOKEN=${LONGPORT_SG_STAGING_ACCESS_TOKEN}

# 其他数据源使用开发环境配置
ITICK_TOKEN=${ITICK_DEV_TOKEN}
TWELVEDATA_API_KEY=${TWELVEDATA_DEV_API_KEY}
FUTU_HOST=${FUTU_DEV_HOST}
FUTU_PORT=${FUTU_DEV_PORT}
FUTU_RSA_FILE=${FUTU_DEV_RSA_FILE}

# =============================================================================
# ⚡ 速率限制配置 (接近生产环境)
# =============================================================================

# IP级别频率限制
IP_RATE_LIMIT_ENABLED=true
IP_RATE_LIMIT_MAX=2000        # 比生产环境稍宽松
IP_RATE_LIMIT_WINDOW=60000

# API Key级别频率限制
API_RATE_LIMIT_STRATEGY=sliding_window
API_RATE_LIMIT_DEFAULT_REQUESTS=1000  # 预生产环境测试用
API_RATE_LIMIT_DEFAULT_WINDOW=1h

# 传统限制配置
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=1000

# =============================================================================
# 🛡️ 安全配置
# =============================================================================

API_VERSION=v1
MAX_REQUEST_SIZE=10mb
MAX_JSON_SIZE=5mb
REQUEST_TIMEOUT=30000
DATABASE_TIMEOUT=10000

# =============================================================================
# 🔄 自动初始化配置 (预生产验证)
# =============================================================================

# 自动初始化 - 预生产环境启用用于验证
AUTO_INIT_ENABLED=true
AUTO_INIT_SYMBOL_MAPPINGS=true
AUTO_INIT_SKIP_EXISTING=true

# =============================================================================
# 📈 性能配置
# =============================================================================

NODE_OPTIONS=--max-old-space-size=2048 --enable-source-maps
CLUSTER_ENABLED=false  # 预生产单实例便于调试
DB_POOL_MIN=5
DB_POOL_MAX=50
REDIS_POOL_SIZE=10

# =============================================================================
# 🚨 告警配置 (测试告警系统)
# =============================================================================

ALERTING_ENABLED=true
ALERTING_WEBHOOK_URL=${STAGING_SLACK_WEBHOOK_URL}
ALERTING_EMAIL=${STAGING_ALERT_EMAIL}

# 预生产环境告警阈值 (更敏感)
MEMORY_ALERT_THRESHOLD=70
CPU_ALERT_THRESHOLD=75
RESPONSE_TIME_ALERT=500

# 缓存系统告警
CACHE_HIT_RATE_ALERT_THRESHOLD=40  # 预生产环境更敏感

# =============================================================================
# 🔧 运维配置
# =============================================================================

GRACEFUL_SHUTDOWN_TIMEOUT=15000
RESTART_DELAY=3000
BACKUP_ENABLED=false  # 预生产环境不需要备份

# =============================================================================
# 🌍 环境特定配置
# =============================================================================

DEPLOYMENT_ENV=staging
DEPLOYMENT_REGION=us-east-1
DEPLOYMENT_VERSION=${CI_COMMIT_SHA}

# 特性开关 - 预生产全面测试
FEATURE_NEW_CACHE_SYSTEM=true   # 重点验证缓存系统
FEATURE_ENHANCED_MONITORING=true
FEATURE_AUTO_SCALING=false      # 预生产环境关闭自动扩缩容

# =============================================================================
# 🧪 测试和验证配置
# =============================================================================

# 性能测试配置
PERFORMANCE_TEST_ENABLED=true
LOAD_TEST_CONCURRENT_USERS=50
LOAD_TEST_DURATION=300  # 5分钟负载测试

# 缓存验证配置
CACHE_VALIDATION_ENABLED=true
CACHE_HIT_RATIO_TARGET=70  # 目标缓存命中率 70%

# 数据一致性验证
DATA_CONSISTENCY_CHECK=true
CONSISTENCY_CHECK_INTERVAL=3600000  # 每小时检查一次