# E2E 黑盒测试场景清单

## 测试策略

本文档定义了智能股票数据处理系统的端到端黑盒测试场景。测试采用真实用户视角，验证完整业务流程。

## 测试环境要求

- MongoDB 运行中
- Redis 运行中
- 测试用户数据已初始化
- LongPort API凭证配置正确

## 核心测试场景

### 1. 认证授权流程 (Authentication & Authorization)

#### 1.1 用户认证流程
- [ ] **场景**: 用户注册 → 登录 → 获取JWT Token
- [ ] **场景**: 使用JWT Token访问受保护端点
- [ ] **场景**: Token过期后刷新Token
- [ ] **场景**: 无效Token被拒绝
- [ ] **场景**: 未认证用户访问受保护端点被拦截

#### 1.2 API Key认证流程
- [ ] **场景**: 创建API Key（需JWT认证）
- [ ] **场景**: 使用API Key + Access Token访问数据接口
- [ ] **场景**: API Key限流机制验证
- [ ] **场景**: 无效API Key被拒绝
- [ ] **场景**: 缺少Access Token被拒绝

#### 1.3 权限控制
- [ ] **场景**: DEVELOPER角色访问开发者专用端点
- [ ] **场景**: ADMIN角色访问管理员专用端点
- [ ] **场景**: 普通用户访问管理员端点被拒绝
- [ ] **场景**: 跨权限访问被正确拦截

---

### 2. 核心业务流程 - 强时效接口

#### 2.1 实时数据接收流程 (Receiver)
- [ ] **场景**: POST /api/v1/receiver/data - 接收单个股票实时数据
  - 输入: `{ dataSource: "longport", symbols: ["AAPL.US"], market: "US" }`
  - 验证: 返回数据格式、缓存策略（1秒TTL）、响应时间 < 100ms

- [ ] **场景**: 交易时间内数据接收（1秒缓存）
  - 时间: 模拟美股交易时间
  - 验证: 缓存TTL = 1秒

- [ ] **场景**: 非交易时间数据接收（60秒缓存）
  - 时间: 模拟休市时间
  - 验证: 缓存TTL = 60秒

- [ ] **场景**: 多市场数据接收
  - 输入: 美股 + 港股 + A股混合请求
  - 验证: 正确处理多市场时区

- [ ] **场景**: 无效股票代码处理
  - 输入: `{ symbols: ["INVALID"] }`
  - 验证: 返回友好错误信息

#### 2.2 WebSocket实时流 (Stream Receiver)
- [ ] **场景**: WebSocket连接建立 → 订阅股票 → 接收实时数据 → 断开连接
- [ ] **场景**: 订阅多个股票代码
- [ ] **场景**: 取消订阅特定股票
- [ ] **场景**: 连接异常自动重连
- [ ] **场景**: 无权限用户连接被拒绝

---

### 3. 核心业务流程 - 弱时效接口

#### 3.1 智能数据查询流程 (Query)
- [ ] **场景**: POST /api/v1/query/execute - 单次查询
  - 输入: `{ type: "BY_SYMBOLS", symbols: ["AAPL.US"], fields: ["price", "volume"] }`
  - 验证: 智能变化检测、双存储策略、数据完整性

- [ ] **场景**: POST /api/v1/query/bulk - 批量查询
  - 输入: 100个股票代码
  - 验证: 批量处理性能、并发控制

- [ ] **场景**: GET /api/v1/query/symbols - 快速查询
  - 输入: `?symbols=AAPL.US,TSLA.US`
  - 验证: 缓存命中率、响应速度

- [ ] **场景**: GET /api/v1/query/market - 市场数据查询
  - 输入: `?market=US`
  - 验证: 返回市场级别聚合数据

- [ ] **场景**: 变化检测机制验证
  - 操作: 连续查询同一股票
  - 验证: 数据无变化时不更新数据库

---

### 4. 数据流管道完整流程

#### 4.1 00-prepare: 符号映射 (Symbol Mapper)
- [ ] **场景**: POST /api/v1/symbol-mapper/transform - 股票代码转换
  - 输入: `{ source: "AAPL", fromFormat: "YAHOO", toFormat: "LONGPORT" }`
  - 验证: 返回 `AAPL.US`

- [ ] **场景**: 批量代码转换
  - 输入: 50个不同格式代码
  - 验证: 转换准确性、性能

- [ ] **场景**: 创建自定义映射规则（需ADMIN权限）
- [ ] **场景**: 查询映射规则
- [ ] **场景**: 删除映射规则

#### 4.2 00-prepare: 数据映射 (Data Mapper)
- [ ] **场景**: 创建数据源字段映射规则
  - 输入: 定义LongPort → 标准格式映射
  - 验证: 规则持久化、生效

- [ ] **场景**: 查询映射规则
- [ ] **场景**: 更新映射规则
- [ ] **场景**: 智能字段建议功能
- [ ] **场景**: 映射模板管理

#### 4.3 02-processing: 数据转换 (Transformer)
- [ ] **场景**: POST /api/v1/transformer/transform - 数据格式标准化
  - 输入: 原始LongPort数据
  - 验证: 返回标准格式数据、字段完整性

- [ ] **场景**: 数据转换预览（不保存）
- [ ] **场景**: 批量数据转换

#### 4.4 04-storage: 数据存储 (Storage)
- [ ] **场景**: 查询存储的历史数据
- [ ] **场景**: 数据持久化验证（MongoDB）
- [ ] **场景**: 缓存数据验证（Redis）
- [ ] **场景**: 双存储一致性验证

---

### 5. 端到端完整业务流程

#### 5.1 完整数据获取流程
```
用户认证 → 创建API Key → 请求实时数据 →
符号转换 → 数据映射 → 格式转换 →
缓存查询 → 数据返回 → 存储持久化
```

**测试步骤**:
1. 用户登录获取JWT Token
2. 使用JWT创建API Key
3. 使用API Key请求 `AAPL` 股票数据
4. 验证系统自动完成：
   - 符号映射: `AAPL` → `AAPL.US`
   - 数据获取: 从LongPort拉取
   - 格式转换: 原始格式 → 标准格式
   - 缓存存储: 写入Redis
   - 持久化: 写入MongoDB
5. 第二次请求相同数据
6. 验证缓存命中，不重复拉取

#### 5.2 多数据源融合流程
```
同时请求 LongPort + TwelveData →
数据聚合 → 去重 → 返回融合结果
```

**测试步骤**:
1. 配置多个数据源
2. 请求同一股票的多源数据
3. 验证数据融合逻辑
4. 验证数据质量评分

#### 5.3 实时监控与告警流程
```
高频请求 → 触发限流 →
异常数据 → 触发告警 →
系统降级 → 保持可用
```

**测试步骤**:
1. 短时间内发送大量请求
2. 验证限流机制生效
3. 验证降级策略（返回缓存数据）
4. 验证系统稳定性

---

### 6. 异常与边界场景

#### 6.1 网络异常
- [ ] **场景**: 数据源API超时
- [ ] **场景**: 数据源API返回错误
- [ ] **场景**: Redis连接断开
- [ ] **场景**: MongoDB连接断开
- [ ] **场景**: 部分服务降级

#### 6.2 数据异常
- [ ] **场景**: 无效股票代码
- [ ] **场景**: 不支持的市场
- [ ] **场景**: 缺失必填字段
- [ ] **场景**: 数据格式错误
- [ ] **场景**: 超大数据量请求

#### 6.3 并发场景
- [ ] **场景**: 100个并发请求同一股票
- [ ] **场景**: 1000个并发请求不同股票
- [ ] **场景**: 缓存击穿防护
- [ ] **场景**: 缓存雪崩防护
- [ ] **场景**: 数据库连接池耗尽

#### 6.4 安全场景
- [ ] **场景**: SQL注入攻击防护
- [ ] **场景**: XSS攻击防护
- [ ] **场景**: CSRF攻击防护
- [ ] **场景**: 大文件上传攻击
- [ ] **场景**: 请求体大小限制

---

### 7. 性能基准测试

#### 7.1 响应时间基准
- [ ] **强时效接口**: P95 < 100ms, P99 < 200ms
- [ ] **弱时效接口**: P95 < 500ms, P99 < 1000ms
- [ ] **WebSocket**: 消息延迟 < 50ms

#### 7.2 吞吐量基准
- [ ] **单机QPS**: > 1000 (缓存命中)
- [ ] **单机QPS**: > 100 (缓存未命中)
- [ ] **并发连接数**: > 10,000

#### 7.3 资源使用基准
- [ ] **内存使用**: < 2GB
- [ ] **CPU使用**: < 80%
- [ ] **网络带宽**: < 100Mbps

---

## 测试数据准备

### 测试用户
```json
{
  "admin": { "username": "admin", "password": "admin123", "role": "ADMIN" },
  "developer": { "username": "dev", "password": "dev123", "role": "DEVELOPER" },
  "user": { "username": "user", "password": "user123", "role": "USER" }
}
```

### 测试股票代码
```json
{
  "US": ["AAPL.US", "TSLA.US", "GOOGL.US", "MSFT.US"],
  "HK": ["00700.HK", "09988.HK", "01810.HK"],
  "CN": ["600519.SH", "000001.SZ"]
}
```

### 测试数据源
- LongPort (主要)
- TwelveData (备用)
- 模拟数据源 (Mock)

---

## 测试执行计划

### Phase 1: 基础流程 (Week 1)
- 认证授权流程
- 强时效接口基础场景
- 弱时效接口基础场景

### Phase 2: 完整管道 (Week 2)
- 符号映射流程
- 数据映射流程
- 数据转换流程
- 数据存储流程

### Phase 3: 端到端 (Week 3)
- 完整业务流程
- 多数据源融合
- 实时监控告警

### Phase 4: 异常与性能 (Week 4)
- 异常场景测试
- 边界条件测试
- 性能基准测试
- 安全测试

---

## 测试报告指标

- **功能覆盖率**: > 90%
- **场景通过率**: > 95%
- **性能达标率**: > 90%
- **Bug发现数**: 及时修复
- **回归测试**: 每次发布前执行
