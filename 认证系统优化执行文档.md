# è®¤è¯ç³»ç»Ÿä¼˜åŒ–æ‰§è¡Œæ–‡æ¡£

åŸºäºæ—¥å¿—åˆ†æå’Œä»£ç å®¡æŸ¥ï¼Œåˆ¶å®šä»¥ä¸‹å®Œæ•´çš„è®¤è¯ç³»ç»Ÿä¼˜åŒ–æ‰§è¡Œè®¡åˆ’ã€‚

## ğŸš¨ æ ¸å¿ƒé—®é¢˜æ€»ç»“

### é‡å¤è®¤è¯æ ¹æœ¬åŸå› 
1. **5ä¸ªå…¨å±€å®ˆå«ä¾æ¬¡æ‰§è¡Œ**ï¼šæ¯ä¸ªè¯·æ±‚éƒ½è¦é€šè¿‡æ‰€æœ‰å®ˆå«
2. **åŒä¸€API Keyè¢«å¤šæ¬¡éªŒè¯**ï¼šApiKeyAuthGuardã€RateLimitGuardã€UnifiedPermissionsGuardéƒ½è°ƒç”¨éªŒè¯
3. **ç¼ºå°‘è¯·æ±‚çº§ç¼“å­˜**ï¼šåŒä¸€è¯·æ±‚ä¸­å¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢
4. **WebSocketç‹¬ç«‹è®¤è¯**ï¼šä¸HTTPå®ˆå«å¹¶è¡Œï¼Œé€ æˆé¢å¤–å¼€é”€

### æ—¥å¿—è¯æ®
```
[09:33:58.115] DEBUG: å¼€å§‹API KeyéªŒè¯ appKey: "sk****78"
[09:33:58.117] DEBUG: å¼€å§‹API KeyéªŒè¯ appKey: "sk****78" 
[09:33:58.129] DEBUG: å¼€å§‹API KeyéªŒè¯ appKey: "sk****78"
```
**åŒä¸€ä¸ªAPI Keyåœ¨1æ¯«ç§’å†…è¢«éªŒè¯3æ¬¡ï¼**

## ğŸ“‹ ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’

### é˜¶æ®µä¸€ï¼šç´§æ€¥ä¿®å¤ï¼ˆé¢„è®¡è€—æ—¶ï¼š2-4å°æ—¶ï¼‰

#### 1.1 æ·»åŠ è¯·æ±‚çº§API Keyç¼“å­˜
**æ–‡ä»¶**ï¼š`src/auth/services/apikey.service.ts`
**ä¼˜å…ˆçº§**ï¼šğŸ”´ æœ€é«˜

```typescript
// åœ¨ApiKeyServiceç±»ä¸­æ·»åŠ 
export class ApiKeyService {
  private readonly requestCache = new Map<string, ApiKeyDocument>();
  
  @AuthPerformance("api_key")
  async validateApiKey(appKey: string, accessToken: string): Promise<ApiKeyDocument> {
    // 1. æ£€æŸ¥è¯·æ±‚çº§ç¼“å­˜
    const cacheKey = `${appKey}:${accessToken}`;
    const cached = this.requestCache.get(cacheKey);
    if (cached) {
      this.logger.debug('API Keyè¯·æ±‚ç¼“å­˜å‘½ä¸­', { appKey: ApiKeyUtil.sanitizeAppKey(appKey) });
      return cached;
    }
    
    // 2. åŸæœ‰æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
    const apiKey = await this.apiKeyModel.findOne({
      appKey, accessToken, isActive: true,
    }).exec();
    
    if (!apiKey) {
      throw new UnauthorizedException(ERROR_MESSAGES.API_CREDENTIALS_INVALID);
    }
    
    // 3. ç¼“å­˜åˆ°è¯·æ±‚çº§åˆ«ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
    this.requestCache.set(cacheKey, apiKey);
    setTimeout(() => this.requestCache.delete(cacheKey), 300000);
    
    return apiKey;
  }
}
```

#### 1.2 ä¼˜åŒ–UnifiedPermissionsGuardæ—©æœŸé€€å‡º
**æ–‡ä»¶**ï¼š`src/auth/guards/unified-permissions.guard.ts`
**ä¼˜å…ˆçº§**ï¼šğŸ”´ æœ€é«˜

```typescript
async canActivate(context: ExecutionContext): Promise<boolean> {
  // æå‰æ£€æŸ¥æƒé™è¦æ±‚ï¼Œé¿å…ä¸å¿…è¦çš„å¤„ç†
  const requiredRoles = this.getRequiredRoles(context);
  const requiredPermissions = this.getRequiredPermissions(context);
  
  // ç«‹å³è¿”å›ï¼Œé¿å…ä»»ä½•é¢å¤–å¤„ç†
  if (requiredRoles.length === 0 && requiredPermissions.length === 0) {
    // åªåœ¨debugæ¨¡å¼è®°å½•æ—¥å¿—
    if (process.env.NODE_ENV === 'development') {
      this.logger.debug("è·³è¿‡æƒé™æ£€æŸ¥ - æ— æƒé™è¦æ±‚");
    }
    return true;
  }
  
  // ç»§ç»­åŸæœ‰é€»è¾‘...
}
```

#### 1.3 å‡å°‘ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
**æ–‡ä»¶**ï¼šå¤šä¸ªæœåŠ¡æ–‡ä»¶
**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ ä¸­ç­‰

```typescript
// åœ¨æ‰€æœ‰è®¤è¯ç›¸å…³æœåŠ¡ä¸­æ·»åŠ æ¡ä»¶æ—¥å¿—
if (process.env.NODE_ENV !== 'production') {
  this.logger.debug('è¯¦ç»†è°ƒè¯•ä¿¡æ¯', { ... });
}

// åªä¿ç•™å…³é”®çš„é”™è¯¯å’Œè­¦å‘Šæ—¥å¿—
this.logger.warn('è®¤è¯å¤±è´¥', { endpoint, method, reason });
this.logger.error('è®¤è¯å¼‚å¸¸', { error: error.message });
```

**é¢„æœŸæ•ˆæœ**ï¼šå‡å°‘70%çš„é‡å¤API KeyæŸ¥è¯¢ï¼Œé™ä½60%çš„æ—¥å¿—I/O

---

### é˜¶æ®µäºŒï¼šç»“æ„ä¼˜åŒ–ï¼ˆé¢„è®¡è€—æ—¶ï¼š1-2å¤©ï¼‰

#### 2.1 å®ç°æ™ºèƒ½å®ˆå«è·¯ç”±
**æ–°æ–‡ä»¶**ï¼š`src/auth/guards/smart-auth.guard.ts`
**ä¼˜å…ˆçº§**ï¼šğŸŸ  é«˜

```typescript
@Injectable()
export class SmartAuthGuard implements CanActivate {
  constructor(
    private reflector: Reflector,
    private apiKeyGuard: ApiKeyAuthGuard,
    private jwtGuard: JwtAuthGuard,
    private rateLimitGuard: RateLimitGuard,
    private permissionsGuard: UnifiedPermissionsGuard,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const authType = this.determineAuthType(context);
    
    switch (authType) {
      case 'public':
        return true; // ç›´æ¥é€šè¿‡ï¼Œä¸æ‰§è¡Œä»»ä½•å®ˆå«
        
      case 'api_key':
        return this.executeApiKeyFlow(context);
        
      case 'jwt':
        return this.executeJwtFlow(context);
        
      case 'mixed':
        return this.executeMixedFlow(context);
    }
  }
  
  private async executeApiKeyFlow(context: ExecutionContext): Promise<boolean> {
    // åªæ‰§è¡Œå¿…è¦çš„å®ˆå«ï¼šApiKey -> RateLimit -> Permissions
    return (await this.apiKeyGuard.canActivate(context)) &&
           (await this.rateLimitGuard.canActivate(context)) &&
           (await this.permissionsGuard.canActivate(context));
  }
}
```

#### 2.2 æ›¿æ¢app.module.tsä¸­çš„å®ˆå«é…ç½®
**æ–‡ä»¶**ï¼š`src/app.module.ts`

```typescript
providers: [
  {
    provide: APP_GUARD,
    useClass: ThrottlerGuard, // ä¿ç•™åŸºç¡€é™æµ
  },
  {
    provide: APP_GUARD,
    useClass: SmartAuthGuard, // æ›¿æ¢æ‰€æœ‰è®¤è¯å®ˆå«
  },
],
```

#### 2.3 æ·»åŠ Redisç¼“å­˜å±‚ç»™API KeyéªŒè¯
**æ–‡ä»¶**ï¼š`src/auth/services/apikey.service.ts`

```typescript
async validateApiKey(appKey: string, accessToken: string): Promise<ApiKeyDocument> {
  const operation = APIKEY_OPERATIONS.VALIDATE_API_KEY;
  
  // 1. æ£€æŸ¥Redisç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰
  const redisCacheKey = `apikey:${appKey}:${accessToken}`;
  const cached = await this.cacheService.get<ApiKeyDocument>(redisCacheKey);
  if (cached) {
    this.logger.debug('API Key Redisç¼“å­˜å‘½ä¸­', { appKey: ApiKeyUtil.sanitizeAppKey(appKey) });
    return cached;
  }
  
  // 2. æ•°æ®åº“æŸ¥è¯¢
  const apiKey = await this.apiKeyModel.findOne({
    appKey, accessToken, isActive: true,
  }).exec();
  
  if (!apiKey) {
    throw new UnauthorizedException(ERROR_MESSAGES.API_CREDENTIALS_INVALID);
  }
  
  // 3. ç¼“å­˜åˆ°Redis
  await this.cacheService.set(redisCacheKey, apiKey, { ttl: 300 });
  
  return apiKey;
}
```

**é¢„æœŸæ•ˆæœ**ï¼šå‡å°‘90%çš„å®ˆå«æ‰§è¡Œå¼€é”€ï¼ŒAPIå“åº”æ—¶é—´æå‡40%

---

### é˜¶æ®µä¸‰ï¼šç›‘æ§å¢å¼ºï¼ˆé¢„è®¡è€—æ—¶ï¼š4-6å°æ—¶ï¼‰

#### 3.1 æ·»åŠ è®¤è¯æ€§èƒ½ç›‘æ§è£…é¥°å™¨
**æ–°æ–‡ä»¶**ï¼š`src/auth/decorators/auth-performance.decorator.ts`

```typescript
export function AuthFlowMonitor(operation: string) {
  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const method = descriptor.value;
    
    descriptor.value = async function (...args: any[]) {
      const startTime = Date.now();
      const logger = createLogger(`AuthFlow:${operation}`);
      
      try {
        const result = await method.apply(this, args);
        const duration = Date.now() - startTime;
        
        // è®°å½•æ€§èƒ½æŒ‡æ ‡
        logger.debug(`è®¤è¯æµç¨‹å®Œæˆ: ${operation}`, {
          duration,
          success: true,
          timestamp: new Date().toISOString(),
        });
        
        return result;
      } catch (error) {
        const duration = Date.now() - startTime;
        logger.error(`è®¤è¯æµç¨‹å¤±è´¥: ${operation}`, {
          duration,
          error: error.message,
          success: false,
        });
        throw error;
      }
    };
  };
}
```

#### 3.2 åœ¨SmartAuthGuardä¸­ä½¿ç”¨ç›‘æ§
```typescript
@AuthFlowMonitor('smart_auth_guard')
async canActivate(context: ExecutionContext): Promise<boolean> {
  // åŸæœ‰é€»è¾‘
}
```

#### 3.3 åˆ›å»ºè®¤è¯æ€§èƒ½æŠ¥å‘Šç«¯ç‚¹
**æ–°æ–‡ä»¶**ï¼š`src/auth/controllers/auth-metrics.controller.ts`

```typescript
@Get('auth/metrics')
@Auth([UserRole.ADMIN])
async getAuthMetrics() {
  return {
    apiKeyValidationStats: await this.getApiKeyStats(),
    guardExecutionStats: await this.getGuardStats(),
    cacheHitRates: await this.getCacheStats(),
  };
}
```

---

### é˜¶æ®µå››ï¼šæ¶æ„å®Œå–„ï¼ˆé¢„è®¡è€—æ—¶ï¼š1-2å¤©ï¼‰

#### 4.1 å®ç°è®¤è¯ä¸Šä¸‹æ–‡ç¼“å­˜
**æ–°æ–‡ä»¶**ï¼š`src/auth/services/auth-context.service.ts`

```typescript
export interface AuthContext {
  subjectId: string;
  subjectType: 'api_key' | 'jwt_user';
  permissions: Permission[];
  roles?: UserRole[];
  expiresAt: Date;
  sessionId: string;
}

@Injectable()
export class AuthContextService {
  private readonly contextCache = new Map<string, AuthContext>();
  
  async getOrCreateContext(subject: AuthSubject): Promise<AuthContext> {
    const contextKey = this.generateContextKey(subject);
    
    let context = this.contextCache.get(contextKey);
    if (context && context.expiresAt > new Date()) {
      return context;
    }
    
    // åˆ›å»ºæ–°çš„è®¤è¯ä¸Šä¸‹æ–‡
    context = await this.buildAuthContext(subject);
    this.contextCache.set(contextKey, context);
    
    return context;
  }
}
```

#### 4.2 æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
**æ‰§è¡Œè„šæœ¬**ï¼š`scripts/optimize-auth-indexes.js`

```javascript
// ä¸ºAPI KeyæŸ¥è¯¢æ·»åŠ å¤åˆç´¢å¼•
db.apikeys.createIndex({ 
  appKey: 1, 
  accessToken: 1, 
  isActive: 1 
}, { 
  name: "apikey_validation_index",
  background: true 
});

// ä¸ºç”¨æˆ·æƒé™æŸ¥è¯¢ä¼˜åŒ–
db.users.createIndex({ 
  _id: 1, 
  role: 1, 
  isActive: 1 
}, {
  name: "user_permissions_index",
  background: true
});
```

---

## ğŸ¯ æ‰§è¡Œæ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº | ä¼˜å…ˆçº§ |
|------|------|----------|--------|--------|
| 1 | è¯·æ±‚çº§API Keyç¼“å­˜ | 2å°æ—¶ | åç«¯å¼€å‘ | ğŸ”´ æœ€é«˜ |
| 1 | å®ˆå«æ—©æœŸé€€å‡ºä¼˜åŒ– | 1å°æ—¶ | åç«¯å¼€å‘ | ğŸ”´ æœ€é«˜ |
| 1 | ç”Ÿäº§ç¯å¢ƒæ—¥å¿—ä¼˜åŒ– | 1å°æ—¶ | åç«¯å¼€å‘ | ğŸŸ¡ ä¸­ç­‰ |
| 2 | æ™ºèƒ½å®ˆå«è·¯ç”±å®ç° | 1å¤© | åç«¯å¼€å‘ | ğŸŸ  é«˜ |
| 2 | Redisç¼“å­˜å±‚æ·»åŠ  | 4å°æ—¶ | åç«¯å¼€å‘ | ğŸŸ  é«˜ |
| 3 | æ€§èƒ½ç›‘æ§è£…é¥°å™¨ | 4å°æ—¶ | åç«¯å¼€å‘ | ğŸŸ¡ ä¸­ç­‰ |
| 3 | ç›‘æ§æŠ¥å‘Šç«¯ç‚¹ | 2å°æ—¶ | åç«¯å¼€å‘ | ğŸŸ¡ ä¸­ç­‰ |
| 4 | è®¤è¯ä¸Šä¸‹æ–‡ç¼“å­˜ | 1å¤© | åç«¯å¼€å‘ | ğŸŸ¢ ä½ |
| 4 | æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– | 2å°æ—¶ | DBA | ğŸŸ¢ ä½ |

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

### ç«‹å³æ”¶ç›Šï¼ˆé˜¶æ®µä¸€å®Œæˆåï¼‰
- **API KeyéªŒè¯**ï¼šå‡å°‘70%é‡å¤æŸ¥è¯¢
- **å“åº”æ—¶é—´**ï¼šPublicç«¯ç‚¹æå‡90%
- **æ—¥å¿—I/O**ï¼šå‡å°‘60%å†™å…¥é‡

### ä¸­æœŸæ”¶ç›Šï¼ˆé˜¶æ®µäºŒå®Œæˆåï¼‰
- **æ•´ä½“è®¤è¯æµç¨‹**ï¼šæå‡40%å“åº”æ—¶é—´
- **å®ˆå«æ‰§è¡Œå¼€é”€**ï¼šå‡å°‘90%
- **ç³»ç»Ÿååé‡**ï¼šæå‡50%

### é•¿æœŸæ”¶ç›Šï¼ˆå…¨éƒ¨å®Œæˆåï¼‰
- **æ•°æ®åº“è´Ÿè½½**ï¼šå‡å°‘80%è®¤è¯ç›¸å…³æŸ¥è¯¢
- **å†…å­˜ä½¿ç”¨**ï¼šä¼˜åŒ–ç¼“å­˜ç­–ç•¥ï¼Œå‡å°‘30%å†…å­˜å ç”¨
- **ç³»ç»Ÿå¯æ‰©å±•æ€§**ï¼šæ”¯æŒ3å€å¹¶å‘é‡

## âœ… éªŒè¯å’Œæµ‹è¯•

### 1. æ€§èƒ½åŸºå‡†æµ‹è¯•
```bash
# ä¼˜åŒ–å‰æ€§èƒ½æµ‹è¯•
k6 run --vus 100 --duration 30s scripts/auth-performance-test.js

# è®°å½•åŸºå‡†æ•°æ®
# - å¹³å‡å“åº”æ—¶é—´
# - é”™è¯¯ç‡
# - æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
```

### 2. åŠŸèƒ½å›å½’æµ‹è¯•
```bash
# ç¡®ä¿æ‰€æœ‰è®¤è¯åŠŸèƒ½æ­£å¸¸
bun run test:auth
bun run test:e2e:auth
```

### 3. ç›‘æ§éªŒè¯
- æ£€æŸ¥API Keyç¼“å­˜å‘½ä¸­ç‡ > 90%
- ç¡®è®¤é‡å¤è®¤è¯æ—¥å¿—æ¶ˆå¤±
- éªŒè¯å®ˆå«æ‰§è¡Œæ¬¡æ•°å‡å°‘

## ğŸš¨ é£é™©è¯„ä¼°å’Œå›æ»šè®¡åˆ’

### é£é™©è¯†åˆ«
1. **ç¼“å­˜ä¸€è‡´æ€§**ï¼šAPI Keyç¼“å­˜å¯èƒ½å¯¼è‡´æƒé™æ›´æ–°å»¶è¿Ÿ
2. **å†…å­˜æ³„æ¼**ï¼šè¯·æ±‚çº§ç¼“å­˜å¦‚æœä¸æ­£ç¡®æ¸…ç†å¯èƒ½å¯¼è‡´å†…å­˜é—®é¢˜
3. **å…¼å®¹æ€§**ï¼šæ™ºèƒ½å®ˆå«å¯èƒ½ä¸ç°æœ‰è£…é¥°å™¨ä¸å…¼å®¹

### å›æ»šè®¡åˆ’
1. **é˜¶æ®µä¸€å›æ»š**ï¼šç®€å•ç§»é™¤ç¼“å­˜é€»è¾‘ï¼Œæ¢å¤åŸå§‹æ•°æ®åº“æŸ¥è¯¢
2. **é˜¶æ®µäºŒå›æ»š**ï¼šæ¢å¤app.module.tsä¸­çš„åŸå§‹å®ˆå«é…ç½®
3. **ç›‘æ§å›æ»š**ï¼šç§»é™¤æ–°å¢çš„ç›‘æ§ç«¯ç‚¹å’Œè£…é¥°å™¨

### åº”æ€¥æªæ–½
```bash
# ç´§æ€¥å›æ»šè„šæœ¬
git checkout HEAD~1 src/auth/services/apikey.service.ts
git checkout HEAD~1 src/app.module.ts
bun run build && bun run start:prod
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### é˜¶æ®µä¸€å®Œæˆæ£€æŸ¥
- [ ] è¯·æ±‚çº§API Keyç¼“å­˜å®ç°
- [ ] å®ˆå«æ—©æœŸé€€å‡ºä¼˜åŒ–
- [ ] ç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«è°ƒæ•´
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ
- [ ] åŠŸèƒ½å›å½’æµ‹è¯•é€šè¿‡

### é˜¶æ®µäºŒå®Œæˆæ£€æŸ¥
- [ ] SmartAuthGuardå®ç°å¹¶æµ‹è¯•
- [ ] app.module.tså®ˆå«é…ç½®æ›´æ–°
- [ ] Redisç¼“å­˜å±‚é›†æˆ
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯
- [ ] æ€§èƒ½æå‡éªŒè¯

### é˜¶æ®µä¸‰å®Œæˆæ£€æŸ¥
- [ ] è®¤è¯æ€§èƒ½ç›‘æ§è£…é¥°å™¨
- [ ] ç›‘æ§æŠ¥å‘Šç«¯ç‚¹å®ç°
- [ ] ç›‘æ§æ•°æ®éªŒè¯
- [ ] æŠ¥è­¦è§„åˆ™é…ç½®

### é˜¶æ®µå››å®Œæˆæ£€æŸ¥
- [ ] è®¤è¯ä¸Šä¸‹æ–‡ç¼“å­˜æœåŠ¡
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- [ ] æœ€ç»ˆæ€§èƒ½éªŒè¯
- [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ

---

**æ‰§è¡Œå»ºè®®**ï¼šä¼˜å…ˆå®Œæˆé˜¶æ®µä¸€ï¼Œç«‹å³è§£å†³é‡å¤è®¤è¯é—®é¢˜ã€‚é˜¶æ®µäºŒå¯ä»¥ä¸é˜¶æ®µä¸‰å¹¶è¡Œå¼€å‘ã€‚é˜¶æ®µå››å¯ä»¥ä½œä¸ºåç»­ä¼˜åŒ–é¡¹ç›®ã€‚

**å…³é”®æˆåŠŸæŒ‡æ ‡**ï¼š
1. API Keyé‡å¤éªŒè¯æ—¥å¿—æ¶ˆå¤±
2. è®¤è¯ç›¸å…³å“åº”æ—¶é—´å‡å°‘40%ä»¥ä¸Š
3. æ•°æ®åº“è¿æ¥æ•°å‡å°‘70%ä»¥ä¸Š
4. ç³»ç»Ÿåœ¨é«˜å¹¶å‘ä¸‹ç¨³å®šè¿è¡Œ