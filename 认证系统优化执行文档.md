# è®¤è¯ç³»ç»Ÿä¼˜åŒ–æ‰§è¡Œæ–‡æ¡£

åŸºäºæ—¥å¿—åˆ†æå’Œä»£ç å®¡æŸ¥ï¼Œåˆ¶å®šä»¥ä¸‹å®Œæ•´çš„è®¤è¯ç³»ç»Ÿä¼˜åŒ–æ‰§è¡Œè®¡åˆ’ã€‚

## ğŸ” åŸºäºå®é™…ä»£ç çš„è®¤è¯ç³»ç»Ÿåˆ†æç»“æœ

### å®é™…ä»£ç æ‰§è¡Œæµç¨‹åˆ†æ

#### 5ä¸ªå…¨å±€å®ˆå«çš„æ‰§è¡Œé¡ºåº (app.module.ts:120-138)
1. **ThrottlerGuard** - å…¨å±€é™æµ
2. **ApiKeyAuthGuard** - API Keyè®¤è¯ (æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢)
3. **JwtAuthGuard** - JWTè®¤è¯ (æ™ºèƒ½è·³è¿‡API Keyè¯·æ±‚)
4. **RateLimitGuard** - é¢‘ç‡é™åˆ¶ (è¯»å–request.user)
5. **UnifiedPermissionsGuard** - æƒé™æ£€æŸ¥ (è¯»å–request.user)

#### æ•°æ®åº“æŸ¥è¯¢åˆ†æ
**âœ… API Keyè¯·æ±‚çš„æ‰§è¡Œè·¯å¾„**ï¼š
- `ApiKeyAuthGuard.canActivate()` â†’ `super.canActivate()` â†’ `ApiKeyStrategy.validate()` â†’ `authService.validateApiKey()` â†’ `apiKeyService.validateApiKey()` â†’ **MongoDBæŸ¥è¯¢**
- éªŒè¯ç»“æœå­˜å‚¨åœ¨ `request.user`
- åç»­å®ˆå«ä» `request.user` è¯»å–ï¼Œ**æ— é‡å¤æ•°æ®åº“æŸ¥è¯¢**

#### æ™ºèƒ½è·³è¿‡é€»è¾‘ç¡®è®¤
**âœ… JwtAuthGuardçš„æ™ºèƒ½é€»è¾‘ (jwt-auth.guard.ts:35-41)**ï¼š
```typescript
const hasApiKeyHeaders = request.headers['x-app-key'] && request.headers['x-access-token'];
if (requireApiKey || hasApiKeyHeaders) {
  return true; // è·³è¿‡JWTè®¤è¯
}
```

### å®é™…å­˜åœ¨çš„æ€§èƒ½é—®é¢˜
1. **5ä¸ªå®ˆå«ä¾æ¬¡æ‰§è¡Œ**ï¼šæ¯ä¸ªè¯·æ±‚éƒ½å¿…é¡»é€šè¿‡æ‰€æœ‰å®ˆå«æ£€æŸ¥ âœ… ç¡®è®¤
2. **è·¨è¯·æ±‚é‡å¤æŸ¥è¯¢**ï¼šä¸åŒè¯·æ±‚ä½¿ç”¨ç›¸åŒAPI Keyæ—¶é‡å¤æ•°æ®åº“æŸ¥è¯¢ âœ… ç¡®è®¤  
3. **å®ˆå«æ‰§è¡Œå¼€é”€**ï¼šå³ä½¿æŸäº›å®ˆå«å¯ä»¥æå‰è·³è¿‡ï¼Œä»éœ€æ‰§è¡Œæ£€æŸ¥é€»è¾‘ âœ… ç¡®è®¤
4. **WebSocketç‹¬ç«‹è®¤è¯**ï¼šä¸HTTPå®ˆå«å¹¶è¡Œè¿è¡Œ âœ… ç¡®è®¤

### ä¿®æ­£çš„ç»“è®º
åŸºäºå®é™…ä»£ç åˆ†æï¼Œè®¤è¯ç³»ç»Ÿæ¶æ„**è®¾è®¡åˆç†**ï¼š
- âœ… å•æ¬¡è¯·æ±‚å†…æ— é‡å¤æ•°æ®åº“æŸ¥è¯¢
- âœ… ä½¿ç”¨request.userä¼ é€’è®¤è¯ç»“æœæ˜¯æ ‡å‡†åšæ³•
- âœ… JwtAuthGuardæœ‰æ™ºèƒ½è·³è¿‡é€»è¾‘

**çœŸæ­£çš„ä¼˜åŒ–ç©ºé—´**ï¼š
1. è·¨è¯·æ±‚API Keyç¼“å­˜ (Redis)
2. å®ˆå«æ‰§è¡Œé¡ºåºå’Œæ¡ä»¶ä¼˜åŒ–
3. å…¬å…±ç«¯ç‚¹çš„å®ˆå«è·³è¿‡æœºåˆ¶

## ğŸ“‹ ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’

### é˜¶æ®µä¸€ï¼šå®é™…æœ‰æ•ˆä¼˜åŒ–ï¼ˆé¢„è®¡è€—æ—¶ï¼š3-4å°æ—¶ï¼‰

#### 1.1 æ·»åŠ è·¨è¯·æ±‚Redisç¼“å­˜ï¼ˆè§£å†³çœŸå®æ€§èƒ½ç“¶é¢ˆï¼‰
**æ–‡ä»¶**ï¼š`src/auth/services/apikey.service.ts`
**ä¼˜å…ˆçº§**ï¼šğŸ”´ æœ€é«˜
**é—®é¢˜**ï¼šç›¸åŒAPI Keyçš„ä¸åŒè¯·æ±‚éƒ½éœ€è¦æ‰§è¡ŒMongoDBæŸ¥è¯¢
**å®é™…ä»·å€¼**ï¼šé«˜é¢‘APIè°ƒç”¨åœºæ™¯ä¸‹æ˜¾è‘—å‡å°‘æ•°æ®åº“è´Ÿè½½

```typescript
// ä¿®æ”¹ApiKeyServiceçš„validateApiKeyæ–¹æ³•
@AuthPerformance("api_key")
async validateApiKey(appKey: string, accessToken: string): Promise<ApiKeyDocument> {
  const operation = APIKEY_OPERATIONS.VALIDATE_API_KEY;
  const cacheKey = `apikey:${appKey}:${accessToken}`;

  // 1. æ£€æŸ¥Redisç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼Œè·¨è¯·æ±‚æœ‰æ•ˆï¼‰
  try {
    const cached = await this.cacheService.get<ApiKeyDocument>(cacheKey);
    if (cached) {
      this.logger.debug('API Key Redisç¼“å­˜å‘½ä¸­', { 
        appKey: ApiKeyUtil.sanitizeAccessToken(appKey) 
      });
      return cached;
    }
  } catch (error) {
    // ç¼“å­˜æœåŠ¡å¼‚å¸¸æ—¶ç»§ç»­æ­£å¸¸æµç¨‹
    this.logger.warn('Redisç¼“å­˜è¯»å–å¤±è´¥ï¼Œç»§ç»­æ•°æ®åº“æŸ¥è¯¢', { error: error.message });
  }

  // 2. åŸæœ‰æ•°æ®åº“æŸ¥è¯¢é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
  const apiKey = await this.apiKeyModel.findOne({
    appKey, accessToken, isActive: true,
  }).exec();

  if (!apiKey) {
    this.logger.warn(ERROR_MESSAGES.API_CREDENTIALS_INVALID, { operation, appKey });
    throw new UnauthorizedException(ERROR_MESSAGES.API_CREDENTIALS_INVALID);
  }

  if (apiKey.expiresAt && apiKey.expiresAt < new Date()) {
    this.logger.warn(ERROR_MESSAGES.API_CREDENTIALS_EXPIRED, { operation, appKey });
    throw new UnauthorizedException(ERROR_MESSAGES.API_CREDENTIALS_EXPIRED);
  }

  // 3. ç¼“å­˜åˆ°Redisï¼ˆ5åˆ†é’ŸTTLï¼‰
  try {
    await this.cacheService.set(cacheKey, apiKey, { ttl: 300 });
  } catch (error) {
    // ç¼“å­˜å†™å…¥å¤±è´¥ä¸å½±å“æ­£å¸¸æµç¨‹
    this.logger.warn('Redisç¼“å­˜å†™å…¥å¤±è´¥', { error: error.message });
  }

  // 4. ä¿æŒåŸæœ‰çš„ä½¿ç”¨ç»Ÿè®¡æ›´æ–°é€»è¾‘
  this.updateApiKeyUsage(apiKey._id.toString()).catch((error) => {
    this.logger.error(ERROR_MESSAGES.UPDATE_USAGE_FAILED, {
      operation, apiKeyId: apiKey._id.toString(), error: error.stack,
    });
  });

  return apiKey;
}
```

#### 1.2 ä¼˜åŒ–å…¬å…±ç«¯ç‚¹çš„å®ˆå«è·³è¿‡æœºåˆ¶
**æ–‡ä»¶**ï¼š`src/auth/guards/*.ts`
**ä¼˜å…ˆçº§**ï¼šğŸ”´ æœ€é«˜  
**é—®é¢˜**ï¼šå…¬å…±ç«¯ç‚¹ä»éœ€æ‰§è¡Œæ‰€æœ‰5ä¸ªå®ˆå«çš„æ£€æŸ¥é€»è¾‘
**åŸºäºä»£ç åˆ†æ**ï¼šç°æœ‰å®ˆå«å·²æœ‰è·³è¿‡é€»è¾‘ï¼Œä½†ä»æœ‰ä¼˜åŒ–ç©ºé—´

```typescript
// åœ¨ApiKeyAuthGuardä¸­ (å·²å­˜åœ¨ï¼Œä½†å¯ä¼˜åŒ–)
if (isPublic) {
  return true; // æ—©æœŸé€€å‡ºï¼Œä½†ä»æ‰§è¡Œäº†reflectoræŸ¥è¯¢
}

// åœ¨JwtAuthGuardä¸­ (å·²å­˜åœ¨æ™ºèƒ½è·³è¿‡)
if (requireApiKey || hasApiKeyHeaders) {
  return true; // å·²ç»å¾ˆå¥½çš„è·³è¿‡é€»è¾‘
}

// ä¼˜åŒ–å»ºè®®ï¼šæ·»åŠ æ›´æ—©æœŸçš„å…¬å…±ç«¯ç‚¹æ£€æµ‹
if (isPublic) {
  return true; // åœ¨æ‰€æœ‰å®ˆå«çš„æœ€å¼€å§‹å°±æ£€æŸ¥
}
```

#### 1.3 å‡å°‘ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
**æ–‡ä»¶**ï¼šå¤šä¸ªæœåŠ¡æ–‡ä»¶
**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ ä¸­ç­‰

```typescript
// åœ¨æ‰€æœ‰è®¤è¯ç›¸å…³æœåŠ¡ä¸­æ·»åŠ æ¡ä»¶æ—¥å¿—
if (process.env.NODE_ENV !== 'production') {
  this.logger.debug('è¯¦ç»†è°ƒè¯•ä¿¡æ¯', { ... });
}

// åªä¿ç•™å…³é”®çš„é”™è¯¯å’Œè­¦å‘Šæ—¥å¿—
this.logger.warn('è®¤è¯å¤±è´¥', { endpoint, method, reason });
this.logger.error('è®¤è¯å¼‚å¸¸', { error: error.message });
```

**é¢„æœŸæ•ˆæœï¼ˆåŸºäºå®é™…ä»£ç åˆ†æï¼‰**ï¼š
- âœ… å‡å°‘80%çš„è·¨è¯·æ±‚MongoDBæŸ¥è¯¢ï¼ˆRedisç¼“å­˜å‘½ä¸­ç‡90%+ï¼‰
- âœ… å…¬å…±ç«¯ç‚¹è·³è¿‡é€»è¾‘ä¼˜åŒ–å¯æå‡å“åº”æ—¶é—´10-20%ï¼ˆç°æœ‰è·³è¿‡æœºåˆ¶å·²è¾ƒå¥½ï¼‰
- âœ… æ—¥å¿—ä¼˜åŒ–å‡å°‘I/Oå¼€é”€5-10%

---

### é˜¶æ®µäºŒï¼šæ¶æ„çº§ä¼˜åŒ–ï¼ˆé¢„è®¡è€—æ—¶ï¼š1-2å¤©ï¼‰

#### 2.1 å®ç°ç»Ÿä¸€è®¤è¯å®ˆå«ï¼ˆåŸºäºå®é™…ä»£ç è®¾è®¡ï¼‰
**æ–°æ–‡ä»¶**ï¼š`src/auth/guards/unified-auth.guard.ts`
**ä¼˜å…ˆçº§**ï¼šğŸŸ  é«˜
**åŸºäºå‘ç°**ï¼šç°æœ‰5ä¸ªå®ˆå«å„æœ‰èŒè´£ï¼Œå¯ä»¥åˆå¹¶ä¸ºæ›´é«˜æ•ˆçš„ç»Ÿä¸€å®ˆå«

```typescript
@Injectable()
export class UnifiedAuthGuard implements CanActivate {
  constructor(
    private reflector: Reflector,
    private apiKeyService: ApiKeyService,
    private jwtService: JwtService,
    private rateLimitService: RateLimitService,
    private permissionService: PermissionService,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    
    // 1. æœ€æ—©æœŸçš„å…¬å…±ç«¯ç‚¹æ£€æµ‹
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(), context.getClass(),
    ]);
    if (isPublic) {
      return true; // ç›´æ¥è·³è¿‡æ‰€æœ‰éªŒè¯
    }
    
    // 2. æ™ºèƒ½è®¤è¯ç±»å‹æ£€æµ‹ï¼ˆåŸºäºå®é™…headersï¼‰
    const authType = this.determineAuthType(request);
    
    // 3. æ ¹æ®è®¤è¯ç±»å‹æ‰§è¡Œå¯¹åº”æµç¨‹
    switch (authType) {
      case 'api_key':
        return this.executeApiKeyFlow(request, context);
      case 'jwt':  
        return this.executeJwtFlow(request, context);
      default:
        return false;
    }
  }
  
  private determineAuthType(request: any): 'api_key' | 'jwt' | 'none' {
    // åŸºäºå®é™…JwtAuthGuardçš„é€»è¾‘ (jwt-auth.guard.ts:35-36)
    if (request.headers['x-app-key'] && request.headers['x-access-token']) {
      return 'api_key';
    }
    if (request.headers['authorization']?.startsWith('Bearer ')) {
      return 'jwt';
    }
    return 'none';
  }
  
  private async executeApiKeyFlow(request: any, context: ExecutionContext): Promise<boolean> {
    // åˆå¹¶åŸæœ‰5ä¸ªå®ˆå«çš„é€»è¾‘åˆ°ä¸€ä¸ªæµç¨‹ä¸­
    // 1. Throttle check (å…¨å±€é™æµ)
    // 2. API Key validation (æ•°æ®åº“æŸ¥è¯¢)  
    // 3. Rate limit check (åŸºäºAPI Key)
    // 4. Permission check
    // å‡å°‘å®ˆå«é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€
  }
}
```

#### 2.2 æ›¿æ¢app.module.tsä¸­çš„å®ˆå«é…ç½®
**æ–‡ä»¶**ï¼š`src/app.module.ts`

```typescript
providers: [
  {
    provide: APP_GUARD,
    useClass: ThrottlerGuard, // ä¿ç•™åŸºç¡€é™æµ
  },
  {
    provide: APP_GUARD,
    useClass: SmartAuthGuard, // æ›¿æ¢æ‰€æœ‰è®¤è¯å®ˆå«
  },
],
```

#### 2.3 æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼ˆä»é˜¶æ®µå››æå‰ï¼‰
**æ–‡ä»¶**ï¼šæ•°æ®åº“ä¼˜åŒ–è„šæœ¬
**ä¼˜å…ˆçº§**ï¼šğŸŸ  é«˜
**åŸå› **ï¼šé…åˆRedisç¼“å­˜ï¼Œä¼˜åŒ–ç¼“å­˜æœªå‘½ä¸­æ—¶çš„æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

```javascript
// æ‰§è¡Œè„šæœ¬ï¼šscripts/optimize-auth-indexes.js
// ä¸ºAPI KeyæŸ¥è¯¢æ·»åŠ å¤åˆç´¢å¼•
db.apikeys.createIndex({ 
  appKey: 1, 
  accessToken: 1, 
  isActive: 1 
}, { 
  name: "apikey_validation_index",
  background: true 
});

// ä¸ºç”¨æˆ·æƒé™æŸ¥è¯¢ä¼˜åŒ–
db.users.createIndex({ 
  _id: 1, 
  role: 1, 
  isActive: 1 
}, {
  name: "user_permissions_index",
  background: true
});
```

**é¢„æœŸæ•ˆæœï¼ˆåŸºäºå®é™…ä»£ç åˆ†æçš„ç°å®é¢„æœŸï¼‰**ï¼š
- âœ… ç»Ÿä¸€å®ˆå«å‡å°‘å®ˆå«é—´ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæå‡æ€§èƒ½15-25%
- âœ… æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æå‡ç¼“å­˜æœªå‘½ä¸­åœºæ™¯æŸ¥è¯¢æ€§èƒ½30%+  
- âœ… å…¬å…±ç«¯ç‚¹å®Œå…¨è·³è¿‡è®¤è¯æµç¨‹ï¼Œæå‡å“åº”æ—¶é—´40%+
- âš ï¸ æ•´ä½“æ”¹å–„ç›¸å¯¹æ¸©å’Œï¼Œå› ä¸ºç°æœ‰æ¶æ„å·²è¾ƒåˆç†

---

### é˜¶æ®µä¸‰ï¼šç›‘æ§å¢å¼ºï¼ˆé¢„è®¡è€—æ—¶ï¼š4-6å°æ—¶ï¼‰

#### 3.1 æ·»åŠ è®¤è¯æ€§èƒ½ç›‘æ§è£…é¥°å™¨
**æ–°æ–‡ä»¶**ï¼š`src/auth/decorators/auth-performance.decorator.ts`

```typescript
export function AuthFlowMonitor(operation: string) {
  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const method = descriptor.value;
    
    descriptor.value = async function (...args: any[]) {
      const startTime = Date.now();
      const logger = createLogger(`AuthFlow:${operation}`);
      
      try {
        const result = await method.apply(this, args);
        const duration = Date.now() - startTime;
        
        // è®°å½•æ€§èƒ½æŒ‡æ ‡
        logger.debug(`è®¤è¯æµç¨‹å®Œæˆ: ${operation}`, {
          duration,
          success: true,
          timestamp: new Date().toISOString(),
        });
        
        return result;
      } catch (error) {
        const duration = Date.now() - startTime;
        logger.error(`è®¤è¯æµç¨‹å¤±è´¥: ${operation}`, {
          duration,
          error: error.message,
          success: false,
        });
        throw error;
      }
    };
  };
}
```

#### 3.2 åœ¨SmartAuthGuardä¸­ä½¿ç”¨ç›‘æ§
```typescript
@AuthFlowMonitor('smart_auth_guard')
async canActivate(context: ExecutionContext): Promise<boolean> {
  // åŸæœ‰é€»è¾‘
}
```

#### 3.3 åˆ›å»ºè®¤è¯æ€§èƒ½æŠ¥å‘Šç«¯ç‚¹
**æ–°æ–‡ä»¶**ï¼š`src/auth/controllers/auth-metrics.controller.ts`

```typescript
@Get('auth/metrics')
@Auth([UserRole.ADMIN])
async getAuthMetrics() {
  return {
    apiKeyValidationStats: await this.getApiKeyStats(),
    guardExecutionStats: await this.getGuardStats(),
    cacheHitRates: await this.getCacheStats(),
  };
}
```

---

### é˜¶æ®µå››ï¼šæ¶æ„å®Œå–„ï¼ˆé¢„è®¡è€—æ—¶ï¼š1-2å¤©ï¼‰

#### 4.1 å®ç°è®¤è¯ä¸Šä¸‹æ–‡ç¼“å­˜
**æ–°æ–‡ä»¶**ï¼š`src/auth/services/auth-context.service.ts`

```typescript
export interface AuthContext {
  subjectId: string;
  subjectType: 'api_key' | 'jwt_user';
  permissions: Permission[];
  roles?: UserRole[];
  expiresAt: Date;
  sessionId: string;
}

@Injectable()
export class AuthContextService {
  private readonly contextCache = new Map<string, AuthContext>();
  
  async getOrCreateContext(subject: AuthSubject): Promise<AuthContext> {
    const contextKey = this.generateContextKey(subject);
    
    let context = this.contextCache.get(contextKey);
    if (context && context.expiresAt > new Date()) {
      return context;
    }
    
    // åˆ›å»ºæ–°çš„è®¤è¯ä¸Šä¸‹æ–‡
    context = await this.buildAuthContext(subject);
    this.contextCache.set(contextKey, context);
    
    return context;
  }
}
```

#### 4.2 é«˜çº§ç¼“å­˜å¤±æ•ˆç­–ç•¥
**æ–°æ–‡ä»¶**ï¼š`src/auth/services/auth-cache-invalidation.service.ts`

```typescript
@Injectable()
export class AuthCacheInvalidationService {
  constructor(private readonly cacheService: CacheService) {}

  /**
   * API Keyæ›´æ–°æ—¶æ¸…ç†ç›¸å…³ç¼“å­˜
   */
  async invalidateApiKeyCache(appKey: string): Promise<void> {
    // æ¸…ç†æ‰€æœ‰ç›¸å…³çš„API Keyç¼“å­˜
    const pattern = `apikey:${appKey}:*`;
    const keys = await this.cacheService.keys(pattern);
    
    if (keys.length > 0) {
      await this.cacheService.del(keys);
      console.log(`æ¸…ç†äº†${keys.length}ä¸ªAPI Keyç›¸å…³ç¼“å­˜`);
    }
  }

  /**
   * ç”¨æˆ·æƒé™æ›´æ–°æ—¶æ¸…ç†ç›¸å…³ç¼“å­˜
   */
  async invalidateUserCache(userId: string): Promise<void> {
    const pattern = `user:${userId}:*`;
    const keys = await this.cacheService.keys(pattern);
    
    if (keys.length > 0) {
      await this.cacheService.del(keys);
      console.log(`æ¸…ç†äº†${keys.length}ä¸ªç”¨æˆ·ç›¸å…³ç¼“å­˜`);
    }
  }
}
```

---

## ğŸ¯ åŸºäºå®é™…ä»£ç åˆ†æçš„æ‰§è¡Œæ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº | ä¼˜å…ˆçº§ | å®é™…ä»·å€¼è¯„ä¼° |
|------|------|----------|--------|--------|-------------|
| 1 | è·¨è¯·æ±‚Redisç¼“å­˜ | 3å°æ—¶ | åç«¯å¼€å‘ | ğŸ”´ æœ€é«˜ | é«˜ä»·å€¼ï¼šå‡å°‘80%è·¨è¯·æ±‚æŸ¥è¯¢ |
| 1 | å…¬å…±ç«¯ç‚¹è·³è¿‡ä¼˜åŒ– | 2å°æ—¶ | åç«¯å¼€å‘ | ğŸŸ  é«˜ | ä¸­ä»·å€¼ï¼šç°æœ‰æœºåˆ¶å·²è¾ƒå¥½ |
| 1 | ç”Ÿäº§ç¯å¢ƒæ—¥å¿—ä¼˜åŒ– | 1å°æ—¶ | åç«¯å¼€å‘ | ğŸŸ¡ ä¸­ç­‰ | ä½ä»·å€¼ï¼šå¾®å°I/Oæ”¹å–„ |
| 2 | ç»Ÿä¸€è®¤è¯å®ˆå«å®ç° | 1.5å¤© | åç«¯å¼€å‘ | ğŸŸ  é«˜ | ä¸­ä»·å€¼ï¼šå‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ |
| 2 | æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– | 2å°æ—¶ | åç«¯å¼€å‘ | ğŸŸ  é«˜ | ä¸­ä»·å€¼ï¼šæ”¹å–„ç¼“å­˜æœªå‘½ä¸­åœºæ™¯ |
| 3 | æ€§èƒ½ç›‘æ§è£…é¥°å™¨ | 4å°æ—¶ | åç«¯å¼€å‘ | ğŸŸ¡ ä¸­ç­‰ | ä¸­ä»·å€¼ï¼šå¯è§‚æµ‹æ€§ |
| 3 | ç›‘æ§æŠ¥å‘Šç«¯ç‚¹ | 2å°æ—¶ | åç«¯å¼€å‘ | ğŸŸ¡ ä¸­ç­‰ | ä½ä»·å€¼ï¼šè¿ç»´ä¾¿åˆ©æ€§ |
| 4 | è®¤è¯ä¸Šä¸‹æ–‡ç¼“å­˜ | 1å¤© | åç«¯å¼€å‘ | ğŸŸ¢ ä½ | ä½ä»·å€¼ï¼šè¾¹é™…æ”¹å–„ |
| 4 | ç¼“å­˜å¤±æ•ˆç­–ç•¥ | 4å°æ—¶ | åç«¯å¼€å‘ | ğŸŸ¢ ä½ | ä¸­ä»·å€¼ï¼šæ•°æ®ä¸€è‡´æ€§ä¿è¯ |

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

### ç«‹å³æ”¶ç›Šï¼ˆé˜¶æ®µä¸€å®Œæˆåï¼‰- åŸºäºå®é™…ä»£ç åˆ†æ
- **è·¨è¯·æ±‚API KeyéªŒè¯**ï¼šå‡å°‘80%MongoDBæŸ¥è¯¢ï¼ˆé«˜é¢‘è°ƒç”¨åœºæ™¯æ˜¾è‘—æ”¹å–„ï¼‰
- **å…¬å…±ç«¯ç‚¹å“åº”æ—¶é—´**ï¼šå¾®å°æå‡ï¼ˆç°æœ‰è·³è¿‡æœºåˆ¶å·²è¾ƒå®Œå–„ï¼‰
- **æ—¥å¿—I/O**ï¼šå‡å°‘ä¸å¿…è¦çš„è°ƒè¯•æ—¥å¿—è¾“å‡º

### ä¸­æœŸæ”¶ç›Šï¼ˆé˜¶æ®µäºŒå®Œæˆåï¼‰- ç°å®é¢„æœŸ
- **ç»Ÿä¸€å®ˆå«æµç¨‹**ï¼šå‡å°‘å®ˆå«é—´åˆ‡æ¢å¼€é”€ï¼Œæ•´ä½“æå‡15-25%
- **æ•°æ®åº“ç´¢å¼•**ï¼šæ”¹å–„ç¼“å­˜æœªå‘½ä¸­åœºæ™¯çš„æŸ¥è¯¢æ€§èƒ½30%
- **æ¶æ„ç®€åŒ–**ï¼šä»£ç ç»´æŠ¤æ€§æå‡ï¼Œä½†æ€§èƒ½æ”¹å–„æœ‰é™

### é•¿æœŸæ”¶ç›Šï¼ˆå…¨éƒ¨å®Œæˆåï¼‰- ä¿å®ˆä¼°è®¡
- **æ•°æ®åº“è´Ÿè½½**ï¼šåœ¨é«˜é¢‘åœºæ™¯ä¸‹å‡å°‘70%è®¤è¯ç›¸å…³æŸ¥è¯¢
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šç¼“å­˜å¤±æ•ˆç­–ç•¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **å¯ç»´æŠ¤æ€§**ï¼šç»Ÿä¸€å®ˆå«æ¶æ„é™ä½å¤æ‚åº¦
- âš ï¸ **ç°å®è¯„ä¼°**ï¼šç°æœ‰ç³»ç»Ÿæ¶æ„åˆç†ï¼Œä¼˜åŒ–æ”¶ç›Šç›¸å¯¹æ¸©å’Œ

## âœ… éªŒè¯å’Œæµ‹è¯•

### 1. æ€§èƒ½åŸºå‡†æµ‹è¯•
```bash
# ä¼˜åŒ–å‰æ€§èƒ½æµ‹è¯•
k6 run --vus 100 --duration 30s scripts/auth-performance-test.js

# è®°å½•åŸºå‡†æ•°æ®
# - å¹³å‡å“åº”æ—¶é—´
# - é”™è¯¯ç‡
# - æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
```

### 2. åŠŸèƒ½å›å½’æµ‹è¯•
```bash
# ç¡®ä¿æ‰€æœ‰è®¤è¯åŠŸèƒ½æ­£å¸¸
bun run test:auth
bun run test:e2e:auth
```

### 3. ç›‘æ§éªŒè¯
- æ£€æŸ¥Redis API Keyç¼“å­˜å‘½ä¸­ç‡ > 90%
- ç¡®è®¤å•æ¬¡è¯·æ±‚ä¸­åªæœ‰ä¸€æ¬¡MongoDBæŸ¥è¯¢
- éªŒè¯å…¬å…±ç«¯ç‚¹ä¸æ‰§è¡Œè®¤è¯ç›¸å…³å®ˆå«
- éªŒè¯æ™ºèƒ½å®ˆå«è·¯ç”±æŒ‰ç«¯ç‚¹ç±»å‹æ­£ç¡®åˆ†æµ

## ğŸš¨ é£é™©è¯„ä¼°å’Œå›æ»šè®¡åˆ’

### é£é™©è¯†åˆ«
1. **Redisç¼“å­˜ä¸€è‡´æ€§**ï¼šAPI Keyç¼“å­˜å¯èƒ½å¯¼è‡´æƒé™æ›´æ–°å»¶è¿Ÿï¼ˆ5åˆ†é’ŸTTLå†…ï¼‰
2. **ç¼“å­˜æœåŠ¡ä¾èµ–**ï¼šRedisä¸å¯ç”¨æ—¶éœ€è¦æ­£ç¡®é™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢
3. **å…¼å®¹æ€§**ï¼šæ™ºèƒ½å®ˆå«å¯èƒ½ä¸ç°æœ‰è£…é¥°å™¨ä¸å…¼å®¹
4. **æ€§èƒ½å›é€€**ï¼šå¦‚æœä¼˜åŒ–ä¸å½“å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™

### å›æ»šè®¡åˆ’
1. **é˜¶æ®µä¸€å›æ»š**ï¼šç§»é™¤Redisç¼“å­˜é€»è¾‘ï¼Œä¿æŒç°æœ‰çš„å•æ¬¡æ•°æ®åº“æŸ¥è¯¢æœºåˆ¶
2. **é˜¶æ®µäºŒå›æ»š**ï¼šæ¢å¤app.module.tsä¸­çš„5ä¸ªç‹¬ç«‹å®ˆå«é…ç½®
3. **ç›‘æ§å›æ»š**ï¼šç§»é™¤æ–°å¢çš„ç›‘æ§ç«¯ç‚¹å’Œè£…é¥°å™¨
4. **ç´¢å¼•å›æ»š**ï¼šæ•°æ®åº“ç´¢å¼•å¯ä»¥ä¿ç•™ï¼Œä¸å½±å“åŠŸèƒ½

### åº”æ€¥æªæ–½
```bash
# ç´§æ€¥å›æ»šè„šæœ¬ - æ¢å¤åŸå§‹è®¤è¯é€»è¾‘
git checkout HEAD~1 src/auth/services/apikey.service.ts
git checkout HEAD~1 src/app.module.ts

# å¦‚æœéœ€è¦å›æ»šæ™ºèƒ½å®ˆå«
rm -f src/auth/guards/smart-auth.guard.ts

# é‡æ–°æ„å»ºå’Œå¯åŠ¨
bun run build && bun run start:prod
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### é˜¶æ®µä¸€å®Œæˆæ£€æŸ¥
- [ ] Redisè·¨è¯·æ±‚API Keyç¼“å­˜å®ç°
- [ ] ç¼“å­˜é™çº§æœºåˆ¶å®ç°ï¼ˆRedisä¸å¯ç”¨æ—¶ï¼‰
- [ ] å®ˆå«æ—©æœŸé€€å‡ºä¼˜åŒ–
- [ ] ç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«è°ƒæ•´
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆï¼ˆç¼“å­˜å‘½ä¸­ç‡>90%ï¼‰
- [ ] åŠŸèƒ½å›å½’æµ‹è¯•é€šè¿‡

### é˜¶æ®µäºŒå®Œæˆæ£€æŸ¥
- [ ] SmartAuthGuardå®ç°å¹¶æµ‹è¯•ï¼ˆæ¡ä»¶æ‰§è¡Œå®ˆå«ï¼‰
- [ ] app.module.tså®ˆå«é…ç½®æ›´æ–°
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–å®Œæˆ
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯ï¼ˆå„ç±»ç«¯ç‚¹æ­£ç¡®è·¯ç”±ï¼‰
- [ ] æ€§èƒ½æå‡éªŒè¯ï¼ˆ40%å“åº”æ—¶é—´æå‡ï¼‰

### é˜¶æ®µä¸‰å®Œæˆæ£€æŸ¥
- [ ] è®¤è¯æ€§èƒ½ç›‘æ§è£…é¥°å™¨
- [ ] ç›‘æ§æŠ¥å‘Šç«¯ç‚¹å®ç°
- [ ] ç›‘æ§æ•°æ®éªŒè¯
- [ ] æŠ¥è­¦è§„åˆ™é…ç½®

### é˜¶æ®µå››å®Œæˆæ£€æŸ¥
- [ ] è®¤è¯ä¸Šä¸‹æ–‡ç¼“å­˜æœåŠ¡
- [ ] ç¼“å­˜å¤±æ•ˆç­–ç•¥å®ç°
- [ ] æœ€ç»ˆæ€§èƒ½éªŒè¯ï¼ˆ85%æŸ¥è¯¢è´Ÿè½½å‡å°‘ï¼‰
- [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ

---

**æ‰§è¡Œå»ºè®®ï¼ˆåŸºäºä»£ç åˆ†æçš„å®¢è§‚è¯„ä¼°ï¼‰**ï¼š

1. **ä¼˜å…ˆçº§è°ƒæ•´**ï¼šç°æœ‰è®¤è¯ç³»ç»Ÿæ¶æ„åˆç†ï¼Œä¼˜åŒ–åº”èšç„¦äºçœŸå®ç“¶é¢ˆ
2. **Redisç¼“å­˜æ˜¯æ ¸å¿ƒ**ï¼šå”¯ä¸€èƒ½å¸¦æ¥æ˜¾è‘—æ”¹å–„çš„ä¼˜åŒ–ç‚¹
3. **ç»Ÿä¸€å®ˆå«å¯é€‰**ï¼šæ”¶ç›Šæœ‰é™ï¼ŒæŠ•å…¥äº§å‡ºæ¯”éœ€æƒè¡¡
4. **ç›‘æ§å¢å¼ºé‡è¦**ï¼šå¸®åŠ©è¯†åˆ«çœŸå®çš„æ€§èƒ½ç“¶é¢ˆ

**ç°å®çš„æˆåŠŸæŒ‡æ ‡**ï¼š
1. âœ… Redisç¼“å­˜å‘½ä¸­ç‡è¾¾åˆ°90%ä»¥ä¸Šï¼ˆé«˜é¢‘è°ƒç”¨åœºæ™¯ï¼‰
2. âœ… è·¨è¯·æ±‚MongoDBæŸ¥è¯¢å‡å°‘80%ï¼ˆå®é™…æœ‰ä»·å€¼çš„æŒ‡æ ‡ï¼‰
3. âœ… ç³»ç»Ÿåœ¨é«˜å¹¶å‘ä¸‹ç¨³å®šè¿è¡Œä¸”ç¼“å­˜é™çº§æ­£å¸¸
4. âš ï¸ æ•´ä½“æ€§èƒ½æ”¹å–„é¢„æœŸï¼šæ¸©å’Œæå‡ï¼ˆ10-30%ï¼‰ï¼Œè€Œéå‰§çƒˆæ”¹å–„
5. âœ… ä»£ç æ¶æ„æ›´æ¸…æ™°ï¼Œç»´æŠ¤æ€§æå‡

**é‡è¦è®¤çŸ¥**ï¼šåŸºäºå®é™…ä»£ç åˆ†æï¼Œç°æœ‰è®¤è¯ç³»ç»Ÿè®¾è®¡**å·²ç»ç›¸å½“åˆç†**ï¼Œå¤§å¹…ä¼˜åŒ–çš„ç©ºé—´æœ‰é™ã€‚