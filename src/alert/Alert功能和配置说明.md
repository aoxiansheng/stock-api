# Alertæ¨¡å—åŠŸèƒ½å’Œé…ç½®è¯´æ˜

## ğŸ“‹ æ¨¡å—æ¦‚è§ˆ

Alertæ¨¡å—æ˜¯ä¸€ä¸ªä¸“ä¸šåŒ–çš„å‘Šè­¦ç®¡ç†ç³»ç»Ÿï¼Œé‡‡ç”¨v2.0æ¶æ„ï¼ŒåŒ…å«7ä¸ªä¸“ä¸šåŒ–æœåŠ¡ã€2ä¸ªæ”¯æŒç»„ä»¶å’Œ2ä¸ªæ•°æ®ä»“å‚¨ï¼Œæä¾›å®Œæ•´çš„å‘Šè­¦è§„åˆ™ç®¡ç†ã€è¯„ä¼°ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œé€šçŸ¥åŠŸèƒ½ã€‚

---

## ğŸš€ å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

### 1. å‘Šè­¦è§„åˆ™ç®¡ç†
- âœ… **åˆ›å»ºå‘Šè­¦è§„åˆ™** - æ”¯æŒå¤šç§æŒ‡æ ‡ç›‘æ§ï¼ˆCPUã€å†…å­˜ã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ç­‰ï¼‰
- âœ… **æ›´æ–°å‘Šè­¦è§„åˆ™** - åŠ¨æ€ä¿®æ”¹è§„åˆ™é…ç½®
- âœ… **åˆ é™¤å‘Šè­¦è§„åˆ™** - å®‰å…¨åˆ é™¤å¹¶æ¸…ç†ç›¸å…³ç¼“å­˜
- âœ… **å¯ç”¨/ç¦ç”¨è§„åˆ™** - å¿«é€Ÿåˆ‡æ¢è§„åˆ™çŠ¶æ€
- âœ… **è·å–è§„åˆ™åˆ—è¡¨** - æ”¯æŒåˆ†é¡µå’Œç­›é€‰
- âœ… **è·å–è§„åˆ™è¯¦æƒ…** - æŸ¥çœ‹å•ä¸ªè§„åˆ™çš„å®Œæ•´ä¿¡æ¯

### 2. å‘Šè­¦è¯„ä¼°ç³»ç»Ÿ
- âœ… **è‡ªåŠ¨è¯„ä¼°** - å®šæœŸè¯„ä¼°æ‰€æœ‰å¯ç”¨çš„è§„åˆ™
- âœ… **æ‰‹åŠ¨è§¦å‘è¯„ä¼°** - æ”¯æŒæ‰‹åŠ¨è§¦å‘ç‰¹å®šè§„åˆ™æˆ–æ‰€æœ‰è§„åˆ™çš„è¯„ä¼°
- âœ… **æ‰¹é‡æŒ‡æ ‡å¤„ç†** - å¤„ç†å¤šä¸ªæŒ‡æ ‡æ•°æ®å¹¶è§¦å‘ç›¸åº”å‘Šè­¦
- âœ… **å†·å´æœŸç®¡ç†** - é˜²æ­¢å‘Šè­¦é¢‘ç¹è§¦å‘ï¼ˆcooldownæœºåˆ¶ï¼‰
- âœ… **æ“ä½œç¬¦æ”¯æŒ** - æ”¯æŒå¤šç§æ¯”è¾ƒæ“ä½œç¬¦ï¼ˆ>, <, >=, <=, ==, !=ï¼‰

### 3. å‘Šè­¦ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… **å‘Šè­¦è§¦å‘** - æ ¹æ®è§„åˆ™è‡ªåŠ¨è§¦å‘å‘Šè­¦
- âœ… **å‘Šè­¦ç¡®è®¤** - ç”¨æˆ·ç¡®è®¤å·²æ”¶åˆ°å‘Šè­¦ï¼ˆacknowledgeï¼‰
- âœ… **å‘Šè­¦è§£å†³** - æ ‡è®°å‘Šè­¦å·²è§£å†³ï¼ˆresolveï¼‰
- âœ… **æ‰¹é‡ç¡®è®¤** - æ‰¹é‡ç¡®è®¤å¤šä¸ªå‘Šè­¦
- âœ… **æ‰¹é‡è§£å†³** - æ‰¹é‡è§£å†³å¤šä¸ªå‘Šè­¦
- âœ… **çŠ¶æ€æµè½¬** - fired â†’ acknowledged â†’ resolved

### 4. å‘Šè­¦æŸ¥è¯¢å’Œç»Ÿè®¡
- âœ… **è·å–æ´»è·ƒå‘Šè­¦** - æŸ¥çœ‹å½“å‰æ‰€æœ‰æœªè§£å†³çš„å‘Šè­¦
- âœ… **å‘Šè­¦å†å²æŸ¥è¯¢** - æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´ã€ä¸¥é‡ç¨‹åº¦ã€çŠ¶æ€ç­‰æ¡ä»¶æŸ¥è¯¢
- âœ… **å‘Šè­¦ç»Ÿè®¡** - è·å–å‘Šè­¦ç³»ç»Ÿçš„ç»Ÿè®¡ä¿¡æ¯
- âœ… **æ€§èƒ½æŒ‡æ ‡** - è§¦å‘ç‡ã€å¹³å‡å“åº”æ—¶é—´ç­‰æ€§èƒ½æŒ‡æ ‡

### 5. å‘Šè­¦ç¼“å­˜ç®¡ç†
- âœ… **æ´»è·ƒå‘Šè­¦ç¼“å­˜** - Redisç¼“å­˜æ´»è·ƒå‘Šè­¦ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
- âœ… **å†·å´æœŸç¼“å­˜** - ç®¡ç†è§„åˆ™çš„å†·å´çŠ¶æ€
- âœ… **ç¼“å­˜åŒæ­¥** - è‡ªåŠ¨åŒæ­¥ç¼“å­˜ä¸æ•°æ®åº“
- âœ… **ç¼“å­˜æ¸…ç†** - è§„åˆ™åˆ é™¤æˆ–ç¦ç”¨æ—¶è‡ªåŠ¨æ¸…ç†ç›¸å…³ç¼“å­˜

### 6. å‘Šè­¦äº‹ä»¶ç³»ç»Ÿ
- âœ… **äº‹ä»¶å‘å¸ƒ** - å‘å¸ƒå‘Šè­¦ç›¸å…³äº‹ä»¶ï¼ˆfired, resolved, acknowledgedç­‰ï¼‰
- âœ… **äº‹ä»¶è®¢é˜…** - å…¶ä»–æ¨¡å—å¯è®¢é˜…å‘Šè­¦äº‹ä»¶
- âœ… **äº‹ä»¶ç±»å‹**:
  - `alert.fired` - å‘Šè­¦è§¦å‘
  - `alert.resolved` - å‘Šè­¦è§£å†³
  - `alert.acknowledged` - å‘Šè­¦ç¡®è®¤
  - `alert.suppressed` - å‘Šè­¦æŠ‘åˆ¶ï¼ˆå†·å´æœŸå†…ï¼‰
  - `alert.escalated` - å‘Šè­¦å‡çº§

### 7. é€šçŸ¥æ¸ é“æ”¯æŒ
- âœ… **å¤šæ¸ é“é€šçŸ¥** - æ”¯æŒ5ç§é€šçŸ¥æ¸ é“ï¼š
  - Email - é‚®ä»¶é€šçŸ¥
  - SMS - çŸ­ä¿¡é€šçŸ¥
  - Webhook - Webhookè°ƒç”¨
  - Push - æ¨é€é€šçŸ¥
  - In-App - åº”ç”¨å†…é€šçŸ¥

---

## ğŸ”§ é…ç½®é¡¹è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# å‘Šè­¦è¯„ä¼°é—´éš”ï¼ˆç§’ï¼‰
ALERT_EVALUATION_INTERVAL=60    # é»˜è®¤: 60ç§’

# Nodeç¯å¢ƒï¼ˆå½±å“ç¼“å­˜å’Œæ€§èƒ½é…ç½®ï¼‰
NODE_ENV=production             # development | test | production
```

### æ ¸å¿ƒé…ç½®å‚æ•°ï¼ˆalert.config.tsï¼‰

```typescript
{
  // è¯„ä¼°é—´éš”é…ç½®
  evaluationInterval: 60,        // é»˜è®¤60ç§’ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–

  // è§„åˆ™éªŒè¯é…ç½®
  validation: {
    duration: {
      min: 30,                   // æœ€å°æŒç»­æ—¶é—´: 30ç§’
      max: 600,                  // æœ€å¤§æŒç»­æ—¶é—´: 600ç§’ï¼ˆ10åˆ†é’Ÿï¼‰
    },
    cooldown: {
      min: 300,                  // æœ€å°å†·å´æœŸ: 300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
      max: 3000,                 // æœ€å¤§å†·å´æœŸ: 3000ç§’ï¼ˆ50åˆ†é’Ÿï¼‰
    },
  },

  // ç¼“å­˜é…ç½®
  cache: {
    cooldownPrefix: "alert:cooldown:",     // å†·å´æœŸç¼“å­˜é”®å‰ç¼€
    activeAlertPrefix: "active-alert",     // æ´»è·ƒå‘Šè­¦ç¼“å­˜é”®å‰ç¼€
    activeAlertTtlSeconds: 1800,          // ç¼“å­˜TTL: 30åˆ†é’Ÿ
  },
}
```

### é»˜è®¤å€¼é…ç½®ï¼ˆdefaults.constants.tsï¼‰

#### åŸºç¡€é»˜è®¤å€¼
```typescript
{
  operator: '>',                 // é»˜è®¤æ“ä½œç¬¦
  duration: 60,                  // é»˜è®¤æŒç»­æ—¶é—´: 60ç§’
  severity: 'medium',            // é»˜è®¤ä¸¥é‡ç¨‹åº¦
  enabled: true,                 // é»˜è®¤å¯ç”¨
  cooldown: 300,                 // é»˜è®¤å†·å´æœŸ: 300ç§’
  
  // å®¹é‡é™åˆ¶
  MAX_CONDITIONS: 10,            // æœ€å¤§æ¡ä»¶æ•°
  MAX_ACTIONS: 5,                // æœ€å¤§åŠ¨ä½œæ•°
  BATCH_SIZE: 100,              // æ‰¹é‡æ“ä½œå¤§å°
  
  // å­—ç¬¦ä¸²é•¿åº¦é™åˆ¶
  NAME_MAX_LENGTH: 100,          // åç§°æœ€å¤§é•¿åº¦
  DESCRIPTION_MAX_LENGTH: 500,   // æè¿°æœ€å¤§é•¿åº¦
  
  // è¶…æ—¶é…ç½®
  TIMEOUT_DEFAULT: 5000,         // é»˜è®¤è¶…æ—¶: 5ç§’
  RETRY_COUNT: 3,                // é»˜è®¤é‡è¯•æ¬¡æ•°
}
```

#### é…ç½®é¢„è®¾ç»„åˆ

**è§„åˆ™é…ç½®é¢„è®¾**:
- **QUICK** - å¿«é€Ÿè§„åˆ™ï¼ˆ30ç§’æŒç»­ï¼Œ300ç§’å†·å´ï¼‰
- **STANDARD** - æ ‡å‡†è§„åˆ™ï¼ˆ60ç§’æŒç»­ï¼Œ300ç§’å†·å´ï¼‰
- **COMPLEX** - å¤æ‚è§„åˆ™ï¼ˆ120ç§’æŒç»­ï¼Œ600ç§’å†·å´ï¼‰

**é€šçŸ¥é…ç½®é¢„è®¾**:
- **INSTANT** - å³æ—¶é€šçŸ¥ï¼ˆ5ç§’è¶…æ—¶ï¼Œ5æ¬¡é‡è¯•ï¼‰
- **STANDARD** - æ ‡å‡†é€šçŸ¥ï¼ˆ30ç§’è¶…æ—¶ï¼Œ3æ¬¡é‡è¯•ï¼‰
- **BATCH** - æ‰¹é‡é€šçŸ¥ï¼ˆ60ç§’è¶…æ—¶ï¼Œ1æ¬¡é‡è¯•ï¼‰

**æ€§èƒ½é…ç½®é¢„è®¾**:
- **HIGH_PERFORMANCE** - é«˜æ€§èƒ½ï¼ˆ20å¹¶å‘ï¼Œ1000æ‰¹é‡ï¼‰
- **BALANCED** - å¹³è¡¡æ¨¡å¼ï¼ˆ5å¹¶å‘ï¼Œ100æ‰¹é‡ï¼‰
- **CONSERVATIVE** - èµ„æºèŠ‚çº¦ï¼ˆ3å¹¶å‘ï¼Œ50æ‰¹é‡ï¼‰

#### ç¯å¢ƒç‰¹å®šé…ç½®

```typescript
// å¼€å‘ç¯å¢ƒ
DEVELOPMENT: {
  cacheEnabled: false,          // ä¸å¯ç”¨ç¼“å­˜
  batchSize: 20,                // å°æ‰¹é‡
  timeout: 1000,                // 1ç§’è¶…æ—¶
  retentionDays: 7,             // ä¿ç•™7å¤©
  logLevel: 'debug',
}

// ç”Ÿäº§ç¯å¢ƒ
PRODUCTION: {
  cacheEnabled: true,           // å¯ç”¨ç¼“å­˜
  batchSize: 1000,              // å¤§æ‰¹é‡
  timeout: 60000,               // 60ç§’è¶…æ—¶
  retentionDays: 90,            // ä¿ç•™90å¤©
  logLevel: 'warn',
}
```

---

## ğŸ¯ APIæ¥å£åˆ—è¡¨

### è§„åˆ™ç®¡ç†æ¥å£
| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | æƒé™è¦æ±‚ |
|------|------|------|----------|
| POST | `/alerts/rules` | åˆ›å»ºå‘Šè­¦è§„åˆ™ | Admin |
| GET | `/alerts/rules` | è·å–è§„åˆ™åˆ—è¡¨ | Admin |
| GET | `/alerts/rules/:ruleId` | è·å–è§„åˆ™è¯¦æƒ… | Admin |
| PUT | `/alerts/rules/:ruleId` | æ›´æ–°è§„åˆ™ | Admin |
| DELETE | `/alerts/rules/:ruleId` | åˆ é™¤è§„åˆ™ | Admin |
| POST | `/alerts/rules/:ruleId/toggle` | å¯ç”¨/ç¦ç”¨è§„åˆ™ | Admin |

### å‘Šè­¦ç®¡ç†æ¥å£
| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | æƒé™è¦æ±‚ |
|------|------|------|----------|
| GET | `/alerts/active` | è·å–æ´»è·ƒå‘Šè­¦ | Admin |
| GET | `/alerts/history` | æŸ¥è¯¢å‘Šè­¦å†å² | Admin |
| GET | `/alerts/stats` | è·å–ç»Ÿè®¡ä¿¡æ¯ | Admin |
| GET | `/alerts/:alertId` | è·å–å‘Šè­¦è¯¦æƒ… | Admin |
| POST | `/alerts/:alertId/acknowledge` | ç¡®è®¤å‘Šè­¦ | Admin |
| POST | `/alerts/:alertId/resolve` | è§£å†³å‘Šè­¦ | Admin |
| POST | `/alerts/trigger` | æ‰‹åŠ¨è§¦å‘è¯„ä¼° | Admin |
| POST | `/alerts/batch/acknowledge` | æ‰¹é‡ç¡®è®¤ | Admin |
| POST | `/alerts/batch/resolve` | æ‰¹é‡è§£å†³ | Admin |

---

## ğŸ—ï¸ æœåŠ¡æ¶æ„

### æ ¸å¿ƒæœåŠ¡ï¼ˆ7ä¸ªï¼‰
1. **AlertOrchestratorService** - ç¼–æ’æœåŠ¡ï¼ˆä¸»å…¥å£ï¼‰
2. **AlertRuleService** - è§„åˆ™ç®¡ç†æœåŠ¡
3. **AlertEvaluationService** - è§„åˆ™è¯„ä¼°æœåŠ¡
4. **AlertLifecycleService** - ç”Ÿå‘½å‘¨æœŸç®¡ç†æœåŠ¡
5. **AlertQueryService** - æŸ¥è¯¢ç»Ÿè®¡æœåŠ¡
6. **AlertCacheService** - ç¼“å­˜ç®¡ç†æœåŠ¡
7. **AlertEventPublisher** - äº‹ä»¶å‘å¸ƒæœåŠ¡

### æ”¯æŒç»„ä»¶ï¼ˆ2ä¸ªï¼‰
1. **AlertRuleValidator** - è§„åˆ™éªŒè¯å™¨
2. **RuleEvaluator** - è¯„ä¼°å¼•æ“

### æ•°æ®ä»“å‚¨ï¼ˆ2ä¸ªï¼‰
1. **AlertRuleRepository** - è§„åˆ™æ•°æ®ä»“å‚¨
2. **AlertHistoryRepository** - å†å²æ•°æ®ä»“å‚¨

---

## ğŸ“Š æ•°æ®æ¨¡å‹

### AlertRule Schema
```typescript
{
  name: string;              // è§„åˆ™åç§°
  description?: string;      // è§„åˆ™æè¿°
  metric: string;           // ç›‘æ§æŒ‡æ ‡
  operator: string;         // æ“ä½œç¬¦ (>, <, >=, <=, ==, !=)
  threshold: number;        // é˜ˆå€¼
  duration: number;         // æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
  severity: string;         // ä¸¥é‡ç¨‹åº¦ (critical, warning, info)
  enabled: boolean;         // æ˜¯å¦å¯ç”¨
  channels: string[];       // é€šçŸ¥æ¸ é“
  cooldown: number;         // å†·å´æ—¶é—´ï¼ˆç§’ï¼‰
  tags?: object;           // æ ‡ç­¾
  createdBy?: string;      // åˆ›å»ºè€…
}
```

### AlertHistory Schema
```typescript
{
  ruleId: string;           // å…³è”è§„åˆ™ID
  ruleName: string;         // è§„åˆ™åç§°
  metric: string;           // æŒ‡æ ‡åç§°
  value: number;            // å®é™…å€¼
  threshold: number;        // é˜ˆå€¼
  severity: string;         // ä¸¥é‡ç¨‹åº¦
  status: string;           // çŠ¶æ€ (fired, acknowledged, resolved)
  message: string;          // å‘Šè­¦æ¶ˆæ¯
  triggeredAt: Date;        // è§¦å‘æ—¶é—´
  acknowledgedBy?: string;  // ç¡®è®¤äºº
  acknowledgedAt?: Date;    // ç¡®è®¤æ—¶é—´
  resolvedBy?: string;      // è§£å†³äºº
  resolvedAt?: Date;        // è§£å†³æ—¶é—´
  duration?: number;        // æŒç»­æ—¶é—´
  context?: object;         // ä¸Šä¸‹æ–‡ä¿¡æ¯
}
```

---

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **æƒé™æ§åˆ¶** - æ‰€æœ‰æ¥å£éœ€è¦Adminæƒé™
2. **é€Ÿç‡é™åˆ¶** - æ‰‹åŠ¨è§¦å‘è¯„ä¼°é™åˆ¶ï¼š5æ¬¡/åˆ†é’Ÿ
3. **è¾“å…¥éªŒè¯** - ä¸¥æ ¼çš„DTOéªŒè¯
4. **å®¡è®¡æ—¥å¿—** - è®°å½•æ‰€æœ‰æ“ä½œ
5. **é˜²é‡å¤è§¦å‘** - å†·å´æœŸæœºåˆ¶é˜²æ­¢å‘Šè­¦é£æš´

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **Redisç¼“å­˜** - æ´»è·ƒå‘Šè­¦å’Œå†·å´çŠ¶æ€ç¼“å­˜
2. **æ‰¹é‡æ“ä½œ** - æ”¯æŒæ‰¹é‡ç¡®è®¤å’Œè§£å†³
3. **å¼‚æ­¥å¤„ç†** - äº‹ä»¶å‘å¸ƒé‡‡ç”¨å¼‚æ­¥æœºåˆ¶
4. **è¿æ¥æ± ** - MongoDBå’ŒRedisè¿æ¥æ± ä¼˜åŒ–
5. **æŸ¥è¯¢ä¼˜åŒ–** - ç´¢å¼•ä¼˜åŒ–å’Œåˆ†é¡µæŸ¥è¯¢

---

## ğŸš§ å¾…å®ç°åŠŸèƒ½

è¯¦è§ [alertå¾…åŠæ¸…å•.md](./alertå¾…åŠæ¸…å•.md)

ä¸»è¦åŒ…æ‹¬ï¼š
- ç»Ÿè®¡è¿½è¸ªåŠŸèƒ½ï¼ˆ6å¤„TODOï¼‰
- æ•°æ®åº“é«˜çº§æŸ¥è¯¢æ–¹æ³•ï¼ˆ3å¤„TODOï¼‰
- å‘Šè­¦å‡†ç¡®ç‡è®¡ç®—ï¼ˆ1å¤„TODOï¼‰
- å…¶ä»–å¢å¼ºåŠŸèƒ½ï¼ˆ9å¤„TODOï¼‰

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºå‘Šè­¦è§„åˆ™
```bash
POST /alerts/rules
{
  "name": "é«˜CPUä½¿ç”¨ç‡å‘Šè­¦",
  "metric": "cpu_usage",
  "operator": ">",
  "threshold": 80,
  "duration": 60,
  "severity": "warning",
  "channels": ["email", "sms"],
  "cooldown": 300
}
```

### æ‰‹åŠ¨è§¦å‘è¯„ä¼°
```bash
POST /alerts/trigger
{
  "metrics": [
    {
      "name": "cpu_usage",
      "value": 85,
      "timestamp": "2025-01-11T10:00:00Z"
    }
  ]
}
```

### ç¡®è®¤å‘Šè­¦
```bash
POST /alerts/{alertId}/acknowledge
{
  "acknowledgedBy": "admin@example.com",
  "comment": "æ­£åœ¨å¤„ç†"
}
```

---

*æœ€åæ›´æ–°æ—¶é—´: 2025-01-11*
*ç‰ˆæœ¬: v2.0*