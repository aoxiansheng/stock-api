# 全局分级日志系统使用说明

## 📖 快速开始

### 1. 基本使用

在任何服务或组件中使用全局日志控制：

```typescript
// 导入受控日志器
import { createControlledLogger } from '@common/logging/controlled-logger';

@Injectable()
export class MyService {
  // 创建日志器实例
  private readonly logger = createControlledLogger(MyService.name);
  
  someMethod() {
    // 使用标准日志方法
    this.logger.debug('Debug message');
    this.logger.info('Info message');
    this.logger.warn('Warning message');
    this.logger.error('Error message');
  }
}
```

### 2. 性能优化用法

避免不必要的计算开销：

```typescript
// ✅ 推荐：先检查级别再执行昂贵操作
if (this.logger.isDebugEnabled()) {
  const expensiveData = this.calculateComplexMetrics();
  this.logger.debug('Performance metrics', expensiveData);
}

// ❌ 避免：总是执行计算
this.logger.debug('Performance metrics', this.calculateComplexMetrics());
```

---

## ⚙️ 配置方式

### 配置优先级

系统按以下优先级应用配置：

1. **环境变量覆盖** （最高优先级）
2. **配置文件设置** 
3. **默认值** （最低优先级）

### 配置文件位置

系统按以下顺序查找配置文件：

1. `LOG_CONFIG_PATH` 环境变量指定的路径
2. `config/log-levels.json`
3. `log-levels.json` （项目根目录）
4. `log-levels.{NODE_ENV}.json` （环境特定）

---

## 📝 配置示例

### 主配置文件（config/log-levels.json）

这是标准配置文件，定义固定的日志级别：

```json
{
  "global": "info",
  
  "modules": {
    "MonitoringService": "debug",
    "AuthService": "warn",
    "DatabaseService": "error",
    "CacheService": "info"
  },
  
  "namespaces": {
    "*Service": "info",
    "*Controller": "debug",
    "*Repository": "warn",
    "Monitor*": "debug"
  },
  
  "features": {
    "enableStructuredLogging": true,
    "enableTimestamps": true,
    "enableMetadata": true
  },
  
  "performance": {
    "cacheEnabled": true,
    "cacheExpiry": 5000,
    "maxCacheSize": 1000
  }
}
```

### 环境变量配置（.env）

用于动态覆盖和环境特定设置：

```bash
# 全局日志级别
LOG_LEVEL=info

# 临时调试特定模块（覆盖配置文件）
LOG_LEVEL_OVERRIDE_MODULE=DatabaseService:debug

# 功能开关
DYNAMIC_LOG_LEVEL=true
LOG_PERFORMANCE_MODE=true

# 配置文件路径（可选）
LOG_CONFIG_PATH=./config/custom-log-levels.json
```

---

## 🎯 常见使用场景

### 场景1：开发环境调试

```bash
# .env.development
NODE_ENV=development
LOG_LEVEL=debug
LOG_LEVEL_OVERRIDE_MODULE=ProblematicService:trace
LOG_CONFIG_DEBUG=true
```

### 场景2：生产环境优化

```bash
# .env.production
NODE_ENV=production
# 不设置 LOG_LEVEL，使用配置文件的设置
LOG_PERFORMANCE_MODE=true
LOG_TO_FILE=true
LOG_FILE_PATH=/var/log/application
```

### 场景3：问题排查

临时启用特定模块的详细日志：

```bash
# 通过环境变量临时覆盖
export LOG_LEVEL_OVERRIDE_MODULE=AuthService:debug
npm run start

# 或使用 REST API（如果启用）
curl -X PUT http://localhost:3000/api/admin/log-levels/module/AuthService/debug
```

### 场景4：单元测试

```bash
# .env.test
NODE_ENV=test
LOG_LEVEL=error  # 只显示错误
DYNAMIC_LOG_LEVEL=false  # 禁用动态更新
```

---

## 🔍 日志级别说明

### 级别层次

从低到高的日志级别：

| 级别 | 数值 | 说明 | 使用场景 |
|------|------|------|----------|
| `silent` | 0 | 完全静默 | 测试环境 |
| `fatal` | 1 | 致命错误 | 系统崩溃 |
| `error` | 2 | 错误 | 异常和错误 |
| `warn` | 3 | 警告 | 潜在问题 |
| `info` | 4 | 信息 | 重要事件 |
| `debug` | 5 | 调试 | 调试信息 |
| `trace` | 6 | 追踪 | 详细追踪 |

### 级别控制逻辑

- 设置为 `info` 级别：只记录 `info`、`warn`、`error`、`fatal`
- 设置为 `debug` 级别：记录所有除 `trace` 外的日志
- 设置为 `error` 级别：只记录 `error` 和 `fatal`

---

## 📊 结构化日志

### 基本格式

```typescript
this.logger.info('User action', {
  userId: user.id,
  action: 'login',
  timestamp: new Date().toISOString(),
  metadata: {
    ip: request.ip,
    userAgent: request.headers['user-agent']
  }
});
```

### 错误日志格式

```typescript
catch (error) {
  this.logger.error('Operation failed', {
    error: error.message,
    stack: error.stack,
    context: {
      userId: user.id,
      operation: 'updateProfile',
      params: { ...params, password: '[REDACTED]' }
    }
  });
}
```

---

## 🛠️ 高级功能

### 动态更新日志级别

#### 使用 REST API

```bash
# 获取当前配置
GET /api/admin/log-levels

# 更新全局级别
PUT /api/admin/log-levels/global/debug

# 更新特定模块
PUT /api/admin/log-levels/module/MonitoringService/trace

# 批量更新
PUT /api/admin/log-levels/batch
Body: [
  { "target": "AuthService", "level": "debug", "type": "module" },
  { "target": "*Controller", "level": "info", "type": "namespace" }
]

# 重置为默认
PUT /api/admin/log-levels/reset
```

#### 使用代码

```typescript
@Injectable()
export class AdminService {
  constructor(private logLevelController: LogLevelController) {}
  
  enableDebugMode() {
    // 更新特定模块
    this.logLevelController.updateLogLevel(
      'ProblematicService',
      'debug',
      'module'
    );
    
    // 批量更新
    this.logLevelController.batchUpdate([
      { target: 'DatabaseService', level: 'debug', type: 'module' },
      { target: '*Repository', level: 'debug', type: 'namespace' }
    ]);
  }
}
```

### 命名空间通配符

支持使用通配符匹配多个组件：

- `*` - 匹配任意字符序列
- `?` - 匹配单个字符

示例：
- `*Service` - 匹配所有以 Service 结尾的组件
- `Monitor*` - 匹配所有以 Monitor 开头的组件
- `*Controller*` - 匹配包含 Controller 的组件
- `User?Service` - 匹配 UserAService, UserBService 等

---

## 📋 最佳实践

### 1. 命名规范

```typescript
// ✅ 推荐：使用清晰的类名
private readonly logger = createControlledLogger(MonitoringService.name);

// ✅ 推荐：使用模块化命名
private readonly logger = createControlledLogger('monitoring.cache');

// ❌ 避免：使用模糊名称
private readonly logger = createControlledLogger('service');
```

### 2. 配置组织

```typescript
// ✅ 推荐的配置结构
{
  "modules": {
    "// 监控组件": "===================",
    "MonitoringService": "info",
    "MonitoringCache": "warn",
    
    "// 认证组件": "===================",
    "AuthService": "warn",
    "AuthGuard": "error"
  }
}
```

### 3. 敏感信息处理

```typescript
// 自动过滤敏感字段
const sanitizedData = {
  ...userData,
  password: '[REDACTED]',
  token: '[REDACTED]',
  apiKey: '[REDACTED]'
};

this.logger.info('User data processed', sanitizedData);
```

### 4. 性能考虑

```typescript
// 在高频调用的地方使用级别检查
for (const item of largeArray) {
  if (this.logger.isDebugEnabled()) {
    this.logger.debug('Processing item', { item });
  }
  // 处理逻辑
}
```

---

## 🔍 故障排除

### 问题1：日志未输出

**检查步骤：**

1. 确认日志级别设置
```bash
echo $LOG_LEVEL
cat config/log-levels.json | grep "global"
```

2. 检查模块名称匹配
```typescript
// 确保 logger 名称与配置匹配
console.log('Logger context:', MyService.name);
```

3. 验证配置加载
```bash
LOG_CONFIG_DEBUG=true npm run start
```

### 问题2：配置未生效

**解决方案：**

1. 检查配置文件路径
```bash
ls -la config/log-levels.json
echo $LOG_CONFIG_PATH
```

2. 验证 JSON 格式
```bash
npx jsonlint config/log-levels.json
```

3. 查看合并后的配置
```bash
curl http://localhost:3000/api/admin/log-levels
```

### 问题3：性能问题

**优化方法：**

1. 启用性能模式
```bash
LOG_PERFORMANCE_MODE=true
```

2. 减少日志级别
```json
{
  "global": "warn",
  "modules": {
    "HotPath": "error"
  }
}
```

3. 使用级别检查
```typescript
if (this.logger.isDebugEnabled()) {
  // 昂贵操作
}
```

---

## 📚 参考资料

### 日志级别快速参考

| 环境 | 推荐全局级别 | 说明 |
|------|------------|------|
| 开发 | `debug` | 详细调试信息 |
| 测试 | `error` | 只关注错误 |
| 预发布 | `info` | 关键操作日志 |
| 生产 | `warn` | 警告和错误 |

### 配置文件模板

- [基础配置](./templates/log-levels.json)
- [开发配置](./templates/log-levels.development.json)
- [生产配置](./templates/log-levels.production.json)

### 相关文档

- [开发文档](./全局分级日志开发文档.md)
- [API 文档](./api-reference.md)
- [迁移指南](./migration-guide.md)

---

## 🆘 获取帮助

- **问题反馈**：创建 GitHub Issue
- **功能建议**：提交 Pull Request
- **紧急支持**：联系运维团队

---

**文档版本**：1.0.0  
**最后更新**：2024-01-11  
**适用版本**：v2.0.0+