# å…¨å±€åˆ†çº§æ—¥å¿—ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## ğŸ“– å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

åœ¨ä»»ä½•æœåŠ¡æˆ–ç»„ä»¶ä¸­ä½¿ç”¨å…¨å±€æ—¥å¿—æ§åˆ¶ï¼š

```typescript
// å¯¼å…¥å—æ§æ—¥å¿—å™¨
import { createControlledLogger } from '@common/logging/controlled-logger';

@Injectable()
export class MyService {
  // åˆ›å»ºæ—¥å¿—å™¨å®ä¾‹
  private readonly logger = createControlledLogger(MyService.name);
  
  someMethod() {
    // ä½¿ç”¨æ ‡å‡†æ—¥å¿—æ–¹æ³•
    this.logger.debug('Debug message');
    this.logger.info('Info message');
    this.logger.warn('Warning message');
    this.logger.error('Error message');
  }
}
```

### 2. æ€§èƒ½ä¼˜åŒ–ç”¨æ³•

é¿å…ä¸å¿…è¦çš„è®¡ç®—å¼€é”€ï¼š

```typescript
// âœ… æ¨èï¼šå…ˆæ£€æŸ¥çº§åˆ«å†æ‰§è¡Œæ˜‚è´µæ“ä½œ
if (this.logger.isDebugEnabled()) {
  const expensiveData = this.calculateComplexMetrics();
  this.logger.debug('Performance metrics', expensiveData);
}

// âŒ é¿å…ï¼šæ€»æ˜¯æ‰§è¡Œè®¡ç®—
this.logger.debug('Performance metrics', this.calculateComplexMetrics());
```

---

## âš™ï¸ é…ç½®æ–¹å¼

### é…ç½®ä¼˜å…ˆçº§

ç³»ç»ŸæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§åº”ç”¨é…ç½®ï¼š

1. **ç¯å¢ƒå˜é‡è¦†ç›–** ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. **é…ç½®æ–‡ä»¶è®¾ç½®** 
3. **é»˜è®¤å€¼** ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰

### é…ç½®æ–‡ä»¶ä½ç½®

ç³»ç»ŸæŒ‰ä»¥ä¸‹é¡ºåºæŸ¥æ‰¾é…ç½®æ–‡ä»¶ï¼š

1. `LOG_CONFIG_PATH` ç¯å¢ƒå˜é‡æŒ‡å®šçš„è·¯å¾„
2. `config/log-levels.json`
3. `log-levels.json` ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
4. `log-levels.{NODE_ENV}.json` ï¼ˆç¯å¢ƒç‰¹å®šï¼‰

---

## ğŸ“ é…ç½®ç¤ºä¾‹

### ä¸»é…ç½®æ–‡ä»¶ï¼ˆconfig/log-levels.jsonï¼‰

è¿™æ˜¯æ ‡å‡†é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰å›ºå®šçš„æ—¥å¿—çº§åˆ«ï¼š

```json
{
  "global": "info",
  
  "modules": {
    "MonitoringService": "debug",
    "AuthService": "warn",
    "DatabaseService": "error",
    "CacheService": "info"
  },
  
  "namespaces": {
    "*Service": "info",
    "*Controller": "debug",
    "*Repository": "warn",
    "Monitor*": "debug"
  },
  
  "features": {
    "enableStructuredLogging": true,
    "enableTimestamps": true,
    "enableMetadata": true
  },
  
  "performance": {
    "cacheEnabled": true,
    "cacheExpiry": 5000,
    "maxCacheSize": 1000
  }
}
```

### ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ.envï¼‰

ç”¨äºåŠ¨æ€è¦†ç›–å’Œç¯å¢ƒç‰¹å®šè®¾ç½®ï¼š

```bash
# å…¨å±€æ—¥å¿—çº§åˆ«
LOG_LEVEL=info

# ä¸´æ—¶è°ƒè¯•ç‰¹å®šæ¨¡å—ï¼ˆè¦†ç›–é…ç½®æ–‡ä»¶ï¼‰
LOG_LEVEL_OVERRIDE_MODULE=DatabaseService:debug

# åŠŸèƒ½å¼€å…³
DYNAMIC_LOG_LEVEL=true
LOG_PERFORMANCE_MODE=true

# é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
LOG_CONFIG_PATH=./config/custom-log-levels.json
```

---

## ğŸ¯ å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå¼€å‘ç¯å¢ƒè°ƒè¯•

```bash
# .env.development
NODE_ENV=development
LOG_LEVEL=debug
LOG_LEVEL_OVERRIDE_MODULE=ProblematicService:trace
LOG_CONFIG_DEBUG=true
```

### åœºæ™¯2ï¼šç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

```bash
# .env.production
NODE_ENV=production
# ä¸è®¾ç½® LOG_LEVELï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶çš„è®¾ç½®
LOG_PERFORMANCE_MODE=true
LOG_TO_FILE=true
LOG_FILE_PATH=/var/log/application
```

### åœºæ™¯3ï¼šé—®é¢˜æ’æŸ¥

ä¸´æ—¶å¯ç”¨ç‰¹å®šæ¨¡å—çš„è¯¦ç»†æ—¥å¿—ï¼š

```bash
# é€šè¿‡ç¯å¢ƒå˜é‡ä¸´æ—¶è¦†ç›–
export LOG_LEVEL_OVERRIDE_MODULE=AuthService:debug
npm run start

# æˆ–ä½¿ç”¨ REST APIï¼ˆå¦‚æœå¯ç”¨ï¼‰
curl -X PUT http://localhost:3000/api/admin/log-levels/module/AuthService/debug
```

### åœºæ™¯4ï¼šå•å…ƒæµ‹è¯•

```bash
# .env.test
NODE_ENV=test
LOG_LEVEL=error  # åªæ˜¾ç¤ºé”™è¯¯
DYNAMIC_LOG_LEVEL=false  # ç¦ç”¨åŠ¨æ€æ›´æ–°
```

---

## ğŸ” æ—¥å¿—çº§åˆ«è¯´æ˜

### çº§åˆ«å±‚æ¬¡

ä»ä½åˆ°é«˜çš„æ—¥å¿—çº§åˆ«ï¼š

| çº§åˆ« | æ•°å€¼ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|------|----------|
| `silent` | 0 | å®Œå…¨é™é»˜ | æµ‹è¯•ç¯å¢ƒ |
| `fatal` | 1 | è‡´å‘½é”™è¯¯ | ç³»ç»Ÿå´©æºƒ |
| `error` | 2 | é”™è¯¯ | å¼‚å¸¸å’Œé”™è¯¯ |
| `warn` | 3 | è­¦å‘Š | æ½œåœ¨é—®é¢˜ |
| `info` | 4 | ä¿¡æ¯ | é‡è¦äº‹ä»¶ |
| `debug` | 5 | è°ƒè¯• | è°ƒè¯•ä¿¡æ¯ |
| `trace` | 6 | è¿½è¸ª | è¯¦ç»†è¿½è¸ª |

### çº§åˆ«æ§åˆ¶é€»è¾‘

- è®¾ç½®ä¸º `info` çº§åˆ«ï¼šåªè®°å½• `info`ã€`warn`ã€`error`ã€`fatal`
- è®¾ç½®ä¸º `debug` çº§åˆ«ï¼šè®°å½•æ‰€æœ‰é™¤ `trace` å¤–çš„æ—¥å¿—
- è®¾ç½®ä¸º `error` çº§åˆ«ï¼šåªè®°å½• `error` å’Œ `fatal`

---

## ğŸ“Š ç»“æ„åŒ–æ—¥å¿—

### åŸºæœ¬æ ¼å¼

```typescript
this.logger.info('User action', {
  userId: user.id,
  action: 'login',
  timestamp: new Date().toISOString(),
  metadata: {
    ip: request.ip,
    userAgent: request.headers['user-agent']
  }
});
```

### é”™è¯¯æ—¥å¿—æ ¼å¼

```typescript
catch (error) {
  this.logger.error('Operation failed', {
    error: error.message,
    stack: error.stack,
    context: {
      userId: user.id,
      operation: 'updateProfile',
      params: { ...params, password: '[REDACTED]' }
    }
  });
}
```

---

## ğŸ› ï¸ é«˜çº§åŠŸèƒ½

### åŠ¨æ€æ›´æ–°æ—¥å¿—çº§åˆ«

#### ä½¿ç”¨ REST API

```bash
# è·å–å½“å‰é…ç½®
GET /api/admin/log-levels

# æ›´æ–°å…¨å±€çº§åˆ«
PUT /api/admin/log-levels/global/debug

# æ›´æ–°ç‰¹å®šæ¨¡å—
PUT /api/admin/log-levels/module/MonitoringService/trace

# æ‰¹é‡æ›´æ–°
PUT /api/admin/log-levels/batch
Body: [
  { "target": "AuthService", "level": "debug", "type": "module" },
  { "target": "*Controller", "level": "info", "type": "namespace" }
]

# é‡ç½®ä¸ºé»˜è®¤
PUT /api/admin/log-levels/reset
```

#### ä½¿ç”¨ä»£ç 

```typescript
@Injectable()
export class AdminService {
  constructor(private logLevelController: LogLevelController) {}
  
  enableDebugMode() {
    // æ›´æ–°ç‰¹å®šæ¨¡å—
    this.logLevelController.updateLogLevel(
      'ProblematicService',
      'debug',
      'module'
    );
    
    // æ‰¹é‡æ›´æ–°
    this.logLevelController.batchUpdate([
      { target: 'DatabaseService', level: 'debug', type: 'module' },
      { target: '*Repository', level: 'debug', type: 'namespace' }
    ]);
  }
}
```

### å‘½åç©ºé—´é€šé…ç¬¦

æ”¯æŒä½¿ç”¨é€šé…ç¬¦åŒ¹é…å¤šä¸ªç»„ä»¶ï¼š

- `*` - åŒ¹é…ä»»æ„å­—ç¬¦åºåˆ—
- `?` - åŒ¹é…å•ä¸ªå­—ç¬¦

ç¤ºä¾‹ï¼š
- `*Service` - åŒ¹é…æ‰€æœ‰ä»¥ Service ç»“å°¾çš„ç»„ä»¶
- `Monitor*` - åŒ¹é…æ‰€æœ‰ä»¥ Monitor å¼€å¤´çš„ç»„ä»¶
- `*Controller*` - åŒ¹é…åŒ…å« Controller çš„ç»„ä»¶
- `User?Service` - åŒ¹é… UserAService, UserBService ç­‰

---

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. å‘½åè§„èŒƒ

```typescript
// âœ… æ¨èï¼šä½¿ç”¨æ¸…æ™°çš„ç±»å
private readonly logger = createControlledLogger(MonitoringService.name);

// âœ… æ¨èï¼šä½¿ç”¨æ¨¡å—åŒ–å‘½å
private readonly logger = createControlledLogger('monitoring.cache');

// âŒ é¿å…ï¼šä½¿ç”¨æ¨¡ç³Šåç§°
private readonly logger = createControlledLogger('service');
```

### 2. é…ç½®ç»„ç»‡

```typescript
// âœ… æ¨èçš„é…ç½®ç»“æ„
{
  "modules": {
    "// ç›‘æ§ç»„ä»¶": "===================",
    "MonitoringService": "info",
    "MonitoringCache": "warn",
    
    "// è®¤è¯ç»„ä»¶": "===================",
    "AuthService": "warn",
    "AuthGuard": "error"
  }
}
```

### 3. æ•æ„Ÿä¿¡æ¯å¤„ç†

```typescript
// è‡ªåŠ¨è¿‡æ»¤æ•æ„Ÿå­—æ®µ
const sanitizedData = {
  ...userData,
  password: '[REDACTED]',
  token: '[REDACTED]',
  apiKey: '[REDACTED]'
};

this.logger.info('User data processed', sanitizedData);
```

### 4. æ€§èƒ½è€ƒè™‘

```typescript
// åœ¨é«˜é¢‘è°ƒç”¨çš„åœ°æ–¹ä½¿ç”¨çº§åˆ«æ£€æŸ¥
for (const item of largeArray) {
  if (this.logger.isDebugEnabled()) {
    this.logger.debug('Processing item', { item });
  }
  // å¤„ç†é€»è¾‘
}
```

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šæ—¥å¿—æœªè¾“å‡º

**æ£€æŸ¥æ­¥éª¤ï¼š**

1. ç¡®è®¤æ—¥å¿—çº§åˆ«è®¾ç½®
```bash
echo $LOG_LEVEL
cat config/log-levels.json | grep "global"
```

2. æ£€æŸ¥æ¨¡å—åç§°åŒ¹é…
```typescript
// ç¡®ä¿ logger åç§°ä¸é…ç½®åŒ¹é…
console.log('Logger context:', MyService.name);
```

3. éªŒè¯é…ç½®åŠ è½½
```bash
LOG_CONFIG_DEBUG=true npm run start
```

### é—®é¢˜2ï¼šé…ç½®æœªç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆï¼š**

1. æ£€æŸ¥é…ç½®æ–‡ä»¶è·¯å¾„
```bash
ls -la config/log-levels.json
echo $LOG_CONFIG_PATH
```

2. éªŒè¯ JSON æ ¼å¼
```bash
npx jsonlint config/log-levels.json
```

3. æŸ¥çœ‹åˆå¹¶åçš„é…ç½®
```bash
curl http://localhost:3000/api/admin/log-levels
```

### é—®é¢˜3ï¼šæ€§èƒ½é—®é¢˜

**ä¼˜åŒ–æ–¹æ³•ï¼š**

1. å¯ç”¨æ€§èƒ½æ¨¡å¼
```bash
LOG_PERFORMANCE_MODE=true
```

2. å‡å°‘æ—¥å¿—çº§åˆ«
```json
{
  "global": "warn",
  "modules": {
    "HotPath": "error"
  }
}
```

3. ä½¿ç”¨çº§åˆ«æ£€æŸ¥
```typescript
if (this.logger.isDebugEnabled()) {
  // æ˜‚è´µæ“ä½œ
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### æ—¥å¿—çº§åˆ«å¿«é€Ÿå‚è€ƒ

| ç¯å¢ƒ | æ¨èå…¨å±€çº§åˆ« | è¯´æ˜ |
|------|------------|------|
| å¼€å‘ | `debug` | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ |
| æµ‹è¯• | `error` | åªå…³æ³¨é”™è¯¯ |
| é¢„å‘å¸ƒ | `info` | å…³é”®æ“ä½œæ—¥å¿— |
| ç”Ÿäº§ | `warn` | è­¦å‘Šå’Œé”™è¯¯ |

### é…ç½®æ–‡ä»¶æ¨¡æ¿

- [åŸºç¡€é…ç½®](./templates/log-levels.json)
- [å¼€å‘é…ç½®](./templates/log-levels.development.json)
- [ç”Ÿäº§é…ç½®](./templates/log-levels.production.json)

### ç›¸å…³æ–‡æ¡£

- [å¼€å‘æ–‡æ¡£](./å…¨å±€åˆ†çº§æ—¥å¿—å¼€å‘æ–‡æ¡£.md)
- [API æ–‡æ¡£](./api-reference.md)
- [è¿ç§»æŒ‡å—](./migration-guide.md)

---

## ğŸ†˜ è·å–å¸®åŠ©

- **é—®é¢˜åé¦ˆ**ï¼šåˆ›å»º GitHub Issue
- **åŠŸèƒ½å»ºè®®**ï¼šæäº¤ Pull Request
- **ç´§æ€¥æ”¯æŒ**ï¼šè”ç³»è¿ç»´å›¢é˜Ÿ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0.0  
**æœ€åæ›´æ–°**ï¼š2024-01-11  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šv2.0.0+