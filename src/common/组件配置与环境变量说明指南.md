# 组件配置与环境变量说明指南

## 📋 目录
- [系统概述](#系统概述)
- [配置架构](#配置架构)
- [环境变量清单](#环境变量清单)
- [配置文件说明](#配置文件说明)
- [配置重叠与独占分析](#配置重叠与独占分析)
- [模块功能与配置](#模块功能与配置)
- [最佳实践](#最佳实践)

## 系统概述

Backend系统实现了完善的分层配置管理体系，包含**120+环境变量**和**15+配置文件**，覆盖8大功能域。系统采用"核心配置集中管理 + 模块配置分散管理"的架构，支持环境变量覆盖、功能开关和动态配置。

### 核心特性
- 🔧 **三级优先级**：环境变量 > 配置文件 > 默认值
- 🔐 **类型安全**：TypeScript接口定义 + Joi验证
- 🚀 **功能开关**：支持动态开关和紧急回滚
- 📊 **环境感知**：不同环境使用不同默认值

## 配置架构

```
┌─────────────────────────────────────────┐
│         ConfigurationModule             │
│         (配置管理核心模块)               │
└────────────┬────────────────────────────┘
             │
    ┌────────┴────────┬────────┬────────┐
    ▼                 ▼        ▼        ▼
┌──────────┐  ┌──────────┐ ┌──────┐ ┌──────────┐
│ App配置  │  │Feature   │ │Alert │ │Security  │
│          │  │Flags     │ │配置  │ │配置      │
└──────────┘  └──────────┘ └──────┘ └──────────┘
    │              │           │          │
    ▼              ▼           ▼          ▼
 环境变量      功能开关    业务配置   安全策略
```

## 环境变量清单

### 1. 基础应用配置 (15个)

| 环境变量 | 默认值 | 必需 | 说明 |
|---------|--------|------|------|
| `NODE_ENV` | development | ✅ | 运行环境：development/test/staging/production |
| `PORT` | 3000 | ❌ | 服务监听端口 |
| `APP_NAME` | smart-stock-data-system | ❌ | 应用名称 |
| `APP_VERSION` | 1.0.0 | ❌ | 应用版本 |
| `API_PREFIX` | api/v1 | ❌ | API路径前缀 |
| `CORS_ORIGIN` | * | ❌ | CORS允许的源 |
| `DISABLE_CSRF` | false | ❌ | 是否禁用CSRF保护 |
| `PROJECT_ROOT` | 自动检测 | ❌ | 项目根目录 |
| `LOG_LEVEL` | info | ❌ | 日志级别：error/warn/info/debug |
| `TRUSTED_PROXY` | false | ❌ | 是否信任代理 |
| `TRUSTED_PROXY_IPS` | - | ❌ | 信任的代理IP列表 |
| `ALLOWED_ORIGINS` | * | ❌ | 允许的源列表 |
| `ALLOW_PROXY_HEADERS_IN_TEST` | false | ❌ | 测试环境是否允许代理头 |
| `PERFORMANCE_MONITORING` | true | ❌ | 是否开启性能监控 |
| `METRICS_ENDPOINT` | /metrics | ❌ | 指标暴露端点 |

### 2. 数据库配置 (6个)

| 环境变量 | 默认值 | 必需 | 说明 |
|---------|--------|------|------|
| `MONGODB_URI` | mongodb://localhost:27017/smart-stock-data | ✅ | MongoDB连接字符串 |
| `MONGODB_POOL_SIZE` | 10 | ❌ | MongoDB连接池大小 |
| `REDIS_HOST` | localhost | ❌ | Redis服务器地址 |
| `REDIS_PORT` | 6379 | ❌ | Redis端口 |
| `REDIS_PASSWORD` | - | ❌ | Redis密码 |
| `REDIS_STREAM_CACHE_DB` | 2 | ❌ | Stream缓存使用的Redis数据库号 |

### 3. 安全认证配置 (7个)

| 环境变量 | 默认值 | 必需 | 说明 |
|---------|--------|------|------|
| `JWT_SECRET` | dev-secret-key | ✅ | JWT签名密钥（生产环境必须更改） |
| `JWT_EXPIRES_IN` | 24h | ❌ | JWT过期时间 |
| `JWT_REFRESH_EXPIRES_IN` | 7d | ❌ | JWT刷新令牌过期时间 |
| `IP_RATE_LIMIT_ENABLED` | true | ❌ | 是否启用IP限流 |
| `IP_RATE_LIMIT_MAX_REQUESTS` | 100 | ❌ | 限流窗口内最大请求数 |
| `IP_RATE_LIMIT_WINDOW_MS` | 60000 | ❌ | 限流窗口时间（毫秒） |
| `TIERED_HEALTHCHECK_ENABLED` | true | ❌ | 是否启用分层健康检查 |

### 4. 数据源配置 (8个)

| 环境变量 | 默认值 | 必需 | 说明 |
|---------|--------|------|------|
| `LONGPORT_APP_KEY` | - | ✅ | LongPort应用密钥 |
| `LONGPORT_APP_SECRET` | - | ✅ | LongPort应用密码 |
| `LONGPORT_ACCESS_TOKEN` | - | ✅ | LongPort访问令牌 |
| `LONGPORT_SG_APP_KEY` | - | ❌ | LongPort新加坡应用密钥 |
| `LONGPORT_SG_APP_SECRET` | - | ❌ | LongPort新加坡应用密码 |
| `LONGPORT_SG_ACCESS_TOKEN` | - | ❌ | LongPort新加坡访问令牌 |
| `ITICK_TOKEN` | - | ❌ | iTick API令牌 |
| `TWELVEDATA_API_KEY` | - | ❌ | TwelveData API密钥 |

### 5. 缓存系统配置 (26个)

#### 5.1 Symbol映射缓存
| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `SYMBOL_MAPPING_CACHE_ENABLED` | true | 是否启用Symbol映射缓存 |
| `SYMBOL_CACHE_MAX_SIZE` | 10000 | Symbol缓存最大条目数 |
| `SYMBOL_CACHE_TTL` | 3600000 | Symbol缓存TTL（毫秒） |
| `RULE_CACHE_MAX_SIZE` | 500 | 规则缓存最大条目数 |
| `RULE_CACHE_TTL` | 1800000 | 规则缓存TTL（毫秒） |
| `BATCH_RESULT_CACHE_MAX_SIZE` | 1000 | 批量结果缓存最大条目数 |
| `BATCH_RESULT_CACHE_TTL` | 300000 | 批量结果缓存TTL（毫秒） |

#### 5.2 通用缓存配置
| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `CACHE_DEFAULT_TTL` | 300 | 默认缓存TTL（秒） |
| `CACHE_MAX_ITEMS` | 1000 | 缓存最大条目数 |
| `CACHE_COMPRESSION_THRESHOLD` | 1024 | 压缩阈值（字节） |
| `CACHE_DECOMPRESSION_ENABLED` | true | 是否启用解压缩 |
| `CACHE_DECOMPRESSION_FALLBACK` | true | 解压失败是否回退 |
| `CACHE_DECOMPRESSION_MAX_CONCURRENT` | 10 | 最大并发解压数 |
| `CACHE_DECOMPRESSION_MAX_RETRY` | 3 | 最大重试次数 |
| `CACHE_DECOMPRESSION_TIMEOUT_MS` | 5000 | 解压超时时间 |
| `CACHE_DECOMPRESSION_METRICS_ENABLED` | true | 是否启用解压指标 |
| `CACHE_PERF_ALERT_THRESHOLD` | 1000 | 性能告警阈值（毫秒） |
| `CACHE_ERROR_ALERT_THRESHOLD` | 10 | 错误告警阈值 |

#### 5.3 Stream缓存配置
| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `STREAM_CACHE_HOT_TTL_MS` | 5000 | 热数据TTL（毫秒） |
| `STREAM_CACHE_WARM_TTL_SECONDS` | 60 | 温数据TTL（秒） |
| `STREAM_CACHE_MAX_HOT_SIZE` | 100 | 热缓存最大大小 |
| `STREAM_CACHE_CLEANUP_INTERVAL_MS` | 60000 | 清理间隔 |
| `STREAM_CACHE_COMPRESSION_THRESHOLD` | 1024 | 压缩阈值 |
| `STORAGE_COMPRESS_THRESHOLD` | 1024 | 存储压缩阈值 |
| `STORAGE_COMPRESS_RATIO` | 0.8 | 存储压缩比率 |

### 6. 监控配置 (11个)

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `MONITORING_ENABLED` | true | 是否启用监控 |
| `MONITORING_CACHE_NAMESPACE` | monitoring | 缓存命名空间 |
| `MONITORING_KEY_INDEX_PREFIX` | idx | 索引键前缀 |
| `MONITORING_COMPRESSION_THRESHOLD` | 1024 | 压缩阈值 |
| `MONITORING_FALLBACK_THRESHOLD` | 100 | 回退阈值 |
| `MONITORING_TTL_HEALTH` | 300 | 健康数据TTL（秒） |
| `MONITORING_TTL_TREND` | 3600 | 趋势数据TTL（秒） |
| `MONITORING_TTL_PERFORMANCE` | 1800 | 性能数据TTL（秒） |
| `MONITORING_TTL_ALERT` | 86400 | 告警数据TTL（秒） |
| `MONITORING_TTL_CACHE_STATS` | 600 | 缓存统计TTL（秒） |
| `MONITORING_BATCH_SIZE` | 100 | 批处理大小 |

### 7. 告警配置 (5个)

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `ALERT_ENABLED` | true | 是否启用告警 |
| `ALERT_EVALUATION_INTERVAL` | 60000 | 评估间隔（毫秒） |
| `ALERT_CHANNELS` | log,email | 告警通道 |
| `ALERT_TRIGGER_RATE_LIMIT` | 10 | 触发限流 |
| `ALERT_NOTIFICATION_RATE_LIMIT` | 5 | 通知限流 |

### 8. 性能优化配置

#### 8.1 批处理配置
| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `BATCH_PROCESSING_ENABLED` | true | 是否启用批处理 |
| `BATCH_SIZE_DEFAULT` | 50 | 默认批量大小 |
| `BATCH_SIZE_MAX` | 1000 | 最大批量大小 |
| `BATCH_TIMEOUT_MS` | 100 | 批处理超时 |
| `BATCH_RETRY_ATTEMPTS` | 3 | 批处理重试次数 |

#### 8.2 对象池配置
| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `OBJECT_POOL_ENABLED` | true | 是否启用对象池 |
| `OBJECT_POOL_MIN_SIZE` | 10 | 对象池最小大小 |
| `OBJECT_POOL_MAX_SIZE` | 100 | 对象池最大大小 |
| `OBJECT_POOL_ACQUIRE_TIMEOUT` | 1000 | 获取超时 |

## 配置文件说明

### 核心配置文件

#### 1. `/src/appcore/configuration/config.module.ts`
- **功能**：配置管理核心模块，统一管理所有应用配置
- **特点**：集成Joi验证，合并多个子配置模块
- **依赖**：ConfigModule, JoiValidationSchema

#### 2. `/src/appcore/config/app.config.ts`
- **功能**：应用基础配置
- **配置项**：
  - 服务器配置（端口、环境、API前缀）
  - 数据库连接（MongoDB、Redis）
  - 安全配置（JWT、CORS、CSRF）
  - 缓存配置（默认TTL、最大条目）

#### 3. `/src/appcore/config/feature-flags.config.ts`
- **功能**：功能开关配置，支持动态开关系统功能
- **支持功能**：
  - Symbol映射缓存
  - 数据转换缓存
  - 对象池优化
  - 规则编译
  - 动态日志级别
- **默认状态**：大部分优化功能默认开启

### 业务模块配置文件

#### 4. `/src/alert/config/alert.config.ts`
- **功能**：告警系统配置
- **配置项**：评估间隔、规则验证、缓存TTL
- **特点**：简单配置，专注告警逻辑

#### 5. `/src/auth/config/security.config.ts`
- **功能**：安全策略配置
- **配置项**：
  - 密码策略（长度、复杂度）
  - 会话管理（JWT配置）
  - API限流策略
  - 审计配置
- **特点**：硬编码安全默认值

#### 6. `/src/monitoring/config/monitoring.config.ts`
- **功能**：监控系统配置
- **配置项**：
  - 缓存配置
  - 事件处理
  - 性能阈值
- **特点**：环境感知，生产环境更严格

#### 7. `/src/notification/config/notification.config.ts`
- **功能**：通知系统配置
- **配置项**：
  - 通知渠道
  - 消息模板
  - 发送策略

### 数据处理模块配置

#### 8. `/src/core/01-entry/query/config/query.config.ts`
- **功能**：查询组件配置
- **配置项**：
  - 批量处理限制
  - 超时控制
  - 内存监控
  - 性能调优
- **验证**：严格的数值范围检查

#### 9. `/src/core/01-entry/stream-receiver/config/stream-receiver.config.ts`
- **功能**：流接收器配置
- **配置项**：
  - 连接管理
  - 动态批处理
  - 内存监控
  - 频率限制
- **特点**：支持动态优化

#### 10. `/src/core/03-fetching/stream-data-fetcher/config/stream-recovery.config.ts`
- **功能**：流恢复配置
- **配置项**：
  - 队列配置
  - 限流策略
  - 优先级设置
  - 重连策略
- **特点**：支持多提供商差异化配置

## 配置重叠与独占分析

### 重叠配置（同时存在于配置文件和环境变量）

这些配置在配置文件中有默认值，但可通过环境变量覆盖：

| 配置项 | 配置文件位置 | 环境变量 | 优先级 |
|--------|-------------|----------|---------|
| 应用端口 | app.config.ts | PORT | 环境变量优先 |
| 运行环境 | app.config.ts | NODE_ENV | 环境变量优先 |
| MongoDB连接 | app.config.ts | MONGODB_URI | 环境变量优先 |
| Redis配置 | app.config.ts | REDIS_* | 环境变量优先 |
| JWT密钥 | app.config.ts | JWT_SECRET | 环境变量优先 |
| 缓存TTL | app.config.ts | CACHE_DEFAULT_TTL | 环境变量优先 |
| 告警开关 | alert.config.ts | ALERT_ENABLED | 环境变量优先 |
| 监控开关 | monitoring.config.ts | MONITORING_ENABLED | 环境变量优先 |

### 配置文件独占

仅在配置文件中定义，不支持环境变量覆盖：

| 配置类型 | 文件位置 | 说明 |
|---------|----------|------|
| **密码策略** | security.config.ts | 密码长度、复杂度要求、历史记录 |
| **会话配置** | security.config.ts | JWT算法、刷新策略 |
| **限流规则** | security.config.ts | API限流细节配置 |
| **审计策略** | security.config.ts | 审计日志级别、存储策略 |
| **通知模板** | notification.config.ts | 各类通知的消息模板 |
| **扫描规则** | provider-scan.config.ts | 提供商文件扫描规则 |
| **业务逻辑** | 各模块config文件 | 复杂的业务逻辑配置 |

### 环境变量独占

仅通过环境变量配置，没有对应的配置文件默认值：

| 配置类别 | 变量数量 | 典型变量 | 说明 |
|---------|----------|----------|------|
| **API凭据** | 8个 | LONGPORT_*, ITICK_TOKEN | 第三方服务密钥 |
| **WebSocket** | 15个 | WS_*, RECONNECT_* | 实时连接配置 |
| **数据恢复** | 20个 | RECOVERY_* | 故障恢复策略 |
| **查询优化** | 8个 | QUERY_* | 批量查询性能 |
| **性能调优** | 12个 | BATCH_*, OBJECT_POOL_* | 高级性能参数 |

## 模块功能与配置

### ConfigurationModule（配置核心）

**主要功能：**
- 集中管理所有应用配置
- 提供配置验证机制（Joi）
- 合并多个子配置模块
- 支持环境变量覆盖

**配置加载顺序：**
1. 加载默认配置
2. 加载环境特定配置
3. 应用环境变量覆盖
4. 执行配置验证

### FeatureFlags（功能开关系统）

**主要功能：**
- 统一管理系统功能开关
- 支持动态开关和紧急回滚
- 无需重启即可调整

**支持的功能开关：**
```typescript
{
  symbolMappingCache: true,      // Symbol映射缓存
  dataTransformCache: true,       // 数据转换缓存
  objectPool: true,              // 对象池优化
  ruleCompilation: true,         // 规则编译优化
  batchProcessing: true,         // 批处理优化
  dynamicLogLevel: true,         // 动态日志级别
  memoryMonitoring: true,        // 内存监控
  performanceTracking: true      // 性能追踪
}
```

### Alert模块

**主要功能：**
- 系统告警管理
- 规则评估引擎
- 多渠道通知

**配置需求：**
- 评估间隔（默认60秒）
- 告警规则配置
- 通知渠道设置
- 限流策略

### Security模块

**主要功能：**
- 身份认证（JWT）
- 访问控制（RBAC）
- API限流
- 安全审计

**配置特点：**
- 硬编码安全默认值
- 不允许降低安全级别
- 支持多层防护

### Monitoring模块

**主要功能：**
- 系统健康监控
- 性能指标收集
- 趋势分析
- 异常检测

**环境差异：**
- 开发环境：宽松阈值，详细日志
- 生产环境：严格阈值，精简日志

### Query模块

**主要功能：**
- 批量数据查询
- 智能缓存
- 并发控制
- 内存管理

**性能优化配置：**
```typescript
{
  maxBatchSize: 1000,           // 最大批量大小
  maxConcurrency: 10,           // 最大并发数
  timeout: 30000,               // 查询超时
  memoryLimit: 512 * 1024 * 1024, // 内存限制
  cacheStrategy: 'LRU'          // 缓存策略
}
```

### StreamReceiver模块

**主要功能：**
- WebSocket连接管理
- 实时数据接收
- 动态批处理
- 自动重连

**关键配置：**
- 连接池大小
- 重连策略
- 批处理窗口
- 背压控制

## 最佳实践

### 1. 环境变量管理

**推荐做法：**
- ✅ 使用`.env.example`作为模板
- ✅ 敏感信息使用环境变量
- ✅ 不同环境使用不同的`.env`文件
- ✅ 生产环境使用密钥管理服务

**避免：**
- ❌ 将`.env`文件提交到版本控制
- ❌ 在代码中硬编码密钥
- ❌ 使用过于简单的默认值

### 2. 配置验证

**推荐做法：**
```typescript
// 使用Joi进行严格验证
const validationSchema = Joi.object({
  NODE_ENV: Joi.string()
    .valid('development', 'test', 'staging', 'production')
    .required(),
  PORT: Joi.number().port().default(3000),
  JWT_SECRET: Joi.string().min(32).required()
});
```

### 3. 功能开关使用

**推荐场景：**
- 新功能灰度发布
- 性能优化开关
- 紧急问题回滚
- A/B测试

**使用示例：**
```typescript
if (featureFlags.isEnabled('newFeature')) {
  // 新功能代码
} else {
  // 旧功能代码
}
```

### 4. 配置分层

**推荐架构：**
```
默认配置（代码中）
    ↓
环境配置文件（.env.development）
    ↓
环境变量（运行时）
    ↓
动态配置（配置中心）
```

### 5. 安全配置

**生产环境必需：**
- 强密码的JWT_SECRET
- 正确的MONGODB_URI（包含认证）
- 合理的限流配置
- 启用所有安全特性

### 6. 性能配置

**根据负载调整：**
- 缓存大小和TTL
- 连接池大小
- 批处理参数
- 并发限制

### 7. 监控配置

**推荐设置：**
- 生产环境启用所有监控
- 合理设置告警阈值
- 配置多个通知渠道
- 定期审查监控数据

## 配置检查清单

### 部署前检查

- [ ] 所有必需环境变量已设置
- [ ] JWT_SECRET已更改为强密码
- [ ] 数据库连接字符串正确
- [ ] Redis配置正确
- [ ] 第三方API密钥已配置
- [ ] 监控和告警已启用
- [ ] 安全特性已启用
- [ ] 性能参数已调优

### 生产环境必需配置

```bash
# 必需的环境变量
NODE_ENV=production
MONGODB_URI=mongodb://user:pass@host:port/database
JWT_SECRET=your-secure-secret-key-min-32-chars
LONGPORT_APP_KEY=your-longport-key
LONGPORT_APP_SECRET=your-longport-secret
LONGPORT_ACCESS_TOKEN=your-longport-token

# 推荐的环境变量
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password
MONITORING_ENABLED=true
ALERT_ENABLED=true
IP_RATE_LIMIT_ENABLED=true
```

## 故障排查

### 常见问题

1. **配置未生效**
   - 检查环境变量是否正确设置
   - 确认配置优先级
   - 查看启动日志中的配置加载信息

2. **验证失败**
   - 检查必需配置项
   - 确认配置值格式正确
   - 查看Joi验证错误信息

3. **性能问题**
   - 调整缓存配置
   - 优化批处理参数
   - 检查连接池设置

4. **安全问题**
   - 确认JWT_SECRET已更改
   - 检查限流配置
   - 验证CORS设置

## 附录：环境变量快速参考

```bash
# 最小配置示例（开发环境）
NODE_ENV=development
MONGODB_URI=mongodb://localhost:27017/smart-stock-data
JWT_SECRET=dev-secret-key-for-testing-only

# 完整配置示例（生产环境）
NODE_ENV=production
PORT=3000
APP_NAME=smart-stock-data-system
MONGODB_URI=mongodb://user:pass@cluster.mongodb.net/database?retryWrites=true
REDIS_HOST=redis.example.com
REDIS_PORT=6379
REDIS_PASSWORD=redis-password
JWT_SECRET=super-secure-secret-key-minimum-32-characters
LONGPORT_APP_KEY=production-app-key
LONGPORT_APP_SECRET=production-app-secret
LONGPORT_ACCESS_TOKEN=production-access-token
MONITORING_ENABLED=true
ALERT_ENABLED=true
CACHE_DEFAULT_TTL=300
IP_RATE_LIMIT_ENABLED=true
IP_RATE_LIMIT_MAX_REQUESTS=100
IP_RATE_LIMIT_WINDOW_MS=60000
```

---

**文档版本**: v1.0  
**最后更新**: 2024-09-12  
**维护者**: Backend Team