# ğŸ“Š ç›‘æ§ç»„ä»¶äº‹ä»¶åŒ–æ¥å…¥æŒ‡å— 

> **ğŸ”¥ æ ¸å¿ƒç†å¿µ**ï¼šå®Œå…¨åŸºäºäº‹ä»¶é©±åŠ¨ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸ç›‘æ§çš„å½»åº•è§£è€¦

## âš¡ 1åˆ†é’Ÿäº‹ä»¶åŒ–æ¥å…¥

### Step 1: æ¨¡å—å¯¼å…¥
```typescript
// app.module.ts
import { MonitoringModule } from './monitoring/monitoring.module';

@Module({
  imports: [MonitoringModule], // è‡ªåŠ¨å¯ç”¨äº‹ä»¶é©±åŠ¨ç›‘æ§æ¶æ„
})
export class AppModule {}
```

### Step 2: å…¨å±€æ‹¦æˆªå™¨ï¼ˆé›¶é…ç½®APIç›‘æ§ï¼‰
```typescript
// main.ts
import { NestFactory } from '@nestjs/core';
import { ApiMonitoringInterceptor } from './monitoring/infrastructure/interceptors/api-monitoring.interceptor';

const app = await NestFactory.create(AppModule);
const apiMonitoringInterceptor = app.get(ApiMonitoringInterceptor);
app.useGlobalInterceptors(apiMonitoringInterceptor); // å…¨è‡ªåŠ¨APIç›‘æ§
```

### Step 3: äº‹ä»¶åŒ–ç›‘æ§ï¼ˆæ ¸å¿ƒæ¨è â­â­â­â­â­ï¼‰
```typescript
// ä»»æ„ä¸šåŠ¡æœåŠ¡ - åªéœ€æ³¨å…¥EventEmitter2
import { EventEmitter2 } from '@nestjs/event-emitter';
import { SYSTEM_STATUS_EVENTS } from './monitoring/contracts/events/system-status.events';

@Injectable()
export class UserService {
  constructor(private readonly eventBus: EventEmitter2) {} // é›¶ä¾èµ–æ³¨å…¥
  
  async createUser(userData: CreateUserDto) {
    const startTime = Date.now();
    
    try {
      const result = await this.userRepository.save(userData);
      
      // ğŸ¯ äº‹ä»¶åŒ–ç›‘æ§ï¼šå¼‚æ­¥ã€è§£è€¦ã€é«˜æ€§èƒ½
      setImmediate(() => {
        this.eventBus.emit(SYSTEM_STATUS_EVENTS.METRIC_COLLECTED, {
          timestamp: new Date(),
          source: 'user_service',
          metricType: 'database',
          metricName: 'user_created',
          metricValue: Date.now() - startTime,
          tags: { 
            operation: 'create',
            status: 'success',
            user_type: userData.type 
          }
        });
      });
      
      return result;
    } catch (error) {
      // é”™è¯¯ç›‘æ§åŒæ ·äº‹ä»¶åŒ–
      setImmediate(() => {
        this.eventBus.emit(SYSTEM_STATUS_EVENTS.METRIC_COLLECTED, {
          timestamp: new Date(),
          source: 'user_service',
          metricType: 'database',
          metricName: 'user_creation_failed',
          metricValue: Date.now() - startTime,
          tags: { 
            operation: 'create', 
            status: 'error',
            error_type: error.name 
          }
        });
      });
      throw error;
    }
  }
}
```

---

## ğŸš€ æ¨èæ¥å…¥æ¨¡å¼ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### ğŸ¥‡ æ¨¡å¼1: çº¯äº‹ä»¶é©±åŠ¨ï¼ˆæœ€æ¨è - å®Œå…¨è§£è€¦ï¼‰

```typescript
// ğŸ”¥ å®Œå…¨äº‹ä»¶åŒ–çš„ä¸šåŠ¡ç›‘æ§
@Injectable()
export class PaymentService {
  constructor(private readonly eventBus: EventEmitter2) {} // åªæ³¨å…¥äº‹ä»¶æ€»çº¿
  
  async processPayment(payment: PaymentDto) {
    const startTime = Date.now();
    
    try {
      // å‘é€å¤„ç†å¼€å§‹äº‹ä»¶
      this.emitMonitoringEvent('payment_started', {
        amount: payment.amount,
        method: payment.method
      });
      
      const result = await this.paymentGateway.charge(payment);
      
      // å‘é€æˆåŠŸäº‹ä»¶
      this.emitMonitoringEvent('payment_completed', {
        amount: payment.amount,
        method: payment.method,
        duration: Date.now() - startTime,
        provider: 'stripe'
      });
      
      return result;
    } catch (error) {
      // å‘é€å¤±è´¥äº‹ä»¶
      this.emitMonitoringEvent('payment_failed', {
        amount: payment.amount,
        method: payment.method,
        duration: Date.now() - startTime,
        error_type: error.constructor.name
      });
      throw error;
    }
  }
  
  // ğŸ¯ å°è£…äº‹ä»¶å‘é€é€»è¾‘ï¼Œä¿æŒä»£ç æ•´æ´
  private emitMonitoringEvent(metricName: string, data: any) {
    setImmediate(() => {
      this.eventBus.emit(SYSTEM_STATUS_EVENTS.METRIC_COLLECTED, {
        timestamp: new Date(),
        source: 'payment',
        metricType: 'business',
        metricName,
        metricValue: data.amount || data.duration || 1,
        tags: {
          method: data.method,
          provider: data.provider || 'internal',
          status: metricName.includes('failed') ? 'error' : 'success',
          ...data
        }
      });
    });
  }
}
```

### ğŸ¥ˆ æ¨¡å¼2: è£…é¥°å™¨å¢å¼ºï¼ˆåŸºç¡€è®¾æ–½å±‚æ€§èƒ½ç›‘æ§ï¼‰

```typescript
import { PerformanceMonitoring } from './monitoring/infrastructure/decorators/infrastructure-config.decorator';

@Injectable()
export class StockDataService {
  
  // è£…é¥°å™¨ä¸»è¦ç”¨äºåŸºç¡€è®¾æ–½å±‚çš„æ€§èƒ½ç›‘æ§ï¼Œè€Œéä¸šåŠ¡å±‚
  @PerformanceMonitoring({ 
    slowRequestThreshold: 500,
    recordMetrics: true,
    sampleRate: 1.0
  })
  async getStockQuote(symbol: string): Promise<StockQuote> {
    // çº¯ä¸šåŠ¡é€»è¾‘ï¼Œæ€§èƒ½ç›‘æ§å®Œå…¨é€æ˜
    // æ³¨æ„ï¼šæ­¤è£…é¥°å™¨ä¸»è¦ç”¨äºåŸºç¡€è®¾æ–½å±‚ç›‘æ§ï¼Œä¸šåŠ¡å±‚æ¨èä½¿ç”¨äº‹ä»¶é©±åŠ¨æ–¹å¼
    return await this.dataProvider.fetchQuote(symbol);
  }
  
  @PerformanceMonitoring({
    slowRequestThreshold: 1000,
    recordMetrics: true
  })
  async batchUpdateStocks(symbols: string[]): Promise<void> {
    // è£…é¥°å™¨è‡ªåŠ¨è®°å½•å“åº”æ—¶é—´å’Œæ…¢æŸ¥è¯¢
    // æ³¨æ„ï¼šæ­¤è£…é¥°å™¨ä¸»è¦ç”¨äºåŸºç¡€è®¾æ–½å±‚ç›‘æ§
  }
}
```

### ğŸ¥‰ æ¨¡å¼3: åˆ†æå±‚äº‹ä»¶é©±åŠ¨äº¤äº’

```typescript
// ğŸ“Š æ•°æ®åˆ†ææœåŠ¡ - é€šè¿‡äº‹ä»¶é©±åŠ¨æ–¹å¼ä¸æ”¶é›†å±‚äº¤äº’
@Injectable()
export class DashboardService {
  constructor(
    private readonly eventBus: EventEmitter2,
    private readonly analyzer: AnalyzerService // åˆ†ææœåŠ¡å·²äº‹ä»¶åŒ–
  ) {}
  
  async getDashboardData() {
    // åˆ†ææœåŠ¡å†…éƒ¨é€šè¿‡äº‹ä»¶é©±åŠ¨æ–¹å¼è·å–æ•°æ®ï¼ŒAPIä¿æŒä¸å˜
    // å®ç°æœºåˆ¶ï¼šAnalyzerServiceé€šè¿‡SYSTEM_STATUS_EVENTS.DATA_REQUESTäº‹ä»¶è¯·æ±‚æ•°æ®ï¼Œ
    // CollectorServiceé€šè¿‡SYSTEM_STATUS_EVENTS.DATA_RESPONSEäº‹ä»¶å“åº”æ•°æ®
    const healthScore = await this.analyzer.getHealthScore();
    const performance = await this.analyzer.getPerformanceAnalysis();
    
    // å‘é€ä»ªè¡¨ç›˜è®¿é—®äº‹ä»¶
    this.emitEvent('dashboard_accessed', { 
      health_score: healthScore,
      performance_level: performance.healthScore > 70 ? 'good' : 'warning'
    });
    
    return { healthScore, performance };
  }
  
  private emitEvent(name: string, data: any) {
    setImmediate(() => {
      this.eventBus.emit(SYSTEM_STATUS_EVENTS.METRIC_COLLECTED, {
        timestamp: new Date(),
        source: 'dashboard',
        metricType: 'business',
        metricName: name,
        metricValue: 1,
        tags: data
      });
    });
  }
}
```

### âš ï¸ æ³¨æ„ï¼šCollectorServiceç›´æ¥æ³¨å…¥æ–¹å¼ï¼ˆå·²ä¸æ¨èï¼‰

```typescript
// âš ï¸ ä¸æ¨èä½†ä»ç„¶å¯ç”¨çš„æ¨¡å¼ï¼šç›´æ¥æ³¨å…¥CollectorService
@Injectable()
export class LegacyService {
  constructor(
    private readonly collectorService: CollectorService // å¯ç”¨ä½†ä¸æ¨è
  ) {}
  
  // è¯´æ˜ï¼šè™½ç„¶ä»å¯ç›´æ¥ä½¿ç”¨CollectorServiceï¼Œä½†æ¨èä½¿ç”¨äº‹ä»¶é©±åŠ¨æ–¹å¼
  // è¿™æ ·å¯ä»¥æ›´å¥½åœ°è§£è€¦ä¸šåŠ¡é€»è¾‘ä¸ç›‘æ§é€»è¾‘ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§
}
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆé€‰æ‹©äº‹ä»¶åŒ–æ¥å…¥ï¼Ÿ

### âœ… äº‹ä»¶åŒ–æ¶æ„ä¼˜åŠ¿

| æ–¹é¢ | äº‹ä»¶åŒ–æ¥å…¥ | ä¼ ç»Ÿç›´æ¥æ³¨å…¥ |
|-----|-----------|------------|
| **è€¦åˆåº¦** | âœ… é›¶è€¦åˆ | âŒ å¼ºè€¦åˆ |
| **æ€§èƒ½å½±å“** | âœ… å¼‚æ­¥å¤„ç†ï¼Œé›¶å½±å“ | âŒ åŒæ­¥è°ƒç”¨ï¼Œå¯èƒ½é˜»å¡ |
| **ä¾èµ–æ³¨å…¥** | âœ… åªéœ€EventEmitter2 | âŒ éœ€è¦å¤šä¸ªç›‘æ§æœåŠ¡ |
| **æµ‹è¯•å‹å¥½** | âœ… å¯ç‹¬ç«‹æµ‹è¯•ä¸šåŠ¡é€»è¾‘ | âŒ éœ€è¦mockå¤šä¸ªç›‘æ§æœåŠ¡ |
| **æ‰©å±•æ€§** | âœ… æ–°å¢ç›‘æ§æ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç  | âŒ éœ€è¦ä¿®æ”¹æ„é€ å‡½æ•°å’Œä¸šåŠ¡é€»è¾‘ |
| **é”™è¯¯éš”ç¦»** | âœ… ç›‘æ§å¤±è´¥ä¸å½±å“ä¸šåŠ¡ | âŒ ç›‘æ§å¼‚å¸¸å¯èƒ½å½±å“ä¸šåŠ¡ |
| **åˆ†æå±‚è§£è€¦** | âœ… é€šè¿‡äº‹ä»¶è¿›è¡Œæ•°æ®äº¤äº’ | âŒ ç›´æ¥ä¾èµ–æ”¶é›†å±‚ |

### ğŸš€ äº‹ä»¶åŒ–ç›‘æ§æ ¸å¿ƒåŸç†

```mermaid
graph TD
    A[ä¸šåŠ¡æœåŠ¡] -->|å‘é€äº‹ä»¶| B[Event Bus]
    B -->|äº‹ä»¶åˆ†å‘| C[MonitoringEventBridge]
    C -->|æ‰¹é‡å¤„ç†| D[PrometheusæŒ‡æ ‡]
    C -->|æ•°æ®å­˜å‚¨| E[MongoDB/Redis]
    
    F[AnalyzerService] -->|æ•°æ®è¯·æ±‚äº‹ä»¶| B
    B -->|äº‹ä»¶åˆ†å‘| G[CollectorService]
    G -->|æ•°æ®å“åº”äº‹ä»¶| F
    
    A -.->|é›¶ä¾èµ–| H[ç›‘æ§æœåŠ¡å®Œå…¨è§£è€¦]
    C -.->|å¼‚æ­¥å¤„ç†| I[ä¸å½±å“ä¸šåŠ¡æ€§èƒ½]
```

---

## ğŸ› ï¸ äº‹ä»¶åŒ–ç›‘æ§æœ€ä½³å®è·µ

### 1. é€šç”¨äº‹ä»¶å‘é€è£…é¥°å™¨

```typescript
// ğŸ¨ è‡ªå®šä¹‰ç›‘æ§è£…é¥°å™¨
export function EventBasedMonitoring(options: {
  source: string;
  operation: string;
  metricType?: 'business' | 'database' | 'cache';
  includeArgs?: boolean;
}) {
  return function (target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const method = descriptor.value;
    
    descriptor.value = async function (...args: any[]) {
      const startTime = Date.now();
      const eventBus = this.eventBus || this.constructor.eventBus;
      
      try {
        const result = await method.apply(this, args);
        
        // æˆåŠŸäº‹ä»¶
        setImmediate(() => {
          eventBus?.emit(SYSTEM_STATUS_EVENTS.METRIC_COLLECTED, {
            timestamp: new Date(),
            source: options.source,
            metricType: options.metricType || 'business',
            metricName: `${options.operation}_success`,
            metricValue: Date.now() - startTime,
            tags: {
              operation: options.operation,
              status: 'success',
              ...(options.includeArgs && { args: JSON.stringify(args) })
            }
          });
        });
        
        return result;
      } catch (error) {
        // å¤±è´¥äº‹ä»¶
        setImmediate(() => {
          eventBus?.emit(SYSTEM_STATUS_EVENTS.METRIC_COLLECTED, {
            timestamp: new Date(),
            source: options.source,
            metricType: options.metricType || 'business',
            metricName: `${options.operation}_failed`,
            metricValue: Date.now() - startTime,
            tags: {
              operation: options.operation,
              status: 'error',
              error_type: error.constructor.name
            }
          });
        });
        
        throw error;
      }
    };
  };
}

// ğŸ’¡ ä½¿ç”¨è‡ªå®šä¹‰è£…é¥°å™¨
@Injectable()
export class ProductService {
  constructor(private readonly eventBus: EventEmitter2) {}
  
  @EventBasedMonitoring({
    source: 'product_service',
    operation: 'search_products',
    metricType: 'business'
  })
  async searchProducts(query: string): Promise<Product[]> {
    return await this.productRepository.search(query);
  }
}
```

### 3. æ‰¹é‡äº‹ä»¶å‘é€ä¼˜åŒ–

```typescript
// ğŸš€ æ‰¹é‡äº‹ä»¶å‘é€ä¼˜åŒ–å™¨
@Injectable()
export class BatchEventSender {
  private eventQueue: any[] = [];
  private flushTimer?: NodeJS.Timeout;
  
  constructor(private readonly eventBus: EventEmitter2) {}
  
  // æ‰¹é‡å‘é€äº‹ä»¶ï¼Œå‡å°‘äº‹ä»¶æ€»çº¿å‹åŠ›
  queueEvent(eventData: any) {
    this.eventQueue.push(eventData);
    
    // é˜Ÿåˆ—æ»¡æˆ–å®šæ—¶è§¦å‘æ‰¹é‡å‘é€
    if (this.eventQueue.length >= 10) {
      this.flushEvents();
    } else if (!this.flushTimer) {
      this.flushTimer = setTimeout(() => this.flushEvents(), 100);
    }
  }
  
  private flushEvents() {
    if (this.eventQueue.length === 0) return;
    
    const events = [...this.eventQueue];
    this.eventQueue = [];
    
    if (this.flushTimer) {
      clearTimeout(this.flushTimer);
      this.flushTimer = undefined;
    }
    
    // æ‰¹é‡å‘é€äº‹ä»¶
    setImmediate(() => {
      events.forEach(event => {
        this.eventBus.emit(SYSTEM_STATUS_EVENTS.METRIC_COLLECTED, event);
      });
    });
  }
}
```

---

## ğŸ“¡ æ”¯æŒçš„äº‹ä»¶ç±»å‹

ç›‘æ§ç³»ç»Ÿæ”¯æŒå¤šç§äº‹ä»¶ç±»å‹ï¼Œç”¨äºä¸åŒåœºæ™¯çš„ç›‘æ§éœ€æ±‚ï¼š

| äº‹ä»¶ç±»å‹ | ç”¨é€” | è§¦å‘æ—¶æœº |
|---------|------|---------|
| `SYSTEM_STATUS_EVENTS.METRIC_COLLECTED` | é€šç”¨æŒ‡æ ‡æ”¶é›† | ä¸šåŠ¡æ“ä½œå®Œæˆæ—¶ |
| `SYSTEM_STATUS_EVENTS.API_REQUEST_STARTED` | APIè¯·æ±‚å¼€å§‹ | HTTPè¯·æ±‚åˆ°è¾¾æ—¶ |
| `SYSTEM_STATUS_EVENTS.API_REQUEST_COMPLETED` | APIè¯·æ±‚å®Œæˆ | HTTPè¯·æ±‚å¤„ç†å®Œæˆæ—¶ |
| `SYSTEM_STATUS_EVENTS.API_REQUEST_ERROR` | APIè¯·æ±‚é”™è¯¯ | HTTPè¯·æ±‚å¤„ç†å‡ºé”™æ—¶ |
| `SYSTEM_STATUS_EVENTS.CACHE_HIT` | ç¼“å­˜å‘½ä¸­ | ç¼“å­˜è¯»å–æˆåŠŸæ—¶ |
| `SYSTEM_STATUS_EVENTS.CACHE_MISS` | ç¼“å­˜æœªå‘½ä¸­ | ç¼“å­˜è¯»å–å¤±è´¥æ—¶ |
| `SYSTEM_STATUS_EVENTS.CACHE_SET` | ç¼“å­˜è®¾ç½® | ç¼“å­˜å†™å…¥æ—¶ |
| `SYSTEM_STATUS_EVENTS.CACHE_INVALIDATED` | ç¼“å­˜å¤±æ•ˆ | ç¼“å­˜è¢«æ¸…é™¤æ—¶ |
| `SYSTEM_STATUS_EVENTS.DATA_REQUEST` | æ•°æ®è¯·æ±‚ | åˆ†æå±‚è¯·æ±‚æ•°æ®æ—¶ |
| `SYSTEM_STATUS_EVENTS.DATA_RESPONSE` | æ•°æ®å“åº” | æ”¶é›†å±‚å“åº”æ•°æ®æ—¶ |
| `SYSTEM_STATUS_EVENTS.HEALTH_SCORE_UPDATED` | å¥åº·åˆ†æ›´æ–° | å¥åº·åˆ†è®¡ç®—å®Œæˆæ—¶ |

## ğŸ” äº‹ä»¶åŒ–ç›‘æ§è°ƒè¯•æŒ‡å—

### æŸ¥çœ‹äº‹ä»¶æµ

```bash
# å¯ç”¨äº‹ä»¶è°ƒè¯•
DEBUG=monitoring:events npm start

# æŸ¥çœ‹äº‹ä»¶ç»Ÿè®¡
curl http://localhost:3000/api/v1/monitoring/events/health

# æ£€æŸ¥äº‹ä»¶æ‰¹å¤„ç†çŠ¶æ€
curl http://localhost:3000/api/v1/monitoring/bridge/metrics

# æŸ¥çœ‹PrometheusæŒ‡æ ‡
curl http://localhost:3000/metrics | grep monitoring_
```

### äº‹ä»¶æµç¨‹éªŒè¯

```typescript
// æµ‹è¯•äº‹ä»¶å‘é€æ˜¯å¦æ­£å¸¸
@Injectable()
export class MonitoringTestService {
  constructor(private readonly eventBus: EventEmitter2) {}
  
  testEventFlow() {
    // å‘é€æµ‹è¯•äº‹ä»¶
    this.eventBus.emit(SYSTEM_STATUS_EVENTS.METRIC_COLLECTED, {
      timestamp: new Date(),
      source: 'test',
      metricType: 'business',
      metricName: 'test_event',
      metricValue: 1,
      tags: { test: true }
    });
    
    console.log('âœ… æµ‹è¯•äº‹ä»¶å·²å‘é€');
  }
}
```

### å¸¸è§é—®é¢˜æ’æŸ¥

```bash
# 1. æ£€æŸ¥EventEmitter2æ˜¯å¦æ­£ç¡®æ³¨å…¥
curl http://localhost:3000/api/v1/monitoring/status

# 2. æŸ¥çœ‹äº‹ä»¶å¤„ç†é”™è¯¯æ—¥å¿—
tail -f logs/monitoring.log | grep "äº‹ä»¶å¤„ç†å¤±è´¥"

# 3. ç›‘æ§äº‹ä»¶é˜Ÿåˆ—å¥åº·çŠ¶æ€
curl http://localhost:3000/api/v1/monitoring/bridge/metrics | jq '.batcher.metrics'

# 4. éªŒè¯æŒ‡æ ‡æ˜¯å¦æ­£ç¡®æ›´æ–°
curl http://localhost:3000/metrics | grep "receiver_requests_total"
```

---

## ğŸ“‹ äº‹ä»¶åŒ–æ¥å…¥æ£€æŸ¥æ¸…å•

### ğŸš€ åŸºç¡€æ¥å…¥æ£€æŸ¥ï¼ˆå¿…éœ€ï¼‰
- [ ] âœ… å·²åœ¨ `app.module.ts` ä¸­å¯¼å…¥ `MonitoringModule`
- [ ] âœ… å·²åœ¨ `main.ts` ä¸­æ³¨å†Œ `ApiMonitoringInterceptor`
- [ ] âœ… ä¸šåŠ¡æœåŠ¡ä¸­åªæ³¨å…¥ `EventEmitter2`ï¼Œä¸ç›´æ¥æ³¨å…¥ç›‘æ§æœåŠ¡
- [ ] âœ… ä½¿ç”¨ `setImmediate()` å¼‚æ­¥å‘é€ç›‘æ§äº‹ä»¶
- [ ] âœ… äº‹ä»¶æ•°æ®åŒ…å«å®Œæ•´çš„ `timestamp`, `source`, `metricType` ç­‰å­—æ®µ

### ğŸ“Š äº‹ä»¶è§„èŒƒæ£€æŸ¥ï¼ˆæ¨èï¼‰
- [ ] âœ… äº‹ä»¶æ ‡ç­¾ä½¿ç”¨ä½åŸºæ•°è®¾è®¡ï¼ˆæ¯ä¸ªæ ‡ç­¾ < 20ä¸ªä¸åŒå€¼ï¼‰
- [ ] âœ… ç»Ÿä¸€ä½¿ç”¨ `SYSTEM_STATUS_EVENTS.METRIC_COLLECTED` äº‹ä»¶ç±»å‹
- [ ] âœ… `metricValue` å­—æ®µåŒ…å«æœ‰æ„ä¹‰çš„æ•°å€¼ï¼ˆæ—¶é•¿ã€æ•°é‡ã€çŠ¶æ€ç­‰ï¼‰
- [ ] âœ… `source` å­—æ®µæ˜ç¡®æ ‡è¯†äº‹ä»¶æ¥æºæœåŠ¡
- [ ] âœ… é”™è¯¯æƒ…å†µä¸‹ä¹Ÿå‘é€ç›‘æ§äº‹ä»¶

### ğŸ”§ æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥ï¼ˆé«˜çº§ï¼‰
- [ ] âœ… é«˜é¢‘æ“ä½œä½¿ç”¨æ‰¹é‡äº‹ä»¶å‘é€æˆ–è£…é¥°å™¨æ¨¡å¼
- [ ] âœ… äº‹ä»¶å‘é€å¤±è´¥ä¸å½±å“ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ
- [ ] âœ… ç›‘æ§ä»£ç å ä¸šåŠ¡ä»£ç æ¯”ä¾‹ < 10%
- [ ] âœ… é…ç½®åˆé€‚çš„æ‰¹å¤„ç†å‚æ•°ï¼ˆæ ¹æ®ä¸šåŠ¡è´Ÿè½½è°ƒæ•´ï¼‰

### ğŸš¨ è¿ç»´ç›‘æ§æ£€æŸ¥ï¼ˆç”Ÿäº§å¿…éœ€ï¼‰
- [ ] âœ… è®¾ç½®äº‹ä»¶é˜Ÿåˆ—æ»¡å‘Šè­¦ (`queue_utilization > 80%`)
- [ ] âœ… é…ç½®äº‹ä»¶å¤„ç†å¤±è´¥å‘Šè­¦ç›‘æ§
- [ ] âœ… å»ºç«‹ Grafana ç›‘æ§é¢æ¿å±•ç¤ºä¸šåŠ¡æŒ‡æ ‡
- [ ] âœ… å®šæœŸæ£€æŸ¥ç›‘æ§ç»„ä»¶è‡ªèº«å¥åº·çŠ¶æ€

---

## ğŸ¯ å¿«é€Ÿæ•…éšœæ¢å¤

```bash
# ğŸš¨ ç›‘æ§å®Œå…¨å¤±æ•ˆæ—¶çš„æ¢å¤æ­¥éª¤

# 1. æ£€æŸ¥ç›‘æ§æ¨¡å—çŠ¶æ€
curl http://localhost:3000/api/v1/monitoring/status

# 2. é‡å¯äº‹ä»¶æ¡¥æ¥æœåŠ¡ï¼ˆæ— éœ€é‡å¯åº”ç”¨ï¼‰
curl -X POST http://localhost:3000/api/v1/monitoring/bridge/restart

# 3. æ¸…ç†é˜»å¡çš„äº‹ä»¶é˜Ÿåˆ—
curl -X POST http://localhost:3000/api/v1/monitoring/bridge/flush

# 4. éªŒè¯ç›‘æ§æ¢å¤
curl http://localhost:3000/metrics | grep -c "monitoring_"
```

---

*äº‹ä»¶åŒ–ç›‘æ§æ¥å…¥æŒ‡å— v2.0 | ä¸“æ³¨è§£è€¦ï¼Œä¸“æ³¨æ€§èƒ½ï¼Œä¸“æ³¨ç¨³å®šæ€§*

---

## ğŸ“Š å¿«é€ŸæŸ¥è¯¢ API

```bash
# è·å–å¥åº·è¯„åˆ†
GET /api/v1/monitoring/health/score

# è·å–æ€§èƒ½æŠ¥å‘Š
GET /api/v1/monitoring/performance

# è·å–1å°æ—¶è¶‹åŠ¿
GET /api/v1/monitoring/trends/1h

# è·å–ä¼˜åŒ–å»ºè®®  
GET /api/v1/monitoring/suggestions

# ç¼“å­˜å¤±æ•ˆ
POST /api/v1/monitoring/cache/invalidate

# ç³»ç»ŸçŠ¶æ€
GET /api/v1/monitoring/status
```

---

## ğŸ”§ å…³é”®æœåŠ¡é€ŸæŸ¥

| æœåŠ¡ç±» | è·¯å¾„ | ä¸»è¦æ–¹æ³• | ç”¨é€” |
|-------|-----|----------|------|
| **CollectorService** | `./monitoring/collector/collector.service` | `recordRequest()`, `recordDatabaseOperation()` | æ•°æ®æ”¶é›† |
| **AnalyzerService** | `./monitoring/analyzer/analyzer.service` | `getHealthScore()`, `getPerformanceAnalysis()` | æ•°æ®åˆ†æ |
| **MonitoringCacheService** | `./monitoring/cache/monitoring-cache.service` | `getOrSetHealthData()`, `healthCheck()` | ç›‘æ§ç¼“å­˜ |
| **ApiMonitoringInterceptor** | `./monitoring/infrastructure/interceptors/api-monitoring.interceptor` | å…¨å±€æ‹¦æˆªå™¨ | APIè‡ªåŠ¨ç›‘æ§ |

---

## âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®

```bash
# ç¯å¢ƒå˜é‡å¿«é€Ÿè°ƒä¼˜
MONITORING_BATCH_SIZE=100                # æ‰¹å¤„ç†å¤§å°
MONITORING_FLUSH_INTERVAL_MS=100        # åˆ·æ–°é—´éš”
MONITORING_MAX_QUEUE_SIZE=10000         # æœ€å¤§é˜Ÿåˆ—
MONITORING_CACHE_TTL_HEALTH=30          # å¥åº·æ•°æ®TTL
MONITORING_CACHE_TTL_PERFORMANCE=60     # æ€§èƒ½æ•°æ®TTL
```

---

## ğŸš¨ æ•…éšœæ’é™¤

```bash
# å¸¸è§é—®é¢˜æ£€æŸ¥
curl http://localhost:3000/api/v1/monitoring/status        # æ•´ä½“çŠ¶æ€
curl http://localhost:3000/api/v1/monitoring/cache/health  # ç¼“å­˜çŠ¶æ€  
curl http://localhost:3000/metrics                         # PrometheusæŒ‡æ ‡

# è°ƒè¯•æ¨¡å¼
LOG_LEVEL=debug npm start
DEBUG=monitoring:* npm start
```

---

## ğŸ“ˆ å…³é”®æŒ‡æ ‡é€Ÿè§ˆ

```promql
# APIæˆåŠŸç‡
rate(receiver_requests_total{status!~"4..|5.."}[5m]) / rate(receiver_requests_total[5m])

# å¹³å‡å“åº”æ—¶é—´
rate(receiver_processing_duration_seconds_sum[5m]) / rate(receiver_processing_duration_seconds_count[5m])

# ç¼“å­˜å‘½ä¸­ç‡  
rate(storage_cache_efficiency[5m])

# äº‹ä»¶å¤„ç†æ€§èƒ½
rate(monitoring_events_processed_total[5m])
```

---

## ğŸ“ æ ‡ç­¾ä½¿ç”¨åŸåˆ™

```typescript
// âœ… å¥½çš„æ ‡ç­¾è®¾è®¡ï¼ˆä½åŸºæ•°ï¼‰
{
  method: 'GET|POST|PUT|DELETE',     // ~4ä¸ªå€¼
  status: '200|400|500',             // ~10ä¸ªå€¼  
  provider: 'longport|yahoo',        // ~5ä¸ªå€¼
  operation: 'get_quote|get_info'    // ~20ä¸ªå€¼
}

// âŒ é¿å…é«˜åŸºæ•°æ ‡ç­¾
{
  user_id: '12345',          // æ•°ä¸‡ä¸ªå€¼ âŒ
  request_id: 'req_abc',     // å”¯ä¸€å€¼ âŒ
  timestamp: '1640995200'    // æ—¶é—´æˆ³ âŒ
}
```

---

## ğŸ¯ æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•

- [ ] âœ… å·²åœ¨ `app.module.ts` ä¸­å¯¼å…¥ `MonitoringModule`
- [ ] âœ… å·²åœ¨ `main.ts` ä¸­æ³¨å†Œ `ApiMonitoringInterceptor`
- [ ] âœ… å…³é”®ä¸šåŠ¡æµç¨‹å·²æ·»åŠ æ•°æ®æ”¶é›†åŸ‹ç‚¹
- [ ] âœ… ä½¿ç”¨åˆç†çš„æ ‡ç­¾åŸºæ•°è®¾è®¡
- [ ] âœ… å¼‚æ­¥å‘é€äº‹ä»¶ï¼Œä¸é˜»å¡ä¸»æµç¨‹
- [ ] âœ… é…ç½®é€‚åˆä¸šåŠ¡çš„æ‰¹å¤„ç†å‚æ•°
- [ ] âœ… è®¾ç½®ç›‘æ§å‘Šè­¦å’ŒGrafanaé¢æ¿
- [ ] âœ… å®šæœŸæ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡å’Œå¥åº·çŠ¶æ€

---

*å¿«é€Ÿå‚è€ƒå¡ v2.0 | 5åˆ†é’Ÿä¸Šæ‰‹ï¼Œ1åˆ†é’Ÿè§£å†³é—®é¢˜*