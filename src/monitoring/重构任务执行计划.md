# 🚀 Monitoring组件重构任务执行计划

## 📊 执行进度总览

### ✅ 已完成阶段
- **Phase 1**: 文件重命名脚本执行完成
  - Infrastructure层: 7个文件重命名 ✅
  - Collector层: 1个文件移动，1个目录清理 ✅
  - Analyzer层: 6个文件移动/重命名，3个目录清理 ✅
  - Presenter层: 3个文件移动/重命名，2个目录清理 ✅
  - Shared层: 4个文件重命名 ✅

## 🎯 详细任务分解

### Phase 2: Infrastructure层代码重构 (高优先级)

#### 2.1 更新类名和导出
- [ ] **infrastructure/metrics/metrics-registry.service.ts**
  - 类名: `InfrastructureMetricsRegistryService` → `MetricsRegistryService`
  - 更新所有相关导入引用

- [ ] **infrastructure/interceptors/infrastructure.interceptor.ts**
  - 类名: `InfrastructurePerformanceInterceptor` → `InfrastructureInterceptor`
  - 更新所有相关导入引用

- [ ] **创建新的基础服务文件**
  - [ ] `infrastructure/infrastructure.service.ts` - 基础设施抽象服务
  - [ ] `infrastructure/infrastructure-cache.service.ts` - 统一缓存服务
  - [ ] `infrastructure/infrastructure-lock.service.ts` - 分布式锁服务
  - [ ] `infrastructure/infrastructure-sanitizer.service.ts` - 数据脱敏服务

#### 2.2 更新模块导入
- [ ] **infrastructure/infrastructure.module.ts**
  - 更新所有服务导入路径
  - 添加新创建的基础服务
  - 更新providers和exports数组

### Phase 3: Collector层代码重构

#### 3.1 更新现有文件导入路径
- [ ] **collector/collector.service.ts**
  - 检查和更新所有导入路径
  - 确保类名与文件名一致

- [ ] **collector/collector.interceptor.ts**
  - 检查和更新所有导入路径

- [ ] **collector/collector.repository.ts**
  - 检查和更新所有导入路径

#### 3.2 创建新的收集器服务
- [ ] **collector/collector-validation.service.ts**
  - 创建数据验证服务
  - 类名: `CollectorValidationService`

- [ ] **collector/collector-task.service.ts**
  - 创建异步任务队列服务
  - 类名: `CollectorTaskService`

#### 3.3 更新模块配置
- [ ] **collector/collector.module.ts**
  - 更新所有服务导入路径
  - 添加新创建的服务
  - 更新providers和exports数组

### Phase 4: Analyzer层代码重构

#### 4.1 更新类名和重构现有文件
- [ ] **analyzer/analyzer-health.service.ts**
  - 类名: `HealthAnalyzerService` → `AnalyzerHealthService`
  - 更新所有导入和引用

- [ ] **analyzer/analyzer-trend.service.ts**
  - 类名: `TrendAnalyzerService` → `AnalyzerTrendService`
  - 更新所有导入和引用

- [ ] **analyzer/analyzer-metrics.service.ts** (原calculator文件)
  - 类名: 新建 `AnalyzerMetricsService`
  - 将calculator逻辑改为service模式

- [ ] **analyzer/analyzer-score.service.ts** (原health-score calculator)
  - 类名: 新建 `AnalyzerScoreService`
  - 将calculator逻辑改为service模式

#### 4.2 创建新的分析器组件
- [ ] **analyzer/analyzer-engine.service.ts**
  - 创建统计引擎服务
  - 类名: `AnalyzerEngineService`

- [ ] **analyzer/analyzer.repository.ts**
  - 创建分析数据仓库
  - 类名: `AnalyzerRepository`

#### 4.3 更新模块配置
- [ ] **analyzer/analyzer.module.ts**
  - 更新所有服务导入路径
  - 添加新创建的服务和仓库
  - 更新providers和exports数组

### Phase 5: Presenter层代码重构

#### 5.1 更新类名和现有文件
- [ ] **presenter/presenter-error.service.ts**
  - 类名: `PresenterErrorHandlerService` → `PresenterErrorService`
  - 更新所有导入和引用

#### 5.2 创建新的展示器服务
- [ ] **presenter/presenter-formatter.service.ts**
  - 创建响应格式化服务
  - 类名: `PresenterFormatterService`

- [ ] **presenter/presenter-report.service.ts**
  - 创建报告生成服务
  - 类名: `PresenterReportService`

#### 5.3 更新模块配置
- [ ] **presenter/presenter.module.ts**
  - 更新所有服务导入路径
  - 添加新创建的服务
  - 更新providers和exports数组

### Phase 6: 全局导入路径更新

#### 6.1 更新根模块
- [ ] **monitoring.module.ts**
  - 更新所有子模块导入路径
  - 确保所有模块正确加载

#### 6.2 更新index文件
- [ ] **contracts/index.ts**
  - 更新所有导出路径

- [ ] **shared/types/index.ts**
  - 更新类型导出路径

- [ ] **shared/interfaces/index.ts**
  - 更新接口导出路径

#### 6.3 跨模块引用更新
- [ ] **搜索并更新所有TypeScript文件中的导入路径**
  - 使用正则表达式查找: `from ['"].*monitoring.*['"]`
  - 更新为新的路径结构

### Phase 7: 测试和验证

#### 7.1 编译验证
- [ ] **TypeScript编译测试**
  ```bash
  npx tsc --noEmit --project .
  ```

#### 7.2 导入路径验证
- [ ] **检查循环依赖**
  ```bash
  npx madge --circular --extensions ts src/monitoring/
  ```

#### 7.3 运行测试套件
- [ ] **单元测试**
  ```bash
  DISABLE_AUTO_INIT=true npx jest src/monitoring --passWithNoTests
  ```

#### 7.4 功能验证
- [ ] **启动应用程序**
  ```bash
  bun run dev
  ```
- [ ] **验证监控端点正常工作**

## 📋 任务优先级与依赖关系

### 🔴 P0 - 必须立即完成
1. Infrastructure层基础服务创建
2. 类名重构和导入路径更新
3. TypeScript编译错误修复

### 🟡 P1 - 高优先级
4. 新服务组件创建
5. 模块配置更新
6. 功能验证测试

### 🟢 P2 - 中等优先级
7. 代码优化和重构
8. 测试覆盖率提升
9. 文档更新

## 🛠️ 执行策略

### 单任务执行原则
- 一次只进行一个层级的重构
- 每完成一个任务立即进行编译验证
- 发现问题立即修复，不累积技术债务

### 回滚准备
- 每个Phase完成后创建Git提交
- 保持功能完整性，避免破坏性变更
- 准备快速回滚机制

### 质量控制
- 每个文件修改后运行TypeScript检查
- 确保导入路径正确性
- 验证类名与文件名一致性

## 📊 估算工作量

| Phase | 任务数量 | 预估时间 | 难度 |
|-------|----------|----------|------|
| Phase 2 | 8个任务 | 2-3小时 | 🔴 高 |
| Phase 3 | 6个任务 | 1-2小时 | 🟡 中 |
| Phase 4 | 8个任务 | 2-3小时 | 🔴 高 |
| Phase 5 | 6个任务 | 1-2小时 | 🟡 中 |
| Phase 6 | 4个任务 | 1小时 | 🟡 中 |
| Phase 7 | 4个任务 | 1小时 | 🟢 低 |
| **总计** | **36个任务** | **8-12小时** | - |

## ⚡ 下一步行动

1. **立即开始Phase 2: Infrastructure层重构**
2. **重点关注基础服务创建和类名更新**
3. **每个步骤都要进行编译验证**

---

**🎯 目标**：完成统一命名规范的监控组件重构，为后续的统一可观测性平台合并做好准备。