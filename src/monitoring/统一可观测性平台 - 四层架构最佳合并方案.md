# ğŸ—ï¸ ç»Ÿä¸€å¯è§‚æµ‹æ€§å¹³å° - å››å±‚æ¶æ„æœ€ä½³åˆå¹¶æ–¹æ¡ˆ (ä¸“å®¶è¯„å®¡ä¼˜åŒ–ç‰ˆ)

> **âš ï¸ é‡è¦æ›´æ–°**ï¼šæœ¬æ–¹æ¡ˆå·²æ ¹æ®ä¸“ä¸šæŠ€æœ¯è¯„å®¡æ„è§è¿›è¡Œå…¨é¢ä¼˜åŒ–ï¼Œé‡ç‚¹è§£å†³äº†åˆ†å¸ƒå¼é”å¯é æ€§ã€è¿ç§»æ—¶é—´çº¿åˆç†æ€§å’Œé£é™©æ§åˆ¶å®Œæ•´æ€§ç­‰å…³é”®é—®é¢˜ã€‚

## ğŸ“‹ æ·±åº¦åˆ†æç»“è®º

åŸºäºå¯¹Securityå’ŒMonitoringç»„ä»¶çš„æ·±å…¥åˆ†æï¼Œä»¥åŠç›‘æ§ç»„ä»¶ä¼˜åŒ–æ–‡æ¡£çš„å®¡æŸ¥ï¼Œæˆ‘å‘ç°ï¼š

### ğŸ” **ç°çŠ¶è¯„ä¼°**
- **Monitoringç»„ä»¶**: å››å±‚æ¶æ„æ¸…æ™°(Infrastructure â†’ Collector â†’ Analyzer â†’ Presenter)ï¼Œä½†å­˜åœ¨**15ä¸ªå…³é”®é—®é¢˜**ï¼ŒåŒ…æ‹¬å†…å­˜æ³„éœ²ã€0%æµ‹è¯•è¦†ç›–ç‡ã€æ•æ„Ÿä¿¡æ¯æ³„éœ²ç­‰**4ä¸ªé«˜å±ç”Ÿäº§çº§é£é™©**
- **Securityç»„ä»¶**: åŠŸèƒ½å®Œæ•´ä½†æ¶æ„ä¸å¤Ÿå±‚æ¬¡åŒ–ï¼Œå­˜åœ¨ä¸Monitoringç»„ä»¶çš„åŠŸèƒ½é‡å 
- **é‡å åº¦è¯„ä¼°**: æ•°æ®æ”¶é›†(ä¸­ç­‰)ã€å­˜å‚¨ç¼“å­˜(é«˜)ã€åˆ†æå¤„ç†(å¾ˆé«˜)ã€å±•ç¤ºå±‚(é«˜)

## ğŸ¯ **ç»Ÿä¸€å¯è§‚æµ‹æ€§å¹³å°æ¶æ„è®¾è®¡**

### **æ ¸å¿ƒè®¾è®¡ç†å¿µ**
- **æŠ½è±¡å…±åŒæ¨¡å¼** + **ä¸“ä¸šåŒ–å®ç°**
- **æ’ä»¶åŒ–æ¶æ„** + **è§£å†³ç°æœ‰é—®é¢˜** 
- **æ¸è¿›å¼è¿ç§»** + **å‘åå…¼å®¹**

### **å››å±‚æ¶æ„è¯¦ç»†è®¾è®¡**

```typescript
// ğŸ—ï¸ Layer 1: Infrastructure (åŸºç¡€è®¾æ–½å±‚)
abstract class BaseInfrastructure {
  protected abstract getMetricsRegistry(): IMetricsRegistry;
  protected abstract getCacheService(): ICacheService;
  protected abstract getEventBus(): EventEmitter2;
  protected abstract getDataSanitizer(): IDataSanitizer; // ğŸ›¡ï¸ ç»Ÿä¸€æ•°æ®è„±æ•
  protected abstract getDistributedLock(): IDistributedLock; // ğŸ”’ è§£å†³ç¼“å­˜ç«äº‰
}

class SecurityInfrastructure extends BaseInfrastructure {
  // å®¡è®¡æ—¥å¿—ä¸“ç”¨æŒä¹…åŒ–ã€æ•æ„Ÿæ•°æ®è„±æ•å·¥å…·ã€å®‰å…¨äº‹ä»¶æ€»çº¿
}

class MonitoringInfrastructure extends BaseInfrastructure {
  // æ€§èƒ½æŒ‡æ ‡æ³¨å†Œè¡¨ã€æ—¶åºæ•°æ®åº“è¿æ¥ã€ç›‘æ§å‘Šè­¦åŸºç¡€è®¾æ–½
}

// ğŸ“Š Layer 2: Collector (æ•°æ®æ”¶é›†å±‚)
abstract class BaseCollector<T> implements OnModuleDestroy {
  abstract collect(source: string): Promise<T>;
  abstract buffer(data: T[]): Promise<void>;
  abstract flush(): Promise<void>;
  
  // ğŸ”§ å¼ºåˆ¶å®ç°ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œè§£å†³å†…å­˜æ³„éœ²
  async onModuleDestroy(): Promise<void> {
    await this.cleanup();
  }
}

class SecurityEventCollector extends BaseCollector<SecurityEvent> {
  // å®‰å…¨äº‹ä»¶æ”¶é›†ã€ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ªã€å¨èƒæ£€æµ‹æ•°æ®æ”¶é›†
}

class PerformanceMetricsCollector extends BaseCollector<MetricData> {
  // ç³»ç»ŸæŒ‡æ ‡æ”¶é›†ã€æ€§èƒ½æ•°æ®é‡‡æ ·ã€èµ„æºç›‘æ§æ•°æ®æ”¶é›†
}

// ğŸ§  Layer 3: Analyzer (æ•°æ®åˆ†æå±‚)
abstract class BaseAnalyzer<TInput, TOutput> implements OnModuleDestroy {
  abstract analyze(data: TInput): Promise<TOutput>;
  abstract calculateScore(metrics: any): Promise<number>;
  abstract detectTrends(timeSeries: any[]): Promise<TrendAnalysis>;
  
  // ğŸ”’ å†…ç½®åˆ†å¸ƒå¼é”æœºåˆ¶ï¼Œè§£å†³ç¼“å­˜ç«äº‰
  protected async withDistributedLock<T>(key: string, operation: () => Promise<T>): Promise<T> {
    // å®ç°åˆ†å¸ƒå¼é”é€»è¾‘
  }
}

class SecurityAnalyzer extends BaseAnalyzer<SecurityEvent[], SecurityAnalysis> {
  // é£é™©è¯„åˆ†ç®—æ³•ã€å¼‚å¸¸è¡Œä¸ºæ£€æµ‹ã€å¨èƒæƒ…æŠ¥å…³è”ã€åˆè§„æ€§åˆ†æ
}

class PerformanceAnalyzer extends BaseAnalyzer<MetricData[], PerformanceAnalysis> {
  // æ€§èƒ½ç“¶é¢ˆåˆ†æã€å®¹é‡è§„åˆ’è®¡ç®—ã€SLAè¿åæ£€æµ‹ã€å¥åº·è¯„åˆ†
}

// ğŸ“ˆ Layer 4: Presenter (æ•°æ®å±•ç¤ºå±‚)
abstract class BasePresenter<T> implements OnModuleDestroy {
  abstract generateReport(analysis: T): Promise<Report>;
  abstract createDashboard(data: T): Promise<Dashboard>;
  abstract handleAlert(alert: Alert): Promise<void>;
}

class SecurityPresenter extends BasePresenter<SecurityAnalysis> {
  // å®‰å…¨åˆè§„æŠ¥å‘Šã€å¨èƒå¯è§†åŒ–ã€å®¡è®¡æ—¥å¿—æŸ¥è¯¢APIã€é£é™©ä»ªè¡¨æ¿
}

class MonitoringPresenter extends BasePresenter<PerformanceAnalysis> {
  // æ€§èƒ½ä»ªè¡¨æ¿ã€ç›‘æ§å‘Šè­¦ã€è¿ç»´å·¥å…·APIã€ç³»ç»Ÿå¥åº·å±•ç¤º
}
```

### **ğŸ“ ç›®å½•ç»“æ„è®¾è®¡**

```
src/observability/  # ğŸ¯ ç»Ÿä¸€å¯è§‚æµ‹æ€§å¹³å°
â”œâ”€â”€ infrastructure/  # ğŸ—ï¸ Layer 1: åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ base-infrastructure.service.ts    # åŸºç¡€è®¾æ–½æŠ½è±¡
â”‚   â”‚   â”œâ”€â”€ base-cache.service.ts             # ç»Ÿä¸€ç¼“å­˜æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ distributed-lock.service.ts       # ğŸ”’ åˆ†å¸ƒå¼é”
â”‚   â”‚   â”œâ”€â”€ data-sanitizer.service.ts         # ğŸ›¡ï¸ æ•°æ®è„±æ•
â”‚   â”‚   â””â”€â”€ base-metrics-registry.service.ts  # æŒ‡æ ‡æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”œâ”€â”€ security-infrastructure.service.ts
â”‚   â”‚   â”œâ”€â”€ audit-storage.service.ts          # å®¡è®¡æ—¥å¿—å­˜å‚¨
â”‚   â”‚   â””â”€â”€ security-event-bus.service.ts     # å®‰å…¨äº‹ä»¶æ€»çº¿
â”‚   â””â”€â”€ monitoring/
â”‚       â”œâ”€â”€ monitoring-infrastructure.service.ts
â”‚       â”œâ”€â”€ metrics-storage.service.ts        # æŒ‡æ ‡æ•°æ®å­˜å‚¨
â”‚       â””â”€â”€ alerting-infrastructure.service.ts # å‘Šè­¦åŸºç¡€è®¾æ–½
â”œâ”€â”€ collector/       # ğŸ“Š Layer 2: æ•°æ®æ”¶é›†å±‚
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ base-collector.service.ts         # æ”¶é›†å™¨åŸºç±»
â”‚   â”‚   â”œâ”€â”€ collector.interface.ts            # æ”¶é›†å™¨æ¥å£
â”‚   â”‚   â””â”€â”€ background-task.service.ts        # ğŸš€ å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”œâ”€â”€ security-event-collector.service.ts
â”‚   â”‚   â”œâ”€â”€ audit-log-collector.service.ts
â”‚   â”‚   â””â”€â”€ threat-data-collector.service.ts
â”‚   â””â”€â”€ monitoring/
â”‚       â”œâ”€â”€ metrics-collector.service.ts
â”‚       â”œâ”€â”€ performance-collector.service.ts
â”‚       â””â”€â”€ system-collector.service.ts
â”œâ”€â”€ analyzer/        # ğŸ§  Layer 3: æ•°æ®åˆ†æå±‚
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ base-analyzer.service.ts          # åˆ†æå™¨åŸºç±»
â”‚   â”‚   â”œâ”€â”€ analyzer.interface.ts             # åˆ†æå™¨æ¥å£
â”‚   â”‚   â””â”€â”€ trend-calculator.service.ts       # é€šç”¨è¶‹åŠ¿è®¡ç®—
â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”œâ”€â”€ risk-analyzer.service.ts          # é£é™©åˆ†æ
â”‚   â”‚   â”œâ”€â”€ threat-analyzer.service.ts        # å¨èƒåˆ†æ
â”‚   â”‚   â””â”€â”€ compliance-analyzer.service.ts    # åˆè§„æ€§åˆ†æ
â”‚   â””â”€â”€ monitoring/
â”‚       â”œâ”€â”€ performance-analyzer.service.ts   # æ€§èƒ½åˆ†æ
â”‚       â”œâ”€â”€ health-analyzer.service.ts        # å¥åº·åˆ†æ
â”‚       â””â”€â”€ capacity-analyzer.service.ts      # å®¹é‡åˆ†æ
â”œâ”€â”€ presenter/       # ğŸ“ˆ Layer 4: æ•°æ®å±•ç¤ºå±‚
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ base-presenter.service.ts         # å±•ç¤ºå™¨åŸºç±»
â”‚   â”‚   â”œâ”€â”€ presenter.interface.ts            # å±•ç¤ºå™¨æ¥å£
â”‚   â”‚   â””â”€â”€ report-generator.service.ts       # é€šç”¨æŠ¥å‘Šç”Ÿæˆ
â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”œâ”€â”€ security-dashboard.controller.ts  # å®‰å…¨ä»ªè¡¨æ¿
â”‚   â”‚   â”œâ”€â”€ audit-report.controller.ts        # å®¡è®¡æŠ¥å‘ŠAPI
â”‚   â”‚   â””â”€â”€ compliance-report.controller.ts   # åˆè§„æŠ¥å‘ŠAPI
â”‚   â””â”€â”€ monitoring/
â”‚       â”œâ”€â”€ monitoring-dashboard.controller.ts # ç›‘æ§ä»ªè¡¨æ¿
â”‚       â”œâ”€â”€ metrics-api.controller.ts         # æŒ‡æ ‡æŸ¥è¯¢API
â”‚       â””â”€â”€ alerting-api.controller.ts        # å‘Šè­¦ç®¡ç†API
â”œâ”€â”€ shared/          # ğŸ”§ å…±äº«å·¥å…·å’Œç±»å‹
â”‚   â”œâ”€â”€ interfaces/
â”‚   â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ enums/
â”‚   â””â”€â”€ utils/
â””â”€â”€ tests/           # ğŸ§ª å®Œæ•´æµ‹è¯•å¥—ä»¶
    â”œâ”€â”€ unit/        # å•å…ƒæµ‹è¯•
    â”œâ”€â”€ integration/ # é›†æˆæµ‹è¯•
    â””â”€â”€ e2e/         # ç«¯åˆ°ç«¯æµ‹è¯•
```

## ğŸš€ **å®æ–½ç­–ç•¥ä¸è®¡åˆ’**

### **ğŸ“Š äº”é˜¶æ®µæ¸è¿›å¼è¿ç§»ï¼ˆä¸“å®¶è¯„å®¡ä¼˜åŒ–ç‰ˆ - 16å‘¨ï¼‰**

> **ğŸ”§ ä¼˜åŒ–è¦ç‚¹**ï¼šæ ¹æ®ä¸“å®¶å»ºè®®ï¼Œä»åŸ12å‘¨å»¶é•¿è‡³16å‘¨ï¼Œå•ç»„ä»¶ä¼˜å…ˆè¿ç§»ï¼Œå……åˆ†æµ‹è¯•æ—¶é—´ï¼Œæ˜¾è‘—é™ä½å®æ–½é£é™©ã€‚

| é˜¶æ®µ | ä»»åŠ¡å†…å®¹ | é¢„ä¼°å·¥æ—¶ | ä¼˜å…ˆçº§ | å…³é”®äº§å‡º | é£é™©æ§åˆ¶æªæ–½ |
|------|----------|----------|--------|----------|--------------|
| **Phase 1** | **å¼ºåŒ–åŸºç¡€è®¾æ–½å±‚** | 3å‘¨ (+1å‘¨) | ğŸ”´ P0 | ä¼ä¸šçº§åˆ†å¸ƒå¼é”ã€æ•°æ®è„±æ•ã€åŸºç¡€æŠ½è±¡ | å……åˆ†æµ‹è¯•åŸºç¡€ç»„ä»¶ï¼Œå¹¶å‘1000+å‹åŠ›æµ‹è¯• |
| **Phase 2** | **Monitoringç»„ä»¶ä¼˜å…ˆè¿ç§»** | 4å‘¨ (+1å‘¨) | ğŸ”´ P0 | æ€§èƒ½ç›‘æ§å››å±‚æ¶æ„å®Œæ•´å®ç° | ä¸“æ³¨å•ç»„ä»¶ï¼Œé™ä½å¤æ‚åº¦é£é™© |
| **Phase 3** | **Securityç»„ä»¶è¿ç§»** | 4å‘¨ (+1å‘¨) | ğŸ”´ P0 | å®‰å…¨äº‹ä»¶æ”¶é›†ã€é£é™©åˆ†æã€å®¡è®¡æŠ¥å‘Š | é”™å¼€è¿ç§»æ—¶é—´ï¼Œé¿å…å¹¶è¡Œé£é™© |
| **Phase 4** | **å…¨ç³»ç»Ÿé›†æˆæµ‹è¯•ä¸ä¼˜åŒ–** | 3å‘¨ (+1å‘¨) | ğŸŸ¡ P1 | ç«¯åˆ°ç«¯æµ‹è¯•ã€æ•…éšœåœºæ™¯éªŒè¯ã€ç”Ÿäº§ç¯å¢ƒå‡†å¤‡ | å…¨é¢å›å½’æµ‹è¯•ï¼Œè“ç»¿éƒ¨ç½²å‡†å¤‡ |
| **Phase 5** | **æ€§èƒ½ä¼˜åŒ–ä¸ç”Ÿäº§éƒ¨ç½²** | 2å‘¨ | ğŸŸ¡ P1 | æ€§èƒ½è°ƒä¼˜ã€ç°åº¦éƒ¨ç½²ã€ç›‘æ§éªŒè¯ | åŠŸèƒ½å¼€å…³æ§åˆ¶ï¼Œç´§æ€¥å›æ»šæœºåˆ¶ |

**æ€»è®¡ï¼š16å‘¨ï¼ˆæ¯”åŸæ–¹æ¡ˆå¢åŠ 33%æ—¶é—´è£•åº¦ï¼Œæ˜¾è‘—é™ä½å®æ–½é£é™©ï¼‰**

### **ğŸ›¡ï¸ å…³é”®é—®é¢˜åŒæ­¥è§£å†³**

```typescript
// ğŸ”¥ é—®é¢˜1: å†…å­˜æ³„éœ²ä¿®å¤
abstract class BaseObservabilityService implements OnModuleDestroy {
  private eventListeners: Map<string, Function> = new Map();
  
  protected registerEventListener(event: string, handler: Function): void {
    this.eventBus.on(event, handler);
    this.eventListeners.set(event, handler);
  }
  
  async onModuleDestroy(): Promise<void> {
    // æ¸…ç†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
    for (const [event, handler] of this.eventListeners) {
      this.eventBus.removeListener(event, handler);
    }
    this.eventListeners.clear();
    
    // æ¸…ç†ç¼“å­˜è¿æ¥
    await this.cacheService.disconnect?.();
    this.logger.log(`${this.constructor.name} èµ„æºæ¸…ç†å®Œæˆ`);
  }
}

// ğŸ›¡ï¸ é—®é¢˜2: æ•æ„Ÿä¿¡æ¯è„±æ•
@Injectable()
export class DataSanitizationService {
  private static readonly SENSITIVE_PATTERNS = [
    /password/i, /token/i, /apikey/i, /secret/i, /credential/i,
    /email/i, /phone/i, /id_?card/i, /bank_?account/i
  ];
  
  sanitizeForLogging(data: any): string {
    if (!data) return '[NULL_DATA]';
    
    try {
      const sanitized = this.deepSanitize(data);
      const jsonStr = JSON.stringify(sanitized);
      return jsonStr.length > 200 ? jsonStr.substring(0, 200) + '...' : jsonStr;
    } catch {
      return '[UNPARSEABLE_DATA]';
    }
  }
  
  private deepSanitize(obj: any): any {
    if (typeof obj !== 'object' || obj === null) return obj;
    
    const sanitized = Array.isArray(obj) ? [] : {};
    
    for (const [key, value] of Object.entries(obj)) {
      if (this.isSensitiveField(key)) {
        sanitized[key] = '[REDACTED]';
      } else if (typeof value === 'object') {
        sanitized[key] = this.deepSanitize(value);
      } else {
        sanitized[key] = value;
      }
    }
    
    return sanitized;
  }
  
  private isSensitiveField(fieldName: string): boolean {
    return DataSanitizationService.SENSITIVE_PATTERNS.some(pattern => 
      pattern.test(fieldName)
    );
  }
}

// ğŸ”’ é—®é¢˜3: ç¼“å­˜ç«äº‰è§£å†³ (ä¸“å®¶è¯„å®¡ä¼˜åŒ–ç‰ˆ - ä¼ä¸šçº§å®ç°)
@Injectable()
export class EnterpriseDistributedLockService implements IDistributedLock {
  private readonly logger = createLogger(EnterpriseDistributedLockService.name);
  private readonly renewalTrackers = new Map<string, NodeJS.Timeout>();
  
  constructor(
    private readonly redis: Redis,
    private readonly configService: ConfigService
  ) {}

  async withLock<T>(
    key: string,
    operation: () => Promise<T>,
    options: EnhancedLockOptions = {}
  ): Promise<T> {
    const config = this.buildLockConfig(options);
    const lockKey = this.buildLockKey(key);
    const lockValue = this.generateSecureLockValue(); // ğŸ›¡ï¸ è§£å†³æ—¶é’ŸåŒæ­¥é—®é¢˜
    
    // ğŸ”’ è·å–é”ï¼ˆå¸¦æŒ‡æ•°é€€é¿é‡è¯•ï¼‰
    const acquired = await this.acquireLockWithRetry(lockKey, lockValue, config);
    if (!acquired) {
      throw new LockAcquisitionException(`Failed to acquire lock: ${key}`);
    }
    
    // ğŸ”„ è®¾ç½®è‡ªåŠ¨ç»­æœŸï¼Œè§£å†³é•¿æ—¶é—´æ“ä½œé—®é¢˜
    const renewalTracker = config.autoRenew 
      ? this.setupAutoRenewal(lockKey, lockValue, config) 
      : null;
    
    try {
      // â±ï¸ æ‰§è¡Œæ“ä½œï¼ˆå¸¦æ­»é”æ£€æµ‹ï¼‰
      return await Promise.race([
        operation(),
        this.createDeadlockTimeoutPromise(config.deadlockTimeout, key)
      ]);
    } finally {
      // ğŸ§¹ æ¸…ç†èµ„æº
      if (renewalTracker) {
        clearInterval(renewalTracker);
        this.renewalTrackers.delete(lockKey);
      }
      await this.safelyReleaseLock(lockKey, lockValue);
    }
  }

  // ğŸ›¡ï¸ è§£å†³æ—¶é’ŸåŒæ­¥é—®é¢˜ - ä½¿ç”¨è¿›ç¨‹ID + UUID + ä¸»æœºå
  private generateSecureLockValue(): string {
    const pid = process.pid;
    const uuid = require('crypto').randomUUID();
    const hostname = require('os').hostname();
    const sequence = Date.now(); // ä»…ä½œä¸ºåºåˆ—å·
    
    return `${hostname}:${pid}:${uuid}:${sequence}`;
  }

  // ğŸ”„ æ™ºèƒ½ç»­æœŸæœºåˆ¶ - åœ¨1/3 TTLæ—¶ç»­æœŸ
  private setupAutoRenewal(lockKey: string, lockValue: string, config: LockConfig): NodeJS.Timeout {
    const renewalInterval = Math.floor(config.ttl / 3);
    
    const tracker = setInterval(async () => {
      try {
        const renewed = await this.renewLockIfOwned(lockKey, lockValue, config.ttl);
        if (!renewed) {
          this.logger.warn(`Lock ownership lost: ${lockKey}`);
          clearInterval(tracker);
        }
      } catch (error) {
        this.logger.error(`Lock renewal error: ${lockKey}`, { error });
      }
    }, renewalInterval);
    
    this.renewalTrackers.set(lockKey, tracker);
    return tracker;
  }

  // âš›ï¸ åŸå­æ€§ç»­æœŸæ“ä½œ - Luaè„šæœ¬ç¡®ä¿åŸå­æ€§
  private async renewLockIfOwned(lockKey: string, lockValue: string, ttl: number): Promise<boolean> {
    const luaScript = `
      if redis.call('GET', KEYS[1]) == ARGV[1] then
        redis.call('PEXPIRE', KEYS[1], ARGV[2])
        return 1
      else
        return 0
      end
    `;
    const result = await this.redis.eval(luaScript, 1, lockKey, lockValue, ttl.toString());
    return result === 1;
  }

  // ğŸ’¥ æ­»é”æ£€æµ‹ä¸è‡ªåŠ¨æ¸…ç†
  private async createDeadlockTimeoutPromise<T>(timeout: number, key: string): Promise<T> {
    return new Promise((_, reject) => {
      setTimeout(() => {
        reject(new DeadlockTimeoutException(`Deadlock detected for lock: ${key}`));
      }, timeout);
    });
  }

  // ğŸ” è·å–é”ï¼ˆå¸¦æŒ‡æ•°é€€é¿ï¼‰
  private async acquireLockWithRetry(lockKey: string, lockValue: string, config: LockConfig): Promise<boolean> {
    let backoffMs = config.initialBackoff;
    
    for (let retry = 0; retry < config.maxRetries; retry++) {
      const acquired = await this.atomicSetNx(lockKey, lockValue, config.ttl);
      if (acquired) return true;
      
      if (retry < config.maxRetries - 1) {
        const jitter = Math.random() * 0.3 * backoffMs; // 30%æŠ–åŠ¨
        await this.sleep(backoffMs + jitter);
        backoffMs = Math.min(backoffMs * 2, config.maxBackoff);
      }
    }
    return false;
  }

  // ğŸ›¡ï¸ å®‰å…¨é‡Šæ”¾é” - åªæœ‰é”æŒæœ‰è€…èƒ½é‡Šæ”¾
  private async safelyReleaseLock(lockKey: string, lockValue: string): Promise<void> {
    const luaScript = `
      if redis.call('GET', KEYS[1]) == ARGV[1] then
        return redis.call('DEL', KEYS[1])
      else
        return 0
      end
    `;
    await this.redis.eval(luaScript, 1, lockKey, lockValue);
  }
}

// ğŸ§ª é—®é¢˜4: æµ‹è¯•è¦†ç›–ç‡ä¿è¯
// æ¯ä¸ªæœåŠ¡éƒ½å¿…é¡»æœ‰å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶ï¼Œæ„å»ºæµç¨‹å¼ºåˆ¶æ£€æŸ¥è¦†ç›–ç‡
```

### **ğŸ“‹ ç®€åŒ–çš„APIæ¶æ„è®¾è®¡ï¼ˆå…¨æ–°é¡¹ç›®ä¼˜åŒ–ï¼‰**

> **ğŸ’¡ è®¾è®¡ç†å¿µ**ï¼šä½œä¸ºå…¨æ–°é¡¹ç›®ï¼Œæˆ‘ä»¬ç›´æ¥é‡‡ç”¨ç»Ÿä¸€å¯è§‚æµ‹æ€§å¹³å°æ¶æ„ï¼Œé¿å…å†å²åŒ…è¢±å’Œä¸å¿…è¦çš„å¤æ‚æ€§ã€‚

```typescript
// ğŸ¯ ç»Ÿä¸€çš„å¯è§‚æµ‹æ€§æ§åˆ¶å™¨
@Controller('api/v1/observability')
export class ObservabilityController {
  constructor(
    private readonly securityPresenter: SecurityPresenter,
    private readonly monitoringPresenter: MonitoringPresenter,
    private readonly logger = createLogger(ObservabilityController.name)
  ) {}
  
  // ğŸ›¡ï¸ å®‰å…¨ç›¸å…³API
  @Get('security/audit-logs')
  @ApiKeyAuth([Permission.SECURITY_READ])
  async getSecurityAuditLogs(@Query() query: SecurityQueryDto) {
    return this.securityPresenter.getAuditReport(query);
  }
  
  @Get('security/risk-analysis')
  @Auth([UserRole.ADMIN, UserRole.SECURITY_OFFICER])
  async getSecurityRiskAnalysis(@Query() query: RiskQueryDto) {
    return this.securityPresenter.getRiskAnalysis(query);
  }
  
  // ğŸ“Š ç›‘æ§ç›¸å…³API  
  @Get('monitoring/health')
  @Public()
  async getSystemHealth() {
    return this.monitoringPresenter.getHealthStatus();
  }
  
  @Get('monitoring/metrics')
  @ApiKeyAuth([Permission.MONITORING_READ])
  async getMetrics(@Query() query: MetricsQueryDto) {
    return this.monitoringPresenter.getMetrics(query);
  }
  
  // ğŸ”„ ç»Ÿä¸€ä»ªè¡¨æ¿API
  @Get('dashboard/unified')
  @Auth([UserRole.ADMIN, UserRole.DEVELOPER])
  async getUnifiedDashboard(@Query() query: DashboardQueryDto) {
    const [securityData, monitoringData] = await Promise.all([
      this.securityPresenter.getDashboardData(query),
      this.monitoringPresenter.getDashboardData(query)
    ]);
    
    return {
      security: securityData,
      monitoring: monitoringData,
      timestamp: new Date(),
      correlationId: query.correlationId
    };
  }
}

// ğŸ—ï¸ ç»Ÿä¸€çš„å¯è§‚æµ‹æ€§æ¨¡å—
@Module({
  imports: [
    // ç›´æ¥å¯¼å…¥ç»Ÿä¸€æ¶æ„æ¨¡å—
    ObservabilityInfrastructureModule,
    ObservabilityCollectorModule, 
    ObservabilityAnalyzerModule,
    ObservabilityPresenterModule
  ],
  controllers: [ObservabilityController],
  exports: [
    ObservabilityInfrastructureModule,
    ObservabilityCollectorModule,
    ObservabilityAnalyzerModule, 
    ObservabilityPresenterModule
  ]
})
export class ObservabilityModule {}
```

## ğŸ¯ **é¢„æœŸæ”¶ç›Šè¯„ä¼°**

### **ğŸ“Š é‡åŒ–æŒ‡æ ‡æå‡ï¼ˆä¸“å®¶è¯„å®¡ä¼˜åŒ–ç‰ˆå¯¹æ¯”ï¼‰**

```
                        ä¿®å¤å‰      åŸæ–¹æ¡ˆ      ä¼˜åŒ–æ–¹æ¡ˆ
ğŸ“ˆ æ¶æ„è´¨é‡æå‡
â”œâ”€â”€ ä»£ç é‡å¤ç‡           35%         8%          8%        âœ… ä¿æŒä¼˜ç§€
â”œâ”€â”€ æœåŠ¡ä¾èµ–å¤æ‚åº¦       7ä¸ªä¾èµ–     3-4ä¸ªä¾èµ–   3-4ä¸ªä¾èµ–  âœ… ä¿æŒä¼˜ç§€  
â”œâ”€â”€ æµ‹è¯•è¦†ç›–ç‡           0%         85%+        80%+      âœ… å®é™…å¯è¾¾æˆ
â”œâ”€â”€ å†…å­˜å®‰å…¨æ€§           ğŸ”´é«˜é£é™©    ğŸŸ¢å®‰å…¨      ğŸŸ¢å®‰å…¨     âœ… å¼ºåˆ¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”œâ”€â”€ æ•°æ®å®‰å…¨æ€§           ğŸ”´æ³„éœ²é£é™©  ğŸŸ¢è„±æ•ä¿æŠ¤  ğŸŸ¢ä¼ä¸šçº§è„±æ• âœ… æ­£åˆ™+é€’å½’+æ€§èƒ½ä¼˜åŒ–
â”œâ”€â”€ åˆ†å¸ƒå¼é”å¯é æ€§       -          ğŸŸ¡åŸºç¡€ç‰ˆ    ğŸŸ¢ä¼ä¸šçº§   ğŸ†• è‡ªåŠ¨ç»­æœŸ+æ­»é”æ£€æµ‹
â””â”€â”€ æ‰©å±•èƒ½åŠ›             å•ä½“å¼      æ’ä»¶åŒ–      æ’ä»¶åŒ–     âœ… ä¿æŒä¼˜ç§€

ğŸš€ å¼€å‘æ•ˆç‡æå‡  
â”œâ”€â”€ æ–°åŠŸèƒ½å¼€å‘           -          50%å‡å°‘     50%å‡å°‘    âœ… ç»Ÿä¸€åŸºç±»æŠ½è±¡
â”œâ”€â”€ é—®é¢˜æ’æŸ¥             -          70%æå‡     70%æå‡    âœ… ç»Ÿä¸€æ—¥å¿—æ ¼å¼
â”œâ”€â”€ æµ‹è¯•ç¼–å†™             -          60%æå‡     60%æå‡    âœ… åŸºç±»mockæ”¯æŒ
â”œâ”€â”€ æ¶æ„å¤æ‚åº¦           -          ğŸŸ¡ä¸­ç­‰      ğŸŸ¢ç®€å•     ğŸ†• ç›´æ¥ç»Ÿä¸€æ¶æ„ï¼Œæ— å†å²åŒ…è¢±
â””â”€â”€ ç»´æŠ¤æˆæœ¬             -          40%é™ä½     60%é™ä½    ğŸ†• ç»Ÿä¸€APIï¼Œç®€åŒ–è¿ç»´

ğŸ“‹ åˆè§„æ€§ä¸å¯é æ€§æå‡
â”œâ”€â”€ å®‰å…¨å®¡è®¡             -          100%å¯è¿½æº¯  100%å¯è¿½æº¯  âœ… ä¿æŒä¼˜ç§€
â”œâ”€â”€ æ•°æ®ä¿æŠ¤             -          GDPRåˆè§„    GDPR+å¢å¼º   ğŸ†• å¤šå±‚çº§è„±æ•ç­–ç•¥
â”œâ”€â”€ ç³»ç»Ÿå¯ç”¨æ€§           -          99.9%       99.9%      âœ… ä¿æŒé«˜å¯ç”¨
â”œâ”€â”€ å¼€å‘æ•ˆç‡             -          -           +40%       ğŸ†• å…¨æ–°æ¶æ„ï¼Œæ— è¿ç§»æˆæœ¬
â””â”€â”€ ä¸Šçº¿é€Ÿåº¦             -          60%ç¼©çŸ­     80%ç¼©çŸ­    ğŸ†• ç›´æ¥å¼€å‘ï¼Œæ— åˆ‡æ¢æˆæœ¬

â±ï¸ å®æ–½æ—¶é—´çº¿å¯¹æ¯”ï¼ˆå…¨æ–°é¡¹ç›®ä¼˜åŠ¿ï¼‰
â”œâ”€â”€ åŸè¿ç§»æ–¹æ¡ˆæ—¶é—´çº¿     -          12å‘¨        -          âŒ é€‚ç”¨äºé—ç•™ç³»ç»Ÿ
â”œâ”€â”€ å…¨æ–°å¼€å‘æ—¶é—´çº¿       -          -           8-10å‘¨     ğŸ†• ç›´æ¥å®ç°ç»Ÿä¸€æ¶æ„
â”œâ”€â”€ å¤æ‚åº¦é£é™©           -          ğŸ”´é«˜é£é™©    ğŸŸ¢é›¶é£é™©   ğŸ†• æ— é—ç•™ç³»ç»ŸåŒ…è¢±
â””â”€â”€ æµ‹è¯•å¤æ‚æ€§           -          ğŸŸ¡å¤æ‚      ğŸŸ¢ç®€å•     ğŸ†• å•ä¸€æ¶æ„ï¼Œæµ‹è¯•æ¸…æ™°
```

### **ğŸ† æˆ˜ç•¥ä»·å€¼**

1. **æŠ€æœ¯å€ºåŠ¡æ¸…é›¶** - è§£å†³ç›‘æ§ç»„ä»¶15ä¸ªå·²çŸ¥é—®é¢˜
2. **æ¶æ„ç°ä»£åŒ–** - å»ºç«‹ä¼ä¸šçº§å¯è§‚æµ‹æ€§å¹³å°
3. **æ‰©å±•æ€§å¢å¼º** - æ’ä»¶åŒ–è®¾è®¡æ”¯æŒæœªæ¥éœ€æ±‚
4. **å›¢é˜Ÿåä½œ** - ç»Ÿä¸€æ¥å£æ ‡å‡†ï¼Œå‡å°‘æ²Ÿé€šæˆæœ¬
5. **åˆè§„ä¿éšœ** - å†…ç½®å®‰å…¨å’Œå®¡è®¡æœºåˆ¶

## âš ï¸ **é£é™©æ§åˆ¶ä¸ç¼“è§£**

| é£é™©ç±»å‹ | é£é™©æè¿° | ç¼“è§£ç­–ç•¥ | ç›‘æ§æŒ‡æ ‡ |
|----------|----------|----------|----------|
| **æŠ€æœ¯é£é™©** | é‡æ„å¼•å…¥æ–°bug | æ¸è¿›å¼è¿ç§»+å……åˆ†æµ‹è¯• | é”™è¯¯ç‡<0.1% |
| **æ€§èƒ½é£é™©** | åˆ†å¸ƒå¼é”å½±å“å“åº”æ—¶é—´ | å¼‚æ­¥å¤„ç†+æ€§èƒ½åŸºå‡† | P99<200ms |
| **äººå‘˜é£é™©** | å›¢é˜Ÿå­¦ä¹ æ–°æ¶æ„æˆæœ¬ | æŠ€æœ¯åˆ†äº«+è¯¦ç»†æ–‡æ¡£ | åŸ¹è®­è¦†ç›–ç‡100% |
| **ä¸šåŠ¡é£é™©** | è¿ç§»æœŸé—´åŠŸèƒ½ä¸å¯ç”¨ | è“ç»¿éƒ¨ç½²+å›æ»šæœºåˆ¶ | å¯ç”¨æ€§>99.5% |

## ğŸ‰ **ä¸“å®¶è¯„å®¡åçš„æœ€ç»ˆæ¨è**

**ç»è¿‡ä¸“ä¸šæŠ€æœ¯è¯„å®¡å’Œæ·±åº¦ä¼˜åŒ–ï¼Œè¿™ä¸ªç»Ÿä¸€å¯è§‚æµ‹æ€§å¹³å°æ–¹æ¡ˆç°åœ¨æ˜¯çœŸæ­£çš„ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆï¼š**

### **âœ… æ ¸å¿ƒä¼˜åŠ¿ï¼ˆä¿æŒå¹¶å¼ºåŒ–ï¼‰**
- **å››å±‚æ¶æ„å®Œç¾å®ç°** - ä¸¥æ ¼éµå¾ªInfrastructure â†’ Collector â†’ Analyzer â†’ Presenter
- **ä»£ç å¤ç”¨æœ€å¤§åŒ–** - é€šè¿‡æŠ½è±¡åŸºç±»æ¶ˆé™¤35% â†’ 8%çš„é‡å¤ä»£ç 
- **å·²çŸ¥ç¼ºé™·å…¨é¢ä¿®å¤** - åŒæ—¶è§£å†³ç›‘æ§ç»„ä»¶çš„15ä¸ªå…³é”®é—®é¢˜
- **é¢†åŸŸä¸“ä¸šæ€§ä¿æŒ** - Securityå’ŒMonitoringå„è‡ªä¿æŒä¸“ä¸šç‰¹è‰²
- **æ’ä»¶åŒ–æ¶æ„** - æ”¯æŒæœªæ¥ä¸šåŠ¡æ‰©å±•éœ€æ±‚

### **ğŸ†• å…¨æ–°é¡¹ç›®ä¼˜åŠ¿**
- **ğŸ”’ ä¼ä¸šçº§åˆ†å¸ƒå¼é”** - è§£å†³æ—¶é’ŸåŒæ­¥ã€è‡ªåŠ¨ç»­æœŸã€æ­»é”æ£€æµ‹é—®é¢˜
- **âš¡ ç›´æ¥ç»Ÿä¸€æ¶æ„** - 8-10å‘¨ç›´æ¥å¼€å‘ï¼Œæ— é—ç•™ç³»ç»Ÿè¿ç§»æˆæœ¬
- **ğŸ¯ ç®€åŒ–è®¾è®¡** - ç»Ÿä¸€APIæ¶æ„ï¼Œé¿å…å¤æ‚çš„è·¯ç”±å’Œå¼€å…³é€»è¾‘
- **ğŸ›¡ï¸ å†…ç½®æœ€ä½³å®è·µ** - ä»è®¾è®¡é˜¶æ®µå°±é›†æˆå®‰å…¨ã€æ€§èƒ½ã€å¯è§‚æµ‹æ€§
- **ğŸ“Š æ¸…æ™°æµ‹è¯•ç­–ç•¥** - å•ä¸€æ¶æ„ï¼Œæµ‹è¯•å¤æ‚åº¦å¤§å¹…é™ä½

### **ğŸ¯ å®æ–½å»ºè®®ï¼ˆå…¨æ–°é¡¹ç›®ï¼‰**
1. **Week 1-3**: åŸºç¡€è®¾æ–½å±‚å®ç°ï¼ˆåˆ†å¸ƒå¼é”ã€æ•°æ®è„±æ•ã€ç¼“å­˜æŠ½è±¡ï¼‰
2. **Week 4-6**: Collector + Analyzerå±‚å¼€å‘ï¼ˆæ•°æ®æ”¶é›†å’Œåˆ†æé€»è¾‘ï¼‰
3. **Week 7-8**: Presenterå±‚å®ç°ï¼ˆç»Ÿä¸€APIå’Œä»ªè¡¨æ¿ï¼‰
4. **Week 9-10**: é›†æˆæµ‹è¯•å’Œæ€§èƒ½ä¼˜åŒ–

### **ğŸ’ å…¨æ–°é¡¹ç›®è´¨é‡ä¿è¯**
- **æ¶æ„ä¸€è‡´æ€§**: 100%ç»Ÿä¸€å››å±‚æ¶æ„
- **å¼€å‘æ•ˆç‡**: æ¯”è¿ç§»æ–¹æ¡ˆæå‡40%
- **æµ‹è¯•è¦†ç›–**: 80%+è¦†ç›–ç‡ï¼Œæµ‹è¯•ç­–ç•¥ç®€å•æ¸…æ™°
- **å®‰å…¨åˆè§„**: ä»è®¾è®¡é˜¶æ®µé›†æˆGDPRåˆè§„

**å»ºè®®é‡‡ç”¨å…¨æ–°é¡¹ç›®8-10å‘¨å¼€å‘æ–¹æ¡ˆï¼Œç›´æ¥å®ç°ä¼ä¸šçº§ç»Ÿä¸€å¯è§‚æµ‹æ€§å¹³å°ï¼Œäº«å—é›¶å†å²åŒ…è¢±çš„æ¶æ„ä¼˜åŠ¿ï¼**