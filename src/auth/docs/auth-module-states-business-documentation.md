# Auth 模块状态管理业务文档

## 概述

本文档详细说明了Auth模块中各种状态的业务含义、使用场景和转换规则，为开发团队提供明确的业务逻辑指引。

## 状态定义

### 基础状态

#### ACTIVE - 激活状态
- **业务含义**: 资源处于正常可用状态
- **适用场景**: 用户账户激活、API密钥生效、权限启用
- **持续时间**: 永久，直到主动更改
- **显示名称**: "激活"

#### INACTIVE - 非激活状态  
- **业务含义**: 资源暂时不可用，但可以重新激活
- **适用场景**: 用户账户暂时禁用、API密钥临时停用
- **持续时间**: 由管理员决定
- **显示名称**: "未激活"

#### SUSPENDED - 暂停状态
- **业务含义**: 由于违规或安全原因临时停用
- **适用场景**: 账户被举报、检测到异常行为、API超额使用
- **持续时间**: 需要人工审核和处理
- **显示名称**: "已暂停"

#### DELETED - 删除状态  
- **业务含义**: 标记删除，不可逆转的终态
- **适用场景**: 用户主动删除账户、管理员永久封禁、数据保留到期
- **持续时间**: 永久（物理删除前的标记期）
- **显示名称**: "已删除"

#### EXPIRED - 过期状态
- **业务含义**: 超出有效期限，需要续期或重新申请
- **适用场景**: API密钥到期、会员资格过期、临时权限过期
- **持续时间**: 直到续期或重新申请
- **显示名称**: "已过期"

#### REVOKED - 撤销状态
- **业务含义**: 被明确撤销，不可逆转的终态
- **适用场景**: 管理员撤销权限、安全事件后撤销密钥、违规后撤销资格
- **持续时间**: 永久
- **显示名称**: "已撤销"

#### LOCKED - 锁定状态
- **业务含义**: 由于安全原因被锁定，需要特殊处理
- **适用场景**: 多次登录失败、检测到可疑活动、安全审计异常
- **持续时间**: 需要安全验证或管理员解锁
- **显示名称**: "已锁定"

### 临时状态

#### PENDING - 等待处理
- **业务含义**: 初始创建后等待处理的中间状态
- **适用场景**: 
  - 用户注册后等待邮箱验证
  - 资源创建后等待初始化
  - 配置更改后等待生效
- **超时时间**: 24小时（系统自动清理）
- **触发条件**: 用户提交注册表单、创建新资源请求
- **显示名称**: "等待处理"

**PENDING状态转换规则**:
- ✅ → ACTIVE: 验证通过，资源激活
- ✅ → INACTIVE: 验证失败或管理员禁用
- ✅ → DELETED: 用户主动删除或系统超时清理
- ✅ → EXPIRED: 验证链接过期
- ❌ → SUSPENDED: 不应该从待处理直接暂停
- ❌ → REVOKED: 不应该从待处理直接撤销
- ❌ → LOCKED: 不应该从待处理直接锁定

#### PENDING_VERIFICATION - 等待验证
- **业务含义**: 敏感资源等待人工审核的中间状态
- **适用场景**:
  - API密钥申请等待管理员审核
  - 权限提升请求等待批准
  - 高级功能申请等待验证
- **超时时间**: 72小时（系统自动拒绝）
- **触发条件**: 提交敏感资源申请、请求权限提升
- **显示名称**: "等待验证"

**PENDING_VERIFICATION状态转换规则**:
- ✅ → ACTIVE: 管理员审核通过
- ✅ → REVOKED: 管理员审核拒绝
- ✅ → DELETED: 申请人撤回或系统超时清理
- ✅ → EXPIRED: 审核超时自动过期
- ❌ → INACTIVE: 审核过程不应产生未激活状态
- ❌ → SUSPENDED: 审核过程不应直接暂停
- ❌ → LOCKED: 审核过程不应直接锁定

## 状态分组

### 可用状态组 (AVAILABLE)
- **成员**: [ACTIVE]
- **特征**: 资源可正常访问和使用
- **业务逻辑**: 只有激活状态的资源才能被正常使用

### 不可用状态组 (UNAVAILABLE)  
- **成员**: [INACTIVE, SUSPENDED, DELETED, EXPIRED, REVOKED, LOCKED]
- **特征**: 资源无法正常访问
- **业务逻辑**: 这些状态的资源应该拒绝访问请求

### 临时状态组 (TEMPORARY)
- **成员**: [PENDING, PENDING_VERIFICATION]  
- **特征**: 可能变更的中间状态
- **业务逻辑**: 需要定期检查和处理的状态

### 终态状态组 (FINAL)
- **成员**: [DELETED, REVOKED]
- **特征**: 不可逆转的最终状态
- **业务逻辑**: 一旦进入终态，不能再转换到其他状态

## 状态转换矩阵

| 源状态 | 可转换目标状态 | 业务场景 |
|--------|-------------|----------|
| PENDING | ACTIVE, INACTIVE, DELETED, EXPIRED | 验证完成、处理失败、用户取消、链接过期 |
| PENDING_VERIFICATION | ACTIVE, REVOKED, DELETED, EXPIRED | 审核通过、审核拒绝、用户撤回、审核超时 |
| ACTIVE | 任何状态 | 管理员操作、用户操作、系统事件 |
| INACTIVE | ACTIVE, DELETED | 重新激活、永久删除 |
| SUSPENDED | ACTIVE, DELETED | 解除暂停、永久删除 |
| EXPIRED | ACTIVE, DELETED | 续期、删除 |
| LOCKED | ACTIVE, DELETED | 解锁、删除 |
| DELETED | 无 | 终态，不可转换 |
| REVOKED | 无 | 终态，不可转换 |

## 业务规则

### 自动化规则

1. **超时处理**
   - PENDING状态超过24小时自动转为DELETED
   - PENDING_VERIFICATION状态超过72小时自动转为EXPIRED

2. **安全规则**  
   - 连续登录失败超过5次自动转为LOCKED
   - 检测到异常API调用模式自动转为SUSPENDED

3. **过期检查**
   - 每日凌晨检查到期资源，自动转为EXPIRED

### 人工干预规则

1. **管理员权限**
   - 管理员可以在任何非终态状态间进行转换
   - 管理员可以强制将任何状态转为DELETED或REVOKED

2. **用户操作**
   - 用户只能主动将自己的资源转为DELETED
   - 用户不能逆转管理员的操作

## 监控和警报

### 关键指标
- PENDING状态资源数量（应保持较低）
- PENDING_VERIFICATION状态处理时间（应在SLA内）
- LOCKED/SUSPENDED状态增长率（监控异常）

### 警报规则
- PENDING状态资源超过1000个
- PENDING_VERIFICATION平均处理时间超过48小时
- LOCKED状态日增长超过100个

## 最佳实践

### 开发建议
1. 在业务逻辑中始终使用StatusUtils工具函数
2. 不要硬编码状态值，使用CommonStatus常量
3. 状态转换前必须调用StatusUtils.canTransition验证

### 运维建议  
1. 定期清理DELETED状态的过期数据
2. 监控临时状态的处理效率
3. 建立状态异常的自动告警机制

### 用户体验建议
1. 向用户展示状态的明确含义和预期处理时间
2. 提供状态变更的邮件通知
3. 为LOCKED和SUSPENDED状态提供申诉渠道