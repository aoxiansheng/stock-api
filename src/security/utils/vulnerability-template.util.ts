/**
 * æ¼æ´æ¨¡æ¿å·¥å…·ç±»
 * ğŸ¯ ç¬¦åˆå¼€å‘è§„èŒƒæŒ‡å— - æ¨¡æ¿åŒ–æ¼æ´ç®¡ç†
 */

import {
  SECURITY_VULNERABILITY_TEMPLATES,
  SECURITY_VULNERABILITY_STATUS,
} from '../../security/constants/security-scanner.constants';
import { SecurityVulnerability } from '../../security/interfaces/security-scanner.interface';

/**
 * æ¨¡æ¿å‚æ•°æ¥å£
 */
export interface VulnerabilityTemplateParams {
  [key: string]: string | number | string[];
}

/**
 * æ¼æ´æ¨¡æ¿å·¥å…·ç±»
 */
export class VulnerabilityTemplateUtil {
  /**
   * æ ¹æ®æ¨¡æ¿åˆ›å»ºæ¼æ´å¯¹è±¡
   * @param templateKey æ¨¡æ¿é”®å
   * @param params æ¨¡æ¿å‚æ•°
   * @returns æ¼æ´å¯¹è±¡
   */
  static createVulnerability(
    templateKey: keyof typeof SECURITY_VULNERABILITY_TEMPLATES,
    params: VulnerabilityTemplateParams = {},
  ): SecurityVulnerability {
    const template = SECURITY_VULNERABILITY_TEMPLATES[templateKey];
    
    if (!template) {
      throw new Error(`æ¼æ´æ¨¡æ¿ä¸å­˜åœ¨: ${templateKey}`);
    }

    return {
      id: this.replaceTemplate(template.id, params),
      type: template.type as SecurityVulnerability['type'],
      severity: template.severity as SecurityVulnerability['severity'],
      title: this.replaceTemplate(template.title, params),
      description: this.replaceTemplate(template.description, params),
      impact: this.replaceTemplate(template.impact, params),
      recommendation: this.replaceTemplate(template.recommendation, params),
      detected: new Date(),
      status: SECURITY_VULNERABILITY_STATUS.DETECTED as SecurityVulnerability['status'],
    };
  }

  /**
   * åˆ›å»ºé»˜è®¤å‡­æ®æ¼æ´
   * @param usernames é»˜è®¤ç”¨æˆ·ååˆ—è¡¨
   * @returns æ¼æ´å¯¹è±¡
   */
  static createDefaultCredentialsVulnerability(usernames: string[]): SecurityVulnerability {
    return this.createVulnerability('DEFAULT_CREDENTIALS', {
      usernames: usernames.join(', '),
    });
  }

  /**
   * åˆ›å»ºè¿‡æœŸAPI Keyæ¼æ´
   * @param apiKeyId API Key ID
   * @param maskedKey æ©ç åçš„API Key
   * @returns æ¼æ´å¯¹è±¡
   */
  static createExpiredApiKeyVulnerability(apiKeyId: string, maskedKey: string): SecurityVulnerability {
    return this.createVulnerability('EXPIRED_API_KEY', {
      id: apiKeyId,
      maskedKey,
    });
  }

  /**
   * åˆ›å»ºæƒé™è¿‡å¤šæ¼æ´
   * @param apiKeyId API Key ID
   * @param maskedKey æ©ç åçš„API Key
   * @returns æ¼æ´å¯¹è±¡
   */
  static createExcessivePermissionsVulnerability(apiKeyId: string, maskedKey: string): SecurityVulnerability {
    return this.createVulnerability('EXCESSIVE_PERMISSIONS', {
      id: apiKeyId,
      maskedKey,
    });
  }

  /**
   * åˆ›å»ºé¢‘ç‡é™åˆ¶ä¸è¶³æ¼æ´
   * @param count æ²¡æœ‰é¢‘ç‡é™åˆ¶çš„API Keyæ•°é‡
   * @returns æ¼æ´å¯¹è±¡
   */
  static createInsufficientRateLimitingVulnerability(count: number): SecurityVulnerability {
    return this.createVulnerability('INSUFFICIENT_RATE_LIMITING', {
      count: count.toString(),
    });
  }

  /**
   * åˆ›å»ºJWTå¯†é’¥å¼ºåº¦ä¸è¶³æ¼æ´
   * @param minLength æœ€å°é•¿åº¦è¦æ±‚
   * @returns æ¼æ´å¯¹è±¡
   */
  static createWeakJwtSecretVulnerability(minLength: number): SecurityVulnerability {
    return this.createVulnerability('WEAK_JWT_SECRET', {
      minLength: minLength.toString(),
    });
  }

  /**
   * åˆ›å»ºç”Ÿäº§ç¯å¢ƒæœ¬åœ°æ•°æ®åº“æ¼æ´
   * @returns æ¼æ´å¯¹è±¡
   */
  static createLocalhostDbInProductionVulnerability(): SecurityVulnerability {
    return this.createVulnerability('LOCALHOST_DB_IN_PRODUCTION');
  }

  /**
   * åˆ›å»ºå¯†ç å“ˆå¸Œå¼ºåº¦ä¸è¶³æ¼æ´
   * @param currentRounds å½“å‰å“ˆå¸Œè½®æ•°
   * @param recommendedRounds æ¨èå“ˆå¸Œè½®æ•°
   * @returns æ¼æ´å¯¹è±¡
   */
  static createWeakPasswordHashingVulnerability(
    currentRounds: number,
    recommendedRounds: number,
  ): SecurityVulnerability {
    return this.createVulnerability('WEAK_PASSWORD_HASHING', {
      currentRounds: currentRounds.toString(),
      recommendedRounds: recommendedRounds.toString(),
    });
  }

  /**
   * æ›¿æ¢æ¨¡æ¿ä¸­çš„å ä½ç¬¦
   * @param template æ¨¡æ¿å­—ç¬¦ä¸²
   * @param params å‚æ•°å¯¹è±¡
   * @returns æ›¿æ¢åçš„å­—ç¬¦ä¸²
   */
  private static replaceTemplate(template: string, params: VulnerabilityTemplateParams): string {
    let result = template;
    
    Object.entries(params).forEach(([key, value]) => {
      const placeholder = `{${key}}`;
      const replacement = Array.isArray(value) ? value.join(', ') : value.toString();
      result = result.replace(new RegExp(placeholder, 'g'), replacement);
    });
    
    return result;
  }

  /**
   * éªŒè¯æ¨¡æ¿å‚æ•°
   * @param templateKey æ¨¡æ¿é”®å
   * @param params å‚æ•°å¯¹è±¡
   * @returns æ˜¯å¦æœ‰æ•ˆ
   */
  static validateTemplateParams(
    templateKey: keyof typeof SECURITY_VULNERABILITY_TEMPLATES,
    params: VulnerabilityTemplateParams,
  ): boolean {
    const template = SECURITY_VULNERABILITY_TEMPLATES[templateKey];
    
    if (!template) {
      return false;
    }

    // æ£€æŸ¥æ¨¡æ¿ä¸­çš„å ä½ç¬¦æ˜¯å¦éƒ½æœ‰å¯¹åº”çš„å‚æ•°
    const placeholderRegex = /\{(\w+)\}/g;
    const templateString = `${template.id} ${template.description} ${template.impact} ${template.recommendation}`;
    const matches = templateString.match(placeholderRegex);
    
    if (!matches) {
      return true; // æ²¡æœ‰å ä½ç¬¦ï¼Œå‚æ•°æœ‰æ•ˆ
    }

    const requiredParams = matches.map(match => match.slice(1, -1)); // ç§»é™¤å¤§æ‹¬å·
    const providedParams = Object.keys(params);
    
    return requiredParams.every(param => providedParams.includes(param));
  }

  /**
   * è·å–æ¨¡æ¿ä¸­çš„å ä½ç¬¦åˆ—è¡¨
   * @param templateKey æ¨¡æ¿é”®å
   * @returns å ä½ç¬¦åˆ—è¡¨
   */
  static getTemplatePlaceholders(templateKey: keyof typeof SECURITY_VULNERABILITY_TEMPLATES): string[] {
    const template = SECURITY_VULNERABILITY_TEMPLATES[templateKey];
    
    if (!template) {
      return [];
    }

    const placeholderRegex = /\{(\w+)\}/g;
    const templateString = `${template.id} ${template.description} ${template.impact} ${template.recommendation}`;
    const matches = templateString.match(placeholderRegex);
    
    if (!matches) {
      return [];
    }

    return [...new Set(matches.map(match => match.slice(1, -1)))]; // ç§»é™¤å¤§æ‹¬å·å¹¶å»é‡
  }

  /**
   * è·å–æ‰€æœ‰å¯ç”¨çš„æ¨¡æ¿é”®å
   * @returns æ¨¡æ¿é”®ååˆ—è¡¨
   */
  static getAvailableTemplates(): string[] {
    return Object.keys(SECURITY_VULNERABILITY_TEMPLATES);
  }

  /**
   * æ£€æŸ¥æ¨¡æ¿æ˜¯å¦å­˜åœ¨
   * @param templateKey æ¨¡æ¿é”®å
   * @returns æ˜¯å¦å­˜åœ¨
   */
  static hasTemplate(templateKey: string): boolean {
    return templateKey in SECURITY_VULNERABILITY_TEMPLATES;
  }
}
