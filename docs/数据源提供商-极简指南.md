# 数据源提供商-极简指南（providersv2）

目标：提供一个最小、稳定、易维护的数据源接入方式，彻底移除装饰器/自动扫描/CLI 生成等复杂机制。

## 架构要点

- 注册表服务：`ProviderRegistryService`（单一职责：注册 + 查询/选择）
- 模块入口：`ProvidersV2Module`
- 现有 Provider：`LongportProvider`、`LongportSgProvider`
- 依赖方使用：
  - `getBestProvider(capability, market?)`
  - `getCapability(provider, capability)`
  - `getProvider(provider)`（用于获取上下文服务）

## 快速上手

1) 导入模块
```ts
// src/app.module.ts
import { ProvidersV2Module } from '@providersv2';

@Module({
  imports: [ProvidersV2Module]
})
export class AppModule {}
```

2) 在业务中使用注册表
```ts
import { ProviderRegistryService } from '@providersv2/provider-registry.service';

constructor(private readonly registry: ProviderRegistryService) {}

const best = this.registry.getBestProvider('get-stock-quote', 'HK');
const cap = this.registry.getCapability('longport', 'get-stock-quote');
const provider = this.registry.getProvider('longport');
const ctx = provider?.getContextService?.();
```

## 新增 Provider（最小步骤）

1) 创建 Provider 类并实现 `IDataProvider`
```ts
export class FooProvider implements IDataProvider {
  name = 'foo';
  description = 'Foo Data Provider';
  capabilities = [getFooQuote];

  async initialize() {}
  async testConnection() { return true; }
  getCapability(name: string) { return this.capabilities.find(c => c.name === name) || null; }
  getContextService?(): any { return this.contextService; }
}
```

2) 在其模块中提供并导出该 Provider
```ts
@Module({
  providers: [FooProvider, FooContextService],
  exports: [FooProvider, FooContextService]
})
export class FooModule {}
```

3) 在 `ProvidersV2Module` 中导入 `FooModule`，注册表将自动注入并注册

> 提示：当前注册优先级规则为注入顺序（longport=1，longportsg=2，其他默认为 10）。如需调序，可在 `ProviderRegistryService.registerProvider` 中调整。

## 设计原则

- KISS：去除装饰器、文件扫描、自动修复、CLI 等复杂机制
- YAGNI：仅保留显式注册与最小查询能力
- DRY：注册逻辑唯一入口（ProvidersV2Module + ProviderRegistryService）
- SOLID：
  - 单一职责：注册表只做注册/查询；Provider 只负责能力与上下文
  - 开闭原则：新增 Provider 只需新增模块与类，无需修改现有代码
  - 依赖倒置：业务依赖抽象（注册表接口 + IDataProvider）

## 常见问题

- 如何获取流上下文服务？
  - 通过 `registry.getProvider(name)?.getStreamContextService?.()`

- 是否支持动态发现/生成？
  - 不支持（已移除）。显式注册更可控、可维护。

- 是否需要额外环境变量？
  - 不需要。各 Provider 自行读取自身所需（如 API Key 等）。

