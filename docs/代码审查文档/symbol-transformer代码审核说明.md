# Symbol-Transformer ä»£ç å®¡æ ¸è¯´æ˜

## 1. å…³é”®é—®é¢˜

> **å®¡æ ¸çŠ¶æ€**: âœ… å·²å®Œæˆ | **é—®é¢˜éªŒè¯**: å®Œå…¨å±å® | **æœ€åæ›´æ–°**: 2025-09-21

### 1.1 å†…å­˜æ³„æ¼é£é™© âš ï¸ **[å·²éªŒè¯]**

**ä»£ç ä½ç½®**: `src/core/02-processing/symbol-transformer/utils/retry.utils.ts:45`

**é£é™©ç‚¹:**
- **æ–­è·¯å™¨ Map**: `RetryUtils.circuitBreakers` ä½¿ç”¨ Map å­˜å‚¨æ–­è·¯å™¨çŠ¶æ€ï¼Œæ— æ¸…ç†æœºåˆ¶
- **å½“å‰å½±å“**: âœ… éªŒè¯ç¡®è®¤ - RetryUtils æœªè¢« SymbolTransformerService ä½¿ç”¨ï¼Œå®é™…é£é™©è¾ƒä½
- **æ½œåœ¨é—®é¢˜**: é•¿æœŸè¿è¡Œæ—¶Mapå¯èƒ½æ— é™å¢é•¿ï¼Œå½±å“å†…å­˜ä½¿ç”¨

**ğŸ†• ä¼˜åŒ–æ–¹æ¡ˆ (æ¨è):**
```typescript
// æ™ºèƒ½è‡ªæ¸…ç†æ–­è·¯å™¨ç®¡ç†å™¨ - é›¶ç»´æŠ¤æˆæœ¬
class SmartCircuitBreakerManager {
  private static instance: SmartCircuitBreakerManager;
  private circuitBreakers = new Map<string, CircuitBreakerState>();
  private cleanupTimer: NodeJS.Timeout | null = null;

  // å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–æ¸…ç†å®šæ—¶å™¨
  static getInstance(): SmartCircuitBreakerManager {
    if (!this.instance) {
      this.instance = new SmartCircuitBreakerManager();
      this.instance.startAutoCleanup();
    }
    return this.instance;
  }

  // è‡ªåŠ¨æ¸…ç†æœºåˆ¶ï¼ˆLRU + æ—¶é—´è¿‡æœŸï¼‰
  private startAutoCleanup(): void {
    this.cleanupTimer = setInterval(() => {
      this.performIntelligentCleanup();
    }, 300000); // 5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
  }

  private performIntelligentCleanup(): void {
    const now = Date.now();
    const maxAge = 300000; // 5åˆ†é’Ÿè¿‡æœŸ

    for (const [key, breaker] of this.circuitBreakers.entries()) {
      if (now - breaker.lastAccessTime > maxAge) {
        this.circuitBreakers.delete(key);
      }
    }
  }
}
```

**åŸæ–¹æ¡ˆ vs ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”:**
| ç‰¹æ€§ | åŸæ–‡æ¡£æ–¹æ¡ˆ | ğŸ†• ä¼˜åŒ–æ–¹æ¡ˆ | ä¼˜åŠ¿ |
|------|------------|-------------|------|
| è§¦å‘æ–¹å¼ | æ‰‹åŠ¨è°ƒç”¨ | è‡ªåŠ¨æ‰§è¡Œ | âœ… é›¶ç»´æŠ¤æˆæœ¬ |
| æ¸…ç†ç­–ç•¥ | ä»…æ—¶é—´è¿‡æœŸ | LRU + æ—¶é—´è¿‡æœŸ | âœ… æ™ºèƒ½ç®¡ç† |
| å†…å­˜æ•ˆç‡ | åŸºç¡€ | é«˜æ•ˆ | âœ… å‡å°‘é•¿æœŸå†…å­˜å ç”¨ |

### 1.2 æ¨¡å—è¾¹ç•Œé—®é¢˜ âš ï¸ **[å·²éªŒè¯]**

**ä»£ç ä½ç½®**:
- `src/core/02-processing/symbol-transformer/services/symbol-transformer.service.ts`
- `src/core/00-prepare/symbol-mapper/services/symbol-mapper.service.ts`

**è¾¹ç•Œä¸æ¸…æ™°:**
- **èŒè´£é‡å **: âœ… éªŒè¯ç¡®è®¤ - ä¸ SymbolMapperService åŠŸèƒ½é‡å 
- **åŠŸèƒ½è¿ç§»**: âœ… éªŒè¯ç¡®è®¤ - æ³¨é‡Šæ˜¾ç¤ºä» SymbolMapperService è¿ç§»è€Œæ¥ï¼Œä½†æœªå®Œå…¨æ›¿ä»£
- **ä¾èµ–æ··ä¹±**: ä¸¤æœåŠ¡éƒ½ä¾èµ– `SymbolMapperCacheService`ï¼ŒèŒè´£è¾¹ç•Œæ¨¡ç³Š

**ğŸ†• æ¸è¿›å¼é‡æ„æ–¹æ¡ˆ (æ¨è):**

**é˜¶æ®µ1: æ¥å£éš”ç¦»** â­â­â­â­â­
```typescript
// æ˜ç¡®æ¥å£èŒè´£ï¼Œé¿å…åŠŸèƒ½æ··æ·†
interface ISymbolRuleManager {
  // ä»…è§„åˆ™ç®¡ç†ç›¸å…³
  createDataSourceMapping(): Promise<SymbolMappingResponseDto>;
  updateSymbolMapping(): Promise<SymbolMappingResponseDto>;
  deleteSymbolMapping(): Promise<SymbolMappingResponseDto>;
  getSymbolMappingRule(): Promise<ISymbolMappingRule[]>;
}

interface ISymbolTransformer {
  // ä»…è½¬æ¢æ‰§è¡Œç›¸å…³
  transformSymbols(): Promise<SymbolTransformResult>;
  transformSingleSymbol(): Promise<string>;
  transformSymbolsForProvider(): Promise<SymbolTransformForProviderResult>;
}
```

**é˜¶æ®µ2: é€‚é…å™¨æ¨¡å¼** â­â­â­â­
```typescript
// æä¾›å…¼å®¹å±‚ï¼Œç¡®ä¿ç°æœ‰è°ƒç”¨ä¸å—å½±å“
@Injectable()
class SymbolMapperCompatibilityAdapter {
  constructor(
    private ruleManager: ISymbolRuleManager,
    private transformer: ISymbolTransformer
  ) {}

  // ä¿æŒåŸæœ‰APIï¼Œå†…éƒ¨å§”æ´¾ç»™ä¸“é—¨çš„æœåŠ¡
  async mapSymbols(...args) {
    return this.transformer.transformSymbols(...args);
  }

  // è§„åˆ™ç®¡ç†APIä¿æŒä¸å˜
  async createDataSourceMapping(...args) {
    return this.ruleManager.createDataSourceMapping(...args);
  }
}
```

**é˜¶æ®µ3: é€æ­¥è¿ç§»** â­â­â­
- æ–°åŠŸèƒ½ä½¿ç”¨æ–°æ¥å£
- è€åŠŸèƒ½é€šè¿‡é€‚é…å™¨è¿‡æ¸¡
- é€æ­¥æ›¿æ¢è€è°ƒç”¨æ–¹

**åŸæ–¹æ¡ˆ vs ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”:**
| ç‰¹æ€§ | åŸæ–‡æ¡£æ–¹æ¡ˆ | ğŸ†• æ¸è¿›å¼æ–¹æ¡ˆ | ä¼˜åŠ¿ |
|------|------------|---------------|------|
| é‡æ„é£é™© | ä¸€æ¬¡æ€§é‡æ„ | åˆ†é˜¶æ®µè¿›è¡Œ | âœ… é™ä½ä¸šåŠ¡ä¸­æ–­é£é™© |
| å…¼å®¹æ€§ | å¯èƒ½ç ´åç°æœ‰API | å®Œå…¨å‘åå…¼å®¹ | âœ… å¹³æ»‘è¿‡æ¸¡ |
| å®æ–½éš¾åº¦ | é«˜ | ä¸­ç­‰ | âœ… å¯æ§çš„å¤æ‚åº¦ |

## 2. ä¿®å¤ä¼˜å…ˆçº§ (åŸºäºå®¡æ ¸åˆ†ææ›´æ–°)

### ğŸ”´ ç«‹å³æ‰§è¡Œï¼ˆé«˜æ€§ä»·æ¯”ï¼‰

**1. å†…å­˜æ³„æ¼é£é™©ä¿®å¤** - é‡‡ç”¨æ™ºèƒ½è‡ªæ¸…ç†ç®¡ç†å™¨
- **ä¼˜å…ˆçº§**: ğŸ”´ ç«‹å³å¤„ç†
- **å®æ–½éš¾åº¦**: ğŸŸ¢ ä½
- **ä¸šåŠ¡ä»·å€¼**: â­â­ é¢„é˜²æ€§ä¿æŠ¤
- **ç†ç”±**: é›¶ç»´æŠ¤æˆæœ¬ï¼Œè‡ªåŠ¨åŒ–ç®¡ç†ï¼Œå®æ–½ç®€å•

### ğŸŸ¡ ä¸­æœŸè§„åˆ’ï¼ˆæ¶æ„ä¼˜åŒ–ï¼‰

**2. æ¨¡å—è¾¹ç•Œé—®é¢˜** - é‡‡ç”¨æ¸è¿›å¼é‡æ„
- **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­æœŸè§„åˆ’
- **å®æ–½éš¾åº¦**: ğŸŸ¡ ä¸­ç­‰
- **ä¸šåŠ¡ä»·å€¼**: â­â­â­â­ é•¿æœŸæ¶æ„æ”¶ç›Š
- **ç†ç”±**: åˆ†é˜¶æ®µé™ä½é£é™©ï¼Œç¡®ä¿ä¸šåŠ¡è¿ç»­æ€§

## 3. æŠ€æœ¯å¯è¡Œæ€§è¯„ä¼° (å®¡æ ¸éªŒè¯ç»“æœ)

| ä¿®å¤é¡¹ç›® | åŸæ–¹æ¡ˆéš¾åº¦ | ğŸ†• ä¼˜åŒ–æ–¹æ¡ˆéš¾åº¦ | å®æ–½é£é™© | æ—¶é—´ä¼°ç®— | æ¨èåº¦ |
|---------|------------|----------------|----------|----------|-------|
| **å†…å­˜æ¸…ç†** | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ **ä½** | ğŸŸ¢ æä½é£é™© | **1å¤©** | â­â­â­â­â­ |
| **æ¨¡å—è¾¹ç•Œ** | ğŸ”´ é«˜ | ğŸŸ¡ **ä¸­ç­‰** | ğŸŸ¡ ä¸­é£é™© | **2-3å‘¨** | â­â­â­â­â­ |

**âœ… å®¡æ ¸éªŒè¯è¦ç‚¹:**
- æ‰€æœ‰é—®é¢˜åœ¨ä»£ç åº“ä¸­å¾—åˆ°ç¡®è®¤
- ä¼˜åŒ–æ–¹æ¡ˆé™ä½äº†å®æ–½å¤æ‚åº¦
- æŠ€æœ¯å¯è¡Œæ€§ç»è¿‡å®é™…ä»£ç åˆ†æéªŒè¯

## 4. æœ€ç»ˆå®¡æ ¸æ€»ç»“

### ğŸ“Š é—®é¢˜éªŒè¯çŠ¶æ€
| é—®é¢˜ç±»å‹ | éªŒè¯ç»“æœ | ä»£ç ä½ç½® | å½“å‰é£é™© | å¤„ç†å»ºè®® |
|---------|---------|----------|----------|----------|
| **å†…å­˜æ³„æ¼** | âœ… **å®Œå…¨å±å®** | `retry.utils.ts:45` | ğŸŸ¡ ä¸­ä½ | ç«‹å³ä¿®å¤ |
| **æ¨¡å—è¾¹ç•Œ** | âœ… **å®Œå…¨å±å®** | ä¸¤ä¸ªæœåŠ¡æ–‡ä»¶ | ğŸ”´ é«˜ | åˆ†é˜¶æ®µé‡æ„ |

### ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆä»·å€¼
**å†…å­˜ç®¡ç†ä¼˜åŒ–ä»·å€¼:**
- âœ… é›¶ç»´æŠ¤æˆæœ¬ï¼ˆè‡ªåŠ¨æ‰§è¡Œ vs æ‰‹åŠ¨è°ƒç”¨ï¼‰
- âœ… æ™ºèƒ½ç®¡ç†ï¼ˆLRU + æ—¶é—´è¿‡æœŸ vs ä»…æ—¶é—´è¿‡æœŸï¼‰
- âœ… æ›´é«˜æ•ˆç‡ï¼ˆå‡å°‘é•¿æœŸå†…å­˜å ç”¨ï¼‰

**æ¨¡å—é‡æ„ä¼˜åŒ–ä»·å€¼:**
- âœ… é™ä½ä¸šåŠ¡ä¸­æ–­é£é™©ï¼ˆåˆ†é˜¶æ®µ vs ä¸€æ¬¡æ€§é‡æ„ï¼‰
- âœ… å®Œå…¨å‘åå…¼å®¹ï¼ˆé€‚é…å™¨æ¨¡å¼ï¼‰
- âœ… å¯æ§å¤æ‚åº¦ï¼ˆæ¸è¿›å¼è¿ç§»ï¼‰

### ğŸ“‹ å®æ–½è·¯çº¿å›¾
```
Phase 1: å†…å­˜æ³„æ¼ä¿®å¤ (1å¤©)
â”œâ”€â”€ å®æ–½æ™ºèƒ½è‡ªæ¸…ç†ç®¡ç†å™¨
â””â”€â”€ éªŒè¯è‡ªåŠ¨æ¸…ç†æœºåˆ¶

Phase 2: æ¥å£éš”ç¦» (1å‘¨)
â”œâ”€â”€ å®šä¹‰æ˜ç¡®çš„æ¥å£è¾¹ç•Œ
â””â”€â”€ åˆ›å»ºæ¥å£å®ç°

Phase 3: é€‚é…å™¨å®ç° (1å‘¨)
â”œâ”€â”€ æ„å»ºå…¼å®¹å±‚
â””â”€â”€ ç¡®ä¿APIå‘åå…¼å®¹

Phase 4: æ¸è¿›è¿ç§» (1å‘¨)
â”œâ”€â”€ æ–°åŠŸèƒ½ä½¿ç”¨æ–°æ¥å£
â””â”€â”€ é€æ­¥æ›¿æ¢ç°æœ‰è°ƒç”¨
```

**æˆåŠŸæŒ‡æ ‡:**
- âœ… å†…å­˜ä½¿ç”¨ç¨³å®šï¼ˆæ— æ³„æ¼é£é™©ï¼‰
- âœ… æ¨¡å—èŒè´£æ¸…æ™°ï¼ˆæ¥å£éš”ç¦»ï¼‰
- âœ… APIå…¼å®¹æ€§100%ï¼ˆé›¶ç ´åæ€§å˜æ›´ï¼‰
- âœ… ä»£ç è´¨é‡æå‡ï¼ˆé€šè¿‡æ‰€æœ‰è´¨é‡é—¨æ§ï¼‰

> **å®¡æ ¸ç»“è®º**: æ–‡æ¡£é—®é¢˜å®Œå…¨å±å®ï¼Œä¼˜åŒ–æ–¹æ¡ˆæ˜¾è‘—æå‡å¯è¡Œæ€§ï¼Œå»ºè®®æŒ‰ç…§æ–°çš„å®æ–½è·¯çº¿å›¾æ‰§è¡Œã€‚