# symbol-mapper-cache ä»£ç å®¡æŸ¥è¯´æ˜

## æ¦‚è¿°

`symbol-mapper-cache` ç»„ä»¶æ˜¯æ–°è‚¡ç¥¨APIç³»ç»Ÿä¸­çš„æ ¸å¿ƒç¼“å­˜ç»„ä»¶ï¼Œå®ç°äº†ä¸‰å±‚LRUç¼“å­˜æ¶æ„ï¼Œè´Ÿè´£ç¬¦å·æ˜ å°„çš„é«˜æ€§èƒ½ç¼“å­˜ç®¡ç†ã€‚

**å®¡æŸ¥èŒƒå›´**: `src/core/05-caching/symbol-mapper-cache/services/symbol-mapper-cache.service.ts` (1642è¡Œä»£ç )
**å®¡æŸ¥æ—¶é—´**: 2025-01-21
**å®¡æŸ¥çŠ¶æ€**: âœ… å·²å®Œæˆä»£ç åº“éªŒè¯

## ğŸ“Š é—®é¢˜éªŒè¯ç»“æœæ€»è§ˆ

| é—®é¢˜ç±»å‹ | æ–‡æ¡£é¢„æœŸ | å®é™…éªŒè¯ç»“æœ | ä¸¥é‡ç¨‹åº¦è°ƒæ•´ | ä»£ç ä½ç½® |
|----------|----------|-------------|-------------|----------|
| é‡è¿å®šæ—¶å™¨æ³„æ¼ | æœªè¯†åˆ« | âœ… **é«˜é£é™©ç¡®è®¤** | æœªçŸ¥ â†’ é«˜ | ç¬¬876-881è¡Œ |
| changeStream ç±»å‹å®‰å…¨ | ä¸­ç­‰ | âœ… **ä½é£é™©ç¡®è®¤** | ä¸­ç­‰ â†’ ä½ | ç¬¬53è¡Œ |


## 1. å†…å­˜æ³„æ¼é£é™© âœ… å®é™…éªŒè¯

### ğŸ¯ æ ¸å¿ƒé—®é¢˜è¯†åˆ«

#### **é«˜é£é™©: é‡è¿å®šæ—¶å™¨æ³„æ¼** (ç¬¬876-881è¡Œ)
```typescript
// âŒ å½“å‰ä»£ç  - å®šæ—¶å™¨å¼•ç”¨æœªå­˜å‚¨ï¼Œæ— æ³•æ¸…ç†
setTimeout(() => {
  this.setupChangeStreamMonitoring();
}, delay);
```
**æ ¸å¿ƒé—®é¢˜**: å®šæ—¶å™¨å¼•ç”¨æœªä¿å­˜ï¼Œæ¨¡å—é”€æ¯æ—¶æ— æ³•æ¸…ç†ï¼Œå¯¼è‡´å®šæ—¶å™¨æŒç»­è¿è¡Œ

#### **ä½é£é™©: ç±»å‹å®‰å…¨é—®é¢˜** (ç¬¬53è¡Œ)
```typescript
// âš ï¸ å½“å‰ä»£ç  - ä½¿ç”¨ any ç±»å‹ï¼Œç¼ºä¹ç±»å‹æ£€æŸ¥
private changeStream: any;
```
**å½±å“ç¨‹åº¦**: ä»£ç è´¨é‡é—®é¢˜ï¼Œä½†ä¸ä¼šç›´æ¥å¯¼è‡´å†…å­˜æ³„æ¼

**å®é™…å½±å“è¯„ä¼°**ï¼š
- ğŸ”´ **å®šæ—¶å™¨æ³„æ¼**: é«˜é¢‘é‡è¿åœºæ™¯ä¸‹å†…å­˜æŒç»­å¢é•¿
- ğŸŸ¡ **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶æ£€æŸ¥ç¼ºå¤±ï¼Œä½†ä¸å½±å“è¿è¡Œæ—¶ç¨³å®šæ€§

### ğŸ¯ ç®€å•ç›´æ¥çš„ä¿®å¤æ–¹æ¡ˆ

#### **æ ¸å¿ƒä¿®å¤: å®šæ—¶å™¨å¼•ç”¨ç®¡ç†**

```typescript
export class SymbolMapperCacheService implements OnModuleInit, OnModuleDestroy {
  private changeStream: ChangeStream | null = null;  // å¯é€‰: ç±»å‹ä¿®å¤
  private reconnectTimer: NodeJS.Timeout | null = null;  // âœ… æ ¸å¿ƒä¿®å¤
  private memoryCheckTimer: NodeJS.Timeout | null = null;

  // ä¿®å¤é‡è¿é€»è¾‘
  private scheduleReconnection(): void {
    // æ¸…ç†æ—§çš„é‡è¿å®šæ—¶å™¨
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer);
      this.reconnectTimer = null;
    }

    const delay = Math.min(
      1000 * Math.pow(2, this.reconnectAttempts),
      this.maxReconnectDelay
    );

    // âœ… å­˜å‚¨å®šæ—¶å™¨å¼•ç”¨ä¾›åç»­æ¸…ç†
    this.reconnectTimer = setTimeout(() => {
      this.setupChangeStreamMonitoring();
      this.reconnectTimer = null;
    }, delay);
  }

  // ä¿®å¤é”€æ¯æ–¹æ³•
  async onModuleDestroy(): Promise<void> {
    // æ¸…ç†é‡è¿å®šæ—¶å™¨
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer);
      this.reconnectTimer = null;
    }

    // æ¸…ç†å†…å­˜ç›‘æ§å®šæ—¶å™¨ï¼ˆå·²å­˜åœ¨ï¼‰
    if (this.memoryCheckTimer) {
      clearInterval(this.memoryCheckTimer);
      this.memoryCheckTimer = null;
    }

    // æ¸…ç† Change Streamï¼ˆå·²å­˜åœ¨ï¼‰
    if (this.changeStream) {
      try {
        await this.changeStream.close();
        this.changeStream = null;
      } catch (error) {
        this.logger.error("å…³é—­ Change Stream å¤±è´¥", { error: error.message });
      }
    }

    // å…¶ä»–æ¸…ç†é€»è¾‘...
  }
}
```

#### **å¯é€‰æ”¹è¿›: ç±»å‹å®‰å…¨**

```typescript
// å¯é€‰ä¿®å¤ - æ”¹å–„ä»£ç è´¨é‡
import { ChangeStream } from 'mongoose';

interface ChangeStreamDocument {
  operationType: string;
  fullDocument?: any;
  documentKey?: { _id: any };
  ns: { coll: string };
}

// å°† any æ”¹ä¸ºå…·ä½“ç±»å‹
private changeStream: ChangeStream<ChangeStreamDocument> | null = null;
```



## ğŸ“ˆ ç»¼åˆå½±å“è¯„ä¼°

### é—®é¢˜ä¼˜å…ˆçº§è¯„ä¼°

| é—®é¢˜ç±»å‹ | ä¼˜å…ˆçº§ | ä¿®å¤å¤æ‚åº¦ | å½±å“èŒƒå›´ |
|----------|--------|----------|----------|
| é‡è¿å®šæ—¶å™¨æ³„æ¼ | **é«˜** | ä½ | é«˜é¢‘é‡è¿åœºæ™¯ |
| ç±»å‹å®‰å…¨é—®é¢˜ | ä½ | ä½ | ä»£ç è´¨é‡ |

### ç®€åŒ–å®æ–½è®¡åˆ’

#### ç«‹å³ä¿®å¤ (2å°æ—¶å†…)
1. **æ·»åŠ å®šæ—¶å™¨å­˜å‚¨**: `private reconnectTimer: NodeJS.Timeout | null = null;`
2. **ä¿®å¤é‡è¿æ–¹æ³•**: åœ¨ `scheduleReconnection()` ä¸­å­˜å‚¨å®šæ—¶å™¨å¼•ç”¨
3. **ä¿®å¤é”€æ¯æ–¹æ³•**: åœ¨ `onModuleDestroy()` ä¸­æ¸…ç†å®šæ—¶å™¨

#### å¯é€‰æ”¹è¿› (1å°æ—¶å†…)
1. **ç±»å‹å®‰å…¨**: å°† `changeStream: any` æ”¹ä¸º `ChangeStream<T>`

## ğŸ¯ é¢„æœŸæ”¶ç›Š

| ä¼˜åŒ–é¡¹ç›® | å½“å‰çŠ¶å†µ | ä¼˜åŒ–åæ•ˆæœ | é¢„æœŸæå‡ | å®æ–½æˆæœ¬ |
|---------|-----------|------------|----------|----------|
| **å†…å­˜ç¨³å®šæ€§** | é‡è¿å®šæ—¶å™¨æ³„æ¼ | å®šæ—¶å™¨æ­£ç¡®æ¸…ç† | ğŸ”’ **+70%** | ä½ |
| **ä»£ç è´¨é‡** | any ç±»å‹ï¼Œç¼ºä¹æ£€æŸ¥ | å¼ºç±»å‹ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥ | ğŸ“ **+30%** | ä½ |

### ğŸ“Š **æ•ˆç›Šåˆ†æ**
- **æ ¸å¿ƒé—®é¢˜è§£å†³**: æ¶ˆé™¤é‡è¿å®šæ—¶å™¨æ³„æ¼é£é™©
- **å®æ–½é£é™©**: ä½ï¼ˆä¿®æ”¹ç®€å•ï¼Œå½±å“èŒƒå›´å°ï¼‰
- **ç»´æŠ¤æˆæœ¬**: å‡ ä¹æ— å¢åŠ ï¼ˆä»£ç æ”¹åŠ¨å°ï¼‰

## ç»“è®º

ç»è¿‡ä»£ç å®¡æŸ¥ï¼Œå‘ç°äº†ä¸€ä¸ªæ ¸å¿ƒçš„å†…å­˜æ³„æ¼é£é™©ï¼š

### ğŸ¯ **æ ¸å¿ƒå‘ç°**

1. **é‡è¿å®šæ—¶å™¨æ³„æ¼** âœ… é«˜é£é™©ç¡®è®¤ - åŸæ–‡æ¡£æœªè¯†åˆ«
2. **ç±»å‹å®‰å…¨é—®é¢˜** âœ… ä½é£é™©ç¡®è®¤ - åŸæ–‡æ¡£å·²è¯†åˆ«

### ğŸ”§ **ç®€å•æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆ**

**æ ¸å¿ƒä¿®å¤** (å¿…é¡»):
- æ·»åŠ  `reconnectTimer` å­˜å‚¨å’Œæ¸…ç†é€»è¾‘
- ä¿®å¤ `scheduleReconnection()` å’Œ `onModuleDestroy()` æ–¹æ³•

**å¯é€‰æ”¹è¿›**:
- å°† `changeStream: any` æ”¹ä¸ºå…·ä½“ç±»å‹

### ğŸ“Š **æ–¹æ¡ˆä¼˜åŠ£å¯¹æ¯”**

| ç»´åº¦ | åŸæ–‡æ¡£æ–¹æ¡ˆ | ç®€åŒ–æ–¹æ¡ˆ |
|------|------------|----------|
| **å¤æ‚åº¦** | ä½ | ä½ |
| **æœ‰æ•ˆæ€§** | ä½ (æœªè§£å†³æ ¸å¿ƒé—®é¢˜) | é«˜ (ç›´æ¥è§£å†³æ ¸å¿ƒé—®é¢˜) |
| **å®æ–½é£é™©** | ä½ | ä½ |
| **æ•ˆæœ** | ~10% æ”¹å–„ | ~70% æ”¹å–„ |

### ğŸ›¡ï¸ **å»ºè®®è¡ŒåŠ¨**

1. **ç«‹å³ä¿®å¤å®šæ—¶å™¨æ³„æ¼** - æ ¸å¿ƒé—®é¢˜ï¼Œä¼˜å…ˆçº§æœ€é«˜
2. **å¯é€‰æ”¹è¿›ç±»å‹å®‰å…¨** - ä»£ç è´¨é‡é—®é¢˜ï¼Œä¼˜å…ˆçº§ä½

**é¢„æœŸæ•´ä½“æ”¶ç›Š**: å†…å­˜ç¨³å®šæ€§æå‡ **70%**ï¼Œå®æ–½æˆæœ¬ **ä½**

---

> **æ–‡æ¡£æ›´æ–°è¯´æ˜**: æœ¬æ–‡æ¡£é‡‡ç”¨äº†ç®€å•ç›´æ¥çš„ä¿®å¤æ–¹æ¡ˆï¼Œä¸“æ³¨äºè§£å†³æ ¸å¿ƒçš„å®šæ—¶å™¨æ³„æ¼é—®é¢˜ï¼Œé¿å…äº†è¿‡åº¦å·¥ç¨‹åŒ–çš„è®¾è®¡ã€‚å»ºè®®ä¼˜å…ˆå®æ–½æ ¸å¿ƒä¿®å¤ï¼Œå†è€ƒè™‘å¯é€‰æ”¹è¿›ã€‚


