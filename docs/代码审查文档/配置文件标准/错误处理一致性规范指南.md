# é”™è¯¯å¤„ç†ä¸€è‡´æ€§è§„èŒƒæŒ‡å—

## ç›®å½•
1. [è§„èŒƒæ¦‚è¿°](#è§„èŒƒæ¦‚è¿°)
2. [ç°çŠ¶åˆ†æ](#ç°çŠ¶åˆ†æ)
3. [æ ¸å¿ƒåŸåˆ™](#æ ¸å¿ƒåŸåˆ™)
4. [é”™è¯¯åˆ†ç±»ä½“ç³»](#é”™è¯¯åˆ†ç±»ä½“ç³»)
5. [é”™è¯¯ç è§„èŒƒ](#é”™è¯¯ç è§„èŒƒ)
6. [å®æ–½æ ‡å‡†](#å®æ–½æ ‡å‡†)
7. [ç»„ä»¶è¿ç§»æŒ‡å—](#ç»„ä»¶è¿ç§»æŒ‡å—)
8. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
9. [æ£€æŸ¥æ¸…å•](#æ£€æŸ¥æ¸…å•)

---

## è§„èŒƒæ¦‚è¿°

### ç›®æ ‡
å»ºç«‹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ ‡å‡†ï¼Œæ¶ˆé™¤ç»„ä»¶é—´é”™è¯¯å¤„ç†ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæå‡ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€å¯è§‚å¯Ÿæ€§å’Œç”¨æˆ·ä½“éªŒã€‚

### é€‚ç”¨èŒƒå›´
- æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ï¼ˆ7å±‚æ¶æ„ï¼‰
- ä¸šåŠ¡æ¨¡å—ï¼ˆAuthã€Notificationã€Monitoringç­‰ï¼‰
- å·¥å…·æœåŠ¡ï¼ˆCacheã€Databaseç­‰ï¼‰

### è§„èŒƒç‰ˆæœ¬
- **ç‰ˆæœ¬**: v1.0
- **ç”Ÿæ•ˆæ—¥æœŸ**: 2025-09-21
- **å®¡æ ¸ä¾æ®**: 10ä¸ªç»„ä»¶ä»£ç å®¡æ ¸æŠ¥å‘Š

---

## ç°çŠ¶åˆ†æ

### ç°æœ‰æŠ€æœ¯åŸºç¡€

#### âœ… GlobalExceptionFilterï¼ˆç³»ç»Ÿæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰
- å¼ºå¤§çš„å¼‚å¸¸è¯†åˆ«å’Œåˆ†ç±»æœºåˆ¶
- å®Œæ•´çš„é”™è¯¯ç ç”Ÿæˆé€»è¾‘
- å¤šè¯­è¨€æ¶ˆæ¯ç¿»è¯‘æ”¯æŒ
- ç›‘æ§äº‹ä»¶è‡ªåŠ¨å‘é€
- æ•æ„Ÿä¿¡æ¯è¿‡æ»¤å’Œå®‰å…¨é˜²æŠ¤

#### âœ… é”™è¯¯å¤„ç†æ¶æ„åŸºç¡€
- åŸºäºNestJSæ ‡å‡†å¼‚å¸¸ä½“ç³»
- ç»Ÿä¸€çš„å“åº”æ ¼å¼å’ŒçŠ¶æ€ç æ˜ å°„
- å®Œå–„çš„æ—¥å¿—è®°å½•å’Œè¿½è¸ªæœºåˆ¶
- ä¸ç›‘æ§ç³»ç»Ÿçš„æ·±åº¦é›†æˆ

#### âš ï¸ Cacheæ¨¡å—ç°çŠ¶
Cacheæ¨¡å—è™½ç„¶æœ‰ç›¸å¯¹å®Œæ•´çš„å¼‚å¸¸ä½“ç³»ï¼Œä½†**åŒæ ·å­˜åœ¨ç‹¬ç«‹å®ç°çš„é—®é¢˜**ï¼š
- è‡ªå®šä¹‰å¼‚å¸¸ç±»ï¼ˆCacheExceptionã€CacheConnectionExceptionç­‰ï¼‰
- ç‹¬ç«‹çš„å¼‚å¸¸å·¥å‚ï¼ˆCacheExceptionFactoryï¼‰
- ä¸å…¶ä»–ç»„ä»¶ä¸ä¸€è‡´çš„é”™è¯¯å¤„ç†æ¨¡å¼

**éœ€è¦è¿ç§»**ï¼šCacheæ¨¡å—ä¹Ÿåº”å½“è¿ç§»åˆ°ç»Ÿä¸€çš„ `@common` é”™è¯¯å¤„ç†ä½“ç³»ä¸­ã€‚

### ä¸»è¦é—®é¢˜æ±‡æ€»

| ç»„ä»¶ | ä¸»è¦é—®é¢˜ | å½±å“ç¨‹åº¦ |
|------|----------|----------|
| **Query** | 22å¤„`throw new Error`ï¼Œç¼ºä¹ç»“æ„åŒ–é”™è¯¯åˆ†ç±» | ğŸ”´ ä¸¥é‡ |
| **Cache** | ç‹¬ç«‹å¼‚å¸¸ä½“ç³»ï¼Œä¸ç»Ÿä¸€æ ‡å‡†ä¸ä¸€è‡´ | ğŸ”´ ä¸¥é‡ |
| **Common-cache** | ç­–ç•¥æ··åˆï¼šæŠ›å¼‚å¸¸vsè¿”å›null vsè¿”å›é”™è¯¯å¯¹è±¡ | ğŸ”´ ä¸¥é‡ |
| **Stream-receiver** | ä¸­è‹±æ–‡æ··ç”¨ï¼š`"è®¢é˜…å¤„ç†å¤±è´¥"` vs `"AuthenticationError"` | ğŸŸ¡ ä¸­ç­‰ |
| **Receiver** | è¿‡åº¦ä½¿ç”¨`BadRequestException`/`NotFoundException` | ğŸŸ¡ ä¸­ç­‰ |
| **Symbol-mapper** | ç¼ºä¹ç»Ÿä¸€é”™è¯¯ç ä½“ç³»å’Œå›½é™…åŒ–æ”¯æŒ | ğŸŸ¡ ä¸­ç­‰ |
| **Shared** | å¯¹ä¸´æ—¶æ€§é”™è¯¯ç›´æ¥é™çº§ï¼Œæœªå®ç°é‡è¯• | ğŸŸ¡ ä¸­ç­‰ |
| **Storage** | é‡è¯•æœºåˆ¶ç¼ºå¤± | ğŸŸ¡ ä¸­ç­‰ |

---

## æ ¸å¿ƒåŸåˆ™

### 1. ç»Ÿä¸€é”™è¯¯ç­–ç•¥
- **å…³é”®è·¯å¾„**ï¼šå¿…é¡»æŠ›å‡ºå¼‚å¸¸ï¼Œä¸å…è®¸é™é»˜å¤±è´¥
- **éå…³é”®åŠŸèƒ½**ï¼šå¯é™çº§å¤„ç†ï¼Œè¿”å›é»˜è®¤å€¼å¹¶è®°å½•æ—¥å¿—
- **é…ç½®éªŒè¯**ï¼šå§‹ç»ˆæŠ›å‡ºå¼‚å¸¸ï¼Œå¿«é€Ÿå¤±è´¥åŸåˆ™

### 2. é”™è¯¯åˆ†ç±»ä¸€è‡´æ€§
- ä½¿ç”¨æ ‡å‡†åŒ–çš„é”™è¯¯åˆ†ç±»ä½“ç³»
- æ¯ä¸ªç»„ä»¶å»ºç«‹è‡ªå·±çš„å¼‚å¸¸ç±»å±‚æ¬¡
- ç»§æ‰¿è‡ªNestJSæ ‡å‡†å¼‚å¸¸ç±»

### 3. é”™è¯¯ä¿¡æ¯æ ‡å‡†åŒ–
- ä½¿ç”¨è‹±æ–‡é”™è¯¯æ¶ˆæ¯ï¼ˆé¢å‘å¼€å‘è€…ï¼‰
- æä¾›ç»“æ„åŒ–çš„é”™è¯¯ä¸Šä¸‹æ–‡
- ä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯ç”¨äºè°ƒè¯•

### 4. å¯æ¢å¤æ€§è®¾è®¡
- åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•é”™è¯¯
- æä¾›é”™è¯¯æ¢å¤å»ºè®®
- å®ç°æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶

---

## é”™è¯¯åˆ†ç±»ä½“ç³»

### å››å±‚åˆ†ç±»ç»“æ„

```
{COMPONENT}_{CATEGORY}_{SEQUENCE}
â”œâ”€â”€ VALIDATION (éªŒè¯ç±»é”™è¯¯)
â”‚   â”œâ”€â”€ 001-099: å‚æ•°éªŒè¯
â”‚   â”œâ”€â”€ 100-199: æ•°æ®æ ¼å¼éªŒè¯
â”‚   â””â”€â”€ 200-299: ä¸šåŠ¡è§„åˆ™éªŒè¯
â”œâ”€â”€ BUSINESS (ä¸šåŠ¡é€»è¾‘é”™è¯¯)
â”‚   â”œâ”€â”€ 300-399: ä¸šåŠ¡æµç¨‹é”™è¯¯
â”‚   â”œâ”€â”€ 400-499: çŠ¶æ€å†²çªé”™è¯¯
â”‚   â””â”€â”€ 500-599: èµ„æºä¸å­˜åœ¨é”™è¯¯
â”œâ”€â”€ SYSTEM (ç³»ç»Ÿèµ„æºé”™è¯¯)
â”‚   â”œâ”€â”€ 600-699: å†…å­˜/CPUèµ„æº
â”‚   â”œâ”€â”€ 700-799: è¶…æ—¶é”™è¯¯
â”‚   â””â”€â”€ 800-899: é…ç½®é”™è¯¯
â””â”€â”€ EXTERNAL (å¤–éƒ¨ä¾èµ–é”™è¯¯)
    â”œâ”€â”€ 900-949: æ•°æ®åº“é”™è¯¯
    â”œâ”€â”€ 950-979: ç¬¬ä¸‰æ–¹APIé”™è¯¯
    â””â”€â”€ 980-999: ç½‘ç»œé”™è¯¯
```

### HTTPçŠ¶æ€ç æ˜ å°„

| é”™è¯¯ç±»åˆ« | HTTPçŠ¶æ€ç  | NestJSå¼‚å¸¸ç±» |
|----------|------------|--------------|
| VALIDATION | 400 | BadRequestException |
| BUSINESS | 400/404/409 | BadRequestException/NotFoundException/ConflictException |
| SYSTEM | 500/503/408 | InternalServerErrorException/ServiceUnavailableException/RequestTimeoutException |
| EXTERNAL | 502/503/504 | BadGatewayException/ServiceUnavailableException/GatewayTimeoutException |

---

## é”™è¯¯ç è§„èŒƒ

### å‘½åè§„åˆ™
- **æ ¼å¼**: `{COMPONENT}_{CATEGORY}_{SEQUENCE}`
- **ç»„ä»¶ä»£ç **:
  - ALERT: è­¦å‘ŠæœåŠ¡
  - AUTH: è®¤è¯æœåŠ¡
  - CACHEï¼šç¼“å­˜å™¨æœåŠ¡
  - MONITORINGï¼šç›‘æ§æœåŠ¡
  - NOTIFICATIONï¼šé€šçŸ¥æœåŠ¡
  
  - SYMBOL-MAPPER : ç¬¦å·æ˜ å°„è§„åˆ™ç»„ä»¶
  - DATA-MAPPER : æ•°æ®æ˜ å°„å™¨è§„åˆ™ç»„ä»¶

  - QUERY: æ…¢æ—¶æ•ˆæŸ¥è¯¢ç»„ä»¶
  - RECEIVER: å¿«æ—¶æ•ˆæŸ¥è¯¢ç»„ä»¶
  - STREAM_RECEIVER: æµæ•°æ®æŸ¥è¯¢ç»„ä»¶

  - DATA-FETCHER: SDK-REST æ•°æ®è·å–ç»„ä»¶
  - STREAM-DATA-FETCHE: SDK-STREAM æ•°æ®è·å–ç»„ä»¶

  - TRANSFORMER: æ•°æ®æ˜ å°„å™¨è§„åˆ™æ‰§è¡Œå™¨
  - SYMBOL-TRANSFORMER: ç¬¦å·æ˜ å°„è§„åˆ™æ‰§è¡Œå™¨

  - SMART-CACHE: æ™ºèƒ½ç¼“å­˜å¯¼ç»„ä»¶
  - COMMON-CACHE: é€šç”¨ç¼“å­˜ç»„ä»¶
  - SYMBOL-MAPPER-CACHE: ç¬¦å·æ˜ å°„è§„åˆ™ä¸“ç”¨ç¼“å­˜å™¨
  - DATA-MAPPER-CACHE: æ•°æ®æ˜ å°„å™¨è§„åˆ™ä¸“ç”¨ç¼“å­˜å™¨
  - STREAM-CACHE: æµæ•°æ®ä¸“ç”¨ç¼“å­˜å™¨

  - STORAGE: å­˜å‚¨æœåŠ¡
  - SHARED: å…±äº«ç»„ä»¶

### ç¤ºä¾‹é”™è¯¯ç 

```typescript
export enum QueryErrorCode {
  // éªŒè¯ç±»é”™è¯¯
  VALIDATION_FAILED = 'QUERY_VALIDATION_001',
  INVALID_SYMBOLS = 'QUERY_VALIDATION_002',
  MISSING_REQUIRED_PARAMS = 'QUERY_VALIDATION_003',

  // ä¸šåŠ¡é€»è¾‘é”™è¯¯
  UNSUPPORTED_QUERY_TYPE = 'QUERY_BUSINESS_300',
  QUERY_RESULT_EMPTY = 'QUERY_BUSINESS_301',

  // ç³»ç»Ÿèµ„æºé”™è¯¯
  MEMORY_PRESSURE = 'QUERY_SYSTEM_600',
  TIMEOUT_ERROR = 'QUERY_SYSTEM_700',

  // å¤–éƒ¨ä¾èµ–é”™è¯¯
  PROVIDER_UNAVAILABLE = 'QUERY_EXTERNAL_950',
  CACHE_SERVICE_ERROR = 'QUERY_EXTERNAL_900',
}
```

---

## å®æ–½æ ‡å‡†

### 1. åŸºäºç°æœ‰æ¶æ„çš„é€šç”¨æ–¹æ¡ˆ

ç³»ç»Ÿå·²æœ‰å¼ºå¤§çš„ `GlobalExceptionFilter` å’Œé”™è¯¯å¤„ç†åŸºç¡€è®¾æ–½ï¼Œæˆ‘ä»¬åªéœ€åœ¨ `@common` æ¨¡å—ä¸­æ‰©å±•ç°æœ‰åŠŸèƒ½ï¼š

```typescript
// @common/core/exceptions/business-exception.ts
// é€šç”¨ä¸šåŠ¡å¼‚å¸¸åŸºç±»ï¼Œå¤ç”¨ç°æœ‰ HttpException ä½“ç³»
export class BusinessException extends HttpException {
  public readonly errorCode: string;
  public readonly operation: string;
  public readonly context?: any;
  public readonly retryable: boolean;
  public readonly component: string;

  constructor(
    errorCode: string,
    message: string,
    status: HttpStatus,
    operation: string,
    component: string,
    context?: any,
    retryable: boolean = false,
    public readonly originalError?: Error
  ) {
    super(message, status);
    this.errorCode = errorCode;
    this.operation = operation;
    this.component = component;
    this.context = context;
    this.retryable = retryable;
  }

  // é”™è¯¯æ¢å¤å»ºè®®
  getRecoveryAction(): 'retry' | 'fallback' | 'abort' {
    if (this.retryable) return 'retry';
    if (this.errorCode.includes('EXTERNAL')) return 'fallback';
    return 'abort';
  }
}
```

### 2. é€šç”¨å¼‚å¸¸å·¥å‚

```typescript
// @common/core/exceptions/exception-factory.ts
// é€šç”¨å¼‚å¸¸å·¥å‚ï¼Œé¿å…æ¯ä¸ªç»„ä»¶é‡å¤å®ç°
export class UniversalExceptionFactory {
  static createBusinessException(
    component: string,
    errorCode: string,
    operation: string,
    message: string,
    context?: any,
    retryable: boolean = false
  ): BusinessException {
    const status = this.getStatusFromErrorCode(errorCode);
    return new BusinessException(
      errorCode,
      message,
      status,
      operation,
      component,
      context,
      retryable
    );
  }

  static createFromError(
    component: string,
    operation: string,
    error: Error,
    context?: any
  ): BusinessException {
    // æ™ºèƒ½é”™è¯¯åˆ†ç±»ï¼ŒåŸºäºç°æœ‰GlobalExceptionFilteré€»è¾‘
    const errorCode = this.classifyError(component, error);
    const status = this.getStatusFromErrorCode(errorCode);
    const retryable = this.isRetryableError(error);

    return new BusinessException(
      errorCode,
      error.message,
      status,
      operation,
      component,
      context,
      retryable,
      error
    );
  }

  private static getStatusFromErrorCode(errorCode: string): HttpStatus {
    if (errorCode.includes('VALIDATION')) return HttpStatus.BAD_REQUEST;
    if (errorCode.includes('BUSINESS')) return HttpStatus.BAD_REQUEST;
    if (errorCode.includes('SYSTEM')) return HttpStatus.INTERNAL_SERVER_ERROR;
    if (errorCode.includes('EXTERNAL')) return HttpStatus.SERVICE_UNAVAILABLE;
    return HttpStatus.INTERNAL_SERVER_ERROR;
  }

  private static classifyError(component: string, error: Error): string {
    const upperComponent = component.toUpperCase();

    if (error.message.includes('timeout')) {
      return `${upperComponent}_SYSTEM_700`;
    }
    if (error.message.includes('validation') || error.message.includes('invalid')) {
      return `${upperComponent}_VALIDATION_001`;
    }
    if (error.message.includes('connection') || error.message.includes('unavailable')) {
      return `${upperComponent}_EXTERNAL_900`;
    }

    return `${upperComponent}_SYSTEM_800`;
  }

  private static isRetryableError(error: Error): boolean {
    const retryableKeywords = ['timeout', 'connection', 'unavailable', 'network'];
    return retryableKeywords.some(keyword =>
      error.message.toLowerCase().includes(keyword)
    );
  }
}
```

### 3. é”™è¯¯å¤„ç†ç­–ç•¥æ ‡å‡†

```typescript
// ç»Ÿä¸€é”™è¯¯å¤„ç†ç­–ç•¥
export enum ErrorHandlingStrategy {
  THROW = 'throw',           // æŠ›å‡ºå¼‚å¸¸
  SILENT = 'silent',         // é™é»˜å¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼
  METADATA = 'metadata'      // è¿”å›åŒ…å«é”™è¯¯ä¿¡æ¯çš„ç»“æœå¯¹è±¡
}

// é”™è¯¯å¤„ç†é…ç½®
interface ErrorHandlingConfig {
  strategy: ErrorHandlingStrategy;
  defaultValue?: any;
  retryConfig?: RetryConfig;
  fallbackAction?: () => any;
}
```

### 4. é‡è¯•æœºåˆ¶æ ‡å‡†

```typescript
// é‡è¯•é…ç½®æ¥å£
interface RetryConfig {
  maxAttempts: number;
  baseDelayMs: number;
  maxDelayMs: number;
  backoffMultiplier: number;
  retryableErrors: string[]; // å¯é‡è¯•çš„é”™è¯¯ç 
}

// æŒ‡æ•°é€€é¿é‡è¯•å®ç°
export class RetryHandler {
  static async executeWithRetry<T>(
    operation: () => Promise<T>,
    config: RetryConfig,
    operationName: string
  ): Promise<T> {
    // é‡è¯•é€»è¾‘å®ç°
  }
}
```

---

## ç»„ä»¶è¿ç§»æŒ‡å—

### ä¼˜å…ˆçº§è¯„çº§

| ä¼˜å…ˆçº§ | ç»„ä»¶ | ç†ç”± | é¢„ä¼°å·¥æœŸ |
|--------|------|------|----------|
| ğŸ”´ P0 | Query | 22å¤„é”™è¯¯å¤„ç†éœ€æ ‡å‡†åŒ–ï¼Œå½±å“æœ€å¤§ | 2å¤© |
| ğŸ”´ P0 | Cache | è¿ç§»ç°æœ‰ç‹¬ç«‹å¼‚å¸¸ä½“ç³»åˆ°é€šç”¨æ ‡å‡† | 1.5å¤© |
| ğŸ”´ P0 | Common-cache | ç­–ç•¥ä¸ç»Ÿä¸€ï¼Œç³»ç»Ÿç¨³å®šæ€§é£é™© | 1å¤© |
| ğŸŸ¡ P1 | Stream-receiver | ä¸­è‹±æ–‡æ··ç”¨ï¼Œç”¨æˆ·ä½“éªŒå½±å“ | 1å¤© |
| ğŸŸ¡ P1 | Receiver | å¼‚å¸¸ç±»å‹è¿‡äºé€šç”¨ | 1å¤© |
| ğŸŸ¢ P2 | Symbol-mapper | åŠŸèƒ½ç›¸å¯¹ç‹¬ç«‹ | 1å¤© |
| ğŸŸ¢ P2 | Storage | é‡è¯•æœºåˆ¶è¡¥å…… | 0.5å¤© |
| ğŸŸ¢ P2 | Shared | é™çº§é€»è¾‘å®Œå–„ | 0.5å¤© |

### è¿ç§»æ­¥éª¤

#### ç¬¬ä¸€é˜¶æ®µï¼šåœ¨ @common ä¸­å»ºç«‹é€šç”¨åŸºç¡€è®¾æ–½

1. **åˆ›å»ºé€šç”¨å¼‚å¸¸åŸºç±»**
   ```bash
   src/common/core/exceptions/
   â”œâ”€â”€ business-exception.ts          # é€šç”¨ä¸šåŠ¡å¼‚å¸¸åŸºç±»
   â”œâ”€â”€ exception-factory.ts          # é€šç”¨å¼‚å¸¸å·¥å‚
   â”œâ”€â”€ retry-handler.ts              # é€šç”¨é‡è¯•æœºåˆ¶
   â””â”€â”€ index.ts                      # ç»Ÿä¸€å¯¼å‡º
   ```

2. **æ‰©å±•å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨**
   - åœ¨ç°æœ‰ `GlobalExceptionFilter` ä¸­æ·»åŠ  `BusinessException` è¯†åˆ«
   - å¤ç”¨ç°æœ‰çš„é”™è¯¯ç ç”Ÿæˆå’Œæ¶ˆæ¯ç¿»è¯‘é€»è¾‘

#### ç¬¬äºŒé˜¶æ®µï¼šç»„ä»¶æ¥å…¥ï¼ˆæ¯ä¸ªç»„ä»¶åªéœ€æœ€å°‘ä»£ç ï¼‰

å„ç»„ä»¶åªéœ€è¦ä¸¤ä¸ªæ–‡ä»¶ï¼š

1. **é”™è¯¯ç å¸¸é‡å®šä¹‰**ï¼ˆå”¯ä¸€éœ€è¦çš„ç»„ä»¶ç‰¹å®šä»£ç ï¼‰
   ```bash
   src/{component}/constants/{component}-error-codes.constants.ts
   ```

2. **ç»„ä»¶é”™è¯¯å¤„ç†å·¥å…·**ï¼ˆå¯é€‰ï¼Œç®€åŒ–è°ƒç”¨ï¼‰
   ```bash
   src/{component}/utils/{component}-error.utils.ts
   ```

#### ç¬¬ä¸‰é˜¶æ®µï¼šæ›¿æ¢ç°æœ‰é”™è¯¯å¤„ç†
1. **å¯¼å…¥é€šç”¨å·¥å‚**: `import { UniversalExceptionFactory } from '@common/core/exceptions'`
2. **æ›¿æ¢throwè¯­å¥**: ä½¿ç”¨ç»Ÿä¸€çš„å·¥å‚æ–¹æ³•
3. **è‡ªåŠ¨è·å¾—é‡è¯•æœºåˆ¶**: é€šè¿‡å·¥å‚è‡ªåŠ¨åˆ¤æ–­å¯é‡è¯•æ€§

---

## ä»£ç ç¤ºä¾‹

### 1. åŸºäº @common çš„ç®€åŒ–ç»„ä»¶æ”¹é€ 

#### Queryç»„ä»¶ï¼šåªéœ€è¦å®šä¹‰é”™è¯¯ç 

```typescript
// src/core/01-entry/query/constants/query-error-codes.constants.ts
// ğŸ¯ ç»„ä»¶å”¯ä¸€éœ€è¦çš„ç‰¹å®šä»£ç 
export const QUERY_ERROR_CODES = {
  // éªŒè¯ç±»é”™è¯¯
  MISSING_REQUIRED_PARAMS: 'QUERY_VALIDATION_001',
  INVALID_SYMBOLS: 'QUERY_VALIDATION_002',
  SYMBOLS_LIMIT_EXCEEDED: 'QUERY_VALIDATION_003',

  // ä¸šåŠ¡é€»è¾‘é”™è¯¯
  UNSUPPORTED_QUERY_TYPE: 'QUERY_BUSINESS_300',
  QUERY_RESULT_EMPTY: 'QUERY_BUSINESS_301',

  // ç³»ç»Ÿèµ„æºé”™è¯¯
  MEMORY_PRESSURE: 'QUERY_SYSTEM_600',
  TIMEOUT_ERROR: 'QUERY_SYSTEM_700',

  // å¤–éƒ¨ä¾èµ–é”™è¯¯
  PROVIDER_UNAVAILABLE: 'QUERY_EXTERNAL_950',
  CACHE_SERVICE_ERROR: 'QUERY_EXTERNAL_900',
} as const;
```

#### æ”¹é€ å‰
```typescript
// âŒ ç°æœ‰é—®é¢˜ä»£ç 
if (!symbols || symbols.length === 0) {
  throw new Error('symbolså‚æ•°ä¸èƒ½ä¸ºç©º');
}

if (symbolCount > 10000) {
  throw new Error('symbolsæ•°é‡ä¸èƒ½è¶…è¿‡10000');
}
```

#### æ”¹é€ å
```typescript
// âœ… ä½¿ç”¨é€šç”¨å·¥å‚çš„æ ‡å‡†åŒ–ä»£ç 
import { UniversalExceptionFactory } from '@common/core/exceptions';
import { QUERY_ERROR_CODES } from '../constants/query-error-codes.constants';

if (!symbols || symbols.length === 0) {
  throw UniversalExceptionFactory.createBusinessException(
    'query',
    QUERY_ERROR_CODES.MISSING_REQUIRED_PARAMS,
    'validateSymbols',
    'Symbols parameter cannot be empty',
    { symbols }
  );
}

if (symbolCount > QUERY_LIMITS.MAX_SYMBOLS) {
  throw UniversalExceptionFactory.createBusinessException(
    'query',
    QUERY_ERROR_CODES.SYMBOLS_LIMIT_EXCEEDED,
    'validateSymbols',
    `Symbols count cannot exceed ${QUERY_LIMITS.MAX_SYMBOLS}`,
    { symbolCount, limit: QUERY_LIMITS.MAX_SYMBOLS }
  );
}
```

### 2. ä½¿ç”¨é€šç”¨é‡è¯•æœºåˆ¶ï¼ˆè‡ªåŠ¨åˆ¤æ–­å¯é‡è¯•æ€§ï¼‰

```typescript
// âœ… ä½¿ç”¨é€šç”¨é‡è¯•å¤„ç†å™¨ï¼Œè‡ªåŠ¨è·å¾—é‡è¯•èƒ½åŠ›
import { UniversalRetryHandler } from '@common/core/exceptions';

export class QueryService {
  async executeQuery(request: QueryRequestDto): Promise<QueryResponseDto> {
    try {
      return await UniversalRetryHandler.executeWithRetry(
        () => this.performQuery(request),
        'query',        // ç»„ä»¶å
        'executeQuery', // æ“ä½œå
        { request }     // ä¸Šä¸‹æ–‡
      );
    } catch (error) {
      // é€šç”¨å·¥å‚ä¼šè‡ªåŠ¨åˆ¤æ–­é”™è¯¯ç±»å‹å’Œå¯é‡è¯•æ€§
      if (error instanceof BusinessException) {
        const action = error.getRecoveryAction();

        if (action === 'fallback') {
          return this.getFallbackResult(request);
        }
      }

      // é€šç”¨å·¥å‚åŒ…è£…æœªçŸ¥é”™è¯¯
      throw UniversalExceptionFactory.createFromError(
        'query',
        'executeQuery',
        error as Error,
        { request }
      );
    }
  }
}
```

### 3. ç®€åŒ–çš„ç»„ä»¶é”™è¯¯å¤„ç†å·¥å…·ï¼ˆå¯é€‰ï¼‰

```typescript
// src/core/01-entry/query/utils/query-error.utils.ts
// ğŸ¯ å¯é€‰ï¼šä¸ºç»„ä»¶æä¾›ä¾¿æ·æ–¹æ³•ï¼Œå‡å°‘é‡å¤ä»£ç 
import { UniversalExceptionFactory } from '@common/core/exceptions';
import { QUERY_ERROR_CODES } from '../constants/query-error-codes.constants';

export class QueryErrorUtils {
  static throwValidationError(
    operation: string,
    errorCode: keyof typeof QUERY_ERROR_CODES,
    message: string,
    context?: any
  ) {
    throw UniversalExceptionFactory.createBusinessException(
      'query',
      QUERY_ERROR_CODES[errorCode],
      operation,
      message,
      context
    );
  }

  static throwSystemError(
    operation: string,
    errorCode: keyof typeof QUERY_ERROR_CODES,
    message: string,
    context?: any,
    retryable = true
  ) {
    throw UniversalExceptionFactory.createBusinessException(
      'query',
      QUERY_ERROR_CODES[errorCode],
      operation,
      message,
      context,
      retryable
    );
  }
}

// ä½¿ç”¨ç¤ºä¾‹
// QueryErrorUtils.throwValidationError(
//   'validateSymbols',
//   'MISSING_REQUIRED_PARAMS',
//   'Symbols parameter cannot be empty',
//   { symbols }
// );
```

### 4. Cacheæ¨¡å—è¿ç§»ï¼ˆä»ç‹¬ç«‹å¼‚å¸¸ä½“ç³»åˆ°é€šç”¨æ ‡å‡†ï¼‰

#### æ”¹é€ å‰
```typescript
// âŒ ç‹¬ç«‹çš„å¼‚å¸¸ä½“ç³»
import {
  CacheConnectionException,
  CacheOperationException,
  CacheSerializationException,
  CacheExceptionFactory
} from '../exceptions';

// åˆ†æ•£çš„å¼‚å¸¸åˆ›å»º
throw new CacheConnectionException('set', cacheKey, originalError);
throw CacheExceptionFactory.fromError('get', error, cacheKey);
```

#### æ”¹é€ å
```typescript
// âœ… ä½¿ç”¨é€šç”¨å¼‚å¸¸ä½“ç³»
import { UniversalExceptionFactory } from '@common/core/exceptions';
import { CACHE_ERROR_CODES } from '../constants/cache-error-codes.constants';

// ç»Ÿä¸€çš„å¼‚å¸¸åˆ›å»º
throw UniversalExceptionFactory.createBusinessException(
  'cache',
  CACHE_ERROR_CODES.CONNECTION_FAILED,
  'set',
  'Cache connection failed',
  { cacheKey },
  true  // è¿æ¥é”™è¯¯å¯é‡è¯•
);

// æ™ºèƒ½é”™è¯¯åŒ…è£…ï¼ˆè‡ªåŠ¨åˆ†ç±»å’Œé‡è¯•åˆ¤æ–­ï¼‰
throw UniversalExceptionFactory.createFromError(
  'cache',
  'get',
  error,
  { cacheKey }
);
```

#### Cacheé”™è¯¯ç å®šä¹‰
```typescript
// src/cache/constants/cache-error-codes.constants.ts
export const CACHE_ERROR_CODES = {
  // è¿æ¥ç±»é”™è¯¯
  CONNECTION_FAILED: 'CACHE_EXTERNAL_900',
  CONNECTION_TIMEOUT: 'CACHE_EXTERNAL_901',

  // æ“ä½œç±»é”™è¯¯
  OPERATION_FAILED: 'CACHE_SYSTEM_800',
  OPERATION_TIMEOUT: 'CACHE_SYSTEM_700',

  // åºåˆ—åŒ–é”™è¯¯
  SERIALIZATION_FAILED: 'CACHE_VALIDATION_100',
  DESERIALIZATION_FAILED: 'CACHE_VALIDATION_101',

  // éªŒè¯é”™è¯¯
  INVALID_KEY: 'CACHE_VALIDATION_001',
  INVALID_VALUE: 'CACHE_VALIDATION_002',
} as const;
```

### 5. Stream-receiverè¯­è¨€æ ‡å‡†åŒ–

#### æ”¹é€ å‰
```typescript
// âŒ ä¸­è‹±æ–‡æ··ç”¨
client.emit("subscribe-error", {
  message: error.message || "è®¢é˜…å¤„ç†å¤±è´¥",  // ä¸­æ–‡
});

const authError = new Error("è¿æ¥è®¤è¯å¤±è´¥");  // ä¸­æ–‡
authError.name = "AuthenticationError";     // è‹±æ–‡
```

#### æ”¹é€ å
```typescript
// âœ… ä½¿ç”¨é€šç”¨å·¥å‚ï¼Œè‡ªåŠ¨è·å¾—æ ‡å‡†åŒ–æ ¼å¼
import { UniversalExceptionFactory } from '@common/core/exceptions';
import { STREAM_ERROR_CODES } from '../constants/stream-error-codes.constants';

// ç»Ÿä¸€çš„é”™è¯¯å‘é€æ ¼å¼ï¼ˆå¤ç”¨GlobalExceptionFilterçš„é€»è¾‘ï¼‰
const businessError = UniversalExceptionFactory.createBusinessException(
  'stream_receiver',
  STREAM_ERROR_CODES.SUBSCRIPTION_FAILED,
  'handleSubscription',
  'Subscription processing failed',
  { clientId, error: error.message }
);

client.emit("subscribe-error", {
  code: businessError.errorCode,
  message: businessError.message,
  timestamp: Date.now(),
  details: businessError.context
});

// è®¤è¯é”™è¯¯
throw UniversalExceptionFactory.createBusinessException(
  'stream_receiver',
  STREAM_ERROR_CODES.AUTH_FAILED,
  'authenticateConnection',
  'Connection authentication failed',
  { clientId }
);
```

---

## æ£€æŸ¥æ¸…å•

### é€šç”¨åŸºç¡€è®¾æ–½æ£€æŸ¥ï¼ˆ@common æ¨¡å—ï¼‰

#### âœ… é€šç”¨å¼‚å¸¸åŸºç¡€è®¾æ–½
- [ ] `BusinessException` åŸºç±»å·²åˆ›å»º
- [ ] `UniversalExceptionFactory` å·¥å‚å·²å®ç°
- [ ] `UniversalRetryHandler` é‡è¯•æœºåˆ¶å·²å®ç°
- [ ] `GlobalExceptionFilter` å·²æ‰©å±•æ”¯æŒ `BusinessException`

#### âœ… é›†æˆéªŒè¯
- [ ] é”™è¯¯ç è‡ªåŠ¨ç”Ÿæˆé€»è¾‘æ­£å¸¸
- [ ] é‡è¯•æœºåˆ¶è‡ªåŠ¨åˆ¤æ–­å¯é‡è¯•æ€§
- [ ] ç›‘æ§äº‹ä»¶è‡ªåŠ¨å‘é€ï¼ˆå¤ç”¨ç°æœ‰ `SYSTEM_STATUS_EVENTS`ï¼‰
- [ ] æ¶ˆæ¯ç¿»è¯‘æœºåˆ¶æ­£å¸¸å·¥ä½œ

### ç»„ä»¶è¿ç§»æ£€æŸ¥ï¼ˆæç®€åŒ–ï¼‰

#### âœ… ç»„ä»¶ç‰¹å®šä»£ç ï¼ˆæ¯ä¸ªç»„ä»¶åªéœ€æ£€æŸ¥è¿™äº›ï¼‰
- [ ] é”™è¯¯ç å¸¸é‡å·²å®šä¹‰ (`{component}-error-codes.constants.ts`)
- [ ] æ‰€æœ‰ `throw new Error` å·²æ›¿æ¢ä¸º `UniversalExceptionFactory` è°ƒç”¨
- [ ] é”™è¯¯æ¶ˆæ¯ç»Ÿä¸€ä½¿ç”¨è‹±æ–‡
- [ ] ä¸Šä¸‹æ–‡ä¿¡æ¯å®Œæ•´ä¼ é€’

#### âœ… è‡ªåŠ¨è·å¾—çš„èƒ½åŠ›ï¼ˆæ— éœ€é¢å¤–å®ç°ï¼‰
- [x] é‡è¯•æœºåˆ¶ï¼ˆå·¥å‚è‡ªåŠ¨åˆ¤æ–­ï¼‰
- [x] é”™è¯¯åˆ†ç±»ï¼ˆå·¥å‚è‡ªåŠ¨è¯†åˆ«ï¼‰
- [x] HTTPçŠ¶æ€ç æ˜ å°„ï¼ˆå·¥å‚è‡ªåŠ¨å¤„ç†ï¼‰
- [x] ç›‘æ§é›†æˆï¼ˆGlobalExceptionFilterè‡ªåŠ¨å¤„ç†ï¼‰
- [x] é”™è¯¯ç ç”Ÿæˆï¼ˆGlobalExceptionFilterè‡ªåŠ¨å¤„ç†ï¼‰

### å•ä¸ªç»„ä»¶æ£€æŸ¥æ¨¡æ¿ï¼ˆç®€åŒ–ç‰ˆï¼‰

```typescript
// æ£€æŸ¥æ¸…å• - {ç»„ä»¶å}ç»„ä»¶ (ç®€åŒ–ç‰ˆ)
export const {COMPONENT}_ERROR_HANDLING_CHECKLIST = {
  // ğŸ¯ ç»„ä»¶ç‰¹å®šä»£ç  (å”¯ä¸€éœ€è¦å®ç°çš„)
  errorCodesConstants: 'âœ… å·²å®šä¹‰', // âŒ å¾…å®šä¹‰
  throwErrorReplacement: '85%',     // æ›¿æ¢è¿›åº¦
  messageLanguage: 'âœ… ç»Ÿä¸€è‹±æ–‡',   // âŒ ä¸­è‹±æ··ç”¨

  // âœ… è‡ªåŠ¨è·å¾—çš„èƒ½åŠ› (æ— éœ€å®ç°)
  retryMechanism: 'âœ… è‡ªåŠ¨è·å¾—',    // é€šè¿‡ UniversalExceptionFactory
  errorClassification: 'âœ… è‡ªåŠ¨è·å¾—', // é€šè¿‡å·¥å‚æ™ºèƒ½åˆ†ç±»
  monitoringIntegration: 'âœ… è‡ªåŠ¨è·å¾—', // é€šè¿‡ GlobalExceptionFilter
  statusCodeMapping: 'âœ… è‡ªåŠ¨è·å¾—',  // é€šè¿‡å·¥å‚é€»è¾‘

  // ğŸ“Š ç»Ÿè®¡æ•°æ®
  codeReduction: '90%',             // ç›¸æ¯”åŸæ–¹æ¡ˆå‡å°‘çš„ä»£ç é‡
  migrationEffort: '1-2å¤©',         // è¿ç§»å·¥ä½œé‡
};
```

### å…³é”®ä¼˜åŠ¿å¯¹æ¯”

| ç»´åº¦ | åŸæ–¹æ¡ˆï¼ˆæ¯ç»„ä»¶ç‹¬ç«‹ï¼‰ | æ–°æ–¹æ¡ˆï¼ˆåŸºäº@commonï¼‰ |
|------|---------------------|---------------------|
| **ä»£ç é‡å¤** | ä¸¥é‡ï¼ˆæ¯ç»„ä»¶é‡å¤å¼‚å¸¸ä½“ç³»ï¼‰ | å‡ ä¹æ— é‡å¤ |
| **ç»´æŠ¤æˆæœ¬** | é«˜ï¼ˆ10ä¸ªç»„ä»¶ Ã— å¤šä¸ªæ–‡ä»¶ï¼‰ | ä½ï¼ˆä»…éœ€ç»´æŠ¤@commonåŸºç¡€è®¾æ–½ï¼‰ |
| **å®æ–½å·¥ä½œé‡** | é«˜ï¼ˆæ¯ç»„ä»¶2-5å¤©ï¼‰ | ä½ï¼ˆæ¯ç»„ä»¶1-2å¤©ï¼‰ |
| **ä¸€è‡´æ€§ä¿è¯** | éš¾ï¼ˆäººå·¥ç»´æŠ¤ä¸€è‡´æ€§ï¼‰ | å¼ºï¼ˆè‡ªåŠ¨ä¿è¯ä¸€è‡´æ€§ï¼‰ |
| **åŠŸèƒ½å®Œæ•´æ€§** | å–å†³äºå®æ–½è´¨é‡ | ç»Ÿä¸€çš„é«˜è´¨é‡å®ç° |

---

## å®æ–½è®¡åˆ’ï¼ˆåŸºäº@commonçš„ç®€åŒ–æ–¹æ¡ˆï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼šå»ºç«‹é€šç”¨åŸºç¡€è®¾æ–½ï¼ˆWeek 1ï¼‰
- **@commonæ¨¡å—æ‰©å±•**ï¼ˆ2-3å¤©ï¼‰:
  - åˆ›å»º `BusinessException` åŸºç±»
  - å®ç° `UniversalExceptionFactory` å·¥å‚
  - å®ç° `UniversalRetryHandler` é‡è¯•æœºåˆ¶
  - æ‰©å±• `GlobalExceptionFilter` æ”¯æŒæ–°å¼‚å¸¸ç±»å‹

### ç¬¬äºŒé˜¶æ®µï¼šç»„ä»¶è¿ç§»ï¼ˆWeek 2-3ï¼‰
æ¯ä¸ªç»„ä»¶åªéœ€ 1-2å¤©ï¼Œå¯å¹¶è¡Œè¿›è¡Œï¼š

| ç»„ä»¶ | å·¥ä½œé‡ | ä¸»è¦ä»»åŠ¡ |
|------|--------|----------|
| **Query** | 2å¤© | å®šä¹‰é”™è¯¯ç å¸¸é‡ + æ›¿æ¢22å¤„é”™è¯¯å¤„ç† |
| **Cache** | 1.5å¤© | è¿ç§»ç°æœ‰å¼‚å¸¸ä½“ç³» + å®šä¹‰é”™è¯¯ç  + ç»Ÿä¸€åˆ°é€šç”¨å·¥å‚ |
| **Common-cache** | 1å¤© | å®šä¹‰é”™è¯¯ç  + ç»Ÿä¸€ç­–ç•¥ |
| **Stream-receiver** | 1å¤© | é”™è¯¯ç  + æ¶ˆé™¤ä¸­è‹±æ–‡æ··ç”¨ |
| **Receiver** | 1å¤© | é”™è¯¯ç  + æ›¿æ¢é€šç”¨å¼‚å¸¸ |
| **Symbol-mapper** | 1å¤© | é”™è¯¯ç  + æ ‡å‡†åŒ– |
| **Storage** | 0.5å¤© | é”™è¯¯ç  + é‡è¯•é›†æˆ |
| **Shared** | 0.5å¤© | é”™è¯¯ç  + é™çº§å®Œå–„ |

### ç¬¬ä¸‰é˜¶æ®µï¼šéªŒè¯å’Œä¼˜åŒ–ï¼ˆWeek 4ï¼‰
- **é›†æˆæµ‹è¯•**: éªŒè¯æ‰€æœ‰ç»„ä»¶é”™è¯¯å¤„ç†ä¸€è‡´æ€§
- **æ€§èƒ½æµ‹è¯•**: ç¡®è®¤é‡è¯•æœºåˆ¶æ€§èƒ½å½±å“
- **ç›‘æ§é…ç½®**: é”™è¯¯æŒ‡æ ‡å’Œå‘Šè­¦è§„åˆ™


---

---

## é™„å½•

### A. å‚è€ƒæ–‡æ¡£
- [NestJS Exception Filters](https://docs.nestjs.com/exception-filters)
- [HTTPçŠ¶æ€ç è§„èŒƒ](https://tools.ietf.org/html/rfc7231#section-6)
- [é”™è¯¯ç è®¾è®¡æœ€ä½³å®è·µ](https://google.github.io/styleguide/jsoncstyleguide.xml#Error_responses)

