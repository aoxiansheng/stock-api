# NestJS 模块字段结构化规范指南

> 基于 NestJS 官方最佳实践的字段管理与去重规范，适用于所有模块的结构化审核

## 一、快速开始

### 1.1 适用场景

本指南适用于以下情况：
- 新建 NestJS 模块时的结构设计
- 现有模块的重构优化
- 代码审查的标准参考


### 1.2 核心原则

```
┌─────────────────────────────────────────────────┐
│ 三个核心原则                                      │
├─────────────────────────────────────────────────┤
│ 1. DRY (Don't Repeat Yourself) - 避免重复        │
│ 2. SRP (Single Responsibility) - 单一职责        │
│ 3. COC (Convention over Configuration) - 约定优先 │
└─────────────────────────────────────────────────┘
```

## 二、字段分类体系

### 2.1 分类决策树

``mermaid
graph TD
    A[字段/常量] --> B{是否跨模块使用?}
    B -->|是| C[全局共享]
    B -->|否| D{是否多文件使用?}
    
    C --> E[shared.constants.ts]
    
    D -->|是| F[模块常量]
    D -->|否| G[文件私有]
    
    F --> H{什么类型?}
    H -->|配置| I[config.constants.ts]
    H -->|消息| J[messages.constants.ts]
    H -->|操作| K[operations.constants.ts]
    H -->|验证| L[validation.constants.ts]
    
    G --> M[不导出，本地定义]
```

### 2.2 标准分类表

| 分类 | 定义标准 | 存储位置 | 命名规范 | 示例 |
|------|---------|---------|---------|------|
| **全局共享常量** | • 被2个以上模块引用<br>• 系统级配置<br>• 不含业务逻辑 | `/common/constants/` | `{SYSTEM}_SHARED_{NAME}` | `SYSTEM_SHARED_TIMEOUT_MS` |
| **模块常量** | • 仅在模块内使用<br>• 业务相关配置 | `/{module}/constants/` | `{MODULE}_{TYPE}_{NAME}` | `USER_CONFIG_MAX_LOGIN_ATTEMPTS` |
| **枚举** | • 有限选项集<br>• 状态/类型/级别 | `/{module}/enums/` | `PascalCase` | `UserStatus`, `OrderType` |
| **DTO字段** | • API数据传输<br>• 请求/响应/查询 | `/{module}/dto/` | `camelCase` | `createUserDto.email` |
| **接口类型** | • 内部数据结构<br>• 服务间传递 | `/{module}/interfaces/` | `I{Name}` | `IUserProfile` |
| **类型 (type)** | • 数据结构定义<br>• 联合类型<br>• 工具类型 | `/{module}/types/` | `PascalCase` | `UserResponse`, `ApiResponse<T>` |


## 三、重复检测规则

### 3.1 重复类型定义

#### Level 1: 完全重复（🔴 Critical）
``typescript
// ❌ 错误示例
// user.constants.ts
export const RETRY_CONFIG = { maxRetries: 3, delay: 1000 };

// order.constants.ts
export const RETRY_CONFIG = { maxRetries: 3, delay: 1000 }; // 完全重复！
```

**检测规则**：
- 字段名相同 AND 值完全相同
- 自动检测命令：`npm run detect:exact-duplicates`

#### Level 2: 语义重复（🟡 Warning）
``typescript
// ⚠️ 需要优化
// user.constants.ts
export const USER_TIMEOUT = 30000;

// order.constants.ts
export const ORDER_PROCESSING_TIMEOUT = 30000; // 概念相同，应统一
```

**检测规则**：
- 值相同 OR 用途相似
- 人工审核 + 工具辅助

#### Level 3: 结构重复（🔵 Info）
``typescript
// 💡 可以优化
// UserQueryDto
class UserQueryDto {
  @IsOptional() page?: number;
  @IsOptional() limit?: number;
}

// OrderQueryDto
class OrderQueryDto {
  @IsOptional() page?: number;  // 结构重复，可继承基类
  @IsOptional() limit?: number;
}
```

**检测规则**：
- 相同的字段组合重复出现
- 建议提取基类或组合

### 3.2 重复度量化标准

``typescript
// 重复度计算公式
重复度 = (重复字段数 / 总字段数) × 100%

// 阈值标准
🟢 优秀: < 3%
🟡 警告: 3% - 8%  
🔴 严重: > 8%
```

## 五、标准审核流程

### 5.1 审核检查清单


####  AI/人工审查
- [ ] 审查完全重复项
- [ ] 评估语义重复项
- [ ] 检查DTO继承机会
- [ ] 验证枚举使用正确性
- [ ] 确认常量分类合理性


### 5.2 审核报告模板

```
# 模块审核报告 - {ModuleName}

## 概览
- 审核日期: {date}
- 文件数量: {fileCount}
- 字段总数: {totalFields}
- 重复率: {duplicateRate}%

## 发现的问题

### 🔴 严重（必须修复）
1. {issue description}
   - 位置: {file}:{line}
   - 影响: {impact}
   - 建议: {suggestion}

### 🟡 警告（建议修复）
...

### 🔵 提示（可选优化）
...

## 量化指标
| 指标 | 当前值 | 目标值 | 状态 |
|-----|--------|--------|------|
| 重复率 | {value}% | <5% | {status} |
| 继承使用率 | {value}% | >70% | {status} |
| 命名规范符合率 | {value}% | 100% | {status} |

## 改进建议
1. {specific recommendations}
```

## 六、最佳实践模式

### 6.1 基类继承模式

``typescript
// ✅ 推荐：提取通用字段到基类

// dto/common/base-query.dto.ts
export class BaseQueryDto {
  @ApiPropertyOptional({ default: 1 })
  @Type(() => Number)
  @Min(1)
  page?: number = 1;

  @ApiPropertyOptional({ default: 20 })
  @Type(() => Number)
  @Min(1)
  @Max(100)
  limit?: number = 20;

  @ApiPropertyOptional()
  @IsEnum(['asc', 'desc'])
  sortOrder?: 'asc' | 'desc' = 'desc';
}

// dto/user-query.dto.ts
export class UserQueryDto extends BaseQueryDto {
  @ApiPropertyOptional()
  @IsString()
  username?: string;
  
  // 只定义特有字段
}
```

### 6.2 常量组织模式

``typescript
// ✅ 推荐：按职责分离常量

// constants/index.ts - 统一导出
export * from './shared.constants';
export * from './config.constants';
export * from './messages.constants';
export * from './validation.constants';

// constants/shared.constants.ts - 跨模块共享
export const SHARED_CONFIG = Object.freeze({
  TIMEOUT: {
    DEFAULT: 30000,
    LONG_RUNNING: 60000,
  },
  RETRY: {
    MAX_ATTEMPTS: 3,
    DELAY: 1000,
  }
});

// constants/config.constants.ts - 模块特定配置
export const USER_CONFIG = Object.freeze({
  MAX_LOGIN_ATTEMPTS: 5,
  SESSION_TIMEOUT: 3600000,
  PASSWORD_MIN_LENGTH: 8,
});
```

### 6.3 枚举定义模式

``typescript
// ✅ 推荐：使用 const assertion 确保类型安全

// enums/user-status.enum.ts
export const UserStatus = {
  ACTIVE: 'active',
  INACTIVE: 'inactive',
  SUSPENDED: 'suspended',
  DELETED: 'deleted',
} as const;

export type UserStatus = typeof UserStatus[keyof typeof UserStatus];

// 提供辅助函数
export const UserStatusUtils = {
  isActive: (status: UserStatus): boolean => status === UserStatus.ACTIVE,
  canLogin: (status: UserStatus): boolean => 
    [UserStatus.ACTIVE].includes(status),
  getLabel: (status: UserStatus): string => {
    const labels = {
      [UserStatus.ACTIVE]: '活跃',
      [UserStatus.INACTIVE]: '未激活',
      [UserStatus.SUSPENDED]: '已暂停',
      [UserStatus.DELETED]: '已删除',
    };
    return labels[status];
  }
};
```

## 七、常见反模式及解决方案

### 7.1 反模式：魔法数字

``typescript
// ❌ 错误
if (retryCount > 3) { // 魔法数字
  throw new Error('Max retries exceeded');
}

// ✅ 正确
if (retryCount > RETRY_CONFIG.MAX_ATTEMPTS) {
  throw new Error('Max retries exceeded');
}
```

### 7.2 反模式：散落的验证规则

``typescript
// ❌ 错误：验证规则分散在DTO中
class UserDto {
  @Matches(/^[a-zA-Z0-9_-]{3,20}$/) // 直接写正则
  username: string;
}

// ✅ 正确：集中管理验证规则
// validation.constants.ts
export const USER_VALIDATION = {
  USERNAME_PATTERN: /^[a-zA-Z0-9_-]{3,20}$/,
  USERNAME_MIN_LENGTH: 3,
  USERNAME_MAX_LENGTH: 20,
};

// user.dto.ts
class UserDto {
  @Matches(USER_VALIDATION.USERNAME_PATTERN)
  @Length(USER_VALIDATION.USERNAME_MIN_LENGTH, USER_VALIDATION.USERNAME_MAX_LENGTH)
  username: string;
}
```

### 7.3 反模式：过度嵌套的常量

``typescript
// ❌ 错误：过度嵌套导致使用困难
export const CONFIG = {
  USER: {
    AUTH: {
      LOGIN: {
        ATTEMPTS: {
          MAX: 5
        }
      }
    }
  }
};

// ✅ 正确：扁平化结构
export const AUTH_CONFIG = {
  MAX_LOGIN_ATTEMPTS: 5,
  LOGIN_TIMEOUT_MS: 30000,
  TOKEN_EXPIRE_TIME: 3600,
};
```


## 八、FAQ

**Q: 什么时候应该提取共享常量？**
A: 当同一个值在2个或以上文件中使用时。

**Q: DTO 什么时候使用继承vs组合？**
A: 继承用于IS-A关系，组合用于HAS-A关系。分页、时间范围等通用字段适合继承。

**Q: 如何处理第三方库的类型定义重复？**
A: 创建统一的类型定义文件，使用命名空间避免冲突。

**Q: 重构的投资回报率(ROI)如何评估？**
A: ROI = (节省的维护时间 × 开发人员时薪) / 重构投入时间

---

## 附录A：快速参考卡

```
┌─────────────────────────────────────────┐
│ 文件组织速查                              │
├─────────────────────────────────────────┤
│ /src/module/                            │
│   ├── constants/                        │
│   │   ├── index.ts          (导出)     │
│   │   ├── shared.constants.ts (共享)    │
│   │   ├── config.constants.ts (配置)    │
│   │   ├── *.constants.ts (其他)         │
│   │   └── messages.constants.ts (消息)  │
│   ├── enums/                           │
│   │   ├── index.ts                     │
│   │   └── *.enum.ts      
│   ├── types/                           │
│   │   ├── index.ts                     │
│   │   └── *.tyoes.ts                 │
│   ├── dto/                             │
│   │   ├── common/          (基类)      │
│   │   ├── request/         (请求)      │
│   │   ├── response/        (响应)      │
│   │   └── query/           (查询)      │
│   └── interfaces/                      │
│       └── *.interface.ts               │
└─────────────────────────────────────────┘
```

