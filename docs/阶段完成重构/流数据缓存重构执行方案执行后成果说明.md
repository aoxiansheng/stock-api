# StreamCache - é«˜æ€§èƒ½æµæ•°æ®ç¼“å­˜ç³»ç»Ÿ

## å¿«é€Ÿå¼€å§‹

StreamCache æ˜¯ä¸“ä¸ºå®æ—¶è‚¡ç¥¨æµæ•°æ®è®¾è®¡çš„åŒå±‚ç¼“å­˜ç³»ç»Ÿï¼Œæä¾›æ¯«ç§’çº§çš„æ•°æ®è®¿é—®æ€§èƒ½ã€‚

### å®‰è£…å’Œé…ç½®

1. **ç¯å¢ƒå‡†å¤‡**
```bash
# ç¡®ä¿Redisè¿è¡Œ
redis-server --port 6379

# å®‰è£…ä¾èµ–
cd backend/
bun install
```

2. **ç¯å¢ƒå˜é‡é…ç½®**
```bash
# .env æ–‡ä»¶
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_STREAM_CACHE_DB=1

# StreamCacheé…ç½®
STREAM_CACHE_HOT_TTL_MS=5000
STREAM_CACHE_WARM_TTL_SECONDS=300
STREAM_CACHE_MAX_HOT_SIZE=1000
```

3. **å¯åŠ¨æœåŠ¡**
```bash
bun run dev
```

## åŸºæœ¬ä½¿ç”¨

### 1. ä¾èµ–æ³¨å…¥

```typescript
import { StreamCacheService } from '@core/05-caching/stream-cache/services/stream-cache.service';

@Injectable()
export class YourService {
  constructor(
    private readonly streamCache: StreamCacheService,
  ) {}
}
```

### 2. æ•°æ®æ“ä½œ

```typescript
// è®¾ç½®æ•°æ® - è‡ªåŠ¨ç­–ç•¥
await this.streamCache.setData('quote:AAPL.US', stockData, 'auto');

// è·å–æ•°æ®
const data = await this.streamCache.getData('quote:AAPL.US');

// å¢é‡æŸ¥è¯¢ - è·å–æœ€è¿‘5ç§’çš„æ•°æ®
const recentData = await this.streamCache.getDataSince(
  'quote:AAPL.US', 
  Date.now() - 5000
);

// æ‰¹é‡æ“ä½œ
const batchResult = await this.streamCache.getBatchData([
  'quote:AAPL.US',
  'quote:TSLA.US'
]);
```

### 3. ç›‘æ§ç»Ÿè®¡

```typescript
// è·å–ç¼“å­˜ç»Ÿè®¡
const stats = this.streamCache.getCacheStats();
console.log(`Hot Cacheå‘½ä¸­ç‡: ${stats.hotCacheHits / (stats.hotCacheHits + stats.hotCacheMisses) * 100}%`);
```

## æ¶æ„ç‰¹æ€§

### ğŸš€ åŒå±‚ç¼“å­˜è®¾è®¡

| ç¼“å­˜å±‚ | å­˜å‚¨ | TTL | å»¶è¿Ÿ | ç”¨é€” |
|--------|------|-----|------|------|
| **Hot Cache** | å†…å­˜LRU | 5ç§’ | ~1ms | è¶…é«˜é¢‘è®¿é—® |
| **Warm Cache** | Redis | 300ç§’ | ~10ms | ä¸­é¢‘è®¿é—® |

### ğŸ¯ æ™ºèƒ½å­˜å‚¨ç­–ç•¥

```typescript
// ç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­å­˜å‚¨ç­–ç•¥
await streamCache.setData(key, data, 'auto'); // æ¨è

// æ‰‹åŠ¨æŒ‡å®šç­–ç•¥
await streamCache.setData(key, data, 'hot');  // å¼ºåˆ¶Hot Cache
await streamCache.setData(key, data, 'warm'); // ä»…Warm Cache
```

### ğŸ“Š æ•°æ®å‹ç¼©

```typescript
// åŸå§‹æ•°æ®æ ¼å¼
const rawData = {
  symbol: 'AAPL.US',
  price: 150.25,
  volume: 1000,
  timestamp: Date.now(),
  change: 2.5,
  changePercent: 1.69
};

// è‡ªåŠ¨å‹ç¼©ä¸º
const compressed = {
  s: 'AAPL.US',    // symbol
  p: 150.25,       // price
  v: 1000,         // volume
  t: Date.now(),   // timestamp
  c: 2.5,          // change
  cp: 1.69         // changePercent
};
```

## æ€§èƒ½æŒ‡æ ‡

### åŸºå‡†æµ‹è¯•ç»“æœ

```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•
bun test test/jest/integration/core/05-caching/stream-cache/

# å…¸å‹æ€§èƒ½æŒ‡æ ‡
âœ“ Hot Cacheè®¿é—®: ~1ms
âœ“ Warm Cacheè®¿é—®: ~10ms
âœ“ 1000æ¬¡å¹¶å‘è®¿é—®: <500ms
âœ“ ç¼“å­˜å‘½ä¸­ç‡: >95%
âœ“ æ•°æ®å‹ç¼©æ¯”: ~0.6
```

### å®¹é‡è§„åˆ’

```typescript
// é»˜è®¤é…ç½®
const config = {
  maxHotCacheSize: 1000,      // Hot Cacheæœ€å¤§æ¡ç›®æ•°
  hotCacheTTL: 5000,          // 5ç§’TTL
  warmCacheTTL: 300,          // 5åˆ†é’ŸTTL
  cleanupInterval: 30000,     // 30ç§’æ¸…ç†é—´éš”
};

// å†…å­˜ä½¿ç”¨ä¼°ç®—
// Hot Cache: ~1000 æ¡ç›® Ã— å¹³å‡1KB = 1MB
// Warm Cache: å–å†³äºRedisé…ç½®
```

## é«˜çº§åŠŸèƒ½

### 1. å¢é‡æ•°æ®æŸ¥è¯¢

```typescript
// å®æ—¶æ•°æ®è¿½è¸ªåœºæ™¯
const lastTimestamp = getLastProcessedTimestamp();
const incrementalData = await streamCache.getDataSince(
  'realtime:AAPL.US',
  lastTimestamp
);

// å¤„ç†æ–°æ•°æ®
if (incrementalData) {
  await processNewData(incrementalData);
}
```

### 2. æ‰¹é‡æ“ä½œä¼˜åŒ–

```typescript
// è·å–æŠ•èµ„ç»„åˆçš„æ‰€æœ‰è‚¡ç¥¨æ•°æ®
const portfolio = ['AAPL.US', 'MSFT.US', 'GOOGL.US', 'AMZN.US'];
const portfolioKeys = portfolio.map(symbol => `quote:${symbol}`);

const portfolioData = await streamCache.getBatchData(portfolioKeys);

// å¹¶è¡Œå¤„ç†
const processedData = Object.entries(portfolioData).map(([key, data]) => {
  return data ? processStockData(data) : null;
});
```

### 3. å®æ—¶WebSocketé›†æˆ

```typescript
// WebSocketæ•°æ®æ¥æ”¶å¤„ç†
websocket.on('data', async (rawData) => {
  const symbol = extractSymbol(rawData);
  const cacheKey = `realtime:${symbol}`;
  
  // æ™ºèƒ½ç¼“å­˜ç­–ç•¥ - çƒ­é—¨è‚¡ç¥¨ç”¨Hot Cache
  const priority = isHotStock(symbol) ? 'hot' : 'auto';
  await streamCache.setData(cacheKey, rawData, priority);
  
  // å¹¿æ’­ç»™è®¢é˜…å®¢æˆ·ç«¯
  broadcastToClients(symbol, rawData);
});
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç¼“å­˜å‘½ä¸­ç‡ä½**
```typescript
// æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
const stats = streamCache.getCacheStats();
console.log('å‘½ä¸­ç‡ç»Ÿè®¡:', {
  hotHitRate: stats.hotCacheHits / (stats.hotCacheHits + stats.hotCacheMisses),
  warmHitRate: stats.warmCacheHits / (stats.warmCacheHits + stats.warmCacheMisses),
});

// å¯èƒ½åŸå› ï¼š
// - TTLè®¾ç½®è¿‡çŸ­
// - ç¼“å­˜å®¹é‡ä¸è¶³
// - æ•°æ®è®¿é—®æ¨¡å¼ä¸è§„å¾‹
```

2. **Redisè¿æ¥é—®é¢˜**
```typescript
// æ£€æŸ¥Redisè¿æ¥
const redisClient = module.get('REDIS_CLIENT');
const pingResult = await redisClient.ping();
console.log('RedisçŠ¶æ€:', pingResult); // åº”è¯¥è¿”å› 'PONG'
```

3. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
```typescript
// è°ƒæ•´Hot Cacheå¤§å°
const config = {
  maxHotCacheSize: 500, // å‡å°‘å®¹é‡
  cleanupInterval: 15000, // å¢åŠ æ¸…ç†é¢‘ç‡
};
```

### è°ƒè¯•æ¨¡å¼

```typescript
// å¯ç”¨è¯¦ç»†æ—¥å¿—
process.env.LOG_LEVEL = 'debug';

// ç›‘æ§ç¼“å­˜æ“ä½œ
streamCache.getCacheStats(); // å®šæœŸæ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
```

## æµ‹è¯•

### è¿è¡Œæµ‹è¯•

```bash
# å•å…ƒæµ‹è¯•
bun test test/jest/unit/core/05-caching/stream-cache/

# é›†æˆæµ‹è¯• (éœ€è¦Redisè¿è¡Œ)
bun test test/jest/integration/core/05-caching/stream-cache/

# ç‰¹å®šæµ‹è¯•
bun test test/jest/unit/core/05-caching/stream-cache/services/stream-cache.service.spec.ts
```

### æµ‹è¯•è¦†ç›–ç‡

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
bun test --coverage test/jest/unit/core/05-caching/stream-cache/
```

## ç”Ÿäº§éƒ¨ç½²

### 1. æ€§èƒ½ä¼˜åŒ–é…ç½®

```typescript
// ç”Ÿäº§ç¯å¢ƒé…ç½®
const productionConfig = {
  hotCacheTTL: 3000,           // 3ç§’ - æ›´æ¿€è¿›çš„TTL
  warmCacheTTL: 600,           // 10åˆ†é’Ÿ - æ›´é•¿çš„å¤‡ä»½æ—¶é—´
  maxHotCacheSize: 2000,       // æ›´å¤§çš„Hot Cache
  cleanupInterval: 60000,      // 1åˆ†é’Ÿæ¸…ç†é—´éš”
  compressionThreshold: 512,   // æ›´ä½çš„å‹ç¼©é˜ˆå€¼
};
```

### 2. ç›‘æ§é›†æˆ

```typescript
// PrometheusæŒ‡æ ‡é›†æˆ
import { register } from 'prom-client';

const cacheHitRateGauge = new Gauge({
  name: 'stream_cache_hit_rate',
  help: 'Stream cache hit rate percentage',
  labelNames: ['cache_type'],
  registers: [register],
});

// å®šæœŸæ›´æ–°æŒ‡æ ‡
setInterval(() => {
  const stats = streamCache.getCacheStats();
  const hotHitRate = stats.hotCacheHits / (stats.hotCacheHits + stats.hotCacheMisses);
  cacheHitRateGauge.set({ cache_type: 'hot' }, hotHitRate);
}, 30000);
```

### 3. å¥åº·æ£€æŸ¥

```typescript
// å¥åº·æ£€æŸ¥ç«¯ç‚¹
@Get('/health/stream-cache')
async getStreamCacheHealth() {
  const stats = streamCache.getCacheStats();
  const redisClient = this.module.get('REDIS_CLIENT');
  
  try {
    await redisClient.ping();
    return {
      status: 'healthy',
      stats,
      redis: 'connected',
      timestamp: new Date().toISOString(),
    };
  } catch (error) {
    return {
      status: 'degraded',
      stats,
      redis: 'disconnected',
      error: error.message,
      timestamp: new Date().toISOString(),
    };
  }
}
```

## æœ€ä½³å®è·µ

### 1. ç¼“å­˜é”®å‘½å
```typescript
// æ¨èçš„å‘½åè§„èŒƒ
const keys = {
  quote: `quote:${symbol}`,                    // æŠ¥ä»·æ•°æ®
  historical: `hist:${symbol}:${date}`,        // å†å²æ•°æ®
  realtime: `rt:${symbol}:${timestamp}`,       // å®æ—¶æµæ•°æ®
  batch: `batch:${batchId}`,                   // æ‰¹é‡æ•°æ®
  portfolio: `portfolio:${userId}:${symbols}`, // æŠ•èµ„ç»„åˆ
};
```

### 2. é”™è¯¯å¤„ç†
```typescript
try {
  const data = await streamCache.getData(key);
  return data || await fallbackDataSource(key);
} catch (error) {
  logger.error('ç¼“å­˜è®¿é—®å¤±è´¥', { key, error });
  return await fallbackDataSource(key); // ä¼˜é›…é™çº§
}
```

### 3. æ‰¹é‡æ“ä½œä¼˜åŒ–
```typescript
// ä¼˜åŒ–å¤§æ‰¹é‡æ“ä½œ
const BATCH_SIZE = 50;
const batches = chunk(keys, BATCH_SIZE);

const results = await Promise.all(
  batches.map(batch => streamCache.getBatchData(batch))
);

return results.reduce((acc, batch) => ({ ...acc, ...batch }), {});
```

---

**StreamCache ä¸ºè‚¡ç¥¨æµæ•°æ®å¤„ç†æä¾›äº†é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„ç¼“å­˜è§£å†³æ–¹æ¡ˆã€‚**