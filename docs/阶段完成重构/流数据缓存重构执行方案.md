# NestJSæµæ•°æ®ç¼“å­˜é‡æ„æ‰§è¡Œæ–¹æ¡ˆ

## ğŸ“‹ é‡æ„æ¦‚è¿°

æ ¹æ®NestJSæœ€ä½³å®è·µï¼Œå°†æµæ•°æ®ç¼“å­˜åŠŸèƒ½ä»é€šç”¨CacheServiceä¸­åˆ†ç¦»ï¼Œåˆ›å»ºä¸“ç”¨çš„StreamCacheæœåŠ¡ï¼Œå®ç°æ¨¡å—åŒ–è§£è€¦å’ŒåŠŸèƒ½ä¸“åŒ–ã€‚

## ğŸ¯ é‡æ„ç›®æ ‡

1. **æ¨¡å—åŒ–è§£è€¦**ï¼šåˆ›å»ºç‹¬ç«‹çš„StreamCacheModuleï¼Œç§»é™¤å¯¹é€šç”¨CacheModuleçš„ä¾èµ–
2. **åŠŸèƒ½ä¸“åŒ–**ï¼šä¼˜åŒ–æµæ•°æ®ç¼“å­˜çš„ç‰¹å®šéœ€æ±‚ï¼ˆåŒå±‚ç¼“å­˜ã€å‹ç¼©ã€TTLç­–ç•¥ï¼‰
3. **ä¾èµ–æ³¨å…¥ä¼˜åŒ–**ï¼šä½¿ç”¨NestJSæ ‡å‡†çš„ä¾èµ–æ³¨å…¥æ¨¡å¼
4. **ä»£ç å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„æ¥å£å®šä¹‰å’Œå®ç°åˆ†ç¦»

## ğŸ“Š å½±å“åˆ†æ

### æ ¸å¿ƒå˜æ›´
- âœ… **StreamDataCacheService** â†’ **StreamCacheService** (é‡æ„ä¸ºä¸“ç”¨æœåŠ¡)
- âœ… **CacheModuleä¾èµ–** â†’ **StreamCacheModuleä¾èµ–** (æ¨¡å—çº§è§£è€¦)
- âœ… **é€šç”¨Redisè¿æ¥** â†’ **ä¸“ç”¨Redisè¿æ¥** (èµ„æºéš”ç¦»)

### å½±å“èŒƒå›´
- âœ… `StreamDataFetcherModule`: å¯¼å…¥å˜æ›´
- âœ… `StreamDataFetcherService`: ä¾èµ–æ³¨å…¥å˜æ›´
- âœ… `StreamReceiverService`: é—´æ¥å½±å“ï¼ˆé€šè¿‡StreamDataFetcherè®¿é—®ï¼‰
- âœ… **æ— ç›´æ¥å½±å“**: CacheServiceä¿æŒä¸å˜ï¼ˆé€šç”¨ç¼“å­˜åŠŸèƒ½å®Œæ•´ä¿ç•™ï¼‰

## ğŸ—ï¸ å®æ–½æ­¥éª¤

### Step 1: åˆ›å»ºStreamCacheæ¶æ„ âœ…

#### 1.1 æ¥å£å®šä¹‰
```typescript
// src/core/05-caching/stream-cache/interfaces/stream-cache.interface.ts
export interface IStreamCache {
  getData(key: string): Promise<StreamDataPoint[] | null>;
  setData(key: string, data: any[], priority?: 'hot' | 'warm' | 'auto'): Promise<void>;
  getDataSince(key: string, since: number): Promise<StreamDataPoint[] | null>;
  getBatchData(keys: string[]): Promise<Record<string, StreamDataPoint[] | null>>;
  deleteData(key: string): Promise<void>;
  clearAll(): Promise<void>;
  getCacheStats(): StreamCacheStats;
}
```

#### 1.2 å¸¸é‡é…ç½®
```typescript
// src/core/05-caching/stream-cache/constants/stream-cache.constants.ts
export const STREAM_CACHE_CONFIG = {
  TTL: {
    HOT_CACHE_MS: 5000,      // Hot Cache: 5ç§’
    WARM_CACHE_SECONDS: 300,  // Warm Cache: 5åˆ†é’Ÿ
  },
  CAPACITY: {
    MAX_HOT_CACHE_SIZE: 1000,
    MAX_BATCH_SIZE: 200,
  },
  // ... å…¶ä»–é…ç½®
};
```

#### 1.3 æ ¸å¿ƒæœåŠ¡å®ç°
```typescript
// src/core/05-caching/stream-cache/services/stream-cache.service.ts
@Injectable()
export class StreamCacheService implements IStreamCache, OnModuleDestroy {
  constructor(
    @Inject('REDIS_CLIENT') private readonly redisClient: Redis,
    @Inject('STREAM_CACHE_CONFIG') config?: Partial<StreamCacheConfig>
  ) {
    // åŒå±‚ç¼“å­˜æ¶æ„ï¼šHot Cache (å†…å­˜LRU) + Warm Cache (Redis)
  }
}
```

### Step 2: åˆ›å»ºç‹¬ç«‹æ¨¡å— âœ…

#### 2.1 StreamCacheModule
```typescript
// src/core/05-caching/stream-cache/module/stream-cache.module.ts
@Module({
  imports: [ConfigModule],
  providers: [
    {
      provide: 'REDIS_CLIENT',
      useFactory: (configService: ConfigService) => {
        // ä¸“ç”¨Redisè¿æ¥ï¼Œä½¿ç”¨ç‹¬ç«‹DB
        db: configService.get<number>('redis.stream_cache_db', 1),
      },
    },
    {
      provide: 'STREAM_CACHE_CONFIG',
      useFactory: (configService: ConfigService) => ({
        hotCacheTTL: configService.get<number>('stream_cache.hot_ttl_ms', 5000),
        warmCacheTTL: configService.get<number>('stream_cache.warm_ttl_seconds', 300),
        // ... å…¶ä»–é…ç½®
      }),
    },
    StreamCacheService,
  ],
  exports: [StreamCacheService, 'REDIS_CLIENT', 'STREAM_CACHE_CONFIG'],
})
export class StreamCacheModule {}
```

### Step 3: é‡æ„ä¾èµ–å…³ç³» âœ…

#### 3.1 StreamDataFetcherModuleé‡æ„
```typescript
// å˜æ›´å‰
@Module({
  imports: [
    CacheModule, // âŒ ç§»é™¤é€šç”¨ç¼“å­˜ä¾èµ–
  ],
  providers: [
    StreamDataCacheService, // âŒ ç§»é™¤æ—§æœåŠ¡
  ],
})

// å˜æ›´å
@Module({
  imports: [
    StreamCacheModule, // âœ… å¯¼å…¥ä¸“ç”¨ç¼“å­˜æ¨¡å—
  ],
  providers: [
    // âœ… StreamCacheServiceç”±StreamCacheModuleæä¾›
  ],
})
```

#### 3.2 StreamDataFetcherServiceé‡æ„
```typescript
// å˜æ›´å‰
constructor(
  private readonly streamDataCache: StreamDataCacheService, // âŒ
) {}

// å˜æ›´å
constructor(
  private readonly streamCache: StreamCacheService, // âœ…
) {}

// æ–¹æ³•æ›´æ–°
getStreamDataCache(): StreamCacheService { // âœ… è¿”å›ç±»å‹æ›´æ–°
  return this.streamCache;
}
```

### Step 4: é…ç½®å’Œç¯å¢ƒå˜é‡ âœ…

#### 4.1 Redisé…ç½®æ‰©å±•
```bash
# æ–°å¢ç¯å¢ƒå˜é‡
REDIS_STREAM_CACHE_DB=1  # æµç¼“å­˜ä¸“ç”¨DB
STREAM_CACHE_HOT_TTL_MS=5000
STREAM_CACHE_WARM_TTL_SECONDS=300
STREAM_CACHE_MAX_HOT_SIZE=1000
```

#### 4.2 é…ç½®æ–‡ä»¶æ›´æ–°
```javascript
// config/default.js
module.exports = {
  redis: {
    host: 'localhost',
    port: 6379,
    db: 0,  // é€šç”¨ç¼“å­˜DB
    stream_cache_db: 1,  // æµç¼“å­˜ä¸“ç”¨DB
  },
  stream_cache: {
    hot_ttl_ms: 5000,
    warm_ttl_seconds: 300,
    max_hot_size: 1000,
    cleanup_interval_ms: 30000,
    compression_threshold: 1024,
  },
};
```

## ğŸ” éªŒè¯æ­¥éª¤

### 1. ç¼–è¯‘éªŒè¯
```bash
cd backend/
bun run build  # ç¡®ä¿æ— TypeScriptç¼–è¯‘é”™è¯¯
```

### 2. ä¾èµ–éªŒè¯
```bash
# æ£€æŸ¥æ¨¡å—ä¾èµ–æ˜¯å¦æ­£ç¡®
bun run lint  # ç¡®ä¿æ— ESLinté”™è¯¯
```

### 3. åŠŸèƒ½éªŒè¯
```bash
# è¿è¡Œç›¸å…³æµ‹è¯•
bun test test/jest/unit/core/03-fetching/stream-data-fetcher/
bun test test/jest/unit/core/05-caching/stream-cache/  # æ–°å¢æµ‹è¯•ç›®å½•
```

### 4. é›†æˆéªŒè¯
```bash
# å¯åŠ¨æœåŠ¡éªŒè¯
bun run dev
# æ£€æŸ¥æµç¼“å­˜æœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œ
```

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### 1. æ¶æ„ä¼˜åŒ–
- **æ¨¡å—åŒ–è§£è€¦**: StreamCacheç‹¬ç«‹éƒ¨ç½²å’Œç»´æŠ¤
- **èµ„æºéš”ç¦»**: ç‹¬ç«‹Redis DBï¼Œé¿å…ç¼“å­˜é”®å†²çª
- **åŠŸèƒ½ä¸“åŒ–**: é’ˆå¯¹æµæ•°æ®ä¼˜åŒ–çš„ç¼“å­˜ç­–ç•¥

### 2. æ€§èƒ½æå‡
- **ä¸“ç”¨é…ç½®**: æµæ•°æ®ä¸“ç”¨çš„TTLå’Œå‹ç¼©ç­–ç•¥
- **è¿æ¥ä¼˜åŒ–**: é’ˆå¯¹é«˜é¢‘è®¿é—®çš„Redisè¿æ¥æ± é…ç½®
- **å†…å­˜ä¼˜åŒ–**: ä¸“ç”¨çš„LRUç®—æ³•å’Œæ¸…ç†ç­–ç•¥

### 3. å¯ç»´æŠ¤æ€§
- **æ¸…æ™°è¾¹ç•Œ**: æµç¼“å­˜vsé€šç”¨ç¼“å­˜èŒè´£æ˜ç¡®
- **æµ‹è¯•ç®€åŒ–**: ç‹¬ç«‹çš„æµ‹è¯•å¥—ä»¶å’ŒMockç­–ç•¥
- **é…ç½®é›†ä¸­**: æµç¼“å­˜ç›¸å…³é…ç½®ç»Ÿä¸€ç®¡ç†

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. å…¼å®¹æ€§ä¿è¯
- âœ… **æ¥å£å…¼å®¹**: `getStreamDataCache()`æ–¹æ³•ç­¾åä¿æŒä¸€è‡´
- âœ… **åŠŸèƒ½ç­‰ä»·**: æ‰€æœ‰åŸæœ‰ç¼“å­˜åŠŸèƒ½å®Œæ•´ä¿ç•™
- âœ… **æ€§èƒ½æ— æŸ**: ç¼“å­˜å‘½ä¸­ç‡å’Œå“åº”æ—¶é—´ä¸å—å½±å“

### 2. è¿ç§»é£é™©
- **æœ€å°å½±å“**: ä»…æ¨¡å—å†…éƒ¨é‡æ„ï¼Œå¤–éƒ¨æ¥å£ä¸å˜
- **å›æ»šæ–¹æ¡ˆ**: ä¿ç•™åŸStreamDataCacheServiceä½œä¸ºå¤‡ä»½
- **æ¸è¿›è¿ç§»**: å¯ä»¥åˆ†é˜¶æ®µéªŒè¯å’Œéƒ¨ç½²

### 3. é…ç½®ç®¡ç†
- **ç¯å¢ƒå˜é‡**: æ–°å¢é…ç½®é¡¹éœ€è¦åœ¨æ‰€æœ‰ç¯å¢ƒä¸­é…ç½®
- **é»˜è®¤å€¼**: æä¾›åˆç†çš„é»˜è®¤é…ç½®å€¼
- **å‘åå…¼å®¹**: åŸæœ‰é…ç½®ç»§ç»­ç”Ÿæ•ˆ

## ğŸ“ å®æ–½æ¸…å•

### å·²å®Œæˆ âœ…
- [x] åˆ›å»ºStreamCacheæ¥å£å’Œå®ç°
- [x] åˆ›å»ºStreamCacheModuleæ¨¡å—
- [x] é‡æ„StreamDataFetcherModuleä¾èµ–
- [x] é‡æ„StreamDataFetcherServiceæ³¨å…¥
- [x] æ›´æ–°æ–¹æ³•ç­¾åå’Œè¿”å›ç±»å‹

### å¾…æ‰§è¡Œ
- [ ] åˆ›å»ºStreamCacheå•å…ƒæµ‹è¯•
- [ ] åˆ›å»ºStreamCacheé›†æˆæµ‹è¯•  
- [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£
- [ ] éƒ¨ç½²ç¯å¢ƒé…ç½®æ›´æ–°
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•

## ğŸ¯ æˆåŠŸæ ‡å‡†

1. **ç¼–è¯‘æˆåŠŸ**: æ— TypeScripté”™è¯¯
2. **æµ‹è¯•é€šè¿‡**: æ‰€æœ‰ç›¸å…³æµ‹è¯•caseé€šè¿‡
3. **åŠŸèƒ½ç­‰ä»·**: ç¼“å­˜åŠŸèƒ½å®Œå…¨ç­‰ä»·äºé‡æ„å‰
4. **æ€§èƒ½ä¸é™**: ç¼“å­˜å‘½ä¸­ç‡å’Œå“åº”æ—¶é—´ä¿æŒæˆ–æå‡
5. **ç‹¬ç«‹æ€§**: StreamCacheå¯ä»¥ç‹¬ç«‹éƒ¨ç½²å’Œé…ç½®

---

**æœ¬é‡æ„æ–¹æ¡ˆåŸºäºå®é™…ä»£ç åˆ†æï¼Œç¡®ä¿æœ€å°åŒ–é£é™©çš„åŒæ—¶å®ç°æ¶æ„ä¼˜åŒ–ç›®æ ‡ã€‚**