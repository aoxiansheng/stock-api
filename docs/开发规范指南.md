## ç›®å½•å¯¼èˆª

- [æ¦‚è¿°](#æ¦‚è¿°)
- [0. å¿«é€Ÿå¼€å§‹](#0-å¿«é€Ÿå¼€å§‹)
  - [0.1 ç¯å¢ƒå‡†å¤‡](#01-ç¯å¢ƒå‡†å¤‡)
  - [0.2 å¼€å‘å·¥ä½œæµç¨‹](#02-å¼€å‘å·¥ä½œæµç¨‹)
  - [0.3 é¡¹ç›®æ ¸å¿ƒæ¦‚å¿µ](#03-é¡¹ç›®æ ¸å¿ƒæ¦‚å¿µ)
- [1. é¡¹ç›®æ¶æ„è§„èŒƒ](#1-é¡¹ç›®æ¶æ„è§„èŒƒ)
  - [1.1 æ ¸å¿ƒæ¶æ„åŸåˆ™](#11-æ ¸å¿ƒæ¶æ„åŸåˆ™)
  - [1.2 ç›®å½•ç»“æ„è§„èŒƒ](#12-ç›®å½•ç»“æ„è§„èŒƒ)
- [2. å‘½åè§„èŒƒ](#2-å‘½åè§„èŒƒ)
  - [2.1 æ–‡ä»¶å‘½å](#21-æ–‡ä»¶å‘½å)
  - [2.2 ç±»å‘½å](#22-ç±»å‘½å)
  - [2.3 æ–¹æ³•å’Œå˜é‡å‘½å](#23-æ–¹æ³•å’Œå˜é‡å‘½å)
  - [2.4 æ•°æ®ç±»å‹å’Œèƒ½åŠ›å‘½åè§„èŒƒ â­](#24-æ•°æ®ç±»å‹å’Œèƒ½åŠ›å‘½åè§„èŒƒ-)
- [3. æ§åˆ¶å™¨å¼€å‘è§„èŒƒ](#3-æ§åˆ¶å™¨å¼€å‘è§„èŒƒ)
  - [3.1 åŸºç¡€ç»“æ„æ¨¡æ¿](#31-åŸºç¡€ç»“æ„æ¨¡æ¿)
  - [3.2 æ§åˆ¶å™¨ç¼–å†™æ ‡å‡†](#32-æ§åˆ¶å™¨ç¼–å†™æ ‡å‡†)
  - [3.3 Swaggeræ–‡æ¡£è§„èŒƒ](#33-swaggeræ–‡æ¡£è§„èŒƒ)
  - [3.4 æ‰¹é‡æ“ä½œå“åº”è§„èŒƒ â­](#34-æ‰¹é‡æ“ä½œå“åº”è§„èŒƒ-)
- [4. æœåŠ¡å±‚å¼€å‘è§„èŒƒ](#4-æœåŠ¡å±‚å¼€å‘è§„èŒƒ)
  - [4.1 æœåŠ¡ç»“æ„æ¨¡æ¿](#41-æœåŠ¡ç»“æ„æ¨¡æ¿)
  - [4.2 æœåŠ¡ç¼–å†™æ ‡å‡†](#42-æœåŠ¡ç¼–å†™æ ‡å‡†)
- [5. DTOå¼€å‘è§„èŒƒ](#5-dtoå¼€å‘è§„èŒƒ)
  - [5.1 DTOç»“æ„æ¨¡æ¿](#51-dtoç»“æ„æ¨¡æ¿)
  - [5.2 DTOç¼–å†™æ ‡å‡†](#52-dtoç¼–å†™æ ‡å‡†)
  - [5.3 DTO å¤ç”¨ common æ¨¡å—æœ€ä½³å®è·µ](#53-dto-å¤ç”¨-common-æ¨¡å—æœ€ä½³å®è·µ)
- [6. æ•°æ®åº“å’Œä»“å‚¨å±‚è§„èŒƒ](#6-æ•°æ®åº“å’Œä»“å‚¨å±‚è§„èŒƒ)
  - [6.1 Schemaå®šä¹‰è§„èŒƒ](#61-schemaå®šä¹‰è§„èŒƒ)
  - [6.2 ä»“å‚¨å±‚å®ç°è§„èŒƒ](#62-ä»“å‚¨å±‚å®ç°è§„èŒƒ)
  - [6.3 æ•°æ®åº“è®¾è®¡æ ‡å‡†](#63-æ•°æ®åº“è®¾è®¡æ ‡å‡†)
  - [6.4 æ•°æ®åº“å¤ç”¨ common æ¨¡å—æœ€ä½³å®è·µ](#64-æ•°æ®åº“å¤ç”¨-common-æ¨¡å—æœ€ä½³å®è·µ)
- [7. é”™è¯¯å¤„ç†å’Œå“åº”è§„èŒƒ](#7-é”™è¯¯å¤„ç†å’Œå“åº”è§„èŒƒ)
  - [7.1 å¼‚å¸¸å¤„ç†æ ‡å‡†](#71-å¼‚å¸¸å¤„ç†æ ‡å‡†)
  - [7.2 è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸](#72-è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸)
  - [7.3 å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨](#73-å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨)
- [8. è®¤è¯å’Œæˆæƒè§„èŒƒ](#8-è®¤è¯å’Œæˆæƒè§„èŒƒ)
  - [8.1 æƒé™ç³»ç»Ÿæ¶æ„](#81-æƒé™ç³»ç»Ÿæ¶æ„)
  - [8.2 è®¤è¯è£…é¥°å™¨ä½¿ç”¨](#82-è®¤è¯è£…é¥°å™¨ä½¿ç”¨)
  - [8.3 å“åº”è£…é¥°å™¨å®Œæ•´æŒ‡å—](#83-å“åº”è£…é¥°å™¨å®Œæ•´æŒ‡å—)
  - [8.4 å“åº”è£…é¥°å™¨è¯¦ç»†ä½¿ç”¨](#84-å“åº”è£…é¥°å™¨è¯¦ç»†ä½¿ç”¨)
  - [8.5 è£…é¥°å™¨å¸¸è§é—®é¢˜ä¸è°ƒè¯•](#85-è£…é¥°å™¨å¸¸è§é—®é¢˜ä¸è°ƒè¯•)
  - [8.6 æƒé™æ§åˆ¶](#86-æƒé™æ§åˆ¶)
  - [8.7 æƒé™éªŒè¯æœ€ä½³å®è·µ](#87-æƒé™éªŒè¯æœ€ä½³å®è·µ)
  - [8.8 è¯·æ±‚ä¸Šä¸‹æ–‡](#88-è¯·æ±‚ä¸Šä¸‹æ–‡)
- [9. æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—è§„èŒƒ](#9-æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—è§„èŒƒ)
  - [9.1 æ—¥å¿—è®°å½•æ ‡å‡†](#91-æ—¥å¿—è®°å½•æ ‡å‡†)
  - [9.2 æ€§èƒ½ç›‘æ§](#92-æ€§èƒ½ç›‘æ§)
  - [9.3 å¥åº·æ£€æŸ¥](#93-å¥åº·æ£€æŸ¥)
- [10. Shared æ¨¡å—å¤ç”¨æŒ‡å— ğŸ¯](#10-common-æ¨¡å—å¤ç”¨æŒ‡å—-)
  - [10.1 Shared æ¨¡å—æ¦‚è§ˆ](#101-common-æ¨¡å—æ¦‚è§ˆ)
  - [10.2 å¼ºåˆ¶å¤ç”¨è§„èŒƒ](#102-å¼ºåˆ¶å¤ç”¨è§„èŒƒ)
  - [10.3 ç»„ä»¶çº§å¤ç”¨æŒ‡å—](#103-ç»„ä»¶çº§å¤ç”¨æŒ‡å—)
  - [10.4 å¤ç”¨éªŒè¯æ¸…å•](#104-å¤ç”¨éªŒè¯æ¸…å•)
  - [10.5 åæ¨¡å¼è­¦å‘Š](#105-åæ¨¡å¼è­¦å‘Š)
- [11. æµ‹è¯•è§„èŒƒ](#11-æµ‹è¯•è§„èŒƒ)
  - [11.1 å•å…ƒæµ‹è¯•](#111-å•å…ƒæµ‹è¯•)
  - [11.2 é›†æˆæµ‹è¯•](#112-é›†æˆæµ‹è¯•)
  - [11.3 æµ‹è¯•ä¸­çš„ Shared æ¨¡å—å¤ç”¨æœ€ä½³å®è·µ](#113-æµ‹è¯•ä¸­çš„-common-æ¨¡å—å¤ç”¨æœ€ä½³å®è·µ)
- [13. APIç‰ˆæœ¬æ§åˆ¶](#13-apiç‰ˆæœ¬æ§åˆ¶)
  - [13.1 ç‰ˆæœ¬ç­–ç•¥](#131-ç‰ˆæœ¬ç­–ç•¥)
  - [13.2 ç‰ˆæœ¬å®ç°](#132-ç‰ˆæœ¬å®ç°)
- [14. å®‰å…¨è§„èŒƒ](#14-å®‰å…¨è§„èŒƒ)
  - [14.1 è¾“å…¥éªŒè¯](#141-è¾“å…¥éªŒè¯)
  - [14.2 æ•æ„Ÿä¿¡æ¯å¤„ç†](#142-æ•æ„Ÿä¿¡æ¯å¤„ç†)
  - [14.3 å®‰å…¨å®¡è®¡](#143-å®‰å…¨å®¡è®¡)
  - [14.4 HTTP Headers å·¥å…·ç±»](#144-http-headers-å·¥å…·ç±»)
- [15. CI/CDå’Œéƒ¨ç½²è§„èŒƒ](#15-cicdå’Œéƒ¨ç½²è§„èŒƒ)
  - [15.1 ä»£ç è´¨é‡æ£€æŸ¥](#151-ä»£ç è´¨é‡æ£€æŸ¥)
  - [15.2 æ„å»ºå’Œéƒ¨ç½²](#152-æ„å»ºå’Œéƒ¨ç½²)
- [16. å¼€å‘å·¥å…·å’Œé…ç½®](#16-å¼€å‘å·¥å…·å’Œé…ç½®)
  - [16.1 IDEé…ç½®](#161-ideé…ç½®)
  - [16.2 ç¯å¢ƒå˜é‡ç®¡ç†](#162-ç¯å¢ƒå˜é‡ç®¡ç†)
- [17. æœ€ä½³å®è·µæ€»ç»“](#17-æœ€ä½³å®è·µæ€»ç»“)
  - [17.1 ä»£ç è´¨é‡](#171-ä»£ç è´¨é‡)
  - [17.2 å›¢é˜Ÿåä½œ](#172-å›¢é˜Ÿåä½œ)
  - [17.3 ç³»ç»Ÿç›‘æ§](#173-ç³»ç»Ÿç›‘æ§)
- [ç»“è¯­](#ç»“è¯­)
  - [ğŸ“š ç›¸å…³æ–‡æ¡£](#-ç›¸å…³æ–‡æ¡£)
  - [ğŸ¯ è§„èŒƒæ›´æ–°è®°å½•](#-è§„èŒƒæ›´æ–°è®°å½•)

# NestJS + Bun é¡¹ç›®å¼€å‘è§„èŒƒæŒ‡å—

> åŸºäº Context7 NestJS æœ€ä½³å®è·µå’Œå½“å‰é¡¹ç›®æ¶æ„åˆ¶å®šçš„ä¼ä¸šçº§å¼€å‘æ ‡å‡†

## æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºå¯¹ NestJS å®˜æ–¹æœ€ä½³å®è·µçš„æ·±å…¥ç ”ç©¶å’Œå½“å‰é¡¹ç›®æ¶æ„çš„å…¨é¢åˆ†æï¼Œåˆ¶å®šäº†ä¸€å¥—ç»Ÿä¸€çš„å¼€å‘è§„èŒƒï¼Œç¡®ä¿ä»£ç è´¨é‡ã€å›¢é˜Ÿåä½œæ•ˆç‡å’Œç³»ç»Ÿçš„é•¿æœŸå¯ç»´æŠ¤æ€§ã€‚

**ğŸ“š æ–‡æ¡£å…³ç³»è¯´æ˜**ï¼š
- æœ¬æ–‡æ¡£æ˜¯ [CLAUDE.md](../CLAUDE.md) çš„è¡¥å……ï¼Œä¸“æ³¨äºå…·ä½“çš„ç¼–ç è§„èŒƒå’Œå¼€å‘æ ‡å‡†
- CLAUDE.md æä¾›ç³»ç»Ÿæ¦‚è§ˆå’Œå¿«é€Ÿä¸Šæ‰‹æŒ‡å—ï¼Œæœ¬æ–‡æ¡£æä¾›è¯¦ç»†çš„å¼€å‘å®è·µè§„èŒƒ
- å»ºè®®å…ˆé˜…è¯» CLAUDE.md äº†è§£ç³»ç»Ÿæ¶æ„ï¼Œå†å‚è€ƒæœ¬æ–‡æ¡£è¿›è¡Œå…·ä½“å¼€å‘

**ğŸ¯ åˆè§„æ•´æ”¹çŠ¶æ€**ï¼š
- âœ… ç³»ç»Ÿå·²å®Œæˆ95%+ä¼ä¸šçº§åˆè§„æ•´æ”¹
- âœ… ç»Ÿä¸€å“åº”æ ¼å¼å’Œè®¤è¯è£…é¥°å™¨æ ‡å‡†åŒ–
- âœ… ä»£ç è´¨é‡å’Œå®‰å…¨è§„èŒƒå…¨é¢å®æ–½
- âœ… å¼€å‘æœåŠ¡å™¨éªŒè¯é€šè¿‡ï¼Œæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸è¿è¡Œ

**ğŸ“ æœ€æ–°æ›´æ–° (v2.1.0)**ï¼š
- âœ… **è£…é¥°å™¨ä½“ç³»ä¼˜åŒ–**: ç®€åŒ–å“åº”è£…é¥°å™¨ä½¿ç”¨ï¼Œç§»é™¤å†—ä½™çš„ `@ApiKeyAuthResponses()`
- âœ… **å¢å¼ºJWTå“åº”**: `@JwtAuthResponses()` ç°åŒ…å«å®Œæ•´é”™è¯¯å“åº”è¦†ç›–
- âœ… **ç»Ÿä¸€æ ‡å‡†å“åº”**: API Keyè®¤è¯å’Œå…¬å¼€ç«¯ç‚¹ç»Ÿä¸€ä½¿ç”¨ `@ApiStandardResponses()`
- âœ… **å®Œå–„ä½¿ç”¨æŒ‡å—**: æ–°å¢è£…é¥°å™¨å¿«é€Ÿå‚è€ƒè¡¨å’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ
- âœ… **è°ƒè¯•æ”¯æŒ**: æä¾›è£…é¥°å™¨ä½¿ç”¨çš„è°ƒè¯•æŠ€å·§å’Œæœ€ä½³å®è·µ

## 0. å¿«é€Ÿå¼€å§‹

### 0.1 ç¯å¢ƒå‡†å¤‡

åœ¨å¼€å§‹å¼€å‘å‰ï¼Œè¯·ç¡®ä¿å·²å®ŒæˆåŸºç¡€ç¯å¢ƒæ­å»ºï¼ˆè¯¦è§ [CLAUDE.md å¿«é€Ÿå¼€å§‹éƒ¨åˆ†](../CLAUDE.md#quick-start)ï¼‰ï¼š

```bash
# 1. å®‰è£…ä¾èµ–
bun install

# 2. ç¯å¢ƒå˜é‡é…ç½®
export LONGPORT_APP_KEY=your_app_key
export LONGPORT_APP_SECRET=your_app_secret  
export LONGPORT_ACCESS_TOKEN=your_access_token

# 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
bun run dev

# 4. éªŒè¯ç³»ç»Ÿè¿è¡Œ
curl http://localhost:3000/docs  # Swaggeræ–‡æ¡£
```

### 0.2 å¼€å‘å·¥ä½œæµç¨‹

**æ ‡å‡†å¼€å‘æµç¨‹**ï¼š
1. **åˆ›å»ºåŠŸèƒ½åˆ†æ”¯** â†’ `git checkout -b feature/åŠŸèƒ½åç§°`
2. **ç¼–å†™ä»£ç ** â†’ éµå¾ªæœ¬æ–‡æ¡£è§„èŒƒ
3. **ä»£ç è´¨é‡æ£€æŸ¥** â†’ `bun run lint && bun run format`
4. **æœ¬åœ°æµ‹è¯•** â†’ `bun test` (æ³¨æ„ï¼šéƒ¨åˆ†æµ‹è¯•é…ç½®å¯èƒ½éœ€è¦æ›´æ–°)
5. **æäº¤ä»£ç ** â†’ è§„èŒƒçš„commitæ¶ˆæ¯
6. **åˆ›å»ºPR** â†’ ä»£ç å®¡æŸ¥ååˆå¹¶

**å¸¸ç”¨å¼€å‘å‘½ä»¤**ï¼š
```bash
# ä»£ç è´¨é‡æ£€æŸ¥ (æ³¨æ„ï¼šESLinté…ç½®å¯èƒ½éœ€è¦@typescript-eslint/recommendedåŒ…)
bun run lint          # ESLintæ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤
bun run format        # Prettieræ ¼å¼åŒ–
bun run format:check  # æ£€æŸ¥ä»£ç æ ¼å¼

# æµ‹è¯• (åˆè§„æ•´æ”¹åï¼Œéƒ¨åˆ†æµ‹è¯•é…ç½®å¯èƒ½éœ€è¦æ›´æ–°)
bun test              # å•å…ƒæµ‹è¯•
bun test --watch      # ç›‘æ§æ¨¡å¼æµ‹è¯•
bun test --coverage   # è¦†ç›–ç‡æµ‹è¯•

# å¼€å‘å’Œè°ƒè¯•
bun run dev           # å¼€å‘æœåŠ¡å™¨ (æ”¯æŒçƒ­é‡è½½)
bun run start:debug   # è°ƒè¯•æ¨¡å¼
```

### 0.3 é¡¹ç›®æ ¸å¿ƒæ¦‚å¿µ

åœ¨æ·±å…¥å¼€å‘å‰ï¼Œè¯·ç†è§£ä»¥ä¸‹æ ¸å¿ƒæ¦‚å¿µï¼ˆè¯¦ç»†æ¶æ„è§ [CLAUDE.md](../CLAUDE.md#architecture-overview)ï¼‰ï¼š

- **6ç»„ä»¶æ¶æ„**ï¼šReceiver â†’ Symbol Mapper â†’ Data Mapper â†’ Transformer â†’ Storage â†’ Query
- **ä¸‰å±‚è®¤è¯**ï¼šJWTè®¤è¯ï¼ˆç”¨æˆ·ï¼‰+ API Keyè®¤è¯ï¼ˆç¬¬ä¸‰æ–¹ï¼‰+ å…¬å¼€è®¿é—®
- **ç»Ÿä¸€å“åº”æ ¼å¼**ï¼šå…¨å±€æ‹¦æˆªå™¨è‡ªåŠ¨å¤„ç†ï¼Œä¸è¦æ‰‹åŠ¨åŒ…è£…å“åº”
- **èƒ½åŠ›å¯¼å‘è®¾è®¡**ï¼šæ•°æ®æºæŒ‰èƒ½åŠ›ç»„ç»‡ï¼Œè‡ªåŠ¨å‘ç°å’Œæ³¨å†Œ

## 1. é¡¹ç›®æ¶æ„è§„èŒƒ

### 1.1 æ ¸å¿ƒæ¶æ„åŸåˆ™

- **6ç»„ä»¶æ ¸å¿ƒæ¶æ„**ï¼š`receiver`ã€`symbol-mapper`ã€`data-mapper`ã€`transformer`ã€`storage`ã€`query`
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªæ¨¡å—å…·æœ‰ç‹¬ç«‹çš„è´£ä»»è¾¹ç•Œå’Œæ¸…æ™°çš„æ¥å£å®šä¹‰
- **æœåŠ¡å¯¼å‘æ¶æ„**ï¼šä¸šåŠ¡é€»è¾‘å°è£…åœ¨æœåŠ¡å±‚ï¼Œæ§åˆ¶å™¨ä»…è´Ÿè´£è¯·æ±‚å¤„ç†
- **ç­–ç•¥æ¨¡å¼**ï¼šè®¤è¯ã€æ•°æ®è½¬æ¢ç­‰é‡‡ç”¨ç­–ç•¥æ¨¡å¼æ”¯æŒå¤šç§å®ç°
- **ä»“å‚¨æ¨¡å¼**ï¼šæ•°æ®è®¿é—®å±‚ç»Ÿä¸€æŠ½è±¡ï¼Œæ”¯æŒä¸åŒæ•°æ®æº

### 1.2 ç›®å½•ç»“æ„è§„èŒƒ

```
src/
â”œâ”€â”€ core/                           # æ ¸å¿ƒä¸šåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ [module-name]/              # æ¨¡å—ç›®å½•
â”‚   â”‚   â”œâ”€â”€ [module].controller.ts  # æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ [module].service.ts     # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ [module].module.ts      # æ¨¡å—å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ dto/                    # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts            # å¯¼å‡ºç´¢å¼•
â”‚   â”‚   â”‚   â”œâ”€â”€ create-[entity].dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ update-[entity].dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ [entity]-query.dto.ts
â”‚   â”‚   â”‚   â””â”€â”€ [entity]-response.dto.ts
â”‚   â”‚   â”œâ”€â”€ schemas/                # æ•°æ®åº“æ¨¡å¼
â”‚   â”‚   â”‚   â””â”€â”€ [entity].schema.ts
â”‚   â”‚   â””â”€â”€ repositories/           # ä»“å‚¨å±‚
â”‚   â”‚       â””â”€â”€ [entity].repository.ts
â”œâ”€â”€ auth/                           # è®¤è¯æˆæƒæ¨¡å—
â”œâ”€â”€ common/                         # å…±äº«ç»„ä»¶
â”‚   â”œâ”€â”€ dto/                        # é€šç”¨DTO
â”‚   â”œâ”€â”€ decorators/                 # è‡ªå®šä¹‰è£…é¥°å™¨
â”‚   â”œâ”€â”€ interceptors/               # æ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ filters/                    # 
â”‚   â”œâ”€â”€ interfaces/                 # æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ config/                      # 
â”‚   â””â”€â”€ constants/                  # å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ utils   /                   # 
â”œâ”€â”€ providers/                      # å¤–éƒ¨æœåŠ¡æä¾›å•†
â”œâ”€â”€ monitoring/                     # ç›‘æ§æ¨¡å—
â”œâ”€â”€ security/                       # å®‰å…¨æ¨¡å—
â””â”€â”€ config/                         # é…ç½®æ–‡ä»¶
```

## 2. å‘½åè§„èŒƒ

### 2.1 æ–‡ä»¶å‘½å

- **æ¨¡å—æ–‡ä»¶**ï¼š`kebab-case`
  - æ§åˆ¶å™¨ï¼š`module-name.controller.ts`
  - æœåŠ¡ï¼š`module-name.service.ts`
  - DTOï¼š`entity-name.dto.ts`
  - æ¥å£ï¼š`entity-name.interface.ts`

### 2.2 ç±»å‘½å

- **ç±»å**ï¼š`PascalCase`
  - æ§åˆ¶å™¨ï¼š`EntityNameController`
  - æœåŠ¡ï¼š`EntityNameService`
  - DTOï¼š`CreateEntityNameDto`ã€`UpdateEntityNameDto`ã€`EntityNameResponseDto`
  - æ¥å£ï¼š`IEntityName`

### 2.3 æ–¹æ³•å’Œå˜é‡å‘½å

- **æ–¹æ³•/å˜é‡**ï¼š`camelCase`
- **å¸¸é‡**ï¼š`SCREAMING_SNAKE_CASE`
- **æšä¸¾**ï¼š`PascalCase` æšä¸¾åï¼Œ`SCREAMING_SNAKE_CASE` æšä¸¾å€¼

### 2.4 æ•°æ®ç±»å‹å’Œèƒ½åŠ›å‘½åè§„èŒƒ â­

> **é‡è¦**ï¼šæœ¬èŠ‚å®šä¹‰äº†ç³»ç»Ÿæ ¸å¿ƒçš„æ•°æ®ç±»å‹å’Œèƒ½åŠ›å‘½åè§„èŒƒï¼Œæ˜¯æ·»åŠ æ–°åŠŸèƒ½æ—¶å¿…é¡»éµå¾ªçš„æ ‡å‡†ã€‚

#### 2.4.1 åˆ†å±‚å‘½åæ¶æ„

ç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚å‘½åæ¶æ„ï¼Œç¡®ä¿ç”¨æˆ·æ¥å£ç®€æ´ã€å†…éƒ¨é€»è¾‘æ¸…æ™°ï¼š

```typescript
// ğŸ¯ å­—æ®µè¯­ä¹‰å››å±‚æ¶æ„ç¤ºä¾‹ï¼ˆæ¶ˆé™¤é€šç”¨dataTypeæ··æ·†ï¼‰
{
  // Receiverå±‚ - èƒ½åŠ›è·¯ç”±
  receiverType: "get-stock-quote",     // ç”¨äºæä¾›å•†èƒ½åŠ›è·¯ç”±å’ŒåŒ¹é…

  // Data Mapper/Transformerå±‚ - æ˜ å°„è§„åˆ™ç±»å‹
  transDataRuleListType: "quote_fields",     // ç”¨äºå­—æ®µæ˜ å°„è§„åˆ™åˆ†ç±»å’ŒæŸ¥æ‰¾

  // Storageå±‚ - æ•°æ®åˆ†ç±»
  storageClassification: "stock_quote",    // ç”¨äºæ•°æ®å­˜å‚¨åˆ†ç±»å’Œæ£€ç´¢

  // Queryå±‚ - æ•°æ®è¿‡æ»¤
  queryTypeFilter: "get-stock-quote",    // ç”¨äºæŸ¥è¯¢æ—¶çš„æ•°æ®ç±»å‹è¿‡æ»¤
  
  // å­˜å‚¨é”® (ç»„åˆå¤šä¸ªè¯­ä¹‰å±‚)
  storageKey: "get-stock-quote:longport:AAPL:US"
}
```

#### 2.4.2 å‘½åæ ¼å¼çº¦å®š

**é‡è¦**: ç³»ç»Ÿä½¿ç”¨ç»Ÿä¸€çš„å‘½åæ ¼å¼çº¦å®šï¼š

- **èƒ½åŠ›è·¯ç”±å±‚** (`receiverType`): ä½¿ç”¨ `kebab-case` (è¿å­—ç¬¦åˆ†éš”) - "get-stock-quote"
- **æ˜ å°„è§„åˆ™å±‚** (`transDataRuleListType`): ä½¿ç”¨ `snake_case` (ä¸‹åˆ’çº¿åˆ†éš”) - "quote_fields"  
- **å­˜å‚¨åˆ†ç±»å±‚** (`storageClassification`): ä½¿ç”¨ `snake_case` (ä¸‹åˆ’çº¿åˆ†éš”) - "stock_quote"
- **æŸ¥è¯¢è¿‡æ»¤å±‚** (`queryTypeFilter`): çµæ´»æ ¼å¼ï¼Œé€šå¸¸æ²¿ç”¨èƒ½åŠ›åç§°æ ¼å¼

#### 2.4.3 å‘½åè§„èŒƒå¯¹ç…§è¡¨

| æ•°æ®ç±»å‹ | Receiverå±‚<br>`receiverType` | Data Mapperå±‚<br>`transDataRuleListType` | Storageå±‚<br>`storageClassification` | Queryå±‚<br>`queryTypeFilter` | æ–‡ä»¶å |
|---------|--------------------------------|------------------------------------|------------------------------------|------------------------------|---------|
| è‚¡ç¥¨æŠ¥ä»· | `get-stock-quote` | `quote_fields` | `stock_quote` | `get-stock-quote` | `get-stock-quote.ts` |
| æŒ‡æ•°æŠ¥ä»· | `get-index-quote` | `index_fields` | `index_quote` | `get-index-quote` | `get-index-quote.ts` |
| è‚¡ç¥¨ä¿¡æ¯ | `get-stock-basic-info` | `basic_info_fields` | `company_profile` | `get-stock-basic-info` | `get-stock-basic-info.ts` |
| å¸‚åœºçŠ¶æ€ | `get-market-status` | `market_status_fields` | `market_status` | `get-market-status` | `get-market-status.ts` |

#### 2.4.4 èƒ½åŠ›æ–‡ä»¶å‘½åè§„èŒƒ

**æ–‡ä»¶å‘½åæ¨¡å¼**ï¼š`get-{data-type}.ts`

```typescript
// âœ… æ­£ç¡®çš„èƒ½åŠ›æ–‡ä»¶å‘½å
src/providers/longport/capabilities/
â”œâ”€â”€ get-stock-quote.ts           // è‚¡ç¥¨æŠ¥ä»·èƒ½åŠ›
â”œâ”€â”€ get-stock-basic-info.ts      // è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯èƒ½åŠ›
â”œâ”€â”€ get-index-quote.ts           // æŒ‡æ•°æŠ¥ä»·èƒ½åŠ›
â”œâ”€â”€ get-market-status.ts         // å¸‚åœºçŠ¶æ€èƒ½åŠ›
â””â”€â”€ get-trading-days.ts          // äº¤æ˜“æ—¥èƒ½åŠ›

// âŒ é”™è¯¯çš„å‘½åæ–¹å¼
â”œâ”€â”€ stock-quote.ts               // ç¼ºå°‘åŠ¨ä½œå‰ç¼€
â”œâ”€â”€ stockQuote.ts                // ä½¿ç”¨camelCase
â”œâ”€â”€ get_stock_quote.ts           // ä½¿ç”¨snake_case
â””â”€â”€ getStockQuote.ts             // ä½¿ç”¨camelCase
```

#### 2.4.5 èƒ½åŠ›å®šä¹‰è§„èŒƒ

**èƒ½åŠ›å¯¹è±¡å‘½å**ï¼šä½¿ç”¨ `camelCase` å¯¼å‡ºå˜é‡åï¼Œ`name` å­—æ®µä½¿ç”¨ `kebab-case`

```typescript
// âœ… æ ‡å‡†çš„èƒ½åŠ›å®šä¹‰æ¨¡æ¿
import { ICapability } from "@common/interfaces";
import { MARKETS } from "@common/constants";

/**
 * {Provider} {DataType} è·å–èƒ½åŠ›
 * æ³¨æ„ï¼šæ­¤å‡½æ•°éœ€è¦ä¸ {Provider}ContextService é…åˆä½¿ç”¨
 */
export const getStockQuote: ICapability = {
  name: "get-stock-quote",                    // âœ… ä½¿ç”¨kebab-case
  description: "è·å–è‚¡ç¥¨å®æ—¶æŠ¥ä»·æ•°æ®",
  supportedMarkets: [MARKETS.HK, MARKETS.US, MARKETS.SZ, MARKETS.SH],
  supportedSymbolFormats: ["700.HK", "AAPL.US", "000001.SZ", "600000.SH"],
  rateLimit: {
    requestsPerSecond: 10,
    requestsPerDay: 10000,
  },

  async execute(params: {
    symbols: string[];
    contextService?: any;
  }): Promise<any> {
    try {
      console.log("è°ƒç”¨ {Provider} SDK è·å–{æ•°æ®ç±»å‹}:", params.symbols);

      // å®ç°å…·ä½“çš„APIè°ƒç”¨é€»è¾‘
      // ...

      return result;
    } catch (error) {
      throw new Error(`{Provider} è·å–{æ•°æ®ç±»å‹}å¤±è´¥: ${error.message}`);
    }
  },
};

export default getStockQuote;  // âœ… é»˜è®¤å¯¼å‡º
```

#### 2.4.6 å­—æ®µè¯­ä¹‰æ˜ å°„è§„èŒƒ

**å››å±‚å­—æ®µæ˜ å°„é…ç½®**ï¼š

```typescript
// âœ… å­—æ®µè¯­ä¹‰å››å±‚æ¶æ„æ˜ å°„
import { FIELD_MAPPING_CONFIG } from '@common/types/field-naming.types';

// Receiverå±‚å¤„ç†èƒ½åŠ›è·¯ç”±
private processCapability(receiverType: string): string {
  // receiverType ç”¨äºèƒ½åŠ›è·¯ç”±å’ŒåŒ¹é…
  // å¦‚: "get-stock-quote", "get-stock-basic-info", "get-index-quote"
  return receiverType;
}

// Data Mapper/Transformerå±‚å¤„ç†æ˜ å°„è§„åˆ™æŸ¥æ‰¾
private findMappingRule(provider: string, transDataRuleListType: string) {
  // transDataRuleListType ç”¨äºæŸ¥æ‰¾å­—æ®µæ˜ å°„è§„åˆ™
  // å¦‚: "quote_fields", "basic_info_fields", "index_fields"
  return this.dataMapperService.findBestMatchingRule(provider, transDataRuleListType);
}

// Storageå±‚å¤„ç†æ•°æ®åˆ†ç±»
private storeData(data: any, storageClassification: string) {
  // storageClassification ç”¨äºæ•°æ®å­˜å‚¨åˆ†ç±»
  // å¦‚: "stock_quote", "company_profile", "index_quote"
  return this.storageService.store(data, { classification: storageClassification });
}

// Queryå±‚å¤„ç†æ•°æ®è¿‡æ»¤
private queryData(symbols: string[], queryTypeFilter?: string) {
  // queryTypeFilter ç”¨äºæŸ¥è¯¢æ—¶çš„æ•°æ®ç±»å‹è¿‡æ»¤ï¼ˆQueryå±‚è¯­ä¹‰ï¼‰
  // å¯ä»¥ä½¿ç”¨ä»»æ„ä¸Šè¿°ç±»å‹çš„å­—ç¬¦ä¸²å€¼
  return this.queryService.execute({ symbols, queryTypeFilter });
}

// æ”¯æŒçš„èƒ½åŠ›ç±»å‹å¸¸é‡
export const SUPPORTED_CAPABILITY_TYPES = [
  "get-stock-quote",
  "get-stock-basic-info", 
  "get-index-quote",
  "get-market-status",
  "get-trading-days",
  // æ·»åŠ æ–°èƒ½åŠ›ç±»å‹æ—¶åœ¨æ­¤å¤„æ‰©å±•
] as const;

// æ˜ å°„è§„åˆ™ç±»å‹å¸¸é‡
export const DATA_RULE_LIST_TYPES = [
  "quote_fields",
  "basic_info_fields",
  "index_fields", 
  "market_status_fields",
  // æ·»åŠ æ–°æ˜ å°„è§„åˆ™ç±»å‹æ—¶åœ¨æ­¤å¤„æ‰©å±•
] as const;
```

#### 2.4.7 å­˜å‚¨åˆ†ç±»è§„èŒƒ

**StorageClassification æšä¸¾å®šä¹‰**ï¼š

```typescript
// âœ… å­˜å‚¨åˆ†ç±»ä½¿ç”¨snake_caseæ ¼å¼
export enum StorageClassification {
  STOCK_QUOTE = "stock_quote",
  STOCK_CANDLE = "stock_candle",
  STOCK_TICK = "stock_tick",
  FINANCIAL_STATEMENT = "financial_statement",
  COMPANY_PROFILE = "company_profile",
  MARKET_NEWS = "market_news",
  TRADING_ORDER = "trading_order",
  USER_PORTFOLIO = "user_portfolio",
  GENERAL = "general",
}
```

#### 2.4.8 é¢„è®¾å­—æ®µé…ç½®è§„èŒƒ

**æ•°æ®æ˜ å°„è§„åˆ™ç±»å‹**ï¼š

```typescript
// âœ… é¢„è®¾å­—æ®µé…ç½®å‘½å (ä½¿ç”¨snake_case)
{
  provider: "preset",
  transDataRuleListType: "quote_fields",             // å­—æ®µæ˜ å°„è§„åˆ™ç±»å‹
  // å…¶ä»–ç¤ºä¾‹ï¼š
  // transDataRuleListType: "basic_info_fields",     // åŸºæœ¬ä¿¡æ¯å­—æ®µ
  // transDataRuleListType: "index_fields",          // æŒ‡æ•°å­—æ®µ
  // transDataRuleListType: "market_status_fields",  // å¸‚åœºçŠ¶æ€å­—æ®µ
}
```

#### 2.4.9 æ·»åŠ æ–°æ•°æ®ç±»å‹çš„æ ‡å‡†æµç¨‹

å½“éœ€è¦æ·»åŠ æ–°çš„æ•°æ®ç±»å‹æ—¶ï¼Œè¯·æŒ‰ä»¥ä¸‹**å››å±‚æ¶æ„**æ“ä½œï¼š

1. **å®šä¹‰Receiverå±‚èƒ½åŠ›ç±»å‹**
   ```typescript
   // ä¾‹å¦‚ï¼šget-crypto-quoteï¼ˆåŠ å¯†è´§å¸æŠ¥ä»·èƒ½åŠ›ï¼‰
   // æ–‡ä»¶ï¼šsrc/providers/{provider}/capabilities/get-crypto-quote.ts
   export const getCryptoQuote: ICapability = {
     name: "get-crypto-quote",  // receiverType å€¼
     // ...
   };
   ```

2. **å®šä¹‰Data Mapperå±‚æ˜ å°„è§„åˆ™ç±»å‹**
   ```typescript
   // æ–‡ä»¶ï¼šsrc/core/data-mapper/constants/data-mapper.constants.ts
   export const SUPPORTED_DATA_RULE_LIST_TYPES = [
     // ç°æœ‰ç±»å‹...
     "crypto_quote_fields",  // transDataRuleListTypeå€¼ (snake_case)
   ] as const;
   ```

3. **å®šä¹‰Storageå±‚æ•°æ®åˆ†ç±»**
   ```typescript
   // æ–‡ä»¶ï¼šsrc/common/types/field-naming.types.ts
   export enum StorageClassification {
     // ç°æœ‰åˆ†ç±»...
     CRYPTO_QUOTE = "crypto_quote",  // storageClassification å€¼ (snake_case)
   }
   ```

4. **æ›´æ–°å­—æ®µæ˜ å°„é…ç½®**
   ```typescript
   // æ–‡ä»¶ï¼šsrc/common/types/field-naming.types.ts
   export const FIELD_MAPPING_CONFIG = {
     CAPABILITY_TO_CLASSIFICATION: {
       // ç°æœ‰æ˜ å°„...
       "get-crypto-quote": StorageClassification.CRYPTO_QUOTE,
     },
     RULE_TYPE_TO_CLASSIFICATION: {
       // ç°æœ‰æ˜ å°„...
       "crypto_quote_fields": StorageClassification.CRYPTO_QUOTE,
     }
   } as const;
   ```

5. **åˆ›å»ºé¢„è®¾å­—æ®µæ˜ å°„è§„åˆ™**ï¼ˆå¦‚éœ€è¦ï¼‰
   ```typescript
   // æ–‡ä»¶ï¼šsrc/scripts/auto-init-on-startup.service.ts
   // æ·»åŠ æ–°çš„å­—æ®µæ˜ å°„è§„åˆ™åˆå§‹åŒ–é€»è¾‘
   private async initCryptoQuotePresetFields() {
     // è‡ªåŠ¨åˆ›å»ºcrypto_quote_fieldsç±»å‹çš„æ˜ å°„è§„åˆ™
   }
   ```

6. **æ›´æ–°èƒ½åŠ›ç±»å‹å¸¸é‡**
   ```typescript  
   // æ–‡ä»¶ï¼šsrc/core/receiver/constants/receiver.constants.ts
   export const SUPPORTED_CAPABILITY_TYPES = [
     // ç°æœ‰ç±»å‹...
     "get-crypto-quote",
   ] as const;
   ```

#### 2.4.10 å­—æ®µè¯­ä¹‰å››å±‚æ¶æ„éªŒè¯æ¸…å•

åœ¨æ·»åŠ æ–°æ•°æ®ç±»å‹æ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ¸…å•éªŒè¯å››å±‚æ¶æ„è§„èŒƒï¼š

**Receiverå±‚ (èƒ½åŠ›è·¯ç”±)**ï¼š
- [ ] **æ–‡ä»¶å**ï¼šä½¿ç”¨ `get-{data-type}.ts` æ ¼å¼
- [ ] **èƒ½åŠ›åç§°**ï¼š`name` å­—æ®µä½¿ç”¨ `get-{data-type}` æ ¼å¼ (kebab-case)
- [ ] **å¯¼å‡ºå˜é‡**ï¼šä½¿ç”¨ `camelCase`ï¼Œå¦‚ `getCryptoQuote`
- [ ] **DTOå­—æ®µ**ï¼š`receiverType` ä½¿ç”¨ `get-{data-type}` æ ¼å¼

**Data Mapper/Transformerå±‚ (æ˜ å°„è§„åˆ™)**ï¼š
- [ ] **æ˜ å°„è§„åˆ™ç±»å‹**ï¼š`transDataRuleListType` ä½¿ç”¨ `{type}_fields` æ ¼å¼ (snake_case)
- [ ] **å¸¸é‡å®šä¹‰**ï¼šåœ¨ `SUPPORTED_DATA_RULE_LIST_TYPES` ä¸­æ·»åŠ 
- [ ] **Schemaå­—æ®µ**ï¼šæ•°æ®åº“ä¸­ä½¿ç”¨ç›¸åŒçš„ `transDataRuleListType` å€¼

**Storageå±‚ (æ•°æ®åˆ†ç±»)**ï¼š
- [ ] **åˆ†ç±»æšä¸¾**ï¼šåœ¨ `StorageClassification` ä¸­ä½¿ç”¨ `{TYPE}` æ ¼å¼ (UPPER_SNAKE_CASE)
- [ ] **åˆ†ç±»å€¼**ï¼šæšä¸¾å€¼ä½¿ç”¨ `{type}` æ ¼å¼ (snake_case)
- [ ] **DTOå­—æ®µ**ï¼š`storageClassification` ä½¿ç”¨åˆ†ç±»æšä¸¾å€¼

**Queryå±‚ (æ•°æ®è¿‡æ»¤)**ï¼š
- [ ] **è¿‡æ»¤å­—æ®µ**ï¼š`queryTypeFilter` å¯çµæ´»ä½¿ç”¨ä¸Šè¿°ä»»æ„æ ¼å¼
- [ ] **é€šå¸¸ä½¿ç”¨**ï¼šæ²¿ç”¨Receiverå±‚çš„èƒ½åŠ›åç§°æ ¼å¼

**æ˜ å°„é…ç½®**ï¼š
- [ ] **æ˜ å°„å…³ç³»**ï¼šåœ¨ `FIELD_MAPPING_CONFIG` ä¸­æ·»åŠ å››å±‚æ˜ å°„
- [ ] **ç±»å‹å®‰å…¨**ï¼šç¡®ä¿ TypeScript ç±»å‹å®šä¹‰æ­£ç¡®
- [ ] **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°ç›¸å…³APIæ–‡æ¡£å’Œå¼€å‘æŒ‡å—

#### 2.4.11 å¸¸è§é”™è¯¯å’Œé¿å…æ–¹æ³•

**âŒ å¸¸è§é”™è¯¯**ï¼š

1. **æ··æ·†ä¸åŒç»„ä»¶çš„å­—æ®µè¯­ä¹‰**
   ```typescript
   // é”™è¯¯ï¼šåœ¨Storageç»„ä»¶ä¸­ä½¿ç”¨èƒ½åŠ›åç§°
   storageClassification: "get-stock-quote" // åº”è¯¥æ˜¯ "stock_quote"
   
   // é”™è¯¯ï¼šåœ¨Data Mapperä¸­ä½¿ç”¨èƒ½åŠ›åç§°
   transDataRuleListType: "get-stock-quote" // åº”è¯¥æ˜¯ "quote_fields"
   ```

2. **ä½¿ç”¨è¿‡æ—¶çš„é€šç”¨dataTypeå­—æ®µ**
   ```typescript
   // é”™è¯¯ï¼šä»ç„¶ä½¿ç”¨é€šç”¨çš„dataTypeå­—æ®µ
   interface RequestDto {
     dataType: string; // å·²åºŸå¼ƒï¼Œåº”æ˜ç¡®ä½¿ç”¨å››å±‚æ¶æ„ä¸­çš„å…·ä½“å­—æ®µ
   }
   ```

3. **å‘½åæ ¼å¼ä¸ä¸€è‡´**
   ```typescript
   // é”™è¯¯ï¼šåœ¨snake_caseåœºæ™¯ä½¿ç”¨kebab-case
   transDataRuleListType: "quote-fields" // åº”è¯¥æ˜¯ "quote_fields"
   
   // é”™è¯¯ï¼šåœ¨kebab-caseåœºæ™¯ä½¿ç”¨snake_case  
   receiverType: "get_stock_quote" // åº”è¯¥æ˜¯ "get-stock-quote"
   ```

**âœ… æ­£ç¡®åšæ³•**ï¼š

1. **æ˜ç¡®å­—æ®µè¯­ä¹‰**
   ```typescript
   // Receiverå±‚ - èƒ½åŠ›è·¯ç”±
   interface DataRequestDto {
     receiverType: string; // "get-stock-quote"
   }
   
   // Data Mapperå±‚ - æ˜ å°„è§„åˆ™
   interface DataMappingRule {
     transDataRuleListType: string; // "quote_fields"  
   }
   
   // Storageå±‚ - æ•°æ®åˆ†ç±»
   interface StorageDocument {
     storageClassification: string; // "stock_quote"
   }
   
   // Queryå±‚ - æ•°æ®è¿‡æ»¤
   interface QueryRequestDto {
     queryTypeFilter?: string; // å¯çµæ´»ä½¿ç”¨ä»»æ„æ ¼å¼
   }
   ```

2. **ä½¿ç”¨ç»Ÿä¸€çš„æ˜ å°„é…ç½®**
   ```typescript
   // é€šè¿‡FIELD_MAPPING_CONFIGç¡®ä¿å››å±‚è¯­ä¹‰ä¸€è‡´æ€§  
   import { FIELD_MAPPING_CONFIG } from '@common/types/field-naming.types';
   
   const storageClassification = FIELD_MAPPING_CONFIG.CAPABILITY_TO_CLASSIFICATION[receiverType];
   ```

2. **ä¿æŒå››å±‚æ¶æ„ä¸€è‡´æ€§**
   ```typescript
   // æ–‡ä»¶åã€èƒ½åŠ›åç§°ã€å­—æ®µè¯­ä¹‰ä¿æŒå¯¹åº”å…³ç³»
   // æ–‡ä»¶ï¼šget-stock-quote.ts
   // èƒ½åŠ›ï¼šname: "get-stock-quote"
   // Receiver APIï¼šreceiverType: "get-stock-quote"
   // Data Mapperï¼štransDataRuleListType: "quote_fields"
   // Storageï¼šstorageClassification : "stock_quote"
   // Queryï¼šqueryTypeFilter: "get-stock-quote" (é€šå¸¸æ²¿ç”¨èƒ½åŠ›åç§°)
   ```

3. **å®Œæ•´æ›´æ–°**
   ```typescript
   // æ·»åŠ æ–°ç±»å‹æ—¶åŒæ—¶æ›´æ–°æ‰€æœ‰ç›¸å…³æ–‡ä»¶
   ```

#### 2.4.12 è‡ªåŠ¨å‘ç°æœºåˆ¶

ç³»ç»Ÿçš„èƒ½åŠ›è‡ªåŠ¨å‘ç°æœºåˆ¶åŸºäºæ–‡ä»¶åå·¥ä½œï¼š

```typescript
// CapabilityRegistryService è‡ªåŠ¨å‘ç°é€»è¾‘
private async loadCapability(providerName: string, capabilityName: string) {
  // 1. æ ¹æ®èƒ½åŠ›åç§°åŠ è½½å¯¹åº”æ–‡ä»¶
  const capabilityModule = await import(`./${providerName}/capabilities/${capabilityName}`);

  // 2. è·å–èƒ½åŠ›å¯¹è±¡ï¼ˆæ–‡ä»¶åå¿…é¡»ä¸èƒ½åŠ›åç§°åŒ¹é…ï¼‰
  const capability: ICapability = capabilityModule.default || capabilityModule[capabilityName];

  // 3. æ³¨å†Œèƒ½åŠ›
  this.capabilities.get(providerName)!.set(capability.name, registration);
}
```

**å…³é”®è¦æ±‚**ï¼š
- æ–‡ä»¶åå¿…é¡»ä¸èƒ½åŠ›åç§°å®Œå…¨åŒ¹é…
- èƒ½åŠ›å¯¹è±¡çš„ `name` å­—æ®µå¿…é¡»ä¸æ–‡ä»¶åä¸€è‡´
- æ”¯æŒé»˜è®¤å¯¼å‡ºæˆ–å‘½åå¯¼å‡º

è¿™å¥—å‘½åè§„èŒƒç¡®ä¿äº†ï¼š
- **ç”¨æˆ·å‹å¥½**ï¼šAPIæ¥å£ç®€æ´æ˜“ç”¨
- **è¯­ä¹‰æ¸…æ™°**ï¼šå†…éƒ¨é€»è¾‘è¡¨è¾¾æ˜ç¡®çš„åŠ¨ä½œæ„å›¾
- **è‡ªåŠ¨å‘ç°**ï¼šæ–‡ä»¶åä¸èƒ½åŠ›åç§°åŒ¹é…ï¼Œæ”¯æŒé›¶é…ç½®
- **å¯æ‰©å±•æ€§**ï¼šæ–°å¢æ•°æ®ç±»å‹éµå¾ªç»Ÿä¸€æ¨¡å¼
- **ä¸€è‡´æ€§**ï¼šæ•´ä¸ªç³»ç»Ÿä½¿ç”¨ç»Ÿä¸€çš„å‘½åæ ‡å‡†

## 3. æ§åˆ¶å™¨å¼€å‘è§„èŒƒ

### 3.1 åŸºç¡€ç»“æ„æ¨¡æ¿

```typescript
import { Controller, Post, Get, Body, Param, Query, Logger, HttpStatus } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';
import { Auth, ApiKeyAuth, Public } from '../auth/decorators/auth.decorator';
import { RequirePermissions } from '../auth/decorators/permissions.decorator';
import { ValidationPipe } from '@nestjs/common';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„é€šç”¨è£…é¥°å™¨
import {
  ApiSuccessResponse,
  ApiCreatedResponse,
  ApiPaginatedResponse,
  ApiStandardResponses,
  JwtAuthResponses,
  ApiHealthResponse,
  PermissionResponses
} from '@common/decorators/swagger-responses.decorator';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„é€šç”¨å“åº” DTO
import { ApiResponseDto, ErrorResponseDto, PaginatedResponseDto } from '@common/dto/common-response.dto';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„é€šç”¨ç±»å‹
import { RequestId, Timestamp } from '@common/types/common.types';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„é€šç”¨å¸¸é‡
import { DataType } from '@common/constants/data-type.constants';
import { MARKETS } from '@common/constants/markets.constants';
import { PROVIDERS } from '@common/constants/providers.constants';

@ApiTags('æ¨¡å—åç§°')
@Controller('api/v1/endpoint')
export class ExampleController {
  // ğŸ¯ å¤ç”¨ common æ¨¡å—çš„æ—¥å¿—é…ç½®
  private readonly logger = new Logger(ExampleController.name);

  constructor(private readonly exampleService: ExampleService) {}

  @ApiKeyAuth() // æˆ– @Auth() ç”¨äºJWTè®¤è¯
  @Post()
  @ApiOperation({
    summary: 'æ“ä½œæè¿°',
    description: 'è¯¦ç»†çš„æ“ä½œè¯´æ˜ï¼ŒåŒ…æ‹¬ä¸šåŠ¡é€»è¾‘å’Œä½¿ç”¨åœºæ™¯'
  })
  @ApiCreatedResponse({
    description: 'åˆ›å»ºæˆåŠŸ',
    type: ApiResponseDto, // ğŸ¯ ä½¿ç”¨é€šç”¨å“åº”DTOç±»å‹
    schema: {
      example: {
        statusCode: 201,
        message: 'æ“ä½œæˆåŠŸ',
        data: { /* å…·ä½“å“åº”æ•°æ®ç¤ºä¾‹ */ },
        timestamp: '2024-01-01T12:00:00.000Z'
      }
    }
  })
  @ApiStandardResponses() // ğŸ¯ ä½¿ç”¨é€šç”¨é”™è¯¯å“åº”è£…é¥°å™¨
  async createExample(
    @Body(ValidationPipe) createDto: CreateExampleDto
  ): Promise<ExampleResponseDto> { // ğŸ¯ æ˜ç¡®è¿”å›ç±»å‹
    this.logger.log(`API è¯·æ±‚: ${createDto.name}`, {
      operation: 'createExample',
      data: createDto
    });

    try {
      // ğŸ¯ åˆè§„æ ‡å‡†ï¼šç›´æ¥è¿”å›ä¸šåŠ¡æ•°æ®ï¼Œè®© ResponseInterceptor è‡ªåŠ¨å¤„ç†æ ¼å¼åŒ–
      return await this.exampleService.create(createDto);
    } catch (error) {
      this.logger.error(`æ“ä½œå¤±è´¥: ${error.message}`, {
        operation: 'createExample',
        error: error.stack,
        input: createDto
      });
      throw error; // ğŸ¯ è®©å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨å¤„ç†é”™è¯¯æ ¼å¼åŒ–
    }
  }
}
```

### 3.2 æ§åˆ¶å™¨ç¼–å†™æ ‡å‡†

#### å¿…é¡»éµå®ˆçš„è§„åˆ™

1. **å“åº”æ ¼å¼ç»Ÿä¸€**ï¼šæ‰€æœ‰APIè¿”å›ç»Ÿä¸€çš„å“åº”æ ¼å¼ï¼ˆç”±å…¨å±€`ResponseInterceptor`è‡ªåŠ¨å¤„ç†ï¼‰
```typescript
{
  statusCode: number;    // HTTPçŠ¶æ€ç 
  message: string;       // ä¸­æ–‡æˆåŠŸ/é”™è¯¯æ¶ˆæ¯
  data: T | null;        // å®é™…å“åº”æ•°æ®
  timestamp: string;     // ISOæ—¶é—´æˆ³
  requestId?: string;    // å¯é€‰çš„è¯·æ±‚è·Ÿè¸ªID
}
```

2. **ğŸš¨ é‡è¦ï¼šå“åº”æ ¼å¼åˆè§„**
   - **ç¦æ­¢æ‰‹åŠ¨åŒ…è£…å“åº”** - è®©`ResponseInterceptor`æ‹¦æˆªå™¨è‡ªåŠ¨å¤„ç†
   - **ç›´æ¥è¿”å›æ•°æ®** - æ§åˆ¶å™¨æ–¹æ³•ç›´æ¥è¿”å›ä¸šåŠ¡æ•°æ®æˆ–DTO
   - **ä½¿ç”¨ä¸­æ–‡æ¶ˆæ¯** - é”™è¯¯å’ŒæˆåŠŸæ¶ˆæ¯å¿…é¡»ä½¿ç”¨ä¸­æ–‡
   
   ```typescript
   // âœ… æ­£ç¡®åšæ³•
   async create(@Body() dto: CreateDto) {
     return await this.service.create(dto); // æ‹¦æˆªå™¨è‡ªåŠ¨åŒ…è£…
   }
   
   // âŒ é”™è¯¯åšæ³•
   async create(@Body() dto: CreateDto) {
     const data = await this.service.create(dto);
     return { statusCode: 201, message: 'åˆ›å»ºæˆåŠŸ', data }; // ä¸è¦æ‰‹åŠ¨åŒ…è£…
   }
   ```

3. **è®¤è¯è£…é¥°å™¨æ ‡å‡†åŒ–**ï¼šä½¿ç”¨ç»Ÿä¸€çš„è®¤è¯è£…é¥°å™¨
4. **Swaggeræ–‡æ¡£å®Œæ•´**ï¼šæ¯ä¸ªç«¯ç‚¹å¿…é¡»æœ‰è¯¦ç»†çš„APIæ–‡æ¡£
5. **ç»“æ„åŒ–æ—¥å¿—è®°å½•**ï¼šè®°å½•å…³é”®æ“ä½œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯

#### è®¤è¯è£…é¥°å™¨ä½¿ç”¨è§„èŒƒ

```typescript
// JWTè®¤è¯ï¼ˆç”¨æˆ·ä¸ªäººè´¦æˆ·ç®¡ç†ï¼‰
@Auth([UserRole.ADMIN])           // ç®¡ç†å‘˜æƒé™
@Auth()                           // ç™»å½•ç”¨æˆ·æƒé™
@Auth([UserRole.DEVELOPER])       // å¼€å‘è€…æƒé™

// API Keyè®¤è¯ï¼ˆç¬¬ä¸‰æ–¹åº”ç”¨å’Œç³»ç»Ÿç®¡ç†ï¼‰
@ApiKeyAuth([Permission.DATA_READ])     // ç¬¬ä¸‰æ–¹APIè®¿é—®
@ApiKeyAuth([Permission.SYSTEM_ADMIN])  // ç³»ç»Ÿç®¡ç†åŠŸèƒ½

// å…¬å¼€è®¿é—®
@Public()                         // æ— éœ€è®¤è¯
```

### 3.3 Swaggeræ–‡æ¡£è§„èŒƒ

```typescript
@ApiOperation({ 
  summary: 'ç®€æ´çš„æ“ä½œæè¿°ï¼ˆä¸­æ–‡ï¼‰',
  description: 'è¯¦ç»†è¯´æ˜æ“ä½œçš„ä¸šåŠ¡é€»è¾‘ã€å‚æ•°è¦æ±‚ã€è¿”å›å†…å®¹ç­‰'
})

// ä½¿ç”¨æ ‡å‡†å“åº”è£…é¥°å™¨
@ApiSuccessResponse({
  description: 'æ“ä½œæˆåŠŸ',
  type: ResponseDto,  // æŒ‡å®šå“åº”DTOç±»å‹
  schema: {
    example: {
      statusCode: 200,
      message: 'æ“ä½œæˆåŠŸ',
      data: { /* çœŸå®çš„å“åº”æ•°æ®ç¤ºä¾‹ */ },
      timestamp: '2024-01-01T12:00:00.000Z'
    }
  }
})

@ApiStandardResponses()  // åŒ…å«400ã€401ã€403ã€404ã€429ã€500ç­‰æ ‡å‡†é”™è¯¯å“åº”
```

### 3.4 æ‰¹é‡æ“ä½œå“åº”è§„èŒƒ â­

ä¸ºç¡®ä¿å¯¹æ‰¹é‡æ“ä½œçš„å¤„ç†ç»“æœæœ‰æ¸…æ™°ã€å¯æ“ä½œçš„åé¦ˆï¼Œæ‰€æœ‰æ‰¹é‡å¤„ç†æ¥å£åº”éµå¾ªä»¥ä¸‹å“åº”æ ¼å¼ã€‚

#### 3.4.1 å“åº”æ•°æ®ä½“ (Data Body) æ ¼å¼

æ‰¹é‡æ“ä½œçš„è¿”å›æ•°æ®ä½“åº”åŒ…å« `succeeded` å’Œ `failed` ä¸¤ä¸ªå­—æ®µï¼Œå‡ä¸ºæ•°ç»„ï¼Œåˆ†åˆ«è®°å½•æ“ä½œæˆåŠŸå’Œå¤±è´¥çš„IDåˆ—è¡¨ã€‚

```typescript
// âœ… æ ‡å‡†çš„æ‰¹é‡æ“ä½œå“åº”æ ¼å¼
{
  "succeeded": ["id-1", "id-2", "id-5"],
  "failed": ["id-3", "id-4"]
}
```

**å­—æ®µè¯´æ˜**:
- `succeeded` (`string[]`): æ“ä½œæˆåŠŸçš„IDåˆ—è¡¨ã€‚
- `failed` (`string[]`): æ“ä½œå¤±è´¥çš„IDåˆ—è¡¨ã€‚

#### 3.4.2 ä¼˜ç‚¹

- **æ˜ç¡®æ€§**: `succeeded` å’Œ `failed` è¯­ä¹‰æ¸…æ™°ï¼Œç›´æ¥è¡¨è¾¾äº†æ¯ä¸ªIDçš„æ“ä½œç»“æœã€‚
- **å¯æ“ä½œæ€§**: è°ƒç”¨æ–¹ï¼ˆå‰ç«¯æˆ–å…¶ä»–æœåŠ¡ï¼‰å¯ä»¥ç²¾ç¡®åœ°çŸ¥é“å“ªäº›IDæ“ä½œå¤±è´¥ï¼Œä»è€Œè½»æ¾å®ç°é‡è¯•æˆ–é”™è¯¯å®šä½é€»è¾‘ã€‚
- **å¯æ‰©å±•æ€§**: å¦‚æœæœªæ¥éœ€è¦æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œ`failed` å­—æ®µå¯ä»¥å¹³æ»‘åœ°æ‰©å±•ä¸ºä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œä¾‹å¦‚ï¼š
  ```typescript
  {
    "succeeded": ["id-1", "id-2"],
    "failed": [
      { "id": "id-3", "reason": "Not found" },
      { "id": "id-4", "reason": "Permission denied" }
    ]
  }
  ```

#### 3.4.3 å®ç°ç¤ºä¾‹

```typescript
// src/alert/alert.controller.ts

@Post("batch/acknowledge")
@Auth([UserRole.ADMIN])
@ApiOperation({ summary: "æ‰¹é‡ç¡®è®¤å‘Šè­¦" })
@ApiSuccessResponse({
  description: "æ‰¹é‡ç¡®è®¤å‘Šè­¦å®Œæˆ",
  schema: {
    example: {
      succeeded: ["alert-id-1", "alert-id-2"],
      failed: ["alert-id-3"]
    }
  }
})
@JwtAuthResponses()
async batchAcknowledgeAlerts(
  @Body() body: { alertIds: string[]; acknowledgedBy: string }
): Promise<{ succeeded: string[]; failed: string[] }> {
  const succeeded: string[] = [];
  const failed: string[] = [];

  // ... æ‰¹é‡å¤„ç†é€»è¾‘ ...
  // æ ¹æ®ç»“æœå¡«å…… succeeded å’Œ failed æ•°ç»„

  return { succeeded, failed };
}
```

## 4. æœåŠ¡å±‚å¼€å‘è§„èŒƒ

### 4.1 æœåŠ¡ç»“æ„æ¨¡æ¿

```typescript
import { Injectable, Logger, NotFoundException, ConflictException } from '@nestjs/common';
import { ExampleRepository } from './repositories/example.repository';
import { CreateExampleDto, UpdateExampleDto, ExampleResponseDto } from './dto';
import { Example } from './schemas/example.schema';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„é€šç”¨æ¥å£
import { IDataMapper } from '@common/interfaces/data-mapping.interface';
import { ICapability } from '@common/interfaces/capability.interface';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„é€šç”¨ç±»å‹
import { Market, ProviderName, RequestId } from '@common/types/common.types';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„é€šç”¨å¸¸é‡
import { DataType } from '@common/constants/data-type.constants';
import { MARKETS } from '@common/constants/markets.constants';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„é€šç”¨å·¥å…·
import { HttpHeadersUtil } from '@common/utils/http-headers.util';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„æ—¥å¿—é…ç½®
import { createLogger, sanitizeLogData } from '@common/config/logger.config';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„åˆ†é¡µæœåŠ¡
import { PaginationService } from '@common/modules/pagination/services/pagination.service';
import { PaginatedDataDto } from '@common/modules/pagination/dto/paginated-data';

@Injectable()
export class ExampleService {
  // ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„æ—¥å¿—é…ç½®
  private readonly logger = createLogger(ExampleService.name);

  constructor(
    private readonly exampleRepository: ExampleRepository,
    private readonly relatedService: RelatedService,
    private readonly paginationService: PaginationService, // ğŸ¯ æ³¨å…¥åˆ†é¡µæœåŠ¡
  ) {}

  async create(createDto: CreateExampleDto): Promise<ExampleResponseDto> {
    // ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„æ—¥å¿—è„±æ•åŠŸèƒ½
    this.logger.log(`åˆ›å»ºå®ä½“: ${createDto.name}`, {
      operation: 'create',
      data: sanitizeLogData(createDto) // è‡ªåŠ¨è„±æ•æ•æ„Ÿæ•°æ®
    });

    try {
      // 1. ä¸šåŠ¡é€»è¾‘éªŒè¯
      await this.validateBusinessRules(createDto);

      // 2. æ•°æ®è½¬æ¢å’Œå¤„ç†
      const entityData = this.transformCreateDto(createDto);

      // 3. æ•°æ®åº“æ“ä½œ
      const createdEntity = await this.exampleRepository.create(entityData);

      // 4. è¿”å›å“åº”DTO
      return ExampleResponseDto.fromEntity(createdEntity);
    } catch (error) {
      this.logger.error(`åˆ›å»ºå¤±è´¥: ${error.message}`, {
        operation: 'create',
        error: error.stack,
        input: sanitizeLogData(createDto) // ğŸ¯ é”™è¯¯æ—¥å¿—ä¹Ÿè¦è„±æ•
      });
      throw error;
    }
  }

  async findById(id: string): Promise<ExampleResponseDto> {
    this.logger.debug(`æŸ¥è¯¢å®ä½“: ${id}`);

    const entity = await this.exampleRepository.findById(id);
    if (!entity) {
      // ğŸ¯ ä½¿ç”¨æ ‡å‡†çš„ NestJS å¼‚å¸¸ï¼Œè®©å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨å¤„ç†
      throw new NotFoundException(`å®ä½“ä¸å­˜åœ¨: ${id}`);
    }

    return ExampleResponseDto.fromEntity(entity);
  }

  // ğŸ¯ åˆ†é¡µæŸ¥è¯¢ï¼šä½¿ç”¨PaginationService
  async findPaginated(query: ExampleQueryDto): Promise<PaginatedDataDto<ExampleResponseDto>> {
    const { items, total } = await this.exampleRepository.findPaginated(query);
    const responseItems = items.map(item => ExampleResponseDto.fromDocument(item));
    
    // ä½¿ç”¨åˆ†é¡µæœåŠ¡è‡ªåŠ¨å¤„ç†åˆ†é¡µé€»è¾‘
    return this.paginationService.createPaginatedResponseFromQuery(responseItems, query, total);
  }

  // ğŸ¯ ç¤ºä¾‹ï¼šä½¿ç”¨ common æ¨¡å—çš„é€šç”¨æ¥å£å®ç°æ•°æ®æ˜ å°„
  async processDataWithMapping(
    rawData: any,
    mappingRuleId: string,
    dataMapper: IDataMapper
  ): Promise<any> {
    try {
      return await dataMapper.mapData(rawData, mappingRuleId);
    } catch (error) {
      this.logger.error('æ•°æ®æ˜ å°„å¤±è´¥', {
        operation: 'processDataWithMapping',
        mappingRuleId,
        error: error.message
      });
      throw error;
    }
  }

  // ç§æœ‰è¾…åŠ©æ–¹æ³•
  private async validateBusinessRules(dto: CreateExampleDto): Promise<void> {
    // ğŸ¯ å¯ä»¥ä½¿ç”¨ common æ¨¡å—çš„å¸¸é‡è¿›è¡ŒéªŒè¯
    if (dto.market && !Object.values(MARKETS).includes(dto.market as Market)) {
      throw new ConflictException(`ä¸æ”¯æŒçš„å¸‚åœº: ${dto.market}`);
    }
    // å…¶ä»–ä¸šåŠ¡è§„åˆ™éªŒè¯é€»è¾‘
  }

  private transformCreateDto(dto: CreateExampleDto): Partial<Example> {
    // DTOåˆ°å®ä½“çš„è½¬æ¢é€»è¾‘
    return {
      name: dto.name.trim(),
      // ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„ç±»å‹ç¡®ä¿ç±»å‹å®‰å…¨
      market: dto.market as Market,
      // å…¶ä»–å­—æ®µè½¬æ¢
    };
  }
}
```

### 4.2 æœåŠ¡ç¼–å†™æ ‡å‡†

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæœåŠ¡ä¸“æ³¨äºä¸€ä¸ªä¸šåŠ¡é¢†åŸŸ
2. **ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
3. **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨NestJSæ ‡å‡†å¼‚å¸¸ç±»å‹
4. **æ—¥å¿—è®°å½•**ï¼šè®°å½•å…³é”®æ“ä½œçš„ç»“æ„åŒ–æ—¥å¿—
5. **è¿”å›DTO**ï¼šæœåŠ¡æ–¹æ³•è¿”å›DTOè€Œéå®ä½“å¯¹è±¡
6. **äº‹åŠ¡å¤„ç†**ï¼šæ¶‰åŠå¤šä¸ªæ•°æ®åº“æ“ä½œæ—¶ä½¿ç”¨äº‹åŠ¡
7. **åˆ†é¡µå¤„ç†**ï¼šä½¿ç”¨PaginationServiceç»Ÿä¸€å¤„ç†åˆ†é¡µé€»è¾‘ â­

#### 4.2.1 æ¨¡å—é…ç½®

â­ **é‡è¦**ï¼šåœ¨Moduleçš„`providers`ä¸­æ·»åŠ `PaginationService`

## 5. DTOå¼€å‘è§„èŒƒ

### 5.1 DTOç»“æ„æ¨¡æ¿

```typescript
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsString,
  IsNotEmpty,
  IsOptional,
  IsEnum,
  IsArray,
  ValidateNested,
  MinLength,
  MaxLength,
  IsEmail
} from 'class-validator';
import { Type } from 'class-transformer';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„é€šç”¨ç±»å‹å’Œå¸¸é‡
import { Market, ProviderName } from '@common/types/common.types';
import { StorageClassification } from '@common/types/field-naming.types';
import { MARKETS } from '@common/constants/markets.constants';
import { PROVIDERS } from '@common/constants/providers.constants';

/**
 * åˆ›å»ºå®ä½“DTO
 */
export class CreateExampleDto {
  @ApiProperty({
    description: 'å®ä½“åç§°',
    example: 'ç¤ºä¾‹åç§°',
    minLength: 3,
    maxLength: 50
  })
  @IsString()
  @IsNotEmpty()
  @MinLength(3)
  @MaxLength(50)
  name: string;

  @ApiProperty({
    description: 'å®ä½“ç±»å‹',
    enum: ExampleType,
    example: ExampleType.STANDARD
  })
  @IsEnum(ExampleType)
  type: ExampleType;

  // ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„å¸‚åœºå¸¸é‡
  @ApiPropertyOptional({
    description: 'å¸‚åœºç±»å‹',
    enum: MARKETS,
    example: MARKETS.HK
  })
  @IsOptional()
  @IsEnum(MARKETS, { message: 'ä¸æ”¯æŒçš„å¸‚åœºç±»å‹' })
  market?: Market;

  // ğŸ¯ æ ¹æ®ç»„ä»¶è¯­ä¹‰ä½¿ç”¨ç›¸åº”çš„å­—æ®µ
  // ç¤ºä¾‹ï¼šå¦‚æœè¿™æ˜¯Storageå±‚çš„DTOï¼Œä½¿ç”¨ storageClassification
  @ApiPropertyOptional({
    description: 'æ•°æ®åˆ†ç±»ï¼ˆStorageå±‚è¯­ä¹‰ï¼‰',
    enum: StorageClassification,
    example: StorageClassification.STOCK_QUOTE
  })
  @IsOptional()
  @IsEnum(StorageClassification, { message: 'ä¸æ”¯æŒçš„æ•°æ®åˆ†ç±»' })
  storageClassification?: StorageClassification;
  
  // ç¤ºä¾‹ï¼šå¦‚æœè¿™æ˜¯Receiverå±‚çš„DTOï¼Œä½¿ç”¨ receiverType
  // @ApiPropertyOptional({
  //   description: 'èƒ½åŠ›ç±»å‹ï¼ˆReceiverå±‚è¯­ä¹‰ï¼‰',
  //   example: 'get-stock-quote'
  // })
  // @IsOptional()
  // @IsString()
  // receiverType?: string;

  @ApiPropertyOptional({
    description: 'å¯é€‰æè¿°',
    maxLength: 500
  })
  @IsOptional()
  @IsString()
  @MaxLength(500)
  description?: string;

  @ApiPropertyOptional({
    description: 'æ ‡ç­¾åˆ—è¡¨',
    type: [String]
  })
  @IsOptional()
  @IsArray()
  @IsString({ each: true })
  tags?: string[];

  @ApiPropertyOptional({
    description: 'åµŒå¥—å¯¹è±¡',
    type: NestedDto
  })
  @IsOptional()
  @ValidateNested()
  @Type(() => NestedDto)
  nestedObject?: NestedDto;
}

/**
 * å“åº”å®ä½“DTO
 * ğŸ¯ ç»§æ‰¿æˆ–ä½¿ç”¨ common æ¨¡å—çš„é€šç”¨å“åº”æ ¼å¼
 */
export class ExampleResponseDto {
  @ApiProperty({ description: 'å®ä½“ID' })
  id: string;

  @ApiProperty({ description: 'å®ä½“åç§°' })
  name: string;

  @ApiProperty({ description: 'å®ä½“ç±»å‹', enum: ExampleType })
  type: ExampleType;

  // ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„ç±»å‹
  @ApiPropertyOptional({
    description: 'å¸‚åœºç±»å‹',
    enum: MARKETS
  })
  market?: Market;

  @ApiPropertyOptional({
    description: 'æ•°æ®åˆ†ç±»ï¼ˆæ ¹æ®å®é™…ç»„ä»¶è¯­ä¹‰é€‰æ‹©åˆé€‚å­—æ®µï¼‰',
    enum: StorageClassification
  })
  storageClassification?: StorageClassification;

  @ApiProperty({ description: 'åˆ›å»ºæ—¶é—´' })
  createdAt: Date;

  @ApiProperty({ description: 'æ›´æ–°æ—¶é—´' })
  updatedAt: Date;

  /**
   * ä»å®ä½“å¯¹è±¡åˆ›å»ºå“åº”DTO
   * ğŸ¯ æ ‡å‡†åŒ–çš„å·¥å‚æ–¹æ³•ï¼Œç¡®ä¿æ•°æ®è½¬æ¢ä¸€è‡´æ€§
   */
  static fromEntity(entity: Example): ExampleResponseDto {
    const dto = new ExampleResponseDto();
    dto.id = entity._id?.toString() || entity.id;
    dto.name = entity.name;
    dto.type = entity.type;
    dto.market = entity.market as Market; // ğŸ¯ ç±»å‹å®‰å…¨è½¬æ¢
    dto.storageClassification = entity.storageClassification as StorageClassification;
    dto.createdAt = entity.createdAt;
    dto.updatedAt = entity.updatedAt;
    return dto;
  }

  /**
   * ä»MongoDBæ–‡æ¡£åˆ›å»ºå“åº”DTO
   * ğŸ¯ å¤„ç†æ•°æ®åº“æ–‡æ¡£çš„æ ‡å‡†åŒ–æ–¹æ³•
   */
  static fromDocument(doc: any): ExampleResponseDto {
    const dto = new ExampleResponseDto();
    dto.id = doc._id.toString();
    dto.name = doc.name;
    dto.type = doc.type;
    dto.market = doc.market as Market;
    dto.storageClassification = doc.storageClassification as StorageClassification;
    dto.createdAt = doc.createdAt;
    dto.updatedAt = doc.updatedAt;
    return dto;
  }

  /**
   * ğŸ¯ æ‰¹é‡è½¬æ¢æ–¹æ³•ï¼Œæé«˜æ€§èƒ½
   */
  static fromEntities(entities: Example[]): ExampleResponseDto[] {
    return entities.map(entity => this.fromEntity(entity));
  }
}

/**
 * æŸ¥è¯¢å‚æ•°DTO
 * ğŸ¯ æ¨èä½¿ç”¨ PaginationService å¤„ç†åˆ†é¡µé€»è¾‘ï¼Œè€Œéæ‰‹åŠ¨å®ç°
 */
export class ExampleQueryDto {
  @ApiPropertyOptional({ description: 'é¡µç ', minimum: 1, default: 1 })
  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  page?: number = 1;

  @ApiPropertyOptional({ description: 'æ¯é¡µæ•°é‡', minimum: 1, maximum: 100, default: 10 })
  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  @Max(100)
  limit?: number = 10;

  @ApiPropertyOptional({ description: 'æœç´¢å…³é”®è¯' })
  @IsOptional()
  @IsString()
  search?: string;

  @ApiPropertyOptional({ description: 'ç±»å‹ç­›é€‰', enum: ExampleType })
  @IsOptional()
  @IsEnum(ExampleType)
  type?: ExampleType;

  // ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„å¸¸é‡è¿›è¡Œç­›é€‰
  @ApiPropertyOptional({
    description: 'å¸‚åœºç­›é€‰',
    enum: MARKETS
  })
  @IsOptional()
  @IsEnum(MARKETS)
  market?: Market;

  @ApiPropertyOptional({
    description: 'æ•°æ®ç±»å‹è¿‡æ»¤å™¨',
    enum: DataType
  })
  @IsOptional()
  @IsEnum(DataType)
  queryTypeFilter?: DataType;
}
```

### 5.2 DTOç¼–å†™æ ‡å‡†

1. **è¯¦ç»†çš„APIæ–‡æ¡£**ï¼šæ¯ä¸ªå­—æ®µéƒ½è¦æœ‰`@ApiProperty`æˆ–`@ApiPropertyOptional`
2. **å®Œæ•´çš„éªŒè¯è§„åˆ™**ï¼šä½¿ç”¨`class-validator`è£…é¥°å™¨è¿›è¡ŒéªŒè¯
3. **ç±»å‹è½¬æ¢**ï¼šä½¿ç”¨`class-transformer`è¿›è¡Œç±»å‹è½¬æ¢
4. **å·¥å‚æ–¹æ³•**ï¼šå“åº”DTOæä¾›`fromEntity`å’Œ`fromDocument`é™æ€æ–¹æ³•
5. **åµŒå¥—éªŒè¯**ï¼šå¤æ‚å¯¹è±¡ä½¿ç”¨`@ValidateNested`å’Œ`@Type`
6. **ä¸­æ–‡æè¿°**ï¼šæ‰€æœ‰æè¿°ä¿¡æ¯ä½¿ç”¨ä¸­æ–‡
7. **ğŸ¯ å¤ç”¨ common æ¨¡å—**ï¼š
   - ä½¿ç”¨ `@common/types` ä¸­çš„é€šç”¨ç±»å‹å®šä¹‰
   - ä½¿ç”¨ `@common/constants` ä¸­çš„æšä¸¾å¸¸é‡
   - ä½¿ç”¨ `@common/interfaces` ä¸­çš„æ¥å£å®šä¹‰
   - ç»§æ‰¿ `@common/dto` ä¸­çš„é€šç”¨å“åº”æ ¼å¼

### 5.3 DTO å¤ç”¨ common æ¨¡å—æœ€ä½³å®è·µ

#### 5.3.1 ç±»å‹å®‰å…¨çš„å¸¸é‡ä½¿ç”¨
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ common æ¨¡å—çš„ç±»å‹å®‰å…¨å¸¸é‡
import { MARKETS } from '@common/constants/markets.constants';
import { DataType } from '@common/constants/data-type.constants';

@IsEnum(MARKETS, { message: 'ä¸æ”¯æŒçš„å¸‚åœºç±»å‹' })
market: Market;

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç æšä¸¾å€¼
@IsEnum(['HK', 'US', 'SZ', 'SH'], { message: 'ä¸æ”¯æŒçš„å¸‚åœºç±»å‹' })
market: string;
```

#### 5.3.2 é€šç”¨æ¥å£çš„å®ç°
```typescript
// âœ… æ­£ç¡®ï¼šå®ç° common æ¨¡å—çš„æ¥å£
import { IDataMappingRule } from '@common/interfaces/data-mapping.interface';

export class DataMappingDto implements IDataMappingRule {
  // å®ç°æ¥å£å®šä¹‰çš„æ‰€æœ‰å­—æ®µ
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ common æ¨¡å—çš„ç±»å‹
import { Market, ProviderName } from '@common/types/common.types';

export class QueryDto {
  @IsEnum(Object.values(MARKETS))
  market: Market;

  @IsEnum(Object.values(PROVIDERS))
  provider: ProviderName;
}
```



#### å“åº” DTO ç±»å‹æ¦‚è§ˆ

ç³»ç»Ÿæä¾›äº†ä¸‰ä¸ªæ ‡å‡†åŒ–çš„å“åº” DTO ç±»ï¼Œä½äº `src/common/dto/common-response.dto.ts`ï¼š

##### 1. ApiResponseDto<T> - æ ‡å‡† API å“åº”æ ¼å¼
```typescript
export class ApiResponseDto<T = any> {
  statusCode: number;    // HTTP çŠ¶æ€ç 
  message: string;       // å“åº”æ¶ˆæ¯
  data?: T;             // å“åº”æ•°æ®ï¼ˆæ³›å‹ï¼‰
  timestamp?: string;    // è¯·æ±‚æ—¶é—´æˆ³
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ‰€æœ‰æ ‡å‡†çš„ API å“åº”
- å•ä¸ªèµ„æºçš„ CRUD æ“ä½œ
- ä¸šåŠ¡é€»è¾‘å¤„ç†ç»“æœ

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
// åœ¨æ§åˆ¶å™¨ä¸­æŒ‡å®šå“åº”ç±»å‹
@ApiSuccessResponse({
  type: ApiResponseDto,
  description: 'è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ'
})
async getUserProfile(): Promise<UserDto> {
  // ç›´æ¥è¿”å›æ•°æ®ï¼ŒResponseInterceptor ä¼šè‡ªåŠ¨åŒ…è£…ä¸º ApiResponseDto æ ¼å¼
  return await this.userService.getProfile();
}
```

##### 2. ErrorResponseDto - é”™è¯¯å“åº”æ ¼å¼
```typescript
export class ErrorResponseDto {
  statusCode: number;           // HTTP çŠ¶æ€ç 
  message: string | string[];   // é”™è¯¯æ¶ˆæ¯
  error: string;               // é”™è¯¯ä»£ç 
  details?: Array<{            // é”™è¯¯è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰
    field: string;
    code: string;
    message: string;
  }>;
  timestamp: string;           // è¯·æ±‚æ—¶é—´æˆ³
  path: string;               // è¯·æ±‚è·¯å¾„
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ‰€æœ‰é”™è¯¯å“åº”ï¼ˆç”±å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨è‡ªåŠ¨å¤„ç†ï¼‰
- å‚æ•°éªŒè¯é”™è¯¯
- ä¸šåŠ¡é€»è¾‘é”™è¯¯
- ç³»ç»Ÿå¼‚å¸¸

**è‡ªåŠ¨å¤„ç†**ï¼š
```typescript
// é”™è¯¯å“åº”ç”±å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œæ— éœ€æ‰‹åŠ¨æ„é€ 
throw new BadRequestException('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
// è‡ªåŠ¨è½¬æ¢ä¸º ErrorResponseDto æ ¼å¼
```

##### 3. PaginatedDataDto<T> - åˆ†é¡µå“åº”æ ¼å¼ â­
```typescript
// ğŸ“‚ ä½ç½®ï¼š@common/modules/pagination/dto/paginated-data
export class PaginatedDataDto<T = unknown> {
  @ApiProperty({ description: "æ•°æ®åˆ—è¡¨" })
  items: T[];

  @ApiProperty({
    description: "åˆ†é¡µä¿¡æ¯",
    example: {
      page: 1,
      limit: 10,
      total: 100,
      totalPages: 10,
      hasNext: true,
      hasPrev: false,
    },
  })
  pagination: {
    page: number;              // å½“å‰é¡µç 
    limit: number;             // æ¯é¡µæ•°é‡
    total: number;             // æ€»è®°å½•æ•°
    totalPages: number;        // æ€»é¡µæ•°
    hasNext: boolean;          // æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
    hasPrev: boolean;          // æ˜¯å¦æœ‰ä¸Šä¸€é¡µ
  };
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- åˆ†é¡µæŸ¥è¯¢ç»“æœ
- åˆ—è¡¨æ•°æ®å±•ç¤º
- æ‰¹é‡æ•°æ®å¤„ç†ç»“æœ

**ä½¿ç”¨æ–¹å¼**ï¼š

1. **Serviceå±‚**ï¼šæ³¨å…¥PaginationServiceï¼Œä½¿ç”¨`createPaginatedResponseFromQuery()`æ–¹æ³•
2. **Repositoryå±‚**ï¼šä½¿ç”¨`normalizePaginationQuery()`å’Œ`calculateSkip()`æ–¹æ³•
3. **Moduleå±‚**ï¼šåœ¨providersä¸­æ³¨å†ŒPaginationService

**æ ¸å¿ƒä½¿ç”¨æ­¥éª¤**ï¼š
- Repositoryè·å–`{ items, total }`
- Serviceè°ƒç”¨`paginationService.createPaginatedResponseFromQuery(items, query, total)`
- è‡ªåŠ¨è¿”å›æ ‡å‡†åŒ–çš„PaginatedDataDtoæ ¼å¼

#### DTO ä½¿ç”¨æœ€ä½³å®è·µ

##### 1. å“åº”ç±»å‹å£°æ˜
```typescript
// âœ… æ­£ç¡®ï¼šæ˜ç¡®æŒ‡å®šå“åº” DTO ç±»å‹
@ApiSuccessResponse({
  type: ApiResponseDto,
  description: 'æ“ä½œæˆåŠŸ',
  schema: {
    example: {
      statusCode: 200,
      message: 'æ“ä½œæˆåŠŸ',
      data: { id: 1, name: 'ç¤ºä¾‹æ•°æ®' },
      timestamp: '2024-01-01T12:00:00.000Z'
    }
  }
})

// âŒ é”™è¯¯ï¼šç¼ºå°‘ç±»å‹å£°æ˜
@ApiSuccessResponse({ description: 'æ“ä½œæˆåŠŸ' })
```

##### 2. æ³›å‹ç±»å‹ä½¿ç”¨
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å…·ä½“çš„æ•°æ®ç±»å‹
@ApiSuccessResponse({
  type: ApiResponseDto<UserDto>,
  description: 'è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ'
})
async getUser(): Promise<UserDto> {
  return await this.userService.findById(id);
}

// âœ… æ­£ç¡®ï¼šæ•°ç»„ç±»å‹
@ApiSuccessResponse({
  type: ApiResponseDto<UserDto[]>,
  description: 'è·å–ç”¨æˆ·åˆ—è¡¨æˆåŠŸ'
})
async getUsers(): Promise<UserDto[]> {
  return await this.userService.findAll();
}
```

##### 3. é”™è¯¯å“åº”å¤„ç†
```typescript
// âœ… æ­£ç¡®ï¼šè®©å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨å¤„ç†
async createUser(@Body() createUserDto: CreateUserDto) {
  try {
    return await this.userService.create(createUserDto);
  } catch (error) {
    // ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè®©å…¨å±€è¿‡æ»¤å™¨æ ¼å¼åŒ–ä¸º ErrorResponseDto
    throw new ConflictException('ç”¨æˆ·åå·²å­˜åœ¨');
  }
}

// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨æ„é€ é”™è¯¯å“åº”
async createUser(@Body() createUserDto: CreateUserDto) {
  try {
    return await this.userService.create(createUserDto);
  } catch (error) {
    // ä¸è¦æ‰‹åŠ¨æ„é€  ErrorResponseDto
    return new ErrorResponseDto(409, 'ç”¨æˆ·åå·²å­˜åœ¨', 'Conflict', '/users');
  }
}
```

## 6. æ•°æ®åº“å’Œä»“å‚¨å±‚è§„èŒƒ

### 6.1 Schemaå®šä¹‰è§„èŒƒ

```typescript
import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
import { Document } from 'mongoose';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„ç±»å‹å’Œå¸¸é‡
import { Market, ProviderName } from '@common/types/common.types';
import { DataType } from '@common/constants/data-type.constants';
import { MARKETS } from '@common/constants/markets.constants';
import { PROVIDERS } from '@common/constants/providers.constants';

@Schema({
  timestamps: true,  // è‡ªåŠ¨æ·»åŠ createdAtå’ŒupdatedAt
  collection: 'examples',
})
export class Example {
  @Prop({ required: true, trim: true, minlength: 3, maxlength: 50 })
  name: string;

  @Prop({ required: true, enum: ExampleType })
  type: ExampleType;

  // ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„å¸‚åœºå¸¸é‡
  @Prop({
    enum: Object.values(MARKETS),
    required: false
  })
  market?: Market;

  // ğŸ¯ ä½¿ç”¨å­—æ®µè¯­ä¹‰å››å±‚æ¶æ„ä¸­çš„ç›¸åº”æšä¸¾
  @Prop({
    enum: Object.values(StorageClassification),
    required: false
  })
  storageClassification?: StorageClassification;

  // ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„æä¾›å•†å¸¸é‡
  @Prop({
    enum: Object.values(PROVIDERS),
    required: false
  })
  provider?: ProviderName;

  @Prop({ maxlength: 500 })
  description?: string;

  @Prop({ type: [String], default: [] })
  tags: string[];

  @Prop({ default: true })
  isActive: boolean;

  // æ—¶é—´æˆ³å­—æ®µç”±timestampsé€‰é¡¹è‡ªåŠ¨æ·»åŠ 
  createdAt?: Date;
  updatedAt?: Date;
}

export type ExampleDocument = Example & Document;
export const ExampleSchema = SchemaFactory.createForClass(Example);

// ğŸ¯ ä½¿ç”¨ common æ¨¡å—å¸¸é‡åˆ›å»ºå¤åˆç´¢å¼•
ExampleSchema.index({ name: 1 }, { unique: true });
ExampleSchema.index({ type: 1, isActive: 1 });
ExampleSchema.index({ market: 1, storageClassification: 1 }); // ä¸šåŠ¡æŸ¥è¯¢ä¼˜åŒ–
ExampleSchema.index({ provider: 1, isActive: 1 }); // æä¾›å•†æŸ¥è¯¢ä¼˜åŒ–
ExampleSchema.index({ createdAt: -1 });

// ğŸ¯ æ ‡å‡†åŒ–çš„JSONåºåˆ—åŒ–æ–¹æ³•
ExampleSchema.methods.toJSON = function() {
  const obj = this.toObject();
  obj.id = obj._id.toString();
  delete obj._id;
  delete obj.__v;
  return obj;
};
```

### 6.2 ä»“å‚¨å±‚å®ç°è§„èŒƒ

```typescript
import { Injectable, Logger } from '@nestjs/common';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';
import { Example, ExampleDocument } from '../schemas/example.schema';
import { CreateExampleDto, UpdateExampleDto, ExampleQueryDto } from '../dto';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„ç±»å‹å’Œå·¥å…·
import { Market, ProviderName } from '@common/types/common.types';
import { DataType } from '@common/constants/data-type.constants';
import { MARKETS } from '@common/constants/markets.constants';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„æ—¥å¿—é…ç½®
import { createLogger, sanitizeLogData } from '@common/config/logger.config';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„åˆ†é¡µæœåŠ¡
import { PaginationService } from '@common/modules/pagination/services/pagination.service';

@Injectable()
export class ExampleRepository {
  // ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„æ—¥å¿—é…ç½®
  private readonly logger = createLogger(ExampleRepository.name);

  constructor(
    @InjectModel(Example.name) private readonly exampleModel: Model<ExampleDocument>,
    private readonly paginationService: PaginationService, // ğŸ¯ æ³¨å…¥åˆ†é¡µæœåŠ¡
  ) {}

  async create(createDto: Partial<Example>): Promise<ExampleDocument> {
    // ğŸ¯ ä½¿ç”¨æ—¥å¿—è„±æ•åŠŸèƒ½
    this.logger.debug(`åˆ›å»ºå®ä½“: ${createDto.name}`, {
      operation: 'create',
      data: sanitizeLogData(createDto)
    });

    const entity = new this.exampleModel(createDto);
    return entity.save();
  }

  async findById(id: string): Promise<ExampleDocument | null> {
    this.logger.debug(`æŸ¥è¯¢å®ä½“: ${id}`);

    return this.exampleModel
      .findById(id)
      .where('isActive')
      .equals(true)
      .lean()
      .exec();
  }

  // ğŸ¯ æ”¯æŒå­—æ®µè¯­ä¹‰å››å±‚æ¶æ„çš„æŸ¥è¯¢æ–¹æ³•
  async findByMarketAndClassification(
    market: Market,
    storageClassification: StorageClassification
  ): Promise<ExampleDocument[]> {
    this.logger.debug(`æŒ‰å¸‚åœºå’Œæ•°æ®åˆ†ç±»æŸ¥è¯¢: ${market}, ${storageClassification}`);

    return this.exampleModel
      .find({
        market,
        storageClassification,
        isActive: true
      })
      .sort({ createdAt: -1 })
      .lean()
      .exec();
  }

  // ğŸ¯ åˆ†é¡µæŸ¥è¯¢ï¼šä½¿ç”¨PaginationService
  async findPaginated(query: ExampleQueryDto): Promise<{ items: ExampleDocument[]; total: number }> {
    // æ ‡å‡†åŒ–åˆ†é¡µå‚æ•°å¹¶è®¡ç®—skip
    const { page, limit } = this.paginationService.normalizePaginationQuery(query);
    const skip = this.paginationService.calculateSkip(page, limit);

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶...
    const filter = { /* æŸ¥è¯¢æ¡ä»¶ */ };

    // å¹¶è¡ŒæŸ¥è¯¢æ•°æ®å’Œæ€»æ•°
    const [items, total] = await Promise.all([
      this.exampleModel.find(filter).skip(skip).limit(limit).lean().exec(),
      this.exampleModel.countDocuments(filter).exec(),
    ]);

    return { items, total };
  }


  async updateById(id: string, updateDto: Partial<Example>): Promise<ExampleDocument | null> {
    this.logger.debug(`æ›´æ–°å®ä½“: ${id}`);
    
    return this.exampleModel
      .findByIdAndUpdate(id, updateDto, { new: true })
      .where('isActive')
      .equals(true)
      .lean()
      .exec();
  }

  async deleteById(id: string): Promise<boolean> {
    this.logger.debug(`åˆ é™¤å®ä½“: ${id}`);
    
    const result = await this.exampleModel
      .findByIdAndUpdate(id, { isActive: false }, { new: true })
      .exec();
    
    return !!result;
  }

  async existsByName(name: string, excludeId?: string): Promise<boolean> {
    const filter: any = { name, isActive: true };
    
    if (excludeId) {
      filter._id = { $ne: excludeId };
    }

    const count = await this.exampleModel.countDocuments(filter).exec();
    return count > 0;
  }
}
```

### 6.3 æ•°æ®åº“è®¾è®¡æ ‡å‡†

1. **Schemaè®¾è®¡**ï¼šä½¿ç”¨TypeScriptç±»å®šä¹‰ï¼Œå¯ç”¨æ—¶é—´æˆ³
2. **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
3. **è½¯åˆ é™¤**ï¼šä½¿ç”¨`isActive`å­—æ®µå®ç°è½¯åˆ é™¤
4. **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä½¿ç”¨`.lean()`è·å¾—æ›´å¥½çš„æ€§èƒ½
5. **äº‹åŠ¡æ”¯æŒ**ï¼šå¤æ‚æ“ä½œä½¿ç”¨MongoDBäº‹åŠ¡
6. **ç¡¬ç¼–ç ID**ï¼šæ ¸å¿ƒæ•°æ®ä½¿ç”¨é¢„å®šä¹‰çš„ObjectId
7. **ğŸ¯ å¤ç”¨ common æ¨¡å—æ ‡å‡†**ï¼š
   - ä½¿ç”¨ `@common/types` ä¸­çš„ç±»å‹å®šä¹‰ç¡®ä¿ç±»å‹å®‰å…¨
   - ä½¿ç”¨ `@common/constants` ä¸­çš„æšä¸¾å€¼ä½œä¸ºSchemaçº¦æŸ
   - ä½¿ç”¨ `@common/config/logger.config` è¿›è¡Œæ—¥å¿—è®°å½•å’Œè„±æ•
   - å®ç° `@common/interfaces` ä¸­å®šä¹‰çš„æ•°æ®æ¥å£

### 6.4 æ•°æ®åº“å¤ç”¨ common æ¨¡å—æœ€ä½³å®è·µ

#### 6.4.1 ç±»å‹å®‰å…¨çš„Schemaå®šä¹‰
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ common æ¨¡å—çš„ç±»å‹çº¦æŸ
import { MARKETS } from '@common/constants/markets.constants';

@Prop({
  enum: Object.values(MARKETS),
  validate: {
    validator: (v: string) => Object.values(MARKETS).includes(v as Market),
    message: 'ä¸æ”¯æŒçš„å¸‚åœºç±»å‹'
  }
})
market: Market;

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç æšä¸¾å€¼
@Prop({ enum: ['HK', 'US', 'SZ', 'SH'] })
market: string;
```

#### 6.4.2 ç»Ÿä¸€çš„æŸ¥è¯¢æ–¹æ³•
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ common æ¨¡å—ç±»å‹çš„æŸ¥è¯¢æ–¹æ³•
async findByBusinessCriteria(
  market: Market,
  storageClassification: DataType,
  provider: ProviderName
): Promise<ExampleDocument[]> {
  return this.exampleModel
    .find({ market, storageClassification, provider, isActive: true })
    .lean()
    .exec();
}

// âœ… æ­£ç¡®ï¼šå®ç° common æ¥å£çš„æŸ¥è¯¢æ–¹æ³•
async findByCapabilityName(capabilityName: string): Promise<ExampleDocument[]> {
  // ä½¿ç”¨ common æ¨¡å—çš„èƒ½åŠ›æ¥å£æ ‡å‡†
  return this.exampleModel
    .find({
      capabilityName,
      isActive: true
    })
    .lean()
    .exec();
}
```

## 7. é”™è¯¯å¤„ç†å’Œå“åº”è§„èŒƒ

### 7.1 å¼‚å¸¸å¤„ç†æ ‡å‡†

```typescript
import {
  BadRequestException,
  NotFoundException,
  ConflictException,
  UnauthorizedException,
  ForbiddenException,
  InternalServerErrorException
} from '@nestjs/common';
// ğŸ¯ å¤ç”¨ common æ¨¡å—çš„ç±»å‹å’Œå¸¸é‡
import { Market, ProviderName } from '@common/types/common.types';
import { DataType } from '@common/constants/data-type.constants';
import { MARKETS } from '@common/constants/markets.constants';

// ğŸ¯ ä½¿ç”¨ common æ¨¡å—å¸¸é‡è¿›è¡ŒéªŒè¯çš„å¼‚å¸¸å¤„ç†
if (!entity) {
  throw new NotFoundException(`å®ä½“ä¸å­˜åœ¨: ${id}`);
}

if (await this.repository.existsByName(dto.name)) {
  throw new ConflictException(`åç§°å·²å­˜åœ¨: ${dto.name}`);
}

if (!user.hasPermission(action)) {
  throw new ForbiddenException('æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œ');
}

// ğŸ¯ ä½¿ç”¨ common æ¨¡å—å¸¸é‡è¿›è¡Œä¸šåŠ¡éªŒè¯
if (dto.market && !Object.values(MARKETS).includes(dto.market as Market)) {
  throw new BadRequestException(`ä¸æ”¯æŒçš„å¸‚åœºç±»å‹: ${dto.market}`);
}

if (dto.storageClassification && !Object.values(StorageClassification).includes(dto.storageClassification)) {
  throw new BadRequestException(`ä¸æ”¯æŒçš„æ•°æ®åˆ†ç±»: ${dto.storageClassification}`);
}
```

### 7.2 è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸

```typescript
import { HttpException, HttpStatus } from '@nestjs/common';

export class BusinessException extends HttpException {
  constructor(
    message: string,
    code: string,
    statusCode: HttpStatus = HttpStatus.BAD_REQUEST,
    details?: any
  ) {
    super(
      {
        message,
        code,
        details,
        timestamp: new Date().toISOString()
      },
      statusCode
    );
  }
}

// ä½¿ç”¨ç¤ºä¾‹
throw new BusinessException(
  'ä¸šåŠ¡è§„åˆ™éªŒè¯å¤±è´¥',
  'BUSINESS_RULE_VIOLATION',
  HttpStatus.UNPROCESSABLE_ENTITY,
  { field: 'amount', constraint: 'minimum_value' }
);
```

### 7.3 å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨

ğŸ¯ ç³»ç»Ÿå·²å®ç°å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ï¼ˆ`@common/filters/global-exception.filter.ts`ï¼‰ï¼Œç¡®ä¿æ‰€æœ‰é”™è¯¯å“åº”æ ¼å¼ä¸€è‡´ï¼š

```typescript
{
  statusCode: number;
  message: string | string[];
  error: string;
  details?: Array<{ field: string; code: string; message: string }>;
  timestamp: string;
  path: string;
}
```

#### 7.3.1 å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ç‰¹æ€§

ğŸ¯ **å¤ç”¨ common æ¨¡å—çš„å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨æä¾›ä»¥ä¸‹åŠŸèƒ½**ï¼š

1. **ç»Ÿä¸€é”™è¯¯æ ¼å¼**ï¼šæ‰€æœ‰å¼‚å¸¸è‡ªåŠ¨è½¬æ¢ä¸º `ErrorResponseDto` æ ¼å¼
2. **æ™ºèƒ½å¼‚å¸¸è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«MongoDBã€JWTã€éªŒè¯ç­‰ä¸åŒç±»å‹å¼‚å¸¸
3. **ä¸­æ–‡é”™è¯¯æ¶ˆæ¯**ï¼šè‡ªåŠ¨ç¿»è¯‘å¸¸è§é”™è¯¯ä¸ºä¸­æ–‡
4. **æ•æ„Ÿä¿¡æ¯è„±æ•**ï¼šä½¿ç”¨ `@common/config/logger.config` çš„è„±æ•åŠŸèƒ½
5. **ç»“æ„åŒ–æ—¥å¿—**ï¼šä½¿ç”¨ `@common/utils/http-headers.util` æå–è¯·æ±‚ä¿¡æ¯
6. **ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–**ï¼šç”Ÿäº§ç¯å¢ƒä¸‹éšè—æ•æ„Ÿçš„é”™è¯¯è¯¦æƒ…

#### 7.3.2 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ

```typescript
// âœ… æ­£ç¡®ï¼šè®©å…¨å±€è¿‡æ»¤å™¨å¤„ç†å¼‚å¸¸æ ¼å¼åŒ–
try {
  return await this.service.processData(data);
} catch (error) {
  // ç›´æ¥æŠ›å‡ºï¼Œè®©å…¨å±€è¿‡æ»¤å™¨å¤„ç†
  throw error;
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ ‡å‡†NestJSå¼‚å¸¸
if (!isValidMarket(dto.market)) {
  throw new BadRequestException(`ä¸æ”¯æŒçš„å¸‚åœº: ${dto.market}`);
}

// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨æ„é€ é”™è¯¯å“åº”
try {
  return await this.service.processData(data);
} catch (error) {
  return {
    statusCode: 500,
    message: 'å¤„ç†å¤±è´¥',
    error: 'InternalServerError'
  };
}
```

## 8. è®¤è¯å’Œæˆæƒè§„èŒƒ

ç³»ç»Ÿä½¿ç”¨ä¸‰å±‚è®¤è¯ä½“ç³»ï¼Œå…·ä½“çš„æƒé™å®šä¹‰å’Œè®¤è¯æœºåˆ¶è¯·å‚è€ƒï¼š
- **æƒé™ç³»ç»Ÿæ¶æ„**: è¯¦è§ [ç³»ç»ŸåŸºæœ¬æ¶æ„å’Œè¯´æ˜æ–‡æ¡£.md](./ç³»ç»ŸåŸºæœ¬æ¶æ„å’Œè¯´æ˜æ–‡æ¡£.md#ä¸‰å±‚è®¤è¯ä½“ç³»)
- **API Keyç®¡ç†**: è¯¦è§ [apikey-management.md](./apikey-management.md)

### 8.1 è®¤è¯è£…é¥°å™¨ä½¿ç”¨

#### JWTè®¤è¯ç¤ºä¾‹
```typescript
// ç®¡ç†å‘˜åŠŸèƒ½
@Auth([UserRole.ADMIN])
@Get('profile')
@ApiOperation({ summary: 'è·å–ç”¨æˆ·ä¿¡æ¯' })
@ApiSuccessResponse({ type: UserResponseDto })
@JwtAuthResponses()
async getProfile() {}
```

#### API Keyè®¤è¯ç¤ºä¾‹
```typescript
// ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®
@ApiKeyAuth()
@RequirePermissions(Permission.DATA_READ)
@Post('receiver/data')
@ApiOperation({ summary: 'è·å–è‚¡ç¥¨æ•°æ®' })
@ApiSuccessResponse({ type: DataResponseDto })
@ApiStandardResponses()
async getData() {}
```

#### å…¬å¼€è®¿é—®ç¤ºä¾‹
```typescript
@Public()
@Get('health')
@ApiOperation({ summary: 'å¥åº·æ£€æŸ¥' })
@ApiHealthResponse()
async getHealth() {}
```

## 9. æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—è§„èŒƒ

### 9.1 æ—¥å¿—è®°å½•æ ‡å‡†

ğŸ¯ **å¼ºçƒˆå»ºè®®ä½¿ç”¨ common æ¨¡å—çš„æ—¥å¿—é…ç½®**ï¼š

```typescript
// ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„æ—¥å¿—é…ç½®
import { createLogger, sanitizeLogData, LoggerConfig } from '@common/config/logger.config';

export class ExampleService {
  // ğŸ¯ ä½¿ç”¨ common æ¨¡å—åˆ›å»ºæ—¥å¿—å®ä¾‹
  private readonly logger = createLogger(ExampleService.name);

  async processData(data: any, user: any) {
    const startTime = Date.now();

    // ğŸ¯ ä¿¡æ¯æ—¥å¿— - è‡ªåŠ¨è„±æ•æ•æ„Ÿæ•°æ®
    this.logger.log('æ“ä½œæˆåŠŸ', {
      operation: 'processData',
      userId: user.id,
      duration: Date.now() - startTime,
      data: sanitizeLogData(data) // è‡ªåŠ¨è„±æ•
    });

    try {
      // ä¸šåŠ¡é€»è¾‘
    } catch (error) {
      // ğŸ¯ é”™è¯¯æ—¥å¿— - è‡ªåŠ¨è„±æ•è¾“å…¥æ•°æ®
      this.logger.error('æ“ä½œå¤±è´¥', {
        operation: 'processData',
        error: error.message,
        stack: error.stack,
        input: sanitizeLogData(data) // è‡ªåŠ¨è„±æ•
      });
      throw error;
    }
  }

  // ğŸ¯ è°ƒè¯•æ—¥å¿—
  debugOperation(details: any) {
    this.logger.debug('è°ƒè¯•ä¿¡æ¯', {
      details: sanitizeLogData(details)
    });
  }

  // ğŸ¯ æ€§èƒ½è­¦å‘Šæ—¥å¿—
  checkPerformance(operation: string, duration: number) {
    if (duration > 1000) {
      this.logger.warn('æ€§èƒ½è­¦å‘Š', {
        operation,
        duration,
        threshold: 1000
      });
    }
  }
}
```

#### 9.1.1 æ—¥å¿—è„±æ•åŠŸèƒ½

ğŸ¯ **common æ¨¡å—æä¾›è‡ªåŠ¨è„±æ•åŠŸèƒ½**ï¼Œä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼š

```typescript
import { sanitizeLogData, LoggerConfig } from '@common/config/logger.config';

// è‡ªåŠ¨è„±æ•çš„æ•æ„Ÿå­—æ®µ
const sensitiveData = {
  username: 'john_doe',
  password: 'secret123',
  accessToken: 'eyJhbGciOiJIUzI1NiIs...',
  apiKey: 'ak_1234567890abcdef'
};

// è„±æ•åçš„æ•°æ®
const sanitized = sanitizeLogData(sensitiveData);
// ç»“æœ: { username: 'john_doe', password: '****', accessToken: 'ey****ef', apiKey: 'ak****ef' }
```

#### 9.1.2 æ—¥å¿—é…ç½®å¸¸é‡

```typescript
// ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„æ—¥å¿—é…ç½®
import { LoggerConfig } from '@common/config/logger.config';

// æœ€å¤§æ—¥å¿—æ¶ˆæ¯é•¿åº¦
if (message.length > LoggerConfig.MAX_MESSAGE_LENGTH) {
  message = message.substring(0, LoggerConfig.MAX_MESSAGE_LENGTH) + '...';
}

// æ•æ„Ÿå­—æ®µåˆ—è¡¨
const isSensitive = LoggerConfig.SENSITIVE_FIELDS.some(field =>
  key.toLowerCase().includes(field)
);
```

### 9.2 æ€§èƒ½ç›‘æ§

ğŸ¯ **ç³»ç»Ÿä½¿ç”¨ common æ¨¡å—çš„æ‹¦æˆªå™¨è¿›è¡Œæ€§èƒ½ç›‘æ§**ï¼š

#### 9.2.1 ResponseInterceptorï¼ˆå“åº”æ‹¦æˆªå™¨ï¼‰
ä½ç½®ï¼š`@common/interceptors/response.interceptor.ts`

**åŠŸèƒ½**ï¼š
- è‡ªåŠ¨åŒ…è£…æ‰€æœ‰å“åº”ä¸ºæ ‡å‡†æ ¼å¼
- è·³è¿‡å¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡ç«¯ç‚¹
- æä¾›ç»Ÿä¸€çš„å“åº”æ—¶é—´æˆ³
- ç»“æ„åŒ–æ—¥å¿—è®°å½•

**ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
// å…¨å±€æ³¨å†Œï¼ˆå·²åœ¨ main.ts ä¸­é…ç½®ï¼‰
app.useGlobalInterceptors(new ResponseInterceptor());

// æ§åˆ¶å™¨ä¸­æ— éœ€ç‰¹æ®Šå¤„ç†ï¼Œç›´æ¥è¿”å›æ•°æ®
@Get('users')
async getUsers(): Promise<UserDto[]> {
  return await this.userService.findAll(); // è‡ªåŠ¨åŒ…è£…ä¸ºæ ‡å‡†å“åº”æ ¼å¼
}
```

#### 9.2.2 æ€§èƒ½ç›‘æ§æœ€ä½³å®è·µ

```typescript
// âœ… æ­£ç¡®ï¼šè®©æ‹¦æˆªå™¨è‡ªåŠ¨å¤„ç†å“åº”æ ¼å¼
@Get('data')
async getData(): Promise<DataDto[]> {
  const startTime = Date.now();

  try {
    const result = await this.dataService.fetchData();

    // è®°å½•æ€§èƒ½æŒ‡æ ‡
    const duration = Date.now() - startTime;
    if (duration > 1000) {
      this.logger.warn('æ…¢æŸ¥è¯¢æ£€æµ‹', { duration, operation: 'getData' });
    }

    return result; // æ‹¦æˆªå™¨è‡ªåŠ¨åŒ…è£…
  } catch (error) {
    this.logger.error('æŸ¥è¯¢å¤±è´¥', {
      operation: 'getData',
      duration: Date.now() - startTime,
      error: error.message
    });
    throw error;
  }
}

// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨åŒ…è£…å“åº”
@Get('data')
async getData() {
  const result = await this.dataService.fetchData();
  return {
    statusCode: 200,
    message: 'è·å–æˆåŠŸ',
    data: result,
    timestamp: new Date().toISOString()
  }; // ä¸è¦æ‰‹åŠ¨åŒ…è£…
}
```

### 9.3 å¥åº·æ£€æŸ¥

ğŸ¯ **ä½¿ç”¨ common æ¨¡å—çš„æ ‡å‡†å¥åº·æ£€æŸ¥æ ¼å¼**ï¼š

```typescript
import { Public } from '@auth/decorators/auth.decorator';
import { ApiHealthResponse } from '@common/decorators/swagger-responses.decorator';

@Public()
@Get('health')
@ApiOperation({ summary: 'ç³»ç»Ÿå¥åº·æ£€æŸ¥' })
@ApiHealthResponse() // ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„å¥åº·æ£€æŸ¥å“åº”è£…é¥°å™¨
async healthCheck() {
  return {
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    version: '1.0.0',
    environment: process.env.NODE_ENV || 'development',
    // ğŸ¯ å¯ä»¥æ·»åŠ æ›´å¤šç³»ç»ŸçŠ¶æ€ä¿¡æ¯
    memory: {
      used: Math.round(process.memoryUsage().heapUsed / 1024 / 1024),
      total: Math.round(process.memoryUsage().heapTotal / 1024 / 1024)
    }
  };
}

// ğŸ¯ é«˜çº§å¥åº·æ£€æŸ¥ï¼ˆåŒ…å«ä¾èµ–æœåŠ¡çŠ¶æ€ï¼‰
@Public()
@Get('health/detailed')
@ApiOperation({ summary: 'è¯¦ç»†å¥åº·æ£€æŸ¥' })
@ApiHealthResponse()
async detailedHealthCheck() {
  const checks = await Promise.allSettled([
    this.checkDatabase(),
    this.checkRedis(),
    this.checkExternalAPIs()
  ]);

  const status = checks.every(check => check.status === 'fulfilled') ? 'ok' : 'error';

  return {
    status,
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    version: '1.0.0',
    environment: process.env.NODE_ENV || 'development',
    checks: {
      database: checks[0].status === 'fulfilled' ? 'ok' : 'error',
      redis: checks[1].status === 'fulfilled' ? 'ok' : 'error',
      externalAPIs: checks[2].status === 'fulfilled' ? 'ok' : 'error'
    }
  };
}
```

## 10. Shared æ¨¡å—å¤ç”¨æŒ‡å— ğŸ¯

### 10.1 Shared æ¨¡å—æ¦‚è§ˆ

ç»è¿‡æ¶æ„ä¼˜åŒ–å’Œä»£ç æ¸…ç†ï¼Œ`src/common` ç›®å½•ç°åœ¨åªåŒ…å«çœŸæ­£è·¨æ¨¡å—å…±äº«çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ä»£ç ã€‚éµå¾ª"æœ€å°å¿…è¦åŸåˆ™"ï¼Œåªä¿ç•™æœ€æ ¸å¿ƒçš„é€šç”¨åŠŸèƒ½ï¼š

```
src/common/
â”œâ”€â”€ config/                     # é€šç”¨é…ç½®
â”‚   â””â”€â”€ logger.config.ts        # æ—¥å¿—é…ç½®å’Œè„±æ•åŠŸèƒ½
â”œâ”€â”€ constants/                  # é€šç”¨å¸¸é‡
â”‚   â””â”€â”€ market.constants.ts     # å¸‚åœºå¸¸é‡å’Œæšä¸¾
â”œâ”€â”€ decorators/                 # é€šç”¨è£…é¥°å™¨
â”‚   â””â”€â”€ swagger-responses.decorator.ts  # Swaggerå“åº”è£…é¥°å™¨
â”œâ”€â”€ dto/                        # é€šç”¨DTO
â”‚   â””â”€â”€ common-response.dto.ts  # æ ‡å‡†å“åº”æ ¼å¼
â”œâ”€â”€ filters/                    # é€šç”¨è¿‡æ»¤å™¨
â”‚   â”œâ”€â”€ global-exception.filter.ts  # å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â””â”€â”€ index.ts                # è¿‡æ»¤å™¨å¯¼å‡º
â”œâ”€â”€ interceptors/               # é€šç”¨æ‹¦æˆªå™¨
â”‚   â”œâ”€â”€ response.interceptor.ts # å“åº”æ ¼å¼åŒ–æ‹¦æˆªå™¨
â”‚   â””â”€â”€ index.ts                # æ‹¦æˆªå™¨å¯¼å‡º
â””â”€â”€ utils/                      # é€šç”¨å·¥å…·
    â””â”€â”€ http-headers.util.ts    # HTTPå¤´å¤„ç†å·¥å…·
```

#### ğŸ¯ æ¶æ„ä¼˜åŒ–è¯´æ˜

**åˆ é™¤çš„å†—ä½™ç»„ä»¶**ï¼š
- `interfaces/` - æ¥å£å®šä¹‰å·²è¿ç§»åˆ°å„è‡ªçš„ä¸šåŠ¡æ¨¡å—ä¸­
- `types/` - ç±»å‹å®šä¹‰å·²è¿ç§»åˆ°å„è‡ªçš„ä¸šåŠ¡æ¨¡å—ä¸­
- `constants/providers.constants.ts` - æœªè¢«ä½¿ç”¨ï¼Œå·²åˆ é™¤
- `constants/data-type.constants.ts` - å·²è¿ç§»åˆ°ä¸šåŠ¡æ¨¡å—ä¸­

**ä¿ç•™åŸåˆ™**ï¼š
1. **çœŸæ­£çš„è·¨æ¨¡å—å…±äº«** - è¢«å¤šä¸ªæ¨¡å—ä½¿ç”¨çš„åŸºç¡€è®¾æ–½
2. **æ ¸å¿ƒåŸºç¡€åŠŸèƒ½** - æ—¥å¿—ã€å¼‚å¸¸å¤„ç†ã€å“åº”æ ¼å¼åŒ–ç­‰
3. **æ¡†æ¶çº§åˆ«çš„ç»„ä»¶** - æ‹¦æˆªå™¨ã€è¿‡æ»¤å™¨ã€è£…é¥°å™¨ç­‰

### 10.2 å¼ºåˆ¶å¤ç”¨è§„èŒƒ

#### 10.2.1 å¯¼å…¥è·¯å¾„æ ‡å‡†åŒ–

**æ‰€æœ‰ç»„ä»¶å¿…é¡»ä½¿ç”¨ `@common` è·¯å¾„åˆ«å**ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨è·¯å¾„åˆ«å
import { Market, MARKETS, MARKET_NAMES } from '@common/constants/market.constants';
import { PaginatedResponseDto } from '@common/dto/common-response.dto';
import { createLogger, sanitizeLogData } from '@common/config/logger.config';
import { HttpHeadersUtil } from '@common/utils/http-headers.util';

// âŒ é”™è¯¯ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„
import { Market } from '../../../common/constants/market.constants';
import { PaginatedResponseDto } from '../../common/dto/common-response.dto';
```

#### 10.2.2 å¸‚åœºå¸¸é‡å¤ç”¨

**å¿…é¡»ä½¿ç”¨ common æ¨¡å—çš„å¸‚åœºå¸¸é‡ï¼Œç¦æ­¢ç¡¬ç¼–ç **ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ common å¸‚åœºå¸¸é‡
import { Market, MARKETS, MARKET_NAMES } from '@common/constants/market.constants';

if (!Object.values(MARKETS).includes(market as Market)) {
  throw new BadRequestException(`ä¸æ”¯æŒçš„å¸‚åœº: ${market}`);
}

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç å¸¸é‡
const supportedMarkets = ['HK', 'US', 'SZ', 'SH'];  // ä¸è¦ç¡¬ç¼–ç 
```

#### 10.2.3 æ—¥å¿—è®°å½•æ ‡å‡†åŒ–

**å¿…é¡»ä½¿ç”¨ common æ¨¡å—çš„æ—¥å¿—é…ç½®ï¼Œç¡®ä¿æ—¥å¿—ä¸€è‡´æ€§å’Œå®‰å…¨æ€§**ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ common æ—¥å¿—é…ç½®
import { createLogger, sanitizeLogData } from '@common/config/logger.config';

export class ExampleService {
  private readonly logger = createLogger(ExampleService.name);

  async processData(data: any): Promise<any> {
    this.logger.log('å¤„ç†æ•°æ®å¼€å§‹', sanitizeLogData({ requestData: data }));
    // ... å¤„ç†é€»è¾‘
  }
}

// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨consoleæˆ–Logger
console.log('å¤„ç†æ•°æ®', data);  // ä¸è¦ç›´æ¥ä½¿ç”¨console
```

### 10.3 ç»„ä»¶çº§å¤ç”¨æŒ‡å—

#### 10.3.1 æ§åˆ¶å™¨å¤ç”¨æ¸…å•

**æ¯ä¸ªæ§åˆ¶å™¨å¿…é¡»å¤ç”¨ä»¥ä¸‹ common ç»„ä»¶**ï¼š

```typescript
// ğŸ¯ æ§åˆ¶å™¨å¤ç”¨æ¸…å•
import { Controller, Get, Post, Body, Query } from '@nestjs/common';
import { ApiTags, ApiOperation } from '@nestjs/swagger';

// âœ… å¿…é¡»å¤ç”¨ï¼šè®¤è¯è£…é¥°å™¨
import { Auth, ApiKeyAuth, Public } from '@auth/decorators/auth.decorator';

// âœ… å¿…é¡»å¤ç”¨ï¼šSwaggerå“åº”è£…é¥°å™¨
import {
  ApiSuccessResponse,
  ApiCreatedResponse,
  ApiPaginatedResponse,
  ApiStandardResponses,
  JwtAuthResponses,
  ApiHealthResponse
} from '@common/decorators/swagger-responses.decorator';

// âœ… å¿…é¡»å¤ç”¨ï¼šé€šç”¨å“åº”DTO
import { PaginatedResponseDto } from '@common/dto/common-response.dto';

// âœ… å¿…é¡»å¤ç”¨ï¼šæ—¥å¿—é…ç½®
import { createLogger } from '@common/config/logger.config';

// âœ… å¿…é¡»å¤ç”¨ï¼šå¸‚åœºå¸¸é‡
import { Market, MARKETS } from '@common/constants/market.constants';

@ApiTags('ç¤ºä¾‹æ¨¡å—')
@Controller('api/v1/examples')
export class ExampleController {
  private readonly logger = createLogger(ExampleController.name);

  @ApiKeyAuth()
  @RequirePermissions(Permission.DATA_READ)
  @Get()
  @ApiOperation({ summary: 'è·å–ç¤ºä¾‹åˆ—è¡¨' })
  @ApiPaginatedResponse(ExampleDto, { description: 'è·å–ç¤ºä¾‹åˆ—è¡¨æˆåŠŸ' })
  @ApiStandardResponses()
  async getExamples(@Query() query: ExampleQueryDto): Promise<PaginatedResponseDto<ExampleDto>> {
    return await this.exampleService.findAll(query);
  }
}
```

#### 10.3.2 æœåŠ¡å±‚å¤ç”¨æ¸…å•

**æ¯ä¸ªæœåŠ¡å¿…é¡»å¤ç”¨ä»¥ä¸‹ common ç»„ä»¶**ï¼š

```typescript
// ğŸ¯ æœåŠ¡å±‚å¤ç”¨æ¸…å•
import { Injectable, NotFoundException, ConflictException } from '@nestjs/common';

// âœ… å¿…é¡»å¤ç”¨ï¼šæ—¥å¿—é…ç½®
import { createLogger, sanitizeLogData } from '@common/config/logger.config';

// âœ… å¿…é¡»å¤ç”¨ï¼šå¸‚åœºå¸¸é‡
import { Market, MARKETS, MARKET_NAMES } from '@common/constants/market.constants';

@Injectable()
export class ExampleService {
  // âœ… å¿…é¡»å¤ç”¨ï¼šshared æ—¥å¿—é…ç½®
  private readonly logger = createLogger(ExampleService.name);

  async processData(data: any): Promise<any> {
    // âœ… å¿…é¡»å¤ç”¨ï¼šæ—¥å¿—è„±æ•
    this.logger.log('å¤„ç†æ•°æ®å¼€å§‹', sanitizeLogData({
      operation: 'processData',
      dataKeys: Object.keys(data)
    }));

    // âœ… å¿…é¡»å¤ç”¨ï¼šå¸‚åœºå¸¸é‡éªŒè¯
    if (data.market && !Object.values(MARKETS).includes(data.market)) {
      throw new ConflictException(`ä¸æ”¯æŒçš„å¸‚åœº: ${data.market}`);
    }

    // å¤„ç†é€»è¾‘...
    const result = await this.doProcess(data);
    
    this.logger.log('å¤„ç†æ•°æ®å®Œæˆ', sanitizeLogData({
      operation: 'processData',
      resultSize: result?.length || 0
    }));

    return result;
  }
}
```

#### 10.3.3 HTTPå¤´å¤„ç†å¤ç”¨

**å¿…é¡»ä½¿ç”¨ common æ¨¡å—çš„HTTPå¤´å¤„ç†å·¥å…·**ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ common HTTPå¤´å·¥å…·
import { HttpHeadersUtil } from '@common/utils/http-headers.util';

@Injectable()
export class ApiKeyService {
  extractApiKeyFromHeaders(request: Request): { appKey?: string; accessToken?: string } {
    // ä½¿ç”¨ç»Ÿä¸€çš„å¤´éƒ¨æå–å·¥å…·
    const appKey = HttpHeadersUtil.extractAppKey(request);
    const accessToken = HttpHeadersUtil.extractAccessToken(request);
    
    return { appKey, accessToken };
  }
}

// âŒ é”™è¯¯ï¼šé‡å¤å®ç°å¤´éƒ¨æå–é€»è¾‘
@Injectable()
export class ApiKeyService {
  extractApiKeyFromHeaders(request: Request): { appKey?: string; accessToken?: string } {
    // ä¸è¦é‡å¤å®ç°è¿™äº›é€»è¾‘
    const appKey = request.headers['x-app-key'] as string;
    const accessToken = request.headers['x-access-token'] as string;
    return { appKey, accessToken };
  }
}
```

### 10.4 æ¨¡å—åŒ–æ¶æ„åŸåˆ™

#### 10.4.1 æ¥å£å’Œç±»å‹å®šä¹‰åŸåˆ™

**æ¥å£å’Œç±»å‹åº”è¯¥å®šä¹‰åœ¨ä½¿ç”¨å®ƒä»¬çš„æ¨¡å—ä¸­**ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šæ¨¡å—å†…éƒ¨æ¥å£å®šä¹‰
// src/core/symbol-mapper/interfaces/symbol-mapping.interface.ts
export interface ISymbolMapper {
  mapSymbol(originalSymbol: string, fromProvider: string, toProvider: string): Promise<string>;
  saveMapping(rule: ISymbolMappingRule): Promise<void>;
  getSymbolMappingRule(provider: string): Promise<IMappingRule[]>;
}

// src/core/symbol-mapper/symbol-mapper.service.ts
import { ISymbolMapper } from "./interfaces/symbol-mapping.interface";

@Injectable()
export class symbolMapperService implements ISymbolMapper {
  // å®ç°æ¥å£æ–¹æ³•...
}

// âŒ é”™è¯¯ï¼šåœ¨sharedä¸­å®šä¹‰åªè¢«å•ä¸ªæ¨¡å—ä½¿ç”¨çš„æ¥å£
// ä¸è¦åœ¨ src/common/interfaces/ ä¸­å®šä¹‰åªè¢«symbol-mapperä½¿ç”¨çš„æ¥å£
```

#### 10.4.2 å¸¸é‡å’Œæšä¸¾åŸåˆ™

**åªæœ‰è¢«å¤šä¸ªæ¨¡å—ä½¿ç”¨çš„å¸¸é‡æ‰æ”¾åœ¨sharedä¸­**ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šçœŸæ­£å…±äº«çš„å¸¸é‡åœ¨sharedä¸­
// src/common/constants/market.constants.ts
export enum Market {
  HK = "HK",
  US = "US", 
  SZ = "SZ",
  SH = "SH"
}

// âœ… æ­£ç¡®ï¼šæ¨¡å—ç‰¹å®šçš„å¸¸é‡åœ¨æ¨¡å—å†…éƒ¨
// src/core/query/enums/data-source-type.enum.ts
export enum DataSourceType {
  CACHE = 'cache',
  PERSISTENT = 'persistent',
  REALTIME = 'realtime'
}

// âŒ é”™è¯¯ï¼šåœ¨sharedä¸­å®šä¹‰åªè¢«å•ä¸ªæ¨¡å—ä½¿ç”¨çš„æšä¸¾
// ä¸è¦å°†DataSourceTypeæ”¾åœ¨sharedä¸­ï¼Œå› ä¸ºå®ƒåªè¢«queryæ¨¡å—ä½¿ç”¨
```

#### 10.4.3 å¤ç”¨åˆ¤æ–­æ ‡å‡†

**åˆ¤æ–­ä»£ç æ˜¯å¦åº”è¯¥æ”¾åœ¨sharedä¸­çš„æ ‡å‡†**ï¼š

1. **ä½¿ç”¨é¢‘ç‡**: è¢«3ä¸ªæˆ–ä»¥ä¸Šæ¨¡å—ä½¿ç”¨
2. **åŠŸèƒ½æ€§è´¨**: åŸºç¡€è®¾æ–½ç±»åŠŸèƒ½ï¼ˆæ—¥å¿—ã€å¼‚å¸¸å¤„ç†ã€å“åº”æ ¼å¼åŒ–ç­‰ï¼‰
3. **ä¸šåŠ¡æ— å…³æ€§**: ä¸å…·ä½“ä¸šåŠ¡é€»è¾‘æ— å…³çš„é€šç”¨åŠŸèƒ½
4. **ç¨³å®šæ€§**: å®šä¹‰ç›¸å¯¹ç¨³å®šï¼Œä¸ä¼šé¢‘ç¹å˜æ›´

```typescript
// âœ… ç¬¦åˆsharedæ ‡å‡†çš„ç»„ä»¶ç¤ºä¾‹ï¼š

// 1. æ—¥å¿—é…ç½® - è¢«æ‰€æœ‰æ¨¡å—ä½¿ç”¨ï¼ŒåŸºç¡€è®¾æ–½ï¼Œä¸šåŠ¡æ— å…³ï¼Œç¨³å®š
import { createLogger } from '@common/config/logger.config';

// 2. å¸‚åœºå¸¸é‡ - è¢«å¤šä¸ªæ¨¡å—ä½¿ç”¨ï¼Œä¸šåŠ¡ç›¸å…³ä½†é€šç”¨ï¼Œç¨³å®š
import { Market, MARKETS } from '@common/constants/market.constants';

// 3. å“åº”æ ¼å¼ - è¢«æ‰€æœ‰æ§åˆ¶å™¨ä½¿ç”¨ï¼ŒåŸºç¡€è®¾æ–½ï¼Œä¸šåŠ¡æ— å…³ï¼Œç¨³å®š
import { PaginatedResponseDto } from '@common/dto/common-response.dto';

// 4. Swaggerè£…é¥°å™¨ - è¢«æ‰€æœ‰æ§åˆ¶å™¨ä½¿ç”¨ï¼ŒåŸºç¡€è®¾æ–½ï¼Œä¸šåŠ¡æ— å…³ï¼Œç¨³å®š
import { ApiStandardResponses } from '@common/decorators/swagger-responses.decorator';

// âŒ ä¸ç¬¦åˆsharedæ ‡å‡†çš„ç»„ä»¶ç¤ºä¾‹ï¼š

// 1. åªè¢«å•ä¸ªæ¨¡å—ä½¿ç”¨çš„æ¥å£
interface ISymbolMapper { ... }  // åº”è¯¥åœ¨symbol-mapperæ¨¡å—ä¸­

// 2. ç‰¹å®šä¸šåŠ¡é€»è¾‘çš„ç±»å‹
interface TransformRequest { ... }  // åº”è¯¥åœ¨transformeræ¨¡å—ä¸­

// 3. æ¨¡å—ç‰¹å®šçš„æšä¸¾
enum QueryType { ... }  // åº”è¯¥åœ¨queryæ¨¡å—ä¸­
```

### 10.5 æ¶æ„æ¸…ç†æˆæœæ€»ç»“



#### 10.5.1 æ ¸å¿ƒåŸåˆ™æ€»ç»“

1. **æœ€å°å¿…è¦åŸåˆ™**: sharedåªåŒ…å«å¿…éœ€çš„å…±äº«ç»„ä»¶
2. **å•ä¸€èŒè´£åŸåˆ™**: æ¯ä¸ªç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½
3. **æ¨¡å—å†…èšåŸåˆ™**: ä¸šåŠ¡ç›¸å…³ä»£ç æ”¾åœ¨å¯¹åº”ä¸šåŠ¡æ¨¡å—ä¸­
4. **ä¾èµ–æ˜ç¡®åŸåˆ™**: æ˜ç¡®åŒºåˆ†æ¡†æ¶åŸºç¡€è®¾æ–½å’Œä¸šåŠ¡é€»è¾‘

#### 10.5.2 å¼€å‘è€…æ£€æŸ¥æ¸…å•

åœ¨å¼€å‘æ–°åŠŸèƒ½æ—¶ï¼Œè¯·æŒ‰ä»¥ä¸‹æ£€æŸ¥æ¸…å•ç¡®ä¿æ­£ç¡®ä½¿ç”¨sharedç»„ä»¶ï¼š

- [ ] **æ—¥å¿—è®°å½•**: ä½¿ç”¨ `createLogger` å’Œ `sanitizeLogData`
- [ ] **å¸‚åœºå¤„ç†**: ä½¿ç”¨ `Market`ã€`MARKETS`ã€`MARKET_NAMES` ç­‰å¸¸é‡
- [ ] **å“åº”æ ¼å¼**: ä½¿ç”¨ `PaginatedResponseDto` ç­‰æ ‡å‡†DTO
- [ ] **APIæ–‡æ¡£**: ä½¿ç”¨sharedçš„Swaggerè£…é¥°å™¨
- [ ] **HTTPå¤´å¤„ç†**: ä½¿ç”¨ `HttpHeadersUtil` å·¥å…·
- [ ] **å¼‚å¸¸å¤„ç†**: ç¡®ä¿å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨æ­£å¸¸å·¥ä½œ
- [ ] **å“åº”æ‹¦æˆª**: ç¡®ä¿å“åº”æ‹¦æˆªå™¨è‡ªåŠ¨æ ¼å¼åŒ–

**é¿å…çš„è¡Œä¸º**ï¼š
- [ ] ä¸è¦åœ¨sharedä¸­æ·»åŠ åªè¢«å•ä¸ªæ¨¡å—ä½¿ç”¨çš„ä»£ç 
- [ ] ä¸è¦é‡å¤å®šä¹‰å·²å­˜åœ¨çš„ç±»å‹æˆ–å¸¸é‡
- [ ] ä¸è¦ç»•è¿‡sharedçš„åŸºç¡€è®¾æ–½ç»„ä»¶
- [ ] ä¸è¦åœ¨ä¸šåŠ¡æ¨¡å—ä¸­é‡æ–°å®ç°é€šç”¨åŠŸèƒ½

### 10.6 DTOå¤ç”¨æ¸…å•

**æ¯ä¸ªDTOå¿…é¡»å¤ç”¨ä»¥ä¸‹ common ç»„ä»¶**ï¼š

```typescript
// ğŸ¯ DTOå¤ç”¨æ¸…å•
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { IsString, IsEnum, IsOptional } from 'class-validator';

// âœ… å¿…é¡»å¤ç”¨ï¼šé€šç”¨ç±»å‹
import { Market, ProviderName } from '@common/types/common.types';

// âœ… å¿…é¡»å¤ç”¨ï¼šé€šç”¨å¸¸é‡
import { DataType } from '@common/constants/data-type.constants';
import { MARKETS } from '@common/constants/markets.constants';
import { PROVIDERS } from '@common/constants/providers.constants';

export class ExampleDto {
  @ApiProperty({ description: 'åç§°' })
  @IsString()
  name: string;

  // âœ… å¿…é¡»å¤ç”¨ï¼šshared æšä¸¾
  @ApiPropertyOptional({
    description: 'å¸‚åœºç±»å‹',
    enum: MARKETS,
    example: MARKETS.HK
  })
  @IsOptional()
  @IsEnum(MARKETS, { message: 'ä¸æ”¯æŒçš„å¸‚åœºç±»å‹' })
  market?: Market;

  // âœ… å¿…é¡»å¤ç”¨ï¼šshared æ•°æ®ç±»å‹
  @ApiPropertyOptional({
    description: 'æ•°æ®ç±»å‹è¿‡æ»¤å™¨',
    enum: DataType,
    example: DataType.STOCK_QUOTE
  })
  @IsOptional()
  @IsEnum(DataType, { message: 'ä¸æ”¯æŒçš„æ•°æ®ç±»å‹' })
  queryTypeFilter?: DataType;
}
```

### 10.4 å¤ç”¨éªŒè¯æ¸…å•

åœ¨å¼€å‘æ–°åŠŸèƒ½æ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ¸…å•ç¡®ä¿æœ€å¤§åŒ–å¤ç”¨ common æ¨¡å—ï¼š

#### 10.4.1 å¼€å‘å‰æ£€æŸ¥

- [ ] æ£€æŸ¥ `@common/constants` æ˜¯å¦å·²æœ‰æ‰€éœ€å¸¸é‡
- [ ] æ£€æŸ¥ `@common/types` æ˜¯å¦å·²æœ‰æ‰€éœ€ç±»å‹å®šä¹‰
- [ ] æ£€æŸ¥ `@common/interfaces` æ˜¯å¦å·²æœ‰æ‰€éœ€æ¥å£
- [ ] æ£€æŸ¥ `@common/dto` æ˜¯å¦å·²æœ‰ç±»ä¼¼çš„å“åº”æ ¼å¼

#### 10.4.2 ç¼–ç æ—¶æ£€æŸ¥

- [ ] æ‰€æœ‰å¯¼å…¥ä½¿ç”¨ `@common` è·¯å¾„åˆ«å
- [ ] æ‰€æœ‰æšä¸¾ä½¿ç”¨ common æ¨¡å—çš„å¸¸é‡
- [ ] æ‰€æœ‰ç±»å‹ä½¿ç”¨ common æ¨¡å—çš„ç±»å‹å®šä¹‰
- [ ] æ‰€æœ‰æ—¥å¿—ä½¿ç”¨ common æ¨¡å—çš„æ—¥å¿—é…ç½®
- [ ] æ‰€æœ‰å“åº”ä½¿ç”¨ common æ¨¡å—çš„è£…é¥°å™¨

#### 10.4.3 å®Œæˆåæ£€æŸ¥

- [ ] æ²¡æœ‰é‡å¤å®šä¹‰ common æ¨¡å—å·²æœ‰çš„ç±»å‹
- [ ] æ²¡æœ‰ç¡¬ç¼–ç  common æ¨¡å—å·²æœ‰çš„å¸¸é‡
- [ ] æ‰€æœ‰å¼‚å¸¸å¤„ç†ä½¿ç”¨æ ‡å‡†NestJSå¼‚å¸¸
- [ ] æ‰€æœ‰å“åº”æ ¼å¼ç¬¦åˆ common æ¨¡å—æ ‡å‡†

### 10.5 åæ¨¡å¼è­¦å‘Š

#### 10.5.1 ç¦æ­¢çš„åšæ³•

```typescript
// âŒ ç¦æ­¢ï¼šé‡å¤å®šä¹‰ç±»å‹
type Market = 'HK' | 'US' | 'SZ' | 'SH';

// âŒ ç¦æ­¢ï¼šç¡¬ç¼–ç å¸¸é‡
const SUPPORTED_MARKETS = ['HK', 'US', 'SZ', 'SH'];

// âŒ ç¦æ­¢ï¼šæ‰‹åŠ¨æ„é€ å“åº”æ ¼å¼
return {
  statusCode: 200,
  message: 'æˆåŠŸ',
  data: result,
  timestamp: new Date().toISOString()
};

// âŒ ç¦æ­¢ï¼šä¸ä½¿ç”¨æ—¥å¿—è„±æ•
this.logger.log('ç”¨æˆ·ç™»å½•', {
  username: user.username,
  password: user.password  // æ•æ„Ÿä¿¡æ¯æœªè„±æ•
});

// âŒ ç¦æ­¢ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„å¯¼å…¥
import { DataType } from '../../../common/constants/data-type.constants';
```

#### 10.5.2 å¿…é¡»çš„åšæ³•

```typescript
// âœ… å¿…é¡»ï¼šä½¿ç”¨ common ç±»å‹
import { Market } from '@common/types/common.types';

// âœ… å¿…é¡»ï¼šä½¿ç”¨ common å¸¸é‡
import { MARKETS } from '@common/constants/markets.constants';

// âœ… å¿…é¡»ï¼šè®©æ‹¦æˆªå™¨å¤„ç†å“åº”æ ¼å¼
return result; // ResponseInterceptor è‡ªåŠ¨åŒ…è£…

// âœ… å¿…é¡»ï¼šä½¿ç”¨æ—¥å¿—è„±æ•
import { sanitizeLogData } from '@common/config/logger.config';
this.logger.log('ç”¨æˆ·ç™»å½•', sanitizeLogData({
  username: user.username,
  password: user.password  // è‡ªåŠ¨è„±æ•
}));

// âœ… å¿…é¡»ï¼šä½¿ç”¨è·¯å¾„åˆ«å
import { DataType } from '@common/constants/data-type.constants';
```

## 11. æµ‹è¯•è§„èŒƒ

**ğŸ”§ å½“å‰æµ‹è¯•çŠ¶æ€**ï¼š
- âœ… æ ¸å¿ƒç³»ç»ŸåŠŸèƒ½éªŒè¯é€šè¿‡ï¼ˆæ‰‹åŠ¨æµ‹è¯•ï¼‰
- âœ… å¼€å‘æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œæ‰€æœ‰APIç«¯ç‚¹å¯è®¿é—®
- âš ï¸ éƒ¨åˆ†è‡ªåŠ¨åŒ–æµ‹è¯•é…ç½®å¯èƒ½éœ€è¦æ›´æ–°ï¼ˆåˆè§„æ•´æ”¹åï¼‰
- ğŸ“‹ å»ºè®®ï¼šä¼˜å…ˆç¼–å†™æ–°åŠŸèƒ½çš„æµ‹è¯•ï¼Œé€æ­¥å®Œå–„æµ‹è¯•è¦†ç›–

### 11.1 å•å…ƒæµ‹è¯•

ğŸ¯ **æµ‹è¯•ä¹Ÿå¿…é¡»å¤ç”¨ common æ¨¡å—çš„ç»„ä»¶**ï¼š

```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { ExampleService } from './example.service';
import { ExampleRepository } from './repositories/example.repository';
// ğŸ¯ æµ‹è¯•ä¸­ä¹Ÿè¦å¤ç”¨ common æ¨¡å—
import { Market, ProviderName } from '@common/types/common.types';
import { DataType } from '@common/constants/data-type.constants';
import { MARKETS } from '@common/constants/markets.constants';
import { createLogger } from '@common/config/logger.config';
// ğŸ¯ åˆ†é¡µæœåŠ¡æµ‹è¯•
import { PaginationService } from '@common/modules/pagination/services/pagination.service';
import { PaginatedDataDto } from '@common/modules/pagination/dto/paginated-data';

describe('ExampleService', () => {
  let service: ExampleService;
  let repository: ExampleRepository;
  let paginationService: PaginationService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        ExampleService,
        PaginationService, // â­ æ·»åŠ åˆ†é¡µæœåŠ¡
        {
          provide: ExampleRepository,
          useValue: {
            create: jest.fn(),
            findById: jest.fn(),
            findByMarketAndType: jest.fn(),
            findPaginated: jest.fn(), // â­ æ·»åŠ åˆ†é¡µæ–¹æ³•
            // å…¶ä»–mockæ–¹æ³•
          },
        },
      ],
    }).compile();

    service = module.get<ExampleService>(ExampleService);
    repository = module.get<ExampleRepository>(ExampleRepository);
    paginationService = module.get<PaginationService>(PaginationService);
  });

  describe('create', () => {
    it('åº”è¯¥æˆåŠŸåˆ›å»ºå®ä½“', async () => {
      // Given - ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„ç±»å‹
      const createDto = {
        name: 'test',
        market: MARKETS.HK as Market,
        storageClassification: DataType.STOCK_QUOTE
      };
      const mockEntity = {
        id: '1',
        name: 'test',
        market: MARKETS.HK,
        storageClassification: DataType.STOCK_QUOTE
      };
      jest.spyOn(repository, 'create').mockResolvedValue(mockEntity);

      // When
      const result = await service.create(createDto);

      // Then - ğŸ¯ éªŒè¯ common æ¨¡å—ç±»å‹
      expect(result).toEqual(expect.objectContaining({
        id: '1',
        name: 'test',
        market: MARKETS.HK,
        storageClassification: DataType.STOCK_QUOTE
      }));
      expect(repository.create).toHaveBeenCalledWith(createDto);
    });

    it('åº”è¯¥éªŒè¯ä¸æ”¯æŒçš„å¸‚åœºç±»å‹', async () => {
      // Given - ğŸ¯ ä½¿ç”¨æ— æ•ˆçš„å¸‚åœºç±»å‹æµ‹è¯•éªŒè¯
      const createDto = {
        name: 'test',
        market: 'INVALID_MARKET' as Market
      };

      // When & Then
      await expect(service.create(createDto))
        .rejects
        .toThrow('ä¸æ”¯æŒçš„å¸‚åœºç±»å‹');
    });
  });

  // â­ åˆ†é¡µæŸ¥è¯¢æµ‹è¯•
  describe('findPaginated', () => {
    it('åº”è¯¥è¿”å›æ­£ç¡®çš„åˆ†é¡µå“åº”', async () => {
      // Mock repositoryè¿”å› { items, total }
      jest.spyOn(repository, 'findPaginated').mockResolvedValue({ items: mockData, total: 25 });
      
      const result = await service.findPaginated({ page: 1, limit: 10 });
      
      // éªŒè¯è¿”å›PaginatedDataDtoæ ¼å¼
      expect(result).toBeInstanceOf(PaginatedDataDto);
      expect(result.pagination.totalPages).toBe(3);
    });
  });

  describe('findByMarketAndType', () => {
    it('åº”è¯¥æŒ‰å¸‚åœºå’Œæ•°æ®ç±»å‹æŸ¥è¯¢', async () => {
      // Given - ğŸ¯ ä½¿ç”¨ common æ¨¡å—çš„æšä¸¾
      const market = MARKETS.US;
      const storageClassification = DataType.STOCK_QUOTE;
      const mockResults = [
        { id: '1', market, storageClassification, name: 'test1' },
        { id: '2', market, storageClassification, name: 'test2' }
      ];

      jest.spyOn(repository, 'findByMarketAndClassification').mockResolvedValue(mockResults);

      // When
      const result = await service.findByMarketAndClassification(market, storageClassification);

      // Then
      expect(result).toHaveLength(2);
      expect(repository.findByMarketAndClassification).toHaveBeenCalledWith(market, storageClassification);
    });
  });
});
```

### 11.2 é›†æˆæµ‹è¯•

ğŸ¯ **é›†æˆæµ‹è¯•ä¸­å¤ç”¨ common æ¨¡å—è¿›è¡Œç«¯åˆ°ç«¯éªŒè¯**ï¼š

```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from '../app.module';
// ğŸ¯ é›†æˆæµ‹è¯•ä¹Ÿè¦å¤ç”¨ common æ¨¡å—
import { ApiResponseDto, PaginatedResponseDto } from '@common/dto/common-response.dto';
import { DataType } from '@common/constants/data-type.constants';
import { MARKETS } from '@common/constants/markets.constants';

describe('ExampleController (e2e)', () => {
  let app: INestApplication;
  let authToken: string;

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();

    // ğŸ¯ åº”ç”¨å…¨å±€æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨ï¼ˆä¸ç”Ÿäº§ç¯å¢ƒä¸€è‡´ï¼‰
    app.useGlobalInterceptors(new ResponseInterceptor());
    app.useGlobalFilters(new GlobalExceptionFilter());

    await app.init();

    // è·å–æµ‹è¯•ç”¨çš„è®¤è¯token
    authToken = await getTestAuthToken(app);
  });

  afterAll(async () => {
    await app.close();
  });

  describe('GET /examples', () => {
    it('åº”è¯¥è¿”å›æ ‡å‡†åˆ†é¡µå“åº”æ ¼å¼', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/examples')
        .set('Authorization', `Bearer ${authToken}`)
        .query({
          page: 1,
          limit: 10,
          market: MARKETS.HK,  // ğŸ¯ ä½¿ç”¨ common å¸¸é‡
          queryTypeFilter: DataType.STOCK_QUOTE  // ğŸ¯ ä½¿ç”¨ common æšä¸¾
        })
        .expect(200);

      // ğŸ¯ éªŒè¯å“åº”ç¬¦åˆ PaginatedDataDto æ ‡å‡†æ ¼å¼
      expect(response.body).toMatchObject({
        statusCode: 200,
        message: expect.any(String),
        data: {
          items: expect.any(Array),        // â­ ä½¿ç”¨itemså­—æ®µ
          pagination: {
            page: 1,
            limit: 10,
            total: expect.any(Number),
            totalPages: expect.any(Number),
            hasNext: expect.any(Boolean),
            hasPrev: expect.any(Boolean)
          }
        },
        timestamp: expect.any(String)
      });

      // ğŸ¯ éªŒè¯æ•°æ®é¡¹åŒ…å« common æ¨¡å—çš„å­—æ®µ
      if (response.body.data.items.length > 0) {
        const firstItem = response.body.data.items[0];
        expect(firstItem).toMatchObject({
          id: expect.any(String),
          name: expect.any(String),
          market: expect.stringMatching(new RegExp(Object.values(MARKETS).join('|'))),
          storageClassification: expect.stringMatching(new RegExp(Object.values(DataType).join('|')))
        });
      }
    });

    it('åº”è¯¥æ­£ç¡®å¤„ç†æ— æ•ˆçš„å¸‚åœºç±»å‹', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/examples')
        .set('Authorization', `Bearer ${authToken}`)
        .query({
          market: 'INVALID_MARKET'  // æ— æ•ˆå¸‚åœº
        })
        .expect(400);

      // ğŸ¯ éªŒè¯é”™è¯¯å“åº”ç¬¦åˆ common æ¨¡å—çš„æ ‡å‡†æ ¼å¼
      expect(response.body).toMatchObject({
        statusCode: 400,
        message: expect.stringContaining('ä¸æ”¯æŒçš„å¸‚åœºç±»å‹'),
        error: 'Bad Request',
        timestamp: expect.any(String),
        path: '/api/v1/examples'
      });
    });
  });

  describe('POST /examples', () => {
    it('åº”è¯¥åˆ›å»ºæ–°å®ä½“å¹¶è¿”å›æ ‡å‡†å“åº”æ ¼å¼', async () => {
      const createDto = {
        name: 'Test Example',
        market: MARKETS.US,  // ğŸ¯ ä½¿ç”¨ common å¸¸é‡
        storageClassification: DataType.STOCK_BASIC_INFO  // ğŸ¯ ä½¿ç”¨ common æšä¸¾
      };

      const response = await request(app.getHttpServer())
        .post('/api/v1/examples')
        .set('Authorization', `Bearer ${authToken}`)
        .send(createDto)
        .expect(201);

      // ğŸ¯ éªŒè¯åˆ›å»ºå“åº”ç¬¦åˆæ ‡å‡†æ ¼å¼
      expect(response.body).toMatchObject({
        statusCode: 201,
        message: expect.any(String),
        data: {
          id: expect.any(String),
          name: createDto.name,
          market: createDto.market,
          storageClassification: createDto.storageClassification,
          createdAt: expect.any(String),
          updatedAt: expect.any(String)
        },
        timestamp: expect.any(String)
      });
    });
  });
});

// ğŸ¯ æµ‹è¯•å·¥å…·å‡½æ•°ä¹Ÿè¦å¤ç”¨ common æ¨¡å—
async function getTestAuthToken(app: INestApplication): Promise<string> {
  const loginResponse = await request(app.getHttpServer())
    .post('/auth/login')
    .send({
      username: 'test@example.com',
      password: 'testpassword'
    })
    .expect(200);

  // éªŒè¯ç™»å½•å“åº”æ ¼å¼
  expect(loginResponse.body).toMatchObject({
    statusCode: 200,
    message: expect.any(String),
    data: {
      accessToken: expect.any(String),
      user: expect.any(Object)
    },
    timestamp: expect.any(String)
  });

  return loginResponse.body.data.accessToken;
}
```

### 11.3 æµ‹è¯•ä¸­çš„ Shared æ¨¡å—å¤ç”¨æœ€ä½³å®è·µ

#### 11.3.1 Mock æ•°æ®ä½¿ç”¨ Shared å¸¸é‡

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ common å¸¸é‡åˆ›å»ºæµ‹è¯•æ•°æ®
import { MARKETS } from '@common/constants/markets.constants';
import { DataType } from '@common/constants/data-type.constants';

const mockData = {
  market: MARKETS.HK,
  storageClassification: DataType.STOCK_QUOTE,
  symbols: ['700.HK', '0005.HK']
};

// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç æµ‹è¯•æ•°æ®
const mockData = {
  market: 'HK',
  receiverType: 'get-stock-quote', // ç»Ÿä¸€ä½¿ç”¨get-å‰ç¼€æ ¼å¼
  symbols: ['700.HK', '0005.HK']
};
```

#### 11.3.2 å“åº”æ ¼å¼éªŒè¯

```typescript
// âœ… æ­£ç¡®ï¼šéªŒè¯å“åº”ç¬¦åˆ common æ¨¡å—æ ‡å‡†
expect(response.body).toMatchObject({
  statusCode: expect.any(Number),
  message: expect.any(String),
  data: expect.anything(),
  timestamp: expect.stringMatching(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/)
});

// âŒ é”™è¯¯ï¼šä¸éªŒè¯æ ‡å‡†å“åº”æ ¼å¼
expect(response.body.data).toBeDefined();
```

#### 11.3.3 å¼‚å¸¸æµ‹è¯•

```typescript
// âœ… æ­£ç¡®ï¼šæµ‹è¯•å¼‚å¸¸å¤„ç†ä½¿ç”¨ common æ¨¡å—éªŒè¯
it('åº”è¯¥æ­£ç¡®å¤„ç†ä¸šåŠ¡å¼‚å¸¸', async () => {
  const invalidData = { market: 'INVALID' };

  await expect(service.processData(invalidData))
    .rejects
    .toThrow('ä¸æ”¯æŒçš„å¸‚åœºç±»å‹');
});

// é›†æˆæµ‹è¯•ä¸­éªŒè¯å¼‚å¸¸å“åº”æ ¼å¼
const response = await request(app.getHttpServer())
  .post('/api/v1/data')
  .send(invalidData)
  .expect(400);

expect(response.body).toMatchObject({
  statusCode: 400,
  message: expect.stringContaining('ä¸æ”¯æŒçš„å¸‚åœºç±»å‹'),
  error: 'Bad Request',
  timestamp: expect.any(String),
  path: expect.any(String)
});
```


## 13. APIç‰ˆæœ¬æ§åˆ¶

### 13.1 ç‰ˆæœ¬ç­–ç•¥

- URLè·¯å¾„ç‰ˆæœ¬æ§åˆ¶ï¼š`/api/v1/`, `/api/v2/`
- ä¸»è¦ç‰ˆæœ¬æ›´æ–°æ—¶åˆ›å»ºæ–°çš„æ§åˆ¶å™¨ç‰ˆæœ¬
- å‘åå…¼å®¹æ€§åŸåˆ™ï¼šæ–°ç‰ˆæœ¬ä¸ç ´åç°æœ‰API

### 11.2 ç‰ˆæœ¬å®ç°

```typescript
@Controller('api/v1/examples')  // v1ç‰ˆæœ¬
export class ExamplesV1Controller {
  // v1å®ç°
}

@Controller('api/v2/examples')  // v2ç‰ˆæœ¬
export class ExamplesV2Controller {
  // v2å®ç°ï¼Œå¢å¼ºåŠŸèƒ½ä½†ä¿æŒå‘åå…¼å®¹
}
```

## 14. å®‰å…¨è§„èŒƒ

### 14.1 è¾“å…¥éªŒè¯

- æ‰€æœ‰è¾“å…¥å¿…é¡»é€šè¿‡DTOéªŒè¯
- ä½¿ç”¨`class-validator`è¿›è¡Œæ•°æ®éªŒè¯
- æ•æ„Ÿæ“ä½œéœ€è¦é¢å¤–çš„ä¸šåŠ¡è§„åˆ™éªŒè¯

### 12.2 æ•æ„Ÿä¿¡æ¯å¤„ç†

```typescript
// Schemaä¸­æ’é™¤æ•æ„Ÿå­—æ®µ
Schema.methods.toJSON = function() {
  const obj = this.toObject();
  delete obj.password;
  delete obj.secretKey;
  return obj;
};

// æ—¥å¿—ä¸­é¿å…è®°å½•æ•æ„Ÿä¿¡æ¯
this.logger.log('ç”¨æˆ·ç™»å½•', {
  userId: user.id,
  // ä¸è®°å½•å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
});
```

### 12.3 å®‰å…¨å®¡è®¡

- ä½¿ç”¨`SecurityAuditService`è®°å½•å®‰å…¨äº‹ä»¶
- æ•æ„Ÿæ“ä½œè‡ªåŠ¨è®°å½•å®¡è®¡æ—¥å¿—
- å¼‚å¸¸è®¿é—®æ¨¡å¼æ£€æµ‹å’Œå‘Šè­¦

### 12.4 HTTP Headers å·¥å…·ç±»

ç³»ç»Ÿæä¾›äº†ç»Ÿä¸€çš„HTTP Headerså¤„ç†å·¥å…·ç±» `HttpHeadersUtil`ï¼Œä½äº `@common/utils/http-headers.util.ts`ï¼Œç”¨äºæ ‡å‡†åŒ–å’Œå®‰å…¨åœ°å¤„ç†HTTPè¯·æ±‚å¤´ã€‚

#### 12.4.1 å·¥å…·ç±»åŠŸèƒ½

```typescript
import { HttpHeadersUtil } from '@common/utils/http-headers.util';

// 1. å®‰å…¨è·å–headerå€¼
const apiKey = HttpHeadersUtil.getHeader(req, 'X-API-Key');
const userAgent = HttpHeadersUtil.getUserAgent(req);

// 2. éªŒè¯APIå‡­è¯æ ¼å¼
const { appKey, appSecret } = HttpHeadersUtil.validateApiCredentials(req);

// 3. è·å–å®¢æˆ·ç«¯IP
const clientIp = HttpHeadersUtil.getClientIP(req);

// 4. è·å–JWT Token
const token = HttpHeadersUtil.getBearerToken(req);

// 5. å®‰å…¨è®°å½•headersï¼ˆè¿‡æ»¤æ•æ„Ÿä¿¡æ¯ï¼‰
const safeHeaders = HttpHeadersUtil.getSafeHeaders(req);
this.logger.log('è¯·æ±‚ä¿¡æ¯', { headers: safeHeaders });
```

#### 12.4.2 APIå‡­è¯éªŒè¯è§„èŒƒ

**ä¸¥æ ¼çš„æ ¼å¼éªŒè¯**ï¼š
```typescript
// âœ… æ­£ç¡®çš„APIå‡­è¯æ ¼å¼
X-API-Key: your_api_key_here
X-API-Secret: your_api_secret_here

// âŒ ä¸å…è®¸çš„æ ¼å¼ï¼ˆåŒ…å«ç©ºç™½å­—ç¬¦ï¼‰
X-API-Key: " your_api_key_here "    // åŒ…å«ç©ºæ ¼
X-API-Secret: "your_api_secret\n"   // åŒ…å«æ¢è¡Œç¬¦
X-API-Key: "your\tapi\tkey"         // åŒ…å«åˆ¶è¡¨ç¬¦
```

**éªŒè¯è§„åˆ™**ï¼š
- æ‹’ç»ä»»ä½•åŒ…å«ç©ºç™½å­—ç¬¦çš„APIå‡­è¯ï¼ˆç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ç­‰ï¼‰
- æä¾›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯åŒºåˆ†ä¸åŒé”™è¯¯ç±»å‹
- å…¼å®¹å¤§å°å†™å·®å¼‚å’Œæ•°ç»„å½¢å¼çš„headerå€¼

#### 12.4.3 ä½¿ç”¨ç¤ºä¾‹

**åœ¨è®¤è¯ç­–ç•¥ä¸­ä½¿ç”¨**ï¼š
```typescript
@Injectable()
export class ApiKeyStrategy extends PassportStrategy(Strategy, 'api-key') {
  async validate(req: Request): Promise<ApiKeyPayload> {
    try {
      // ä½¿ç”¨ç»Ÿä¸€å·¥å…·éªŒè¯APIå‡­è¯
      const { appKey, appSecret } = HttpHeadersUtil.validateApiCredentials(req);
      
      // éªŒè¯API Key
      const apiKey = await this.authService.validateApiKey(appKey, appSecret);
      if (!apiKey) {
        throw new UnauthorizedException('APIå‡­è¯æ— æ•ˆ');
      }
      
      return { apiKey, clientIp: HttpHeadersUtil.getClientIP(req) };
    } catch (error) {
      this.logger.error('API KeyéªŒè¯å¤±è´¥', {
        error: error.message,
        clientIp: HttpHeadersUtil.getClientIP(req),
        userAgent: HttpHeadersUtil.getUserAgent(req)
      });
      throw error;
    }
  }
}
```

**åœ¨ä¸­é—´ä»¶ä¸­ä½¿ç”¨**ï¼š
```typescript
@Injectable()
export class SecurityMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    // è·å–å®¢æˆ·ç«¯ä¿¡æ¯
    const clientIp = HttpHeadersUtil.getClientIP(req);
    const userAgent = HttpHeadersUtil.getUserAgent(req);
    
    // æ£€æµ‹API Keyè¯·æ±‚
    const apiCredentials = HttpHeadersUtil.getApiCredentials(req);
    if (apiCredentials) {
      // è®°å½•APIè®¿é—®æ—¥å¿—
      this.logger.log('APIè®¿é—®è¯·æ±‚', {
        clientIp,
        userAgent,
        hasApiKey: true,
        path: req.path,
        method: req.method
      });
    }
    
    next();
  }
}
```

**åœ¨å¼‚å¸¸è¿‡æ»¤å™¨ä¸­ä½¿ç”¨**ï¼š
```typescript
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const request = ctx.getRequest<Request>();
    
    // ä½¿ç”¨å·¥å…·ç±»è·å–è¯·æ±‚ä¿¡æ¯
    const errorContext = {
      path: request.url,
      method: request.method,
      clientIp: HttpHeadersUtil.getClientIP(request),
      userAgent: HttpHeadersUtil.getUserAgent(request),
      headers: HttpHeadersUtil.getSafeHeaders(request) // è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
    };
    
    this.logger.error('è¯·æ±‚å¼‚å¸¸', { exception, context: errorContext });
  }
}
```

#### 12.4.4 æœ€ä½³å®è·µ

1. **ç»Ÿä¸€ä½¿ç”¨å·¥å…·ç±»**ï¼š
   - æ‰€æœ‰HTTP headerså¤„ç†éƒ½åº”ä½¿ç”¨ `HttpHeadersUtil`
   - é¿å…ç›´æ¥è®¿é—® `req.headers` å¯¹è±¡
   - æ¶ˆé™¤é¡¹ç›®ä¸­çš„é‡å¤ä»£ç 

2. **å®‰å…¨ç¬¬ä¸€**ï¼š
   - ä½¿ç”¨ `getSafeHeaders()` è®°å½•æ—¥å¿—ï¼Œè‡ªåŠ¨è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
   - ä¸¥æ ¼éªŒè¯APIå‡­è¯æ ¼å¼ï¼Œæ‹’ç»åŒ…å«ç©ºç™½å­—ç¬¦çš„å‡­è¯
   - æä¾›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯å¸®åŠ©è°ƒè¯•

3. **å…¼å®¹æ€§å¤„ç†**ï¼š
   - è‡ªåŠ¨å¤„ç†headeråç§°çš„å¤§å°å†™å·®å¼‚
   - æ”¯æŒæ•°ç»„å½¢å¼çš„headerå€¼
   - ä¼˜é›…å¤„ç†ç¼ºå¤±çš„header

4. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ç¼“å­˜æœºåˆ¶é¿å…é‡å¤è§£æ
   - æä¾›è½»é‡çº§çš„getteræ–¹æ³•
   - æ”¯æŒæ‰¹é‡è·å–å¤šä¸ªheaderå€¼

#### 12.4.5 é”™è¯¯å¤„ç†

å·¥å…·ç±»ä¼šæŠ›å‡ºä»¥ä¸‹å¼‚å¸¸ç±»å‹ï¼š

```typescript
// APIå‡­è¯ç¼ºå¤±
throw new UnauthorizedException('ç¼ºå°‘APIå‡­è¯');

// APIå‡­è¯æ ¼å¼é”™è¯¯
throw new BadRequestException('APIå‡­è¯æ ¼å¼æ— æ•ˆï¼Œä¸èƒ½åŒ…å«ç©ºç™½å­—ç¬¦');

// å…¶ä»–æ ¼å¼é”™è¯¯
throw new BadRequestException('æ— æ•ˆçš„è®¤è¯å¤´æ ¼å¼');
```

#### 12.4.6 é¡¹ç›®é›†æˆæ£€æŸ¥

åœ¨é¡¹ç›®ä¸­ä½¿ç”¨æ­¤å·¥å…·ç±»æ—¶ï¼Œéœ€è¦æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶æ˜¯å¦å·²æ›´æ–°ï¼š

- âœ… `auth/strategies/apikey.strategy.ts` - API Keyè®¤è¯ç­–ç•¥
- âœ… `security/middleware/security.middleware.ts` - å®‰å…¨ä¸­é—´ä»¶
- âœ… `auth/filters/rate-limit.filter.ts` - é™æµå¼‚å¸¸è¿‡æ»¤å™¨
- âœ… `common/filters/global-exception.filter.ts` - å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
- âœ… `auth/guards/rate-limit.guard.ts` - é™æµå®ˆå«

ç¡®ä¿æ‰€æœ‰ç›¸å…³æ–‡ä»¶éƒ½å·²æ›´æ–°ä¸ºä½¿ç”¨ç»Ÿä¸€çš„ `HttpHeadersUtil` å·¥å…·ç±»ï¼Œé¿å…ä»£ç é‡å¤å’Œä¸ä¸€è‡´çš„å¤„ç†é€»è¾‘ã€‚

## 15. CI/CDå’Œéƒ¨ç½²è§„èŒƒ

### 15.1 ä»£ç è´¨é‡æ£€æŸ¥

```bash
# å¼€å‘æ—¶è¿è¡Œ
bun run lint          # ESLintæ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤
bun run format        # Prettieræ ¼å¼åŒ–
bun run typecheck     # TypeScriptç±»å‹æ£€æŸ¥

# CI/CDç®¡é“
bun test              # å•å…ƒæµ‹è¯•
bun run test:integration  # é›†æˆæµ‹è¯•
bun run test:e2e      # ç«¯åˆ°ç«¯æµ‹è¯•
bun run security:deps # ä¾èµ–å®‰å…¨æ‰«æ
```

### 13.2 æ„å»ºå’Œéƒ¨ç½²

```bash
# æ„å»º
bun run build         # TypeScriptç¼–è¯‘

# ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
bun run start:prod    # ç”Ÿäº§æ¨¡å¼

# å¥åº·æ£€æŸ¥
curl http://localhost:3000/health
```

## 16. å¼€å‘å·¥å…·å’Œé…ç½®

### 16.1 IDEé…ç½®

æ¨èVSCodeæ‰©å±•ï¼š
- TypeScript Importer
- ESLint
- Prettier
- REST Client
- MongoDB for VS Code

### 14.2 ç¯å¢ƒå˜é‡ç®¡ç†

**å¿…éœ€çš„ç¯å¢ƒå˜é‡**ï¼ˆè¯¦ç»†é…ç½®è§ [CLAUDE.md](../CLAUDE.md#environment-setup)ï¼‰ï¼š

```typescript
// ç±»å‹å®‰å…¨çš„ç¯å¢ƒå˜é‡
interface EnvironmentVariables {
  // åŸºç¡€é…ç½®
  NODE_ENV: 'development' | 'production' | 'test';
  PORT: number;
  
  // æ•°æ®åº“é…ç½®
  MONGODB_URI: string;
  REDIS_HOST: string;
  REDIS_PORT: number;
  REDIS_PASSWORD?: string;
  
  // è®¤è¯é…ç½®
  JWT_SECRET: string;
  JWT_EXPIRES_IN: string;
  
  // LongPort SDKé…ç½® (ç”Ÿäº§æ•°æ®æº)
  LONGPORT_APP_KEY: string;      // å¿…éœ€ï¼šLongPortåº”ç”¨å¯†é’¥
  LONGPORT_APP_SECRET: string;   // å¿…éœ€ï¼šLongPortåº”ç”¨å¯†é’¥
  LONGPORT_ACCESS_TOKEN: string; // å¿…éœ€ï¼šLongPortè®¿é—®ä»¤ç‰Œ
  
  // å…¶ä»–æ•°æ®æºé…ç½® (é¢„ç•™)
  ITICK_API_KEY?: string;
  FUTU_APP_ID?: string;
  TWELVEDATA_API_KEY?: string;
}
```

**ç¯å¢ƒå˜é‡è®¾ç½®ç¤ºä¾‹**ï¼š
```bash
# å¼€å‘ç¯å¢ƒ (.env.development)
NODE_ENV=development
PORT=3000
MONGODB_URI=mongodb://localhost:27017/smart-stock-data
REDIS_HOST=localhost
REDIS_PORT=6379
JWT_SECRET=your_32_char_jwt_secret_key_here
JWT_EXPIRES_IN=24h

# LongPort SDK (å¿…éœ€)
LONGPORT_APP_KEY=your_longport_app_key
LONGPORT_APP_SECRET=your_longport_app_secret
LONGPORT_ACCESS_TOKEN=your_longport_access_token
```

## 17. æœ€ä½³å®è·µæ€»ç»“

### 17.1 ä»£ç è´¨é‡

1. **ç±»å‹å®‰å…¨**ï¼šå……åˆ†åˆ©ç”¨TypeScriptçš„ç±»å‹ç³»ç»Ÿ
2. **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨æ ‡å‡†å¼‚å¸¸ç±»å‹ï¼Œæä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯
3. **æ—¥å¿—è®°å½•**ï¼šç»“æ„åŒ–æ—¥å¿—ï¼ŒåŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ç¼“å­˜ã€æ•°æ®åº“ç´¢å¼•ã€æŸ¥è¯¢ä¼˜åŒ–
5. **å®‰å…¨ç¬¬ä¸€**ï¼šè¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒã€æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

### 15.2 å›¢é˜Ÿåä½œ

1. **ä»£ç å®¡æŸ¥**ï¼šæ‰€æœ‰ä»£ç å˜æ›´å¿…é¡»ç»è¿‡å®¡æŸ¥
2. **æ–‡æ¡£ç»´æŠ¤**ï¼šAPIæ–‡æ¡£ã€æ¶æ„æ–‡æ¡£ä¿æŒæœ€æ–°
3. **æµ‹è¯•è¦†ç›–**ï¼šå…³é”®ä¸šåŠ¡é€»è¾‘å¿…é¡»æœ‰æµ‹è¯•è¦†ç›–
4. **æŒç»­é›†æˆ**ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•ã€æ„å»ºã€éƒ¨ç½²

### 15.3 ç³»ç»Ÿç›‘æ§

1. **æ€§èƒ½ç›‘æ§**ï¼šå“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€èµ„æºä½¿ç”¨
2. **ä¸šåŠ¡ç›‘æ§**ï¼šAPIè°ƒç”¨é‡ã€ç”¨æˆ·æ´»åŠ¨ã€æ•°æ®è´¨é‡
3. **å®‰å…¨ç›‘æ§**ï¼šå¼‚å¸¸è®¿é—®ã€å®‰å…¨äº‹ä»¶ã€æ¼æ´æ‰«æ
4. **å‘Šè­¦æœºåˆ¶**ï¼šåŠæ—¶å‘ç°å’Œå“åº”ç³»ç»Ÿé—®é¢˜

## ç»“è¯­

æœ¬å¼€å‘è§„èŒƒåŸºäºNestJSæœ€ä½³å®è·µå’Œé¡¹ç›®å®é™…éœ€æ±‚åˆ¶å®šï¼Œæ—¨åœ¨ç¡®ä¿ä»£ç è´¨é‡ã€å¼€å‘æ•ˆç‡å’Œç³»ç»Ÿç¨³å®šæ€§ã€‚æ‰€æœ‰å›¢é˜Ÿæˆå‘˜éƒ½åº”ä¸¥æ ¼éµå®ˆè¿™äº›è§„èŒƒï¼Œå¹¶åœ¨å®è·µä¸­ä¸æ–­å®Œå–„å’Œä¼˜åŒ–ã€‚

### ğŸ“š ç›¸å…³æ–‡æ¡£

- **[CLAUDE.md](../CLAUDE.md)** - ç³»ç»Ÿæ¶æ„æ¦‚è§ˆå’Œå¿«é€Ÿä¸Šæ‰‹æŒ‡å—
- **[ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](./system-architecture-overview.md)** - å®Œæ•´çš„æŠ€æœ¯æ¶æ„æ–‡æ¡£  
- **[å®‰å…¨é…ç½®å‚è€ƒ](./security-configuration-reference.md)** - ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®



---

*æœ¬æ–‡æ¡£ä¸ [CLAUDE.md](../CLAUDE.md) é…å¥—ä½¿ç”¨ï¼Œå…±åŒæ„æˆå®Œæ•´çš„é¡¹ç›®å¼€å‘æŒ‡å—ä½“ç³»ã€‚*