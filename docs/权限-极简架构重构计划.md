# 权限组件极简架构重构计划（v2）

## 目标
- 仅两种角色：`ADMIN`（管控）、`DEVELOPER`（查询）
- 两档权限画像：`READ_PROFILE`、`ADMIN_PROFILE`
- 内部认证：JWT（仅管理员）；外部认证：API Key
- 去除兼容层、统一配置、权限缓存与冗余目录

## v2 扁平化结构（src/authv2）
- `enums.ts`：`UserRole`、`Permission`
- `constants.ts`：`READ_PROFILE`、`ADMIN_PROFILE`、元数据键、头部常量
- `decorators.ts`：`Auth`、`ApiKeyAuth`、`MixedAuth`、`ReadAccess`、`AdminOnly`、`Public`
- `guards.ts`：`JwtAuthGuard`、`ApiKeyAuthGuard`、`PermissionsGuard`
- `strategies.ts`：`JwtStrategy`、`ApiKeyStrategy`
- `service.ts`：`AuthService`（JWT 签发与 API Key 校验）
- `schema.ts`：`ApiKey`（极简：`profile` 字段）
- `auth.module.ts`：模块汇总
- `index.ts`：统一导出

## 端点标注规范
- 查询端点：`@ReadAccess()`（等价 `@MixedAuth([DEVELOPER], READ_PROFILE)`）
- 管控端点：`@AdminOnly()`（等价 `@Auth([ADMIN], ADMIN_PROFILE)`）
- 外部管控（少数场景）：`@ApiKeyAuth(ADMIN_PROFILE)`
- 禁止散用 `@RequirePermissions(...)`

## 切换步骤（建议）
1. 引入 `authv2` 模块：在应用模块中注册 `AuthModule`（来自 `src/authv2`）。
2. 端点标注收敛：统一替换为 `@ReadAccess()` / `@AdminOnly()`。
3. API Key 简化：将 `permissions[]` 迁移为 `profile` 字段，默认 `READ`。
4. 删除旧目录：移除 `src/auth` 下的 `config/、filters/、interceptors/、middleware/、permission/、subjects/、interfaces/` 等。
5. 测试与文档：仅保留两角色两画像的用例与说明。

## 风险与回滚
- 分阶段切换，阶段性执行 `bun run build` 保证编译通过。
- 数据层面：可临时保留 `permissions[]` -> `profile` 的映射，最终仅存 `profile`。

## 验收标准
- 任一查询端点对 `DEVELOPER` 与 `READ` API Key 可访问。
- 任一管控端点仅对 `ADMIN`（JWT）或 `ADMIN` API Key（显式标注）开放。
- 端点不再使用零散权限组合；仅通过画像常量控制。

