# ç›‘æ§ç»„ä»¶ä½¿ç”¨æŒ‡å¯¼æ–‡æ¡£

> **ğŸš¨ é‡è¦æ›´æ–°è¯´æ˜ï¼ˆ2025-08-25ï¼‰**
> 
> æœ¬æ–‡æ¡£å·²æ ¹æ®å®é™…ä»£ç è¿›è¡Œå…¨é¢ä¿®æ­£ï¼Œç¡®ä¿æ‰€æœ‰ç¤ºä¾‹ä»£ç ä¸ CollectorService çš„çœŸå® API ä¸€è‡´ã€‚
> ä¸»è¦ä¿®æ­£å†…å®¹ï¼š
> - ä¿®æ­£æ–¹æ³•è°ƒç”¨å‚æ•°æ ¼å¼ï¼ˆä»å¯¹è±¡å‚æ•°æ”¹ä¸ºä½ç½®å‚æ•°ï¼‰
> - ç§»é™¤ä¸å­˜åœ¨çš„æ–¹æ³•ï¼ˆrecordExternalCallã€recordBusinessMetricã€recordBatchOperationï¼‰
> - æ‰€æœ‰ç¤ºä¾‹ä»£ç å‡å·²éªŒè¯å¯ä»¥æ­£å¸¸è¿è¡Œ
> - æ·»åŠ æ­£ç¡®çš„ TypeScript ç±»å‹å®šä¹‰

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›ç›‘æ§ç»„ä»¶çš„æ ‡å‡†ä½¿ç”¨æ–¹æ³•å’Œæœ€ä½³å®è·µï¼Œç¡®ä¿å„æ ¸å¿ƒç»„ä»¶èƒ½å¤Ÿç»Ÿä¸€ã€è§„èŒƒåœ°æ¥å…¥ç›‘æ§ä½“ç³»ã€‚

## æ¶æ„åŸç†

### å››å±‚ç›‘æ§æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Presenter     â”‚  â† æ•°æ®å±•ç¤ºå±‚ (HTTPæ¥å£ã€ä»ªè¡¨æ¿)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Analyzer      â”‚  â† åˆ†æå¤„ç†å±‚ (è¶‹åŠ¿åˆ†æã€å¥åº·è¯„ä¼°)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Collector     â”‚  â† æ•°æ®æ”¶é›†å±‚ (ä¸šåŠ¡è¯­ä¹‰æ¥å£) â˜… æ ¸å¿ƒç»„ä»¶ä½¿ç”¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Infrastructure  â”‚  â† åŸºç¡€è®¾æ–½å±‚ (Prometheusæ³¨å†Œç®¡ç†)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®è®¾è®¡åŸåˆ™
- **åˆ†å±‚è§£è€¦**ï¼šæ ¸å¿ƒç»„ä»¶åªä¸Collectorå±‚äº¤äº’
- **ä¸šåŠ¡è¯­ä¹‰åŒ–**ï¼šä½¿ç”¨ä¸šåŠ¡å‹å¥½çš„æ–¹æ³•åå’Œå‚æ•°
- **æ ‡å‡†åŒ–æ¥å£**ï¼šç»Ÿä¸€çš„ç›‘æ§è°ƒç”¨æ¨¡å¼
- **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šä¸šåŠ¡é€»è¾‘ä¸ç›‘æ§å®ç°è§£è€¦

## æ ‡å‡†ä½¿ç”¨æ¨¡å¼

### 1. ä¾èµ–æ³¨å…¥é…ç½®

```typescript
// âœ… æ­£ç¡®çš„ä¾èµ–æ³¨å…¥æ–¹å¼
import { CollectorService } from '@monitoring/collector/collector.service';

@Injectable()
export class YourService {
  constructor(
    private readonly collectorService: CollectorService,
    // âŒ ä¸è¦ç›´æ¥æ³¨å…¥ MetricsRegistryService
    // private readonly metricsRegistry: MetricsRegistryService,
  ) {}
}
```

### 2. æ¨¡å—å¯¼å…¥é…ç½®

```typescript
// your.module.ts
import { Module } from '@nestjs/common';
import { MonitoringModule } from '@monitoring/monitoring.module';

@Module({
  imports: [
    MonitoringModule, // å¯¼å…¥ç›‘æ§æ¨¡å—
  ],
  providers: [YourService],
})
export class YourModule {}
```

## æ ¸å¿ƒç›‘æ§æ–¹æ³•

### 1. HTTPè¯·æ±‚ç›‘æ§

```typescript
// è®°å½•APIè¯·æ±‚
async handleRequest(dto: RequestDto) {
  const startTime = Date.now();
  
  try {
    const result = await this.processRequest(dto);
    
    // âœ… æˆåŠŸè¯·æ±‚ç›‘æ§
    this.collectorService.recordRequest(
      '/api/stock-quote',                    // endpoint
      'POST',                               // method
      200,                                  // statusCode
      Date.now() - startTime,               // duration
      {                                     // metadata
        operation: 'get-stock-quote',
        provider: 'longport',
        symbols: dto.symbols,
        market: 'HK'
      }
    );
    
    return result;
  } catch (error) {
    // âœ… å¤±è´¥è¯·æ±‚ç›‘æ§
    this.collectorService.recordRequest(
      '/api/stock-quote',                   // endpoint
      'POST',                               // method
      500,                                  // statusCode
      Date.now() - startTime,               // duration
      {                                     // metadata
        operation: 'get-stock-quote',
        provider: 'longport',
        error: error.message,
        symbols: dto.symbols
      }
    );
    
    throw error;
  }
}
```

### 2. æ•°æ®åº“æ“ä½œç›‘æ§

```typescript
// MongoDBæŸ¥è¯¢ç›‘æ§
async findSymbolMapping(symbol: string) {
  const startTime = Date.now();
  
  try {
    const result = await this.symbolModel.findOne({ symbol });
    
    // âœ… æ•°æ®åº“æ“ä½œç›‘æ§
    this.collectorService.recordDatabaseOperation(
      'findOne',                            // operation
      Date.now() - startTime,               // duration
      true,                                 // success
      {                                     // metadata
        collection: 'symbolMappings',
        resultCount: result ? 1 : 0
      }
    );
    
    return result;
  } catch (error) {
    this.collectorService.recordDatabaseOperation(
      'findOne',                            // operation
      Date.now() - startTime,               // duration
      false,                                // success
      {                                     // metadata
        collection: 'symbolMappings',
        error: error.message
      }
    );
    
    throw error;
  }
}
```

### 3. ç¼“å­˜æ“ä½œç›‘æ§

```typescript
// Redisç¼“å­˜ç›‘æ§
async getCachedData(key: string) {
  const startTime = Date.now();
  
  try {
    const data = await this.redisClient.get(key);
    const hit = data !== null;
    
    // âœ… ç¼“å­˜æ“ä½œç›‘æ§
    this.collectorService.recordCacheOperation(
      'get',                                // operation
      hit,                                  // hit
      Date.now() - startTime,               // duration
      {                                     // metadata
        cacheType: 'redis',
        key: key.substring(0, 50)           // ç¼“å­˜é”®(æˆªæ–­æ•æ„Ÿä¿¡æ¯)
      }
    );
    
    return hit ? JSON.parse(data) : null;
  } catch (error) {
    this.collectorService.recordCacheOperation(
      'get',                                // operation
      false,                                // hit
      Date.now() - startTime,               // duration
      {                                     // metadata
        cacheType: 'redis',
        error: error.message
      }
    );
    
    throw error;
  }
}
```

### 4. å¤–éƒ¨APIè°ƒç”¨ç›‘æ§

```typescript
// ç¬¬ä¸‰æ–¹APIè°ƒç”¨ç›‘æ§
// æ³¨æ„ï¼šå¤–éƒ¨APIè°ƒç”¨å¯ä»¥ä½¿ç”¨HTTPè¯·æ±‚ç›‘æ§æ–¹æ³•è®°å½•
async callProviderAPI(symbols: string[]) {
  const startTime = Date.now();
  
  try {
    const response = await this.httpClient.post('/api/quotes', { symbols });
    
    // âœ… å¤–éƒ¨APIè°ƒç”¨ç›‘æ§ï¼ˆä½¿ç”¨HTTPè¯·æ±‚ç›‘æ§ï¼‰
    this.collectorService.recordRequest(
      '/api/quotes',                        // endpoint
      'POST',                               // method
      response.status,                      // statusCode
      Date.now() - startTime,               // duration
      {                                     // metadata
        provider: 'longport',
        callType: 'external_api',
        requestSize: JSON.stringify({ symbols }).length,
        responseSize: JSON.stringify(response.data).length,
        symbols: symbols
      }
    );
    
    return response.data;
  } catch (error) {
    this.collectorService.recordRequest(
      '/api/quotes',                        // endpoint
      'POST',                               // method
      error.response?.status || 500,        // statusCode
      Date.now() - startTime,               // duration
      {                                     // metadata
        provider: 'longport',
        callType: 'external_api',
        error: error.message,
        symbols: symbols
      }
    );
    
    throw error;
  }
}
```

### 4. ç³»ç»ŸæŒ‡æ ‡ç›‘æ§

```typescript
// ç³»ç»ŸæŒ‡æ ‡ç›‘æ§
async recordSystemStatus() {
  try {
    // è·å–ç³»ç»ŸæŒ‡æ ‡
    const systemMetrics = await this.collectorService.getSystemMetrics();
    
    // âœ… è®°å½•ç³»ç»ŸæŒ‡æ ‡
    this.collectorService.recordSystemMetrics(systemMetrics);
    
    this.logger.debug('ç³»ç»ŸæŒ‡æ ‡è®°å½•å®Œæˆ', systemMetrics);
  } catch (error) {
    this.logger.error('ç³»ç»ŸæŒ‡æ ‡è®°å½•å¤±è´¥', error.message);
  }
}
```

## ç›‘æ§æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†æ¨¡å¼

```typescript
// âœ… æ ‡å‡†é”™è¯¯å¤„ç†ç›‘æ§æ¨¡å¼
async riskyOperation() {
  const startTime = Date.now();
  
  try {
    // ä¸šåŠ¡é€»è¾‘
    const result = await this.doSomething();
    
    // æˆåŠŸç›‘æ§
    this.collectorService.recordRequest(
      '/internal/risky-operation',          // endpoint
      'POST',                               // method
      200,                                  // statusCode
      Date.now() - startTime,               // duration
      { operation: 'risky-operation' }      // metadata
    );
    
    return result;
  } catch (error) {
    // é”™è¯¯ç›‘æ§ - è®°å½•ä½†ä¸æŠ‘åˆ¶å¼‚å¸¸
    this.collectorService.recordRequest(
      '/internal/risky-operation',          // endpoint
      'POST',                               // method
      500,                                  // statusCode
      Date.now() - startTime,               // duration
      {                                     // metadata
        operation: 'risky-operation',
        error: error.message
      }
    );
    
    // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œä¿æŒä¸šåŠ¡æµç¨‹ä¸å˜
    throw error;
  }
}
```

### 2. å¼‚æ­¥ç›‘æ§æ¨¡å¼

```typescript
// âœ… å¼‚æ­¥ç›‘æ§ï¼Œé¿å…é˜»å¡ä¸šåŠ¡
async fastBusinessOperation() {
  const startTime = Date.now();
  const result = await this.quickOperation();
  
  // å¼‚æ­¥è®°å½•ç›‘æ§ï¼Œä¸é˜»å¡å“åº”
  setImmediate(() => {
    try {
      this.collectorService.recordRequest(
        '/internal/fast-operation',         // endpoint
        'POST',                             // method
        200,                                // statusCode
        Date.now() - startTime,             // duration
        {                                   // metadata
          operation: 'fast-operation',
          async: true
        }
      );
    } catch (error) {
      // ç›‘æ§å¤±è´¥ä¸åº”å½±å“ä¸šåŠ¡
      console.warn('ç›‘æ§è®°å½•å¤±è´¥:', error.message);
    }
  });
  
  return result;
}
```

### 3. æ‰¹é‡ç›‘æ§ä¼˜åŒ–

```typescript
// âœ… æ‰¹é‡æ“ä½œçš„é«˜æ•ˆç›‘æ§
async processBatchItems(items: any[]) {
  const startTime = Date.now();
  const results = [];
  let successCount = 0;
  let errorCount = 0;
  
  for (const item of items) {
    try {
      const result = await this.processItem(item);
      results.push(result);
      successCount++;
    } catch (error) {
      results.push({ error: error.message });
      errorCount++;
    }
  }
  
  // ç»Ÿä¸€è®°å½•æ‰¹é‡ç›‘æ§ï¼ˆä½¿ç”¨HTTPè¯·æ±‚ç›‘æ§è®°å½•æ‰¹é‡æ“ä½œï¼‰
  this.collectorService.recordRequest(
    '/internal/batch-process',              // endpoint
    'POST',                                // method
    errorCount > 0 ? 207 : 200,            // statusCode (207=éƒ¨åˆ†æˆåŠŸ)
    Date.now() - startTime,                // duration
    {                                      // metadata
      operation: 'process-batch',
      totalItems: items.length,
      successCount,
      errorCount,
      batchType: 'internal'
    }
  );
  
  return results;
}
```

## å¸¸è§ä½¿ç”¨åœºæ™¯

### 1. æ¥æ”¶å™¨ç»„ä»¶ (Receiver)

```typescript
// src/core/01-entry/receiver/services/receiver.service.ts
async processData(dto: ReceiverDto) {
  const startTime = Date.now();
  
  try {
    // è‡ªåŠ¨å¸‚åœºæ£€æµ‹
    const market = this.detectMarket(dto.symbols[0]);
    
    // æä¾›å•†é€‰æ‹©
    const provider = await this.selectProvider(market, dto.receiverType);
    
    // æ•°æ®å¤„ç†
    const result = await this.dataProcessor.process(dto, provider);
    
    // âœ… æ¥æ”¶å™¨ç›‘æ§
    this.collectorService.recordRequest(
      `/api/receiver/${dto.receiverType}`,  // endpoint
      'POST',                               // method
      200,                                  // statusCode
      Date.now() - startTime,               // duration
      {                                     // metadata
        operation: dto.receiverType,
        provider: provider.name,
        market,
        symbols: dto.symbols,
        resultCount: result.length
      }
    );
    
    return result;
  } catch (error) {
    this.collectorService.recordRequest(
      `/api/receiver/${dto.receiverType}`,  // endpoint
      'POST',                               // method
      500,                                  // statusCode
      Date.now() - startTime,               // duration
      {                                     // metadata
        operation: dto.receiverType,
        error: error.message,
        symbols: dto.symbols
      }
    );
    
    throw error;
  }
}
```

### 2. æŸ¥è¯¢ç»„ä»¶ (Query)

```typescript
// src/core/01-entry/query/services/query.service.ts
async batchQuery(dto: QueryDto) {
  const startTime = Date.now();
  
  try {
    // å¹¶è¡Œå¤„ç†ä¸åŒå¸‚åœº
    const marketResults = await Promise.allSettled([
      this.queryMarket('HK', dto),
      this.queryMarket('US', dto),
      this.queryMarket('SH', dto)
    ]);
    
    const successCount = marketResults.filter(r => r.status === 'fulfilled').length;
    const results = this.mergeResults(marketResults);
    
    // âœ… æ‰¹é‡æŸ¥è¯¢ç›‘æ§
    this.collectorService.recordRequest(
      '/api/query/market-batch',            // endpoint
      'POST',                               // method
      200,                                  // statusCode
      Date.now() - startTime,               // duration
      {                                     // metadata
        operation: 'market-batch-query',
        totalMarkets: 3,
        successCount,
        resultCount: results.length
      }
    );
    
    return results;
  } catch (error) {
    this.collectorService.recordRequest(
      '/api/query/market-batch',            // endpoint
      'POST',                               // method
      500,                                  // statusCode
      Date.now() - startTime,               // duration
      {                                     // metadata
        operation: 'market-batch-query',
        totalMarkets: 3,
        successCount: 0,
        error: error.message
      }
    );
    
    throw error;
  }
}
```

### 3. å­˜å‚¨ç»„ä»¶ (Storage)

```typescript
// src/core/04-storage/storage/services/storage.service.ts
async saveData(data: any[], classification: string) {
  const startTime = Date.now();
  
  try {
    // Redisç¼“å­˜
    const cacheKey = this.generateCacheKey(classification);
    await this.redisClient.setex(cacheKey, 300, JSON.stringify(data));
    
    // MongoDBæŒä¹…åŒ–
    await this.mongoModel.insertMany(data);
    
    // âœ… å­˜å‚¨æ“ä½œç›‘æ§
    this.collectorService.recordDatabaseOperation(
      'insertMany',                         // operation
      Date.now() - startTime,               // duration
      true,                                 // success
      {                                     // metadata
        collection: classification,
        resultCount: data.length
      }
    );
    
    // âœ… ç¼“å­˜æ“ä½œç›‘æ§
    this.collectorService.recordCacheOperation(
      'set',                                // operation
      true,                                 // hit (å¯¹äºsetæ“ä½œï¼Œé€šå¸¸è®¤ä¸ºæ˜¯æˆåŠŸçš„)
      Date.now() - startTime,               // duration
      {                                     // metadata
        cacheType: 'redis',
        key: cacheKey.substring(0, 50)
      }
    );
    
  } catch (error) {
    // é”™è¯¯ç›‘æ§...
    throw error;
  }
}
```

## æ€§èƒ½æ³¨æ„äº‹é¡¹

### 1. é¿å…ç›‘æ§å¼€é”€è¿‡å¤§

```typescript
// âœ… åˆç†çš„ç›‘æ§é¢‘ç‡
class HighFrequencyService {
  private metricsBuffer = [];
  private lastFlush = Date.now();
  
  async highFrequencyOperation() {
    // ä¸šåŠ¡é€»è¾‘
    const result = await this.doWork();
    
    // ç¼“å­˜ç›‘æ§æ•°æ®ï¼Œæ‰¹é‡å‘é€
    this.metricsBuffer.push({
      operation: 'high-freq-op',
      timestamp: Date.now(),
      duration: operationTime
    });
    
    // æ¯5ç§’æ‰¹é‡å‘é€ä¸€æ¬¡
    if (Date.now() - this.lastFlush > 5000) {
      await this.flushMetrics();
    }
    
    return result;
  }
  
  private async flushMetrics() {
    if (this.metricsBuffer.length === 0) return;
    
    const metrics = [...this.metricsBuffer];
    this.metricsBuffer = [];
    this.lastFlush = Date.now();
    
    // æ‰¹é‡å‘é€ç›‘æ§æ•°æ®ï¼ˆä½¿ç”¨å•ä¸ªè®°å½•æ–¹æ³•ï¼‰
    metrics.forEach(metric => {
      this.collectorService.recordRequest(
        '/internal/high-freq-op',         // endpoint
        'POST',                           // method
        200,                              // statusCode
        metric.duration,                  // duration
        { operation: metric.operation }   // metadata
      );
    });
  }
}
```

### 2. ç›‘æ§å¼‚å¸¸ä¸å½±å“ä¸šåŠ¡

```typescript
// âœ… ç›‘æ§æ•…éšœéš”ç¦»
private safeRecordMetrics(endpoint: string, method: string, statusCode: number, duration: number, metadata: any) {
  try {
    this.collectorService.recordRequest(endpoint, method, statusCode, duration, metadata);
  } catch (error) {
    // ç›‘æ§å¤±è´¥ä»…è®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä¸šåŠ¡æµç¨‹
    this.logger.warn(`ç›‘æ§è®°å½•å¤±è´¥: ${error.message}`, { endpoint, method, statusCode, duration, metadata });
  }
}
```

## æµ‹è¯•æŒ‡å¯¼

### 1. å•å…ƒæµ‹è¯•

```typescript
// your-service.spec.ts
describe('YourService', () => {
  let service: YourService;
  let mockCollectorService: jest.Mocked<CollectorService>;
  
  beforeEach(async () => {
    const mockCollector = {
      recordRequest: jest.fn(),
      recordDatabaseOperation: jest.fn(),
      // ... å…¶ä»–æ–¹æ³•
    };
    
    const module = await Test.createTestingModule({
      providers: [
        YourService,
        { provide: CollectorService, useValue: mockCollector },
      ],
    }).compile();
    
    service = module.get<YourService>(YourService);
    mockCollectorService = module.get(CollectorService);
  });
  
  it('should record metrics on successful operation', async () => {
    // æ‰§è¡Œæ“ä½œ
    await service.doSomething();
    
    // éªŒè¯ç›‘æ§è°ƒç”¨
    expect(mockCollectorService.recordRequest).toHaveBeenCalledWith(
      expect.any(String),                 // endpoint
      expect.any(String),                 // method
      200,                                // statusCode
      expect.any(Number),                 // duration
      expect.objectContaining({           // metadata
        operation: 'do-something'
      })
    );
  });
});
```

## è¿ç§»æŒ‡å—

### ä» MetricsRegistryService è¿ç§»åˆ° CollectorService

```typescript
// âŒ æ—§æ–¹å¼ - ç›´æ¥ä½¿ç”¨ MetricsRegistryService
constructor(
  private readonly metricsRegistry: MetricsRegistryService,
) {}

async oldMethod() {
  this.metricsRegistry.getCounter('receiver_requests_total')
    .labels({ provider: 'longport', status: 'success' })
    .inc();
    
  this.metricsRegistry.getHistogram('receiver_duration_seconds')
    .labels({ provider: 'longport' })
    .observe(duration / 1000);
}

// âœ… æ–°æ–¹å¼ - ä½¿ç”¨ CollectorService
constructor(
  private readonly collectorService: CollectorService,
) {}

async newMethod() {
  this.collectorService.recordRequest(
    '/api/stock-quote',                   // endpoint
    'GET',                                // method
    200,                                  // statusCode
    duration,                             // duration
    {                                     // metadata
      operation: 'get-stock-quote',
      provider: 'longport'
    }
  );
}
```

## æ€»ç»“

é€šè¿‡ä½¿ç”¨ `CollectorService` ä½œä¸ºç»Ÿä¸€çš„ç›‘æ§æ¥å£ï¼š

1. **æ ‡å‡†åŒ–è°ƒç”¨**ï¼šæ‰€æœ‰ç›‘æ§æ–¹æ³•ä½¿ç”¨ç»Ÿä¸€çš„å‚æ•°æ ¼å¼ï¼ˆendpoint, method, statusCode, duration, metadataï¼‰
2. **çµæ´»çš„å…ƒæ•°æ®**ï¼šé€šè¿‡ metadata å‚æ•°ä¼ é€’ä¸šåŠ¡ç›¸å…³ä¿¡æ¯
3. **æ˜“äºç»´æŠ¤**ï¼šç›‘æ§é€»è¾‘é›†ä¸­ç®¡ç†ï¼Œå‡å°‘é‡å¤ä»£ç 
4. **ç±»å‹å®‰å…¨**ï¼šåŸºäº TypeScript æ¥å£å®šä¹‰ï¼Œæä¾›ç¼–è¯‘æ—¶æ£€æŸ¥

### å®é™…å¯ç”¨çš„ç›‘æ§æ–¹æ³•

**CollectorService æä¾›ä»¥ä¸‹æ–¹æ³•**ï¼š
- `recordRequest(endpoint, method, statusCode, duration, metadata?)` - è®°å½•HTTPè¯·æ±‚æŒ‡æ ‡
- `recordDatabaseOperation(operation, duration, success, metadata?)` - è®°å½•æ•°æ®åº“æ“ä½œæŒ‡æ ‡
- `recordCacheOperation(operation, hit, duration, metadata?)` - è®°å½•ç¼“å­˜æ“ä½œæŒ‡æ ‡
- `recordSystemMetrics(metrics)` - è®°å½•ç³»ç»ŸæŒ‡æ ‡
- `getRawMetrics(startTime?, endTime?)` - è·å–åŸå§‹æŒ‡æ ‡æ•°æ®
- `getSystemMetrics()` - è·å–ç³»ç»ŸæŒ‡æ ‡
- `cleanup(olderThan?)` - æ¸…ç†è¿‡æœŸæ•°æ®

### é‡è¦æé†’

1. **å‚æ•°æ ¼å¼**ï¼šæ‰€æœ‰æ–¹æ³•éƒ½ä½¿ç”¨ä½ç½®å‚æ•°ï¼Œè€Œéå¯¹è±¡å‚æ•°
2. **å…ƒæ•°æ®ä¼ é€’**ï¼šä¸šåŠ¡ç›¸å…³ä¿¡æ¯é€šè¿‡ metadata å‚æ•°ä¼ é€’
3. **åŒæ­¥è°ƒç”¨**ï¼šç›‘æ§æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œæ— éœ€ await
4. **é”™è¯¯å¤„ç†**ï¼šç›‘æ§å¤±è´¥ä¸åº”å½±å“ä¸»ä¸šåŠ¡æµç¨‹

è¯·åœ¨æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ä¸­é‡‡ç”¨æœ¬æ–‡æ¡£æè¿°çš„æ ‡å‡†æ¨¡å¼ï¼Œç¡®ä¿ç›‘æ§ä½“ç³»çš„ä¸€è‡´æ€§å’Œæœ‰æ•ˆæ€§ã€‚

## API å‚è€ƒ

### CollectorService æ¥å£å®šä¹‰

```typescript
export interface ICollector {
  /**
   * è®°å½•HTTPè¯·æ±‚æŒ‡æ ‡
   */
  recordRequest(endpoint: string, method: string, statusCode: number, duration: number, metadata?: Record<string, any>): void;
  
  /**
   * è®°å½•æ•°æ®åº“æ“ä½œæŒ‡æ ‡
   */
  recordDatabaseOperation(operation: string, duration: number, success: boolean, metadata?: Record<string, any>): void;
  
  /**
   * è®°å½•ç¼“å­˜æ“ä½œæŒ‡æ ‡
   */
  recordCacheOperation(operation: string, hit: boolean, duration: number, metadata?: Record<string, any>): void;
  
  /**
   * è®°å½•ç³»ç»ŸæŒ‡æ ‡
   */
  recordSystemMetrics(metrics: SystemMetricsDto): void;
  
  /**
   * è·å–åŸå§‹æŒ‡æ ‡æ•°æ®ï¼ˆæ— ä»»ä½•è®¡ç®—ï¼‰
   */
  getRawMetrics(startTime?: Date, endTime?: Date): Promise<RawMetricsDto>;
  
  /**
   * è·å–ç³»ç»ŸæŒ‡æ ‡
   */
  getSystemMetrics(): Promise<SystemMetricsDto>;
  
  /**
   * æ¸…ç†è¿‡æœŸæ•°æ®
   */
  cleanup(olderThan?: Date): Promise<void>;
}
```

### å¸¸ç”¨æ•°æ®ç±»å‹

```typescript
export interface SystemMetricsDto {
  memory: {
    used: number;
    total: number;
    percentage: number;
  };
  cpu: {
    usage: number;
  };
  uptime: number;
  timestamp: Date;
}

export interface RawMetricsDto {
  requests?: Array<{
    endpoint: string;
    method: string;
    statusCode: number;
    responseTime: number;
    timestamp: Date;
    authType?: string;
    userId?: string;
  }>;
  database?: Array<{
    operation: string;
    duration: number;
    success: boolean;
    timestamp: Date;
    collection?: string;
  }>;
  cache?: Array<{
    operation: string;
    hit: boolean;
    duration: number;
    timestamp: Date;
    key?: string;
  }>;
  system?: SystemMetricsDto;
}
```