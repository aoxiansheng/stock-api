
inferMarketFromSymbol é‡å¤å®ç°

åŸºäºå¸‚åœºä¼˜å…ˆçº§çš„æ™ºèƒ½é€‰æ‹© + å®‰å…¨å›é€€æœºåˆ¶
æ–°å¢æ–¹æ³•: getDefaultProvider, analyzeMarketDistribution, getProviderByMarketPriority

å¤§éƒ¨åˆ†æµ‹è¯•éƒ½å·²ç»é€šè¿‡ï¼Œä½†æ˜¯æˆ‘å‘ç°æµ‹è¯•ä»£ç å­˜åœ¨æŠ•æœºæ€§è¡Œä¸ºï¼Œä¸ºäº† æµ‹è¯•é€šè¿‡è€Œé€šè¿‡ï¼Œè¿™äº›æ–­è¨€æ²¡æœ‰ååº”åç«¯çœŸå®çš„è®¾è®¡ç›®çš„å’Œè¡Œä¸ºã€‚ä½ ç°åœ¨çš„å·¥ä½œå°±æ˜¯åˆ†æè¿™äº›æ–­è¨€æ˜¯å¦æ˜¯æŠ•æœºæ€§çš„ã€‚

  - å¹¶å‘å®‰å…¨æ€§ç¼ºå¤±
    - WebSocketé‡è¿é€»è¾‘é—®é¢˜
    - å¼‚å¸¸å¤„ç†ä¸ä¸€è‡´
  2. æ¶æ„ä¼˜åŒ–æœºä¼šï¼š
    - å»ºè®®å¼•å…¥äº‹ä»¶é©±åŠ¨æ¶æ„
    - å®ç°è¿æ¥æ± ç®¡ç†
- é”™è¯¯å¤„ç†ç»Ÿä¸€è§„èŒƒ é”™è¯¯ä¸€è‡´æ€§
  - ç±»å‹å®‰å…¨æ”¹è¿›è®¡åˆ’

Dto çš„ç®€åŒ–
é›†æˆ dto çš„æ‹†åˆ†

æšä¸¾å€¼ä¸å¸¸é‡çš„é‡å¤å®šä¹‰


æ€§èƒ½ç»Ÿè®¡å ä½å®ç° ğŸ”´ é«˜ä¼˜å…ˆçº§
ä½ç½®: src/core/04-storage/storage/services/storage.service.ts


@Throttle({ default: { limit: 30, ttl: 60000 } })  åº”è¯¥é…ç½® è€Œä¸æ˜¯ç¡¬ç¼–ç  
å¸‚åœºçŠ¶æ€æ²¡æœ‰ api æ”¯æŒ éœ€è¦æ·»åŠ  futu çš„æ‹“å±•
market-awareness-caching.e2e.test.ts

npx jest --config test/config/jest.blackbox.config.js  market-awareness-caching.e2e.test.ts //æœªæµ‹è¯•
   

StreamReceiver â†’ SymbolTransformerService â†’ SymbolMapperCacheService    â†’ stream-data-fetcher â†’ transformer  â†’ è¿”å›æ•°æ®
ä½†è¿™é‡Œçš„â€œè·å–è§„åˆ™â€è¿™ä¸ªåŠ¨ä½œï¼Œæ­£æ˜¯ç”± SymbolTransformerService å§”æ‰˜ SymbolMapperCacheService å»å®Œæˆçš„ã€‚

   * SymbolTransformerService çš„è§’è‰²æ˜¯ â€œè½¬æ¢æµç¨‹çš„ç®¡ç†è€…/æ‰§è¡Œè€…â€ã€‚å®ƒæ¥æ”¶ä»»åŠ¡ï¼Œå¹¶ç®¡ç†å®Œæˆä»»åŠ¡æ‰€éœ€çš„æ‰€æœ‰æ­¥éª¤ã€‚
   * SymbolMapperCacheService çš„è§’è‰²æ˜¯ â€œæ˜ å°„è§„åˆ™çš„æä¾›è€…ï¼ˆå¸¦ç¼“å­˜ï¼‰â€ã€‚å®ƒçš„èŒè´£å¾ˆçº¯ç²¹ï¼šç»™æˆ‘ä¸€ä¸ªè¾“å…¥ï¼Œæˆ‘ç»™ä½ ä¸€ä¸ªè¾“å‡ºï¼Œå¹¶ä¸”æˆ‘ä¼šç”¨ç¼“å­˜æ¥åŠ é€Ÿã€‚

  SymbolTransformerService ä½œä¸ºâ€œæ‰§è¡Œè€…â€ï¼Œå®ƒçš„æ‰§è¡Œæ­¥éª¤ä¹‹ä¸€å°±æ˜¯è°ƒç”¨ SymbolMapperCacheService æ¥â€œè·å–è§„åˆ™â€ã€‚å› æ­¤ï¼Œè°ƒç”¨é“¾å¿…ç„¶æ˜¯ Transformer 
  â†’ Cacheã€‚
    
ç”¨æˆ·ç®¡ç†ï¼Œå¢åˆ æ”¹ï¼Œroot ç”¨æˆ·çš„æƒé™ï¼Œå¯ä»¥åˆ é™¤ admin å’Œ developerã€‚

åŸºç¡€å·¥å…·ç±»
é€šç”¨è£…é¥°å™¨
é€šç”¨æ‹¦æˆªå™¨
é€šç”¨ç±»å‹å®šä¹‰
é€šç”¨åˆ†é¡µ é€šç”¨å“åº”ã€‚

ThrottlerGuard å…¨å±€é™æµå™¨è¢«ä¿®æ”¹äº†
æ™ºèƒ½ç¼“å­˜æœ‰ç–‘é—® Storage å‚¨å­˜å™¨ 

Websocket çš„æƒé™è®¾ç½® æˆ‘æœ‰ç–‘æƒ‘ åº”è¯¥æœ‰ä¸€ä¸ª closeï¼Œç„¶å write æƒé™ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿï¼Ÿ


ç°åœ¨æˆ‘ä»¬éœ€è¦ç¡®è®¤æˆ‘ä»¬çš„é‡æ„æ˜¯å¦å®ç°äº†æˆ‘çš„è¦æ±‚.é¢„å®šé¡ºåºæ˜¯:Request â†’ Receiver â†’ SymbolMapper â†’  DataFetcher â†’ Transformer â†’ Storage â†’ Response.æˆ‘ä»¬çš„é¡¹ç›®æ˜¯ä¸€ä¸ªèšä¼šç¬¬ä¸‰æ–¹ sdk è·å–è‚¡ç¥¨ä¿¡æ¯çš„é¡¹ç›®,ç”¨æˆ·å‘èµ·å¯¹æˆ‘ä»¬æ¥å£çš„è¯·æ±‚,ä½¿ç”¨çš„ symbol æ˜¯æ ‡å‡†å­—ç¬¦ä¸²æ¯”å¦‚ 00700.HK,ç”±äºç¬¬ä¸‰æ–¹ sdkå¯èƒ½éœ€è¦ä¸“ç”¨ sdksymbol æ¯”å¦‚ 700.HK,å› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨è½¬åŒ–å™¨SymbolMapper è¿›è¡Œè½¬æ¢.ç„¶åå‘é€ è½¬æ¢åçš„ symbolåˆ°ç¬¬ä¸‰æ–¹ sdk,ä¹Ÿå°±æ˜¯ä½¿ç”¨DataFetcherç»„ä»¶,ç„¶åç¬¬ä¸‰æ–¹ç»„ä»¶è¿”å›çš„æ•°æ®,æ¯ä¸ª sdk å•†çš„æ ¼å¼éƒ½ä¸ä¸€æ ·,å› æ­¤æˆ‘ä»¬é¢„è®¾ç»„ä»¶Data-Mapperå®ç°äº†æ•°æ®æ˜ å°„è§„åˆ™,æˆ‘ä»¬çš„Transformeræ•°æ®è½¬åŒ–å™¨ä¼šè¯»å–Data-Mapper  è®¾ç½®è§„åˆ™,å¯¹æ•°æ®è¿›è¡Œæ ¼å¼åŒ–,æ¥ç€Storageè¿›è¡Œå‚¨å­˜å,è¿”å›ç»™ç”¨æˆ·éœ€è¦çš„æ•°æ®. 

æ•°æ®æµç¨‹æ­£ç¡®å®ç°ï¼š
1. è¯·æ±‚é¦–å…ˆç”±Receiveræ¥æ”¶
2. Receiverå§”æ‰˜SymbolMapperè¿›è¡Œç¬¦å·è½¬æ¢
3. Receiverå°†è½¬æ¢åçš„ç¬¦å·ä¼ é€’ç»™DataFetcherå¤„ç†SDKè°ƒç”¨
4. è·å–åˆ°åŸå§‹æ•°æ®åï¼ŒReceiverå§”æ‰˜Transformerè¿›è¡Œæ ¼å¼è½¬æ¢
5. Transformerä½¿ç”¨Data-Mapperçš„æ˜ å°„è§„åˆ™è¿›è¡Œæ•°æ®æ ‡å‡†åŒ–
6. è½¬æ¢åçš„æ•°æ®ä¼ é€’ç»™Storageç»„ä»¶è¿›è¡Œå­˜å‚¨
7. æœ€åè¿”å›æ ‡å‡†åŒ–çš„å“åº”æ•°æ®


 ç”¨æˆ·è¯·æ±‚: { symbols: ["00700.HK"], receiverType: "get-stock-quote" }
      â†“
  Receiver: éªŒè¯è¯·æ±‚ï¼Œé€‰æ‹©provider (å¦‚longport)
      â†“
  SymbolMapper: 00700.HK â†’ 700.HK (SDKæ ¼å¼)
      â†“
  DataFetcher: è°ƒç”¨LongPort SDKè·å– { symbol: "700.HK", last_done: 385.6 }
      â†“
  Transformer: è¯»å–Data-Mapperè§„åˆ™ï¼Œè½¬æ¢ä¸º { symbol: "00700.HK", lastPrice: 385.6 }
      â†“
  Storage: å­˜å‚¨åˆ°Rediså’ŒMongoDB
      â†“
  Response: è¿”å›æ ‡å‡†åŒ–æ•°æ®ç»™ç”¨æˆ·



3. **é”™è¯¯ä»£ç é‡å¤æ¨¡å¼**
   - ä½ç½®: auth/constants/auth.constants.ts:211-227, permission.constants.ts:195-206, apikey.constants.ts:159-170
   - å½±å“: é”™è¯¯ä»£ç å®šä¹‰æ¨¡å¼ç›¸ä¼¼ä½†åˆ†æ•£
   - å»ºè®®: è€ƒè™‘ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯ä»£ç ç”Ÿæˆå™¨æˆ–åŸºç¡€æ¨¡æ¿


æ¶ˆé™¤ any
