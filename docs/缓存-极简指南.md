# 缓存组件（cachev2）极简指南

目标：提供最小可用且稳定的缓存基础设施，仅暴露业务真实使用的 5 个方法，移除复杂配置、演示控制器与冗余 DTO。

## 能力范围

- 键值操作：`get<T>(key)`、`set<T>(key, value, { ttl? })`、`del(key)`
- 计数/过期：`incr(key)`、`expire(key, seconds)`
- 默认 TTL：300 秒（调用方可在 set 时显式传入 `ttl`）
- 序列化：固定 JSON，取消压缩与 MsgPack（KISS/YAGNI）
- 安全：1MB 硬限制（JSON Bomb 防护），连接错误与通用错误使用统一异常工厂

## 使用方式

```ts
import { CacheModule, CacheService } from '@cachev2';

@Module({ imports: [CacheModule] })
export class AnyFeatureModule {}

@Injectable()
export class FooService {
  constructor(private readonly cache: CacheService) {}

  async demo() {
    await this.cache.set('foo:1', { a: 1 }, { ttl: 600 });
    const val = await this.cache.get<{ a: number }>('foo:1');
    await this.cache.incr('foo:counter');
    await this.cache.expire('foo:1', 120);
    await this.cache.del('foo:1');
  }
}
```

## 环境与依赖

- 依赖全局 Redis 连接（`@nestjs-modules/ioredis`），在 `src/app.module.ts` 已配置
- 无组件级环境变量（删除所有 `CACHE_*` 配置与校验）

## 与旧版差异

- 删除：演示控制器/Swagger/DTO、批量接口、列表/集合/哈希操作、压缩/MsgPack、复杂统一配置
- 路径切换：`@cache/*` → `@cachev2/*`；类名与注入 token 保持 `CacheService`/`CacheModule`
- 行为等价：现有业务路径仅使用的五个方法保持不变

## 错误与日志

- 连接失败：`EXTERNAL_SERVICE_UNAVAILABLE`
- 操作失败：`EXTERNAL_API_ERROR`
- 数据超限：`DATA_VALIDATION_FAILED`（> 1MB）
- 日志：仅最小化 `debug/warn`，不内置采样或事件

## 迁移清单

- 导入：将 `@cache/module/cache.module` 替换为 `@cachev2/cache.module`
- 服务：将 `@cache/services/cache.service` 替换为 `@cachev2/cache.service`
- 删除：`src/cache/**` 与相关测试；文档与示例引用同步清理

## 原则落实

- KISS：固定 JSON、固定 5 个方法、无演示控制器/复杂配置
- YAGNI：移除未被业务使用的接口与能力（批量、集合、压缩、MsgPack）
- DRY：统一从一个服务进入，不复用多处 TTL/阈值配置
- SOLID：单一职责、开闭扩展、小接口、依赖 Redis 抽象

