# 修订版常量优化策略

## 📊 过滤后的真实问题分析

经过智能过滤，正确排除了导入路径等合理重复，聚焦于真正需要优化的问题：

### 🔢 核心问题：重复数字 (154个)

**高频业务配置数字需要优化：**

| 数字 | 重复次数 | 问题场景 | 业务含义 |
|------|----------|----------|----------|
| **5** | 505次 | `0.05`阈值、`slice(-5)`、`< 5`判断 | 监控阈值、采样大小 |
| **100** | 361次 | 分页大小、百分比基数 | 分页配置、性能基准 |
| **1000** | 261次 | 超时时间、批量大小 | 快速操作超时 |
| **10000** | 100次 | 长超时、大批量处理 | 数据库操作超时 |
| **30000** | 55次 | API请求超时 | 标准请求超时 |
| **5000** | 85次 | 中等操作超时 | 监控请求超时 |
| **3600** | 46次 | 1小时秒数 | 缓存TTL |
| **86400** | 32次 | 1天秒数 | 日缓存配置 |

### 📝 核心问题：业务字符串重复

**需要优化的业务特定字符串：**

| 字符串 | 重复次数 | 问题分析 | 业务含义 |
|--------|----------|----------|----------|
| `"2024-01-01T12:00:00.000Z"` | 73次 | 硬编码测试时间 | 标准参考时间 |
| `"longport"` | 65次 | 提供商标识符硬编码 | 主要数据提供商 |
| `"get-stock-quote"` | 26次 | API操作类型硬编码 | 核心API操作 |
| `"700.HK"` | 23次 | 测试股票代码硬编码 | 标准测试股票 |
| `"quote"` | 32次 | 数据类型标识 | 报价数据类型 |

**注意：环境相关的字符串如 `"development"`、`"production"` 是合理重复，不需要优化**

## 🎯 精准优化方案

### 阶段一：业务数字常量化 (1天)

#### 1.1 监控和性能阈值

```typescript
// src/common/constants/domain/monitoring-business.constants.ts
export const MONITORING_BUSINESS = Object.freeze({
  ERROR_THRESHOLDS: {
    ACCEPTABLE_RATE: 0.05,         // 5% - 可接受错误率 (505次中的0.05)
    WARNING_RATE: 0.1,             // 10% - 警告错误率
    CRITICAL_RATE: 0.2,            // 20% - 严重错误率
  },
  
  CHANGE_DETECTION: {
    MINIMAL_CHANGE_PERCENT: 5,     // 5% - 最小变化阈值 (505次中的5)
    SIGNIFICANT_CHANGE_PERCENT: 10, // 10% - 显著变化
    MAJOR_CHANGE_PERCENT: 20,      // 20% - 重大变化
  },
  
  SAMPLING_CONFIG: {
    RECENT_METRICS_COUNT: 5,       // 最近数据点数量 (505次中的slice(-5))
    MIN_DATA_POINTS: 5,            // 最小数据要求
    DEFAULT_SUGGESTION_LIMIT: 5,   // 建议数量限制
  },
  
  PERFORMANCE_BENCHMARKS: {
    GOOD_SCORE_THRESHOLD: 90,      // 90分以上为良好
    EXCELLENT_SCORE_THRESHOLD: 95, // 95分以上为优秀
    CACHE_HIT_GOOD: 70,           // 70% 缓存命中率良好
    CACHE_HIT_EXCELLENT: 90,      // 90% 缓存命中率优秀
  }
} as const);
```

#### 1.2 超时和大小配置

```typescript
// src/common/constants/domain/operation-limits.constants.ts
export const OPERATION_LIMITS = Object.freeze({
  TIMEOUTS_MS: {
    QUICK_OPERATION: 1000,         // 1秒 - 快速操作 (261次重复)
    MONITORING_REQUEST: 5000,      // 5秒 - 监控请求 (85次重复) 
    DATABASE_OPERATION: 10000,     // 10秒 - 数据库操作 (100次重复)
    API_REQUEST: 30000,            // 30秒 - API请求超时 (55次重复)
    LONG_OPERATION: 60000,         // 60秒 - 长时间操作 (43次重复)
  },
  
  BATCH_SIZES: {
    DEFAULT_PAGE_SIZE: 100,        // 默认分页大小 (361次重复)
    STANDARD_BATCH: 1000,          // 标准批量处理 (261次重复)
    LARGE_BATCH: 10000,            // 大批量处理 (100次重复)
  },
  
  CACHE_TTL_SECONDS: {
    SHORT_CACHE: 300,              // 5分钟短期缓存 (61次重复)
    HOURLY_CACHE: 3600,            // 1小时缓存 (46次重复)
    DAILY_CACHE: 86400,            // 1天缓存 (32次重复)
  }
} as const);
```

### 阶段二：业务字符串常量化 (0.5天)

#### 2.1 测试和示例数据

```typescript
// src/common/constants/domain/reference-data.constants.ts
export const REFERENCE_DATA = Object.freeze({
  TEST_TIMESTAMPS: {
    REFERENCE_DATE: '2024-01-01T12:00:00.000Z', // 标准参考时间 (73次重复)
    YEAR_START: '2024-01-01T00:00:00.000Z',
    YEAR_END: '2024-12-31T23:59:59.999Z',
  },
  
  SAMPLE_SYMBOLS: {
    HK_TENCENT: '700.HK',          // 腾讯股票 - 香港市场示例 (23次重复)
    US_APPLE: 'AAPL.US',           // 苹果股票 - 美国市场示例  
    CN_PING_AN: '000001.SZ',       // 平安银行 - 中国市场示例
  },
  
  PROVIDER_IDS: {
    LONGPORT: 'longport',          // 长桥证券 (65次重复)
    LONGPORT_SG: 'longport-sg',    // 长桥新加坡
  }
} as const);
```

#### 2.2 API操作类型

```typescript
// src/common/constants/domain/api-operations.constants.ts
export const API_OPERATIONS = Object.freeze({
  STOCK_DATA: {
    GET_QUOTE: 'get-stock-quote',        // 获取股票报价 (26次重复)
    GET_INFO: 'get-stock-info',          // 获取股票信息
    STREAM_QUOTE: 'stream-stock-quote',  // 流式报价
  },
  
  DATA_TYPES: {
    QUOTE: 'quote',                      // 报价数据 (32次重复)  
    CHART: 'chart',                      // 图表数据
    NEWS: 'news',                        // 新闻数据
    FUNDAMENTAL: 'fundamental',          // 基本面数据
  }
} as const);
```

### 阶段三：批量替换实施 (0.5天)

#### 3.1 创建智能替换规则

```typescript
// tools/business-constant-replacer.util.ts
export class BusinessConstantReplacer {
  private readonly replacements = [
    // 监控阈值替换
    {
      pattern: /errorRate\s*[><=]+\s*0\.05/g,
      replacement: 'errorRate $operator MONITORING_BUSINESS.ERROR_THRESHOLDS.ACCEPTABLE_RATE',
      import: "import { MONITORING_BUSINESS } from '@common/constants';"
    },
    {
      pattern: /\.slice\(-5\)/g,
      replacement: '.slice(-MONITORING_BUSINESS.SAMPLING_CONFIG.RECENT_METRICS_COUNT)',
      import: "import { MONITORING_BUSINESS } from '@common/constants';"
    },
    
    // 超时替换
    {
      pattern: /timeout[:\s]*30000/gi,
      replacement: 'timeout: OPERATION_LIMITS.TIMEOUTS_MS.API_REQUEST',
      import: "import { OPERATION_LIMITS } from '@common/constants';"
    },
    {
      pattern: /1000\s*(?=.*(?:timeout|delay|ms))/gi,
      replacement: 'OPERATION_LIMITS.TIMEOUTS_MS.QUICK_OPERATION',
      import: "import { OPERATION_LIMITS } from '@common/constants';"
    },
    
    // 业务字符串替换
    {
      pattern: /"2024-01-01T12:00:00\.000Z"/g,
      replacement: 'REFERENCE_DATA.TEST_TIMESTAMPS.REFERENCE_DATE',
      import: "import { REFERENCE_DATA } from '@common/constants';"
    },
    {
      pattern: /"longport"/g,
      replacement: 'REFERENCE_DATA.PROVIDER_IDS.LONGPORT',
      import: "import { REFERENCE_DATA } from '@common/constants';"
    },
    {
      pattern: /"get-stock-quote"/g,
      replacement: 'API_OPERATIONS.STOCK_DATA.GET_QUOTE',
      import: "import { API_OPERATIONS } from '@common/constants';"
    },
    {
      pattern: /"700\.HK"/g,
      replacement: 'REFERENCE_DATA.SAMPLE_SYMBOLS.HK_TENCENT',
      import: "import { REFERENCE_DATA } from '@common/constants';"
    }
  ];

  async replaceInFile(filePath: string): Promise<void> {
    // 实施智能替换，包括自动添加导入
  }
}
```

## 📊 优化效果预期

### 精准优化指标

| 优化项 | 当前状态 | 优化后 | 减少率 |
|--------|----------|-------|--------|
| 核心业务数字重复 | 154个 | <15个 | 90%+ |
| 关键业务字符串重复 | ~20个高频 | <3个 | 85%+ |
| 硬编码测试数据 | 73+65+26+23=187处 | 0处 | 100% |

### 具体改善示例

**数字 `5` 的505次重复按上下文分类：**
- `errorRate > 0.05` → `errorRate > MONITORING_BUSINESS.ERROR_THRESHOLDS.ACCEPTABLE_RATE`
- `.slice(-5)` → `.slice(-MONITORING_BUSINESS.SAMPLING_CONFIG.RECENT_METRICS_COUNT)`  
- `< 5` → `< MONITORING_BUSINESS.SAMPLING_CONFIG.MIN_DATA_POINTS`

**字符串完全消除硬编码：**
- `"2024-01-01T12:00:00.000Z"` (73处) → `REFERENCE_DATA.TEST_TIMESTAMPS.REFERENCE_DATE`
- `"longport"` (65处) → `REFERENCE_DATA.PROVIDER_IDS.LONGPORT`
- `"700.HK"` (23处) → `REFERENCE_DATA.SAMPLE_SYMBOLS.HK_TENCENT`

## ⚠️ 优化原则 (修订版)

### ✅ 需要优化的重复

1. **业务配置数字**: 超时时间、批量大小、监控阈值
2. **测试数据**: 固定时间戳、示例股票代码、测试用例
3. **业务标识**: 提供商ID、API操作类型、数据类型标识
4. **性能参数**: 缓存TTL、分页大小、采样数量

### ❌ 不优化的合理重复 (已正确过滤)

1. **导入路径**: `"@nestjs/common"`、`"@app/config/xxx"` - **完全不需要优化**
2. **环境标识**: `"development"`、`"production"` - 环境相关的自然重复
3. **通用状态**: `"success"`、`"pending"`、`"healthy"` - 标准状态词
4. **TypeScript类型**: `"string"`、`"object"` - 语言类型声明
5. **标准格式**: 时间格式、HTTP状态码 - 行业标准

## 🚀 实施时间表

| 阶段 | 任务 | 时间 | 重点内容 |
|------|------|------|----------|
| **阶段一** | 业务数字常量化 | 1天 | 监控阈值、超时配置、批量大小 |
| **阶段二** | 业务字符串常量化 | 0.5天 | 测试数据、API操作、提供商标识 |
| **阶段三** | 批量替换实施 | 0.5天 | 智能替换、测试验证 |
| **总计** | | **2天** | **精准、务实、高效** |

## 📈 成功标准

### 技术指标
- [ ] 核心业务数字重复减少90%+ (154 → <15)
- [ ] 硬编码业务字符串100%消除
- [ ] 所有测试通过，零编译错误
- [ ] 性能无回归

### 质量指标  
- [ ] 代码业务语义更清晰
- [ ] 测试数据标准化和复用
- [ ] 监控配置集中管理
- [ ] 新功能开发更高效

---

## 🎯 总结

修订后的策略正确聚焦于真正的问题：

**排除了不该优化的：**
- ✅ 导入路径重复 - 这是正常和必要的
- ✅ 环境配置重复 - 这是合理的
- ✅ 通用状态词重复 - 这是标准化的

**聚焦真正的问题：**
- 🎯 **154个业务配置数字** - 监控阈值、超时配置等
- 🎯 **核心业务字符串** - 测试数据、API操作、提供商标识
- 🎯 **硬编码问题** - 测试时间、股票代码等

**2天精准优化，避免过度工程，解决真正影响维护的重复问题！**