# 📖 New Stock API 测试命令完整说明文档

## 🚀 基础测试命令

### **主要入口命令**
| 命令 | 说明 | 用途 |
|------|------|------|
| `bun test` | 快速完整测试 | 运行单元+集成+端到端+安全+性能测试，适合日常开发 |
| `bun test:all` | 完整详细测试 | 运行所有模块的详细测试，适合发布前验证 |

## 📋 单元测试命令 (Unit Tests)

### **基础单元测试**
| 命令 | 说明 | 执行内容 |
|------|------|----------|
| `bun test:unit` | 基础单元测试 | 使用Jest配置运行所有单元测试 |
| `bun test:unit:all` | 完整单元测试 | 按模块逐一运行所有单元测试 |
| `bun test:unit:watch` | 监听模式单元测试 | 文件变化时自动重新运行单元测试 | 
| `bun test:unit:coverage` | 单元测试覆盖率 | 生成单元测试覆盖率报告 |

### **模块化单元测试**
| 命令 | 说明 | 测试模块 |
|------|------|----------|
| `bun test:unit:auth` | 认证模块单元测试 | JWT认证、API密钥、权限验证 |
| `bun test:unit:core` | 核心模块单元测试 | 6大核心组件(接收器、映射器等) |
| `bun test:unit:common` | 共享模块单元测试 | 工具类、常量、装饰器 |
| `bun test:unit:alert` | 告警模块单元测试 | 告警规则、通知服务 |
| `bun test:unit:cache` | 缓存模块单元测试 | Redis缓存操作 |
| `bun test:unit:metrics` | 指标模块单元测试 | 性能监控、指标收集 |
| `bun test:unit:security` | 安全模块单元测试 | 安全扫描、审计服务 |
| `bun test:unit:monitoring` | 监控模块单元测试 | 系统监控、健康检查 |
| `bun test:unit:providers` | 提供商模块单元测试 | 提供商、能力注册表 |

#### **独立测试命令**
npx jest --config test/config/jest.unit.config.js data-mapper.controller.spec.ts

## 🔗 集成测试命令 (Integration Tests)

### **基础集成测试**
| 命令 | 说明 | 执行内容 |
|------|------|----------|
| `bun test:integration` | 基础集成测试 | 模块间接口和数据交互测试 |
| `bun test:integration:all` | 完整集成测试 | 按模块逐一运行所有集成测试 |
| `bun test:integration:watch` | 监听模式集成测试 | 文件变化时自动重新运行集成测试 |
| `bun test:integration:coverage` | 集成测试覆盖率 | 生成集成测试覆盖率报告 |



### **模块化集成测试**
| 命令 | 说明 | 测试范围 |
|------|------|----------|
| `bun test:integration:auth` | 认证集成测试 | 认证与数据库、缓存的集成 |
| `bun test:integration:core` | 核心集成测试 | 核心组件间的数据流集成 |
| `bun test:integration:monitoring` | 监控集成测试 | 监控与各模块的集成 |
| `bun test:integration:alert` | 告警集成测试 | 告警与缓存、数据库的集成 |
| `bun test:integration:metrics` | 指标集成测试 | 指标收集与存储的集成 |
| `bun test:integration:security` | 安全集成测试 | 安全模块与缓存的集成 |
| `bun test:integration:cross-module` | 跨模块集成测试 | 多模块协作的综合测试 |
| `bun test:integration:common` | 共享集成测试 | 共享组件的集成验证 |
| `bun test:integration:providers` | 提供商集成测试 | 提供商模块的集成 |
| `bun test:integration:cache` | 缓存集成测试 | 缓存模块的集成 |


#### **独立测试命令**
npx jest --config test/config/jest.integration.config.js test/jest/integration/auth/auth-database.integration.test.ts

## 🌐 端到端测试命令 (E2E Tests)

### **基础端到端测试**
| 命令 | 说明 | 执行内容 |
|------|------|----------|
| `bun test:e2e` | 基础端到端测试 | 完整用户流程测试 |
| `bun test:e2e:all` | 完整端到端测试 | 按模块逐一运行所有E2E测试 |
| `bun test:e2e:watch` | 监听模式E2E测试 | 文件变化时自动重新运行E2E测试 |
| `bun test:e2e:coverage` | E2E测试覆盖率 | 生成端到端测试覆盖率报告 ✅ |

### **模块化端到端测试**
| 命令 | 说明 | 测试场景 |
|------|------|----------|
| `bun test:e2e:auth` | 认证E2E测试 | 完整认证流程端到端验证 |
| `bun test:e2e:core` | 核心E2E测试 | 数据处理完整流程测试 |
| `bun test:e2e:monitoring` | 监控E2E测试 | 监控系统完整功能测试 |
| `bun test:e2e:cache` | 缓存E2E测试 | 缓存操作的端到端验证 |
| `bun test:e2e:metrics` | 指标E2E测试 | 性能指标的端到端测试 |
| `bun test:e2e:common` | 共享E2E测试 | 响应格式、错误处理的E2E测试 |
| `bun test:e2e:alert` | 告警E2E测试 | 告警系统的端到端验证 |



#### **独立测试命令**
npx jest --config test/config/jest.e2e.config.js health-checks.e2e.test.ts

## 🛡️ 安全测试命令 (Security Tests)

### **基础安全测试**
| 命令 | 说明 | 执行内容 |
|------|------|----------|
| `bun test:security` | 基础安全测试 | 运行所有安全漏洞扫描 |
| `bun test:security:all` | 完整安全测试 | 按模块逐一运行所有安全测试 |
| `bun test:security:watch` | 监听模式安全测试 | 文件变化时自动重新运行安全测试 |

### **模块化安全测试**
| 命令 | 说明 | 安全检查内容 |
|------|------|-------------|
| `bun test:security:auth` | 认证安全测试 | 权限验证、身份认证漏洞扫描 |
| `bun test:security:core` | 核心安全测试 | 数据安全、输入验证漏洞扫描 |
| `bun test:security:common` | 共享安全测试 | 基础设施安全漏洞扫描 |
| `bun test:security:alert` | 告警安全测试 | 告警系统的安全漏洞扫描 |
| `bun test:security:cache` | 缓存安全测试 | 缓存数据的安全漏洞扫描 |
| `bun test:security:metrics` | 指标安全测试 | 性能指标的安全漏洞扫描 |
| `bun test:security:monitoring` | 监控安全测试 | 监控系统的安全漏洞扫描 |


#### **独立测试命令**
npx jest --config test/config/jest.security.config.js infrastructure-security.test.ts


## ⚡ 性能测试命令 (Performance Tests)

### **基础性能测试**
| 命令 | 说明 | 测试内容 |
|------|------|----------|
| `bun test:perf` | 基础性能测试 | 认证+数据+API的核心性能测试 |
| `bun test:perf:all` | 完整性能测试 | 所有模块的综合性能测试 |

### **具体性能测试**
| 命令 | 说明 | 性能测试类型 |
|------|------|-------------|
| `bun test:perf:auth` | 认证性能测试 | 认证系统压力测试 |
| `bun test:perf:auth-spike` | 认证尖峰测试 | 认证系统尖峰负载测试 |
| `bun test:perf:data` | 数据性能测试 | 数据处理性能测试 |
| `bun test:perf:volume` | 大容量测试 | 高容量数据处理测试 |
| `bun test:perf:api` | API性能测试 | API接口压力测试 |
| `bun test:perf:api:spike` | API尖峰测试 | API接口尖峰负载测试 |
| `bun test:perf:bulk` | 批量请求测试 | 批量API请求性能测试 |
| `bun test:perf:auth:load` | 认证负载测试 | 认证系统负载均衡测试 |
| `bun test:perf:security` | 安全性能测试 | 安全模块的性能测试 |

### **组合性能测试**
| 命令 | 说明 | 组合测试内容 |
|------|------|-------------|
| `bun test:perf:api:all` | 完整API性能测试 | API+尖峰+批量的综合测试 |
| `bun test:perf:spike` | 尖峰综合测试 | 认证+API尖峰负载测试 |
| `bun test:perf:stress` | 压力综合测试 | 认证+API压力测试 |
| `bun test:perf:load` | 负载综合测试 | 认证负载+批量请求测试 |

### **数据流性能测试 (占位符)**
| 命令 | 说明 | 状态 |
|------|------|------|
| `bun test:perf:data-flow` | 数据流性能测试 | 占位符(待实现) |
| `bun test:perf:load:data-flow` | 数据流负载测试 | 占位符(待实现) |
| `bun test:perf:spike:data-flow` | 数据流尖峰测试 | 占位符(待实现) |
| `bun test:perf:stress:data-flow` | 数据流压力测试 | 占位符(待实现) |

## 📊 测试覆盖率命令 (Coverage Tests)

### **基础覆盖率测试**
| 命令 | 说明 | 覆盖范围 |
|------|------|----------|
| `bun test:coverage:all` | 完整覆盖率测试 | 单元+集成+E2E覆盖率+报告合并 |
| `bun test:coverage` | 模块覆盖率测试 | 各模块详细覆盖率测试 |

### **基础类型覆盖率**
| 命令 | 说明 | 覆盖率类型 |
|------|------|----------|
| `bun test:coverage:unit` | 单元测试覆盖率 | 生成单元测试覆盖率报告 |
| `bun test:coverage:integration` | 集成测试覆盖率 | 生成集成测试覆盖率报告 |
| `bun test:coverage:e2e` | E2E测试覆盖率 | 生成端到端测试覆盖率报告 ✅ |
| `bun test:coverage:security` | 安全测试覆盖率 | 生成安全测试覆盖率报告 ✅ |

### **模块化覆盖率测试**
| 命令 | 说明 | 模块范围 |
|------|------|----------|
| `bun test:coverage:auth` | 认证模块覆盖率 | 认证模块单元测试覆盖率 |
| `bun test:coverage:core` | 核心模块覆盖率 | 核心模块单元测试覆盖率 |
| `bun test:coverage:common` | 共享模块覆盖率 | 共享模块单元测试覆盖率 |
| `bun test:coverage:alert` | 告警模块覆盖率 | 告警模块单元测试覆盖率 |
| `bun test:coverage:cache` | 缓存模块覆盖率 | 缓存模块单元测试覆盖率 |
| `bun test:coverage:metrics` | 指标模块覆盖率 | 指标模块单元测试覆盖率 |
| `bun test:coverage:security:unit` | 安全模块单元覆盖率 | 安全模块单元测试覆盖率 |
| `bun test:coverage:monitoring` | 监控模块覆盖率 | 监控模块单元测试覆盖率 |
| `bun test:coverage:providers` | 提供商模块覆盖率 | 提供商模块单元测试覆盖率 |
| `bun test:coverage:scripts` | 脚本模块覆盖率 | 启动脚本单元测试覆盖率 |

### **集成覆盖率测试**
| 命令 | 说明 | 集成范围 |
|------|------|----------|
| `bun test:coverage:integration:alert` | 告警集成覆盖率 | 告警模块集成测试覆盖率 |
| `bun test:coverage:integration:cross-module` | 跨模块集成覆盖率 | 跨模块集成测试覆盖率 |
| `bun test:coverage:integration:monitoring` | 监控集成覆盖率 | 监控模块集成测试覆盖率 |

### **E2E覆盖率测试**
| 命令 | 说明 | E2E范围 |
|------|------|----------|
| `bun test:coverage:e2e:alert` | 告警E2E覆盖率 | 告警模块E2E测试覆盖率 |
| `bun test:coverage:e2e:auth` | 认证E2E覆盖率 | 认证模块E2E测试覆盖率 |
| `bun test:coverage:e2e:core` | 核心E2E覆盖率 | 核心模块E2E测试覆盖率 |
| `bun test:coverage:e2e:monitoring` | 监控E2E覆盖率 | 监控模块E2E测试覆盖率 |
| `bun test:coverage:e2e:cache` | 缓存E2E覆盖率 | 缓存模块E2E测试覆盖率 |
| `bun test:coverage:e2e:metrics` | 指标E2E覆盖率 | 指标模块E2E测试覆盖率 |
| `bun test:coverage:e2e:common` | 共享E2E覆盖率 | 共享模块E2E测试覆盖率 |

## 📈 覆盖率报告命令 (Coverage Reports)

| 命令 | 说明 | 功能 |
|------|------|------|
| `coverage:merge` | 合并覆盖率报告 | 将多个覆盖率报告合并为统一报告 |
| `coverage:analyze` | 分析覆盖率 | 分析覆盖率数据并生成分析报告 |
| `coverage:gate-check` | 覆盖率门禁检查 | 检查覆盖率是否达到最低要求 |
| `coverage:trend-check` | 覆盖率趋势检查 | 检查覆盖率变化趋势 |
| `coverage:report` | 生成覆盖率报告 | 合并+分析覆盖率数据 |
| `coverage:full-analysis` | **完整覆盖率分析** ✨ | 运行所有覆盖率工具: 合并+分析+趋势+门禁检查 |
| `coverage:report:html` | HTML覆盖率报告 | 生成HTML格式的覆盖率报告 |
| `coverage:report:lcov` | LCOV覆盖率报告 | 生成LCOV格式的覆盖率报告 |
| `coverage:clean` | 清理覆盖率文件 | 删除所有覆盖率报告文件 |

## 🔧 测试工具命令 (Test Utilities)

### **核心测试工具**
| 命令 | 说明 | 功能 |
|------|------|------|
| `bun test:detect-conflicts` | 检测测试冲突 | 检测测试文件之间的冲突 |
| `bun test:validate-structure` | 验证测试结构 | 验证测试文件结构是否规范(TypeScript版本) |
| `bun test:validate-structure:list` | 显示详细列表 | 展示智能匹配、孤立和缺失的测试文件详细信息 |
| `bun test:validate-structure:repair` | 生成修复脚本 | 生成智能测试结构修复脚本 |
| `bun test:validate-structure:apply` | 执行修复脚本 | 应用自动生成的测试结构修复脚本 |
| `bun test:coverage-mapping` | 覆盖率映射 | 生成测试覆盖率映射关系 |
| `bun test:validate-naming` | 验证命名规范 | 检查测试文件命名是否符合规范 |
| `bun test:validate-config` | 验证测试配置 | 验证Jest配置文件是否正确 |
| `bun test:fix-config` | 修复测试配置 | 自动修复测试配置问题 |
| `bun test:config-report` | 测试配置报告 | 生成测试配置分析报告 |
| `bun test:quality-check` | 测试质量检查 | 综合检查测试质量和配置 |

### **测试辅助工具**
| 命令 | 说明 | 功能 |
|------|------|------|
| `bun test:helpers:api-response` | API响应助手信息 | 显示API响应验证工具的使用方法和示例 |
| `bun test:helpers:monitoring` | 监控测试助手信息 | 显示监控测试辅助工具的使用方法和示例 |
| `bun test:helpers:async` | 异步测试助手 | 异步测试操作的辅助工具 |
| `bun test:helpers:batch-request` | 批量请求助手 | 批量API请求测试工具 |
| `bun test:helpers:concurrent` | 并发请求助手 | 并发请求测试的辅助工具 |
| `bun test:data-manager` | 测试数据管理器信息 | 显示测试数据管理器的使用方法和示例 |

### **测试工具报告命令 ✨**
| 命令 | 说明 | 功能 |
|------|------|------|
| `bun test:tools:all` | 执行所有测试工具 | 运行所有测试辅助工具并生成执行报告 |

## 🚀 CI/CD测试命令 (Continuous Integration)

| 命令 | 说明 | 适用场景 |
|------|------|----------|
| `bun test:ci:quick` | 快速CI测试 | 单元+集成测试，适合快速验证 |
| `bun test:ci:full` | 完整CI测试 | 快速测试+E2E+安全测试，适合发布前 |
| `bun test:ci:security` | CI安全测试 | 安全测试+性能安全测试 |
| `bun test:ci:performance` | CI性能测试 | 认证+数据+API性能测试 |
| `bun test:ci:modules` | CI模块测试 | 核心模块单元测试 |

## 🛠️ 开发工具命令 (Development Tools)

### **开发环境命令**
| 命令 | 说明 | 使用场景 |
|------|------|----------|
| `bun test:dev` | 开发模式测试 | 监听文件变化自动运行单元测试 |

### **调试工具命令**
| 命令 | 说明 | 调试内容 |
|------|------|----------|
| `bun test:debug:auth` | 认证模块调试 | 详细输出认证测试过程，无覆盖率 |
| `bun test:debug:alert` | 告警模块调试 | 详细输出告警测试过程，无覆盖率 |
| `bun test:debug:monitoring` | 监控模块调试 | 详细输出监控测试过程，无覆盖率 |

## 🔍 监控系统测试命令 (Monitoring Tests)

| 命令 | 说明 | 功能 |
|------|------|------|
| `bun test:monitoring:stress` | 监控压力测试 | 运行监控系统压力测试脚本 |
| `bun test:monitoring:setup` | 监控测试环境搭建 | 初始化监控测试数据 |
| `bun test:monitoring:cleanup` | 监控测试环境清理 | 清除监控测试数据，恢复环境 |
| `bun test:monitoring:full` | 监控完整测试 | 高并发长时间监控测试(10并发60秒) |
| `bun test:monitoring:jest-setup` | 监控Jest准备 | 为监控Jest测试准备数据 |

## 🎯 专项测试命令 (Specialized Tests)

| 命令 | 说明 | 测试目的 |
|------|------|----------|
| `bun test:smoke` | 冒烟测试 | 快速验证核心功能(认证+核心+集成) |
| `bun test:regression` | 回归测试 | 完整测试+性能测试，确保无功能倒退 |
| `bun test:database` | 数据库测试 | 数据库相关集成测试(认证+监控+告警) |
| `bun test:cache` | 缓存测试 | 缓存相关测试(单元+集成+E2E) |
| `bun test:api` | API测试 | API相关测试(核心E2E+完整API性能) |

## 📊 测试报告生成能力

### **HTML测试报告 ✅**
所有Jest测试都配置了`jest-html-reporter`，自动生成美观的HTML报告：

| 测试类型 | 报告路径 | 包含内容 |
|----------|----------|----------|
| 单元测试 | `test-results/unit-test-report.html` | 测试结果 + 覆盖率图表 |
| 集成测试 | `test-results/integration-test-report.html` | 测试结果 + 覆盖率图表 |
| E2E测试 | `test-results/e2e-test-report.html` | 测试结果 + 覆盖率图表 ✨ |
| 安全测试 | `test-results/security-test-report.html` | 测试结果 + 覆盖率图表 ✨ |
| 测试工具 | `test-results/tools-execution-report.html` | 工具执行状态 ✨ |
| 统一报告 | `test-results/unified-test-report.html` | 所有测试类型汇总 ✨ |

### **覆盖率报告 ✅**
各类测试的覆盖率阈值和报告路径：

| 测试类型 | 覆盖率要求 | 报告路径 | 格式 |
|----------|------------|----------|------|
| 单元测试 | 85% | `coverage/unit/` | text + lcov + html |
| 集成测试 | 75% | `coverage/integration/` | text + lcov + html |
| E2E测试 | 65% ✨ | `coverage/e2e/` | text + lcov + html |
| 安全测试 | 80%/90% ✨ | `coverage/security/` | text + lcov + html |
| 合并报告 | - | `coverage/merged/` | 统一覆盖率 |

### **性能测试报告 ✅**
K6性能测试使用`htmlReport`和`textSummary`生成：
- **HTML性能报告**: 图表展示响应时间、吞吐量等
- **文本摘要**: 控制台输出关键指标
- **自定义指标**: 认证成功率、错误率等

### **执行日志 ✅**
- **工具执行日志**: `test-results/tools-execution.log`
- **详细控制台输出**: 所有测试类型都配置了详细日志
- **时间戳记录**: 每次执行都有时间戳

## 📋 快速参考

### **最常用命令**
```bash
npm run test          # 日常开发完整测试
npm run test:dev      # 开发时监听模式
npm run test:unit     # 快速单元测试
npm run test:smoke    # 冒烟测试验证
```

### **发布前验证**
```bash
npm run test:all              # 完整详细测试
npm run test:ci:full          # CI完整测试
npm run test:regression       # 回归测试
npm run coverage:full-analysis # 完整覆盖率分析
```

### **性能优化**
```bash
npm run test:perf:all      # 完整性能测试
npm run test:monitoring:full # 监控性能测试
```

### **安全审计**
```bash
npm run test:security:all  # 完整安全测试
npm run test:ci:security   # CI安全测试
```

### **报告生成**
```bash
npm run test:tools:all         # 执行所有测试工具并生成报告
npm run test:report:unified    # 生成统一可视化测试报告
npm run test:coverage:all      # 生成完整覆盖率报告
npm run coverage:full-analysis # 运行所有覆盖率分析工具
```

### **测试结构管理** ✨
```bash
npm run test:validate-structure       # 验证测试文件结构
npm run test:validate-structure:list  # 查看问题文件详细列表
npm run test:validate-structure:repair # 生成修复脚本
npm run test:validate-structure:apply  # 应用修复脚本
npm run test:quality-check           # 综合质量检查
```

#### **智能结构修复工作流程** 🤖
1. **运行结构验证**: `npm run test:validate-structure`
2. **查看详细列表**: `npm run test:validate-structure:list` （查看智能匹配和问题文件详情）
3. **生成修复脚本**: `npm run test:validate-structure:repair`
4. **执行修复脚本**: `npm run test:validate-structure:apply`
5. **验证修复结果**: 再次运行结构验证确认修复效果

**智能匹配特性**:
- 📝 文件名相似度算法（基于编辑距离）
- 📁 目录结构匹配分析
- 🎯 特殊模式识别（service、controller、repository等）
- 📊 相似度评分和匹配原因说明
- 🛡️ 安全预览模式，确认后再执行

## 📊 测试命令统计

- **基础测试命令**: 2个
- **单元测试命令**: 12个 
- **集成测试命令**: 12个
- **端到端测试命令**: 11个
- **安全测试命令**: 10个
- **性能测试命令**: 17个
- **覆盖率命令**: 29个 (+1 新增 `coverage:full-analysis`)
- **测试工具命令**: 19个 (+3 新增测试结构命令, -2 删除冗余命令)
- **CI/CD命令**: 5个
- **开发工具命令**: 4个
- **监控测试命令**: 5个
- **专项测试命令**: 5个

**总计: 131个测试命令**，覆盖开发、测试、部署全生命周期的各种测试需求！

### **🔧 工具命令更新** ✨
- ✅ 新增 `test:validate-structure:list` - 查看详细问题列表
- ✅ 新增 `test:validate-structure:repair` - 生成智能修复脚本
- ✅ 新增 `test:validate-structure:apply` - 应用测试结构修复脚本
- ✅ 新增 `coverage:full-analysis` - 完整覆盖率分析
- 🔄 更新工具助手命令 - 改为显示使用信息而非执行测试文件
- ❌ 清理了引用已删除文件的无效命令

---

## 📝 使用建议

1. **日常开发**: 使用`bun test:dev`进行持续测试
2. **功能验证**: 使用`bun test:smoke`进行快速验证
3. **模块开发**: 使用相应的模块测试命令
4. **发布前**: 运行`bun test:all`和`bun test:regression`
5. **CI/CD**: 使用`bun test:ci:*`系列命令
6. **调试问题**: 使用`bun test:debug:*`命令进行详细调试
7. **报告查看**: 使用`bun test:report:unified`查看统一测试报告
8. **覆盖率监控**: 定期运行`bun test:coverage:all`检查覆盖率

### **✨ 新增功能亮点**

- **E2E测试覆盖率**: 现在E2E测试也生成覆盖率报告 (65%阈值)
- **安全测试覆盖率**: 安全测试覆盖率报告 (80-90%阈值)
- **智能结构修复**: 自动检测并修复测试文件结构问题 🚀
- **完整覆盖率分析**: 一键运行所有覆盖率分析工具
- **测试工具报告**: 所有测试工具执行都有HTML报告
- **统一测试报告**: 一个页面查看所有测试类型结果
- **可视化图表**: 覆盖率进度条和测试结果统计
- **工具使用指导**: 辅助工具提供清晰的导入和使用示例

这套完整的测试体系确保了New Stock API系统的高质量和稳定性！