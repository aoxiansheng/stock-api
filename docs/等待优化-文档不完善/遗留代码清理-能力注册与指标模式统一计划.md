# é—ç•™ä»£ç æ¸…ç†è®¡åˆ’ï¼šèƒ½åŠ›æ³¨å†Œç»Ÿä¸€ä¸æŒ‡æ ‡æ¨¡å¼ä¸€è‡´æ€§

> ç›®æ ‡ï¼šåœ¨ä¸æ”¹å˜æ¥å£å¥‘çº¦å’Œä¸šåŠ¡è¡Œä¸ºçš„å‰æä¸‹ï¼Œæ¶ˆé™¤åŒæ³¨å†Œè¡¨å¹¶è¡Œã€æŒ‡æ ‡ legacy é…ç½®ä¸å®ç°ä¸ä¸€è‡´ã€ä»¥åŠæ— æ•ˆæœåŠ¡æš´éœ²ç­‰å…¼å®¹æ€§éšæ‚£ï¼Œæä¾›å¯å›æ»šã€å¯éªŒè¯çš„åˆ†é˜¶æ®µæ–¹æ¡ˆã€‚

## ä¸€ã€èŒƒå›´ä¸èƒŒæ™¯
- **æŠ€æœ¯æ ˆ**ï¼šNestJSï¼ˆåç«¯ï¼‰ï¼Œæœ¬æ¬¡ä»…æ¶‰åŠæ•°æ®ä¸ä¸šåŠ¡é€»è¾‘å±‚ï¼Œä¸æ¶‰åŠ UIã€‚
- **èšç„¦é—®é¢˜**ï¼ˆä¸æœ¬æ¬¡é‡æ„ç›´æ¥ç›¸å…³ï¼‰ï¼š
  - èƒ½åŠ›æ³¨å†Œè¡¨å­˜åœ¨â€œæ—§/æ–°å¹¶è¡Œâ€å®ä¾‹ï¼Œå¯èƒ½é€ æˆçŠ¶æ€ä¸ä¸€è‡´ã€‚
  - æŒ‡æ ‡ legacy æ¨¡å¼çš„é…ç½®ä¸å®é™…åˆå§‹åŒ–å®ç°è„±èŠ‚ã€‚
  - æ‰¹é‡ä¼˜åŒ–æ¨¡å—/æœåŠ¡æŒç»­æš´éœ²ä½†æœªè¢«å®é™…ä¾èµ–ï¼Œå­˜åœ¨è¯¯ç”¨é£é™©ã€‚

## äºŒã€è¯æ®å®šä½ï¼ˆä»£ç ä¸æ³¨é‡Šï¼‰

- Providers æ¨¡å—åŒæ—¶æ³¨å†Œæ—§/æ–°æ³¨å†Œè¡¨ï¼ˆåŒå®ä¾‹å¹¶è¡Œï¼‰ï¼š
```1:71:/Users/honor/Documents/code/newstockapi/backend/src/providers/module/providers.module.ts
providers: [
  CapabilityRegistryService,
  EnhancedCapabilityRegistryService,
  {
    provide: 'ENHANCED_CAPABILITY_REGISTRY',
    useClass: EnhancedCapabilityRegistryService
  }
],
exports: [CapabilityRegistryService, EnhancedCapabilityRegistryService],
```

- å¢å¼ºæ³¨å†Œè¡¨åŒ…å«å…¼å®¹æ—§æ¥å£çš„æ•°æ®ç»“æ„ä¸æ–¹æ³•ï¼ˆå¯ä½œä¸ºç»Ÿä¸€å®ç°ï¼‰ï¼š
```1:120:/Users/honor/Documents/code/newstockapi/backend/src/providers/services/enhanced-capability-registry.service.ts
// ç­–ç•¥4: å‘åå…¼å®¹ - å¡«å……ç°æœ‰æ•°æ®ç»“æ„
private populateLegacyStructures(): void { ... }
// å…¼å®¹æ—§æ¥å£çš„å…¬å¼€æ–¹æ³•ï¼ˆç¤ºä¾‹ï¼‰
getAllCapabilities(): Map<string, Map<string, ICapabilityRegistration>> { ... }
getBestProvider(...) { ... }
registerProvider(provider: any): void { ... }
getProvider(providerName: string): any { ... }
```

- æŒ‡æ ‡åˆå§‹åŒ–æœåŠ¡é»˜è®¤ç¦ç”¨ legacyModeï¼Œä½†æœªåœ¨æ¨¡å—ä¸­æ³¨å†Œï¼š
```1:23:/Users/honor/Documents/code/newstockapi/backend/src/monitoring/metrics/services/metrics-initializer.service.ts
onModuleInit(): void {
  // ç›´æ¥å…³é—­ legacyModeï¼ˆæ—§å†…å­˜ç»Ÿè®¡é€»è¾‘å·²å¼ƒç”¨ï¼‰
  Metrics.setLegacyMode(false);
}
```

- FeatureFlags ä»æš´éœ² legacy å¼€å…³ï¼ˆæ–‡æ¡£/é…ç½®ä¸å®ç°å­˜åœ¨ä¸ä¸€è‡´ï¼‰ï¼š
```1:125:/Users/honor/Documents/code/newstockapi/backend/src/common/config/feature-flags.config.ts
// ğŸ¯ æŒ‡æ ‡åŒå†™å…¼å®¹æ¨¡å¼å¼€å…³ (default: true)
readonly metricsLegacyModeEnabled: boolean = process.env.METRICS_LEGACY_MODE_ENABLED !== 'false';
```

- æ‰¹é‡ä¼˜åŒ–æ¨¡å—å·²ä»ä¸šåŠ¡æ¨¡å—ä¸­ç§»é™¤ï¼ˆæ³¨é‡Šè¯´æ˜ï¼‰ï¼š
```1:43:/Users/honor/Documents/code/newstockapi/backend/src/core/01-entry/stream-receiver/module/stream-receiver.module.ts
// - ç§»é™¤äº† PerformanceOptimizationModule (æ‰¹é‡ä¼˜åŒ–é€»è¾‘å†…ç½®)
```

- æ‰¹é‡ä¼˜åŒ–æœåŠ¡åŒ…å«å¤šå¤„â€œå·²åºŸå¼ƒâ€æç¤ºï¼ˆä»…ä¿ç•™ä¸ºæµ‹è¯•/åŸºå‡†ï¼‰ï¼š
```1:404:/Users/honor/Documents/code/newstockapi/backend/src/core/shared/services/batch-optimization.service.ts
// æ—§ç‰ˆå†…å­˜ç»Ÿè®¡é€»è¾‘å·²åºŸå¼ƒ
// æ—§å‘½ä¸­ç‡è®¡ç®—æ–¹æ³•å·²åºŸå¼ƒï¼ˆæ•°æ®ç”± Prometheus è´Ÿè´£ï¼‰
// æ—§å†…å­˜ç»Ÿè®¡å·²åºŸå¼ƒï¼Œæ— éœ€é‡ç½®
```

## ä¸‰ã€é—®é¢˜ä¸å½±å“ï¼ˆè¯æ®é©±åŠ¨ï¼‰
- **åŒæ³¨å†Œè¡¨å¹¶è¡Œï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰**
  - é—®é¢˜ï¼š`CapabilityRegistryService`ï¼ˆæ—§ï¼‰ä¸ `EnhancedCapabilityRegistryService`ï¼ˆæ–°ï¼‰åŒæ—¶å®ä¾‹åŒ–ï¼Œä¸” `ProvidersModule` å°† Provider å®ä¾‹åŒæ—¶æ³¨å†Œåˆ°ä¸¤è¾¹ï¼Œå¯èƒ½å¯¼è‡´èƒ½åŠ›æ•°æ®é›†ä¸åŒæ­¥ã€‚
  - å½±å“ï¼šä¸åŒæ³¨å…¥æ–¹æ‹¿åˆ°çš„èƒ½åŠ›é›†åˆå¯èƒ½ä¸ä¸€è‡´ï¼ŒåŸ‹ä¸‹è”è°ƒ/ç°åº¦éšæ‚£ã€‚
- **æŒ‡æ ‡ legacy æ¨¡å¼é…ç½®ä¸å®ç°ä¸ä¸€è‡´ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰**
  - é—®é¢˜ï¼šç¯å¢ƒå˜é‡ä¸æ–‡æ¡£ä»ä¿ç•™ legacy å¼€å…³ï¼Œä½†åˆå§‹åŒ–æœåŠ¡é»˜è®¤å…³é—­ä¸”æœªæ³¨å…¥æ¨¡å—ï¼Œè¡Œä¸ºä¸é…ç½®ä¸ä¸€è‡´ã€‚
  - å½±å“ï¼šè¿ç»´/å›æ»šè„šæœ¬å‚è€ƒè¯¥å˜é‡æ—¶äº§ç”Ÿè¯¯å¯¼ï¼Œå¢åŠ ç¯å¢ƒåˆ‡æ¢é£é™©ã€‚
- **æ‰¹é‡ä¼˜åŒ–æ— æ•ˆæš´éœ²ï¼ˆä½ä¼˜å…ˆçº§ï¼‰**
  - é—®é¢˜ï¼š`PerformanceOptimizationModule` æœªè¢«ä¸šåŠ¡æ¨¡å—å¯¼å…¥ï¼Œ`BatchOptimizationService` ä»åœ¨å…±äº«æ¨¡å—å¯¼å‡ºï¼Œå­˜åœ¨è¯¯ç”¨é£é™©ã€‚
  - å½±å“ï¼šæ¦‚å¿µè´Ÿæ‹…ä¸æ½œåœ¨è¯¯ç”¨ï¼Œä½†ä¸å½±å“å½“å‰è¿è¡Œã€‚

## å››ã€åˆ†é˜¶æ®µä¿®å¤æ–¹æ¡ˆï¼ˆä¿æŒåŠŸèƒ½ç­‰ä»·ï¼Œæ¸è¿›å¼ï¼‰

### é˜¶æ®µä¸€ï¼ˆå½“å¤©å¯å®Œæˆï¼Œé›¶æ¥å£é£é™©ï¼‰
1) ç»Ÿä¸€èƒ½åŠ›æ³¨å†Œè¡¨ï¼ˆDI ç»‘å®šæ›¿æ¢ï¼‰
- æ–¹æ¡ˆï¼šåœ¨ `providers.module.ts` ä¸­ä½¿ç”¨ `useExisting` å°†æ—§ token ç»‘å®šåˆ°å¢å¼ºå®ç°ï¼Œæ¶ˆé™¤åŒå®ä¾‹å¹¶è¡Œã€‚
- åŠ¨ä½œï¼š
  - ç”¨ `{ provide: CapabilityRegistryService, useExisting: EnhancedCapabilityRegistryService }` æ›¿æ¢ç›´æ¥æ³¨å†Œæ—§ç±»ã€‚
  - ä¿ç•™ `EnhancedCapabilityRegistryService` çš„æ³¨å†Œä¸å¯¼å‡ºï¼Œæ—§ä»£ç æ— æ„Ÿåˆ‡æ¢ã€‚
- é¢„æœŸï¼šæ‰€æœ‰æ³¨å…¥æ—§ç±»çš„è°ƒç”¨æ–¹è‡ªåŠ¨è·å¾—å¢å¼ºå®ç°ï¼Œèƒ½åŠ›æ•°æ®ä¸€è‡´ã€‚

2) æ˜¾å¼æ³¨å†ŒæŒ‡æ ‡åˆå§‹åŒ–æœåŠ¡ï¼ˆä¿æŒç°æœ‰ç¦ç”¨è¡Œä¸ºï¼‰
- æ–¹æ¡ˆï¼šåœ¨ `metrics.module.ts` å°† `MonitoringInitializerService` åŠ å…¥ `providers`ï¼Œä½¿â€œç¦ç”¨ legacy æ¨¡å¼â€çš„æ—¢æœ‰è¡Œä¸ºæ¨¡å—åŒ–ã€å¯å‘ç°ã€‚
- é¢„æœŸï¼šä¸æ”¹å˜ç°ç½‘è¡¨ç°ï¼Œä»…æå‡ä¸€è‡´æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚

3) æ ‡æ³¨æ‰¹é‡ä¼˜åŒ–æœåŠ¡ä¸ºåºŸå¼ƒï¼ˆé˜²è¯¯ç”¨ï¼‰
- æ–¹æ¡ˆï¼šåœ¨ `batch-optimization.service.ts` é¡¶éƒ¨æ·»åŠ  JSDoc `@deprecated`ï¼Œè¯´æ˜ç”±å„ç»„ä»¶å†…ç½®é€»è¾‘æ›¿ä»£ï¼Œä»…ä¿ç•™ä½œåŸºå‡†/æµ‹è¯•ç”¨é€”ã€‚

### é˜¶æ®µäºŒï¼ˆå°æ”¹åŠ¨ï¼Œå¯å›æ»šï¼‰
1) æ¸…ç†å†—ä½™åˆ«åå¯¼å‡º
- æ–¹æ¡ˆï¼šé€æ­¥ç§»é™¤ `'ENHANCED_CAPABILITY_REGISTRY'` å­—ç¬¦ä¸²åˆ«åï¼Œä»…ä¿ç•™æ—§ tokenï¼ˆå·²ç»‘å®šå¢å¼ºå®ç°ï¼‰ï¼Œå‡å°‘äºŒä¹‰æ€§ã€‚

2) æ–‡æ¡£ä¸é…ç½®ä¸€è‡´åŒ–
- æ–¹æ¡ˆï¼šåœ¨ç¯å¢ƒé…ç½®/è¿ç»´æ–‡æ¡£ä¸­æ ‡æ³¨ `METRICS_LEGACY_MODE_ENABLED` ä¸ºâ€œå¼ƒç”¨ï¼Œä¸å†ç”Ÿæ•ˆâ€ï¼Œå»ºè®®å§‹ç»ˆä½¿ç”¨ Prometheus æŒ‡æ ‡ã€‚

3) æ³¨å…¥å…¥å£ç»Ÿä¸€
- æ–¹æ¡ˆï¼šå¦‚å‘ç°ç›´æ¥æ³¨å…¥ `EnhancedCapabilityRegistryService` çš„ä»£ç ï¼Œç»Ÿä¸€åˆ‡æ¢ä¸ºæ³¨å…¥ `CapabilityRegistryService` tokenï¼ˆä¿æŒå®ç°ä¸å˜ï¼‰ï¼Œå‡å°‘æ–°è€æ··ç”¨ã€‚

### é˜¶æ®µä¸‰ï¼ˆå¯é€‰ï¼Œè§‚æµ‹ä¸è‡ªæ£€ï¼‰
1) æ³¨å†Œè¡¨ä¸€è‡´æ€§è‡ªæ£€
- æ–¹æ¡ˆï¼šåœ¨å¢å¼ºå®ç°ä¸­æä¾›ä¸€è‡´æ€§æ£€æŸ¥ä¸è°ƒè¯•ä¿¡æ¯å¯¼å‡ºï¼ˆå·²æœ‰ `getDebugInfo()` å¯å¤ç”¨ï¼‰ï¼Œä¾¿äºå·¡æ£€ã€‚

2) è¿ç§»è¯´æ˜
- æ–¹æ¡ˆï¼šæ–°å¢ README æ®µè½ï¼ŒæŒ‡å¯¼å¦‚ä½•æ³¨å…¥ç»Ÿä¸€ tokenã€å¦‚ä½•å›æ»šã€‚

## äº”ã€æµ‹è¯•éªŒè¯ä¸é£é™©æ§åˆ¶

### 5.1 è¯¦ç»†éªŒè¯ç­–ç•¥

#### å•å…ƒæµ‹è¯•éªŒè¯
```bash
# 1. æ³¨å†Œè¡¨ä¸€è‡´æ€§æµ‹è¯•
DISABLE_AUTO_INIT=true npx jest test/jest/unit/providers/services/capability-registry.service.spec.ts --testTimeout=30000 --config test/config/jest.unit.config.js

# 2. å¢å¼ºæ³¨å†Œè¡¨åŠŸèƒ½æµ‹è¯•
DISABLE_AUTO_INIT=true npx jest test/jest/unit/providers/services/enhanced-capability-registry.service.spec.ts --testTimeout=30000 --config test/config/jest.unit.config.js

# 3. æŒ‡æ ‡åˆå§‹åŒ–æµ‹è¯•
DISABLE_AUTO_INIT=true npx jest test/jest/unit/monitoring/metrics/services/metrics-initializer.service.spec.ts --testTimeout=30000 --config test/config/jest.unit.config.js
```

#### é›†æˆæµ‹è¯•éªŒè¯
```bash
# 1. Provider æ³¨å†Œé›†æˆæµ‹è¯•
DISABLE_AUTO_INIT=true npx jest test/jest/integration/providers/capability-registry.integration.test.ts --testTimeout=60000 --config test/config/jest.integration.config.js

# 2. æŒ‡æ ‡ç³»ç»Ÿé›†æˆæµ‹è¯•
DISABLE_AUTO_INIT=true npx jest test/jest/integration/monitoring/metrics.integration.test.ts --testTimeout=60000 --config test/config/jest.integration.config.js
```

#### E2E æµ‹è¯•éªŒè¯
```bash
# 1. å®Œæ•´æ•°æ®æµæµ‹è¯•
DISABLE_AUTO_INIT=true npx jest test/jest/e2e/core/receiver/receiver.e2e.test.ts --testTimeout=60000 --config test/config/jest.e2e.config.js

# 2. èƒ½åŠ›å‘ç°ä¸é€‰æ‹©æµ‹è¯•
DISABLE_AUTO_INIT=true npx jest test/jest/e2e/providers/capability-discovery.e2e.test.ts --testTimeout=60000 --config test/config/jest.e2e.config.js
```

#### æ³¨å†Œè¡¨ä¸€è‡´æ€§éªŒè¯æµ‹è¯•ç”¨ä¾‹ï¼ˆæ–°å¢ï¼‰
```typescript
// å»ºè®®æ·»åŠ åˆ°æµ‹è¯•å¥—ä»¶ä¸­çš„éªŒè¯é€»è¾‘
describe('Registry Migration Verification', () => {
  let app: TestingModule;
  let capabilityRegistry: CapabilityRegistryService;
  let enhancedRegistry: EnhancedCapabilityRegistryService;

  beforeEach(async () => {
    app = await Test.createTestingModule({
      imports: [ProvidersModule],
    }).compile();

    capabilityRegistry = app.get<CapabilityRegistryService>(CapabilityRegistryService);
    enhancedRegistry = app.get<EnhancedCapabilityRegistryService>(EnhancedCapabilityRegistryService);
  });

  it('should return identical instances after DI binding', () => {
    // éªŒè¯æ³¨å…¥CapabilityRegistryServiceå®é™…å¾—åˆ°EnhancedCapabilityRegistryServiceå®ä¾‹
    expect(capabilityRegistry).toBe(enhancedRegistry);
  });

  it('should maintain getBestProvider consistency', () => {
    // éªŒè¯getBestProvideræ–¹æ³•åœ¨ç›¸åŒè¾“å…¥ä¸‹è¿”å›ä¸€è‡´ç»“æœ
    const testSymbol = '700.HK';
    const testCapability = 'get-stock-quote';
    
    const result1 = capabilityRegistry.getBestProvider(testSymbol, testCapability);
    const result2 = enhancedRegistry.getBestProvider(testSymbol, testCapability);
    
    expect(result1).toEqual(result2);
  });

  it('should return identical capability sets', () => {
    // éªŒè¯getAllCapabilitiesè¿”å›ç›¸åŒçš„èƒ½åŠ›é›†åˆ
    const capabilities1 = capabilityRegistry.getAllCapabilities();
    const capabilities2 = enhancedRegistry.getAllCapabilities();
    
    expect(capabilities1).toEqual(capabilities2);
  });

  it('should maintain provider registration consistency', () => {
    // éªŒè¯provideræ³¨å†Œåä¸¤ä¸ªæ³¨å†Œè¡¨çŠ¶æ€ä¸€è‡´
    const mockProvider = {
      name: 'test-provider',
      capabilities: ['test-capability'],
    };

    capabilityRegistry.registerProvider(mockProvider);
    
    const provider1 = capabilityRegistry.getProvider('test-provider');
    const provider2 = enhancedRegistry.getProvider('test-provider');
    
    expect(provider1).toBe(provider2);
  });
});
```

### 5.2 æ€§èƒ½å½±å“è¯„ä¼°ä¸ç›‘æ§

#### æ€§èƒ½åŸºå‡†æµ‹è¯•
```bash
# 1. æ³¨å†Œè¡¨æ“ä½œæ€§èƒ½æµ‹è¯•
bun run test:perf:providers

# 2. å†…å­˜ä½¿ç”¨ç›‘æ§æµ‹è¯•
NODE_OPTIONS="--max-old-space-size=512" bun run test:integration:providers

# 3. èƒ½åŠ›æŸ¥è¯¢å“åº”æ—¶é—´æµ‹è¯•
bun run test:perf:capability-lookup
```

#### å…³é”®æ€§èƒ½æŒ‡æ ‡ç›‘æ§
- **Provideræ³¨å†Œæ•°é‡**: è¿ç§»å‰ååº”ä¿æŒä¸€è‡´
- **èƒ½åŠ›æŸ¥è¯¢å“åº”æ—¶é—´**: P95 < 50ms, P99 < 100ms
- **å†…å­˜ä½¿ç”¨**: EnhancedCapabilityRegistryServiceç›¸æ¯”æ—§å®ç°å†…å­˜å¢é•¿ < 20%
- **åˆå§‹åŒ–æ—¶é—´**: åº”ç”¨å¯åŠ¨æ—¶é—´å¢é•¿ < 5%

#### ç›‘æ§è„šæœ¬ç¤ºä¾‹
```bash
# å†…å­˜ä½¿ç”¨ç›‘æ§
echo "ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ..."
NODE_OPTIONS="--expose-gc" node -e "
const { CapabilityRegistryService } = require('./dist/providers/services/capability-registry.service');
const { EnhancedCapabilityRegistryService } = require('./dist/providers/services/enhanced-capability-registry.service');

console.log('åˆå§‹å†…å­˜:', process.memoryUsage());
const registry = new EnhancedCapabilityRegistryService();
console.log('åˆ›å»ºå¢å¼ºæ³¨å†Œè¡¨å:', process.memoryUsage());
global.gc();
console.log('GCå:', process.memoryUsage());
"
```

### 5.3 é£é™©ç¼“è§£æªæ–½

#### åˆå§‹åŒ–æ—¶åºé£é™©ç¼“è§£
- **é—®é¢˜**: ä»£ç ä¸­å­˜åœ¨`waitForRegistriesInitialization()`ï¼Œè¯´æ˜æœ‰æ—¶åºä¾èµ–
- **ç¼“è§£æªæ–½**: 
  1. åœ¨`EnhancedCapabilityRegistryService`ä¸­ä¿ç•™æ—¶åºæ§åˆ¶é€»è¾‘
  2. å¢åŠ åˆå§‹åŒ–çŠ¶æ€æ£€æŸ¥å’Œç­‰å¾…æœºåˆ¶
  3. æ·»åŠ åˆå§‹åŒ–è¶…æ—¶ä¿æŠ¤ï¼ˆé»˜è®¤30ç§’ï¼‰

#### è¡Œä¸ºå·®å¼‚é£é™©ç¼“è§£
- **é—®é¢˜**: è™½ç„¶æ¥å£å…¼å®¹ï¼Œä½†å†…éƒ¨å®ç°å¯èƒ½æœ‰ç»†å¾®å·®å¼‚
- **ç¼“è§£æªæ–½**:
  1. å¢åŠ ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–æ‰€æœ‰ä½¿ç”¨åœºæ™¯
  2. åœ¨é¢„ç”Ÿäº§ç¯å¢ƒè¿è¡Œå®Œæ•´å›å½’æµ‹è¯•
  3. ç›‘æ§å…³é”®ä¸šåŠ¡æŒ‡æ ‡ï¼ˆprovideré€‰æ‹©å‡†ç¡®ç‡ã€èƒ½åŠ›å‘ç°æˆåŠŸç‡ï¼‰

#### æ€§èƒ½å½±å“ç¼“è§£
- **é—®é¢˜**: å¢å¼ºæœåŠ¡çš„é¢å¤–æ•°æ®ç»“æ„å¯èƒ½å½±å“æ€§èƒ½
- **ç¼“è§£æªæ–½**:
  1. å®æ–½å‰è¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
  2. ç›‘æ§å†…å­˜ä½¿ç”¨å’Œå“åº”æ—¶é—´
  3. å¦‚æ€§èƒ½ä¸‹é™>10%ï¼Œè€ƒè™‘ä¼˜åŒ–æ•°æ®ç»“æ„æˆ–å›æ»š

### 5.4 åˆ†é˜¶æ®µå›æ»šç­–ç•¥

#### é˜¶æ®µä¸€å›æ»šï¼ˆDIç»‘å®šå›é€€ï¼‰
```typescript
// ç´§æ€¥å›æ»šæ­¥éª¤ï¼ˆproviders.module.tsï¼‰
providers: [
  // æ¢å¤ç›´æ¥æ³¨å†Œï¼ˆå›æ»šæ“ä½œï¼‰
  CapabilityRegistryService,
  EnhancedCapabilityRegistryService,
  // ç§»é™¤useExistingç»‘å®š
  // { provide: CapabilityRegistryService, useExisting: EnhancedCapabilityRegistryService },
],
```

#### å®Œæ•´å›æ»šæ£€æŸ¥æ¸…å•
- [ ] æ¢å¤`providers.module.ts`ä¸­çš„ç›´æ¥æ³¨å†Œ
- [ ] éªŒè¯ä¸¤ä¸ªæ³¨å†Œè¡¨å®ä¾‹ç‹¬ç«‹è¿è¡Œ
- [ ] è¿è¡Œå›å½’æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
- [ ] ç›‘æ§ç³»ç»ŸæŒ‡æ ‡ç¡®ä¿æ€§èƒ½æ¢å¤
- [ ] æ›´æ–°éƒ¨ç½²æ–‡æ¡£è®°å½•å›æ»šæ“ä½œ

#### å¿«é€Ÿå›æ»šè„šæœ¬
```bash
#!/bin/bash
# å¿«é€Ÿå›æ»šè„šæœ¬
echo "å¼€å§‹å›æ»šDIç»‘å®š..."

# å¤‡ä»½å½“å‰æ–‡ä»¶
cp src/providers/module/providers.module.ts src/providers/module/providers.module.ts.backup

# æ¢å¤åŸå§‹DIé…ç½®
git checkout HEAD~1 -- src/providers/module/providers.module.ts

# é‡å¯åº”ç”¨
bun run build
bun run start:prod &

# ç­‰å¾…å¯åŠ¨
sleep 10

# éªŒè¯å›æ»šæˆåŠŸ
curl -f http://localhost:3000/api/v1/monitoring/health || {
  echo "å›æ»šéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
  exit 1
}

echo "å›æ»šå®Œæˆå¹¶éªŒè¯æˆåŠŸ"
```

## å…­ã€é£é™©è¯„ä¼°ä¸æˆåŠŸæ ‡å‡†

### 6.1 æ•´ä½“é£é™©è¯„ä¼°
- **æŠ€æœ¯é£é™©**: ä½ - ä¸æ”¹å˜ HTTP æ¥å£å¥‘çº¦ä¸ DTOï¼›ä¸å¼•å…¥æ–°æŠ€æœ¯æ ˆ
- **ä¸šåŠ¡é£é™©**: æä½ - DI å±‚æ›¿æ¢å¯¹ä¸šåŠ¡æ— æ„Ÿï¼ŒåŠŸèƒ½ç­‰ä»·
- **è¿ç»´é£é™©**: ä½ - æ–‡æ¡£/é…ç½®ä¸€è‡´åŒ–ä»…ä¿®æ­£è®¤çŸ¥åå·®ï¼Œä¸æ¶‰åŠè¿è¡Œè·¯å¾„
- **å›æ»šé£é™©**: æä½ - å¯å¿«é€Ÿå›æ»šï¼Œæœ‰å®Œæ•´çš„å›é€€ç­–ç•¥

### 6.2 å…³é”®æˆåŠŸæ ‡å‡†
- **åŠŸèƒ½å®Œæ•´æ€§**: 100% - æ‰€æœ‰ç°æœ‰åŠŸèƒ½å¿…é¡»ä¿æŒä¸å˜
- **æ€§èƒ½æ ‡å‡†**: 95% - å…³é”®æŒ‡æ ‡æ€§èƒ½ä¸‹é™ä¸è¶…è¿‡5%
- **æµ‹è¯•è¦†ç›–**: 90% - æ–°å¢æµ‹è¯•ç”¨ä¾‹å¿…é¡»é€šè¿‡ï¼Œç°æœ‰æµ‹è¯•é›¶å¤±è´¥
- **ç›‘æ§æŒ‡æ ‡**: 100% - æ‰€æœ‰å…³é”®ç›‘æ§æŒ‡æ ‡ä¿æŒæ­£å¸¸

## ä¸ƒã€è¯¦ç»†æ‰§è¡Œæ¸…å•ä¸éªŒè¯è„šæœ¬

### 7.1 é˜¶æ®µä¸€æ‰§è¡Œæ¸…å•ï¼ˆå½“å¤©å®Œæˆï¼‰

#### 7.1.1 ç»Ÿä¸€èƒ½åŠ›æ³¨å†Œè¡¨
- [ ] **ä»£ç ä¿®æ”¹**: ä¿®æ”¹`src/providers/module/providers.module.ts`
  ```typescript
  // æ›¿æ¢ç›´æ¥æ³¨å†Œä¸ºDIç»‘å®š
  { provide: CapabilityRegistryService, useExisting: EnhancedCapabilityRegistryService }
  ```
- [ ] **éªŒè¯è„šæœ¬**: 
  ```bash
  # éªŒè¯æ³¨å†Œè¡¨ä¸€è‡´æ€§
  DISABLE_AUTO_INIT=true npx jest test/jest/unit/providers/services/capability-registry.service.spec.ts --testTimeout=30000 --config test/config/jest.unit.config.js
  ```
- [ ] **é¢„æœŸç»“æœ**: ä¸¤ä¸ªtokenæ³¨å…¥å¾—åˆ°ç›¸åŒå®ä¾‹

#### 7.1.2 æ³¨å†ŒæŒ‡æ ‡åˆå§‹åŒ–æœåŠ¡
- [ ] **ä»£ç ä¿®æ”¹**: ä¿®æ”¹`src/monitoring/metrics/metrics.module.ts`
  ```typescript
  // åœ¨providersæ•°ç»„ä¸­æ·»åŠ 
  MonitoringInitializerService,
  ```
- [ ] **éªŒè¯è„šæœ¬**:
  ```bash
  # éªŒè¯æŒ‡æ ‡åˆå§‹åŒ–
  bun run dev > startup.log 2>&1 &
  sleep 5
  grep -i "legacyMode" startup.log || echo "åˆå§‹åŒ–æœåŠ¡æœªæ­£ç¡®æ‰§è¡Œ"
  ```
- [ ] **é¢„æœŸç»“æœ**: å¯åŠ¨æ—¥å¿—æ˜¾ç¤º"LegacyModeå·²ç¦ç”¨"

#### 7.1.3 æ ‡æ³¨æ‰¹é‡ä¼˜åŒ–æœåŠ¡åºŸå¼ƒ
- [ ] **ä»£ç ä¿®æ”¹**: åœ¨`src/core/shared/services/batch-optimization.service.ts`é¡¶éƒ¨æ·»åŠ 
  ```typescript
  /**
   * @deprecated è¯¥æœåŠ¡å·²åºŸå¼ƒï¼Œæ‰¹é‡ä¼˜åŒ–é€»è¾‘å·²å†…ç½®åˆ°å„ç»„ä»¶ä¸­ã€‚
   * ä»…ä¿ç•™ä½œä¸ºæ€§èƒ½åŸºå‡†æµ‹è¯•å’Œå‘åå…¼å®¹ç›®çš„ã€‚
   * å»ºè®®ä½¿ç”¨å„ç»„ä»¶å†…ç½®çš„ä¼˜åŒ–é€»è¾‘ã€‚
   */
  @Injectable()
  export class BatchOptimizationService {
  ```
- [ ] **éªŒè¯è„šæœ¬**: 
  ```bash
  # éªŒè¯åºŸå¼ƒæ ‡æ³¨
  grep -n "@deprecated" src/core/shared/services/batch-optimization.service.ts
  ```

### 7.2 é˜¶æ®µä¸€å®Œæ•´éªŒè¯æµç¨‹

#### 7.2.1 è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬
```bash
#!/bin/bash
# é˜¶æ®µä¸€å®Œæ•´éªŒè¯è„šæœ¬
echo "=== å¼€å§‹é˜¶æ®µä¸€éªŒè¯ ==="

# 1. ç¼–è¯‘æ£€æŸ¥
echo "1. ç¼–è¯‘æ£€æŸ¥..."
bun run build || {
  echo "âŒ ç¼–è¯‘å¤±è´¥"
  exit 1
}
echo "âœ… ç¼–è¯‘æˆåŠŸ"

# 2. å•å…ƒæµ‹è¯•éªŒè¯
echo "2. è¿è¡Œå•å…ƒæµ‹è¯•..."
DISABLE_AUTO_INIT=true npx jest test/jest/unit/providers/ --testTimeout=30000 --config test/config/jest.unit.config.js --passWithNoTests || {
  echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥"
  exit 1
}
echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

# 3. é›†æˆæµ‹è¯•éªŒè¯
echo "3. è¿è¡Œé›†æˆæµ‹è¯•..."
DISABLE_AUTO_INIT=true npx jest test/jest/integration/providers/ --testTimeout=60000 --config test/config/jest.integration.config.js --passWithNoTests || {
  echo "âŒ é›†æˆæµ‹è¯•å¤±è´¥"
  exit 1
}
echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"

# 4. å¯åŠ¨éªŒè¯
echo "4. åº”ç”¨å¯åŠ¨éªŒè¯..."
bun run dev > startup.log 2>&1 &
APP_PID=$!
sleep 10

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl -f http://localhost:3000/api/v1/monitoring/health > /dev/null 2>&1 || {
  echo "âŒ åº”ç”¨å¯åŠ¨å¤±è´¥"
  kill $APP_PID 2>/dev/null
  exit 1
}

# æ£€æŸ¥æŒ‡æ ‡åˆå§‹åŒ–
grep -i "legacyMode" startup.log > /dev/null || {
  echo "âš ï¸  æŒ‡æ ‡åˆå§‹åŒ–æ—¥å¿—æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥MonitoringInitializerServiceæ³¨å†Œ"
}

kill $APP_PID 2>/dev/null
echo "âœ… åº”ç”¨å¯åŠ¨éªŒè¯é€šè¿‡"

echo "=== é˜¶æ®µä¸€éªŒè¯å®Œæˆ ==="
```

#### 7.2.2 æ€§èƒ½åŸºå‡†æµ‹è¯•è„šæœ¬
```bash
#!/bin/bash
# æ€§èƒ½åŸºå‡†æµ‹è¯•è„šæœ¬
echo "=== æ€§èƒ½åŸºå‡†æµ‹è¯• ==="

# 1. å†…å­˜ä½¿ç”¨æµ‹è¯•
echo "1. å†…å­˜ä½¿ç”¨æµ‹è¯•..."
NODE_OPTIONS="--expose-gc" node -e "
const start = process.memoryUsage();
console.log('å¯åŠ¨å†…å­˜:', start);

// æ¨¡æ‹Ÿæ³¨å†Œè¡¨ä½¿ç”¨
for(let i = 0; i < 1000; i++) {
  // æ¨¡æ‹Ÿprovideræ³¨å†Œæ“ä½œ
}

global.gc();
const end = process.memoryUsage();
console.log('GCåå†…å­˜:', end);
console.log('å†…å­˜å¢é•¿:', Math.round((end.heapUsed - start.heapUsed) / 1024 / 1024), 'MB');
"

# 2. å“åº”æ—¶é—´æµ‹è¯•
echo "2. å“åº”æ—¶é—´æµ‹è¯•..."
bun run dev > /dev/null 2>&1 &
APP_PID=$!
sleep 10

# æµ‹è¯•å¥åº·æ£€æŸ¥å“åº”æ—¶é—´
for i in {1..10}; do
  start=$(date +%s%N)
  curl -s http://localhost:3000/api/v1/monitoring/health > /dev/null
  end=$(date +%s%N)
  echo "è¯·æ±‚ $i: $((($end - $start) / 1000000)) ms"
done

kill $APP_PID 2>/dev/null
echo "=== æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ ==="
```

### 7.3 ç›‘æ§æŒ‡æ ‡å®šä¹‰

#### 7.3.1 å…³é”®ç›‘æ§æŒ‡æ ‡
- **æ³¨å†Œè¡¨ä¸€è‡´æ€§æŒ‡æ ‡**
  - `capability_registry_instances_count`: æ³¨å†Œè¡¨å®ä¾‹æ•°é‡ï¼ˆåº”ä¸º1ï¼‰
  - `provider_registration_success_rate`: Provideræ³¨å†ŒæˆåŠŸç‡ï¼ˆåº”>99%ï¼‰
  - `capability_lookup_response_time`: èƒ½åŠ›æŸ¥è¯¢å“åº”æ—¶é—´ï¼ˆP95<50msï¼‰

- **æ€§èƒ½æŒ‡æ ‡**
  - `memory_usage_after_migration`: è¿ç§»åå†…å­˜ä½¿ç”¨é‡
  - `startup_time`: åº”ç”¨å¯åŠ¨æ—¶é—´
  - `provider_count`: æ³¨å†Œçš„provideræ•°é‡

#### 7.3.2 ç›‘æ§è„šæœ¬æ¨¡æ¿
```bash
#!/bin/bash
# ç›‘æ§æŒ‡æ ‡æ”¶é›†è„šæœ¬
echo "=== æ”¶é›†å…³é”®ç›‘æ§æŒ‡æ ‡ ==="

# æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
curl -f http://localhost:3000/api/v1/monitoring/health > /dev/null 2>&1 || {
  echo "âŒ åº”ç”¨æœªè¿è¡Œ"
  exit 1
}

# æ”¶é›†æŒ‡æ ‡
echo "ğŸ“Š æ”¶é›†æŒ‡æ ‡ä¸­..."

# 1. å†…å­˜ä½¿ç”¨
MEMORY=$(curl -s http://localhost:3000/api/v1/monitoring/metrics-health | jq -r '.data.memoryUsage.heapUsed')
echo "å†…å­˜ä½¿ç”¨: ${MEMORY} bytes"

# 2. Provideræ•°é‡
PROVIDER_COUNT=$(curl -s http://localhost:3000/api/v1/providers/debug/capabilities | jq -r '.data | length')
echo "Provideræ•°é‡: ${PROVIDER_COUNT}"

# 3. å“åº”æ—¶é—´åŸºå‡†
RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" http://localhost:3000/api/v1/monitoring/health)
echo "å¥åº·æ£€æŸ¥å“åº”æ—¶é—´: ${RESPONSE_TIME}s"

echo "=== æŒ‡æ ‡æ”¶é›†å®Œæˆ ==="
```

---

æœ€åæ›´æ–°ï¼šè‡ªåŠ¨ç”Ÿæˆäºå½“å‰è¿­ä»£ã€‚è‹¥éœ€æˆ‘ç›´æ¥å®Œæˆé˜¶æ®µä¸€ä»£ç ç¼–è¾‘å¹¶è¿è¡Œæµ‹è¯•ï¼Œè¯·åœ¨æœ¬æ–‡æ¡£å¯¹åº”æ¸…å•ä¸Šå‹¾é€‰å¹¶åˆ†é…æ‰§è¡Œäººã€‚ 