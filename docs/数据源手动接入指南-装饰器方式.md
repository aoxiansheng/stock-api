# æ•°æ®æºæ‰‹åŠ¨æ¥å…¥æŒ‡å— - è£…é¥°å™¨æ–¹å¼

## æ¦‚è¿°

æ‰‹åŠ¨æ¥å…¥æ–¹å¼é€‚åˆéœ€è¦**ç²¾ç¡®æ§åˆ¶ä»£ç ç»“æ„**æˆ–**å­¦ä¹ ç³»ç»Ÿå†…éƒ¨æœºåˆ¶**çš„å¼€å‘è€…ã€‚é€šè¿‡æ‰‹åŠ¨åˆ›å»ºæ–‡ä»¶å’Œç¼–å†™è£…é¥°å™¨ä»£ç ï¼Œæ‚¨å¯ä»¥å®Œå…¨ç†è§£æ–°è£…é¥°å™¨ç³»ç»Ÿçš„å·¥ä½œåŸç†ã€‚

> **æ³¨æ„**: å¦‚æœæ‚¨å¸Œæœ›å¿«é€Ÿæ¥å…¥æ•°æ®æºï¼Œå»ºè®®ä½¿ç”¨ [CLIå·¥å…·æ–¹å¼](./æ•°æ®æºå¿«é€Ÿæ¥å…¥æŒ‡å—-CLIå·¥å…·æ–¹å¼.md)ï¼Œåªéœ€5åˆ†é’Ÿå³å¯å®Œæˆã€‚

## ğŸ¯ è£…é¥°å™¨ç³»ç»Ÿæ ¸å¿ƒæ¦‚å¿µ

### è£…é¥°å™¨çš„ä¼˜åŠ¿

ç›¸æ¯”ä¼ ç»Ÿçš„æ–‡ä»¶å¯¼å‡ºæ–¹å¼ï¼Œè£…é¥°å™¨æ–¹å¼å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **ç¼–è¯‘æ—¶éªŒè¯**: TypeScriptç¼–è¯‘å™¨æ£€æŸ¥ç±»å‹å’Œæ¥å£å®ç°
- **è‡ªåŠ¨æ³¨å†Œ**: æ— éœ€æ‰‹åŠ¨é…ç½®è·¯å¾„å’Œå¯¼å…¥
- **æ™ºèƒ½æ¨æ–­**: è‡ªåŠ¨ä»æ–‡ä»¶è·¯å¾„æ¨æ–­æä¾›å•†åç§°
- **IDEæ”¯æŒ**: å®Œæ•´çš„æ™ºèƒ½æç¤ºå’Œé‡æ„æ”¯æŒ
- **å£°æ˜å¼**: é…ç½®å³æ–‡æ¡£ï¼Œæ¸…æ™°ç›´è§‚

### æ ¸å¿ƒè£…é¥°å™¨

```typescript
// æä¾›å•†è£…é¥°å™¨
@Provider({
  name: string,              // æä¾›å•†å”¯ä¸€åç§°
  description?: string,      // æè¿°ä¿¡æ¯
  autoRegister?: boolean,    // æ˜¯å¦è‡ªåŠ¨æ³¨å†Œï¼ˆé»˜è®¤trueï¼‰
  healthCheck?: boolean      // æ˜¯å¦å¯ç”¨å¥åº·æ£€æŸ¥ï¼ˆé»˜è®¤falseï¼‰
})

// RESTèƒ½åŠ›è£…é¥°å™¨
@Capability({
  name: string,              // èƒ½åŠ›åç§°ï¼ˆå¦‚ï¼šget-stock-quoteï¼‰
  provider?: string,         // æä¾›å•†åç§°ï¼ˆå¯è‡ªåŠ¨æ¨æ–­ï¼‰
  description?: string,      // èƒ½åŠ›æè¿°
  markets?: string[],        // æ”¯æŒçš„å¸‚åœº
  priority?: number,         // ä¼˜å…ˆçº§ï¼ˆé»˜è®¤1ï¼‰
  enabled?: boolean         // æ˜¯å¦å¯ç”¨ï¼ˆé»˜è®¤trueï¼‰
})

// WebSocketæµèƒ½åŠ›è£…é¥°å™¨
@StreamCapability({
  // ç»§æ‰¿@Capabilityçš„æ‰€æœ‰å±æ€§
  type: 'websocket'         // å›ºå®šä¸ºwebsocket
})
```

## ğŸ—ï¸ æ‰‹åŠ¨æ¥å…¥å®Œæ•´æ­¥éª¤

### æ­¥éª¤1: åˆ›å»ºç›®å½•ç»“æ„

```bash
# åœ¨ src/providers/ ä¸‹åˆ›å»ºæä¾›å•†ç›®å½•
mkdir -p src/providers/alpha-vantage/{capabilities,module,services}
mkdir -p src/providers/alpha-vantage/tests
```

**æ¨èçš„ç›®å½•ç»“æ„**:
```
src/providers/alpha-vantage/
â”œâ”€â”€ index.ts                    # ä¸»Providerç±»
â”œâ”€â”€ module/
â”‚   â””â”€â”€ alpha-vantage.module.ts # NestJSæ¨¡å—
â”œâ”€â”€ capabilities/               # èƒ½åŠ›å®ç°ç›®å½•
â”‚   â”œâ”€â”€ get-stock-quote.ts     
â”‚   â”œâ”€â”€ get-stock-basic-info.ts
â”‚   â””â”€â”€ stream-real-time.ts    # æµèƒ½åŠ›ç¤ºä¾‹
â”œâ”€â”€ services/                   # å¯é€‰ï¼šè¾…åŠ©æœåŠ¡
â”‚   â””â”€â”€ alpha-vantage-client.ts
â”œâ”€â”€ types.ts                    # ç±»å‹å®šä¹‰
â”œâ”€â”€ README.md                   # æ–‡æ¡£
â””â”€â”€ tests/                      # å¯é€‰ï¼šæµ‹è¯•æ–‡ä»¶
    â””â”€â”€ alpha-vantage.spec.ts
```

### æ­¥éª¤2: åˆ›å»ºä¸»Providerç±»

```typescript
// src/providers/alpha-vantage/index.ts
import { Injectable } from '@nestjs/common';
import { Provider } from '../decorators';
import { IDataProvider } from '../interfaces/provider.interface';

@Provider({
  name: 'alpha-vantage',
  description: 'Alpha Vantage å…è´¹è‚¡ç¥¨APIæ•°æ®æº',
  autoRegister: true,
  healthCheck: true
})
@Injectable()
export class AlphaVantageProvider implements IDataProvider {
  readonly name = 'alpha-vantage';
  readonly description = 'Alpha Vantage å…è´¹è‚¡ç¥¨APIæ•°æ®æº';

  constructor(
    // å¯ä»¥æ³¨å…¥é…ç½®æœåŠ¡æˆ–å…¶ä»–ä¾èµ–
    // @Inject('CONFIG_SERVICE') private configService: ConfigService
  ) {}

  async initialize(): Promise<void> {
    console.log(`${this.name} æ•°æ®æºåˆå§‹åŒ–å¼€å§‹...`);
    
    // TODO: å®ç°åˆå§‹åŒ–é€»è¾‘
    // - éªŒè¯APIå¯†é’¥
    // - è®¾ç½®è¿æ¥æ± 
    // - åˆå§‹åŒ–ç¼“å­˜
    
    console.log(`${this.name} æ•°æ®æºåˆå§‹åŒ–å®Œæˆ`);
  }

  async testConnection(): Promise<boolean> {
    try {
      // TODO: å®ç°è¿æ¥æµ‹è¯•
      // const response = await this.apiClient.ping();
      // return response.status === 'ok';
      
      console.log(`${this.name} è¿æ¥æµ‹è¯•é€šè¿‡`);
      return true;
    } catch (error) {
      console.error(`${this.name} è¿æ¥æµ‹è¯•å¤±è´¥:`, error.message);
      return false;
    }
  }

  getCapability(name: string): any {
    // TODO: å¦‚æœéœ€è¦è¿è¡Œæ—¶è·å–èƒ½åŠ›å®ä¾‹ï¼Œåœ¨è¿™é‡Œå®ç°
    // è£…é¥°å™¨ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å¤§éƒ¨åˆ†æƒ…å†µ
    return null;
  }
}

export default AlphaVantageProvider;
```

### æ­¥éª¤3: åˆ›å»ºèƒ½åŠ›å®ç°

#### RESTèƒ½åŠ›ç¤ºä¾‹

```typescript
// src/providers/alpha-vantage/capabilities/get-stock-quote.ts
import { Capability } from '../../decorators';
import { ICapability } from '../../interfaces/capability.interface';
import { DataRequest, DataResponse } from '../../interfaces/data.interface';

@Capability({
  name: 'get-stock-quote',
  provider: 'alpha-vantage', // å¯çœç•¥ï¼Œä¼šè‡ªåŠ¨ä»è·¯å¾„æ¨æ–­
  description: 'è·å–è‚¡ç¥¨å®æ—¶æŠ¥ä»·æ•°æ®',
  markets: ['US', 'UK'], // Alpha Vantageä¸»è¦æ”¯æŒç¾å›½å’Œè‹±å›½å¸‚åœº
  priority: 2, // ä¼˜å…ˆçº§ç¨ä½ï¼Œå› ä¸ºæœ‰è¯·æ±‚é™åˆ¶
  symbolFormats: ['SYMBOL', 'SYMBOL.EXCHANGE'],
  config: {
    rateLimit: {
      requestsPerMinute: 5, // Alpha Vantageå…è´¹ç‰ˆé™åˆ¶
      requestsPerDay: 500
    }
  }
})
export class GetStockQuoteCapability implements ICapability {
  readonly name = 'get-stock-quote';
  readonly supportedMarkets = ['US', 'UK'];
  readonly supportedSymbolFormats = ['SYMBOL', 'SYMBOL.EXCHANGE'];

  async execute(request: DataRequest): Promise<DataResponse> {
    const { symbols } = request;
    
    try {
      // è¾“å…¥éªŒè¯
      this.validateRequest(request);
      
      // è·å–APIå¯†é’¥
      const apiKey = this.getApiKey();
      
      // è°ƒç”¨Alpha Vantage API
      const quotes = await this.fetchQuotes(symbols, apiKey);
      
      // è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
      const standardizedData = this.transformToStandardFormat(quotes);
      
      return {
        success: true,
        data: standardizedData,
        timestamp: new Date(),
        metadata: {
          provider: 'alpha-vantage',
          rateLimitRemaining: quotes.rateLimitRemaining
        }
      };
    } catch (error) {
      throw new Error(`Alpha Vantageè·å–è‚¡ç¥¨æŠ¥ä»·å¤±è´¥: ${error.message}`);
    }
  }

  private validateRequest(request: DataRequest): void {
    if (!request.symbols || request.symbols.length === 0) {
      throw new Error('symbolså‚æ•°ä¸èƒ½ä¸ºç©º');
    }
    
    if (request.symbols.length > 5) {
      throw new Error('Alpha Vantageå…è´¹ç‰ˆå•æ¬¡è¯·æ±‚æœ€å¤šæ”¯æŒ5ä¸ªè‚¡ç¥¨ä»£ç ');
    }
  }

  private getApiKey(): string {
    const apiKey = process.env.ALPHA_VANTAGE_API_KEY;
    if (!apiKey) {
      throw new Error('è¯·è®¾ç½®ALPHA_VANTAGE_API_KEYç¯å¢ƒå˜é‡');
    }
    return apiKey;
  }

  private async fetchQuotes(symbols: string[], apiKey: string): Promise<any> {
    const quotes = [];
    
    // Alpha Vantageéœ€è¦é€ä¸ªè¯·æ±‚è‚¡ç¥¨æ•°æ®
    for (const symbol of symbols) {
      const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKey}`;
      
      const response = await fetch(url);
      const data = await response.json();
      
      if (data['Error Message']) {
        throw new Error(`Alpha Vantage APIé”™è¯¯: ${data['Error Message']}`);
      }
      
      if (data['Note']) {
        throw new Error('Alpha Vantage APIè¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œè¯·ç¨åé‡è¯•');
      }
      
      quotes.push({
        symbol,
        rawData: data['Global Quote']
      });
      
      // é¿å…è§¦å‘é¢‘ç‡é™åˆ¶
      if (symbols.length > 1) {
        await this.sleep(200); // 200mså»¶è¿Ÿ
      }
    }
    
    return quotes;
  }

  private transformToStandardFormat(quotes: any[]): any[] {
    return quotes.map(quote => {
      const rawData = quote.rawData;
      
      return {
        symbol: quote.symbol,
        lastPrice: parseFloat(rawData['05. price']) || 0,
        change: parseFloat(rawData['09. change']) || 0,
        changePercent: parseFloat(rawData['10. change percent']?.replace('%', '')) || 0,
        volume: parseInt(rawData['06. volume']) || 0,
        high: parseFloat(rawData['03. high']) || 0,
        low: parseFloat(rawData['04. low']) || 0,
        open: parseFloat(rawData['02. open']) || 0,
        previousClose: parseFloat(rawData['08. previous close']) || 0,
        timestamp: rawData['07. latest trading day'],
        market: this.inferMarket(quote.symbol)
      };
    });
  }

  private inferMarket(symbol: string): string {
    // ç®€å•çš„å¸‚åœºæ¨æ–­é€»è¾‘
    if (symbol.includes('.L') || symbol.includes('.LON')) {
      return 'UK';
    }
    return 'US';
  }

  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

export default GetStockQuoteCapability;
```

#### WebSocketæµèƒ½åŠ›ç¤ºä¾‹

```typescript
// src/providers/alpha-vantage/capabilities/stream-real-time.ts
import { StreamCapability } from '../../decorators';
import { IStreamCapability, ConnectionStatus } from '../../interfaces/stream-capability.interface';

@StreamCapability({
  name: 'stream-real-time-quotes',
  provider: 'alpha-vantage',
  description: 'Alpha Vantageå®æ—¶è‚¡ä»·æµï¼ˆWebSocketï¼‰',
  markets: ['US'],
  type: 'websocket',
  priority: 3
})
export class StreamRealTimeQuotesCapability implements IStreamCapability {
  readonly name = 'stream-real-time-quotes';
  readonly supportedMarkets = ['US'];
  readonly supportedSymbolFormats = ['SYMBOL'];

  private wsConnection: WebSocket | null = null;
  private isConnectedFlag = false;
  private subscribers = new Set<string>();
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;

  async execute(request: any): Promise<any> {
    // æµèƒ½åŠ›é€šè¿‡connect/subscribeæ–¹å¼å·¥ä½œï¼Œè€Œä¸æ˜¯execute
    throw new Error('æµèƒ½åŠ›è¯·ä½¿ç”¨connect()å’Œsubscribe()æ–¹æ³•');
  }

  async connect(): Promise<void> {
    if (this.isConnectedFlag) {
      return;
    }

    try {
      const apiKey = process.env.ALPHA_VANTAGE_API_KEY;
      if (!apiKey) {
        throw new Error('è¯·è®¾ç½®ALPHA_VANTAGE_API_KEYç¯å¢ƒå˜é‡');
      }

      // Alpha Vantageå®é™…ä¸Šä¸æä¾›WebSocketï¼Œè¿™é‡Œæ˜¯ç¤ºä¾‹ä»£ç 
      // å®é™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„WebSocket URL
      const wsUrl = `wss://ws.alphavantage.co/stream?apikey=${apiKey}`;
      
      this.wsConnection = new WebSocket(wsUrl);
      
      this.wsConnection.onopen = () => {
        console.log('Alpha Vantage WebSocketè¿æ¥å·²å»ºç«‹');
        this.isConnectedFlag = true;
        this.reconnectAttempts = 0;
      };

      this.wsConnection.onmessage = (event) => {
        this.handleMessage(event.data);
      };

      this.wsConnection.onerror = (error) => {
        console.error('Alpha Vantage WebSocketé”™è¯¯:', error);
      };

      this.wsConnection.onclose = () => {
        console.log('Alpha Vantage WebSocketè¿æ¥å·²å…³é—­');
        this.isConnectedFlag = false;
        this.attemptReconnect();
      };

      // ç­‰å¾…è¿æ¥å»ºç«‹
      await this.waitForConnection();
    } catch (error) {
      throw new Error(`Alpha Vantage WebSocketè¿æ¥å¤±è´¥: ${error.message}`);
    }
  }

  async disconnect(): Promise<void> {
    if (this.wsConnection) {
      this.wsConnection.close();
      this.wsConnection = null;
    }
    this.isConnectedFlag = false;
    this.subscribers.clear();
  }

  async subscribe(symbols: string[]): Promise<void> {
    if (!this.isConnectedFlag) {
      throw new Error('WebSocketæœªè¿æ¥ï¼Œè¯·å…ˆè°ƒç”¨connect()');
    }

    for (const symbol of symbols) {
      if (!this.subscribers.has(symbol)) {
        // å‘é€è®¢é˜…æ¶ˆæ¯
        const subscribeMessage = {
          action: 'subscribe',
          symbols: [symbol]
        };
        
        this.wsConnection?.send(JSON.stringify(subscribeMessage));
        this.subscribers.add(symbol);
        
        console.log(`å·²è®¢é˜…è‚¡ç¥¨: ${symbol}`);
      }
    }
  }

  async unsubscribe(symbols: string[]): Promise<void> {
    if (!this.isConnectedFlag) {
      return;
    }

    for (const symbol of symbols) {
      if (this.subscribers.has(symbol)) {
        // å‘é€å–æ¶ˆè®¢é˜…æ¶ˆæ¯
        const unsubscribeMessage = {
          action: 'unsubscribe',
          symbols: [symbol]
        };
        
        this.wsConnection?.send(JSON.stringify(unsubscribeMessage));
        this.subscribers.delete(symbol);
        
        console.log(`å·²å–æ¶ˆè®¢é˜…è‚¡ç¥¨: ${symbol}`);
      }
    }
  }

  isConnected(): boolean {
    return this.isConnectedFlag;
  }

  getConnectionStatus(): ConnectionStatus {
    return {
      status: this.isConnectedFlag ? 'connected' : 'disconnected',
      connectedAt: this.isConnectedFlag ? new Date() : null,
      errorCount: this.reconnectAttempts
    };
  }

  private handleMessage(data: string): void {
    try {
      const message = JSON.parse(data);
      
      // å¤„ç†å®æ—¶ä»·æ ¼æ•°æ®
      if (message.type === 'quote') {
        const standardizedQuote = this.transformStreamData(message);
        
        // è§¦å‘æ•°æ®äº‹ä»¶ï¼ˆå®é™…å®ç°ä¸­éœ€è¦äº‹ä»¶å‘å°„å™¨ï¼‰
        console.log('æ”¶åˆ°å®æ—¶æŠ¥ä»·:', standardizedQuote);
      }
    } catch (error) {
      console.error('å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥:', error);
    }
  }

  private transformStreamData(rawMessage: any): any {
    return {
      symbol: rawMessage.symbol,
      lastPrice: rawMessage.price,
      change: rawMessage.change,
      changePercent: rawMessage.changePercent,
      volume: rawMessage.volume,
      timestamp: new Date(rawMessage.timestamp),
      market: 'US'
    };
  }

  private async waitForConnection(): Promise<void> {
    return new Promise((resolve, reject) => {
      const timeout = setTimeout(() => {
        reject(new Error('WebSocketè¿æ¥è¶…æ—¶'));
      }, 10000);

      const checkConnection = () => {
        if (this.isConnectedFlag) {
          clearTimeout(timeout);
          resolve();
        } else {
          setTimeout(checkConnection, 100);
        }
      };

      checkConnection();
    });
  }

  private attemptReconnect(): void {
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      this.reconnectAttempts++;
      console.log(`å°è¯•é‡è¿ Alpha Vantage WebSocket (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
      
      setTimeout(() => {
        this.connect().catch(error => {
          console.error('é‡è¿å¤±è´¥:', error);
        });
      }, 1000 * this.reconnectAttempts); // é€’å¢å»¶è¿Ÿ
    } else {
      console.error('Alpha Vantage WebSocketé‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
    }
  }
}

export default StreamRealTimeQuotesCapability;
```

### æ­¥éª¤4: åˆ›å»ºç±»å‹å®šä¹‰

```typescript
// src/providers/alpha-vantage/types.ts

/**
 * Alpha Vantage é…ç½®æ¥å£
 */
export interface AlphaVantageConfig {
  apiKey: string;
  baseUrl?: string;
  timeout?: number;
  retryAttempts?: number;
  rateLimitBuffer?: number; // è¯·æ±‚é—´éš”ç¼“å†²æ—¶é—´(ms)
}

/**
 * Alpha Vantage API åŸå§‹å“åº”æ ¼å¼
 */
export interface AlphaVantageQuoteResponse {
  'Global Quote': {
    '01. symbol': string;
    '02. open': string;
    '03. high': string;
    '04. low': string;
    '05. price': string;
    '06. volume': string;
    '07. latest trading day': string;
    '08. previous close': string;
    '09. change': string;
    '10. change percent': string;
  };
}

/**
 * Alpha Vantage é”™è¯¯å“åº”
 */
export interface AlphaVantageErrorResponse {
  'Error Message'?: string;
  'Note'?: string; // é¢‘ç‡é™åˆ¶æç¤º
}

/**
 * Alpha Vantage WebSocket æ¶ˆæ¯æ ¼å¼
 */
export interface AlphaVantageStreamMessage {
  type: 'quote' | 'error' | 'heartbeat';
  symbol?: string;
  price?: number;
  change?: number;
  changePercent?: number;
  volume?: number;
  timestamp?: string;
  error?: string;
}

/**
 * å†…éƒ¨ä½¿ç”¨çš„æ ‡å‡†åŒ–æŠ¥ä»·æ•°æ®
 */
export interface StandardizedQuote {
  symbol: string;
  lastPrice: number;
  change: number;
  changePercent: number;
  volume: number;
  high: number;
  low: number;
  open: number;
  previousClose: number;
  timestamp: string;
  market: string;
}
```

### æ­¥éª¤5: åˆ›å»ºNestJSæ¨¡å—

```typescript
// src/providers/alpha-vantage/module/alpha-vantage.module.ts
import { Module } from '@nestjs/common';
import { AlphaVantageProvider } from '../index';

@Module({
  providers: [AlphaVantageProvider],
  exports: [AlphaVantageProvider]
})
export class AlphaVantageModule {}
```

### æ­¥éª¤6: æ³¨å†Œåˆ°ä¸»æ¨¡å—

```typescript
// src/providers/module/providers.module.ts
import { Module, OnModuleInit } from '@nestjs/common';
import { AuthModule } from '../../auth/module/auth.module';

// å¯¼å…¥ç°æœ‰æ¨¡å—
import { LongportModule } from '../longport/module/longport.module';
import { LongportSgModule } from '../longport-sg/module/longport-sg.module';

// å¯¼å…¥æ–°æ¨¡å—
import { AlphaVantageModule } from '../alpha-vantage/module/alpha-vantage.module';

// å¯¼å…¥æ³¨å†Œè¡¨æœåŠ¡
import { CapabilityRegistryService } from '../services/capability-registry.service';
import { EnhancedCapabilityRegistryService } from '../services/enhanced-capability-registry.service';

// å¯¼å…¥Providerå®ä¾‹
import { LongportProvider } from '../longport/longport.provider';
import { LongportSgProvider } from '../longport-sg/longport-sg.provider';
import { AlphaVantageProvider } from '../alpha-vantage';

// å¯¼å…¥æ§åˆ¶å™¨
import { ProvidersController } from '../controller/providers-controller';

@Module({
  imports: [
    AuthModule,
    LongportModule,
    LongportSgModule,
    AlphaVantageModule, // æ·»åŠ æ–°æ¨¡å—
  ],
  controllers: [ProvidersController],
  providers: [
    CapabilityRegistryService,
    EnhancedCapabilityRegistryService,
    {
      provide: 'ENHANCED_CAPABILITY_REGISTRY',
      useClass: EnhancedCapabilityRegistryService
    }
  ],
  exports: [CapabilityRegistryService, EnhancedCapabilityRegistryService],
})
export class ProvidersModule implements OnModuleInit {
  constructor(
    private readonly capabilityRegistry: CapabilityRegistryService,
    private readonly longportProvider: LongportProvider,
    private readonly longportSgProvider: LongportSgProvider,
    private readonly alphaVantageProvider: AlphaVantageProvider, // æ³¨å…¥æ–°Provider
  ) {}

  async onModuleInit() {
    await this.registerProviders();
  }

  private async registerProviders(): Promise<void> {
    // æ³¨å†Œç°æœ‰Provider
    this.capabilityRegistry.registerProvider(this.longportProvider);
    this.capabilityRegistry.registerProvider(this.longportSgProvider);
    
    // æ³¨å†Œæ–°Provider
    this.capabilityRegistry.registerProvider(this.alphaVantageProvider);
  }
}
```

### æ­¥éª¤7: åˆ›å»ºæ–‡æ¡£ï¼ˆå¯é€‰ï¼‰

```markdown
<!-- src/providers/alpha-vantage/README.md -->
# Alpha Vantage æ•°æ®æº

Alpha Vantageæ˜¯ä¸€ä¸ªå…è´¹çš„è‚¡ç¥¨APIæœåŠ¡ï¼Œæä¾›å…¨çƒè‚¡å¸‚æ•°æ®ã€‚

## æ”¯æŒçš„èƒ½åŠ›

- `get-stock-quote` - è·å–è‚¡ç¥¨å®æ—¶æŠ¥ä»·
- `get-stock-basic-info` - è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
- `stream-real-time-quotes` - å®æ—¶è‚¡ä»·æµï¼ˆWebSocketï¼‰

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# å¿…éœ€ï¼šAlpha Vantage APIå¯†é’¥
export ALPHA_VANTAGE_API_KEY=your_api_key_here

# å¯é€‰ï¼šAPIåŸºç¡€URLï¼ˆé»˜è®¤ï¼šhttps://www.alphavantage.coï¼‰
export ALPHA_VANTAGE_BASE_URL=https://www.alphavantage.co

# å¯é€‰ï¼šè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ï¼š5000msï¼‰
export ALPHA_VANTAGE_TIMEOUT=5000
```

### è·å–APIå¯†é’¥

1. è®¿é—® [Alpha Vantage](https://www.alphavantage.co/support/#api-key)
2. å…è´¹æ³¨å†Œè´¦æˆ·
3. è·å–APIå¯†é’¥
4. è®¾ç½®ç¯å¢ƒå˜é‡

## ä½¿ç”¨é™åˆ¶

- **å…è´¹ç‰ˆ**: æ¯åˆ†é’Ÿ5æ¬¡è¯·æ±‚ï¼Œæ¯å¤©500æ¬¡è¯·æ±‚
- **ä»˜è´¹ç‰ˆ**: æ›´é«˜çš„è¯·æ±‚é™åˆ¶

## ä½¿ç”¨ç¤ºä¾‹

```bash
# è·å–è‚¡ç¥¨æŠ¥ä»·
curl -X POST http://localhost:3000/api/v1/receiver/data \
  -H "X-App-Key: YOUR_APP_KEY" \
  -H "X-Access-Token: YOUR_ACCESS_TOKEN" \
  -d '{
    "symbols": ["AAPL", "GOOGL"],
    "receiverType": "get-stock-quote",
    "options": {"preferredProvider": "alpha-vantage"}
  }'
```

## æ³¨æ„äº‹é¡¹

1. **è¯·æ±‚é¢‘ç‡**: å…è´¹ç‰ˆæœ‰ä¸¥æ ¼çš„é¢‘ç‡é™åˆ¶ï¼Œè¶…å‡ºä¼šè¿”å›é”™è¯¯
2. **å¸‚åœºæ”¯æŒ**: ä¸»è¦æ”¯æŒç¾å›½å’Œè‹±å›½å¸‚åœº
3. **ç¬¦å·æ ¼å¼**: ä½¿ç”¨æ ‡å‡†è‚¡ç¥¨ä»£ç ï¼Œå¦‚ AAPLã€GOOGL
4. **WebSocket**: ç¤ºä¾‹ä»£ç ä¸­çš„WebSocketåŠŸèƒ½ä¸ºæ¼”ç¤ºç”¨é€”ï¼ŒAlpha Vantageå®é™…ä¸æä¾›WebSocketæ¥å£
```

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### 1. å¯åŠ¨æœåŠ¡éªŒè¯

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
bun run dev

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼Œç¡®è®¤æ³¨å†ŒæˆåŠŸ
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä¿¡æ¯ï¼š
# [EnhancedCapabilityRegistryService] è£…é¥°å™¨æ•°æ®æ”¶é›†å®Œæˆ
# [ProvidersModule] Providerå®ä¾‹æ³¨å†ŒæˆåŠŸ: alpha-vantage
```

### 2. APIæµ‹è¯•

```bash
# 1. æ£€æŸ¥èƒ½åŠ›æ³¨å†Œ
curl http://localhost:3000/api/v1/providers/capabilities | grep alpha-vantage

# 2. æµ‹è¯•è·å–æŠ¥ä»·ï¼ˆéœ€è¦è®¾ç½®APIè®¤è¯ï¼‰
curl -X POST http://localhost:3000/api/v1/receiver/data \
  -H "X-App-Key: YOUR_APP_KEY" \
  -H "X-Access-Token: YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "symbols": ["AAPL"],
    "receiverType": "get-stock-quote"
  }'
```

### 3. å•å…ƒæµ‹è¯•ï¼ˆå¯é€‰ï¼‰

```typescript
// src/providers/alpha-vantage/tests/alpha-vantage.spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { AlphaVantageProvider } from '../index';
import { GetStockQuoteCapability } from '../capabilities/get-stock-quote';

describe('AlphaVantageProvider', () => {
  let provider: AlphaVantageProvider;
  let capability: GetStockQuoteCapability;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [AlphaVantageProvider, GetStockQuoteCapability],
    }).compile();

    provider = module.get<AlphaVantageProvider>(AlphaVantageProvider);
    capability = module.get<GetStockQuoteCapability>(GetStockQuoteCapability);
  });

  it('should be defined', () => {
    expect(provider).toBeDefined();
    expect(capability).toBeDefined();
  });

  it('should initialize successfully', async () => {
    await expect(provider.initialize()).resolves.not.toThrow();
  });

  it('should test connection', async () => {
    const result = await provider.testConnection();
    expect(typeof result).toBe('boolean');
  });
});
```

## ğŸ¯ æ‰‹åŠ¨æ¥å…¥çš„ä¼˜åŠ¿

### 1. å®Œå…¨æ§åˆ¶

- **ç²¾ç¡®é…ç½®**: å¯ä»¥ç²¾ç¡®æ§åˆ¶æ¯ä¸ªé…ç½®é¡¹
- **è‡ªå®šä¹‰ç»“æ„**: å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ç›®å½•ç»“æ„
- **ç‰¹æ®Šéœ€æ±‚**: å¯ä»¥å®ç°ç‰¹æ®Šçš„ä¸šåŠ¡é€»è¾‘

### 2. å­¦ä¹ ä»·å€¼

- **æ·±å…¥ç†è§£**: å®Œå…¨ç†è§£è£…é¥°å™¨ç³»ç»Ÿçš„å·¥ä½œåŸç†
- **è°ƒè¯•èƒ½åŠ›**: é‡åˆ°é—®é¢˜æ—¶èƒ½å¤Ÿå¿«é€Ÿå®šä½å’Œè§£å†³
- **æ‰©å±•èƒ½åŠ›**: å…·å¤‡æ‰©å±•å’Œä¿®æ”¹ç³»ç»Ÿçš„èƒ½åŠ›

### 3. çµæ´»æ€§

- **æ¸è¿›å®ç°**: å¯ä»¥é€æ­¥å®ç°å„ä¸ªèƒ½åŠ›
- **è‡ªå®šä¹‰è£…é¥°å™¨**: å¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºè‡ªå®šä¹‰è£…é¥°å™¨
- **é«˜çº§åŠŸèƒ½**: å¯ä»¥å®ç°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘

## ğŸš¨ å¸¸è§é—®é¢˜

### 1. è£…é¥°å™¨ä¸ç”Ÿæ•ˆ

**é—®é¢˜**: èƒ½åŠ›æˆ–æä¾›å•†æœªè¢«ç³»ç»Ÿå‘ç°

**åŸå› **: 
- è£…é¥°å™¨è¯­æ³•é”™è¯¯
- æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®
- æ¨¡å—æœªæ­£ç¡®æ³¨å†Œ

**è§£å†³**:
```typescript
// ç¡®ä¿è£…é¥°å™¨è¯­æ³•æ­£ç¡®
@Provider({
  name: 'alpha-vantage', // å¿…éœ€
  description: '...'     // æ¨è
})

// ç¡®ä¿æ­£ç¡®å®ç°æ¥å£
export class AlphaVantageProvider implements IDataProvider {
  // å¿…é¡»å®ç°æ‰€æœ‰æ¥å£æ–¹æ³•
}
```

### 2. è‡ªåŠ¨æ¨æ–­å¤±è´¥

**é—®é¢˜**: æä¾›å•†åç§°æ¨æ–­ä¸æ­£ç¡®

**è§£å†³**: æ˜ç¡®æŒ‡å®šæä¾›å•†åç§°
```typescript
@Capability({
  name: 'get-stock-quote',
  provider: 'alpha-vantage', // æ˜ç¡®æŒ‡å®šï¼Œä¸ä¾èµ–æ¨æ–­
})
```

### 3. Providerå®ä¾‹æœªæ³¨å†Œ

**é—®é¢˜**: è¿è¡Œæ—¶æ‰¾ä¸åˆ°Providerå®ä¾‹

**è§£å†³**: ç¡®ä¿åœ¨ProvidersModuleä¸­å®Œæˆä¸‰ä¸ªæ­¥éª¤
```typescript
@Module({
  imports: [AlphaVantageModule], // 1. å¯¼å…¥æ¨¡å—
})
export class ProvidersModule {
  constructor(
    private readonly alphaVantageProvider: AlphaVantageProvider, // 2. æ³¨å…¥å®ä¾‹
  ) {}

  private async registerProviders(): Promise<void> {
    this.capabilityRegistry.registerProvider(this.alphaVantageProvider); // 3. æ³¨å†Œå®ä¾‹
  }
}
```

## ğŸ“‹ æ‰‹åŠ¨æ¥å…¥æ£€æŸ¥æ¸…å•

- [ ] **ç›®å½•ç»“æ„**: åˆ›å»ºäº†å®Œæ•´çš„æä¾›å•†ç›®å½•ç»“æ„
- [ ] **ä¸»Providerç±»**: ä½¿ç”¨@Providerè£…é¥°å™¨ï¼Œå®ç°IDataProvideræ¥å£
- [ ] **èƒ½åŠ›å®ç°**: ä½¿ç”¨@Capabilityè£…é¥°å™¨ï¼Œå®ç°ICapabilityæ¥å£
- [ ] **ç±»å‹å®šä¹‰**: åˆ›å»ºäº†å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
- [ ] **NestJSæ¨¡å—**: åˆ›å»ºäº†æ¨¡å—æ–‡ä»¶å¹¶æ­£ç¡®å¯¼å‡ºProvider
- [ ] **æ¨¡å—æ³¨å†Œ**: åœ¨ProvidersModuleä¸­å¯¼å…¥ã€æ³¨å…¥ã€æ³¨å†Œ
- [ ] **ç¯å¢ƒé…ç½®**: è®¾ç½®äº†å¿…è¦çš„ç¯å¢ƒå˜é‡
- [ ] **ä¸šåŠ¡é€»è¾‘**: å®ç°äº†å…·ä½“çš„APIè°ƒç”¨å’Œæ•°æ®è½¬æ¢é€»è¾‘
- [ ] **é”™è¯¯å¤„ç†**: æ·»åŠ äº†å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- [ ] **æµ‹è¯•éªŒè¯**: é€šè¿‡å¯åŠ¨æ—¥å¿—å’ŒAPIè°ƒç”¨éªŒè¯åŠŸèƒ½æ­£å¸¸

## ğŸ“š è¿›é˜¶ä¸»é¢˜

### 1. è‡ªå®šä¹‰è£…é¥°å™¨

```typescript
// åˆ›å»ºä¸“ç”¨äºç‰¹å®šæ•°æ®æºçš„è£…é¥°å™¨
export function AlphaVantageCapability(metadata: Partial<CapabilityMetadata>) {
  return Capability({
    provider: 'alpha-vantage',
    markets: ['US', 'UK'],
    ...metadata
  });
}

// ä½¿ç”¨è‡ªå®šä¹‰è£…é¥°å™¨
@AlphaVantageCapability({
  name: 'get-earnings-data',
  description: 'è·å–è´¢æŠ¥æ•°æ®'
})
export class GetEarningsCapability implements ICapability {
  // ...
}
```

### 2. å¤æ‚é…ç½®ç®¡ç†

```typescript
@Provider({
  name: 'alpha-vantage',
  config: {
    endpoints: {
      quote: '/query?function=GLOBAL_QUOTE',
      fundamentals: '/query?function=OVERVIEW',
      earnings: '/query?function=EARNINGS'
    },
    rateLimits: {
      free: { perMinute: 5, perDay: 500 },
      premium: { perMinute: 75, perDay: 75000 }
    }
  }
})
```

### 3. ä¾èµ–æ³¨å…¥é›†æˆ

```typescript
@Provider({
  name: 'alpha-vantage'
})
@Injectable()
export class AlphaVantageProvider implements IDataProvider {
  constructor(
    @Inject('CONFIG_SERVICE') private configService: ConfigService,
    @Inject('CACHE_SERVICE') private cacheService: CacheService,
    @Inject('METRICS_SERVICE') private metricsService: MetricsService,
  ) {}
}
```

---

*æ‰‹åŠ¨æ¥å…¥æ–¹å¼æä¾›äº†æœ€å¤§çš„çµæ´»æ€§å’Œæ§åˆ¶åŠ›ï¼Œé€‚åˆéœ€è¦æ·±åº¦å®šåˆ¶æˆ–å­¦ä¹ ç³»ç»Ÿå†…éƒ¨æœºåˆ¶çš„å¼€å‘è€…ã€‚å¦‚æœæ‚¨éœ€è¦å¿«é€Ÿæ¥å…¥ï¼Œå»ºè®®ä½¿ç”¨CLIå·¥å…·æ–¹å¼ã€‚*