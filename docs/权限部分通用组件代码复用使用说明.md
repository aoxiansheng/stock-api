# æƒé™éƒ¨åˆ†é€šç”¨ç»„ä»¶ä»£ç å¤ç”¨ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ–‡æ¡£æ¦‚è§ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ17æ—¥  
**ç»´æŠ¤å›¢é˜Ÿ**: åç«¯å¼€å‘å›¢é˜Ÿ  
**é€‚ç”¨èŒƒå›´**: å…¨é¡¹ç›®æƒé™ç³»ç»Ÿæ¶æ„è®¾è®¡ä¸ä½¿ç”¨æŒ‡å—  

---

## ğŸ¯ æ ¸å¿ƒæ¶æ„ç†å¿µ

### å•ä¸€æƒé™ä¸­å¿ƒæ¶æ„

æœ¬é¡¹ç›®é‡‡ç”¨**å•ä¸€æƒé™ä¸­å¿ƒæ¶æ„**ï¼Œå³**Authæ¨¡å—ä½œä¸ºå”¯ä¸€æƒé™å®šä¹‰ã€æ‰§è¡Œå’Œç®¡ç†ä¸­å¿ƒ**ï¼Œå…¶ä»–æ‰€æœ‰ä¸šåŠ¡æ¨¡å—ä½œä¸ºæƒé™æ¶ˆè´¹è€…ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Auth Module (æƒé™ä¸­å¿ƒ)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   æƒé™å®šä¹‰        â”‚   æƒé™æ‰§è¡Œ        â”‚    æƒé™è£…é¥°å™¨        â”‚  â”‚
â”‚  â”‚ â€¢ UserRole       â”‚ â€¢ Guards        â”‚ â€¢ @Auth()          â”‚  â”‚
â”‚  â”‚ â€¢ Permission     â”‚ â€¢ Services      â”‚ â€¢ @RequirePermissionsâ”‚  â”‚
â”‚  â”‚ â€¢ RolePermissionsâ”‚ â€¢ Validators    â”‚ â€¢ @Roles()         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ æä¾›æƒé™æœåŠ¡
                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Alert Moduleâ”‚    â”‚ Core Module â”‚    â”‚Other Modulesâ”‚
    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
    â”‚ @Auth([])   â”‚    â”‚ @Auth([])   â”‚    â”‚ @Auth([])   â”‚
    â”‚ (æ¶ˆè´¹æƒé™)    â”‚    â”‚ (æ¶ˆè´¹æƒé™)    â”‚    â”‚ (æ¶ˆè´¹æƒé™)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ åˆè§„æ€§æ£€æŸ¥
                              â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ @common/modules/permission  â”‚
                â”‚      (æƒé™åˆè§„æ€§æ£€æŸ¥å·¥å…·)      â”‚
                â”‚                            â”‚
                â”‚ â€¢ PermissionValidator      â”‚
                â”‚ â€¢ è£…é¥°å™¨ä½¿ç”¨æ£€æŸ¥             â”‚
                â”‚ â€¢ æƒé™çº§åˆ«éªŒè¯              â”‚
                â”‚ â€¢ åˆè§„æ€§æŠ¥å‘Šç”Ÿæˆ            â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ ç»„ä»¶åŠŸèƒ½å®šä½

### 1. Authæ¨¡å— - æƒé™ä¸­å¿ƒ â­

**ä½ç½®**: `src/auth/`  
**è§’è‰²**: æƒé™ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£æƒé™çš„å®šä¹‰ã€æ‰§è¡Œå’Œç®¡ç†

#### æ ¸å¿ƒåŠŸèƒ½
- **æƒé™å®šä¹‰**: UserRoleã€Permissionæšä¸¾å’ŒRolePermissionsæ˜ å°„
- **æƒé™æ‰§è¡Œ**: UnifiedPermissionsGuardç»Ÿä¸€æƒé™å®ˆå«
- **æƒé™æœåŠ¡**: PermissionServiceæƒé™éªŒè¯æœåŠ¡
- **æƒé™è£…é¥°å™¨**: @Authã€@RequirePermissionsã€@Rolesè£…é¥°å™¨
- **ç¼“å­˜æœºåˆ¶**: æƒé™éªŒè¯ç»“æœç¼“å­˜
- **å®¡è®¡æ—¥å¿—**: æƒé™æ£€æŸ¥æ—¥å¿—è®°å½•

#### æƒé™ä½“ç³»
```typescript
// ç”¨æˆ·è§’è‰²å®šä¹‰
export enum UserRole {
  ADMIN = "admin",
  DEVELOPER = "developer",
}

// ç»†ç²’åº¦æƒé™å®šä¹‰ (21ä¸ªæƒé™)
export enum Permission {
  // åŸºç¡€æ•°æ®æƒé™ (3ä¸ª)
  DATA_READ = "data:read",
  QUERY_EXECUTE = "query:execute", 
  PROVIDERS_READ = "providers:read",
  
  // å¼€å‘è€…æƒé™ (6ä¸ª)
  TRANSFORMER_PREVIEW = "transformer:preview",
  SYSTEM_MONITOR = "system:monitor",
  SYSTEM_METRICS = "system:metrics",
  // ...æ›´å¤šæƒé™

  // ç®¡ç†å‘˜æƒé™ (5ä¸ª)
  USER_MANAGE = "user:manage",
  APIKEY_MANAGE = "apikey:manage",
  CONFIG_WRITE = "config:write",
  // ...æ›´å¤šæƒé™
}

// è§’è‰²æƒé™æ˜ å°„
export const RolePermissions = {
  [UserRole.DEVELOPER]: DEVELOPER_PERMISSIONS,
  [UserRole.ADMIN]: [...DEVELOPER_PERMISSIONS, ...ADMIN_PERMISSIONS],
};
```

#### é›†æˆé€šç”¨æƒé™å·¥å…·
```typescript
// Authæ¨¡å—å·²é›†æˆ@common/modules/permissionä½œä¸ºéªŒè¯å·¥å…·
@Module({
  imports: [
    PermissionModule,  // âœ… æƒé™åˆè§„æ€§æ£€æŸ¥å·¥å…·
    // ...å…¶ä»–æ¨¡å—
  ],
  providers: [
    UnifiedPermissionsGuard,  // ç»Ÿä¸€æƒé™å®ˆå«
    PermissionService,        // æƒé™éªŒè¯æœåŠ¡
    // ...å…¶ä»–æœåŠ¡
  ],
  exports: [
    UnifiedPermissionsGuard,  // å¯¼å‡ºç»™å…¨å±€ä½¿ç”¨
    // ...å…¶ä»–å¯¼å‡º
  ],
})
export class AuthModule {}
```

### 2. @common/modules/permission - æƒé™åˆè§„æ€§æ£€æŸ¥å·¥å…· ğŸ”

**ä½ç½®**: `src/common/modules/permission/`  
**è§’è‰²**: å¼€å‘é˜¶æ®µçš„æƒé™ä½¿ç”¨åˆè§„æ€§æ£€æŸ¥å·¥å…·ï¼Œ**ä¸æ˜¯æƒé™æ‰§è¡Œå™¨**

#### æ ¸å¿ƒåŠŸèƒ½
- **è£…é¥°å™¨ä½¿ç”¨æ£€æŸ¥**: éªŒè¯@Authã€@RequirePermissionsè£…é¥°å™¨ä½¿ç”¨æ˜¯å¦è§„èŒƒ
- **æƒé™çº§åˆ«éªŒè¯**: æ£€æŸ¥æƒé™ç»„åˆæ˜¯å¦åˆç†
- **åˆè§„æ€§æŠ¥å‘Š**: ç”Ÿæˆæƒé™ä½¿ç”¨åˆè§„æ€§æŠ¥å‘Š
- **å¼€å‘æ—¶éªŒè¯**: åœ¨å¼€å‘é˜¶æ®µæ£€æŸ¥æƒé™é…ç½®æ­£ç¡®æ€§

#### éªŒè¯åŠŸèƒ½
```typescript
/**
 * æƒé™è£…é¥°å™¨éªŒè¯å™¨ - åˆè§„æ€§æ£€æŸ¥å·¥å…·
 */
@Injectable()
export class PermissionDecoratorValidator {
  /**
   * éªŒè¯æ‰€æœ‰æ§åˆ¶å™¨çš„æƒé™è£…é¥°å™¨ä½¿ç”¨
   */
  async validateAllControllers(): Promise<ValidationResult[]> {
    // æ£€æŸ¥è£…é¥°å™¨ä½¿ç”¨è§„èŒƒ
    // éªŒè¯æƒé™çº§åˆ«åˆç†æ€§
    // ç”Ÿæˆåˆè§„æ€§æŠ¥å‘Š
  }
}
```

#### éªŒè¯è§„åˆ™
- **@ApiKeyAuthå¿…é¡»é…åˆ@RequirePermissionsä½¿ç”¨**
- **æƒé™çº§åˆ«ä¸€è‡´æ€§æ£€æŸ¥**
- **æƒé™ç»„åˆæœ‰æ•ˆæ€§éªŒè¯**
- **è£…é¥°å™¨ä½¿ç”¨è§„èŒƒæ£€æŸ¥**

### 3. ä¸šåŠ¡æ¨¡å— - æƒé™æ¶ˆè´¹è€… ğŸ“±

**å…¸å‹æ¨¡å—**: Alertæ¨¡å—ã€Coreæ¨¡å—ç­‰  
**è§’è‰²**: æƒé™çš„ä½¿ç”¨è€…ï¼Œé€šè¿‡Authæ¨¡å—æä¾›çš„è£…é¥°å™¨è¿›è¡Œæƒé™æ§åˆ¶

---

## ğŸš€ æƒé™é›†æˆç­–ç•¥

### é›†æˆå†³ç­–çŸ©é˜µ

| æ¨¡å—ç±»å‹ | æ˜¯å¦éœ€è¦é›†æˆ@common/modules/permission | æƒé™å®ç°æ–¹å¼ | é›†æˆæ–¹å¼ |
|----------|----------------------------------------|-------------|----------|
| **Authæ¨¡å—** | âœ… **å·²é›†æˆ** (ä½œä¸ºæƒé™ä¸­å¿ƒ) | æƒé™å®šä¹‰ + æ‰§è¡Œ + éªŒè¯å·¥å…· | å®Œæ•´é›†æˆPermissionModule |
| **ä¸šåŠ¡æ¨¡å—** (Alert, Coreç­‰) | âŒ **ä¸éœ€è¦é›†æˆ** | ä½¿ç”¨Authæ¨¡å—æä¾›çš„è£…é¥°å™¨ | å¯¼å…¥Authè£…é¥°å™¨å³å¯ |
| **@common/modules/permission** | N/A (å·¥å…·æ¨¡å—) | æƒé™åˆè§„æ€§æ£€æŸ¥å·¥å…· | è¢«Authæ¨¡å—é›†æˆ |

### æ ¸å¿ƒåŸåˆ™

#### âœ… æ¨èåšæ³•
```typescript
// 1. Authæ¨¡å— - æƒé™ä¸­å¿ƒ (å·²å®Œæˆ)
@Module({
  imports: [PermissionModule], // é›†æˆæƒé™éªŒè¯å·¥å…·
  providers: [UnifiedPermissionsGuard, PermissionService],
  exports: [UnifiedPermissionsGuard], // å¯¼å‡ºç»™å…¶ä»–æ¨¡å—ä½¿ç”¨
})
export class AuthModule {}

// 2. ä¸šåŠ¡æ¨¡å— - æƒé™æ¶ˆè´¹è€… (å½“å‰åšæ³•å·²æ­£ç¡®)  
@Controller('alerts')
export class AlertController {
  @Auth([UserRole.ADMIN])    // âœ… ä½¿ç”¨Authæ¨¡å—çš„è£…é¥°å™¨
  @Post('rules')
  createRule() {}
}

// 3. åº”ç”¨çº§åˆ« - å…¨å±€æƒé™å®ˆå« (å·²é…ç½®)
@Module({
  providers: [
    {
      provide: APP_GUARD,
      useClass: UnifiedPermissionsGuard, // å…¨å±€æƒé™å®ˆå«
    },
  ],
})
export class AppModule {}
```

#### âŒ é”™è¯¯åšæ³•
```typescript
// é”™è¯¯ï¼šåœ¨æ¯ä¸ªä¸šåŠ¡æ¨¡å—ä¸­éƒ½é›†æˆæƒé™æ¨¡å—
@Module({
  imports: [PermissionModule], // âŒ ä¸éœ€è¦ï¼
})
export class AlertModule {}

@Module({
  imports: [PermissionModule], // âŒ ä¸éœ€è¦ï¼
})
export class CoreModule {}
```

---

## ğŸ“š ä½¿ç”¨æŒ‡å—

### 1. ä¸šåŠ¡æ¨¡å—æƒé™æ§åˆ¶æœ€ä½³å®è·µ

#### **åŸºç¡€æƒé™æ§åˆ¶**
```typescript
import { Auth } from '@auth/decorators/auth.decorator';
import { Public } from '@auth/decorators/public.decorator';
import { UserRole } from '@auth/enums/user-role.enum';

@Controller('business')
export class BusinessController {
  
  // ç®¡ç†å‘˜ä¸“ç”¨åŠŸèƒ½
  @Auth([UserRole.ADMIN])
  @Post('admin-action')
  adminAction() {
    // åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
  }
  
  // å¼€å‘è€…å’Œç®¡ç†å‘˜éƒ½å¯è®¿é—®
  @Auth([UserRole.ADMIN, UserRole.DEVELOPER])
  @Get('data')
  getData() {
    // å·²ç™»å½•çš„å¼€å‘è€…å’Œç®¡ç†å‘˜å¯ä»¥è®¿é—®
  }
  
  // å…¬å¼€æ¥å£
  @Public()
  @Get('public-info')
  getPublicInfo() {
    // æ— éœ€è®¤è¯å³å¯è®¿é—®
  }
}
```

#### **ç»†ç²’åº¦æƒé™æ§åˆ¶**
```typescript
import { RequirePermissions } from '@auth/decorators/permissions.decorator';
import { Permission } from '@auth/enums/user-role.enum';

@Controller('advanced')
export class AdvancedController {
  
  // è§’è‰² + æƒé™åŒé‡éªŒè¯
  @Auth([UserRole.ADMIN, UserRole.DEVELOPER])
  @RequirePermissions(Permission.DATA_READ)
  @Get('sensitive-data')
  getSensitiveData() {
    // éœ€è¦ç™»å½• + å…·å¤‡æ•°æ®è¯»å–æƒé™
  }
  
  // å¤šæƒé™è¦æ±‚
  @Auth([UserRole.ADMIN])
  @RequirePermissions(Permission.CONFIG_WRITE, Permission.SYSTEM_ADMIN)
  @Put('system-config')
  updateSystemConfig() {
    // éœ€è¦ç®¡ç†å‘˜è§’è‰² + é…ç½®å†™å…¥æƒé™ + ç³»ç»Ÿç®¡ç†æƒé™
  }
  
  // API Keyä¸“ç”¨æƒé™
  @RequirePermissions(Permission.DATA_READ)
  @Get('api-data')
  getApiData() {
    // æ”¯æŒAPI Keyå’ŒJWTç”¨æˆ·ï¼Œä½†éƒ½éœ€è¦æ•°æ®è¯»å–æƒé™
  }
}
```

### 2. æƒé™éªŒè¯æµç¨‹

#### **è®¤è¯ä¸»ä½“ç±»å‹**
```typescript
// JWTç”¨æˆ·æƒé™éªŒè¯æµç¨‹
1. æ£€æŸ¥JWT Tokenæœ‰æ•ˆæ€§
2. æå–ç”¨æˆ·è§’è‰²å’Œæƒé™
3. éªŒè¯è§’è‰²è¦æ±‚ (å¦‚æœæœ‰@Authè£…é¥°å™¨)
4. éªŒè¯æƒé™è¦æ±‚ (å¦‚æœæœ‰@RequirePermissionsè£…é¥°å™¨)
5. æƒé™æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸è®¿é—®

// API Keyæƒé™éªŒè¯æµç¨‹  
1. æ£€æŸ¥API Keyæœ‰æ•ˆæ€§
2. æå–API Keyå…³è”çš„æƒé™
3. è·³è¿‡è§’è‰²éªŒè¯ (API Keyæ— è§’è‰²æ¦‚å¿µ)
4. éªŒè¯æƒé™è¦æ±‚ (å¦‚æœæœ‰@RequirePermissionsè£…é¥°å™¨)
5. æƒé™æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸è®¿é—®
```

#### **æƒé™æ£€æŸ¥é€»è¾‘**
```typescript
/**
 * ç»Ÿä¸€æƒé™éªŒè¯å®ˆå«æ‰§è¡Œé€»è¾‘
 */
async canActivate(context: ExecutionContext): Promise<boolean> {
  // 1. è·å–æƒé™è¦æ±‚
  const requiredRoles = this.getRequiredRoles(context);
  const requiredPermissions = this.getRequiredPermissions(context);
  
  // 2. å¦‚æœæ²¡æœ‰æƒé™è¦æ±‚ï¼Œç›´æ¥æ”¾è¡Œ
  if (requiredRoles.length === 0 && requiredPermissions.length === 0) {
    return true;
  }
  
  // 3. è·å–è®¤è¯ä¸»ä½“ (JWTç”¨æˆ· æˆ– API Key)
  const authSubject = AuthSubjectFactory.createFromRequest(request);
  
  // 4. æ‰§è¡Œæƒé™éªŒè¯
  const checkResult = await this.permissionService.checkPermissions(
    authSubject,
    requiredPermissions, 
    requiredRoles,
  );
  
  // 5. è¿”å›éªŒè¯ç»“æœ
  return checkResult.allowed;
}
```

### 3. æƒé™åˆè§„æ€§æ£€æŸ¥

#### **å¼€å‘é˜¶æ®µæƒé™éªŒè¯**
```typescript
// åœ¨å¼€å‘/æµ‹è¯•é˜¶æ®µä½¿ç”¨æƒé™éªŒè¯å·¥å…·
import { PermissionDecoratorValidator } from '@common/modules/permission/validators';

// æ£€æŸ¥æ‰€æœ‰æ§åˆ¶å™¨çš„æƒé™è£…é¥°å™¨ä½¿ç”¨æ˜¯å¦è§„èŒƒ
const validator = new PermissionDecoratorValidator();
const results = await validator.validateAllControllers();
const report = validator.generateReport(results);

console.log(report);
```

#### **æƒé™åˆè§„æ€§æŠ¥å‘Šç¤ºä¾‹**
```
æƒé™è£…é¥°å™¨éªŒè¯æŠ¥å‘Š
======================

æ€»ä½“ç»Ÿè®¡:
- æ§åˆ¶å™¨æ€»æ•°: 15
- è·¯ç”±æ€»æ•°: 89
- è¿è§„æ€»æ•°: 3
- åˆè§„æ§åˆ¶å™¨: 12/15 (80.0%)

è¿è§„è¯¦æƒ…:
--------

æ§åˆ¶å™¨: UserController
  [HIGH] POST /users/admin
    é—®é¢˜: @ApiKeyAuthè£…é¥°å™¨å¿…é¡»é…åˆ@RequirePermissionsä½¿ç”¨
    å»ºè®®: æ·»åŠ  @RequirePermissions(Permission.XXX) è£…é¥°å™¨

æ§åˆ¶å™¨: ConfigController  
  [MEDIUM] PUT /config/system
    é—®é¢˜: æƒé™çº§åˆ«ä¸ä¸€è‡´ï¼ŒåŒæ—¶è¦æ±‚é«˜çº§å’Œä½çº§æƒé™
    å»ºè®®: ä½¿ç”¨å•ä¸€æƒé™çº§åˆ«æˆ–å»ºç«‹æƒé™ç»§æ‰¿å…³ç³»
```

---

## ğŸ” æ¨¡å—æƒé™å®ç°æ¡ˆä¾‹

### Alertæ¨¡å—æƒé™å®ç° âœ… æœ€ä½³å®è·µ

**å½“å‰å®ç°æ–¹å¼**ï¼ˆå®Œå…¨æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹ï¼‰ï¼š

```typescript
// src/alert/controller/alert.controller.ts
import { Auth } from '../../auth/decorators/auth.decorator';
import { UserRole } from '../../auth/enums/user-role.enum';

@ApiTags("å‘Šè­¦ç®¡ç†")
@Controller("alerts")
export class AlertController {

  // âœ… æ ‡å‡†æƒé™æ§åˆ¶ - ç®¡ç†å‘˜ä¸“ç”¨
  @Auth([UserRole.ADMIN])
  @Post("rules")
  @ApiOperation({ summary: "ğŸš¨ åˆ›å»ºå‘Šè­¦è§„åˆ™" })
  async createRule(@Body() createRuleDto: CreateAlertRuleDto) {
    return await this.alertOrchestrator.createRule(createRuleDto);
  }

  // âœ… ç»Ÿä¸€æƒé™æ ‡å‡† - æ‰€æœ‰å‘Šè­¦æ“ä½œéƒ½è¦æ±‚ç®¡ç†å‘˜æƒé™
  @Auth([UserRole.ADMIN])
  @Get("rules")
  @ApiOperation({ summary: "ğŸ“‹ è·å–æ‰€æœ‰å‘Šè­¦è§„åˆ™" })
  async getRules() {
    return await this.alertOrchestrator.getRules();
  }

  // âœ… é¢‘ç‡é™åˆ¶ + æƒé™æ§åˆ¶
  @Auth([UserRole.ADMIN])
  @Throttle({ default: { limit: 5, ttl: 60000 } })
  @Post("trigger")
  @ApiOperation({ summary: "âš¡ æ‰‹åŠ¨è§¦å‘å‘Šè­¦è¯„ä¼°" })
  async triggerEvaluation(@Body() triggerDto?: TriggerAlertDto) {
    // æƒé™éªŒè¯è‡ªåŠ¨ç”±UnifiedPermissionsGuardå¤„ç†
    // é¢‘ç‡é™åˆ¶ç”±ThrottlerGuardå¤„ç†
  }
}
```

**ä¸ºä»€ä¹ˆAlertæ¨¡å—ä¸éœ€è¦é›†æˆ@common/modules/permissionï¼Ÿ**

1. **æƒé™é€»è¾‘å·²ç»Ÿä¸€**: ä½¿ç”¨Authæ¨¡å—çš„`@Auth([UserRole.ADMIN])`è£…é¥°å™¨
2. **æƒé™éªŒè¯è‡ªåŠ¨åŒ–**: UnifiedPermissionsGuardå…¨å±€å®ˆå«è‡ªåŠ¨å¤„ç†
3. **æ¶æ„æ¸…æ™°**: æƒé™å®šä¹‰åœ¨Authæ¨¡å—ï¼ŒAlertæ¨¡å—åªæ˜¯æ¶ˆè´¹è€…
4. **ç»´æŠ¤æˆæœ¬ä½**: æ— éœ€åœ¨Alertæ¨¡å—ä¸­ç»´æŠ¤æƒé™é€»è¾‘

---

## ğŸ“Š æ¶æ„ä¼˜åŠ¿åˆ†æ

### å•ä¸€æƒé™ä¸­å¿ƒçš„ä¼˜åŠ¿

| ä¼˜åŠ¿é¡¹ç›® | å…·ä½“è¡¨ç° | å®ç°æ•ˆæœ |
|----------|----------|----------|
| **ä¸€è‡´æ€§** | æ‰€æœ‰æ¨¡å—ä½¿ç”¨ç›¸åŒçš„æƒé™æ ‡å‡† | UserRoleå’ŒPermissionåœ¨å…¨é¡¹ç›®ç»Ÿä¸€ |
| **å¯ç»´æŠ¤æ€§** | æƒé™é€»è¾‘é›†ä¸­åœ¨Authæ¨¡å— | ä¿®æ”¹æƒé™åªéœ€æ›´æ”¹ä¸€å¤„ |
| **å¯æ‰©å±•æ€§** | æ–°å¢æƒé™åªéœ€ä¿®æ”¹Authæ¨¡å— | æ–°ä¸šåŠ¡æ¨¡å—è‡ªåŠ¨äº«å—æƒé™ä½“ç³» |
| **å¯æµ‹è¯•æ€§** | æƒé™é€»è¾‘é›†ä¸­ï¼Œæ˜“äºå•å…ƒæµ‹è¯• | Mock UnifiedPermissionsGuardå³å¯ |
| **æ€§èƒ½ä¼˜åŒ–** | ç»Ÿä¸€çš„æƒé™ç¼“å­˜æœºåˆ¶ | æƒé™æ£€æŸ¥ç»“æœç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®— |
| **å®¡è®¡è·Ÿè¸ª** | é›†ä¸­çš„æƒé™æ£€æŸ¥æ—¥å¿— | ç»Ÿä¸€çš„æƒé™è®¿é—®å®¡è®¡è®°å½• |

### ä¸å…¶ä»–æ¶æ„æ¨¡å¼å¯¹æ¯”

| æ¶æ„æ¨¡å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|----------|------|------|----------|
| **å•ä¸€æƒé™ä¸­å¿ƒ** (å½“å‰) | ç»Ÿä¸€ç®¡ç†ã€æ˜“ç»´æŠ¤ã€é«˜æ€§èƒ½ | æƒé™ä¸­å¿ƒæˆä¸ºå…³é”®ä¾èµ– | âœ… ä¼ä¸šçº§åº”ç”¨ |
| **åˆ†å¸ƒå¼æƒé™** | æ¨¡å—ç‹¬ç«‹ã€æ•…éšœéš”ç¦» | æƒé™ä¸ä¸€è‡´ã€é‡å¤å®ç° | å¾®æœåŠ¡æ¶æ„ |
| **æ··åˆæƒé™** | çµæ´»æ€§é«˜ | å¤æ‚åº¦é«˜ã€ç»´æŠ¤å›°éš¾ | å¤æ‚ä¸šåŠ¡åœºæ™¯ |

---

## ğŸ¯ å¼€å‘è§„èŒƒ

### æ–°æ¨¡å—æƒé™é›†æˆæ­¥éª¤

#### **Step 1: ç¡®å®šæƒé™éœ€æ±‚**
```typescript
// åˆ†ææ–°æ¨¡å—çš„æƒé™éœ€æ±‚
// 1. æ˜¯å¦éœ€è¦è§’è‰²æƒé™ï¼Ÿ
// 2. æ˜¯å¦éœ€è¦ç»†ç²’åº¦æƒé™ï¼Ÿ
// 3. æ˜¯å¦æœ‰å…¬å¼€æ¥å£ï¼Ÿ
// 4. æ˜¯å¦æ”¯æŒAPI Keyè®¿é—®ï¼Ÿ
```

#### **Step 2: å¯¼å…¥Authè£…é¥°å™¨**
```typescript
// åœ¨æ–°æ¨¡å—ä¸­å¯¼å…¥Authæ¨¡å—çš„è£…é¥°å™¨
import { Auth } from '@auth/decorators/auth.decorator';
import { Public } from '@auth/decorators/public.decorator';
import { RequirePermissions } from '@auth/decorators/permissions.decorator';
import { UserRole, Permission } from '@auth/enums/user-role.enum';
```

#### **Step 3: åº”ç”¨æƒé™æ§åˆ¶**
```typescript
@Controller('new-module')
export class NewModuleController {
  
  // æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„æƒé™æ§åˆ¶æ–¹å¼
  @Auth([UserRole.ADMIN])                    // è§’è‰²æƒé™
  @RequirePermissions(Permission.DATA_READ)  // ç»†ç²’åº¦æƒé™
  @Public()                                 // å…¬å¼€æ¥å£
  
  // ç»„åˆä½¿ç”¨æƒé™è£…é¥°å™¨
  methodName() {}
}
```

#### **Step 4: éªŒè¯æƒé™é…ç½®**
```typescript
// ä½¿ç”¨æƒé™éªŒè¯å·¥å…·æ£€æŸ¥é…ç½®æ­£ç¡®æ€§
const validator = new PermissionDecoratorValidator();
const results = await validator.validateAllControllers();
```

### ä»£ç å®¡æŸ¥æ¸…å•

**æƒé™æ§åˆ¶æ£€æŸ¥é¡¹**ï¼š
- [ ] æ˜¯å¦æ­£ç¡®ä½¿ç”¨Authæ¨¡å—çš„è£…é¥°å™¨ï¼Ÿ
- [ ] æ˜¯å¦é¿å…åœ¨ä¸šåŠ¡æ¨¡å—ä¸­é›†æˆPermissionModuleï¼Ÿ
- [ ] æƒé™çº§åˆ«æ˜¯å¦åˆé€‚ï¼Ÿï¼ˆä¸è¦è¿‡åº¦æˆæƒï¼‰
- [ ] æ˜¯å¦æœ‰æœªä¿æŠ¤çš„æ•æ„Ÿæ¥å£ï¼Ÿ
- [ ] API Keyæƒé™æ˜¯å¦æ­£ç¡®é…ç½®ï¼Ÿ
- [ ] æƒé™ç»„åˆæ˜¯å¦åˆç†ï¼Ÿ

**æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥é¡¹**ï¼š
- [ ] æ˜¯å¦åˆ©ç”¨äº†æƒé™ç¼“å­˜æœºåˆ¶ï¼Ÿ
- [ ] æ˜¯å¦é¿å…äº†é‡å¤çš„æƒé™æ£€æŸ¥ï¼Ÿ
- [ ] æƒé™æ£€æŸ¥æ˜¯å¦åœ¨åˆé€‚çš„å±‚çº§è¿›è¡Œï¼Ÿ

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### **é—®é¢˜1: æƒé™è£…é¥°å™¨ä¸ç”Ÿæ•ˆ**
```typescript
// âŒ é”™è¯¯ï¼šè£…é¥°å™¨é¡ºåºä¸æ­£ç¡®
@RequirePermissions(Permission.DATA_READ)
@Auth([UserRole.ADMIN])
@Get('data')

// âœ… æ­£ç¡®ï¼šAuthè£…é¥°å™¨åœ¨å‰
@Auth([UserRole.ADMIN])
@RequirePermissions(Permission.DATA_READ)
@Get('data')
```

#### **é—®é¢˜2: API Keyæƒé™éªŒè¯å¤±è´¥**
```typescript
// âŒ é”™è¯¯ï¼šAPI Keyä¸æ”¯æŒè§’è‰²éªŒè¯
@Auth([UserRole.ADMIN])  // API Keyæ²¡æœ‰è§’è‰²æ¦‚å¿µ
@RequirePermissions(Permission.DATA_READ)
@Get('api-data')

// âœ… æ­£ç¡®ï¼šAPI Keyåªä½¿ç”¨æƒé™éªŒè¯
@RequirePermissions(Permission.DATA_READ)
@Get('api-data')
```

#### **é—®é¢˜3: æƒé™ç¼“å­˜ä¸æ›´æ–°**
```typescript
// è§£å†³æ–¹æ¡ˆï¼šæ¸…é™¤ç‰¹å®šç”¨æˆ·çš„æƒé™ç¼“å­˜
await this.permissionService.invalidateCacheFor(userId);

// æˆ–è€…æ¸…é™¤æ‰€æœ‰æƒé™ç¼“å­˜
await this.cacheService.del('permission:*');
```

#### **é—®é¢˜4: æƒé™æ£€æŸ¥æ€§èƒ½é—®é¢˜**
```typescript
// ä¼˜åŒ–æ–¹æ¡ˆï¼šä½¿ç”¨æƒé™ç¼“å­˜
const cacheKey = `permission:${userId}:${endpoint}`;
const cachedResult = await this.cacheService.get(cacheKey);
if (cachedResult) {
  return cachedResult;
}
// æ‰§è¡Œæƒé™æ£€æŸ¥å¹¶ç¼“å­˜ç»“æœ
```

---

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### æƒé™ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡

#### **å…³é”®æŒ‡æ ‡**
- **æƒé™æ£€æŸ¥å»¶è¿Ÿ**: P95 < 50ms, P99 < 100ms
- **ç¼“å­˜å‘½ä¸­ç‡**: > 90%
- **æƒé™æ£€æŸ¥QPS**: > 1000 requests/second
- **å†…å­˜ä½¿ç”¨**: æƒé™ç¼“å­˜ < 100MB

#### **ç›‘æ§æ–¹æ³•**
```typescript
// åœ¨æƒé™æœåŠ¡ä¸­æ·»åŠ æ€§èƒ½ç›‘æ§
@Injectable()
export class PermissionService {
  async checkPermissions(authSubject, permissions, roles) {
    const startTime = Date.now();
    
    try {
      const result = await this.performPermissionCheck(authSubject, permissions, roles);
      
      // è®°å½•æ€§èƒ½æŒ‡æ ‡
      const duration = Date.now() - startTime;
      this.metricsService.recordPermissionCheckDuration(duration);
      
      return result;
    } catch (error) {
      this.metricsService.recordPermissionCheckError();
      throw error;
    }
  }
}
```

---

## ğŸ”® æœªæ¥æ‰©å±•

### æƒé™ç³»ç»Ÿæ¼”è¿›æ–¹å‘

#### **çŸ­æœŸä¼˜åŒ– (1-3ä¸ªæœˆ)**
- æƒé™æ£€æŸ¥æ€§èƒ½ä¼˜åŒ–
- æƒé™ç¼“å­˜ç­–ç•¥ç»†åŒ–
- æƒé™å®¡è®¡æ—¥å¿—å¢å¼º

#### **ä¸­æœŸæ‰©å±• (3-6ä¸ªæœˆ)**
- åŠ¨æ€æƒé™åˆ†é…
- æƒé™å§”æ‰˜æœºåˆ¶
- ç»†ç²’åº¦èµ„æºæƒé™

#### **é•¿æœŸè§„åˆ’ (6-12ä¸ªæœˆ)**
- åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ (ABAC)
- æƒé™ç­–ç•¥å¼•æ“
- å¤šç§Ÿæˆ·æƒé™éš”ç¦»

### æŠ€æœ¯å€ºåŠ¡ç®¡ç†

#### **å½“å‰æŠ€æœ¯å€ºåŠ¡**
- âœ… **æ— é‡å¤§æŠ€æœ¯å€ºåŠ¡**: å½“å‰æ¶æ„è®¾è®¡åˆç†
- âœ… **æƒé™é€»è¾‘æ¸…æ™°**: å•ä¸€æƒé™ä¸­å¿ƒæ¶æ„ç®€å•é«˜æ•ˆ
- âœ… **ç»„ä»¶å¤ç”¨è‰¯å¥½**: Authæ¨¡å—æƒé™è£…é¥°å™¨è¢«è‰¯å¥½å¤ç”¨

#### **æŒç»­æ”¹è¿›è®¡åˆ’**
- å®šæœŸæƒé™åˆè§„æ€§æ£€æŸ¥
- æƒé™ä½¿ç”¨æ¨¡å¼åˆ†æ
- æ€§èƒ½åŸºå‡†æµ‹è¯•æ›´æ–°

---

## ğŸ“ æ”¯æŒä¸ç»´æŠ¤

### æŠ€æœ¯æ”¯æŒ

**æƒé™ç³»ç»Ÿç›¸å…³é—®é¢˜**:
- è®¤è¯æˆæƒé—®é¢˜: è”ç³»Authæ¨¡å—ç»´æŠ¤å›¢é˜Ÿ
- æƒé™é…ç½®é—®é¢˜: å‚è€ƒæœ¬æ–‡æ¡£æˆ–æäº¤Issue
- æ€§èƒ½é—®é¢˜: æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡æˆ–è”ç³»åŸºç¡€è®¾æ–½å›¢é˜Ÿ

### æ–‡æ¡£ç»´æŠ¤

**æ›´æ–°é¢‘ç‡**: æ¯å­£åº¦æ›´æ–°  
**ç‰ˆæœ¬ç®¡ç†**: éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶  
**å˜æ›´è®°å½•**: è¯¦è§æ–‡æ¡£æœ«å°¾å˜æ›´æ—¥å¿—  

---

## ğŸ“ å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | è´Ÿè´£äºº |
|------|------|----------|--------|
| v1.0 | 2025-01-17 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´æƒé™æ¶æ„è¯´æ˜ | åç«¯å›¢é˜Ÿ |

---

**æ–‡æ¡£çŠ¶æ€**: âœ… æ´»è·ƒç»´æŠ¤  
**ä¸‹æ¬¡å®¡æ ¸**: 2025å¹´4æœˆ17æ—¥  
**ç»´æŠ¤å‘¨æœŸ**: å­£åº¦æ›´æ–°  

---

*æœ¬æ–‡æ¡£ä¸ºæƒé™ç³»ç»Ÿæ¶æ„çš„æƒå¨æŒ‡å—ï¼Œä¸ºé¡¹ç›®ä¸­æ‰€æœ‰æƒé™ç›¸å…³å¼€å‘æä¾›æ ‡å‡†è§„èŒƒã€‚*