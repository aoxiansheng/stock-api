# 项目架构组织说明

## 概述

为了提高代码的可读性和可维护性，我们对 [AppModule](file:///Users/honor/Documents/code/newstockapi/backend/src/app.module.ts#L37-L131) 的模块导入进行了重新组织，按照功能层次和职责进行了清晰的分层。

## 架构分层

### 1. 基础设施层 (Infrastructure Layer)

负责提供应用运行所需的基础服务：

- 统一配置管理 ([AppConfigModule](file:///Users/honor/Documents/code/newstockapi/backend/src/app/config/config.module.ts#L18-L39))
- 数据库连接管理 ([DatabaseModule](file:///Users/honor/Documents/code/newstockapi/backend/src/database/database.module.ts#L15-L44))
- 缓存服务 (RedisModule)
- 消息队列 (BullModule)
- 事件系统 (EventEmitterModule)

### 2. 应用服务层 (Application Services Layer)

提供应用级服务和管理功能：

- 应用核心服务 ([AppCoreModule](file:///Users/honor/Documents/code/newstockapi/backend/src/app/modules/app-core.module.ts#L19-L37))
- 全局基础设施服务 ([GlobalServicesModule](file:///Users/honor/Documents/code/newstockapi/backend/src/app/modules/global-services.module.ts#L22-L32))
- 启动和关闭管理 ([StartupModule](file:///Users/honor/Documents/code/newstockapi/backend/src/app/startup/startup.module.ts#L24-L34))
- 通用工具模块 (PaginationModule)

### 3. 核心业务层 (Core Business Layer)

按照六组件核心架构组织，按数据处理流程排列：

#### 3.1 准备阶段 (Prepare)
- 符号映射器 ([SymbolMapperModule](file:///Users/honor/Documents/code/newstockapi/backend/src/core/00-prepare/symbol-mapper/module/symbol-mapper.module.ts#L22-L49))
- 数据映射器 ([DataMapperModule](file:///Users/honor/Documents/code/newstockapi/backend/src/core/00-prepare/data-mapper/module/data-mapper.module.ts#L18-L43))

#### 3.2 入口阶段 (Entry)
- 数据接收器 ([ReceiverModule](file:///Users/honor/Documents/code/newstockapi/backend/src/core/01-entry/receiver/module/receiver.module.ts#L17-L30))
- 流数据接收器 ([StreamReceiverModule](file:///Users/honor/Documents/code/newstockapi/backend/src/core/01-entry/stream-receiver/module/stream-receiver.module.ts#L18-L35))
- 查询接口 ([QueryModule](file:///Users/honor/Documents/code/newstockapi/backend/src/core/01-entry/query/module/query.module.ts#L17-L31))

#### 3.3 处理阶段 (Processing)
- 数据转换器 ([TransformerModule](file:///Users/honor/Documents/code/newstockapi/backend/src/core/02-processing/transformer/module/data-transformer.module.ts#L15-L30))

#### 3.4 存储阶段 (Storage)
- 数据存储器 ([StorageModule](file:///Users/honor/Documents/code/newstockapi/backend/src/core/04-storage/storage/module/storage.module.ts#L18-L39))

#### 3.5 缓存阶段 (Caching)
- 智能缓存编排器 ([SmartCacheModule](file:///Users/honor/Documents/code/newstockapi/backend/src/core/05-caching/smart-cache/module/smart-cache.module.ts#L30-L44))

### 4. 领域模块 (Domain Modules)

提供特定业务领域的功能：

- 认证和授权 ([AuthModule](file:///Users/honor/Documents/code/newstockapi/backend/src/auth/module/auth.module.ts#L32-L85))
- 系统监控 ([MonitoringModule](file:///Users/honor/Documents/code/newstockapi/backend/src/monitoring/monitoring.module.ts#L32-L47))
- 告警管理 ([AlertEnhancedModule](file:///Users/honor/Documents/code/newstockapi/backend/src/alert/module/alert-enhanced.module.ts#L24-L41))
- 数据提供商 ([ProvidersModule](file:///Users/honor/Documents/code/newstockapi/backend/src/providers/module/providers-sg.module.ts#L24-L31))
- 权限验证 ([PermissionValidationModule](file:///Users/honor/Documents/code/newstockapi/backend/src/common/modules/permission/modules/permission-validation.module.ts#L16-L27))

### 5. 安全防护层 (Security Layer)

提供应用安全防护机制：

- 速率限制 ([ThrottlerModule](file:///Users/honor/Documents/code/newstockapi/backend/node_modules/@nestjs/throttler/dist/throttler.module.d.ts#L5-L17))
- JWT认证守卫 ([JwtAuthGuard](file:///Users/honor/Documents/code/newstockapi/backend/src/auth/guards/jwt-auth.guard.ts#L13-L35))
- API密钥认证守卫 ([ApiKeyAuthGuard](file:///Users/honor/Documents/code/newstockapi/backend/src/auth/guards/apikey-auth.guard.ts#L17-L33))
- 统一权限守卫 ([UnifiedPermissionsGuard](file:///Users/honor/Documents/code/newstockapi/backend/src/auth/guards/unified-permissions.guard.ts#L21-L62))
- 速率限制守卫 ([RateLimitGuard](file:///Users/honor/Documents/code/newstockapi/backend/src/auth/guards/rate-limit.guard.ts#L14-L44))

## 导入顺序原则

模块按照以下顺序导入：

1. 基础设施层
2. 应用服务层
3. 核心业务层（按处理流程）
4. 领域模块
5. 安全防护层

## 守卫执行顺序

安全守卫按照以下顺序执行：

1. [ThrottlerGuard](file:///Users/honor/Documents/code/newstockapi/backend/node_modules/@nestjs/throttler/dist/throttler.guard.d.ts#L5-L28) - 速率限制
2. [ApiKeyAuthGuard](file:///Users/honor/Documents/code/newstockapi/backend/src/auth/guards/apikey-auth.guard.ts#L17-L33) - API密钥认证
3. [JwtAuthGuard](file:///Users/honor/Documents/code/newstockapi/backend/src/auth/guards/jwt-auth.guard.ts#L13-L35) - JWT认证
4. [RateLimitGuard](file:///Users/honor/Documents/code/newstockapi/backend/src/auth/guards/rate-limit.guard.ts#L14-L44) - API密钥速率限制
5. [UnifiedPermissionsGuard](file:///Users/honor/Documents/code/newstockapi/backend/src/auth/guards/unified-permissions.guard.ts#L21-L62) - 权限检查

这种组织方式确保了请求处理的安全性和正确性。