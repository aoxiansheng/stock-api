# 📊 监控组件整合重构方案

## 📋 文档信息
- **创建日期**: 2025-01-23
- **文档版本**: v1.6
- **负责人**: 系统架构团队
- **审核状态**: 已优化
- **预计工期**: 12个工作日
- **修订说明**: 保持原目录名，减少不必要的重命名

---

## 🎯 一、现状分析

### 1.1 当前监控组件分布

系统中存在三个分散的监控相关组件，位置分散且职责重叠：

#### 1. **system-status 组件** (`/src/system-status/`)
- **定位**: 应用层监控仪表板系统
- **架构**: Collector → Analyzer → Presenter (三层架构)
- **规模**: 4个子模块，20+个服务文件
- **功能**: 
  - 数据收集 (HTTP请求、数据库、系统指标)
  - 数据分析 (性能分析、健康评分、趋势分析)
  - 数据展示 (12个监控API端点)

#### 2. **common/core/monitoring 组件** (`/src/common/core/monitoring/`)
- **定位**: 底层监控基础设施
- **架构**: 装饰器 + 注册表 + 拦截器
- **规模**: 68个Prometheus自定义指标
- **功能**:
  - Prometheus指标注册 (InfrastructureMetricsRegistryService)
  - 性能监控装饰器 (DatabasePerformance等)
  - 性能拦截器 (PerformanceInterceptor)

#### 3. **performance-monitoring 装饰器** (`/src/common/core/decorators/performance-monitoring.decorator.ts`)
- **定位**: 控制器级性能监控开关
- **架构**: 元数据装饰器模式
- **功能**:
  - 性能监控启用/禁用控制
  - 采样率配置
  - 慢请求跟踪配置

### 1.2 存在的问题

#### 🔴 严重问题
1. **功能重复建设**
   - system-status和common/monitoring都在收集性能数据
   - 两套独立的数据库监控系统
   - 重复的健康检查实现

2. **架构职责混乱**
   - system-status既做基础监控又做应用监控
   - common/monitoring散落在common目录下，不易发现
   - 性能装饰器分散在不同位置

3. **维护成本高**
   - 修改监控逻辑需要改动多处
   - 新增监控指标不知道加在哪里
   - 缺乏统一的监控框架

#### 🟡 中等问题
- 监控配置分散，难以统一管理
- 指标命名不一致
- 缺少监控文档

#### 🟢 次要问题
- 部分代码重复
- 导入路径过长
- 测试覆盖不全

---

## 🎯 二、重构目标

### 2.1 核心目标
1. **建立统一的监控框架**: 所有监控功能集中在一个模块
2. **清晰的分层架构**: 基础设施→收集→分析→展示
3. **消除功能重复**: 一个功能只在一处实现
4. **提升可维护性**: 统一的代码组织和命名规范

### 2.2 预期收益
- **减少30%代码量**: 消除重复代码
- **提升50%开发效率**: 清晰的代码组织
- **降低60%维护成本**: 统一的监控框架

---

## 📐 三、目标架构设计

### 3.1 新的模块结构

```
src/monitoring/  (新的统一监控模块)
├── infrastructure/     # 基础设施层 (原 common/core/monitoring)
│   ├── metrics/
│   │   ├── infrastructure-metrics-registry.service.ts # Prometheus 注册表
│   │   ├── infrastructure-metrics.module.ts           # 指标模块
│   │   └── infrastructure-metrics.constants.ts        # 指标常量
│   ├── decorators/
│   │   ├── infrastructure-database-performance.decorator.ts
│   │   ├── infrastructure-auth-performance.decorator.ts
│   │   └── infrastructure-monitoring-config.decorator.ts # 原 performance-monitoring
│   ├── interceptors/
│   │   ├── infrastructure-performance.interceptor.ts  # 性能拦截器
│   │   └── infrastructure-metrics.interceptor.ts      # 指标收集拦截器
│   └── infrastructure.module.ts
│
├── collector/          # 数据收集层 (原 system-status/collector)
│   ├── services/
│   │   └── collector.service.ts           # 统一数据收集服务
│   ├── repositories/
│   │   └── collector.repository.ts        # 数据持久化
│   ├── interceptors/
│   │   └── collector.interceptor.ts       # 收集拦截器
│   └── collector.module.ts
│
├── analyzer/           # 数据分析层 (原 system-status/analyzer)
│   ├── services/
│   │   ├── analyzer.service.ts            # 分析协调器
│   │   ├── analyzer-health.service.ts     # 健康分析
│   │   └── analyzer-trend.service.ts      # 趋势分析
│   ├── calculators/
│   │   ├── analyzer-health-score.calculator.ts # 健康分数计算
│   │   └── analyzer-metrics.calculator.ts      # 指标计算
│   └── analyzer.module.ts
│
├── presenter/          # 展示层 (原 system-status/presenter)
│   ├── controllers/
│   │   └── presenter.controller.ts        # 展示层API
│   ├── services/
│   │   ├── presenter.service.ts           # 展示业务逻辑
│   │   └── presenter-error-handler.service.ts # 错误处理
│   ├── dto/
│   │   ├── presenter-query.dto.ts         # 查询DTO
│   │   └── presenter-response.dto.ts      # 响应DTO
│   └── presenter.module.ts
│
├── shared/            # 共享资源
│   ├── interfaces/
│   │   ├── monitoring-collector.interface.ts
│   │   ├── monitoring-analyzer.interface.ts
│   │   └── monitoring.interface.ts
│   ├── types/
│   │   └── monitoring.types.ts
│   ├── constants/
│   │   └── monitoring.constants.ts
│   └── utils/
│       └── monitoring.utils.ts
│
└── monitoring.module.ts  # 主模块

```

### 3.2 分层职责定义

#### 基础设施层 (Infrastructure)
- **职责**: 提供监控基础能力
- **组件**: 
  - Prometheus指标注册
  - 性能监控装饰器
  - 监控拦截器
- **不包含**: 业务逻辑、数据分析

#### 数据收集层 (Collection)
- **职责**: 收集原始监控数据
- **组件**:
  - HTTP请求监控
  - 数据库操作监控
  - 系统指标收集
- **不包含**: 数据分析、展示逻辑

#### 数据分析层 (Analysis)
- **职责**: 分析和计算监控指标
- **组件**:
  - 性能分析
  - 健康评分
  - 趋势分析
  - 优化建议
- **不包含**: 数据收集、API展示

#### 展示层 (Presentation)
- **职责**: 对外提供监控API
- **组件**:
  - RESTful API端点
  - 数据格式化
  - 权限控制
- **不包含**: 数据收集、分析逻辑

---

## 📅 四、实施计划

### 4.1 Phase 1: 目录结构重组 (第1天)

#### 任务清单
- [ ] 重命名现有的 system-status 目录
- [ ] 创建新的 monitoring 目录结构
- [ ] 建立完整的子目录体系

#### 具体步骤
```bash
# 1. 备份并重命名现有目录
mv src/system-status src/system-status-backup
mv src/common/core/monitoring src/common/core/monitoring-backup

# 2. 创建新的监控目录结构
mkdir -p src/monitoring/{infrastructure,collector,analyzer,presenter,shared}

# 3. 创建基础设施层子目录
mkdir -p src/monitoring/infrastructure/{metrics,decorators,interceptors}

# 4. 创建收集层子目录
mkdir -p src/monitoring/collector/{services,repositories,interceptors}

# 5. 创建分析层子目录
mkdir -p src/monitoring/analyzer/{services,calculators}

# 6. 创建展示层子目录
mkdir -p src/monitoring/presenter/{controllers,services,dto}

# 7. 创建共享资源子目录
mkdir -p src/monitoring/shared/{interfaces,types,constants,utils}
```

#### 验收标准
- 新目录结构创建完成
- 原有目录已备份重命名
- 目录层次结构正确

### 4.2 Phase 2: 代码文件迁移 (第2天)

#### 任务清单
- [ ] 迁移 common/core/monitoring 下的文件到 infrastructure 层
- [ ] 迁移 system-status/collector 下的文件到 collection 层  
- [ ] 迁移 system-status/analyzer 下的文件到 analysis 层
- [ ] 迁移 system-status/presenter 下的文件到 presentation 层
- [ ] 迁移共享接口和类型定义

#### 代码迁移路径映射
```bash
# Infrastructure 层迁移
cp src/common/core/monitoring-backup/infrastructure/metrics-registry.service.ts \
   src/monitoring/infrastructure/metrics/

cp src/common/core/monitoring-backup/decorators/database-performance.decorator.ts \
   src/monitoring/infrastructure/decorators/

cp src/common/core/decorators/performance-monitoring.decorator.ts \
   src/monitoring/infrastructure/decorators/

# Collector 层迁移
cp src/system-status-backup/collector/services/* \
   src/monitoring/collector/services/

cp src/system-status-backup/collector/repositories/* \
   src/monitoring/collector/repositories/

# Analyzer 层迁移
cp src/system-status-backup/analyzer/services/* \
   src/monitoring/analyzer/services/

cp src/system-status-backup/analyzer/calculators/* \
   src/monitoring/analyzer/calculators/

# Presenter 层迁移
cp src/system-status-backup/presenter/controllers/* \
   src/monitoring/presenter/controllers/

cp src/system-status-backup/presenter/services/* \
   src/monitoring/presenter/services/

cp src/system-status-backup/presenter/dto/* \
   src/monitoring/presenter/dto/
```

#### 验收标准
- 所有原有代码文件已复制到新目录
- 文件完整性检查通过
- 无文件丢失或损坏

### 4.3 Phase 3: 文件和类名重命名 (第3天)

#### 任务清单
- [ ] 按照命名规范重命名所有文件
- [ ] 更新文件内的类名和导出名
- [ ] 批量更新类名引用
- [ ] 验证文件名与类名一致性

#### 文件重命名脚本
```bash
#!/bin/bash
# 文件重命名脚本 - rename-files.sh

# Infrastructure 层重命名
cd src/monitoring/infrastructure/
mv metrics/metrics-registry.service.ts metrics/infrastructure-metrics-registry.service.ts
mv decorators/database-performance.decorator.ts decorators/infrastructure-database-performance.decorator.ts
mv decorators/performance-monitoring.decorator.ts decorators/infrastructure-monitoring-config.decorator.ts

# Collector 层重命名 (保持原名)
cd ../collector/services/
# collector.service.ts 保持不变
cd ../repositories/
# collector.repository.ts 保持不变

# Analyzer 层重命名 (保持原名)
cd ../../analyzer/services/
# analyzer.service.ts 保持不变
mv health-analyzer.service.ts analyzer-health.service.ts
mv trend-analyzer.service.ts analyzer-trend.service.ts
cd ../calculators/
mv health-score.calculator.ts analyzer-health-score.calculator.ts
mv metrics.calculator.ts analyzer-metrics.calculator.ts

# Presenter 层重命名 (保持原名)
cd ../../presenter/controllers/
mv monitoring.controller.ts presenter.controller.ts
cd ../services/
mv monitoring.service.ts presenter.service.ts
mv error-handler.service.ts presenter-error-handler.service.ts
cd ../dto/
mv monitoring-query.dto.ts presenter-query.dto.ts
mv monitoring-response.dto.ts presenter-response.dto.ts
```

#### 类名重命名脚本
```bash
#!/bin/bash
# 类名重命名脚本 - rename-classes.sh

# 使用 sed 批量替换类名
find src/monitoring -name "*.ts" -exec sed -i 's/class InfrastructureMetricsRegistryService/class InfrastructureMetricsRegistryService/g' {} \;
find src/monitoring -name "*.ts" -exec sed -i 's/class MonitoringController/class PresenterController/g' {} \;
find src/monitoring -name "*.ts" -exec sed -i 's/class MonitoringService/class PresenterService/g' {} \;

# 更新导出语句
find src/monitoring -name "*.ts" -exec sed -i 's/export class InfrastructureMetricsRegistryService/export class InfrastructureMetricsRegistryService/g' {} \;
find src/monitoring -name "*.ts" -exec sed -i 's/export class MonitoringController/export class PresenterController/g' {} \;
find src/monitoring -name "*.ts" -exec sed -i 's/export class MonitoringService/export class PresenterService/g' {} \;
```

#### 验收标准
- 所有文件已按规范重命名
- 类名与文件名完全一致
- 导出语句正确更新
- TypeScript 编译无错误

### 4.4 Phase 4: 创建缺失文件 (第4天)

#### 任务清单
- [ ] 分析现有文件与目标架构的差异
- [ ] 创建缺失的服务文件
- [ ] 创建缺失的接口文件
- [ ] 创建缺失的模块配置文件
- [ ] 创建基础的测试文件框架

#### 缺失文件创建脚本
```bash
#!/bin/bash
# 创建缺失文件脚本 - create-missing-files.sh

# 1. 创建模块配置文件
touch src/monitoring/monitoring.module.ts
touch src/monitoring/infrastructure/infrastructure.module.ts
touch src/monitoring/collector/collector.module.ts
touch src/monitoring/analyzer/analyzer.module.ts
touch src/monitoring/presenter/presenter.module.ts

# 2. 创建缺失的拦截器文件
touch src/monitoring/infrastructure/interceptors/infrastructure-performance.interceptor.ts
touch src/monitoring/infrastructure/interceptors/infrastructure-metrics.interceptor.ts
touch src/monitoring/collector/interceptors/collector.interceptor.ts

# 3. 创建共享资源文件
touch src/monitoring/shared/interfaces/monitoring-collector.interface.ts
touch src/monitoring/shared/interfaces/monitoring-analyzer.interface.ts
touch src/monitoring/shared/interfaces/monitoring.interface.ts
touch src/monitoring/shared/types/monitoring.types.ts
touch src/monitoring/shared/constants/monitoring.constants.ts
touch src/monitoring/shared/utils/monitoring.utils.ts

# 4. 创建常量和配置文件
touch src/monitoring/infrastructure/metrics/infrastructure-metrics.constants.ts
touch src/monitoring/infrastructure/metrics/infrastructure-metrics.module.ts

# 5. 为每个主要服务创建基础测试文件
touch src/monitoring/infrastructure/metrics/__tests__/infrastructure-metrics-registry.service.spec.ts
touch src/monitoring/collector/services/__tests__/collector.service.spec.ts
touch src/monitoring/analyzer/services/__tests__/analyzer.service.spec.ts
touch src/monitoring/presenter/controllers/__tests__/presenter.controller.spec.ts
```

#### 文件模板创建
```typescript
// 模板: monitoring.module.ts
import { Module } from '@nestjs/common';
import { InfrastructureModule } from './infrastructure/infrastructure.module';
import { CollectorModule } from './collector/collector.module';
import { AnalyzerModule } from './analyzer/analyzer.module';
import { PresenterModule } from './presenter/presenter.module';

@Module({
  imports: [
    InfrastructureModule,
    CollectorModule,
    AnalyzerModule,
    PresenterModule,
  ],
  exports: [
    InfrastructureModule,
    CollectorModule,
    AnalyzerModule,
    PresenterModule,
  ],
})
export class MonitoringModule {}
```

#### 验收标准
- 所有必需文件已创建
- 文件结构完整无缺失
- 基础模板代码正确
- TypeScript 编译通过

### 4.5 Phase 5: 代码重构和整合 (第5-7天)

#### 任务清单
- [ ] 重构 Collection Service 内部逻辑
- [ ] 整合重复的数据收集逻辑
- [ ] 对接 Infrastructure Metrics Registry Service
- [ ] 消除重复指标定义
- [ ] 更新所有依赖注入关系
- [ ] 重构 Analysis Service 及相关服务
- [ ] 优化分析算法和计算性能

#### 重构要点
```typescript
// 重构前：独立的收集逻辑
class CollectorService {
  private readonly metricsBuffer: RawMetric[] = [];
  recordRequest() { /* 独立实现 */ }
}

// 重构后：使用统一的指标注册
// 文件: src/monitoring/collector/services/collector.service.ts
export class CollectorService {
  constructor(
    private readonly InfrastructureMetricsRegistryService: InfrastructureMetricsRegistryService
  ) {}
  
  recordRequest() {
    // 使用 Prometheus 指标
    this.InfrastructureMetricsRegistryService.receiverRequestsTotal.inc();
  }
}
```

#### 依赖注入重构
```typescript
// 各层模块的依赖关系
// Collector Module 依赖 Infrastructure Module
@Module({
  imports: [InfrastructureModule],
  providers: [CollectorService, CollectorRepository],
  exports: [CollectorService],
})
export class CollectorModule {}

// Analyzer Module 依赖 Collector Module
@Module({
  imports: [CollectorModule],
  providers: [AnalyzerService, AnalyzerHealthService],
  exports: [AnalyzerService],
})
export class AnalyzerModule {}
```

#### 验收标准
- 数据收集功能正常
- 分析功能正常运行
- 消除所有重复代码
- 性能提升20%
- 依赖注入关系正确
- 单元测试覆盖率>80%

### 4.6 Phase 6: 展示层整合和API设计 (第8-9天)

#### 任务清单
- [ ] 设计统一的 API 端点
- [ ] 统一响应格式
- [ ] 重构 Presentation Service 业务逻辑
- [ ] 创建 DTO 类和验证规则
- [ ] 更新 Swagger 文档

#### API 设计策略
```typescript
// 文件: src/monitoring/presenter/controllers/presenter.controller.ts
@Controller('monitoring')
export class PresenterController {
  constructor(
    private readonly presenterService: PresenterService,
    private readonly presenterErrorHandlerService: PresenterErrorHandlerService
  ) {}

  @Get('metrics')
  @ApiOperation({ summary: '获取系统指标' })
  async getMetrics(@Query() query: PresenterQueryDto): Promise<PresenterResponseDto> { 
    try {
      const metrics = await this.presenterService.getMetrics(query);
      return new PresenterResponseDto(metrics);
    } catch (error) {
      this.presenterErrorHandlerService.handleError(error);
      throw error;
    }
  }
  
  @Get('health')
  @ApiOperation({ summary: '获取健康状态' })
  async getHealthStatus(): Promise<PresenterResponseDto> { 
    return this.presenterService.getHealthStatus();
  }
  
  @Get('performance')  
  @ApiOperation({ summary: '获取性能指标' })
  async getPerformanceMetrics(@Query() query: PresenterQueryDto): Promise<PresenterResponseDto> { 
    return this.presenterService.getPerformanceMetrics(query);
  }
}
```

#### DTO 设计
```typescript
// 文件: src/monitoring/presenter/dto/presenter-query.dto.ts
export class PresenterQueryDto {
  @IsOptional()
  @IsString()
  startTime?: string;

  @IsOptional()
  @IsString()
  endTime?: string;

  @IsOptional()
  @IsNumber()
  limit?: number;
}

// 文件: src/monitoring/presenter/dto/presenter-response.dto.ts
export class PresenterResponseDto {
  statusCode: number;
  message: string;
  data: any;
  timestamp: string;

  constructor(data: any) {
    this.statusCode = 200;
    this.message = '获取成功';
    this.data = data;
    this.timestamp = new Date().toISOString();
  }
}
```

#### 验收标准
- 所有API正常工作
- API设计符合RESTful规范
- DTO 验证规则正确
- 错误处理机制完善
- Swagger文档更新完成

### 4.7 Phase 7: 导入路径更新和清理 (第10天)

#### 任务清单
- [ ] 更新项目中所有对旧路径的引用
- [ ] 批量替换导入语句
- [ ] 更新测试文件中的导入路径
- [ ] 清理已备份的旧目录
- [ ] 验证所有导入路径正确性

#### 导入路径更新脚本
```bash
#!/bin/bash
# 导入路径更新脚本 - update-import-paths.sh

# 1. 更新对旧监控组件的导入
find src -name "*.ts" -not -path "*/monitoring/*" -not -path "*-backup/*" \
  -exec sed -i 's|from.*system-status/collector|from "@monitoring/collector"|g' {} \;

find src -name "*.ts" -not -path "*/monitoring/*" -not -path "*-backup/*" \
  -exec sed -i 's|from.*system-status/analyzer|from "@monitoring/analyzer"|g' {} \;

find src -name "*.ts" -not -path "*/monitoring/*" -not -path "*-backup/*" \
  -exec sed -i 's|from.*system-status/presenter|from "@monitoring/presenter"|g' {} \;

find src -name "*.ts" -not -path "*/monitoring/*" -not -path "*-backup/*" \
  -exec sed -i 's|from.*common/core/monitoring|from "@monitoring/infrastructure"|g' {} \;

# 2. 更新测试文件中的导入路径
find test -name "*.ts" \
  -exec sed -i 's|from.*system-status|from "@monitoring"|g' {} \;

find test -name "*.ts" \
  -exec sed -i 's|from.*common/core/monitoring|from "@monitoring/infrastructure"|g' {} \;

# 3. 更新类名引用 (保持原有类名)
find src -name "*.ts" -not -path "*-backup/*" \
  -exec sed -i 's/InfrastructureMetricsRegistryService/InfrastructureMetricsRegistryService/g' {} \;

find src -name "*.ts" -not -path "*-backup/*" \
  -exec sed -i 's/MonitoringController/PresenterController/g' {} \;

find src -name "*.ts" -not -path "*-backup/*" \
  -exec sed -i 's/MonitoringService/PresenterService/g' {} \;
```

#### 清理旧文件
```bash
#!/bin/bash
# 清理脚本 - cleanup-old-files.sh

# 确认新架构工作正常后执行清理
echo "⚠️  执行前请确认新监控架构已通过所有测试"
read -p "继续清理旧文件? (y/N): " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
  # 删除备份的旧目录
  rm -rf src/system-status-backup
  rm -rf src/common/core/monitoring-backup
  
  # 删除可能残留的旧导入
  echo "清理完成"
else
  echo "清理已取消"
fi
```

#### 验收标准
- 所有导入路径更新正确
- TypeScript 编译无错误
- 所有测试正常运行
- 旧文件已安全清理

### 4.8 Phase 8: 综合测试和优化 (第11-12天)

#### 任务清单
- [ ] 完整的单元测试
- [ ] 完整的集成测试
- [ ] 端到端测试
- [ ] 性能基准测试
- [ ] 压力测试
- [ ] 安全扫描
- [ ] 代码质量审查
- [ ] 文档更新和完善

#### 测试策略
```bash
# 1. 单元测试
npm run test:unit:monitoring
# 预期覆盖率 > 85%

# 2. 集成测试
npm run test:integration:monitoring  
# 测试各层之间的集成

# 3. E2E 测试
npm run test:e2e:monitoring
# 测试完整的监控流程

# 4. 性能测试
npm run test:performance:monitoring
# 验证性能提升目标
```

#### 质量门禁
- 单元测试覆盖率 > 85%
- 集成测试覆盖率 > 70%
- 代码复杂度 < 10
- 重复代码率 < 5%
- TypeScript 编译 0 错误
- ESLint 检查 0 警告

#### 性能基准验证
- API 响应时间 < 100ms (P95)
- 内存占用减少 > 20%
- CPU 使用率减少 > 15%
- 代码量减少 > 30%

#### 验收标准
- 所有测试通过
- 性能基准达标
- 代码质量符合标准
- 文档完整准确
- 功能完全兼容

---

## 🚀 五、实施策略

### 5.1 风险控制

#### 实施策略
1. **阶段1**: 创建新的监控模块架构
2. **阶段2**: 迁移现有功能到新架构
3. **阶段3**: 清理旧代码和文件

### 5.2 监控重构过程

#### 关键指标
- API响应时间
- 错误率
- 内存使用
- CPU使用率

#### 告警设置
- 错误率 > 1% 触发告警
- 响应时间 > 200ms 触发告警
- 内存增长 > 10% 触发告警

---

## 📊 六、验收标准

### 6.1 功能验收

| 功能模块 | 验收标准 | 优先级 |
|---------|---------|--------|
| Prometheus指标 | 68个指标全部正常工作 | P0 |
| 监控API | 新API端点全部可用 | P0 |
| 性能装饰器 | 装饰器正常工作 | P1 |
| 数据收集 | 数据类型正常收集 | P0 |
| 数据分析 | 健康评分误差<5% | P1 |

### 6.2 性能验收

| 指标 | 当前值 | 目标值 | 验收标准 |
|-----|--------|--------|---------|
| API响应时间(P95) | 150ms | 100ms | <120ms |
| 内存占用 | 200MB | 150MB | <180MB |
| CPU使用率 | 15% | 10% | <12% |
| 代码行数 | 5000 | 3500 | <4000 |

### 6.3 质量验收

| 质量指标 | 目标值 | 验收标准 |
|---------|--------|---------|
| 单元测试覆盖率 | 90% | >85% |
| 集成测试覆盖率 | 80% | >70% |
| 代码复杂度 | <10 | <15 |
| 重复代码率 | <5% | <10% |
| 文档完整度 | 100% | >90% |

---

## 🔧 七、技术细节

### 7.1 文件名与类名一致性规范

#### 命名规范
```typescript
// 1. Infrastructure 层
// 文件: infrastructure-metrics-registry.service.ts
export class InfrastructureMetricsRegistryService { }

// 文件: infrastructure-database-performance.decorator.ts  
export const InfrastructureDatabasePerformance = createDecorator();

// 文件: infrastructure-performance.interceptor.ts
export class InfrastructurePerformanceInterceptor { }

// 2. Collection 层
// 文件: collection.service.ts
export class CollectionService { }

// 文件: collection.repository.ts
export class CollectionRepository { }

// 3. Analysis 层
// 文件: analysis.service.ts
export class AnalysisService { }

// 文件: analysis-health-score.calculator.ts
export class AnalysisHealthScoreCalculator { }

// 4. Presentation 层
// 文件: presentation.controller.ts
export class PresentationController { }

// 文件: presentation-query.dto.ts
export class PresentationQueryDto { }
```

### 7.2 依赖注入优化

```typescript
// 重构前：多个独立的服务
@Module({
  providers: [
    CollectorService,
    AnalyzerService,
    PresenterService,
    InfrastructureMetricsRegistryService,
    // ... 分散的服务
  ]
})

// 重构后：模块化的服务组织
@Module({
  imports: [
    InfrastructureModule,  // 基础设施服务
    CollectionModule,      // 数据收集服务
    AnalysisModule,        // 数据分析服务
    PresentationModule     // 展示服务
  ]
})
export class MonitoringModule {}
```

### 7.3 性能优化策略

#### 批处理优化
```typescript
// 文件: src/monitoring/infrastructure/metrics/infrastructure-metrics-registry.service.ts
export class InfrastructureMetricsRegistryService {
  private batch: MetricUpdate[] = [];
  private batchTimer: NodeJS.Timer;
  
  recordMetric(metric: MetricUpdate) {
    this.batch.push(metric);
    
    if (this.batch.length >= 100) {
      this.flush();
    }
  }
  
  private flush() {
    // 批量更新 Prometheus 指标
    this.registry.batchUpdate(this.batch);
    this.batch = [];
  }
}
```

### 7.4 错误处理标准化

```typescript
// 文件: src/monitoring/presentation/services/presentation-error-handler.service.ts
export class PresentationErrorHandlerService {
  handleError(error: MonitoringError) {
    // 处理监控相关错误
  }
}

// 文件: src/monitoring/shared/types/monitoring.types.ts
export class MonitoringError extends Error {
  constructor(
    public readonly code: string,
    public readonly component: string,
    message: string,
    public readonly details?: any
  ) {
    super(message);
  }
}

// 使用示例
throw new MonitoringError(
  'METRICS_REGISTRY_ERROR',
  'infrastructure',
  'Failed to register metric',
  { metricName, error: originalError }
);
```

---

## 📝 八、相关文档

### 需要更新的文档
1. API文档 (Swagger)
2. 架构设计文档
3. 部署文档
4. 运维手册
5. 开发指南

### 新增文档
1. 监控组件使用指南
2. 迁移指南
3. 性能调优指南
4. 故障排查手册

---

## ✅ 九、成功标准

### 短期成功（1个月内）
- ✅ 所有监控功能正常工作
- ✅ 性能达到预期目标
- ✅ 代码量减少30%

### 中期成功（3个月内）
- ✅ 开发效率提升50%
- ✅ 新功能开发时间减少40%
- ✅ 故障处理时间减少30%
- ✅ 监控覆盖率达到95%

### 长期成功（6个月内）
- ✅ 维护成本降低60%
- ✅ 系统稳定性提升到99.9%
- ✅ 成为公司其他项目的标准监控方案
- ✅ 开源社区贡献

---

## 📌 十、注意事项

### 重要提醒
1. **全新设计**: 采用全新的监控架构，无需考虑历史包袱
2. **模块化实施**: 按阶段逐步构建新的监控系统
3. **充分测试**: 每个阶段都要有完整的测试
4. **文档先行**: 先更新文档，再改代码
5. **监控重构过程**: 实时监控重构对系统的影响

### 潜在风险
1. **功能完整性风险**: 确保新架构覆盖所有必要功能
2. **性能目标风险**: 新架构需达到预期性能指标
3. **数据连续性风险**: 确保监控数据的连续性
4. **开发进度风险**: 严格按照时间计划执行

---

## 📞 十一、联系方式

- **技术负责人**: 架构团队
- **项目经理**: 待定
- **紧急联系**: 运维值班电话

---

## 📚 附录

### A. 文件名与类名映射表

| 文件路径 | 类名 | 说明 |
|---------|------|------|
| **Infrastructure 层** | | |
| `infrastructure-metrics-registry.service.ts` | `InfrastructureMetricsRegistryService` | Prometheus指标注册表 |
| `infrastructure-database-performance.decorator.ts` | `InfrastructureDatabasePerformance` | 数据库性能装饰器 |
| `infrastructure-auth-performance.decorator.ts` | `InfrastructureAuthPerformance` | 认证性能装饰器 |
| `infrastructure-monitoring-config.decorator.ts` | `InfrastructureMonitoringConfig` | 监控配置装饰器 |
| `infrastructure-performance.interceptor.ts` | `InfrastructurePerformanceInterceptor` | 性能拦截器 |
| `infrastructure-metrics.interceptor.ts` | `InfrastructureMetricsInterceptor` | 指标收集拦截器 |
| **Collector 层** | | |
| `collector.service.ts` | `CollectorService` | 数据收集服务 |
| `collector.repository.ts` | `CollectorRepository` | 数据持久化仓库 |
| `collector.interceptor.ts` | `CollectorInterceptor` | 收集拦截器 |
| **Analyzer 层** | | |
| `analyzer.service.ts` | `AnalyzerService` | 分析协调器 |
| `analyzer-health.service.ts` | `AnalyzerHealthService` | 健康分析服务 |
| `analyzer-trend.service.ts` | `AnalyzerTrendService` | 趋势分析服务 |
| `analyzer-health-score.calculator.ts` | `AnalyzerHealthScoreCalculator` | 健康分计算器 |
| `analyzer-metrics.calculator.ts` | `AnalyzerMetricsCalculator` | 指标计算器 |
| **Presenter 层** | | |
| `presenter.controller.ts` | `PresenterController` | 展示层控制器 |
| `presenter.service.ts` | `PresenterService` | 展示业务服务 |
| `presenter-error-handler.service.ts` | `PresenterErrorHandlerService` | 错误处理服务 |
| `presenter-query.dto.ts` | `PresenterQueryDto` | 查询数据传输对象 |
| `presenter-response.dto.ts` | `PresenterResponseDto` | 响应数据传输对象 |

### B. 代码迁移脚本

```bash
#!/bin/bash
# 自动迁移脚本
# migrate-monitoring.sh

# 1. 备份现有代码
git checkout -b monitoring-refactor-backup
git add .
git commit -m "Backup before monitoring refactor"

# 2. 创建新结构
mkdir -p src/monitoring/{infrastructure,collection,analysis,presentation,shared}

# 3. 迁移文件
mv src/common/core/monitoring/* src/monitoring/infrastructure/
mv src/system-status/collector/* src/monitoring/collection/
mv src/system-status/analyzer/* src/monitoring/analysis/
mv src/system-status/presenter/* src/monitoring/presentation/

# 4. 更新导入路径
find src -name "*.ts" -exec sed -i 's|@common/core/monitoring|@monitoring/infrastructure|g' {} \;
find src -name "*.ts" -exec sed -i 's|../system-status/|@monitoring/|g' {} \;

echo "Migration completed!"
```

### C. 功能验证清单

- [ ] 所有Prometheus指标正常
- [ ] 所有监控API可访问
- [ ] 性能装饰器正常工作
- [ ] 数据收集无遗漏
- [ ] 分析结果准确
- [ ] API设计规范验证
- [ ] 性能基准测试
- [ ] 压力测试通过
- [ ] 安全扫描通过
- [ ] 文档完整性检查

### D. 发布检查清单

- [ ] 代码审查完成
- [ ] 测试全部通过
- [ ] 文档更新完成
- [ ] 性能基准达标
- [ ] 安全扫描通过
- [ ] 监控告警配置
- [ ] 运维团队培训
- [ ] 发布计划确认
- [ ] 紧急联系人确认

---

**文档结束**

最后更新时间: 2025-01-23 (v1.6 - 保持原目录名，减少不必要的重命名)