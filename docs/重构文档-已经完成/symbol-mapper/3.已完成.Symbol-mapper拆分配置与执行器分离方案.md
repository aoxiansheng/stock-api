# Symbol Mapper æ‹†åˆ†æ–¹æ¡ˆ

## ğŸ“Š å®æ–½çŠ¶æ€

- âœ… **æ–¹æ¡ˆä¼˜åŒ–å®Œæˆ**ï¼šåŸºäºä»£ç å®é™…åˆ†æï¼Œç®€åŒ–ä¸ºå®ç”¨çš„3é˜¶æ®µæ¸è¿›å¼é‡æ„
- ğŸ”„ **å½“å‰çŠ¶æ€**ï¼šSymbolMapperService(43ä¸ªæ–¹æ³•) + SymbolMapperCacheService(48ä¸ªæ–¹æ³•ï¼Œå«ä¸šåŠ¡é€»è¾‘)
- ğŸ¯ **å®æ–½ç­–ç•¥**ï¼šä¿æŒç°æœ‰é«˜æ•ˆæ¶æ„ï¼Œä»…è§£å†³æ ¸å¿ƒèŒè´£æ··åˆé—®é¢˜

**è®¾è®¡åŸåˆ™è°ƒæ•´**ï¼šä»"å¤§è§„æ¨¡æ¶æ„é‡æ„"è°ƒæ•´ä¸º"æœ€å°åŒ–å½±å“çš„èŒè´£åˆ†ç¦»"ï¼Œé¿å…è¿‡åº¦è®¾è®¡ã€‚

### ğŸ“‹ ç®€åŒ–æ–¹æ¡ˆå¯¹æ¯”ï¼ˆé¿å…è¿‡åº¦è®¾è®¡ï¼‰

| ç»„ä»¶ | å½“å‰çŠ¶æ€ | ç®€åŒ–ç›®æ ‡çŠ¶æ€ | ä¿æŒä¸å˜ |
|-----|---------|-------------|----------|
| **Symbol Mapper** | âœ… è§„åˆ™ç®¡ç† + âŒ 43ä¸ªæ··åˆæ–¹æ³• | âœ… çº¯è§„åˆ™ç®¡ç†(CRUD) + å…¼å®¹é€‚é…å™¨ | ğŸ”¶ ç°æœ‰ç¼“å­˜ç®¡ç† |
| **Symbol Transformer** | âŒ **ä¸å­˜åœ¨** | âœ… æ ¸å¿ƒè½¬æ¢é€»è¾‘(ç®€åŒ–ç‰ˆ) | - |
| **Symbol Mapper Cache** | âŒ mapSymbols + executeUncachedQuery | ğŸŸ¡ **å¯é€‰ä¼˜åŒ–** | âœ… ä¸‰å±‚ç¼“å­˜æ¶æ„ |
| **Change Streamç›‘æ§** | âœ… setupChangeStreamMonitoring | **ä¿æŒä¸å˜** | âœ… ç°æœ‰äº‹ä»¶æœºåˆ¶ |
| **è°ƒç”¨æ–¹** | ReceiverService + StreamReceiverService | **æœ€å°åŒ–ä¿®æ”¹** | âœ… ç°æœ‰æ¥å£æ ¼å¼ |

## ğŸ“‹ æ¦‚è¿°

åŸºäºå¯¹ç°æœ‰ä»£ç æ¶æ„çš„æ·±å…¥åˆ†æï¼Œå½“å‰Symbol Mapperç»„ä»¶å­˜åœ¨èŒè´£æ··åˆçš„é—®é¢˜ï¼Œå°†è§„åˆ™åˆ¶å®šå’Œè§„åˆ™æ‰§è¡Œæ··åˆåœ¨ä¸€ä¸ªç»„ä»¶ä¸­ï¼Œä¸Data Mapper + Transformerçš„ä¼˜ç§€è®¾è®¡æ¨¡å¼ä¸ä¸€è‡´ã€‚æœ¬æ–‡æ¡£åˆ¶å®šäº†è¯¦ç»†çš„æ‹†åˆ†æ–¹æ¡ˆï¼Œå°†Symbol Mapperé‡æ„ä¸ºç¬¦åˆæ¶æ„åŸåˆ™çš„åŒç»„ä»¶è®¾è®¡ã€‚

## ğŸ¯ ç®€åŒ–é‡æ„ç›®æ ‡

### å®ç”¨æ¶æ„è®¾è®¡
```
00-prepare/symbol-mapper/          # ğŸ“‹ è§„åˆ™ç®¡ç†å™¨ï¼ˆæ¸…ç†åï¼‰
â”œâ”€â”€ è§„åˆ™CRUDæ“ä½œï¼ˆä¿ç•™ï¼‰
â”œâ”€â”€ ç¼“å­˜ç®¡ç†ï¼ˆä¿ç•™ï¼‰  
â””â”€â”€ å…¼å®¹é€‚é…å™¨ï¼ˆæ–°å¢ï¼‰

02-processing/symbol-transformer/  # âš™ï¸ è½¬æ¢æ‰§è¡Œå™¨ï¼ˆæ–°å»ºï¼‰
â””â”€â”€ æ ¸å¿ƒè½¬æ¢é€»è¾‘ï¼ˆä»SymbolMapperè¿ç§»ï¼‰
```

### ç®€åŒ–è®¾è®¡åŸåˆ™
- **æœ€å°åŒ–å½±å“**ï¼šä¿æŒç°æœ‰é«˜æ•ˆæ¶æ„å’Œæ€§èƒ½ç‰¹å¾
- **èŒè´£åˆ†ç¦»**ï¼šä»…è§£å†³æ ¸å¿ƒèŒè´£æ··åˆé—®é¢˜
- **æ¸è¿›å¼è¿ç§»**ï¼š3é˜¶æ®µå¯æ§å®æ–½ï¼Œæ¯é˜¶æ®µå¯å›æ»š
- **å‘åå…¼å®¹**ï¼šç°æœ‰è°ƒç”¨æ–¹å¼ç»§ç»­å·¥ä½œ

## ğŸ”´ å…³é”®é—®é¢˜ä¿®å¤ï¼ˆå¿…é¡»ä¼˜å…ˆå¤„ç†ï¼‰

### å‘ç°çš„è¿”å›ç»“æ„è¯¯ç”¨é—®é¢˜

**é—®é¢˜ä½ç½®**ï¼š`src/core/01-entry/stream-receiver/services/stream-receiver.service.ts:610-615`

**é—®é¢˜æè¿°**ï¼š`StreamReceiverService.mapSymbols()` ä¸­è¯¯å°†å¯¹è±¡è¿”å›å€¼å½“ä½œæ•°ç»„ä½¿ç”¨

**é”™è¯¯ä»£ç **ï¼š
```typescript
private async mapSymbols(symbols: string[], providerName: string): Promise<string[]> {
  const mappedSymbol = await this.symbolMapperService.transformSymbolsForProvider(
    providerName, [symbol], `map_${Date.now()}`
  );
  // âŒ é”™è¯¯ï¼šå°†å¯¹è±¡å½“ä½œæ•°ç»„å¤„ç†
  const finalSymbol = Array.isArray(mappedSymbol) && mappedSymbol.length > 0 ? mappedSymbol[0] : symbol;
}
```

**å®é™…è¿”å›ç»“æ„**ï¼ˆç»ä»£ç éªŒè¯ï¼‰ï¼š
```typescript
// transformSymbolsForProvider() å®é™…è¿”å›ï¼š
{
  transformedSymbols: string[],        // â† å®é™…çš„ç¬¦å·æ•°ç»„åœ¨è¿™é‡Œ
  mappingResults: {
    transformedSymbols: Record<string, string>,
    failedSymbols: string[],
    metadata: { provider, totalSymbols, successfulTransformations, processingTime }
  }
}
```

**æ­£ç¡®ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
private async mapSymbols(symbols: string[], providerName: string): Promise<string[]> {
  const mappedSymbol = await this.symbolMapperService.transformSymbolsForProvider(
    providerName, [symbol], `map_${Date.now()}`
  );
  // âœ… æ­£ç¡®ï¼šä»å¯¹è±¡ä¸­æå–è½¬æ¢åçš„ç¬¦å·æ•°ç»„
  const finalSymbol = mappedSymbol.transformedSymbols?.[0] ?? symbol;
}
```

**å½±å“è¯„ä¼°**ï¼š
- **å½“å‰å½±å“**ï¼šStreamReceiver ä¸­ç¬¦å·æ˜ å°„å®é™…å¤±è´¥ï¼Œä½†å› ä¸ºæœ‰ fallback æœºåˆ¶ä½¿ç”¨åŸå§‹ç¬¦å·ï¼ŒåŠŸèƒ½å¯æ­£å¸¸å·¥ä½œ
- **æ½œåœ¨é£é™©**ï¼šç¬¦å·è½¬æ¢é€»è¾‘è¢«ç»•è¿‡ï¼Œå¯èƒ½å½±å“æµæ•°æ®å¤„ç†çš„å‡†ç¡®æ€§
- **ä¿®å¤ä¼˜å…ˆçº§**ï¼šğŸ”´ **P0 é˜»å¡é—®é¢˜**ï¼Œå¿…é¡»åœ¨å®æ–½æ–°æ¶æ„å‰ä¿®å¤

## ğŸ” ç°çŠ¶åˆ†æ

### å®é™…ä»£ç å¤æ‚åº¦ç¡®è®¤

**âœ… éªŒè¯çš„é—®é¢˜**ï¼š
- **SymbolMapperService**: 43ä¸ªæ–¹æ³•ï¼ŒèŒè´£ä¸¥é‡æ··åˆï¼ˆCRUD + è½¬æ¢ + ç¼“å­˜ï¼‰
- **SymbolMapperCacheService**: 48ä¸ªæ–¹æ³•ï¼Œå«`mapSymbols()`å’Œ`executeUncachedQuery()`ä¸šåŠ¡é€»è¾‘
- **è°ƒç”¨æ–¹é›†ä¸­**: ä¸»è¦æ˜¯ReceiverService(2å¤„) + StreamReceiverService(4å¤„)

**âœ… ç°æœ‰è‰¯å¥½è®¾è®¡**ï¼š
- **ä¸‰å±‚ç¼“å­˜æ¶æ„**è¿è¡Œé«˜æ•ˆï¼Œæ€§èƒ½æ— é—®é¢˜
- **Change Streamç›‘æ§**å·²å®ç°ï¼Œæ— éœ€é‡æ–°è®¾è®¡  
- **ç°æœ‰æ¥å£**å·¥ä½œè‰¯å¥½ï¼Œç”¨æˆ·æ»¡æ„

### æ ¸å¿ƒé—®é¢˜è¯†åˆ«

#### 1. **SymbolMapperServiceèŒè´£æ··åˆ** âŒ
å®é™…æ£€æŸ¥ç¡®è®¤43ä¸ªæ–¹æ³•ï¼ŒèŒè´£ä¸¥é‡æ··åˆï¼š

**ä¿ç•™æ–¹æ³•**ï¼ˆè§„åˆ™ç®¡ç† + ç¼“å­˜ç®¡ç†ï¼‰ï¼š
```typescript
// è§„åˆ™CRUDï¼ˆ8ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼‰
- createDataSourceMapping(), saveMapping(), updateSymbolMapping(), deleteSymbolMapping()
- getSymbolMappingRule(), addSymbolMappingRule(), updateSymbolMappingRule(), removeSymbolMappingRule()

// æŸ¥è¯¢å’Œåˆ†é¡µï¼ˆ5ä¸ªæ–¹æ³•ï¼‰
- getSymbolMappingsPaginated(), getSymbolMappingByDataSource(), getAllSymbolMappingRule()
- getDataSources(), getMarkets(), getSymbolTypes()

// ç¼“å­˜ç®¡ç†ï¼ˆä¿æŒç°æœ‰é«˜æ•ˆæœºåˆ¶ï¼‰
- clearCache(), clearProviderCache(), getCacheStats()
- setupChangeStreamMonitoring() // ä¿æŒä¸å˜
```

**è¿ç§»æ–¹æ³•**ï¼ˆè½¬æ¢æ‰§è¡Œé€»è¾‘ â†’ SymbolTransformerServiceï¼‰ï¼š
```typescript
// æ ¸å¿ƒè½¬æ¢æ–¹æ³•ï¼ˆ7ä¸ªæ–¹æ³•ï¼‰
- mapSymbol() â†’ transformSingleSymbol()
- mapSymbols() â†’ transformSymbols()
- transformSymbols(), transformSymbolsById(), transformSymbolsForProvider()
- _executeSymbolTransformation(), applySymbolMappingRule()
```

#### 2. **SymbolMapperCacheServiceèŒè´£æ±¡æŸ“** âŒ
ç¼“å­˜å±‚ç¡®å®åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼ˆ48ä¸ªæ–¹æ³•ï¼‰ï¼š
```typescript
// å½“å‰é—®é¢˜æ–¹æ³•
- mapSymbols() // å®Œæ•´ä¸šåŠ¡é€»è¾‘ï¼Œåº”ç§»åˆ°SymbolTransformer
- executeUncachedQuery() // æ•°æ®åº“æŸ¥è¯¢ï¼Œåº”é›†æˆåˆ°è½¬æ¢é€»è¾‘ä¸­
```

**ç®€åŒ–å¤„ç†æ–¹æ¡ˆ**ï¼š
- **é˜¶æ®µ3å¯é€‰ä¼˜åŒ–**ï¼šå¦‚æœç¡®å®éœ€è¦ï¼Œå¯ä»¥æ¸…ç†ç¼“å­˜å±‚ä¸šåŠ¡é€»è¾‘
- **ä¼˜å…ˆä¿æŒ**ï¼šç°æœ‰ä¸‰å±‚ç¼“å­˜æ¶æ„ï¼ˆL1+L2+L3ï¼‰è¿è¡Œé«˜æ•ˆ
- **é‡ç‚¹å…³æ³¨**ï¼šæ ¸å¿ƒè½¬æ¢é€»è¾‘çš„èŒè´£åˆ†ç¦»

#### 3. **çœŸå®ç—›ç‚¹ç¡®è®¤** âœ…
- **æµ‹è¯•å›°éš¾**ï¼š43ä¸ªæ–¹æ³•æ··åˆåœ¨ä¸€èµ·ï¼Œå•å…ƒæµ‹è¯•å¤æ‚
- **ç»´æŠ¤å›°éš¾**ï¼šèŒè´£ä¸æ¸…æ™°ï¼Œä¿®æ”¹å½±å“é¢å¤§
- **ä»£ç å¯è¯»æ€§**ï¼šæ–°äººç†è§£æˆæœ¬é«˜

## ğŸ“ ç®€åŒ–é‡æ„è®¾è®¡

### ç»„ä»¶èŒè´£é‡æ–°å®šä¹‰ï¼ˆå®ç”¨ç‰ˆï¼‰

#### **Symbol Mapper** (00-prepare/symbol-mapper/) ã€æ¸…ç†ç‰ˆã€‘
**èŒè´£**ï¼šè§„åˆ™ç®¡ç† + ç¼“å­˜ç®¡ç† + å…¼å®¹é€‚é…å™¨

**ä¿ç•™çš„æ–¹æ³•ï¼ˆçº¦30ä¸ªï¼‰**ï¼š
```typescript
// è§„åˆ™CRUDæ“ä½œï¼ˆ8ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼‰
createDataSourceMapping(), saveMapping(), getSymbolMappingRule(), updateSymbolMapping()
deleteSymbolMapping(), addSymbolMappingRule(), updateSymbolMappingRule(), removeSymbolMappingRule()

// æŸ¥è¯¢å’Œåˆ†é¡µï¼ˆ5ä¸ªæ–¹æ³•ï¼‰
getSymbolMappingsPaginated(), getSymbolMappingByDataSource(), getAllSymbolMappingRule()
getDataSources(), getMarkets(), getSymbolTypes()

// ç¼“å­˜ç®¡ç†ï¼ˆä¿æŒç°æœ‰æœºåˆ¶ï¼‰
clearCache(), clearProviderCache(), getCacheStats()
setupChangeStreamMonitoring() // ä¿æŒä¸å˜

// å…¼å®¹é€‚é…å™¨ï¼ˆæ–°å¢ï¼Œå®ç°å‘åå…¼å®¹ï¼‰
mapSymbols() // å†…éƒ¨å§”æ‰˜ç»™SymbolTransformerService
transformSymbols() // å†…éƒ¨å§”æ‰˜ç»™SymbolTransformerService
```

#### **Symbol Transformer** (02-processing/symbol-transformer/) ã€ç®€åŒ–æ–°å»ºã€‘
**èŒè´£**ï¼šä¸“é—¨çš„ç¬¦å·è½¬æ¢æ‰§è¡Œé€»è¾‘ï¼ˆä»SymbolMapperServiceè¿ç§»ï¼‰

**ç®€åŒ–è®¾è®¡åŸåˆ™**ï¼š
- **ç›´æ¥ä¾èµ–**ï¼šä¾èµ–ç°æœ‰SymbolMapperServiceï¼ˆæ— éœ€æ–°æ¥å£å±‚ï¼‰
- **æœ€å°æ”¹åŠ¨**ï¼šä¿æŒç°æœ‰æ¥å£æ ¼å¼å’Œç¼“å­˜æœºåˆ¶
- **æ ¸å¿ƒåŠŸèƒ½**ï¼šä»…å¤„ç†ç¬¦å·è½¬æ¢ï¼Œä¸ç®¡ç†ç¼“å­˜å’Œè§„åˆ™

**è¿ç§»çš„æ–¹æ³•ï¼ˆ7ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼‰**ï¼š
```typescript
// ä¸»è¦è½¬æ¢æ–¹æ³•
transformSymbols(provider: string, symbols: string[], direction?: string)
transformSingleSymbol(provider: string, symbol: string, direction?: string)

// è¿ç§»çš„å†…éƒ¨é€»è¾‘
_executeSymbolTransformation() // ä»SymbolMapperServiceè¿ç§»
applySymbolMappingRule() // ä»SymbolMapperServiceè¿ç§»
transformSymbolsForProvider() // ä»SymbolMapperServiceè¿ç§»

// ä¿æŒç°æœ‰æ ¼å¼
mapSymbol() // å‘åå…¼å®¹æ–¹æ³•å
mapSymbols() // å‘åå…¼å®¹æ–¹æ³•å
```

#### **ä¾èµ–å…³ç³»ç®€åŒ–**
**é¿å…è¿‡åº¦è®¾è®¡**ï¼šæ— éœ€æ–°çš„æ¥å£å±‚å’Œå¤æ‚ä¾èµ–å…³ç³»

**ç®€åŒ–ä¾èµ–è®¾è®¡**ï¼š
```typescript
// SymbolTransformerService ç›´æ¥ä¾èµ–ç°æœ‰æœåŠ¡
@Injectable()
export class SymbolTransformerService {
  constructor(
    // ç›´æ¥ä¾èµ–ï¼Œæ— éœ€æ¥å£æŠ½è±¡
    private readonly symbolMapperService: SymbolMapperService,
    private readonly symbolMapperCacheService: SymbolMapperCacheService // å¯é€‰ï¼Œç”¨äºç¼“å­˜
  ) {}
}

// SymbolMapperService æä¾›å…¼å®¹é€‚é…å™¨
class SymbolMapperService {
  constructor(
    private readonly symbolTransformerService?: SymbolTransformerService // å¯é€‰æ³¨å…¥ï¼Œå‘å‰å…¼å®¹
  ) {}
  
  // å…¼å®¹é€‚é…å™¨æ–¹æ³•
  async mapSymbols(provider: string, symbols: string[]) {
    if (this.symbolTransformerService) {
      return await this.symbolTransformerService.transformSymbols(provider, symbols);
    }
    // ä¿ç•™ç°æœ‰å®ç°ä½œä¸ºfallback
    return await this.legacyMapSymbols(provider, symbols);
  }
}
```

#### **Symbol Mapper Cache** (05-caching/symbol-mapper-cache/) ã€å¯é€‰ä¼˜åŒ–ã€‘
**å½“å‰çŠ¶æ€**ï¼šåŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œä½†è¿è¡Œé«˜æ•ˆ

**ç®€åŒ–å¤„ç†ç­–ç•¥**ï¼š
- **é˜¶æ®µ3å¯é€‰**ï¼šå¦‚æœç¡®å®éœ€è¦ï¼Œå¯ä»¥æ¸…ç†`mapSymbols()`å’Œ`executeUncachedQuery()`
- **ä¼˜å…ˆä¿æŒ**ï¼šç°æœ‰ä¸‰å±‚ç¼“å­˜æ¶æ„è¿è¡Œè‰¯å¥½ï¼Œæ— æ€§èƒ½é—®é¢˜
- **é‡ç‚¹å…³æ³¨**ï¼šæ ¸å¿ƒè½¬æ¢é€»è¾‘çš„èŒè´£åˆ†ç¦»å³å¯

**å¦‚éœ€ä¼˜åŒ–çš„è°ƒæ•´**ï¼š
```typescript
// å¯é€‰ç§»é™¤çš„æ–¹æ³•ï¼ˆä»…å½“ç¡®å®éœ€è¦æ—¶ï¼‰
- mapSymbols() // ç§»åˆ°SymbolTransformerService  
- executeUncachedQuery() // é›†æˆåˆ°è½¬æ¢é€»è¾‘ä¸­

// ä¿ç•™çš„æ ¸å¿ƒç¼“å­˜åŠŸèƒ½ï¼ˆä¿æŒé«˜æ•ˆï¼‰
+ ä¸‰å±‚ç¼“å­˜ç®¡ç†ï¼ˆL1è§„åˆ™+L2ç¬¦å·+L3æ‰¹é‡ï¼‰
+ setupChangeStreamMonitoring() // ä¿æŒç°æœ‰äº‹ä»¶æœºåˆ¶
+ æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
+ å†…å­˜ç®¡ç†å’Œæ¸…ç†
```

### ç®€åŒ–ç»„ä»¶ç»“æ„è®¾è®¡

#### **Symbol Transformer ç»„ä»¶ç»“æ„ï¼ˆæœ€å°åŒ–ï¼‰**
```
src/core/02-processing/symbol-transformer/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ symbol-transformer.service.ts         # æ ¸å¿ƒè½¬æ¢æœåŠ¡ï¼ˆä»SymbolMapperè¿ç§»é€»è¾‘ï¼‰
â”œâ”€â”€ module/
â”‚   â””â”€â”€ symbol-transformer.module.ts          # æ¨¡å—å®šä¹‰
â””â”€â”€ controller/  # å¯é€‰
    â””â”€â”€ symbol-transformer.controller.ts      # è°ƒè¯•æ¥å£ï¼ˆç”Ÿäº§ç¯å¢ƒç¦ç”¨ï¼‰
```

**é¿å…è¿‡åº¦è®¾è®¡**ï¼š
- **æ— éœ€æ–°DTO**ï¼šä½¿ç”¨ç°æœ‰æ¥å£æ ¼å¼ï¼Œé¿å…å¤§è§„æ¨¡APIå˜æ›´
- **æ— éœ€æ–°æ¥å£**ï¼šç›´æ¥ä¾èµ–ç°æœ‰æœåŠ¡ï¼Œé¿å…æŠ½è±¡å±‚å¤æ‚åº¦
- **æ— éœ€æ–°å¸¸é‡**ï¼šä½¿ç”¨ç°æœ‰é…ç½®æœºåˆ¶
- **ä¸“æ³¨æ ¸å¿ƒ**ï¼šä»…è¿ç§»è½¬æ¢é€»è¾‘ï¼Œä¿æŒç®€å•

### ç®€åŒ–æ¥å£è®¾è®¡ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰

#### **Symbol Transformer Service æ ¸å¿ƒæ¥å£**
```typescript
// ç®€åŒ–æ¥å£è®¾è®¡ï¼Œä¿æŒç°æœ‰æ ¼å¼
@Injectable()
export class SymbolTransformerService {
  // ä¸»è¦è½¬æ¢æ–¹æ³•ï¼ˆä¿æŒç°æœ‰æ¥å£æ ¼å¼ï¼‰
  async transformSymbols(
    provider: string, 
    symbols: string | string[], 
    direction: 'to_standard' | 'from_standard' = 'to_standard'
  ): Promise<SymbolTransformResult> {
    // ä»SymbolMapperServiceè¿ç§»çš„é€»è¾‘
  }
  
  // å•ç¬¦å·è½¬æ¢ï¼ˆä¾¿æ·æ–¹æ³•ï¼‰
  async transformSingleSymbol(
    provider: string, 
    symbol: string, 
    direction: 'to_standard' | 'from_standard' = 'to_standard'
  ): Promise<string> {
    const result = await this.transformSymbols(provider, [symbol], direction);
    return result.mappedSymbols[0] || symbol;  // æ³¨æ„ï¼šä½¿ç”¨ mappedSymbols å­—æ®µ
  }
  
  // å…¼å®¹ç°æœ‰æ–¹æ³•å
  async mapSymbols(provider: string, symbols: string | string[], requestId?: string) {
    return await this.transformSymbols(provider, symbols, 'to_standard');
  }
  
  async mapSymbol(provider: string, symbol: string, requestId?: string) {
    return await this.transformSingleSymbol(provider, symbol, 'to_standard');
  }
}

// ä¸¥æ ¼å¯¹é½ç°æœ‰ SymbolMapperService.mapSymbols() è¿”å›æ ¼å¼
interface SymbolTransformResult {
  mappedSymbols: string[];                    // å¯¹é½ï¼šSymbolMapperService.mapSymbols().mappedSymbols
  mappingDetails: Record<string, string>;     // å¯¹é½ï¼šSymbolMapperService.mapSymbols().mappingDetails
  failedSymbols: string[];                    // å¯¹é½ï¼šSymbolMapperService.mapSymbols().failedSymbols
  metadata: {                                 // å¯¹é½ï¼šSymbolMapperService.mapSymbols().metadata
    provider: string;
    totalSymbols: number;
    successCount: number;
    failedCount: number;
    processingTimeMs: number;                 // æ³¨æ„ï¼šä½¿ç”¨ processingTimeMsï¼ˆä¸æ˜¯ processingTimeï¼‰
  };
}
```

#### **å­—æ®µå¯¹é½éªŒè¯**ï¼ˆåŸºäºä»£ç å®é™…éªŒè¯ï¼‰
```typescript
// ç¼“å­˜å±‚ BatchMappingResult â†’ è§„åˆ™æœåŠ¡è½¬æ¢ â†’ è°ƒç”¨æ–¹ä½¿ç”¨
// âœ… å·²éªŒè¯çš„å­—æ®µæµè½¬ï¼š
BatchMappingResult {
  mappingDetails: Record<string, string>,    // â†’ mappedSymbols = Object.values(mappingDetails)
  failedSymbols: string[],                   // â†’ ç›´æ¥ä¼ é€’
  processingTime: number                     // â†’ è½¬æ¢ä¸º processingTimeMs
} 
â†’ SymbolMapperService.mapSymbols() {
  mappedSymbols: string[],                   // â† ä» Object.values(mappingDetails) æ´¾ç”Ÿ
  mappingDetails: Record<string, string>,    // â† ç›´æ¥ä¼ é€’
  failedSymbols: string[],                   // â† ç›´æ¥ä¼ é€’
  metadata: { processingTimeMs: number }     // â† ä» processingTime è½¬æ¢
}
â†’ ReceiverService ä½¿ç”¨æ­£å¸¸
```

**è®¾è®¡åŸåˆ™**ï¼š
- **ä¿æŒç°æœ‰æ¥å£**ï¼šé¿å…è°ƒç”¨æ–¹å¤§è§„æ¨¡ä¿®æ”¹
- **å‘åå…¼å®¹**ï¼šç°æœ‰æ–¹æ³•åå’Œå‚æ•°æ ¼å¼ç»§ç»­å·¥ä½œ
- **æœ€å°åŒ–å˜æ›´**ï¼šä»…è¿ç§»å†…éƒ¨é€»è¾‘ï¼Œä¸æ”¹å˜å¤–éƒ¨æ¥å£

### äº‹ä»¶æœºåˆ¶å¤„ç†ï¼ˆç®€åŒ–ï¼‰

#### **ä¿æŒç°æœ‰äº‹ä»¶æœºåˆ¶ï¼ˆé¿å…é‡æ–°è®¾è®¡ï¼‰**
```typescript
// ç°æœ‰Change Streamç›‘æ§å·²ç»å·¥ä½œè‰¯å¥½
class SymbolMapperCacheService {
  // ä¿æŒç°æœ‰å®ç°
  setupChangeStreamMonitoring() {
    // å·²å®ç°çš„MongoDB Change Streamç›‘æ§
    // æ— éœ€é‡æ–°è®¾è®¡äº‹ä»¶ç³»ç»Ÿ
  }
  
  handleChangeEvent(changeEvent) {
    // ç°æœ‰çš„å˜æ›´å¤„ç†é€»è¾‘
    // ä¿æŒä¸å˜ï¼Œè¿è¡Œé«˜æ•ˆ
  }
}

// Symbol Mapperä¿æŒç°æœ‰ç¼“å­˜å¤±æ•ˆæœºåˆ¶
class SymbolMapperService {
  async updateSymbolMapping(id: string, updateDto: UpdateSymbolMappingDto) {
    const updatedRule = await this.repository.update(id, updateDto);
    
    // ä¿æŒç°æœ‰ç¼“å­˜å¤±æ•ˆé€»è¾‘
    await this.invalidateCacheForChangedRule(updatedRule);
    
    return updatedRule;
  }
  
  // ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜
  private async invalidateCacheForChangedRule(rule: SymbolMappingRule) {
    // ç°æœ‰å®ç°å·²ç»é«˜æ•ˆï¼Œæ— éœ€ä¿®æ”¹
  }
}
```

**ç®€åŒ–åŸåˆ™**ï¼š
- **ä¿æŒç°æœ‰æœºåˆ¶**ï¼šChange Streamç›‘æ§å·²ç»å·¥ä½œè‰¯å¥½
- **é¿å…é‡å¤å»ºè®¾**ï¼šæ— éœ€æ–°çš„EventEmitter2äº‹ä»¶ç³»ç»Ÿ  
- **é™ä½å¤æ‚åº¦**ï¼šç°æœ‰ç¼“å­˜å¤±æ•ˆé€»è¾‘è¿è¡Œç¨³å®š

### ç›´æ¥æ¶æ„å®ç°ï¼ˆæ— å…¼å®¹å±‚ï¼‰

#### **ç›´æ¥æ›¿æ¢ SymbolMapperService çš„è½¬æ¢æ–¹æ³•**
```typescript
// ç›´æ¥ç§»é™¤è½¬æ¢æ–¹æ³•ï¼Œä¿ç•™è§„åˆ™ç®¡ç†æ–¹æ³•
class SymbolMapperService {
  // âŒ åˆ é™¤æ‰€æœ‰è½¬æ¢æ–¹æ³•
  // - mapSymbol()
  // - mapSymbols()
  // - transformSymbols()
  // - transformSymbolsForProvider()
  // - _executeSymbolTransformation()
  // - applySymbolMappingRule()

  // âœ… ä¿ç•™è§„åˆ™ç®¡ç†æ–¹æ³•
  async createDataSourceMapping() { /* ä¿æŒä¸å˜ */ }
  async updateSymbolMapping() { /* ä¿æŒä¸å˜ */ }
  async deleteSymbolMapping() { /* ä¿æŒä¸å˜ */ }
  async getSymbolMappingRule() { /* ä¿æŒä¸å˜ */ }
  // ... å…¶ä»–è§„åˆ™CRUDæ–¹æ³•
}
```

#### **è°ƒç”¨æ–¹ç›´æ¥åˆ‡æ¢åˆ°æ–°æœåŠ¡**
```typescript
// ReceiverService ç›´æ¥æ³¨å…¥ SymbolTransformerService
class ReceiverService {
  constructor(
    private readonly symbolTransformerService: SymbolTransformerService,
    private readonly symbolMapperService: SymbolMapperService, // ä»…ç”¨äºè§„åˆ™ç®¡ç†
    // ... å…¶ä»–ä¾èµ–
  ) {}

  async executeOriginalDataFlow(dto: QueryDto, requestId: string) {
    // ç›´æ¥è°ƒç”¨æ–°æœåŠ¡
    const mappingResult = await this.symbolTransformerService.transformSymbols(
      dto.provider, 
      dto.symbols
    );
    
    // è§„åˆ™ç®¡ç†ä»ä½¿ç”¨ SymbolMapperService
    const rules = await this.symbolMapperService.getSymbolMappingRule(dto.provider);
  }
}

// StreamReceiverService - ä¿æŒ transformSymbolsForProvider() é›¶æ”¹åŠ¨
class StreamReceiverService {
  constructor(
    private readonly symbolTransformerService: SymbolTransformerService,
    // ... å…¶ä»–ä¾èµ–
  ) {}

  private async mapSymbols(symbols: string[], providerName: string): Promise<string[]> {
    // ä¿æŒç°æœ‰æ–¹æ³•è°ƒç”¨ï¼Œä»…åˆ‡æ¢æœåŠ¡æ¥æº
    const result = await this.symbolTransformerService.transformSymbolsForProvider(
      providerName,
      symbols,
      `map_${Date.now()}`
    );
    return result.transformedSymbols || [];
  }
}
```

## ğŸ”„ æ— å…¼å®¹å±‚å®æ–½æ–¹æ¡ˆï¼ˆæœ€å°æ”¹åŠ¨è·¯å¾„ï¼‰

**ğŸ¯ æ ¸å¿ƒç­–ç•¥**ï¼šç›´æ¥åˆ›å»ºæ–°æœåŠ¡ï¼Œè°ƒç”¨æ–¹é›¶æ”¹åŠ¨æˆ–æœ€å°æ”¹åŠ¨

### é˜¶æ®µ1ï¼šåˆ›å»º SymbolTransformerService ã€æ ¸å¿ƒé˜¶æ®µã€‘

**ğŸ”´ å½“å‰çŠ¶æ€**ï¼šæ­¤ç»„ä»¶å®Œå…¨ä¸å­˜åœ¨ï¼Œéœ€è¦ä»é›¶åˆ›å»º

#### 1.1 åˆ›å»ºç›®å½•ç»“æ„
```bash
mkdir -p src/core/02-processing/symbol-transformer/{services,module,interfaces,dto}
```

#### 1.2 å®ç°æ ¸å¿ƒæœåŠ¡
```typescript
// src/core/02-processing/symbol-transformer/services/symbol-transformer.service.ts
@Injectable()
export class SymbolTransformerService {
  private readonly logger = createLogger('SymbolTransformer');
  
  constructor(
    private readonly symbolMapperCacheService: SymbolMapperCacheService,  // ç¼“å­˜æœåŠ¡ï¼ˆå«å›æºé€»è¾‘ï¼‰
    private readonly metricsRegistry?: MetricsRegistryService  // å¯é€‰ç›‘æ§
  ) {}

  /**
   * æ ¸å¿ƒè½¬æ¢æ–¹æ³• - è¿ç§»è‡ª SymbolMapperService
   */
  async transformSymbols(
    provider: string,
    symbols: string | string[],
    direction: 'to_standard' | 'from_standard' = 'to_standard'
  ): Promise<SymbolTransformResult> {
    const startTime = process.hrtime.bigint();
    const symbolArray = Array.isArray(symbols) ? symbols : [symbols];
    const requestId = `transform_${Date.now()}`;

    this.logger.debug('å¼€å§‹ç¬¦å·è½¬æ¢', {
      provider,
      symbolsCount: symbolArray.length,
      direction,
      requestId,
    });

    try {
      // ä½¿ç”¨ç¼“å­˜æœåŠ¡è¿›è¡Œæ‰¹é‡è½¬æ¢
      const result = await this.symbolMapperCacheService.mapSymbols(
        provider,
        symbolArray,
        direction,
        requestId
      );
      
      const processingTime = Number(process.hrtime.bigint() - startTime) / 1e6;
      
      // è½¬æ¢ä¸ºç»Ÿä¸€è¿”å›æ ¼å¼
      const response: SymbolTransformResult = {
        mappedSymbols: Object.values(result.mappingDetails),
        mappingDetails: result.mappingDetails,
        failedSymbols: result.failedSymbols,
        metadata: {
          provider,
          totalSymbols: symbolArray.length,
          successCount: Object.keys(result.mappingDetails).length,
          failedCount: result.failedSymbols.length,
          processingTimeMs: processingTime,
        },
      };

      // è®°å½•æ€§èƒ½æŒ‡æ ‡
      if (this.metricsRegistry) {
        this.recordMetrics(provider, response);
      }

      return response;

    } catch (error) {
      const processingTime = Number(process.hrtime.bigint() - startTime) / 1e6;
      
      this.logger.error('ç¬¦å·è½¬æ¢å¤±è´¥', {
        requestId,
        provider,
        error: error.message,
        processingTimeMs: processingTime,
      });

      // è¿”å›å¤±è´¥ç»“æœ
      return {
        mappedSymbols: [],
        mappingDetails: {},
        failedSymbols: symbolArray,
        metadata: {
          provider,
          totalSymbols: symbolArray.length,
          successCount: 0,
          failedCount: symbolArray.length,
          processingTimeMs: processingTime,
        },
      };
    }
  }

  /**
   * å•ç¬¦å·è½¬æ¢ä¾¿æ·æ–¹æ³•
   */
  async transformSingleSymbol(
    provider: string,
    symbol: string,
    direction: 'to_standard' | 'from_standard' = 'to_standard'
  ): Promise<string> {
    const result = await this.transformSymbols(provider, [symbol], direction);
    return result.mappedSymbols[0] || symbol;
  }

  /**
   * transformSymbolsForProvider - è¿ç§»è‡ª SymbolMapperService
   */
  async transformSymbolsForProvider(
    provider: string,
    symbols: string[],
    requestId: string
  ): Promise<any> {
    // åˆ†ç¦»æ ‡å‡†æ ¼å¼å’Œéœ€è¦è½¬æ¢çš„ç¬¦å·
    const { symbolsToTransform, standardSymbols } = this.separateSymbolsByFormat(symbols);
    
    // è½¬æ¢éæ ‡å‡†æ ¼å¼
    let mappingResult = {
      transformedSymbols: {},
      failedSymbols: [],
      processingTimeMs: 0,
    };

    if (symbolsToTransform.length > 0) {
      const result = await this.transformSymbols(provider, symbolsToTransform);
      mappingResult = {
        transformedSymbols: result.mappingDetails,
        failedSymbols: result.failedSymbols,
        processingTimeMs: result.metadata.processingTimeMs,
      };
    }

    // æ·»åŠ æ ‡å‡†æ ¼å¼ç¬¦å·
    standardSymbols.forEach((symbol) => {
      mappingResult.transformedSymbols[symbol] = symbol;
    });

    return {
      transformedSymbols: Object.values(mappingResult.transformedSymbols),
      mappingResults: {
        transformedSymbols: mappingResult.transformedSymbols,
        failedSymbols: mappingResult.failedSymbols,
        metadata: {
          provider,
          totalSymbols: symbols.length,
          successfulTransformations: Object.keys(mappingResult.transformedSymbols).length,
          failedTransformations: mappingResult.failedSymbols.length,
          processingTime: mappingResult.processingTimeMs,
        },
      },
    };
  }

  private separateSymbolsByFormat(symbols: string[]): {
    symbolsToTransform: string[];
    standardSymbols: string[];
  } {
    // å®ç°ç¬¦å·æ ¼å¼åˆ†ç¦»é€»è¾‘ï¼ˆä» SymbolMapperService è¿ç§»ï¼‰
    const symbolsToTransform: string[] = [];
    const standardSymbols: string[] = [];
    
    symbols.forEach(symbol => {
      if (this.isStandardFormat(symbol)) {
        standardSymbols.push(symbol);
      } else {
        symbolsToTransform.push(symbol);
      }
    });
    
    return { symbolsToTransform, standardSymbols };
  }

  private isStandardFormat(symbol: string): boolean {
    // åˆ¤æ–­æ˜¯å¦ä¸ºæ ‡å‡†æ ¼å¼ï¼ˆè¿ç§»è‡ª SymbolMapperServiceï¼‰
    return /^\d{6}$/.test(symbol) || // 6ä½æ•°å­—ï¼ˆAè‚¡ï¼‰
           /^[A-Z]+$/.test(symbol);    // çº¯å­—æ¯ï¼ˆç¾è‚¡ï¼‰
  }

  private recordMetrics(provider: string, result: SymbolTransformResult): void {
    const hitRate = result.metadata.successCount / result.metadata.totalSymbols;
    this.metricsRegistry?.setGauge('symbol_transformer_success_rate', hitRate, { provider });
    this.metricsRegistry?.histogram('symbol_transformer_processing_time', 
      result.metadata.processingTimeMs, { provider });
  }
}
```

#### 1.3 å®šä¹‰æ¥å£å’ŒDTO
æŒ‰ç…§è®¾è®¡åˆ›å»ºå®Œæ•´çš„æ¥å£å’ŒDTOå®šä¹‰ã€‚

### é˜¶æ®µ2ï¼šæ¸…ç† SymbolMapperService

#### 2.1 åˆ é™¤è½¬æ¢ç›¸å…³æ–¹æ³•
ä» SymbolMapperService ä¸­ç›´æ¥åˆ é™¤ä»¥ä¸‹æ–¹æ³•ï¼š
```typescript
// âŒ å®Œå…¨åˆ é™¤è¿™äº›æ–¹æ³•ï¼ˆå·²è¿ç§»åˆ° SymbolTransformerServiceï¼‰
- mapSymbol()
- mapSymbols()
- transformSymbols()
- transformSymbolsById()
- transformSymbolsForProvider()
- _executeSymbolTransformation()
- applySymbolMappingRule()
```

#### 2.2 ä¿ç•™è§„åˆ™ç®¡ç†èŒè´£
```typescript
// âœ… ä¿ç•™è¿™äº›æ–¹æ³•
class SymbolMapperService {
  // è§„åˆ™CRUD
  async createDataSourceMapping() { }
  async updateSymbolMapping() { }
  async deleteSymbolMapping() { }
  async getSymbolMappingRule() { }
  
  // æŸ¥è¯¢å’Œåˆ†é¡µ
  async getSymbolMappingsPaginated() { }
  async getSymbolMappingByDataSource() { }
  
  // ç¼“å­˜ç®¡ç†
  async clearCache() { }
  async getCacheStats() { }
  setupChangeStreamMonitoring() { }
}
```

### é˜¶æ®µ3ï¼šæ›´æ–°è°ƒç”¨æ–¹

#### 3.1 æ›´æ–° ReceiverService
```typescript
class ReceiverService {
  constructor(
    // æ³¨å…¥ä¸¤ä¸ªæœåŠ¡ï¼šè½¬æ¢æœåŠ¡ + è§„åˆ™ç®¡ç†æœåŠ¡
    private readonly symbolTransformerService: SymbolTransformerService,
    private readonly symbolMapperService: SymbolMapperService,
    // ... å…¶ä»–ä¾èµ–
  ) {}

  async executeOriginalDataFlow(dto: QueryDto, requestId: string) {
    // ä½¿ç”¨æ–°çš„è½¬æ¢æœåŠ¡
    const mappingResult = await this.symbolTransformerService.transformSymbols(
      dto.provider, 
      dto.symbols
    );
    
    // è§„åˆ™ç®¡ç†ä»ä½¿ç”¨åŸæœåŠ¡
    const rules = await this.symbolMapperService.getSymbolMappingRule(dto.provider);
  }
}
```

#### 3.2 æ›´æ–° StreamReceiverService
```typescript
class StreamReceiverService {
  constructor(
    // æ³¨å…¥è½¬æ¢æœåŠ¡
    private readonly symbolTransformerService: SymbolTransformerService,
    // ... å…¶ä»–ä¾èµ–
  ) {}

  private async mapSymbols(symbols: string[], providerName: string): Promise<string[]> {
    // ä½¿ç”¨æ–°çš„è½¬æ¢æœåŠ¡
    const result = await this.symbolTransformerService.transformSymbolsForProvider(
      providerName,
      symbols,
      `map_${Date.now()}`
    );
    // âœ… ä¿®å¤ï¼šæ­£ç¡®æå–è½¬æ¢åçš„ç¬¦å·
    return result.transformedSymbols || [];
  }
}
```

### é˜¶æ®µ4ï¼šæ¨¡å—ç»„è£…å’Œæµ‹è¯•

#### 4.1 åˆ›å»º SymbolTransformerModule
```typescript
// src/core/02-processing/symbol-transformer/module/symbol-transformer.module.ts
@Module({
  imports: [
    SymbolMapperModule,      // è·å–è§„åˆ™ä»“åº“
    SymbolMapperCacheModule, // ç¼“å­˜æœåŠ¡
  ],
  providers: [SymbolTransformerService],
  exports: [SymbolTransformerService],
})
export class SymbolTransformerModule {}
```

#### 4.2 æ›´æ–°ä¸Šå±‚æ¨¡å—å¯¼å…¥
```typescript
// ReceiverModule
@Module({
  imports: [
    SymbolTransformerModule, // æ–°å¢ï¼šç¬¦å·è½¬æ¢æœåŠ¡
    SymbolMapperModule,      // ä¿ç•™ï¼šè§„åˆ™ç®¡ç†
    // ... å…¶ä»–æ¨¡å—
  ],
})
export class ReceiverModule {}

// StreamReceiverModule  
@Module({
  imports: [
    SymbolTransformerModule, // æ–°å¢ï¼šç¬¦å·è½¬æ¢æœåŠ¡
    // ... å…¶ä»–æ¨¡å—
  ],
})
export class StreamReceiverModule {}
```

### é˜¶æ®µ5ï¼šæµ‹è¯•éªŒè¯

#### 5.1 ç­‰ä»·æ€§æµ‹è¯•
```typescript
describe('Symbol Transformer Equivalence', () => {
  it('æ–°æ—§å®ç°å¯¹åŒä¸€è§„åˆ™é›†çš„è½¬æ¢ç»“æœå®Œå…¨ä¸€è‡´', async () => {
    const testCases = [
      { provider: 'longport', symbols: ['700.HK'], expected: ['00700'] },
      { provider: 'longport', symbols: ['AAPL.US'], expected: ['AAPL'] },
      { provider: 'longport', symbols: ['invalid-symbol'], expected: [] }, // è¾¹ç•Œæƒ…å†µ
      { provider: 'longport', symbols: ['AApl.Us'], expected: ['AAPL'] }, // å¤§å°å†™
    ];
    
    for (const testCase of testCases) {
      // æ—§å®ç°ç»“æœ
      const oldResult = await oldSymbolMapperService.mapSymbols(testCase.provider, testCase.symbols);
      
      // æ–°å®ç°ç»“æœ
      const newRequest = SymbolTransformRequestDto.fromLegacy(testCase.provider, 'to_standard');
      newRequest.symbols = testCase.symbols;
      const newResult = await symbolTransformerService.transformSymbols(newRequest);
      
      // ç»“æœå¿…é¡»å®Œå…¨ä¸€è‡´
      expect(newResult.transformedSymbols).toEqual(oldResult.mappedSymbols);
      expect(newResult.mappingDetails).toEqual(oldResult.mappingDetails);
      expect(newResult.failedSymbols).toEqual(oldResult.failedSymbols);
    }
  });
});
```

#### 6.2 ä¸€è‡´æ€§å¿«ç…§æµ‹è¯•
```typescript
describe('Symbol Normalization Consistency', () => {
  const testCases = [
    // å¤§å°å†™å·®å¼‚
    { input: '700.hk', expected: '700.HK' },
    { input: 'aapl.us', expected: 'AAPL.US' },
    
    // åœ°åŸŸåç¼€æ ‡å‡†åŒ–
    { input: ' 700.HK ', expected: '700.HK' },  // trimå¤„ç†
    { input: 'BABA.US', expected: 'BABA.US' },
    
    // çº¯æ•°å­—Aè‚¡ç¬¦å·
    { input: '000001', expected: '000001' },    // æ·±äº¤æ‰€
    { input: '600000', expected: '600000' },    // ä¸Šäº¤æ‰€
    { input: '688001', expected: '688001' },    // ç§‘åˆ›æ¿
  ];
  
  testCases.forEach(({ input, expected }) => {
    it(`ç¬¦å·å½’ä¸€åŒ–ç­–ç•¥ä¿æŒä¸€è‡´: ${input} -> ${expected}`, async () => {
      // ä½¿ç”¨ç°æœ‰å·¥å…·ç±»è¿›è¡Œå½’ä¸€åŒ–æµ‹è¯•
      const result = SymbolValidationUtil.normalizeSymbol(input);
      expect(result).toBe(expected);
      
      // å¦‚æœ SymbolTransformerService æä¾›äº† normalizeSymbol æ–¹æ³•ï¼Œä¹Ÿè¿›è¡Œå¯¹æ¯”æµ‹è¯•
      if (symbolTransformerService.normalizeSymbol) {
        const serviceResult = await symbolTransformerService.normalizeSymbol(input);
        expect(serviceResult).toBe(result); // ç¡®ä¿æœåŠ¡å±‚ä¸å·¥å…·ç±»ä¸€è‡´
      }
    });
  });
});
```

#### 6.3 æ€§èƒ½æµ‹è¯•
```typescript
describe('Symbol Transformer Performance', () => {
  const performanceTests = [
    { name: 'å•ç¬¦å·', symbols: ['700.HK'] },
    { name: 'å°æ‰¹é‡', symbols: ['700.HK', 'AAPL.US', 'BABA.US', 'JD.US', 'NTES.US'] },
    { name: 'ä¸­æ‰¹é‡', symbols: generateTestSymbols(50) },
    { name: 'å¤§æ‰¹é‡', symbols: generateTestSymbols(500) }
  ];
  
  performanceTests.forEach(({ name, symbols }) => {
    it(`${name}è½¬æ¢æ€§èƒ½ä¸å›é€€`, async () => {
      const iterations = 10;
      const oldTimes = [];
      const newTimes = [];
      
      // æµ‹è¯•æ—§å®ç°æ€§èƒ½
      for (let i = 0; i < iterations; i++) {
        const start = Date.now();
        await oldSymbolMapperService.mapSymbols('longport', symbols);
        oldTimes.push(Date.now() - start);
      }
      
      // æµ‹è¯•æ–°å®ç°æ€§èƒ½
      for (let i = 0; i < iterations; i++) {
        const start = Date.now();
        await symbolTransformerService.transformSymbols('longport', symbols);
        newTimes.push(Date.now() - start);
      }
      
      const oldP95 = percentile(oldTimes, 0.95);
      const oldP99 = percentile(oldTimes, 0.99);
      const newP95 = percentile(newTimes, 0.95);
      const newP99 = percentile(newTimes, 0.99);
      
      // P95ã€P99ä¸å›é€€è¶…è¿‡20%
      expect(newP95).toBeLessThanOrEqual(oldP95 * 1.2);
      expect(newP99).toBeLessThanOrEqual(oldP99 * 1.2);
    });
  });
});
```

**ç›´æ¥æ¶æ„ä¼˜åŠ¿**ï¼š
- âš¡ **å®æ–½å‘¨æœŸ**ï¼š1-2å‘¨ï¼ˆæ— å…¼å®¹å±‚å¼€å‘ï¼‰
- ğŸ”§ **æ¶æ„æ¸…æ™°**ï¼šæ— å†å²åŒ…è¢±ï¼ŒèŒè´£åˆ†æ˜
- ğŸ›¡ï¸ **é™ä½å¤æ‚åº¦**ï¼šæ— éœ€ç»´æŠ¤å…¼å®¹ä»£ç 
- ğŸ¯ **ç›´æ¥åˆ‡æ¢**ï¼šè°ƒç”¨æ–¹ç›´æ¥ä½¿ç”¨æ–°æœåŠ¡
- ğŸ‘¨â€ğŸ’» **æ˜“äºç»´æŠ¤**ï¼šä»£ç ç»“æ„ç®€å•æ¸…æ™°

**æ ¸å¿ƒæˆæœ**ï¼š
âœ… è§£å†³èŒè´£æ··åˆé—®é¢˜ï¼ˆSymbolMapperService 43ä¸ªæ–¹æ³• â†’ è§„åˆ™ç®¡ç†30ä¸ª + è½¬æ¢æ‰§è¡Œ7ä¸ªï¼‰  
âœ… ä¿æŒé«˜æ•ˆæ¶æ„ï¼ˆä¸‰å±‚ç¼“å­˜ + Change Stream ç›‘æ§ä¿æŒä¸å˜ï¼‰  
âœ… æå‡ä»£ç å¯è¯»æ€§å’Œå¯æµ‹è¯•æ€§  
âœ… æœ€å°åŒ–å½±å“å’Œå®æ–½é£é™©

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
1. **âœ… P0**ï¼šStreamReceiverService è¿”å›ç»“æ„è¯¯ç”¨é—®é¢˜å·²ä¿®å¤
2. **ğŸ¯ P1**ï¼šå¼€å§‹å®æ–½é˜¶æ®µ1 - åˆ›å»º SymbolTransformerServiceï¼ˆ1å‘¨å†…å®Œæˆï¼‰

**å…³é”®æˆåŠŸè¦ç´ **ï¼š
- ä¸¥æ ¼æŒ‰ç…§å­—æ®µå£å¾„è¦æ±‚å®ç°ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•
- ç¡®ä¿è°ƒç”¨æ–¹ä»£ç é›¶æ”¹åŠ¨ï¼ˆReceiverServiceï¼‰æˆ–æœ€å°æ”¹åŠ¨ï¼ˆStreamReceiverServiceï¼‰
- ä¿æŒç°æœ‰ç¼“å­˜å’Œæ€§èƒ½ç‰¹å¾ä¸å˜

## ğŸ” ä»£ç å¯¹é½æ ¸æŸ¥ï¼ˆå®æ–½å‰å¿…è¯»ï¼‰

### å­—æ®µå£å¾„éªŒè¯ç»“æœ

**âœ… Receiverè°ƒç”¨é“¾éªŒè¯**ï¼š
- ç°çŠ¶ï¼š`SymbolMapperService.mapSymbols()` â†’ `{ mappedSymbols, mappingDetails, failedSymbols, metadata.processingTimeMs }`
- ç›®æ ‡ï¼š`SymbolTransformerService.transformSymbols()` â†’ ä¿æŒç›¸åŒç»“æ„
- å½±å“ï¼šReceiverService åç»­è½¬æ¢ä»£ç å¯å®Œå…¨ä¿æŒä¸å˜

**âœ… StreamReceiverè°ƒç”¨é“¾éªŒè¯**ï¼š
- ç°çŠ¶ï¼š`transformSymbolsForProvider()` â†’ `{ transformedSymbols, mappingResults.metadata.processingTime }`
- ç›®æ ‡ï¼šæ–°æœåŠ¡ä¿æŒç›¸åŒæ–¹æ³•ç­¾åå’Œè¿”å›ç»“æ„
- å½±å“ï¼šStreamReceiverService å¯é›¶æ”¹åŠ¨åˆ‡æ¢ï¼ˆå·²ä¿®å¤å–å€¼é€»è¾‘ï¼‰

### é¡ºåºè¯­ä¹‰è¯´æ˜
**å½“å‰è¡Œä¸º**ï¼š`mappedSymbols = Object.values(mappingDetails)` ä¸ä¿è¯ä¸è¾“å…¥é€ä¸€å¯¹åº”
**è°ƒç”¨æ–¹ä¾èµ–**ï¼šå½“å‰æ— è°ƒç”¨æ–¹ä¾èµ–ä½åºåŒ¹é…
**å¤„ç†ç­–ç•¥**ï¼šç»´æŒç°çŠ¶ï¼Œå¦‚æœªæ¥éœ€ä¸¥æ ¼æŒ‰åºå¯åœ¨æ–°æœåŠ¡ä¸­ä¼˜åŒ–

### ç¼“å­˜å’Œäº‹ä»¶æœºåˆ¶
**ä¿æŒä¸å˜**ï¼š
- `SymbolMapperCacheService` ä¸‰å±‚ç¼“å­˜æ¶æ„
- Change Stream ç›‘æ§æœºåˆ¶
- ç°æœ‰ç¼“å­˜å¤±æ•ˆé€»è¾‘
**æ— éœ€æ–°å¢**ï¼šäº‹ä»¶ç³»ç»Ÿã€é¢å¤–æ¥å£æŠ½è±¡å±‚

### å®æ–½å½±å“é¢è¯„ä¼°
**æœ€å°æ”¹åŠ¨ç‚¹**ï¼š
1. æ–°å¢1ä¸ªæœåŠ¡ç±»ï¼ˆSymbolTransformerServiceï¼‰
2. æ–°å¢1ä¸ªæ¨¡å—ï¼ˆSymbolTransformerModuleï¼‰  
3. ä¿®æ”¹2å¤„è°ƒç”¨æ–¹ï¼ˆReceiverService + StreamReceiverServiceï¼‰
4. æ¸…ç†1ä¸ªæœåŠ¡ç±»ï¼ˆSymbolMapperService åˆ é™¤æ‰§è¡Œæ–¹æ³•ï¼‰

**é£é™©æ§åˆ¶**ï¼š
- ä½¿ç”¨ç›¸åŒç¼“å­˜è·¯å¾„ï¼Œæ€§èƒ½ç­‰ä»·
- å­—æ®µç»“æ„å®Œå…¨å¯¹é½ï¼Œæ— å…¼å®¹æ€§é—®é¢˜
- å¯åˆ†é˜¶æ®µå®æ–½ï¼Œæ¯é˜¶æ®µå¯å›æ»š

## ğŸ”„ æ•°æ®æµå…¼å®¹æ€§éªŒè¯

### ä¸ç°æœ‰æ•°æ®æµçš„å…¼å®¹æ€§åˆ†æ

åŸºäº`docs/å®Œæ•´çš„æ•°æ®æµåœºæ™¯å®æ™¯è¯´æ˜.md`çš„åˆ†æï¼Œæ–°æ¶æ„å®Œå…¨å…¼å®¹ç°æœ‰æ•°æ®æµï¼š

#### **å½“å‰æ•°æ®æµ**
```
Receiver â†’ Smart Cacheæ£€æŸ¥(âŒ) â†’ executeOriginalDataFlow() 
â†’ Symbol Mapper (ä¸‰å±‚ç¼“å­˜å¤„ç†ï¼Œè¿”å›æ˜ å°„ç»“æœ{700.HKâ†’00700})
â†’ Data Fetcher â†’ Transformer â†’ Storage â†’ è¿”å›æ•°æ®
```

#### **æ‹†åˆ†åæ•°æ®æµ**  
```
Receiver â†’ Smart Cacheæ£€æŸ¥(âŒ) â†’ executeOriginalDataFlow()
â†’ Symbol Mapper (è§„åˆ™æŸ¥è¯¢å’Œç®¡ç†) 
â†’ Symbol Transformer (ä¸‰å±‚ç¼“å­˜å¤„ç†ï¼Œè¿”å›æ˜ å°„ç»“æœ{700.HKâ†’00700})
â†’ Data Fetcher â†’ Transformer â†’ Storage â†’ è¿”å›æ•°æ®
```

#### **å…¼å®¹æ€§ä¿éšœ**
1. **ç¼“å­˜å±‚å®Œå…¨ä¿æŒ**ï¼šL1è§„åˆ™ + L2ç¬¦å· + L3æ‰¹é‡ä¸‰å±‚ç¼“å­˜æ¶æ„ä¸å˜
2. **æ€§èƒ½ç‰¹å¾ä¸€è‡´**ï¼šå“åº”æ—¶é—´å’Œç¼“å­˜å‘½ä¸­ç‡ä¿æŒç°æœ‰æ°´å¹³
3. **è°ƒç”¨æ–¹ç›´æ¥åˆ‡æ¢åˆ°æ–°æœåŠ¡ï¼Œå­—æ®µå£å¾„ä¿æŒä¸€è‡´**
4. **æ•°æ®æµä½ç½®ä¸å˜**ï¼šç¬¦å·å¤„ç†ä»åœ¨Data Fetcherä¹‹å‰æ‰§è¡Œ
5. **Smart Cacheé›†æˆ**ï¼šä¸Smart Cache + Common Cacheçš„ååŒå·¥ä½œä¸å—å½±å“

#### **æ¶æ„ä¼˜åŠ¿**
- **èŒè´£æ¸…æ™°**ï¼šè§„åˆ™ç®¡ç†(00-prepare) vs è§„åˆ™æ‰§è¡Œ(02-processing)åˆ†ç¦»  
- **ä¸Transformerä¸€è‡´**ï¼šSymbol Transformerä¸Data Transformeréƒ½åœ¨02-processing
- **æœ€å°åŒ–å½±å“**ï¼šæ ¸å¿ƒæ•°æ®æµç¨‹åºä¸å˜ï¼Œä»…å†…éƒ¨å®ç°é‡æ„

## âœ… å®æ–½æ£€æŸ¥æ¸…å•ï¼ˆæ— å…¼å®¹å±‚ç‰ˆæœ¬ï¼‰

### ğŸ”´ P0 é˜»å¡é—®é¢˜ä¿®å¤ï¼ˆå¿…é¡»ä¼˜å…ˆå®Œæˆï¼‰
- [x] **ä¿®å¤ StreamReceiverService è¿”å›ç»“æ„è¯¯ç”¨**ï¼ˆå·²åœ¨ä»£ç ä¸­ä¿®å¤ï¼‰
  ```typescript
  // æ–‡ä»¶ï¼šsrc/core/01-entry/stream-receiver/services/stream-receiver.service.ts
  // æ–¹æ³•ï¼šmapSymbols()
  // å·²ä¿®å¤ï¼šconst finalSymbol = mappedResult?.transformedSymbols?.[0] ?? symbol;
  ```

### é˜¶æ®µ1ï¼šåˆ›å»º SymbolTransformerService
- [ ] åˆ›å»ºç›®å½• `src/core/02-processing/symbol-transformer/{services,module,interfaces,dto}`
  - æ³¨ï¼š`dto` ç›®å½•å¯é€‰ï¼Œæœ¬æ–¹æ¡ˆæ— éœ€æ–°DTO
- [ ] å®ç° `SymbolTransformerService` åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š
  - [ ] `transformSymbols(provider, symbols)` â†’ è¿”å›ä¸ç°æœ‰ `mapSymbols()` å®Œå…¨ç›¸åŒçš„ç»“æ„
  - [ ] `transformSingleSymbol(provider, symbol)` â†’ åŸºäº `transformSymbols()` å–ç¬¬ä¸€ä¸ª
  - [ ] `transformSymbolsForProvider(provider, symbols, requestId)` â†’ è¿”å›ä¸ç°æœ‰å®ç°ä¸€è‡´çš„ç»“æ„
- [ ] ç¡®ä¿è¿”å›å­—æ®µå£å¾„ï¼š
  - [ ] `transformSymbols()` è¿”å› `metadata.processingTimeMs`ï¼ˆæ¯«ç§’ï¼‰
  - [ ] `transformSymbolsForProvider()` è¿”å› `mappingResults.metadata.processingTime`ï¼ˆæ¯«ç§’ï¼‰
- [ ] å†…éƒ¨ä¾èµ– `SymbolMapperCacheService.mapSymbols()`ï¼Œä¸ç›´æ¥è®¿é—®ä»“å‚¨

### é˜¶æ®µ2ï¼šæ›´æ–°è°ƒç”¨æ–¹
- [ ] **ReceiverService**ï¼š
  - [ ] æ³¨å…¥ `SymbolTransformerService`
  - [ ] æ›¿æ¢ `this.symbolMapperService.mapSymbols()` â†’ `this.symbolTransformerService.transformSymbols()`
  - [ ] ä¿æŒåç»­å­—æ®µè½¬æ¢ä»£ç ä¸å˜ï¼ˆå­—æ®µå·²å¯¹é½ï¼‰
- [ ] **StreamReceiverService**ï¼š
  - [ ] æ³¨å…¥ `SymbolTransformerService`  
  - [ ] ä¿æŒè°ƒç”¨ `transformSymbolsForProvider()`ï¼ˆé›¶æ”¹åŠ¨ï¼Œå­—æ®µå£å¾„å®Œå…¨ä¸€è‡´ï¼‰
  - [ ] ç¡®è®¤è¿”å›å€¼æå–æ­£ç¡®ï¼š`result.transformedSymbols[0]`

### é˜¶æ®µ3ï¼šæ¸…ç† SymbolMapperService
- [ ] åˆ é™¤æ‰§è¡Œå±‚æ–¹æ³•ï¼š
  - [ ] `mapSymbol()`, `mapSymbols()`, `transformSymbols()`
  - [ ] `transformSymbolsById()`, `transformSymbolsForProvider()`
  - [ ] `_executeSymbolTransformation()`, `applySymbolMappingRule()`
- [ ] åˆ é™¤ç›¸å…³çŠ¶æ€ï¼ˆå¦‚æ— å…¶ä»–ä½¿ç”¨ï¼‰ï¼š
  - [ ] `unifiedCache`
  - [ ] `pendingQueries`
- [ ] ä¿ç•™è§„åˆ™ç®¡ç†èŒè´£ï¼š
  - [ ] è§„åˆ™ CRUD æ–¹æ³•
  - [ ] æŸ¥è¯¢å’Œåˆ†é¡µæ–¹æ³•
  - [ ] Change Stream ç›‘æ§

### é˜¶æ®µ4ï¼šæ¨¡å—è£…é…
- [ ] åˆ›å»º `SymbolTransformerModule`
- [ ] åœ¨ `ReceiverModule` å¯¼å…¥ `SymbolTransformerModule`
- [ ] åœ¨ `StreamReceiverModule` å¯¼å…¥ `SymbolTransformerModule`
- [ ] ç¡®è®¤ä¾èµ–æ³¨å…¥æ­£å¸¸å·¥ä½œï¼ˆåªæ³¨å…¥ SymbolMapperCacheServiceï¼Œé¿å…ç›´æ¥ä»“å‚¨è®¿é—®ï¼‰

### éªŒè¯æµ‹è¯•æ¸…å•
- [ ] **ç­‰ä»·æ€§æµ‹è¯•**ï¼šâš ï¸ **å¿…é¡»åœ¨æ¸…ç† SymbolMapperService æ‰§è¡Œæ–¹æ³•å‰å®Œæˆ**
  - [ ] `SymbolTransformerService.transformSymbols()` vs æ—§ `SymbolMapperService.mapSymbols()` å››å­—æ®µå®Œå…¨ä¸€è‡´
  - [ ] ç‰¹åˆ«éªŒè¯ `metadata.processingTimeMs` å­—æ®µå‡†ç¡®æ€§
  - [ ] æ¸…ç†åéœ€è¦è·³è¿‡æˆ–æ›¿æ¢å¯¹æ—§å®ç°çš„æ¯”å¯¹æµ‹è¯•
- [ ] **æµå¼åœºæ™¯æµ‹è¯•**ï¼š
  - [ ] `transformSymbolsForProvider()` è¿”å›ç»“æ„å®Œæ•´æ€§
  - [ ] StreamReceiverService å–å€¼é€»è¾‘æ­£ç¡®ï¼ˆ`result.transformedSymbols[0]`ï¼‰
- [ ] **æ€§èƒ½æµ‹è¯•**ï¼šP95/P99ä¸å›é€€è¶…è¿‡20%ï¼ˆåŸºäºç›¸åŒç¼“å­˜è·¯å¾„ï¼‰
- [ ] **å›å½’æµ‹è¯•**ï¼š
  - [ ] å…¨åº“æœç´¢ç¡®è®¤æ— å¼•ç”¨å·²åˆ é™¤çš„æ—§æ‰§è¡Œæ–¹æ³•
  - [ ] `*symbol-mapper-cache*` æµ‹è¯•ä¿æŒä¸å˜ä¸”é€šè¿‡

### æ¸…ç†éªŒæ”¶æ¸…å•ï¼ˆé˜¶æ®µ3å®Œæˆåï¼‰
- [ ] **SymbolMapperService å·²åˆ é™¤æ‰§è¡Œå±‚æ–¹æ³•**ï¼š
  - [ ] `mapSymbol`, `mapSymbols`, `transformSymbols`
  - [ ] `transformSymbolsById`, `transformSymbolsForProvider`  
  - [ ] `_executeSymbolTransformation`, `applySymbolMappingRule`
- [ ] **å·²åˆ é™¤ä»…æœåŠ¡æ—§æ‰§è¡Œè·¯å¾„çš„å­—æ®µä¸ç§æœ‰æ–¹æ³•**ï¼š
  - [ ] `unifiedCache`ï¼ˆå¦‚æ— å…¶ä»–ä½¿ç”¨ï¼‰
  - [ ] `pendingQueries`ï¼ˆå¦‚æ— å…¶ä»–ä½¿ç”¨ï¼‰
  - [ ] å…¨åº“æœç´¢ç§»é™¤æ—§æ–¹æ³•å¼•ç”¨ï¼Œé¿å…ç¼–è¯‘é”™è¯¯
- [ ] **ä¿ç•™çš„è§„åˆ™ç®¡ç†åŠŸèƒ½æ­£å¸¸**ï¼š
  - [ ] è§„åˆ™ CRUD æ“ä½œ
  - [ ] æŸ¥è¯¢å’Œåˆ†é¡µåŠŸèƒ½
  - [ ] Change Stream ç›‘æ§å’Œç¼“å­˜å¤±æ•ˆ

## ğŸ“Š é¢„æœŸæ”¶ç›Š

### æ¶æ„æ”¶ç›Š
1. **èŒè´£æ¸…æ™°**ï¼šè§„åˆ™åˆ¶å®š vs è§„åˆ™æ‰§è¡Œå®Œå…¨åˆ†ç¦»
2. **æ¶æ„ä¸€è‡´**ï¼šä¸Data Mapper + Transformerä¿æŒä¸€è‡´  
3. **ç¼“å­˜çº¯åŒ–**ï¼šç¼“å­˜å±‚ä¸“æ³¨ç¼“å­˜ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
4. **æ¥å£ç»Ÿä¸€**ï¼šæ ‡å‡†åŒ–çš„è½¬æ¢æ¥å£å’Œæ•°æ®ç»“æ„

### æ€§èƒ½æ”¶ç›Š
1. **ç¼“å­˜ä¼˜åŒ–**ï¼šä¸“é—¨çš„ç¼“å­˜å±‚ï¼Œæ€§èƒ½æ›´å¥½
2. **å¹¶å‘å¤„ç†**ï¼šè½¬æ¢æœåŠ¡å¯ç‹¬ç«‹æ‰©å±•
3. **ç›‘æ§æ”¹è¿›**ï¼šæ›´ç²¾ç¡®çš„æ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡

### ç»´æŠ¤æ”¶ç›Š  
1. **æµ‹è¯•ç®€åŒ–**ï¼šç»„ä»¶èŒè´£å•ä¸€ï¼Œæµ‹è¯•æ›´å®¹æ˜“
2. **æ‰©å±•æ€§**ï¼šæ–°çš„è½¬æ¢ç®—æ³•å¯ç‹¬ç«‹å¼€å‘
3. **è°ƒè¯•å‹å¥½**ï¼šé—®é¢˜å®šä½æ›´ç²¾ç¡®

### è§‚æµ‹æ€§å’Œå…¼å®¹æ€§ä¿éšœ

#### **æŒ‡æ ‡å‘½åä¸æ˜ å°„å…³ç³»**
```typescript
// ä¿æŒç°æœ‰æŒ‡æ ‡è¯­ä¹‰ä¸å˜ï¼Œæ–°å¢æŒ‡æ ‡å»ºç«‹æ˜ å°„å…³ç³»
class SymbolTransformerService {
  private recordMetrics(provider: string, result: SymbolDataTransformResponseDto) {
    // æ²¿ç”¨æ—§æŒ‡æ ‡å£å¾„ï¼ˆé¿å…Dashboardå¤±è”ï¼‰
    const hitRate = result.metadata.cacheHits / result.metadata.totalSymbols;
    this.metricsRegistry.setGauge('symbol_cache_hit_rate', hitRate, { provider }); // ä¿æŒåŸå
    
    // è½¬æ¢è€—æ—¶ï¼ˆä¸æ—§ç³»ç»Ÿä¿æŒç›¸åŒå£å¾„ï¼‰
    this.metricsRegistry.histogram('symbol_processing_time', 
      result.metadata.processingTimeMs, { provider, type: 'transform' }); // ä¿æŒåŸå
    
    // å¤±è´¥ç‡
    const failureRate = result.metadata.failedCount / result.metadata.totalSymbols;
    this.metricsRegistry.setGauge('symbol_failure_rate', failureRate, { provider }); // ä¿æŒåŸå
    
    // æ–°å¢æŒ‡æ ‡ï¼ˆä¸ç›‘æ§æ–‡æ¡£å»ºç«‹æ˜ å°„å…³ç³»ï¼‰
    this.metricsRegistry.inc('symbol_transformer_requests_total', { provider, status: 'success' });
    this.metricsRegistry.inc('symbol_transformer_cache_operations', { provider, operation: 'hit' }, result.metadata.cacheHits);
  }
  
  // é™çº§æŒ‡æ ‡è®°å½•
  private recordFallbackMetrics(provider: string, error: Error, symbolCount: number) {
    this.metricsRegistry.inc('symbol_transformer_fallback_total', { 
      provider, 
      error_type: error.constructor.name,
      symbol_count_bucket: this.getSymbolCountBucket(symbolCount)
    });
  }
}
```

**æŒ‡æ ‡æ˜ å°„æ–‡æ¡£**ï¼ˆéœ€æ·»åŠ åˆ°ç›‘æ§æ–‡æ¡£ï¼‰ï¼š
- `symbol_cache_hit_rate` â† åŸ `symbol_mapper_cache_hit_rate`
- `symbol_processing_time` â† åŸ `symbol_mapper_processing_time` 
- `symbol_failure_rate` â† åŸ `symbol_mapper_failure_rate`
- `symbol_transformer_*` â† æ–°å¢æŒ‡æ ‡ï¼Œç”¨äºSymbol Transformerä¸“ç”¨ç›‘æ§

**æ–°æ—§æŒ‡æ ‡é‡å æœŸåŒå†™ç­–ç•¥**ï¼š
```typescript
// æŒ‡æ ‡åŒå†™ï¼šåŒæ—¶ä¸ŠæŠ¥æ–°æ—§æŒ‡æ ‡åï¼Œé¿å…ç›‘æ§ç©ºçª—
private recordMetrics(provider: string, result: SymbolDataTransformResponseDto) {
  const hitRate = result.metadata.cacheHits / result.metadata.totalSymbols;
  
  // åŒå†™ï¼šä¿æŒæ—§æŒ‡æ ‡å + æ–°æŒ‡æ ‡å
  this.metricsRegistry.setGauge('symbol_cache_hit_rate', hitRate, { provider }); // æ—§æŒ‡æ ‡ä¿æŒ
  this.metricsRegistry.setGauge('symbol_transformer_cache_hit_rate', hitRate, { provider }); // æ–°æŒ‡æ ‡å
  
  // Dashboardåˆ‡æ¢å®Œæˆåï¼Œé€šè¿‡FeatureFlagæ§åˆ¶ä¸‹çº¿æ—§æŒ‡æ ‡
  if (!this.featureFlags.enableLegacyMetrics) {
    // åœæ­¢ä¸ŠæŠ¥æ—§æŒ‡æ ‡å
  }
}
```

#### **ç°åº¦æ”¾é‡æ§åˆ¶**
```typescript
// Feature Flagsé…ç½®
interface SymbolTransformerFeatureFlags {
  enableSymbolTransformer: boolean;           // ä¸»å¼€å…³
  symbolTransformerTrafficPercentage: number; // æµé‡ç™¾åˆ†æ¯” 0-100
  enableSymbolTransformerDebugApi: boolean;   // è°ƒè¯•APIå¼€å…³
  symbolTransformerFallbackEnabled: boolean;  // é™çº§å¼€å…³
}

// æµé‡åˆ†é…é€»è¾‘
class SymbolMapperService {
  async mapSymbols(provider: string, symbols: string[], requestId?: string) {
    const shouldUseNewService = this.featureFlags.enableSymbolTransformer &&
      this.shouldRouteToNewService(requestId);
    
    if (shouldUseNewService) {
      try {
        return await this.routeToSymbolTransformer(provider, symbols, requestId);
      } catch (error) {
        if (this.featureFlags.symbolTransformerFallbackEnabled) {
          // è®°å½•é™çº§æŒ‡æ ‡
          this.recordFallbackMetrics(provider, error, symbols.length);
          this.logger.warn('Symbol Transformer failed, fallback to legacy', { 
            error: error.message, 
            provider, 
            symbolsCount: symbols.length,
            requestId 
          });
          return await this.legacyMapSymbols(provider, symbols, requestId);
        }
        throw error;
      }
    } else {
      return await this.legacyMapSymbols(provider, symbols, requestId);
    }
  }
  
  // å¤šç»´è·¯ç”±ç­–ç•¥å¼€å…³ï¼ˆæ˜ç¡®ä¼˜å…ˆçº§ï¼‰
  private shouldRouteToNewService(requestId: string, userId?: string, symbols?: string[]): boolean {
    const flags = this.featureFlags;
    let routingDecision = { method: 'none', enabled: false };
    
    // ä¼˜å…ˆçº§1ï¼šç”¨æˆ·ç™½åå• > å…¶ä»–ç­–ç•¥
    if (flags.symbolTransformerUserWhitelist && userId) {
      const inWhitelist = flags.symbolTransformerUserWhitelist.includes(userId);
      routingDecision = { method: 'user_whitelist', enabled: inWhitelist };
      this.recordRoutingMetrics('user_whitelist', inWhitelist, { userId, requestId });
      return inWhitelist;
    }
    
    // ä¼˜å…ˆçº§2ï¼šå¸‚åœºè·¯ç”± > ç™¾åˆ†æ¯”è·¯ç”±
    if (flags.symbolTransformerMarketRouting && symbols?.length) {
      const markets = this.extractMarkets(symbols);
      const hasEnabledMarket = flags.symbolTransformerEnabledMarkets && 
        markets.some(market => flags.symbolTransformerEnabledMarkets.includes(market));
      
      if (!hasEnabledMarket) {
        routingDecision = { method: 'market_routing', enabled: false };
        this.recordRoutingMetrics('market_routing', false, { markets, requestId });
        return false; // å¸‚åœºæœªå¼€æ”¾ï¼Œç›´æ¥æ‹’ç»
      }
    }
    
    // ä¼˜å…ˆçº§3ï¼šæŒ‰ç™¾åˆ†æ¯”è·¯ç”±ï¼ˆæœ€åå…œåº•ï¼‰
    const percentage = flags.symbolTransformerTrafficPercentage || 0;
    const hash = crypto.createHash('md5').update(requestId || Date.now().toString()).digest('hex');
    const hashNum = parseInt(hash.substring(0, 8), 16);
    const enabled = (hashNum % 100) < percentage;
    
    routingDecision = { method: 'percentage', enabled };
    this.recordRoutingMetrics('percentage', enabled, { percentage, hashNum: hashNum % 100, requestId });
    
    return enabled;
  }
  
  // è·¯ç”±å†³ç­–æŒ‡æ ‡è®°å½•ï¼ˆåˆ†å¸ƒå¯è§‚æµ‹ï¼‰
  private recordRoutingMetrics(method: string, enabled: boolean, context: any): void {
    this.metricsRegistry.inc('symbol_transformer_routing_decisions_total', {
      method,
      decision: enabled ? 'enabled' : 'disabled',
      percentage_bucket: method === 'percentage' ? this.getPercentageBucket(context.percentage) : 'n/a'
    });
  }
  
  private extractMarkets(symbols: string[]): string[] {
    return symbols.map(symbol => {
      if (symbol.endsWith('.HK')) return 'HK';
      if (symbol.endsWith('.US')) return 'US';
      if (symbol.startsWith('00') || symbol.startsWith('30')) return 'SZ';
      if (symbol.startsWith('60') || symbol.startsWith('68')) return 'SH';
      return 'UNKNOWN';
    });
  }
}
```

## âš ï¸ é£é™©æ§åˆ¶

### è¿ç§»é£é™©
1. **æ¥å£å…¼å®¹**ï¼šæ–°æ¥å£å¿…é¡»å‘ä¸‹å…¼å®¹ï¼Œä¿æŒç°æœ‰è°ƒç”¨æ–¹å¼ä¸å˜
2. **æ€§èƒ½å›å½’**ï¼šP95/P99å“åº”æ—¶é—´ä¸èƒ½å›é€€è¶…è¿‡20%
3. **æ•°æ®ä¸€è‡´**ï¼šè½¬æ¢ç»“æœå¿…é¡»ä¸ç°æœ‰å®ç°å®Œå…¨ä¸€è‡´
4. **ç¼“å­˜å¤±æ•ˆ**ï¼šè§„åˆ™å˜æ›´åç¼“å­˜å¿…é¡»ç²¾å‡†å¤±æ•ˆå¹¶å³æ—¶ç”Ÿæ•ˆ
5. **æ‰§è¡Œå±‚ä¾èµ–è¾¹ç•Œ**ï¼šæ‰§è¡Œå±‚ä¸ç›´æ¥è®¿é—®ä»“å‚¨ï¼Œç»Ÿä¸€é€šè¿‡ `SymbolMapperCacheService` å›æºå¹¶ç¼“å­˜

### é£é™©ç¼“è§£
1. **åˆ†é˜¶æ®µè¿ç§»**ï¼š3é˜¶æ®µé€æ­¥å®æ–½ï¼Œæ¯é˜¶æ®µéƒ½æœ‰å›æ»šç‚¹
2. **ç°åº¦æ”¾é‡**ï¼šé€šè¿‡æµé‡ç™¾åˆ†æ¯”æ§åˆ¶ï¼Œä»5% â†’ 20% â†’ 50% â†’ 100%
3. **A/Bå¯¹æ¯”éªŒè¯**ï¼šè¿ç§»æœŸé—´æ–°è€ç³»ç»Ÿå¹¶è¡Œè¿è¡Œï¼Œå®æ—¶å¯¹æ¯”ç»“æœ
4. **é™çº§æœºåˆ¶**ï¼šæ–°æœåŠ¡å¼‚å¸¸æ—¶è‡ªåŠ¨é™çº§åˆ°æ—§å®ç°
5. **ç›‘æ§å‘Šè­¦**ï¼šå…³é”®æŒ‡æ ‡å®æ—¶ç›‘æ§ï¼Œå¼‚å¸¸ç«‹å³å‘Šè­¦
6. **å›æ»šé¢„æ¡ˆ**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½ä¿ç•™å®Œæ•´çš„å›æ»šæ–¹æ¡ˆ

## ğŸ—“ï¸ å®æ–½æ—¶é—´çº¿

- **Week 1**ï¼šé˜¶æ®µ1-2ï¼Œåˆ›å»ºç»„ä»¶å¹¶è¿ç§»æ ¸å¿ƒé€»è¾‘
- **Week 2**ï¼šé˜¶æ®µ3-4ï¼Œé‡æ„ç¼“å­˜å’Œæ¸…ç†Symbol Mapper  
- **Week 3**ï¼šé˜¶æ®µ5ï¼Œæ›´æ–°æ‰€æœ‰ä¾èµ–è°ƒç”¨
- **Week 4**ï¼šé˜¶æ®µ6ï¼Œæµ‹è¯•éªŒè¯å’Œæ€§èƒ½å¯¹æ¯”

## ğŸ“ æ€»ç»“

é€šè¿‡è¿™ä¸ªæ— å…¼å®¹å±‚çš„æ‹†åˆ†æ–¹æ¡ˆï¼Œæˆ‘ä»¬å°†å®ç°ï¼š
- **è§„åˆ™åˆ¶å®šå™¨**ï¼šSymbol Mapperä¸“æ³¨æ˜ å°„è§„åˆ™ç®¡ç†ï¼ˆCRUD + Change Streamç›‘æ§ï¼‰
- **è§„åˆ™æ‰§è¡Œå™¨**ï¼šSymbol Transformerä¸“é—¨å¤„ç†ç¬¦å·è½¬æ¢ï¼ˆå¤ç”¨ç°æœ‰ç¼“å­˜è·¯å¾„ï¼‰
- **è°ƒç”¨æ–¹å½±å“**ï¼šæœ€å°åŒ–æ”¹åŠ¨ï¼Œä¿æŒå­—æ®µå£å¾„ä¸€è‡´

### å®æ–½ä¼˜åŠ¿
- **æ—¶é—´æœ€çŸ­**ï¼š1-2å‘¨å®Œæˆï¼Œæ— å…¼å®¹å±‚å¼€å‘æˆæœ¬
- **é£é™©å¯æ§**ï¼š4ä¸ªæœ€å°æ”¹åŠ¨ç‚¹ï¼Œæ¯é˜¶æ®µå¯å›æ»š
- **æ¶æ„æ¸…æ™°**ï¼šèŒè´£åˆ†ç¦»å½»åº•ï¼Œä¸Data Mapper + Transformerä¿æŒä¸€è‡´
- **æ€§èƒ½ä¿æŒ**ï¼šä½¿ç”¨ç›¸åŒç¼“å­˜æœºåˆ¶ï¼ŒP95/P99ä¸å›é€€

### å…³é”®æé†’
âš ï¸ **å®æ–½å‰å¿…é¡»é˜…è¯»"ä»£ç å¯¹é½æ ¸æŸ¥"ç« èŠ‚ï¼Œç¡®ä¿å­—æ®µå£å¾„ä¸¥æ ¼åŒ¹é…**

ğŸ¯ **æ ¸å¿ƒç›®æ ‡**ï¼šé›¶å†å²åŒ…è¢±çš„èŒè´£åˆ†ç¦»ï¼Œä¸ºå…¨æ–°é¡¹ç›®å¥ å®šæ¸…æ™°çš„æ¶æ„åŸºç¡€