bun run lint
bun run lint --fix   ESLint 错误检查
npx tsc --noEmit --skipLibCheck  TypeScript 编译检查

风格检查与修复
 bun run format:check
 bun prettier --write "src/**/*.ts" "test/**/*.ts"


bun test:coverage:all

 ESM 与 CommonJS  混用。

 利用了 TypeScript 在构建时将 ESM 语法转译为 CommonJS 的能力

 项目应该是使用的 CommonJS！

 启动 开发模式
 bun run dev


我将切换到仓库目录，检查变更并执行提交与推送。
cd /Users/honor/Documents/code/newstockapi/backend && git rev-parse --is-inside-work-tree && git status --porcelain | cat
git add -A && git commit -m "消除部分字段的歧义，制定统一的字段命名规则" && git push




缓存可能有错误
好的，现在我们知道：
  1. 测试使用了正确的 queryTypeFilter: "get-stock-quote"
  2. 数据已经成功存储在数据库中，包含了转换后的数据结构（有 symbol, lastPrice, volume 字段）

  让我深入分析 Query 组件为什么没有返回正确的数据：

⏺ serena - find_symbol (MCP)(name_path: "QueryService/tryGetFromCache", relative_path: "src/core/restapi/query", include_body: true)
  ⎿  [                                               
       {
         "name_path": "QueryService/tryGetFromCache",
     … +18 lines (ctrl+r to expand)

⏺ 关键问题在于 Query 组件构建的 storageKey 与 Receiver 存储时使用的 key 不匹配！

  让我查看 Query 如何构建 key：

⏺ Read(src/core/restapi/query/services/query.service.ts)
  ⎿  Read 15 lines (ctrl+r to expand)

⏺ 现在我看到问题了！

  问题分析：Key 格式不匹配

  Receiver 存储的 key：

  stock_data_longport_get-stock-quote_759bdbf2-015a-4566-a70b-bd308f187585

  Query 查询的 key（通过 buildStorageKey 构建）：

  US:*:get-stock-quote:AMD.US
  或者如果没有指定 provider：
  *:*:get-stock-quote:AMD.US

  这两个 key 完全不同！

  Query 使用 buildStorageKey 函数构建的 key 格式是：
  const parts = [market ?? "*", provider ?? "*", queryTypeFilter ?? "*", symbol];
  return parts.join(":");

  而 Receiver 存储时使用的 key 格式是：
  `stock_data_${provider}_${request.receiverType}_${requestId}`

  根本原因

  架构设计问题：
  1. Receiver 使用基于 requestId 的唯一 key 存储数据
  2. Query 使用基于 symbol 的查询 key 检索数据
  3. 这两种 key 格式根本无法匹配

  所以即使数据已经存储在数据库中，Query 也无法找到它，因为它在寻找错误格式的 key。

  解决方案

  系统需要统一 key 格式，要么：
  1. Receiver 改用 symbol-based key：stock_data_${provider}_${receiverType}_${symbol}
  2. 或者建立索引机制：允许通过 symbol 查询使用 requestId 存储的数据

  这是一个严重的架构设计缺陷，导致 Query 组件永远无法找到 Receiver 存储的数据。