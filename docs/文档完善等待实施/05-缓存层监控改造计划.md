# ç¼“å­˜å±‚ç›‘æ§æ”¹é€ è¯¦ç»†è®¡åˆ’

## 1. æ”¹é€ èƒŒæ™¯

### 1.1 ç°çŠ¶åˆ†æ

| ç¼“å­˜å­ç»„ä»¶ | å½“å‰ç›‘æ§å®ç° | é—®é¢˜ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ |
|------------|-------------|-------------|----------|
| **CommonCache** | Mock Registry â†’ console.debug | ğŸ”´ ä¸¥é‡ | 80%åŸºç¡€æ“ä½œæ— ç›‘æ§ |
| **SymbolMapperCache** | ç›´æ¥æ³¨å…¥MetricsRegistryService | ğŸŸ¡ ä¸­ç­‰ | æ¶æ„è¿è§„ï¼Œè·¨å±‚è°ƒç”¨ |
| **DataMapperCache** | ç§æœ‰metricså¯¹è±¡ | ğŸŸ¡ ä¸­ç­‰ | ç›‘æ§æ•°æ®å­¤å²› |
| **StreamCache** | ç§æœ‰statsç»Ÿè®¡ | ğŸŸ¡ ä¸­ç­‰ | ç¼ºå¤±å…³é”®æŒ‡æ ‡ |
| **SmartCache** | æ³¨å…¥presenterRegistryService | ğŸŸ¡ ä¸­ç­‰ | æ¶æ„æ··ä¹± |

### 1.2 æ¶æ„è¿è§„é—®é¢˜

å½“å‰å®ç°è¿åäº†ç›‘æ§ç»„ä»¶çš„4å±‚æ¶æ„è®¾è®¡åŸåˆ™ï¼š
- âŒ ä¸šåŠ¡ç»„ä»¶ç›´æ¥ä½¿ç”¨Infrastructureå±‚çš„MetricsRegistryService
- âŒ ä½¿ç”¨Mock Registryå¯¼è‡´ç›‘æ§å¤±æ•ˆ
- âŒ ç§æœ‰ç»Ÿè®¡å¯¹è±¡é€ æˆç›‘æ§å­¤å²›
- âŒ æ··ç”¨Presenterå±‚å’ŒInfrastructureå±‚æœåŠ¡

æ­£ç¡®çš„æ¶æ„è°ƒç”¨å…³ç³»ï¼š
```
ä¸šåŠ¡ç»„ä»¶ â†’ CollectorService â†’ MetricsRegistryService â†’ Prometheus
```

## 2. æ”¹é€ ç›®æ ‡

1. âœ… **ç»Ÿä¸€ä½¿ç”¨CollectorService** - æ‰€æœ‰ç¼“å­˜ç»„ä»¶åªä¸Collectorå±‚äº¤äº’
2. âœ… **ä¸šåŠ¡è¯­ä¹‰åŒ–æ¥å£** - ä½¿ç”¨recordCacheOperationç­‰ä¸šåŠ¡å‹å¥½æ–¹æ³•
3. âœ… **ç§»é™¤Infrastructureå±‚ä¾èµ–** - ä¸å†ç›´æ¥æ³¨å…¥MetricsRegistryService
4. âœ… **ç§»é™¤Mock Registry** - ä¸å†ä½¿ç”¨console.debugå¼çš„å‡ç›‘æ§
5. âœ… **ç§»é™¤ç§æœ‰stats** - ä¸å†è‡ªå»ºå­¤ç«‹çš„ç›‘æ§ç»Ÿè®¡
6. âœ… **å¼‚æ­¥ç›‘æ§** - ç›‘æ§å¤±è´¥ä¸å½±å“ç¼“å­˜ä¸šåŠ¡é€»è¾‘
7. âœ… **å¯¼å…¥MonitoringModule** - ç¡®ä¿CollectorServiceå¯ç”¨

## 3. æ”¹é€ è®¡åˆ’

### é˜¶æ®µ1ï¼šCommonCacheç»„ä»¶æ”¹é€ ï¼ˆä¼˜å…ˆçº§ï¼šæœ€é«˜ï¼‰

#### 3.1.1 ç§»é™¤Mock Registry
**æ–‡ä»¶**: `src/core/05-caching/common-cache/module/common-cache.module.ts`

**æ”¹é€ å†…å®¹**:
- ç§»é™¤METRICS_REGISTRY providerå®šä¹‰ï¼ˆç¬¬76-92è¡Œï¼‰
- å¯¼å…¥MonitoringModule
- ä»exportsä¸­ç§»é™¤METRICS_REGISTRY

#### 3.1.2 æœåŠ¡å±‚æ”¹é€ 
**æ–‡ä»¶**: `src/core/05-caching/common-cache/services/common-cache.service.ts`

**æ”¹é€ å†…å®¹**:
- ç§»é™¤`@Inject('METRICS_REGISTRY')`æ³¨å…¥
- æ³¨å…¥CollectorServiceæ›¿ä»£
- æ”¹é€ recordMetricsæ–¹æ³•ä½¿ç”¨CollectorService.recordCacheOperation
- æ”¹é€ recordDecompressionMetricsæ–¹æ³•

**ç¤ºä¾‹ä»£ç **:
```typescript
constructor(
  @Inject('REDIS_CLIENT') private readonly redis: Redis,
  private readonly configService: ConfigService,
  private readonly compressionService: CacheCompressionService,
  private readonly collectorService: CollectorService, // æ–°å¢
) {}

private recordMetrics(operation: string, success: boolean, duration: number): void {
  try {
    // ä½¿ç”¨CollectorServiceçš„ä¸šåŠ¡è¯­ä¹‰åŒ–æ¥å£
    this.collectorService.recordCacheOperation(
      operation,
      success, // hitå‚æ•°ï¼ŒæˆåŠŸå³å‘½ä¸­
      duration,
      { layer: 'common-cache' }
    );
  } catch (error) {
    // ç›‘æ§å¤±è´¥ä¸å½±å“ä¸šåŠ¡
    this.logger.debug(`ç›‘æ§è®°å½•å¤±è´¥: ${error.message}`);
  }
}
```

### é˜¶æ®µ2ï¼šSymbolMapperCacheç»„ä»¶æ”¹é€ 

#### 3.2.1 æ¨¡å—æ”¹é€ 
**æ–‡ä»¶**: `src/core/05-caching/symbol-mapper-cache/module/symbol-mapper-cache.module.ts`

**æ”¹é€ å†…å®¹**:
- å¯¼å…¥MonitoringModule
- ç§»é™¤å¯¹MetricsRegistryServiceçš„ç›´æ¥å¯¼å…¥

#### 3.2.2 æœåŠ¡å±‚æ”¹é€ 
**æ–‡ä»¶**: `src/core/05-caching/symbol-mapper-cache/services/symbol-mapper-cache.service.ts`

**æ”¹é€ å†…å®¹**:
- å°†MetricsRegistryServiceæ³¨å…¥æ”¹ä¸ºCollectorService
- æ”¹é€ recordCacheMetricsæ–¹æ³•
- æ”¹é€ recordPerformanceMetricsæ–¹æ³•
- ç§»é™¤å¯¹Prometheusåº•å±‚APIçš„ç›´æ¥è°ƒç”¨

**ç¤ºä¾‹ä»£ç **:
```typescript
constructor(
  private readonly repository: SymbolMapperRepository,
  private readonly featureFlags: FeatureFlagsService,
  private readonly collectorService: CollectorService, // æ›¿æ¢MetricsRegistryService
) {}

private recordCacheMetrics(hit: boolean, layer: string): void {
  try {
    const operation = `symbol_mapping_${layer}`;
    this.collectorService.recordCacheOperation(
      operation,
      hit,
      0, // å¦‚æœæ²¡æœ‰durationå¯ä¼ 0
      { 
        layer,
        cacheType: 'symbol-mapper'
      }
    );
  } catch (error) {
    this.logger.debug(`ç›‘æ§è®°å½•å¤±è´¥: ${error.message}`);
  }
}
```

### é˜¶æ®µ3ï¼šDataMapperCacheç»„ä»¶æ”¹é€ 

#### 3.3.1 ç§»é™¤ç§æœ‰metricså¯¹è±¡
**æ–‡ä»¶**: `src/core/05-caching/data-mapper-cache/services/data-mapper-cache.service.ts`

**æ”¹é€ å†…å®¹**:
- ç§»é™¤ç§æœ‰çš„metricså¯¹è±¡ï¼ˆç¬¬20-26è¡Œï¼‰
- æ³¨å…¥CollectorService
- æ”¹é€ updateMetricsæ–¹æ³•ä½¿ç”¨CollectorService

**ç¤ºä¾‹ä»£ç **:
```typescript
constructor(
  private readonly redisService: RedisService,
  private readonly collectorService: CollectorService, // æ–°å¢
) {}

private updateMetrics(hit: boolean, operation: string): void {
  try {
    this.collectorService.recordCacheOperation(
      `data_mapper_${operation}`,
      hit,
      0,
      { cacheType: 'data-mapper' }
    );
  } catch (error) {
    this.logger.debug(`ç›‘æ§è®°å½•å¤±è´¥: ${error.message}`);
  }
}
```

### é˜¶æ®µ4ï¼šStreamCacheç»„ä»¶æ”¹é€ 

#### 3.4.1 ç§»é™¤ç§æœ‰statså¯¹è±¡
**æ–‡ä»¶**: `src/core/05-caching/stream-cache/services/stream-cache.service.ts`

**æ”¹é€ å†…å®¹**:
- ç§»é™¤ç§æœ‰çš„statså¯¹è±¡ï¼ˆç¬¬35-42è¡Œï¼‰
- æ³¨å…¥CollectorService
- æ”¹é€ æ‰€æœ‰statsæ›´æ–°é€»è¾‘

**ç¤ºä¾‹ä»£ç **:
```typescript
constructor(
  @Inject('REDIS_CLIENT') private redisClient: Redis,
  private readonly collectorService: CollectorService, // æ–°å¢
) {}

// æ›¿æ¢åŸæœ‰çš„stats.hotCacheHits++
private recordHotCacheHit(): void {
  try {
    this.collectorService.recordCacheOperation(
      'stream_hot_cache',
      true, // hit
      0,
      { cacheLayer: 'hot' }
    );
  } catch (error) {
    this.logger.debug(`ç›‘æ§è®°å½•å¤±è´¥: ${error.message}`);
  }
}
```

### é˜¶æ®µ5ï¼šSmartCacheç»„ä»¶æ”¹é€ 

#### 3.5.1 æœåŠ¡æ³¨å…¥è§„èŒƒåŒ–
**æ–‡ä»¶**: `src/core/05-caching/smart-cache/services/smart-cache-orchestrator.service.ts`

**æ”¹é€ å†…å®¹**:
- ç§»é™¤presenterRegistryServiceæ³¨å…¥
- æ³¨å…¥CollectorService
- æ”¹é€ æ‰€æœ‰ç›‘æ§è®°å½•é€»è¾‘

**ç¤ºä¾‹ä»£ç **:
```typescript
constructor(
  private readonly rawConfig: ConfigService,
  private readonly commonCacheService: CommonCacheService,
  private readonly dataChangeDetectorService: DataChangeDetectorService,
  private readonly marketStatusService: MarketStatusService,
  private readonly backgroundTaskService: BackgroundTaskService,
  private readonly collectorService: CollectorService, // æ›¿æ¢presenterRegistryService
) {}
```

## 4. æµ‹è¯•è®¡åˆ’

### 4.1 å•å…ƒæµ‹è¯•æ”¹é€ 
æ¯ä¸ªç»„ä»¶éœ€è¦æ›´æ–°å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶ï¼š
- ç§»é™¤Mock Registryç›¸å…³æµ‹è¯•
- æ·»åŠ CollectorServiceçš„Mock
- éªŒè¯ç›‘æ§æ–¹æ³•è°ƒç”¨æ­£ç¡®æ€§

### 4.2 é›†æˆæµ‹è¯•
- éªŒè¯ç›‘æ§æ•°æ®æ­£ç¡®æµå‘CollectorService
- éªŒè¯ç›‘æ§å¤±è´¥ä¸å½±å“ä¸šåŠ¡é€»è¾‘
- éªŒè¯æ€§èƒ½å½±å“åœ¨å¯æ¥å—èŒƒå›´å†…

### 4.3 E2Eæµ‹è¯•
- éªŒè¯å®Œæ•´çš„ç›‘æ§æ•°æ®æµ
- éªŒè¯PrometheusæŒ‡æ ‡æ­£ç¡®æ€§
- éªŒè¯ç›‘æ§æ•°æ®å±•ç¤ºæ­£ç¡®æ€§

## 5. å®æ–½é¡ºåº

| é¡ºåº | ç»„ä»¶ | é¢„è®¡å·¥æ—¶ | é£é™©ç­‰çº§ |
|------|------|----------|----------|
| 1 | CommonCache | 2å°æ—¶ | ä½ |
| 2 | StreamCache | 1.5å°æ—¶ | ä½ |
| 3 | DataMapperCache | 1.5å°æ—¶ | ä½ |
| 4 | SymbolMapperCache | 2å°æ—¶ | ä¸­ |
| 5 | SmartCache | 2å°æ—¶ | ä¸­ |

## 6. å›æ»šè®¡åˆ’

å¦‚æœæ”¹é€ å‡ºç°é—®é¢˜ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

1. **ç‰ˆæœ¬æ§åˆ¶å›æ»š**ï¼šé€šè¿‡Gitæ¢å¤åˆ°æ”¹é€ å‰çš„ç‰ˆæœ¬
2. **é…ç½®å¼€å…³**ï¼šåœ¨æ¯ä¸ªç»„ä»¶æ·»åŠ feature flagæ§åˆ¶æ–°æ—§ç›‘æ§åˆ‡æ¢
3. **é€æ­¥å›æ»š**ï¼šæŒ‰ç»„ä»¶ç‹¬ç«‹å›æ»šï¼Œä¸å½±å“å…¶ä»–ç»„ä»¶

## 7. æˆåŠŸæ ‡å‡†

- âœ… æ‰€æœ‰ç¼“å­˜ç»„ä»¶ç»Ÿä¸€ä½¿ç”¨CollectorService
- âœ… ç§»é™¤æ‰€æœ‰Mock Registryå’Œç§æœ‰ç»Ÿè®¡å¯¹è±¡
- âœ… ç›‘æ§æ•°æ®å®Œæ•´æ€§è¾¾åˆ°95%ä»¥ä¸Š
- âœ… ç›‘æ§å»¶è¿Ÿä¸è¶…è¿‡5ms
- âœ… ç›‘æ§å¤±è´¥ç‡ä½äº0.1%
- âœ… é€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

## 8. æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šä¿æŒå¯¹å¤–æ¥å£ä¸å˜ï¼Œåªæ”¹é€ å†…éƒ¨å®ç°
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨å¼‚æ­¥æ–¹å¼è®°å½•ç›‘æ§ï¼Œé¿å…é˜»å¡ä¸šåŠ¡é€»è¾‘
3. **é”™è¯¯å¤„ç†**ï¼šç›‘æ§å¤±è´¥å¿…é¡»é™é»˜å¤„ç†ï¼Œä¸èƒ½å½±å“ç¼“å­˜åŠŸèƒ½
4. **æ—¥å¿—çº§åˆ«**ï¼šç›‘æ§ç›¸å…³æ—¥å¿—ä½¿ç”¨debugçº§åˆ«ï¼Œé¿å…ç”Ÿäº§ç¯å¢ƒæ—¥å¿—è†¨èƒ€
5. **æ‰¹é‡å¤„ç†**ï¼šå¯¹äºé«˜é¢‘æ“ä½œï¼Œè€ƒè™‘æ‰¹é‡æäº¤ç›‘æ§æ•°æ®

## 9. åç»­ä¼˜åŒ–å»ºè®®

1. **ç»Ÿä¸€ç›‘æ§é…ç½®**ï¼šå°†ç›‘æ§ç›¸å…³é…ç½®é›†ä¸­ç®¡ç†
2. **ç›‘æ§æ•°æ®èšåˆ**ï¼šåœ¨CollectorServiceå±‚é¢å®ç°æ•°æ®é¢„èšåˆ
3. **è‡ªå®šä¹‰æŒ‡æ ‡**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚å®šåˆ¶ç¼“å­˜ä¸“å±æŒ‡æ ‡
4. **å‘Šè­¦è§„åˆ™**ï¼šåŸºäºç›‘æ§æ•°æ®é…ç½®å‘Šè­¦è§„åˆ™
5. **å¯è§†åŒ–ä¼˜åŒ–**ï¼šä¼˜åŒ–Grafana Dashboardå±•ç¤º

## 10. æ–‡æ¡£æ›´æ–°

æ”¹é€ å®Œæˆåéœ€è¦æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ï¼š
- ç›‘æ§ç»„ä»¶ä½¿ç”¨æŒ‡å¯¼æ–‡æ¡£
- ç¼“å­˜ç»„ä»¶æ¶æ„è¯´æ˜æ–‡æ¡£
- ç›‘æ§æŒ‡æ ‡è¯´æ˜æ–‡æ¡£
- è¿ç»´æ‰‹å†Œç›¸å…³ç« èŠ‚