# ç¼“å­˜å±‚ç›‘æ§æ”¹é€ è®¡åˆ’ - äº‹ä»¶é©±åŠ¨æ¶æ„

> **ğŸ“‹ äº‹ä»¶é©±åŠ¨æ¶æ„æ›´æ–°ï¼ˆ2025-08-26ï¼‰**
>
> æœ¬æ–‡æ¡£å·²å…¨é¢æ›´æ–°ä»¥æ”¯æŒäº‹ä»¶é©±åŠ¨ç›‘æ§æ¶æ„v2.0ï¼ŒåŸºäºMonitoringCacheServiceçš„æœ€æ–°äº‹ä»¶åŒ–å®ç°ã€‚
> ä¸»è¦æ›´æ–°å†…å®¹ï¼š
> - âœ… äº‹ä»¶é©±åŠ¨æ¶æ„ï¼šå®Œå…¨è§£è€¦çš„ç›‘æ§ä½“ç³»
> - âœ… è‡ªåŠ¨äº‹ä»¶å‘å°„ï¼šMonitoringCacheServiceè‡ªåŠ¨å‘å°„CACHE_HIT/MISS/SET/ERRORäº‹ä»¶
> - âœ… é”™è¯¯éš”ç¦»ä¿è¯ï¼šç›‘æ§å¤±è´¥ä¸å½±å“ç¼“å­˜ä¸šåŠ¡é€»è¾‘
> - âœ… é«˜æ€§èƒ½æ‰¹å¤„ç†ï¼šEventBatcheræ™ºèƒ½èšåˆç¼“å­˜äº‹ä»¶
> - âœ… å‘åå…¼å®¹ï¼šä¿æŒåŸæœ‰ç¼“å­˜APIæ¥å£

## ğŸ”„ äº‹ä»¶é©±åŠ¨æ¶æ„åŸç†

### ğŸ—ï¸ MonitoringCacheService äº‹ä»¶åŒ–æ¨¡å¼

åŸºäºæœ€æ–°çš„MonitoringCacheServiceå®ç°ï¼Œç¼“å­˜æ“ä½œå·²å…¨é¢äº‹ä»¶åŒ–ï¼š

```typescript
// âœ… è‡ªåŠ¨äº‹ä»¶å‘å°„æœºåˆ¶
// ç¼“å­˜å‘½ä¸­ï¼šè‡ªåŠ¨å‘å°„ SYSTEM_STATUS_EVENTS.CACHE_HIT
// ç¼“å­˜æœªå‘½ä¸­ï¼šè‡ªåŠ¨å‘å°„ SYSTEM_STATUS_EVENTS.CACHE_MISS
// ç¼“å­˜è®¾ç½®ï¼šè‡ªåŠ¨å‘å°„ SYSTEM_STATUS_EVENTS.CACHE_SET
// ç¼“å­˜é”™è¯¯ï¼šè‡ªåŠ¨å‘å°„ SYSTEM_STATUS_EVENTS.CACHE_ERROR

this.eventBus.emit(SYSTEM_STATUS_EVENTS.CACHE_HIT, {
  timestamp: new Date(),
  source: 'cache',
  key: cacheKey,
  metadata: { 
    duration,
    ttl,
    cache_type: 'monitoring',
    category: 'health'
  }
});
```

### ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **ğŸ”„ äº‹ä»¶é©±åŠ¨è§£è€¦**ï¼šç¼“å­˜ç»„ä»¶åªä½¿ç”¨MonitoringCacheServiceæˆ–CollectorService
2. **âš¡ è‡ªåŠ¨äº‹ä»¶å‘å°„**ï¼šç¼“å­˜æ“ä½œè‡ªåŠ¨è§¦å‘ç›¸åº”äº‹ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–ç 
3. **ğŸ›¡ï¸ é”™è¯¯éš”ç¦»ä¿è¯**ï¼šç›‘æ§äº‹ä»¶å¤±è´¥ä¸å½±å“ç¼“å­˜æ“ä½œ
4. **ğŸ“¦ æ™ºèƒ½æ‰¹å¤„ç†**ï¼šEventBatcherè‡ªåŠ¨èšåˆç¼“å­˜äº‹ä»¶ï¼Œå‡å°‘ç›‘æ§å¼€é”€
5. **ğŸ”§ å‘åå…¼å®¹**ï¼šä¿æŒåŸæœ‰ç¼“å­˜APIï¼Œæ¸è¿›å¼è¿ç§»

### ğŸš¨ å½“å‰æ—§æ¶æ„é—®é¢˜

| ç¼“å­˜å­ç»„ä»¶ | å½“å‰é—®é¢˜ | äº‹ä»¶é©±åŠ¨æ”¹é€ æ–¹æ¡ˆ |
|------------|-------------|-------------|
| **CommonCache** | Mock Registryå¯¼è‡´ç›‘æ§å¤±æ•ˆ | ä½¿ç”¨MonitoringCacheServiceè‡ªåŠ¨äº‹ä»¶å‘å°„ |
| **SymbolMapperCache** | ç›´æ¥æ³¨å…¥MetricsRegistryService | æ›¿æ¢ä¸ºCollectorServiceäº‹ä»¶é©±åŠ¨æ¨¡å¼ |
| **DataMapperCache** | ç§æœ‰metricså¯¹è±¡ | ç§»é™¤ç§æœ‰ç»Ÿè®¡ï¼Œé‡‡ç”¨äº‹ä»¶å‘å°„ |
| **StreamCache** | ç§æœ‰statsç»Ÿè®¡ | ç§»é™¤ç§æœ‰statsï¼Œä½¿ç”¨CollectorService |
| **SmartCache** | æ³¨å…¥presenterRegistryService | æ›¿æ¢ä¸ºMonitoringCacheService |

## ğŸ”§ äº‹ä»¶é©±åŠ¨æ”¹é€ è®¡åˆ’

### é˜¶æ®µ1ï¼šCommonCacheç»„ä»¶æ”¹é€ ï¼ˆä¼˜å…ˆçº§ï¼šæœ€é«˜ï¼‰

#### 3.1.1 ç§»é™¤Mock Registry
**æ–‡ä»¶**: `src/core/05-caching/common-cache/module/common-cache.module.ts`

**æ”¹é€ å†…å®¹**:
- ç§»é™¤METRICS_REGISTRY providerå®šä¹‰ï¼ˆç¬¬76-92è¡Œï¼‰
- å¯¼å…¥MonitoringModule
- ä»exportsä¸­ç§»é™¤METRICS_REGISTRY

#### 3.1.2 æœåŠ¡å±‚æ”¹é€ 
**æ–‡ä»¶**: `src/core/05-caching/common-cache/services/common-cache.service.ts`

**æ”¹é€ å†…å®¹**:
- ç§»é™¤`@Inject('METRICS_REGISTRY')`æ³¨å…¥
- æ³¨å…¥CollectorServiceæ›¿ä»£
- æ”¹é€ recordMetricsæ–¹æ³•ä½¿ç”¨CollectorService.recordCacheOperation
- æ”¹é€ recordDecompressionMetricsæ–¹æ³•

**ç¤ºä¾‹ä»£ç **:
```typescript
constructor(
  @Inject('REDIS_CLIENT') private readonly redis: Redis,
  private readonly configService: ConfigService,
  private readonly compressionService: CacheCompressionService,
  private readonly collectorService: CollectorService, // æ–°å¢
) {}

private recordMetrics(operation: string, success: boolean, duration: number): void {
  try {
    // ä½¿ç”¨CollectorServiceçš„ä¸šåŠ¡è¯­ä¹‰åŒ–æ¥å£
    this.collectorService.recordCacheOperation(
      operation,
      success, // hitå‚æ•°ï¼ŒæˆåŠŸå³å‘½ä¸­
      duration,
      { layer: 'common-cache' }
    );
  } catch (error) {
    // ç›‘æ§å¤±è´¥ä¸å½±å“ä¸šåŠ¡
    this.logger.debug(`ç›‘æ§è®°å½•å¤±è´¥: ${error.message}`);
  }
}
```

### é˜¶æ®µ2ï¼šSymbolMapperCacheç»„ä»¶æ”¹é€ 

#### 3.2.1 æ¨¡å—æ”¹é€ 
**æ–‡ä»¶**: `src/core/05-caching/symbol-mapper-cache/module/symbol-mapper-cache.module.ts`

**æ”¹é€ å†…å®¹**:
- å¯¼å…¥MonitoringModule
- ç§»é™¤å¯¹MetricsRegistryServiceçš„ç›´æ¥å¯¼å…¥

#### 3.2.2 æœåŠ¡å±‚æ”¹é€ 
**æ–‡ä»¶**: `src/core/05-caching/symbol-mapper-cache/services/symbol-mapper-cache.service.ts`

**æ”¹é€ å†…å®¹**:
- å°†MetricsRegistryServiceæ³¨å…¥æ”¹ä¸ºCollectorService
- æ”¹é€ recordCacheMetricsæ–¹æ³•
- æ”¹é€ recordPerformanceMetricsæ–¹æ³•
- ç§»é™¤å¯¹Prometheusåº•å±‚APIçš„ç›´æ¥è°ƒç”¨

**ç¤ºä¾‹ä»£ç **:
```typescript
constructor(
  private readonly repository: SymbolMapperRepository,
  private readonly featureFlags: FeatureFlagsService,
  private readonly collectorService: CollectorService, // æ›¿æ¢MetricsRegistryService
) {}

private recordCacheMetrics(hit: boolean, layer: string): void {
  try {
    const operation = `symbol_mapping_${layer}`;
    this.collectorService.recordCacheOperation(
      operation,
      hit,
      0, // å¦‚æœæ²¡æœ‰durationå¯ä¼ 0
      { 
        layer,
        cacheType: 'symbol-mapper'
      }
    );
  } catch (error) {
    this.logger.debug(`ç›‘æ§è®°å½•å¤±è´¥: ${error.message}`);
  }
}
```

### é˜¶æ®µ3ï¼šDataMapperCacheç»„ä»¶æ”¹é€ 

#### 3.3.1 ç§»é™¤ç§æœ‰metricså¯¹è±¡
**æ–‡ä»¶**: `src/core/05-caching/data-mapper-cache/services/data-mapper-cache.service.ts`

**æ”¹é€ å†…å®¹**:
- ç§»é™¤ç§æœ‰çš„metricså¯¹è±¡ï¼ˆç¬¬20-26è¡Œï¼‰
- æ³¨å…¥CollectorService
- æ”¹é€ updateMetricsæ–¹æ³•ä½¿ç”¨CollectorService

**ç¤ºä¾‹ä»£ç **:
```typescript
constructor(
  private readonly redisService: RedisService,
  private readonly collectorService: CollectorService, // æ–°å¢
) {}

private updateMetrics(hit: boolean, operation: string): void {
  try {
    this.collectorService.recordCacheOperation(
      `data_mapper_${operation}`,
      hit,
      0,
      { cacheType: 'data-mapper' }
    );
  } catch (error) {
    this.logger.debug(`ç›‘æ§è®°å½•å¤±è´¥: ${error.message}`);
  }
}
```

### é˜¶æ®µ4ï¼šStreamCacheç»„ä»¶æ”¹é€ 

#### 3.4.1 ç§»é™¤ç§æœ‰statså¯¹è±¡
**æ–‡ä»¶**: `src/core/05-caching/stream-cache/services/stream-cache.service.ts`

**æ”¹é€ å†…å®¹**:
- ç§»é™¤ç§æœ‰çš„statså¯¹è±¡ï¼ˆç¬¬35-42è¡Œï¼‰
- æ³¨å…¥CollectorService
- æ”¹é€ æ‰€æœ‰statsæ›´æ–°é€»è¾‘

**ç¤ºä¾‹ä»£ç **:
```typescript
constructor(
  @Inject('REDIS_CLIENT') private redisClient: Redis,
  private readonly collectorService: CollectorService, // æ–°å¢
) {}

// æ›¿æ¢åŸæœ‰çš„stats.hotCacheHits++
private recordHotCacheHit(): void {
  try {
    this.collectorService.recordCacheOperation(
      'stream_hot_cache',
      true, // hit
      0,
      { cacheLayer: 'hot' }
    );
  } catch (error) {
    this.logger.debug(`ç›‘æ§è®°å½•å¤±è´¥: ${error.message}`);
  }
}
```

### é˜¶æ®µ5ï¼šSmartCacheç»„ä»¶æ”¹é€ 

#### 3.5.1 æœåŠ¡æ³¨å…¥è§„èŒƒåŒ–
**æ–‡ä»¶**: `src/core/05-caching/smart-cache/services/smart-cache-orchestrator.service.ts`

**æ”¹é€ å†…å®¹**:
- ç§»é™¤presenterRegistryServiceæ³¨å…¥
- æ³¨å…¥CollectorService
- æ”¹é€ æ‰€æœ‰ç›‘æ§è®°å½•é€»è¾‘

**ç¤ºä¾‹ä»£ç **:
```typescript
constructor(
  private readonly rawConfig: ConfigService,
  private readonly commonCacheService: CommonCacheService,
  private readonly dataChangeDetectorService: DataChangeDetectorService,
  private readonly marketStatusService: MarketStatusService,
  private readonly backgroundTaskService: BackgroundTaskService,
  private readonly collectorService: CollectorService, // æ›¿æ¢presenterRegistryService
) {}
```

## 4. æµ‹è¯•è®¡åˆ’

### 4.1 å•å…ƒæµ‹è¯•æ”¹é€ 
æ¯ä¸ªç»„ä»¶éœ€è¦æ›´æ–°å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶ï¼š
- ç§»é™¤Mock Registryç›¸å…³æµ‹è¯•
- æ·»åŠ CollectorServiceçš„Mock
- éªŒè¯ç›‘æ§æ–¹æ³•è°ƒç”¨æ­£ç¡®æ€§

### 4.2 é›†æˆæµ‹è¯•
- éªŒè¯ç›‘æ§æ•°æ®æ­£ç¡®æµå‘CollectorService
- éªŒè¯ç›‘æ§å¤±è´¥ä¸å½±å“ä¸šåŠ¡é€»è¾‘
- éªŒè¯æ€§èƒ½å½±å“åœ¨å¯æ¥å—èŒƒå›´å†…

### 4.3 E2Eæµ‹è¯•
- éªŒè¯å®Œæ•´çš„ç›‘æ§æ•°æ®æµ
- éªŒè¯PrometheusæŒ‡æ ‡æ­£ç¡®æ€§
- éªŒè¯ç›‘æ§æ•°æ®å±•ç¤ºæ­£ç¡®æ€§

## 5. å®æ–½é¡ºåº

| é¡ºåº | ç»„ä»¶ | é¢„è®¡å·¥æ—¶ | é£é™©ç­‰çº§ |
|------|------|----------|----------|
| 1 | CommonCache | 2å°æ—¶ | ä½ |
| 2 | StreamCache | 1.5å°æ—¶ | ä½ |
| 3 | DataMapperCache | 1.5å°æ—¶ | ä½ |
| 4 | SymbolMapperCache | 2å°æ—¶ | ä¸­ |
| 5 | SmartCache | 2å°æ—¶ | ä¸­ |

## 6. å›æ»šè®¡åˆ’

å¦‚æœæ”¹é€ å‡ºç°é—®é¢˜ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

1. **ç‰ˆæœ¬æ§åˆ¶å›æ»š**ï¼šé€šè¿‡Gitæ¢å¤åˆ°æ”¹é€ å‰çš„ç‰ˆæœ¬
2. **é…ç½®å¼€å…³**ï¼šåœ¨æ¯ä¸ªç»„ä»¶æ·»åŠ feature flagæ§åˆ¶æ–°æ—§ç›‘æ§åˆ‡æ¢
3. **é€æ­¥å›æ»š**ï¼šæŒ‰ç»„ä»¶ç‹¬ç«‹å›æ»šï¼Œä¸å½±å“å…¶ä»–ç»„ä»¶

## 7. æˆåŠŸæ ‡å‡†

- âœ… æ‰€æœ‰ç¼“å­˜ç»„ä»¶ç»Ÿä¸€ä½¿ç”¨CollectorService
- âœ… ç§»é™¤æ‰€æœ‰Mock Registryå’Œç§æœ‰ç»Ÿè®¡å¯¹è±¡
- âœ… ç›‘æ§æ•°æ®å®Œæ•´æ€§è¾¾åˆ°95%ä»¥ä¸Š
- âœ… ç›‘æ§å»¶è¿Ÿä¸è¶…è¿‡5ms
- âœ… ç›‘æ§å¤±è´¥ç‡ä½äº0.1%
- âœ… é€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

## 8. æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šä¿æŒå¯¹å¤–æ¥å£ä¸å˜ï¼Œåªæ”¹é€ å†…éƒ¨å®ç°
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨å¼‚æ­¥æ–¹å¼è®°å½•ç›‘æ§ï¼Œé¿å…é˜»å¡ä¸šåŠ¡é€»è¾‘
3. **é”™è¯¯å¤„ç†**ï¼šç›‘æ§å¤±è´¥å¿…é¡»é™é»˜å¤„ç†ï¼Œä¸èƒ½å½±å“ç¼“å­˜åŠŸèƒ½
4. **æ—¥å¿—çº§åˆ«**ï¼šç›‘æ§ç›¸å…³æ—¥å¿—ä½¿ç”¨debugçº§åˆ«ï¼Œé¿å…ç”Ÿäº§ç¯å¢ƒæ—¥å¿—è†¨èƒ€
5. **æ‰¹é‡å¤„ç†**ï¼šå¯¹äºé«˜é¢‘æ“ä½œï¼Œè€ƒè™‘æ‰¹é‡æäº¤ç›‘æ§æ•°æ®

## 9. åç»­ä¼˜åŒ–å»ºè®®

1. **ç»Ÿä¸€ç›‘æ§é…ç½®**ï¼šå°†ç›‘æ§ç›¸å…³é…ç½®é›†ä¸­ç®¡ç†
2. **ç›‘æ§æ•°æ®èšåˆ**ï¼šåœ¨CollectorServiceå±‚é¢å®ç°æ•°æ®é¢„èšåˆ
3. **è‡ªå®šä¹‰æŒ‡æ ‡**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚å®šåˆ¶ç¼“å­˜ä¸“å±æŒ‡æ ‡
4. **å‘Šè­¦è§„åˆ™**ï¼šåŸºäºç›‘æ§æ•°æ®é…ç½®å‘Šè­¦è§„åˆ™
5. **å¯è§†åŒ–ä¼˜åŒ–**ï¼šä¼˜åŒ–Grafana Dashboardå±•ç¤º

## 10. æ–‡æ¡£æ›´æ–°

æ”¹é€ å®Œæˆåéœ€è¦æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ï¼š
- ç›‘æ§ç»„ä»¶ä½¿ç”¨æŒ‡å¯¼æ–‡æ¡£
- ç¼“å­˜ç»„ä»¶æ¶æ„è¯´æ˜æ–‡æ¡£
- ç›‘æ§æŒ‡æ ‡è¯´æ˜æ–‡æ¡£
- è¿ç»´æ‰‹å†Œç›¸å…³ç« èŠ‚